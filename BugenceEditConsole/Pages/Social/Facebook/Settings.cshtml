
@page "/social/facebook/settings"
@model BugenceEditConsole.Pages.Social.Facebook.SettingsModel
@{
    ViewData["Title"] = "Facebook Marketing Settings";
    ViewData["BodyClass"] = "page-social-facebook-settings";
}

@if (!Model.Enabled)
{
    <div class="alert alert-warning">Social Marketing module is disabled by feature flags.</div>
    return;
}

<style>
    :root {
        --fb-bg: #020202;
        --fb-panel: rgba(9, 9, 9, 0.94);
        --fb-panel-strong: rgba(5, 5, 5, 0.985);
        --fb-panel-soft: rgba(255,255,255,0.03);
        --fb-border: rgba(255,255,255,0.08);
        --fb-border-strong: rgba(255,255,255,0.14);
        --fb-text: #f5f7fa;
        --fb-muted: #8993a4;
        --fb-cyan: #6cecff;
        --fb-blue: #6ea8ff;
        --fb-green: #4ade80;
        --fb-gold: #f6c85f;
        --fb-red: #fb7185;
        --fb-violet: #9f7aea;
    }

    .fb-settings-shell { max-width: 1720px; margin: 0 auto; display: grid; gap: 18px; padding-bottom: 32px; }
    .fb-settings-hero {
        position: relative; overflow: hidden; border-radius: 32px; border: 1px solid var(--fb-border-strong);
        background: radial-gradient(900px 340px at -8% -18%, rgba(108,236,255,0.16), transparent 56%), radial-gradient(760px 280px at 108% 0%, rgba(110,168,255,0.18), transparent 58%), linear-gradient(135deg, rgba(11,11,11,0.98), rgba(3,3,3,0.985));
        padding: 28px; box-shadow: 0 40px 100px rgba(0,0,0,0.58);
    }
    .fb-settings-hero::after {
        content: ""; position: absolute; inset: 0;
        background-image: linear-gradient(rgba(255,255,255,0.022) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.022) 1px, transparent 1px);
        background-size: 32px 32px; opacity: 0.18; pointer-events: none;
    }
    .fb-settings-hero-inner { position: relative; z-index: 1; display: grid; grid-template-columns: minmax(0, 1.22fr) 420px; gap: 18px; }
    .fb-kicker, .fb-panel-kicker {
        display: inline-flex; align-items: center; gap: 10px; padding: 8px 14px; border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.04); color: var(--fb-cyan);
        font-size: 0.72rem; font-weight: 900; letter-spacing: 0.18em; text-transform: uppercase;
    }
    .fb-panel-kicker { padding: 7px 12px; font-size: 0.68rem; letter-spacing: 0.16em; }
    .fb-settings-title {
        margin: 14px 0 12px; color: var(--fb-text); font-family: "Cabinet Grotesk", sans-serif;
        font-size: clamp(2rem, 3vw, 3rem); line-height: 1.02; letter-spacing: -0.04em; max-width: 760px;
    }
    .fb-settings-copy, .fb-panel-copy, .fb-command-sub {
        margin: 0; color: var(--fb-muted); font-size: 0.95rem; line-height: 1.7;
    }
    .fb-settings-lead { margin: 0 0 10px; color: var(--fb-muted); font-size: 1rem; line-height: 1.7; max-width: 760px; }
    .fb-panel-copy { font-size: 0.9rem; max-width: 700px; }
    .fb-command-sub { font-size: 0.84rem; }
    .fb-hero-points, .fb-actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .fb-hero-points { margin-top: 18px; }
    .fb-point, .fb-chip {
        display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.09); background: rgba(255,255,255,0.04); color: #dbe4ee;
        font-size: 0.78rem; font-weight: 800; letter-spacing: 0.05em; text-transform: uppercase;
    }
    .fb-command-panel, .fb-panel {
        border: 1px solid rgba(255,255,255,0.1); background: linear-gradient(180deg, rgba(15,15,15,0.97), rgba(7,7,7,0.985));
        box-shadow: 0 24px 70px rgba(0,0,0,0.42);
    }
    .fb-command-panel { border-radius: 26px; padding: 18px; display: grid; gap: 16px; align-content: start; }
    .fb-panel {
        border-radius: 28px;
        background: radial-gradient(600px 200px at 100% 0%, rgba(108,236,255,0.05), transparent 58%), linear-gradient(180deg, rgba(10,10,10,0.965), rgba(5,5,5,0.985));
        padding: 22px;
    }
    .fb-command-title { margin: 0; color: var(--fb-text); font-size: 1rem; font-weight: 900; }
    .fb-panel-title {
        margin: 10px 0 6px; color: var(--fb-text); font-family: "Cabinet Grotesk", sans-serif;
        font-size: clamp(1.3rem, 2vw, 2rem); line-height: 1; letter-spacing: -0.04em;
    }
    .fb-field { display: grid; gap: 7px; }
    .fb-field label { color: #7a8492; font-size: 0.72rem; font-weight: 900; letter-spacing: 0.12em; text-transform: uppercase; }
    .fb-input, .fb-select, .fb-textarea {
        width: 100%; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.03); color: var(--fb-text);
        border-radius: 16px; padding: 0 14px; font-size: 0.92rem;
    }
    .fb-input, .fb-select { height: 48px; }
    .fb-textarea { min-height: 118px; padding: 14px; resize: vertical; }
    .fb-input:focus, .fb-select:focus, .fb-textarea:focus { outline: none; border-color: rgba(108,236,255,0.55); box-shadow: 0 0 0 4px rgba(108,236,255,0.08); }
    .fb-btn, .fb-btn-accent, .fb-btn-danger, .fb-btn-warn {
        height: 46px; padding: 0 16px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.12); font-size: 0.85rem;
        font-weight: 900; display: inline-flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none; cursor: pointer;
        transition: transform 0.2s ease, filter 0.2s ease, border-color 0.2s ease;
    }
    .fb-btn { background: rgba(255,255,255,0.04); color: var(--fb-text); }
    .fb-btn-accent { background: linear-gradient(135deg, var(--fb-cyan), var(--fb-blue)); color: #031116; border-color: rgba(108,236,255,0.18); }
    .fb-btn-danger { background: rgba(251,113,133,0.12); color: #ffd3da; border-color: rgba(251,113,133,0.28); }
    .fb-btn-warn { background: rgba(246,200,95,0.12); color: #ffe6a7; border-color: rgba(246,200,95,0.28); }
    .fb-btn:hover, .fb-btn-accent:hover, .fb-btn-danger:hover, .fb-btn-warn:hover { transform: translateY(-1px); filter: brightness(1.04); }
    .fb-health-band { display: grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap: 12px; }
    .fb-health-card {
        position: relative; overflow: hidden; min-height: 132px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.08);
        background: radial-gradient(220px 90px at 100% 0%, rgba(255,255,255,0.04), transparent 64%), linear-gradient(180deg, rgba(10,10,10,0.96), rgba(6,6,6,0.97));
        padding: 18px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.03);
    }
    .fb-health-card::before { content: ""; position: absolute; inset: auto 0 0 0; height: 3px; background: linear-gradient(90deg, rgba(108,236,255,0.75), rgba(110,168,255,0.12)); }
    .fb-health-card.warn::before { background: linear-gradient(90deg, rgba(246,200,95,0.86), rgba(246,200,95,0.12)); }
    .fb-health-card.err::before { background: linear-gradient(90deg, rgba(251,113,133,0.84), rgba(251,113,133,0.12)); }
    .fb-health-label { color: #788394; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.14em; font-weight: 900; }
    .fb-health-value { margin-top: 12px; color: var(--fb-text); font-size: 2rem; font-weight: 900; letter-spacing: -0.05em; }
    .fb-health-meta { margin-top: 10px; color: var(--fb-muted); font-size: 0.82rem; line-height: 1.6; }
    .fb-settings-grid { display: grid; grid-template-columns: 1.12fr 0.88fr; gap: 18px; }
    .fb-settings-form, .fb-template-grid, .fb-rule-builder { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 14px; }
    .fb-check, .fb-default-toggle {
        display: inline-flex; align-items: center; gap: 10px; min-height: 48px; padding: 0 14px; border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.025); color: #d7e2ee; font-size: 0.88rem; font-weight: 700;
    }
    .fb-check input { width: 16px; height: 16px; accent-color: var(--fb-cyan); }
    .fb-status-line { min-height: 24px; color: #9ed9ff; font-size: 0.86rem; font-weight: 700; margin-top: 14px; }
    .fb-rule-builder .fb-field:last-child { grid-column: 1 / -1; }
    .fb-rule-cta { display: flex; justify-content: flex-end; margin-top: 12px; }
    .fb-table-shell { overflow: hidden; border-radius: 22px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.02); }
    .fb-table-wrap { overflow: auto; }
    .fb-table { width: 100%; border-collapse: collapse; }
    .fb-table thead { background: rgba(255,255,255,0.02); }
    .fb-table th, .fb-table td { padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); vertical-align: top; white-space: nowrap; }
    .fb-table th { color: #7d8798; font-size: 0.72rem; font-weight: 900; letter-spacing: 0.12em; text-transform: uppercase; }
    .fb-table td { color: #e5ebf3; font-size: 0.88rem; }
    .fb-table tbody tr:hover { background: rgba(255,255,255,0.025); }
    .fb-chip.ok { color: #b6ffd2; background: rgba(74,222,128,0.12); border-color: rgba(74,222,128,0.22); }
    .fb-chip.warn { color: #ffe6a7; background: rgba(246,200,95,0.12); border-color: rgba(246,200,95,0.22); }
    .fb-chip.err { color: #ffd3da; background: rgba(251,113,133,0.12); border-color: rgba(251,113,133,0.22); }
    .fb-template-list { display: grid; gap: 14px; }
    .fb-template-card {
        border-radius: 22px; border: 1px solid rgba(255,255,255,0.08);
        background: radial-gradient(260px 90px at 100% 0%, rgba(159,122,234,0.08), transparent 68%), rgba(255,255,255,0.025);
        padding: 16px; display: grid; gap: 14px;
    }
    .fb-template-head { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
    .fb-template-name { color: var(--fb-text); font-size: 1.1rem; font-weight: 900; }
    .fb-template-meta { margin-top: 6px; color: var(--fb-muted); font-size: 0.74rem; letter-spacing: 0.12em; text-transform: uppercase; font-weight: 900; }
    .fb-empty { padding: 34px 18px; color: var(--fb-muted); text-align: center; font-size: 0.92rem; }
    .fb-code {
        display: inline-block; max-width: 420px; overflow: hidden; text-overflow: ellipsis; color: #c5d0de;
        background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 6px 10px;
        font-family: Consolas, "SFMono-Regular", monospace; font-size: 0.78rem;
    }
    .fb-bottom-grid { display: grid; grid-template-columns: 1.08fr 0.92fr; gap: 18px; }

    @@media (max-width: 1400px) {
        .fb-health-band { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .fb-settings-grid, .fb-bottom-grid, .fb-settings-hero-inner { grid-template-columns: 1fr; }
    }
    @@media (max-width: 980px) {
        .fb-settings-form, .fb-rule-builder, .fb-template-grid { grid-template-columns: 1fr; }
    }
    @@media (max-width: 760px) {
        .fb-health-band { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .fb-settings-hero, .fb-panel { padding: 18px; border-radius: 24px; }
    }
    @@media (max-width: 560px) {
        .fb-health-band { grid-template-columns: 1fr; }
    }
</style>

<div class="fb-settings-shell">
    <section class="fb-settings-hero">
        <div class="fb-settings-hero-inner">
            <div>
                <span class="fb-kicker">Marketing Ops Control Room</span>
                <h1 class="fb-settings-title">Facebook Marketing Settings</h1>
                <p class="fb-settings-lead">Operate lead ingestion, automation, and recovery from one high-signal command surface.</p>
                <p class="fb-settings-copy">This is the operational layer behind Facebook Marketing. Control sync policy, consent guardrails, routing rules, templates, and dead-letter recovery without dropping marketers into infrastructure-level complexity.</p>
                <div class="fb-hero-points">
                    <span class="fb-point">Webhook posture</span>
                    <span class="fb-point">SLA governance</span>
                    <span class="fb-point">Workflow routing</span>
                    <span class="fb-point">Template ops</span>
                </div>
            </div>

            <aside class="fb-command-panel">
                <div class="fb-command-head">
                    <h2 class="fb-command-title">Meta Connection</h2>
                    <p class="fb-command-sub">Select the connected account that this workspace should operate against. All health, rules, templates, and DLQ views hydrate from this selection.</p>
                </div>

                <div class="fb-command-grid">
                    <div class="fb-field">
                        <label for="integrationConnectionId">Integration Account</label>
                        <select id="integrationConnectionId" class="fb-select">
                            @foreach (var c in Model.Connections)
                            {
                                <option value="@c.Id">@c.DisplayName (@c.Status)</option>
                            }
                        </select>
                    </div>

                    <div class="fb-actions">
                        <a class="fb-btn" asp-page="/Settings/Integration">Manage Integrations</a>
                        <button type="button" class="fb-btn-accent" id="refreshOpsBtn">Refresh Operations</button>
                    </div>
                </div>
            </aside>
        </div>
    </section>

    <section class="fb-health-band">
        <article class="fb-health-card"><div class="fb-health-label">Webhook</div><div class="fb-health-value" id="healthWebhook">-</div><div class="fb-health-meta">Realtime ingestion posture for this integration account.</div></article>
        <article class="fb-health-card warn"><div class="fb-health-label">SLA Breaches</div><div class="fb-health-value" id="healthSla">0</div><div class="fb-health-meta">Leads currently outside your configured first-response window.</div></article>
        <article class="fb-health-card warn"><div class="fb-health-label">Open DLQ</div><div class="fb-health-value" id="healthDlq">0</div><div class="fb-health-meta">Webhook events waiting for operator recovery or retry.</div></article>
        <article class="fb-health-card err"><div class="fb-health-label">Sync Failures</div><div class="fb-health-value" id="healthFailures">0</div><div class="fb-health-meta">Recent pipeline failures across metadata and lead ingestion.</div></article>
        <article class="fb-health-card"><div class="fb-health-label">Leads Tracked</div><div class="fb-health-value" id="healthLeads">0</div><div class="fb-health-meta">Normalized leads under active operational tracking.</div></article>
        <article class="fb-health-card"><div class="fb-health-label">Consent Guard</div><div class="fb-health-value" id="healthConsent">Off</div><div class="fb-health-meta">Whether outreach is blocked for submissions lacking consent flags.</div></article>
    </section>

    <section class="fb-settings-grid">
        <article class="fb-panel">
            <div class="fb-panel-header"><div><span class="fb-panel-kicker">Sync and SLA</span><h2 class="fb-panel-title">Operational policy</h2><p class="fb-panel-copy">Define ingestion cadence, compliance posture, retention, and response windows. These values drive how the Facebook pipeline behaves before marketers ever touch a lead.</p></div></div>
            <div class="fb-settings-form">
                <label class="fb-check" for="webhookEnabled"><input type="checkbox" id="webhookEnabled" checked /><span>Webhook enabled</span></label>
                <label class="fb-check" for="requireConsent"><input type="checkbox" id="requireConsent" /><span>Require consent before outreach</span></label>
                <div class="fb-field"><label for="pollingIntervalMinutes">Polling Interval (minutes)</label><input id="pollingIntervalMinutes" class="fb-input" type="number" min="1" value="10" /></div>
                <div class="fb-field"><label for="dataRetentionDays">Data Retention (days)</label><input id="dataRetentionDays" class="fb-input" type="number" min="30" value="180" /></div>
                <div class="fb-field"><label for="responseSlaMinutes">Response SLA (minutes)</label><input id="responseSlaMinutes" class="fb-input" type="number" min="1" value="10" /></div>
                <div class="fb-field"><label for="workingHoursStart">Working Hours Start</label><input id="workingHoursStart" class="fb-input" type="time" value="09:00" /></div>
                <div class="fb-field"><label for="workingHoursEnd">Working Hours End</label><input id="workingHoursEnd" class="fb-input" type="time" value="18:00" /></div>
                <div class="fb-actions" style="align-self:end;"><button id="saveSettingsBtn" class="fb-btn-accent" type="button">Save Settings</button></div>
            </div>
            <div class="fb-status-line" id="settingsStatus"></div>
        </article>

        <article class="fb-panel">
            <div class="fb-panel-header"><div><span class="fb-panel-kicker">Workflow Routing</span><h2 class="fb-panel-title">Auto Rules</h2><p class="fb-panel-copy">Bind operational events to reusable workflows so the Facebook surface stays marketer-friendly while the workflow engine stays lean.</p></div></div>
            <div class="fb-rule-builder">
                <div class="fb-field"><label for="eventType">Event</label><select id="eventType" class="fb-select"><option value="lead_received">lead_received</option><option value="lead_marked_hot">lead_marked_hot</option><option value="lead_needs_enrichment">lead_needs_enrichment</option><option value="sla_breached">sla_breached</option></select></div>
                <div class="fb-field"><label for="workflowId">Workflow</label><select id="workflowId" class="fb-select">@foreach (var w in Model.Workflows){<option value="@w.Id">@((w.Caption ?? w.Name))</option>}</select></div>
                <div class="fb-field"><label for="conditionsJson">Conditions JSON</label><input id="conditionsJson" class="fb-input" placeholder="Optional routing conditions" /></div>
            </div>
            <div class="fb-rule-cta"><button id="addRuleBtn" class="fb-btn-accent" type="button">Add Rule</button></div>
            <div class="fb-table-shell" style="margin-top:14px;"><div class="fb-table-wrap"><table class="fb-table"><thead><tr><th>Event</th><th>Workflow</th><th>Enabled</th><th>Updated</th><th>Action</th></tr></thead><tbody id="rulesRows"><tr><td colspan="5" class="fb-empty">No rules yet.</td></tr></tbody></table></div></div>
        </article>
    </section>

    <section class="fb-bottom-grid">
        <article class="fb-panel">
            <div class="fb-panel-header"><div><span class="fb-panel-kicker">Message System</span><h2 class="fb-panel-title">Template Library</h2><p class="fb-panel-copy">Maintain reusable WhatsApp, email, and quick-reply templates for actions inside the lead drawer. Keep response quality high without slowing operators down.</p></div><button id="addTemplateBtn" class="fb-btn" type="button">Add Template</button></div>
            <div id="templatesList" class="fb-template-list"></div>
        </article>

        <article class="fb-panel">
            <div class="fb-panel-header"><div><span class="fb-panel-kicker">Recovery Queue</span><h2 class="fb-panel-title">Dead Letter Queue</h2><p class="fb-panel-copy">Inspect and retry failed webhook events after fixing tokens, permissions, or transient fetch issues.</p></div></div>
            <div class="fb-table-shell"><div class="fb-table-wrap"><table class="fb-table"><thead><tr><th>Event</th><th>Attempts</th><th>Created</th><th>Status</th><th>Retry</th></tr></thead><tbody id="dlqRows"><tr><td colspan="5" class="fb-empty">No failed events.</td></tr></tbody></table></div></div>
        </article>
    </section>

    <article class="fb-panel">
        <div class="fb-panel-header"><div><span class="fb-panel-kicker">Pipeline Audit</span><h2 class="fb-panel-title">Recent Sync Logs</h2><p class="fb-panel-copy">Track the last successful and failed operations across metadata sync, webhook processing, and lead ingestion.</p></div></div>
        <div class="fb-table-shell"><div class="fb-table-wrap"><table class="fb-table"><thead><tr><th>Scope</th><th>Status</th><th>Started</th><th>Ended</th><th>Counts</th></tr></thead><tbody id="syncRows"><tr><td colspan="5" class="fb-empty">No sync activity yet.</td></tr></tbody></table></div></div>
    </article>
</div>
<script>
(() => {
    const q = (id) => document.getElementById(id);
    const rulesRows = q("rulesRows");
    const syncRows = q("syncRows");
    const dlqRows = q("dlqRows");
    const templatesList = q("templatesList");
    let settingsState = { templates: [] };

    const esc = (v) => (v ?? "").toString().replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
    const settingsPayload = () => ({
        integrationConnectionId: q("integrationConnectionId").value,
        webhookEnabled: q("webhookEnabled").checked,
        requireConsent: q("requireConsent").checked,
        pollingIntervalMinutes: Number(q("pollingIntervalMinutes").value || 10),
        dataRetentionDays: Number(q("dataRetentionDays").value || 180),
        responseSlaMinutes: Number(q("responseSlaMinutes").value || 10),
        workingHoursStart: q("workingHoursStart").value || "09:00",
        workingHoursEnd: q("workingHoursEnd").value || "18:00",
        templates: settingsState.templates || []
    });

    function renderTemplates() {
        const templates = settingsState.templates || [];
        if (!templates.length) {
            templatesList.innerHTML = `<div class="fb-empty">No templates saved yet.</div>`;
            return;
        }
        templatesList.innerHTML = templates.map((tpl, idx) => `
            <div class="fb-template-card">
                <div class="fb-template-head">
                    <div>
                        <div class="fb-template-name">${esc(tpl.name || "Untitled Template")}</div>
                        <div class="fb-template-meta">${esc(tpl.channel || "whatsapp")} ${tpl.isDefault ? "| default" : ""}</div>
                    </div>
                    <button class="fb-btn-danger" type="button" data-template-del="${idx}">Delete</button>
                </div>
                <div class="fb-template-grid">
                    <div class="fb-field"><label>Template Name</label><input class="fb-input" data-template-name="${idx}" value="${esc(tpl.name || "")}" placeholder="Template name" /></div>
                    <div class="fb-field"><label>Channel</label><select class="fb-select" data-template-channel="${idx}"><option value="whatsapp" ${tpl.channel === "whatsapp" ? "selected" : ""}>WhatsApp</option><option value="email" ${tpl.channel === "email" ? "selected" : ""}>Email</option><option value="quick_reply" ${tpl.channel === "quick_reply" ? "selected" : ""}>Quick Reply</option></select></div>
                    <div class="fb-field"><label>Subject</label><input class="fb-input" data-template-subject="${idx}" value="${esc(tpl.subject || "")}" placeholder="Subject for email templates" /></div>
                    <label class="fb-default-toggle"><input type="checkbox" data-template-default="${idx}" ${tpl.isDefault ? "checked" : ""} /><span>Set as default template</span></label>
                </div>
                <div class="fb-field"><label>Template Body</label><textarea class="fb-textarea" data-template-body="${idx}" placeholder="Write the full response template">${esc(tpl.body || "")}</textarea></div>
            </div>
        `).join("");

        templatesList.querySelectorAll("[data-template-del]").forEach(btn => btn.addEventListener("click", () => { settingsState.templates.splice(Number(btn.dataset.templateDel), 1); renderTemplates(); }));
        templatesList.querySelectorAll("[data-template-name]").forEach(input => input.addEventListener("input", () => settingsState.templates[Number(input.dataset.templateName)].name = input.value));
        templatesList.querySelectorAll("[data-template-channel]").forEach(input => input.addEventListener("change", () => settingsState.templates[Number(input.dataset.templateChannel)].channel = input.value));
        templatesList.querySelectorAll("[data-template-subject]").forEach(input => input.addEventListener("input", () => settingsState.templates[Number(input.dataset.templateSubject)].subject = input.value));
        templatesList.querySelectorAll("[data-template-body]").forEach(input => input.addEventListener("input", () => settingsState.templates[Number(input.dataset.templateBody)].body = input.value));
        templatesList.querySelectorAll("[data-template-default]").forEach(input => input.addEventListener("change", () => {
            const idx = Number(input.dataset.templateDefault);
            settingsState.templates.forEach((tpl, i) => tpl.isDefault = i === idx ? input.checked : false);
            renderTemplates();
        }));
    }

    async function loadSettings() {
        const id = q("integrationConnectionId").value;
        if (!id) return;
        const res = await fetch(`/api/social/facebook/settings?integrationConnectionId=${encodeURIComponent(id)}`, { credentials: "same-origin" });
        const data = await res.json();
        const s = data.settings || {};
        settingsState = { templates: Array.isArray(s.templates) ? s.templates : [] };
        q("webhookEnabled").checked = s.webhookEnabled ?? true;
        q("requireConsent").checked = !!s.requireConsent;
        q("pollingIntervalMinutes").value = s.pollingIntervalMinutes ?? 10;
        q("dataRetentionDays").value = s.dataRetentionDays ?? 180;
        q("responseSlaMinutes").value = s.responseSlaMinutes ?? 10;
        q("workingHoursStart").value = s.workingHoursStart || "09:00";
        q("workingHoursEnd").value = s.workingHoursEnd || "18:00";
        renderTemplates();
    }

    async function saveSettings() {
        const res = await fetch(`/api/social/facebook/settings`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            credentials: "same-origin",
            body: JSON.stringify(settingsPayload())
        });
        q("settingsStatus").textContent = res.ok ? "Settings saved." : "Unable to save settings.";
        await loadHealth();
    }

    async function loadHealth() {
        const id = q("integrationConnectionId").value;
        if (!id) return;
        const res = await fetch(`/api/social/facebook/ops/health?integrationConnectionId=${encodeURIComponent(id)}`, { credentials: "same-origin" });
        const data = await res.json();
        const h = data.health || {};
        q("healthWebhook").textContent = h.webhookEnabled ? "Enabled" : "Disabled";
        q("healthSla").textContent = h.slaBreaches ?? 0;
        q("healthDlq").textContent = h.openDeadLetters ?? 0;
        q("healthFailures").textContent = h.recentSyncFailures ?? 0;
        q("healthLeads").textContent = h.leadsTracked ?? 0;
        q("healthConsent").textContent = h.requireConsent ? "On" : "Off";
    }

    async function loadRules() {
        const id = q("integrationConnectionId").value;
        const res = await fetch(`/api/social/facebook/auto-rules?integrationConnectionId=${encodeURIComponent(id)}`, { credentials: "same-origin" });
        const data = await res.json();
        const rows = Array.isArray(data.rows) ? data.rows : [];
        if (!rows.length) {
            rulesRows.innerHTML = `<tr><td colspan="5" class="fb-empty">No rules yet.</td></tr>`;
            return;
        }
        rulesRows.innerHTML = rows.map(r => `<tr><td>${esc(r.eventType)}</td><td>${esc(r.workflowId)}</td><td><span class="fb-chip ${r.isEnabled ? "ok" : "warn"}">${r.isEnabled ? "enabled" : "disabled"}</span></td><td>${new Date(r.updatedAtUtc).toLocaleString()}</td><td><button class="fb-btn-danger" type="button" data-del="${r.id}">Delete</button></td></tr>`).join("");
        rulesRows.querySelectorAll("button[data-del]").forEach(btn => btn.addEventListener("click", async () => {
            await fetch(`/api/social/facebook/auto-rules/${btn.getAttribute("data-del")}`, { method: "DELETE", credentials: "same-origin" });
            await loadRules();
        }));
    }

    async function addRule() {
        const body = { integrationConnectionId: q("integrationConnectionId").value, eventType: q("eventType").value, workflowId: q("workflowId").value, isEnabled: true, conditionsJson: q("conditionsJson").value || "{}" };
        await fetch(`/api/social/facebook/auto-rules`, { method: "POST", headers: { "Content-Type": "application/json" }, credentials: "same-origin", body: JSON.stringify(body) });
        await loadRules();
    }

    async function loadSyncLogs() {
        const id = q("integrationConnectionId").value;
        const res = await fetch(`/api/social/facebook/sync/logs?integrationConnectionId=${encodeURIComponent(id)}`, { credentials: "same-origin" });
        const data = await res.json();
        const rows = Array.isArray(data.rows) ? data.rows : [];
        if (!rows.length) {
            syncRows.innerHTML = `<tr><td colspan="5" class="fb-empty">No sync activity yet.</td></tr>`;
            return;
        }
        syncRows.innerHTML = rows.map(r => `<tr><td>${esc(r.scope)}</td><td><span class="fb-chip ${r.status === "success" ? "ok" : "err"}">${esc(r.status)}</span></td><td>${new Date(r.startedAtUtc).toLocaleString()}</td><td>${new Date(r.endedAtUtc).toLocaleString()}</td><td><span class="fb-code">${esc(JSON.stringify(r.counts || {}))}</span></td></tr>`).join("");
    }

    async function loadDlq() {
        const id = q("integrationConnectionId").value;
        const res = await fetch(`/api/social/facebook/dead-letter?integrationConnectionId=${encodeURIComponent(id)}`, { credentials: "same-origin" });
        const data = await res.json();
        const rows = Array.isArray(data.rows) ? data.rows : [];
        if (!rows.length) {
            dlqRows.innerHTML = `<tr><td colspan="5" class="fb-empty">No failed events.</td></tr>`;
            return;
        }
        dlqRows.innerHTML = rows.map(r => `<tr><td>${esc(r.eventType)}</td><td>${r.attempts ?? 0}</td><td>${new Date(r.createdAtUtc).toLocaleString()}</td><td><span class="fb-chip ${r.resolvedAtUtc ? "ok" : "warn"}">${r.resolvedAtUtc ? "resolved" : "pending"}</span></td><td><button class="fb-btn-warn" type="button" data-retry="${r.id}">Retry</button></td></tr>`).join("");
        dlqRows.querySelectorAll("[data-retry]").forEach(btn => btn.addEventListener("click", async () => {
            await fetch(`/api/social/facebook/dead-letter/${btn.dataset.retry}/retry`, { method: "POST", credentials: "same-origin" });
            await loadDlq();
            await loadSyncLogs();
            await loadHealth();
        }));
    }

    q("integrationConnectionId").addEventListener("change", async () => { await loadSettings(); await loadHealth(); await loadRules(); await loadSyncLogs(); await loadDlq(); });
    q("saveSettingsBtn").addEventListener("click", saveSettings);
    q("refreshOpsBtn").addEventListener("click", async () => { await loadHealth(); await loadSyncLogs(); await loadDlq(); });
    q("addRuleBtn").addEventListener("click", addRule);
    q("addTemplateBtn").addEventListener("click", () => { settingsState.templates.push({ id: crypto.randomUUID(), channel: "whatsapp", name: "New template", subject: "", body: "", isDefault: false }); renderTemplates(); });

    if (q("integrationConnectionId").value) {
        loadSettings();
        loadHealth();
        loadRules();
        loadSyncLogs();
        loadDlq();
    }
})();
</script>
