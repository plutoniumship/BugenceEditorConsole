@* Shared top navbar matching dashboard design *@
@using System.Security.Claims
@inject BugenceEditConsole.Data.ApplicationDbContext Db
@inject Microsoft.AspNetCore.Identity.UserManager<BugenceEditConsole.Models.ApplicationUser> UserManager
@inject BugenceEditConsole.Services.ISubscriptionService SubscriptionService
@{
    var githubUser = User?.Claims?.FirstOrDefault(c => c.Type == "github:username")?.Value;
    var githubProfile = User?.Claims?.FirstOrDefault(c => c.Type == "github:url")?.Value;
    var isGithubConnected = !string.IsNullOrWhiteSpace(githubUser);
    var returnUrl = Context?.Request?.Path + Context?.Request?.QueryString;
    var currentUserId = UserManager.GetUserId(User);
    var currentUser = string.IsNullOrWhiteSpace(currentUserId) ? null : await UserManager.GetUserAsync(User);
    var displayName = currentUser?.GetFriendlyName();
    if (string.IsNullOrWhiteSpace(displayName))
    {
        displayName = User?.Identity?.Name ?? "Administrator";
    }
    var displayEmail = currentUser?.Email ?? User?.Claims?.FirstOrDefault(c => c.Type == System.Security.Claims.ClaimTypes.Email)?.Value ?? "admin@bugence.com";
    var initials = new string((displayName ?? "AD")
        .Split(' ', StringSplitOptions.RemoveEmptyEntries)
        .Select(p => char.ToUpperInvariant(p[0]))
        .Take(2)
        .ToArray());
    if (string.IsNullOrWhiteSpace(initials))
    {
        initials = "AD";
    }
    var subscription = string.IsNullOrWhiteSpace(currentUserId) ? null : await SubscriptionService.GetOrStartTrialAsync(currentUserId);
    var plan = BugenceEditConsole.Services.BillingPlanCatalog.GetPlan(subscription?.PlanKey);
    var planBadge = subscription?.Status?.Equals("Trial", StringComparison.OrdinalIgnoreCase) == true ? "TRIAL" : (plan?.Key?.ToUpperInvariant() ?? "STARTER");
}
<style>
    :root { --dash-muted: #737373; --dash-border: rgba(255,255,255,0.08); }
    .shell > aside, .dashboard-container > aside, aside.sidebar, .sidebar {
        overflow-y: auto;
    }
    aside, .sidebar {
        scrollbar-width: thin;
        scrollbar-color: rgba(148,163,184,0.45) transparent;
    }
    aside::-webkit-scrollbar, .sidebar::-webkit-scrollbar { width: 8px; }
    aside::-webkit-scrollbar-track, .sidebar::-webkit-scrollbar-track { background: transparent; }
    aside::-webkit-scrollbar-thumb, .sidebar::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.35); border-radius: 999px; }
    aside::-webkit-scrollbar-thumb:hover, .sidebar::-webkit-scrollbar-thumb:hover { background: rgba(148,163,184,0.55); }
    .dash-topbar { display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap; margin-bottom:35px; position:relative; z-index:120; overflow:visible; }
    .dash-search { position:relative; width:360px; max-width:100%; }
    .dash-search input { width:100%; background:#0a0a0a; border:1px solid rgba(255,255,255,0.08); padding:12px 12px 12px 45px; border-radius:12px; color:white; font-family:inherit; transition:0.2s; }
    .dash-search input:focus { border-color:#06b6d4; box-shadow:0 0 0 4px rgba(6,182,212,0.1); outline:none; }
    .dash-search .icon { position:absolute; left:16px; top:50%; transform:translateY(-50%); color:#737373; }
    .dash-user-menu { display:flex; gap:10px; align-items:center; flex-wrap:wrap; overflow:visible; }
    .dash-icon-btn { background:#0a0a0a; border:1px solid rgba(255,255,255,0.08); width:40px; height:40px; border-radius:10px; display:grid; place-items:center; color:#737373; cursor:pointer; transition:0.2s; position:relative; }
    .dash-icon-btn svg { width:18px; height:18px; display:block; }
    .dash-icon-btn:hover, .dash-icon-btn.active { color:white; border-color:#444; background:#1a1a1a; }
    .dash-noti-dot { position:absolute; top:-2px; right:-2px; width:8px; height:8px; background:#06b6d4; border-radius:50%; border:2px solid #020202; display:none; }
    .dash-noti-count {
        position:absolute;
        top:-7px;
        right:-9px;
        min-width:20px;
        height:20px;
        padding:0 6px;
        border-radius:999px;
        border:2px solid #020202;
        background:linear-gradient(135deg,#ef4444,#f59e0b);
        color:#fff;
        font-size:0.7rem;
        font-weight:800;
        display:none;
        align-items:center;
        justify-content:center;
    }
    .dash-dropdown { position:relative; overflow:visible; }
    .dash-dropdown-menu { position:absolute; top:120%; right:0; width:260px; background:#0c0c0c; border:1px solid rgba(255,255,255,0.08); border-radius:16px; box-shadow:0 10px 40px -10px rgba(0,0,0,0.8); opacity:0; transform:translateY(-10px); pointer-events:none; transition:0.2s cubic-bezier(0.16,1,0.3,1); z-index:3000; overflow:hidden; max-height: min(60vh, 420px); }
    .dash-dropdown-menu.show { opacity:1; transform:translateY(0); pointer-events:auto; }
    .dash-dd-body { padding:8px; display:flex; flex-direction:column; }
    .dash-noti-header {
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:8px;
        padding:10px 10px 8px;
        border-bottom:1px solid rgba(255,255,255,0.08);
        margin:-8px -8px 8px;
    }
    .dash-noti-title { font-size:0.82rem; font-weight:800; color:#e5e7eb; letter-spacing:0.02em; }
    .dash-noti-actions { display:flex; align-items:center; gap:6px; }
    .dash-noti-action {
        background:rgba(255,255,255,0.04);
        border:1px solid rgba(255,255,255,0.12);
        color:#d1d5db;
        border-radius:8px;
        padding:5px 8px;
        font-size:0.7rem;
        font-weight:700;
        cursor:pointer;
    }
    .dash-noti-action:hover { border-color:#06b6d4; color:#fff; }
    .dash-noti-item {
        display:flex;
        align-items:flex-start;
        gap:10px;
        padding:10px;
        border-radius:10px;
        text-decoration:none;
        border:1px solid transparent;
        cursor:pointer;
    }
    .dash-noti-item:hover { background:rgba(255,255,255,0.04); border-color:rgba(255,255,255,0.08); }
    .dash-noti-icon {
        width:28px;
        height:28px;
        border-radius:9px;
        display:grid;
        place-items:center;
        background:rgba(6,182,212,0.14);
        color:#7de9ff;
        flex-shrink:0;
        margin-top:1px;
    }
    .dash-noti-content { min-width:0; display:flex; flex-direction:column; gap:3px; }
    .dash-noti-content strong {
        font-size:0.82rem;
        color:#f5f5f5;
        line-height:1.25;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
    }
    .dash-noti-content p {
        margin:0;
        font-size:0.74rem;
        color:#9ca3af;
        line-height:1.3;
        overflow:hidden;
        display:-webkit-box;
        -webkit-line-clamp:2;
        -webkit-box-orient:vertical;
    }
    .dash-noti-meta {
        display:flex;
        align-items:center;
        gap:6px;
        font-size:0.68rem;
        color:#7c8798;
        text-transform:uppercase;
        letter-spacing:0.05em;
    }
    .dash-noti-unread {
        width:7px;
        height:7px;
        border-radius:50%;
        background:#06b6d4;
        box-shadow:0 0 0 3px rgba(6,182,212,0.12);
    }
    .dash-dd-item { display:flex; align-items:center; gap:10px; padding:10px; border-radius:10px; color:#ccc; text-decoration:none; font-weight:600; font-size:0.9rem; }
    .dash-dd-item:hover { background:rgba(255,255,255,0.05); color:white; }
    .dash-github-card {
        background:#0a0a0a; border:1px solid rgba(255,255,255,0.08); border-radius:12px;
        padding:6px 12px; display:flex; align-items:center; gap:10px; color:#e5e7eb;
        cursor:pointer; transition:0.2s; min-height:40px;
    }
    .dash-github-card:hover { border-color:#444; background:#121212; }
    .dash-github-icon { width:28px; height:28px; border-radius:8px; background:#111; display:grid; place-items:center; color:white; }
    .dash-github-meta { display:flex; flex-direction:column; line-height:1.1; }
    .dash-github-meta strong { font-size:0.85rem; }
    .dash-github-meta span { font-size:0.72rem; color:#737373; }
    .is-hidden { display:none !important; }
    .dash-avatar-chip { background:#119bb3; color:black; border:none; border-radius:12px; padding:8px 14px; display:flex; align-items:center; gap:10px; cursor:pointer; }
    .dash-avatar-dot { width:34px; height:34px; border-radius:50%; background:white; color:black; display:grid; place-items:center; font-weight:800; }
    .dash-avatar-meta { display:flex; flex-direction:column; line-height:1.1; }
    .dash-cta { background:#d49506; color:black; border:none; padding:10px 16px; border-radius:10px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
    .github-modal {
        position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(6px); z-index: 2000;
    }
    .github-modal.show { display: flex; }
    .github-card {
        width: min(520px, 92vw); background: #0c0c0c; border: 1px solid rgba(255,255,255,0.08);
        border-radius: 20px; padding: 26px; box-shadow: 0 30px 80px rgba(0,0,0,0.7);
    }
    .github-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .github-badge { width: 48px; height: 48px; border-radius: 12px; background: #111; display: grid; place-items: center; color: white; font-size: 1.4rem; }
    .github-title { font-size: 1.4rem; font-weight: 800; margin: 0; }
    .github-desc { color: #737373; font-size: 0.95rem; margin: 0 0 18px; }
    .github-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 18px; }
    .github-btn {
        padding: 10px 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08);
        background: #111; color: white; font-weight: 700; cursor: pointer;
    }
    .github-btn.primary { background: #22c55e; color: #05140b; border-color: transparent; }
    .dash-toast-tray {
        position: fixed; left: 24px; bottom: 24px; display: flex; flex-direction: column; gap: 10px;
        z-index: 2500; pointer-events: none;
    }
    .dash-toast {
        background: #0b0b0b; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
        padding: 12px 14px; min-width: 260px; color: #e5e7eb; box-shadow: 0 18px 50px rgba(0,0,0,0.6);
        transform: translateY(8px); opacity: 0; transition: 0.2s ease;
    }
    .dash-toast.show { transform: translateY(0); opacity: 1; }
    .dash-toast strong { display: block; font-size: 0.9rem; margin-bottom: 2px; }
    .dash-toast small { color: #9ca3af; font-size: 0.78rem; }
    .session-lock-modal {
        position: fixed;
        inset: 0;
        z-index: 3600;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(2, 6, 23, 0.78);
        backdrop-filter: blur(6px);
    }
    .session-lock-modal.show { display: flex; }
    .session-lock-card {
        width: min(460px, 92vw);
        background: #0b0f16;
        border: 1px solid rgba(148,163,184,0.24);
        border-radius: 16px;
        box-shadow: 0 24px 60px rgba(0,0,0,0.6);
        padding: 20px;
    }
    .session-lock-head {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #f8fafc;
        font-weight: 800;
        font-size: 1rem;
    }
    .session-lock-icon {
        width: 34px;
        height: 34px;
        border-radius: 10px;
        background: rgba(239,68,68,0.18);
        border: 1px solid rgba(239,68,68,0.44);
        color: #fecaca;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .session-lock-body {
        margin-top: 12px;
        color: #cbd5e1;
        font-size: 0.9rem;
        line-height: 1.5;
    }
    .session-lock-foot {
        margin-top: 14px;
        color: #94a3b8;
        font-size: 0.82rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
    }
    .session-lock-btn {
        border: 1px solid rgba(239,68,68,0.45);
        background: rgba(239,68,68,0.13);
        color: #fee2e2;
        border-radius: 10px;
        padding: 8px 12px;
        font-size: 0.8rem;
        font-weight: 700;
        cursor: pointer;
    }
    .session-lock-btn:hover { border-color: rgba(239,68,68,0.68); color: #fff; }
    @@media (max-width: 1024px) {
        .dash-topbar {
            gap: 12px;
            margin-bottom: 18px;
            padding-top: 2px;
        }
        .dash-search {
            width: 100%;
            order: 2;
        }
        .dash-search input {
            min-height: 42px;
            font-size: 0.95rem;
        }
        .dash-user-menu {
            width: 100%;
            justify-content: space-between;
            gap: 8px;
            order: 1;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 2px;
        }
        .dash-user-menu > div:first-child {
            display: none !important;
        }
        .dash-github-card {
            min-height: 38px;
            padding: 6px 8px;
        }
        .dash-github-meta span { display: none; }
        .dash-avatar-chip {
            padding: 6px 8px;
            border-radius: 10px;
            gap: 8px;
        }
        .dash-avatar-dot {
            width: 30px;
            height: 30px;
        }
        .dash-avatar-meta strong {
            font-size: 0.86rem !important;
            max-width: 118px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dash-avatar-meta span {
            font-size: 0.7rem !important;
        }
        .dash-cta {
            padding: 9px 12px;
            border-radius: 10px;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .dash-dropdown-menu {
            width: min(92vw, 320px);
            right: 0;
            max-height: 62vh;
        }
    }
    @@media (max-width: 640px) {
        .dash-user-menu {
            gap: 6px;
        }
        .dash-icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 9px;
        }
        .dash-avatar-meta span {
            display: none;
        }
        .dash-cta {
            padding: 8px 10px;
            font-size: 0.85rem;
        }
    }
</style>

<div class="dash-topbar">
    <div class="dash-search">
        <i class="fa-solid fa-search icon"></i>
        <input type="text" id="globalSearch" placeholder="Search projects, logs, or files..." oninput="window.filterDashboard?.()" />
    </div>
    <div class="dash-user-menu">
        <div style="display:flex; align-items:center; gap:8px; font-size:0.8rem; color:#737373;">
            <div style="width:8px; height:8px; background:#10b981; border-radius:50%; box-shadow:0 0 5px #10b981;"></div> Operational
        </div>
        <div class="dash-dropdown">
            <button class="dash-icon-btn @(isGithubConnected ? "is-hidden" : "")" id="githubSyncBtn" title="Sync GitHub"><i class="fa-brands fa-github"></i></button>
            <button class="dash-github-card @(isGithubConnected ? "" : "is-hidden")" id="githubConnected" data-dropdown-toggle="githubMenu" type="button">
                <div class="dash-github-icon"><i class="fa-brands fa-github"></i></div>
                <div class="dash-github-meta">
                    <strong id="githubName">@(!string.IsNullOrWhiteSpace(githubUser) ? githubUser : "GitHub Connected")</strong>
                    <span id="githubTag">@(!string.IsNullOrWhiteSpace(githubUser) ? $"@{githubUser}" : "@connected")</span>
                </div>
                <i class="fa-solid fa-chevron-down" style="margin-left:auto; font-size:0.75rem; color:#737373;"></i>
            </button>
            <div class="dash-dropdown-menu" id="githubMenu">
                <div class="dash-dd-body">
                    <a class="dash-dd-item" id="githubProfileLink" href="@(string.IsNullOrWhiteSpace(githubProfile) ? "https://github.com" : githubProfile)" target="_blank" rel="noreferrer"><i class="fa-solid fa-user" style="width:20px;"></i> View GitHub Profile</a>
                    <button class="dash-dd-item" type="button" id="githubSyncNow"><i class="fa-solid fa-rotate" style="width:20px;"></i> Sync repositories</button>
                    <button class="dash-dd-item" type="button" id="githubManageWebhooks"><i class="fa-solid fa-plug" style="width:20px;"></i> Manage webhooks</button>
                    <div style="height:1px; background:rgba(255,255,255,0.08); margin:6px 0;"></div>
                    <form method="post" asp-page="/Auth/GitHubDisconnect" asp-route-returnUrl="@returnUrl" style="margin:0;">
                        @Html.AntiForgeryToken()
                        <button class="dash-dd-item" type="submit" style="color:#ef4444; width:100%; background:none; border:0; text-align:left;">
                            <i class="fa-solid fa-right-from-bracket" style="width:20px;"></i> Logout GitHub
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <div class="dash-dropdown">
            <div class="dash-icon-btn" data-dropdown-toggle="notiMenu">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path fill="currentColor" d="M12 3a5 5 0 0 0-5 5v2.2c0 .7-.26 1.38-.73 1.9L5 13.4V15h14v-1.6l-1.27-1.3A2.7 2.7 0 0 1 17 10.2V8a5 5 0 0 0-5-5Zm0 18a2.5 2.5 0 0 0 2.45-2h-4.9A2.5 2.5 0 0 0 12 21Z"/>
                </svg>
                <div class="dash-noti-dot"></div>
                <span class="dash-noti-count" id="dashNotiCount">0</span>
            </div>
            <div class="dash-dropdown-menu" id="notiMenu">
                <div class="dash-dd-body" id="dashNotiList">
                    <div class="dash-dd-item" style="justify-content:center; color:#737373;">Loading notifications...</div>
                </div>
                <a href="/Support/Notifications" style="display:block; text-align:center; padding:10px; font-size:0.8rem; color:var(--dash-muted); border-top:1px solid var(--dash-border); text-decoration:none;">View All</a>
            </div>
        </div>
        <div class="dash-dropdown">
            <div class="dash-avatar-chip" data-dropdown-toggle="topbarProfileMenu">
                <div class="dash-avatar-dot" data-profile-initials>@initials</div>
                <div class="dash-avatar-meta">
                    <strong style="font-size:0.95rem;" data-profile-name>@displayName</strong>
                    <span style="font-size:0.8rem;">@planBadge PLAN</span>
                </div>
                <i class="fa-solid fa-chevron-down" style="font-size:0.8rem; color:#0f172a;"></i>
            </div>
            <div class="dash-dropdown-menu" id="topbarProfileMenu">
                <div class="dash-dd-body">
                    <a href="/Settings/Profile" class="dash-dd-item"><i class="fa-solid fa-user-gear" style="width:20px;"></i> Account</a>
                    <a href="/Settings/Teams" class="dash-dd-item"><i class="fa-solid fa-users" style="width:20px;"></i> Team</a>
                    <a href="/Settings/Billing" class="dash-dd-item"><i class="fa-solid fa-credit-card" style="width:20px;"></i> Billing</a>
                    <div style="height:1px; background:rgba(255,255,255,0.08); margin:6px 0;"></div>
                    <a href="/Auth/Logout" class="dash-dd-item" style="color:#ef4444;"><i class="fa-solid fa-right-from-bracket" style="width:20px;"></i> Sign Out</a>
                </div>
            </div>
        </div>
        <button class="dash-cta" id="openProjectModal" type="button"><i class="fa-solid fa-plus"></i> New Project</button>
    </div>
</div>

<div class="github-modal" id="githubModal">
    <div class="github-card">
        <div class="github-header">
            <div class="github-badge"><i class="fa-brands fa-github"></i></div>
            <div>
                <div class="github-title">Connect GitHub</div>
                <div class="plan-badge">SYNC REQUIRED</div>
            </div>
        </div>
        <p class="github-desc" id="githubModalDesc">Login to your GitHub account to sync repositories and enable automated deployments.</p>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <div class="dash-dd-item" style="background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:10px;">
                <i class="fa-solid fa-check"></i> Deploy from branches
            </div>
            <div class="dash-dd-item" style="background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:10px;">
                <i class="fa-solid fa-check"></i> Commit history
            </div>
            <div class="dash-dd-item" style="background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:10px;">
                <i class="fa-solid fa-check"></i> Auto sync
            </div>
        </div>
        <div class="github-actions">
            <button class="github-btn" id="githubCancel" type="button">Cancel</button>
            <a class="github-btn primary" href="/Auth/GitHub?returnUrl=@(System.Net.WebUtility.UrlEncode(returnUrl ?? "/Dashboard/Index"))">Continue with GitHub</a>
        </div>
    </div>
</div>

<div class="dash-toast-tray" id="dashToastTray"></div>
<div class="session-lock-modal" id="sessionLockModal" aria-live="assertive" aria-modal="true" role="dialog">
    <div class="session-lock-card">
        <div class="session-lock-head">
            <span class="session-lock-icon"><i class="fa-solid fa-shield-exclamation"></i></span>
            Session Ended
        </div>
        <div class="session-lock-body">
            Your account was signed in on another device. This session has been securely logged out.
        </div>
        <div class="session-lock-foot">
            <span id="sessionLockCountdown">Redirecting to login in 4s...</span>
            <button type="button" class="session-lock-btn" id="sessionLockLoginNow">Login now</button>
        </div>
    </div>
</div>

<script>
    document.querySelectorAll('[data-dropdown-toggle]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = btn.getAttribute('data-dropdown-toggle');
            document.querySelectorAll('.dash-dropdown-menu').forEach(m => { if (m.id !== id) m.classList.remove('show'); });
            const menu = document.getElementById(id);
            menu?.classList.toggle('show');
        });
    });
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.dash-dropdown')) {
            document.querySelectorAll('.dash-dropdown-menu').forEach(m => m.classList.remove('show'));
        }
    });
    const githubBtn = document.getElementById('githubSyncBtn');
    const githubModal = document.getElementById('githubModal');
    const githubCancel = document.getElementById('githubCancel');
    const githubConnected = document.getElementById('githubConnected');
    const githubProfileLink = document.getElementById('githubProfileLink');
    const githubSyncNow = document.getElementById('githubSyncNow');
    const githubManageWebhooks = document.getElementById('githubManageWebhooks');

    githubBtn?.addEventListener('click', () => githubModal?.classList.add('show'));
    githubCancel?.addEventListener('click', () => githubModal?.classList.remove('show'));
    githubModal?.addEventListener('click', (e) => {
        if (e.target === githubModal) githubModal.classList.remove('show');
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') githubModal?.classList.remove('show');
    });
    githubSyncNow?.addEventListener('click', () => githubModal?.classList.add('show'));
    githubManageWebhooks?.addEventListener('click', () => githubModal?.classList.add('show'));

    const newProjectBtn = document.getElementById('openProjectModal');
    newProjectBtn?.addEventListener('click', () => {
        if (typeof window.showProjectModal === 'function') {
            window.showProjectModal();
            return;
        }
        window.location.href = '/Dashboard/Index?openProject=1';
    });

    const params = new URLSearchParams(window.location.search);
    if (params.get('githubError') === 'not_configured') {
        githubModal?.classList.add('show');
        const desc = document.getElementById('githubModalDesc');
        if (desc) {
            desc.textContent = 'GitHub OAuth is not configured yet. Add Authentication:GitHub:ClientId and Authentication:GitHub:ClientSecret to enable sign-in.';
        }
    }

    const avatarStorageKey = 'bugence.account.avatar';
    const applyStoredAvatar = () => {
        const stored = localStorage.getItem(avatarStorageKey);
        if (!stored) return;
        document.querySelectorAll('.dash-avatar-dot, .avatar-dot, .profile-avatar').forEach((el) => {
            if (!(el instanceof HTMLElement)) return;
            el.style.backgroundImage = `url("${stored}")`;
            el.style.backgroundSize = 'cover';
            el.style.backgroundPosition = 'center';
            el.textContent = '';
        });
    };
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyStoredAvatar);
    } else {
        applyStoredAvatar();
    }

    const dashToastTray = document.getElementById('dashToastTray');
    window.showDashToast = (title, message) => {
        if (!dashToastTray) return;
        const toast = document.createElement('div');
        toast.className = 'dash-toast';
        toast.innerHTML = `<strong>${title}</strong><small>${message || ""}</small>`;
        dashToastTray.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('show'));
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 240);
        }, 4200);
    };

    const notiList = document.getElementById('dashNotiList');
    const notiDot = document.querySelector('.dash-noti-dot');
    const notiCount = document.getElementById('dashNotiCount');
    const toRelativeTime = (value) => {
        if (!value) return '';
        const parsed = new Date(value);
        const deltaMs = Date.now() - parsed.getTime();
        const deltaSec = Math.floor(deltaMs / 1000);
        if (deltaSec < 60) return 'just now';
        const deltaMin = Math.floor(deltaSec / 60);
        if (deltaMin < 60) return `${deltaMin}m ago`;
        const deltaHour = Math.floor(deltaMin / 60);
        if (deltaHour < 24) return `${deltaHour}h ago`;
        const deltaDay = Math.floor(deltaHour / 24);
        if (deltaDay < 30) return `${deltaDay}d ago`;
        return parsed.toLocaleDateString();
    };
    const escapeHtml = (value) => (value ?? '')
        .toString()
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('\"', '&quot;')
        .replaceAll("'", '&#39;');

    const markNotificationsRead = async () => {
        try {
            await fetch('/api/notifications/read-all', {
                method: 'POST',
                credentials: 'include'
            });
        } catch {
            // ignore
        } finally {
            refreshNotifications();
        }
    };

    const clearNotifications = async () => {
        try {
            await fetch('/api/notifications/clear', {
                method: 'POST',
                credentials: 'include'
            });
        } catch {
            // ignore
        } finally {
            refreshNotifications();
        }
    };

    window.refreshNotifications = async () => {
        if (!notiList) return;
        try {
            const res = await fetch('/api/notifications?take=8', { credentials: 'include' });
            if (!res.ok) throw new Error('Failed');
            const data = await res.json();
            notiList.innerHTML = '';
            const header = document.createElement('div');
            header.className = 'dash-noti-header';
            header.innerHTML = `
                <span class="dash-noti-title">Notifications</span>
                <div class="dash-noti-actions">
                    <button class="dash-noti-action" type="button" id="notiReadAll">Mark Read</button>
                    <button class="dash-noti-action" type="button" id="notiClearAll">Clear</button>
                </div>`;
            notiList.appendChild(header);

            (data.items || []).forEach(item => {
                const icon = item.type === 'success'
                    ? 'fa-check'
                    : item.type === 'warning'
                    ? 'fa-triangle-exclamation'
                    : item.type === 'danger'
                    ? 'fa-circle-xmark'
                    : 'fa-bell';
                const row = document.createElement('div');
                row.className = 'dash-noti-item';
                const title = escapeHtml(item.title || 'Notification');
                const message = escapeHtml(item.message || '');
                const typeLabel = escapeHtml(item.type || 'info');
                const unreadDot = item.isRead ? '' : '<span class=\"dash-noti-unread\"></span>';
                row.innerHTML = `
                    <div class="dash-noti-icon"><i class="fa-solid ${icon}"></i></div>
                    <div class="dash-noti-content">
                        <strong>${title}</strong>
                        <p>${message || 'No additional details provided.'}</p>
                        <div class="dash-noti-meta">${unreadDot}<span>${typeLabel}</span><span>â€¢</span><span>${toRelativeTime(item.createdAtUtc)}</span></div>
                    </div>`;
                notiList.appendChild(row);
            });
            if (!data.items || data.items.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'dash-dd-item';
                empty.style.justifyContent = 'center';
                empty.style.color = '#737373';
                empty.textContent = 'No notifications yet.';
                notiList.appendChild(empty);
            }
            const readAllBtn = document.getElementById('notiReadAll');
            const clearAllBtn = document.getElementById('notiClearAll');
            readAllBtn?.addEventListener('click', markNotificationsRead);
            clearAllBtn?.addEventListener('click', clearNotifications);
            if (notiDot instanceof HTMLElement) {
                notiDot.style.display = data.unreadCount > 0 ? 'block' : 'none';
            }
            if (notiCount instanceof HTMLElement) {
                const count = Number(data.unreadCount || 0);
                if (count > 0) {
                    notiCount.style.display = 'inline-flex';
                    notiCount.textContent = count > 99 ? '99+' : String(count);
                } else {
                    notiCount.style.display = 'none';
                }
            }
        } catch {
            notiList.innerHTML = '<div class="dash-dd-item" style="justify-content:center; color:#737373;">Unable to load notifications.</div>';
        }
    };
    refreshNotifications();

    let sessionCheckTimer = null;
    let sessionLockShown = false;
    let sessionRedirectStarted = false;
    let sessionCountdownTimer = null;
    const sessionLockStorageKey = 'bugence.concurrent-login.redirecting';
    const sessionLockModal = document.getElementById('sessionLockModal');
    const sessionLockCountdown = document.getElementById('sessionLockCountdown');
    const sessionLockLoginNow = document.getElementById('sessionLockLoginNow');

    const forceLogout = () => {
        if (sessionRedirectStarted) return;
        sessionRedirectStarted = true;
        try { sessionStorage.setItem(sessionLockStorageKey, '1'); } catch { }
        if (sessionCheckTimer) {
            window.clearInterval(sessionCheckTimer);
            sessionCheckTimer = null;
        }
        if (sessionCountdownTimer) {
            window.clearInterval(sessionCountdownTimer);
            sessionCountdownTimer = null;
        }
        const returnUrl = encodeURIComponent('/Auth/Login?reason=concurrent-login');
        window.location.replace(`/Auth/Logout?returnUrl=${returnUrl}`);
    };

    const showSessionLock = () => {
        if (sessionLockShown) return;
        sessionLockShown = true;
        sessionLockModal?.classList.add('show');
        let remaining = 4;
        if (sessionLockCountdown) {
            sessionLockCountdown.textContent = `Redirecting to login in ${remaining}s...`;
        }
        if (sessionCheckTimer) {
            window.clearInterval(sessionCheckTimer);
            sessionCheckTimer = null;
        }
        sessionCountdownTimer = window.setInterval(() => {
            remaining -= 1;
            if (remaining <= 0) {
                if (sessionCountdownTimer) {
                    window.clearInterval(sessionCountdownTimer);
                    sessionCountdownTimer = null;
                }
                forceLogout();
                return;
            }
            if (sessionLockCountdown) {
                sessionLockCountdown.textContent = `Redirecting to login in ${remaining}s...`;
            }
        }, 1000);
    };

    sessionLockLoginNow?.addEventListener('click', forceLogout);

    const checkSessionState = async () => {
        if (sessionLockShown) return;
        if (sessionRedirectStarted) return;
        try {
            const response = await fetch('/api/auth/session-state', {
                method: 'GET',
                credentials: 'include',
                cache: 'no-store'
            });
            if (response.status === 401) return;
            if (!response.ok) return;
            const data = await response.json();
            if (data?.valid === false && data?.reason === 'new_login_detected') {
                showSessionLock();
            }
        } catch {
            // Ignore transient errors.
        }
    };

    try {
        if (sessionStorage.getItem(sessionLockStorageKey) === '1') {
            sessionStorage.removeItem(sessionLockStorageKey);
        }
    } catch { }

    sessionCheckTimer = window.setInterval(checkSessionState, 5000);
    checkSessionState();
</script>
