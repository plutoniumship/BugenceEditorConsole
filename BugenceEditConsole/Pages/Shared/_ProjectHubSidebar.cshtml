@* Shared Project Hub sidebar with profile dropdown matching dashboard *@
@using BugenceEditConsole.Models
@inject Microsoft.AspNetCore.Identity.UserManager<ApplicationUser> UserManager
@{
    var projectIdValue = ViewContext.HttpContext?.Request?.Query["projectId"].ToString();
    var projectQuery = string.IsNullOrWhiteSpace(projectIdValue) ? string.Empty : $"?projectId={projectIdValue}";
    var currentUser = await UserManager.GetUserAsync(User);
    var displayName = currentUser?.GetFriendlyName();
    if (string.IsNullOrWhiteSpace(displayName))
    {
        displayName = User?.Identity?.Name ?? "Administrator";
    }
    var displayEmail = currentUser?.Email ?? User?.Claims?.FirstOrDefault(c => c.Type == System.Security.Claims.ClaimTypes.Email)?.Value ?? "admin@bugence.app";
    var initials = new string((displayName ?? "AD")
        .Split(' ', StringSplitOptions.RemoveEmptyEntries)
        .Select(p => char.ToUpperInvariant(p[0]))
        .Take(2)
        .ToArray());
    if (string.IsNullOrWhiteSpace(initials))
    {
        initials = "AD";
    }
}

<style>
    .ph-sidebar { width:260px; flex-shrink:0; background:#050505; border-right:1px solid rgba(255,255,255,0.08); padding:24px; display:flex; flex-direction:column; transition:width .2s ease, transform .22s ease; z-index:120; }
    .ph-topbar { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:16px; }
    .ph-collapsed-stack {
        display: none;
        width: 100%;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 8px;
    }
    .ph-brand-pill {
        width: 38px;
        height: 38px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(255,255,255,0.04);
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .ph-de-chip {
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(255,255,255,0.04);
        color: #e2e8f0;
        border-radius: 999px;
        height: 28px;
        min-width: 66px;
        padding: 0 8px;
        font-size: 0.72rem;
        font-weight: 700;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        cursor: default;
    }
    .ph-side-actions { display:flex; align-items:center; gap:6px; }
    .ph-side-btn { width:30px; height:30px; border-radius:8px; border:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.03); color:#d1d5db; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; }
    .ph-side-btn:hover { color:#fff; border-color:rgba(255,255,255,0.24); background:rgba(255,255,255,0.06); }
    .ph-edge-toggle {
        position: absolute;
        top: 50%;
        right: -14px;
        transform: translateY(-50%);
        width: 28px;
        height: 54px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.16);
        background: rgba(8,8,8,0.94);
        color: #d1d5db;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 165;
        box-shadow: 0 10px 24px rgba(0,0,0,0.35);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
    }
    .ph-edge-toggle:hover { color:#fff; border-color:rgba(255,255,255,0.28); background:rgba(16,16,16,0.98); }
    #phSidebarCloseBtn { display:none; }
    .ph-brand { font-family:'Cabinet Grotesk',sans-serif; font-weight:800; font-size:1.2rem; color:white; text-decoration:none; display:flex; align-items:center; gap:10px; }
    .ph-brand-text { white-space:nowrap; }
    .ph-back { margin-bottom:20px; color:#a1a1aa; font-size:0.9rem; text-decoration:none; display:flex; align-items:center; gap:8px; }
    .ph-back:hover { color:white; transform:translateX(-4px); transition:0.2s; }
    .ph-menu-title { margin:20px 0 10px 12px; font-size:0.7rem; text-transform:uppercase; letter-spacing:1px; color:#555; font-weight:700; }
    .ph-nav-item { display:flex; align-items:center; gap:12px; padding:10px 14px; border-radius:12px; color:#a1a1aa; text-decoration:none; font-weight:600; font-size:0.95rem; margin-bottom:4px; transition:all 0.2s; }
    .ph-nav-item:hover { background:rgba(255,255,255,0.05); color:white; }
    .ph-nav-item.active { background:rgba(6,182,212,0.1); color:#06b6d4; }
    .ph-profile { margin-top:auto; padding-top:16px; }
    .ph-avatar-chip { background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08); display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:white; cursor:pointer; transition:0.2s; position:relative; }
    .ph-avatar-chip:hover { background:#121212; }
    .ph-avatar-dot { width:34px; height:34px; border-radius:50%; background:linear-gradient(135deg,#2dd4bf,#06b6d4); color:#041017; font-weight:800; display:grid; place-items:center; }
    .ph-avatar-meta { display:flex; flex-direction:column; line-height:1.2; }
    .ph-dropdown { position:relative; }
    .ph-dropdown-menu { position:absolute; bottom:calc(100% + 8px); left:0; width:100%; background:#0c0c0c; border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:6px 0; display:none; flex-direction:column; box-shadow:0 10px 40px rgba(0,0,0,0.8); z-index:50; }
    .ph-dropdown-menu.show { display:flex; }
    .ph-profile-option { padding:10px 12px; color:#ccc; text-decoration:none; font-weight:600; display:flex; align-items:center; gap:10px; border-radius:8px; }
    .ph-profile-option:hover { background:rgba(255,255,255,0.05); color:white; }
    .ph-profile-option.danger { color:#ef4444; border-top:1px solid rgba(255,255,255,0.05); margin-top:4px; padding-top:12px; }
    .ph-mobile-toggle {
        position: fixed; top: 14px; left: 14px; z-index: 160;
        width: 40px; height: 40px; border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.14); background: rgba(8,8,8,0.92);
        color: #fff; display: none; align-items: center; justify-content: center;
        backdrop-filter: blur(8px);
    }
    .ph-mobile-backdrop {
        position: fixed; inset: 0; background: rgba(0,0,0,0.56);
        opacity: 0; pointer-events: none; transition: opacity .2s ease; z-index: 140;
    }
    body.ph-sidebar-collapsed .ph-sidebar { width:84px; padding-left:12px; padding-right:12px; }
    body.ph-sidebar-collapsed .ph-brand { justify-content:center; }
    body.ph-sidebar-collapsed .ph-collapsed-stack { display: inline-flex; }
    body.ph-sidebar-collapsed .ph-brand-text,
    body.ph-sidebar-collapsed .ph-menu-title,
    body.ph-sidebar-collapsed .ph-avatar-meta { display:none !important; }
    body.ph-sidebar-collapsed .ph-brand,
    body.ph-sidebar-collapsed .ph-side-actions { display:none !important; }
    body.ph-sidebar-collapsed .ph-back,
    body.ph-sidebar-collapsed .ph-nav-item {
        justify-content:center;
        gap:0;
        font-size:0;
    }
    body.ph-sidebar-collapsed .ph-back i,
    body.ph-sidebar-collapsed .ph-nav-item i {
        font-size:1rem;
        width:auto;
    }
    body.ph-sidebar-collapsed #phSidebarCollapseBtn i { transform: rotate(180deg); }
    body.ph-sidebar-collapsed .ph-edge-toggle { right: -18px; }
    body.ph-sidebar-collapsed .ph-edge-toggle i { transform: rotate(180deg); }
    @@media (max-width: 1024px) {
        .ph-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: min(82vw, 300px);
            max-width: 300px;
            transform: translateX(-102%);
            padding: 18px 14px;
        }
        .ph-mobile-toggle { display: inline-flex; }
        #phSidebarCollapseBtn { display: none; }
        .ph-edge-toggle { display: none; }
        #phSidebarCloseBtn { display: inline-flex; }
        body.ph-sidebar-open .ph-sidebar { transform: translateX(0); }
        body.ph-sidebar-open .ph-mobile-backdrop { opacity: 1; pointer-events: auto; }
        body.ph-sidebar-collapsed .ph-sidebar {
            width: min(82vw, 300px);
            padding-left: 14px;
            padding-right: 14px;
        }
        body.ph-sidebar-collapsed .ph-brand-text,
        body.ph-sidebar-collapsed .ph-menu-title,
        body.ph-sidebar-collapsed .ph-avatar-meta { display: initial !important; }
        body.ph-sidebar-collapsed .ph-brand,
        body.ph-sidebar-collapsed .ph-side-actions { display:inline-flex !important; }
        body.ph-sidebar-collapsed .ph-collapsed-stack { display: none !important; }
        body.ph-sidebar-collapsed .ph-back,
        body.ph-sidebar-collapsed .ph-nav-item {
            justify-content:flex-start;
            gap:12px;
            font-size:0.95rem;
        }
        body.ph-sidebar-collapsed .ph-back i,
        body.ph-sidebar-collapsed .ph-nav-item i {
            width:20px;
        }
    }
</style>

<button class="ph-mobile-toggle" id="phSidebarMobileToggle" type="button" aria-label="Open sidebar" aria-expanded="false">
    <i class="fa-solid fa-bars"></i>
</button>
<div class="ph-mobile-backdrop" id="phSidebarBackdrop"></div>
<aside class="ph-sidebar">
    <div class="ph-topbar">
        <div class="ph-collapsed-stack" aria-hidden="true">
            <span class="ph-brand-pill"><i class="fa-solid fa-bug" style="color:#06b6d4;"></i></span>
            <button class="ph-de-chip" type="button" tabindex="-1">Bugence DE <i class="fa-solid fa-chevron-down"></i></button>
        </div>
        <a href="/Dashboard/Index" class="ph-brand"><i class="fa-solid fa-bug" style="color:#06b6d4;"></i> <span class="ph-brand-text">BUGENCE</span></a>
        <div class="ph-side-actions">
            <button class="ph-side-btn" id="phSidebarCollapseBtn" type="button" aria-label="Minimize sidebar"><i class="fa-solid fa-chevron-left"></i></button>
            <button class="ph-side-btn" id="phSidebarCloseBtn" type="button" aria-label="Close sidebar"><i class="fa-solid fa-xmark"></i></button>
        </div>
    </div>
    <a class="ph-back" href="/Dashboard/Index"><i class="fa-solid fa-arrow-left"></i> Back to Dashboard</a>

    <div class="ph-menu-title">Project Menu</div>
    <a class="ph-nav-item @(((ViewContext.HttpContext?.Request?.Path.Value ?? string.Empty).Contains("/ProjectHub/Index", StringComparison.OrdinalIgnoreCase)) ? "active" : "")" href="@($"/ProjectHub/Index{projectQuery}")"><i class="fa-solid fa-layer-group"></i> Site Pages</a>
    <a class="ph-nav-item @(((ViewContext.HttpContext?.Request?.Path.Value ?? string.Empty).Contains("/ProjectHub/MediaAssets", StringComparison.OrdinalIgnoreCase)) ? "active" : "")" href="@($"/ProjectHub/MediaAssets{projectQuery}")"><i class="fa-solid fa-images"></i> Media Assets</a>
    <a class="ph-nav-item @(((ViewContext.HttpContext?.Request?.Path.Value ?? string.Empty).Contains("/ProjectHub/GlobalStyles", StringComparison.OrdinalIgnoreCase)) ? "active" : "")" href="@($"/ProjectHub/GlobalStyles{projectQuery}")"><i class="fa-solid fa-palette"></i> Global Styles</a>
    <a class="ph-nav-item @(((ViewContext.HttpContext?.Request?.Path.Value ?? string.Empty).Contains("/ProjectHub/CustomCode", StringComparison.OrdinalIgnoreCase)) ? "active" : "")" href="@($"/ProjectHub/CustomCode{projectQuery}")"><i class="fa-solid fa-code"></i> Custom Code</a>
    <a class="ph-nav-item @(((ViewContext.HttpContext?.Request?.Path.Value ?? string.Empty).Contains("/ProjectHub/ProductSettings", StringComparison.OrdinalIgnoreCase)) ? "active" : "")" href="@($"/ProjectHub/ProductSettings{projectQuery}")"><i class="fa-solid fa-gear"></i> Project Settings</a>
    <a class="ph-nav-item @(((ViewContext.HttpContext?.Request?.Path.Value ?? string.Empty).Contains("/Tools/ReactBuilder", StringComparison.OrdinalIgnoreCase)) ? "active" : "")" href="/Tools/ReactBuilder"><i class="fa-brands fa-react"></i> React Builder</a>

    <div class="ph-profile dropdown-wrapper" style="position:relative;">
        <div class="ph-avatar-chip" data-ph-profile>
            <div class="ph-avatar-dot" data-profile-initials>@initials</div>
            <div class="ph-avatar-meta">
                <strong style="font-size:0.95rem;" data-profile-name>@displayName</strong>
                <span style="font-size:0.8rem; color:#a1a1aa;" data-profile-email>@displayEmail</span>
            </div>
            <i class="fa-solid fa-chevron-up" style="margin-left:auto; font-size:0.8rem; color:#737373;"></i>
        </div>
        <div class="ph-dropdown-menu" id="phProfileMenu">
            <a href="/Settings/Profile" class="ph-profile-option"><i class="fa-solid fa-user-gear"></i> Account</a>
            <a href="/Settings/Teams" class="ph-profile-option"><i class="fa-solid fa-users"></i> Team</a>
            <a href="/Settings/Billing" class="ph-profile-option"><i class="fa-solid fa-credit-card"></i> Billing</a>
            <a href="/Support/PrivacySupport" class="ph-profile-option"><i class="fa-solid fa-shield-halved"></i> Privacy</a>
            <a href="/Auth/Logout" class="ph-profile-option danger"><i class="fa-solid fa-right-from-bracket"></i> Sign Out</a>
        </div>
    </div>
    <button class="ph-edge-toggle" id="phSidebarEdgeToggle" type="button" aria-label="Toggle sidebar">
        <i class="fa-solid fa-chevron-left"></i>
    </button>
</aside>

<script>
    const phBody = document.body;
    const phCollapseKey = 'bugence.sidebar.collapsed';
    const phSidebarMobileToggle = document.getElementById('phSidebarMobileToggle');
    const phSidebarBackdrop = document.getElementById('phSidebarBackdrop');
    const phSidebarCollapseBtn = document.getElementById('phSidebarCollapseBtn');
    const phSidebarCloseBtn = document.getElementById('phSidebarCloseBtn');
    const phSidebarEdgeToggle = document.getElementById('phSidebarEdgeToggle');
    const setPhOpen = (open) => {
        phBody.classList.toggle('ph-sidebar-open', open);
        phSidebarMobileToggle?.setAttribute('aria-expanded', open ? 'true' : 'false');
    };
    const setPhCollapsed = (collapsed) => {
        phBody.classList.toggle('ph-sidebar-collapsed', collapsed);
        localStorage.setItem(phCollapseKey, collapsed ? '1' : '0');
    };
    try {
        const raw = localStorage.getItem(phCollapseKey);
        const saved = raw == null ? true : raw === '1';
        if (window.innerWidth > 1024) setPhCollapsed(saved);
    } catch { }
    phSidebarCollapseBtn?.addEventListener('click', () => setPhCollapsed(!phBody.classList.contains('ph-sidebar-collapsed')));
    phSidebarEdgeToggle?.addEventListener('click', () => {
        if (window.innerWidth <= 1024) return;
        setPhCollapsed(!phBody.classList.contains('ph-sidebar-collapsed'));
    });
    phSidebarMobileToggle?.addEventListener('click', () => setPhOpen(!phBody.classList.contains('ph-sidebar-open')));
    phSidebarBackdrop?.addEventListener('click', () => setPhOpen(false));
    phSidebarCloseBtn?.addEventListener('click', () => setPhOpen(false));
    document.querySelectorAll('.ph-sidebar .ph-nav-item, .ph-sidebar .ph-back').forEach((item) => {
        item.addEventListener('click', () => { if (window.innerWidth <= 1024) setPhOpen(false); });
    });
    window.addEventListener('resize', () => {
        if (window.innerWidth > 1024) {
            setPhOpen(false);
            try {
                const raw = localStorage.getItem(phCollapseKey);
                const saved = raw == null ? true : raw === '1';
                setPhCollapsed(saved);
            } catch { }
        } else {
            setPhCollapsed(false);
        }
    });

    const phAvatarStorageKey = 'bugence.account.avatar';
    const applyProjectHubAvatar = () => {
        const stored = localStorage.getItem(phAvatarStorageKey);
        if (!stored) return;
        document.querySelectorAll('.ph-avatar-dot, .avatar-dot, .profile-avatar').forEach((el) => {
            if (!(el instanceof HTMLElement)) return;
            el.style.backgroundImage = `url("${stored}")`;
            el.style.backgroundSize = 'cover';
            el.style.backgroundPosition = 'center';
            el.textContent = '';
        });
    };
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyProjectHubAvatar);
    } else {
        applyProjectHubAvatar();
    }

    document.querySelector('[data-ph-profile]')?.addEventListener('click', (e) => {
        const menu = document.getElementById('phProfileMenu');
        menu?.classList.toggle('show');
        e.stopPropagation();
    });
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.ph-profile')) {
            document.getElementById('phProfileMenu')?.classList.remove('show');
        }
    });
</script>
