@page
@model BugenceEditConsole.Pages.Settings.ProfileModel
@{
    ViewData["Title"] = "Profile Settings";
    ViewData["BodyClass"] = "page-settings-profile-v3";
    var userName = string.IsNullOrWhiteSpace(Model.DisplayName) ? "Administrator" : Model.DisplayName;
    var displayEmail = string.IsNullOrWhiteSpace(Model.Email) ? "-" : Model.Email;
    var avatarUrl = Model.AvatarUrl;
    var companyLogoUrl = Model.CompanyLogoUrl;
    var githubUsername = User?.Claims?.FirstOrDefault(c => c.Type == "github:username")?.Value;
    var googleAvatar = User?.Claims?.FirstOrDefault(c => c.Type == "urn:google:avatar")?.Value;
    var roleKey = (Model.WorkspaceRole ?? "Viewer").ToLowerInvariant();
    var roleTone = roleKey == "admin" ? "role-admin" : roleKey == "editor" ? "role-editor" : "role-viewer";
    var qrPreviewUrl = string.IsNullOrWhiteSpace(Model.AuthenticatorUri) ? string.Empty : $"https://quickchart.io/qr?size=220&margin=1&text={Uri.EscapeDataString(Model.AuthenticatorUri)}";
}

@section Head {
<style>
    :root{--bg:#020202;--panel:#090909;--border:rgba(255,255,255,.08);--text:#f8fafc;--muted:#94a3b8;--cyan:#6ee7ff;--blue:#60a5fa;--green:#4ade80;--gold:#f4c55c;--red:#fb7185}
    .ps-shell{max-width:1600px;margin:0 auto;padding:12px 6px 40px;display:grid;gap:18px}.ps-hero,.ps-card{position:relative;overflow:hidden;border-radius:28px;border:1px solid rgba(255,255,255,.12);background:radial-gradient(580px 240px at -10% -10%,rgba(110,231,255,.14),transparent 54%),radial-gradient(460px 200px at 110% 0%,rgba(96,165,250,.12),transparent 52%),linear-gradient(135deg,rgba(11,11,11,.98),rgba(4,4,4,.98));box-shadow:0 32px 80px rgba(0,0,0,.55)}
    .ps-hero::after,.ps-card::after{content:"";position:absolute;inset:0;background-image:linear-gradient(rgba(255,255,255,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.02) 1px,transparent 1px);background-size:32px 32px;opacity:.15;pointer-events:none}.ps-hero{padding:28px}.ps-hero-inner,.ps-grid{position:relative;z-index:1;display:grid;gap:18px}.ps-hero-inner{grid-template-columns:minmax(0,1.2fr) 420px}.ps-grid{grid-template-columns:minmax(0,1.05fr) minmax(340px,.95fr)}.ps-stack{display:grid;gap:18px}
    .ps-kicker,.ps-badge,.ps-status,.ps-tab,.ps-pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;font-size:.76rem;font-weight:800;letter-spacing:.06em;text-transform:uppercase}.ps-kicker{width:fit-content;padding:8px 14px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.04);color:var(--cyan);letter-spacing:.18em}.ps-title{margin:14px 0 10px;font-family:"Cabinet Grotesk",sans-serif;font-size:clamp(2.25rem,4vw,4.2rem);line-height:.94;letter-spacing:-.045em;color:var(--text);max-width:760px}.ps-sub{margin:0;color:var(--muted);line-height:1.65}.ps-row,.ps-actions,.ps-tabs{display:flex;gap:12px;flex-wrap:wrap}.ps-badge{padding:10px 14px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.035);color:#d9e1ea}.role-admin{color:var(--cyan)!important;border-color:rgba(110,231,255,.22)!important}.role-editor{color:var(--green)!important;border-color:rgba(74,222,128,.22)!important}.role-viewer{color:var(--blue)!important;border-color:rgba(96,165,250,.22)!important}
    .ps-command,.ps-pane,.ps-metric,.ps-box{border-radius:22px;border:1px solid var(--border);background:rgba(255,255,255,.03)}.ps-command{padding:20px;display:grid;gap:16px}.ps-head,.ps-logo{display:grid;grid-template-columns:88px minmax(0,1fr);gap:16px;align-items:center}.ps-logo{grid-template-columns:96px minmax(0,1fr)}.ps-avatar,.ps-logo-stage{position:relative;overflow:hidden;border:1px solid rgba(255,255,255,.14);background:radial-gradient(circle at 30% 20%,rgba(110,231,255,.34),transparent 38%),linear-gradient(135deg,#0b0b0b,#171717);display:grid;place-items:center}.ps-avatar{width:88px;height:88px;border-radius:28px}.ps-logo-stage{width:96px;height:96px;border-radius:24px}.ps-avatar img,.ps-logo-stage img{width:100%;height:100%;object-fit:cover;display:block}.ps-fallback,.ps-logo-fallback{width:100%;height:100%;display:grid;place-items:center;background:linear-gradient(135deg,var(--cyan),#38bdf8);color:#06161d;font-weight:900}.ps-logo-fallback{font-size:2rem}.ps-name{margin:0;color:var(--text);font-size:1.26rem;font-weight:800}
    .ps-metrics,.ps-forms,.ps-company,.ps-connections,.ps-security,.ps-twofactor,.ps-recovery{display:grid;gap:12px}.ps-metrics{grid-template-columns:repeat(3,minmax(0,1fr))}.ps-metric,.ps-pane,.ps-box{padding:16px}.ps-metric .k{color:#7d8795;font-size:.72rem;font-weight:800;letter-spacing:.12em;text-transform:uppercase}.ps-metric .v{margin-top:8px;font-size:1.45rem;font-weight:900;color:var(--text)}.ps-card-head,.ps-card-body{position:relative;z-index:1;padding:22px}.ps-card-head{padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:end;gap:14px}.ps-card-body{display:grid;gap:16px}.ps-forms,.ps-company{grid-template-columns:repeat(2,minmax(0,1fr))}.ps-field{display:grid;gap:7px}.ps-span2{grid-column:span 2}.ps-field label{font-size:.76rem;text-transform:uppercase;letter-spacing:.12em;color:#788394;font-weight:800}.ps-field input{width:100%;min-height:50px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:var(--text);padding:12px 14px;font-size:.95rem}.ps-field input:focus{outline:none;border-color:rgba(110,231,255,.55);box-shadow:0 0 0 4px rgba(110,231,255,.08)}
    .ps-pill{padding:10px 12px;background:rgba(244,197,92,.08);border:1px dashed rgba(244,197,92,.28);color:#f7d77a}.ps-btn,.ps-btn-accent,.ps-btn-danger{border-radius:16px;padding:12px 16px;font-size:.88rem;font-weight:800;border:1px solid rgba(255,255,255,.12);cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:10px}.ps-btn{background:rgba(255,255,255,.04);color:var(--text)}.ps-btn-accent{border-color:rgba(110,231,255,.18);background:linear-gradient(135deg,var(--cyan),#48a5ff);color:#031116}.ps-btn-danger{background:rgba(251,113,133,.08);color:#fecdd3;border-color:rgba(251,113,133,.22)}
    .ps-tab{padding:10px 14px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);color:#d9e1ea;cursor:pointer}.ps-tab.active{color:#07161d;border-color:transparent;background:linear-gradient(135deg,var(--cyan),#60a5fa)}.ps-pane{display:none}.ps-pane.active{display:grid;gap:16px}.ps-security,.ps-twofactor{grid-template-columns:repeat(2,minmax(0,1fr))}.ps-twofactor{grid-template-columns:minmax(0,1fr) 220px;align-items:start}.ps-status{width:fit-content;padding:10px 12px;border:1px solid rgba(255,255,255,.08)}.connected{color:#86efac;border-color:rgba(74,222,128,.22);background:rgba(74,222,128,.08)}.pending{color:#fcd34d;border-color:rgba(244,197,92,.22);background:rgba(244,197,92,.08)}.locked{color:#93c5fd;border-color:rgba(96,165,250,.22);background:rgba(96,165,250,.08)}.ps-connections{grid-template-columns:repeat(2,minmax(0,1fr))}.ps-code,.ps-recovery code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}.ps-code{color:#e2f8ff;font-size:.98rem;letter-spacing:.12em;word-break:break-word}.ps-qr img{width:180px;height:180px;border-radius:18px;background:#fff;padding:10px}.ps-recovery{grid-template-columns:repeat(2,minmax(0,1fr))}.ps-recovery code{display:block;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);color:#fef3c7;font-size:.88rem;text-align:center}
    .ps-toast{position:fixed;right:24px;bottom:24px;z-index:2600;min-width:280px;max-width:420px;border-radius:18px;border:1px solid rgba(255,255,255,.1);background:rgba(8,8,8,.92);backdrop-filter:blur(12px);box-shadow:0 24px 60px rgba(0,0,0,.55);padding:14px 16px;display:none}.ps-toast.show{display:block}.ps-hidden{display:none}
    @@media (max-width:1260px){.ps-hero-inner,.ps-grid,.ps-twofactor{grid-template-columns:1fr}} @@media (max-width:760px){.ps-shell{padding:8px 0 24px}.ps-hero,.ps-card-head,.ps-card-body{padding-left:16px;padding-right:16px}.ps-metrics,.ps-forms,.ps-company,.ps-connections,.ps-security,.ps-recovery,.ps-head,.ps-logo{grid-template-columns:1fr}.ps-span2{grid-column:auto}}
</style>
}

<div class="ps-shell">
    <section class="ps-hero">
        <div class="ps-hero-inner">
            <div>
                <div class="ps-kicker"><i class="fa-solid fa-user-shield"></i> Account Command</div>
                <h1 class="ps-title">Identity, company controls, and security posture in one serious control surface.</h1>
                <p class="ps-sub">Update personal identity, manage the workspace company if you own it, and activate authenticator-based two-factor security without leaving profile settings.</p>
                <div class="ps-row">
                    <span class="ps-badge @roleTone"><i class="fa-solid fa-shield-halved"></i> @Model.WorkspaceRole</span>
                    <span class="ps-badge"><i class="fa-solid fa-envelope"></i> @displayEmail</span>
                    <span class="ps-badge"><i class="fa-solid fa-building"></i> @(string.IsNullOrWhiteSpace(Model.CompanyName) ? "Company pending" : Model.CompanyName)</span>
                </div>
            </div>
            <aside class="ps-command">
                <div class="ps-head">
                    <div class="ps-avatar" id="profileAvatarStage">@if (!string.IsNullOrWhiteSpace(avatarUrl)) { <img src="@avatarUrl" alt="@userName" /> } else { <div class="ps-fallback">@Model.Initials</div> }</div>
                    <div><h2 class="ps-name" id="profileDisplayName">@userName</h2><p class="ps-sub" id="profileDisplayEmail">@displayEmail</p></div>
                </div>
                <div class="ps-metrics">
                    <div class="ps-metric"><div class="k">Workspace Role</div><div class="v">@Model.WorkspaceRole</div></div>
                    <div class="ps-metric"><div class="k">Name Changes Left</div><div class="v" id="nameChangesRemaining">@Model.NameChangesRemaining</div></div>
                    <div class="ps-metric"><div class="k">2FA</div><div class="v" id="twoFactorMetric">@(Model.TwoFactorEnabled ? "Enabled" : "Off")</div></div>
                </div>
                <div class="ps-actions"><button class="ps-btn-accent" type="button" id="uploadAvatarBtn"><i class="fa-solid fa-camera"></i> Change Photo</button><a class="ps-btn" href="#securityCenter"><i class="fa-solid fa-lock"></i> Open Security</a></div>
                <input class="ps-hidden" type="file" id="avatarInput" accept=".png,.jpg,.jpeg,.webp,.gif" />
            </aside>
        </div>
    </section>

    <div class="ps-grid">
        <div class="ps-stack">
            <section class="ps-card">
                <div class="ps-card-head"><div><h3 class="ps-name" style="font-size:1.05rem;">Identity & Contact</h3><p class="ps-sub">Core profile fields used across Bugence menus, activity streams, ownership labels, and audit views.</p></div><div class="ps-pill"><i class="fa-solid fa-hourglass-half"></i> Name changes remaining: <strong id="nameChangeLabel">@Model.NameChangesRemaining</strong></div></div>
                <div class="ps-card-body">
                    <div class="ps-forms">
                        <div class="ps-field ps-span2"><label for="nameInput">Full Name</label><input id="nameInput" value="@userName" @(Model.CanChangeName ? null : "readonly") /></div>
                        <div class="ps-field"><label for="emailInput">Email</label><input id="emailInput" type="email" value="@displayEmail" /></div>
                        <div class="ps-field"><label for="phoneInput">Phone</label><input id="phoneInput" value="@Model.PhoneNumber" placeholder="+1 555 000 0000" /></div>
                        <div class="ps-field"><label for="countryInput">Country</label><input id="countryInput" value="@Model.Country" placeholder="United States" /></div>
                        <div class="ps-field"><label for="timezoneInput">Timezone</label><input id="timezoneInput" value="@Model.Timezone" placeholder="UTC-05:00" /></div>
                    </div>
                    <div class="ps-actions"><button class="ps-btn-accent" type="button" id="saveProfileBtn"><i class="fa-solid fa-floppy-disk"></i> Save Profile</button><a class="ps-btn" asp-page="/Settings/Teams"><i class="fa-solid fa-users"></i> Manage Team</a></div>
                </div>
            </section>

            <section class="ps-card" id="securityCenter">
                <div class="ps-card-head"><div><h3 class="ps-name" style="font-size:1.05rem;">Security Center</h3><p class="ps-sub">Password hygiene, authenticator enrollment, recovery access, and live account posture.</p></div><div class="ps-pill"><i class="fa-solid fa-shield"></i> Security posture @(Model.TwoFactorEnabled ? "hardened" : "needs attention")</div></div>
                <div class="ps-card-body">
                    <div class="ps-tabs"><button class="ps-tab active" type="button" data-security-tab="password">Password</button><button class="ps-tab" type="button" data-security-tab="twofactor">Two-Factor Authentication</button></div>
                    <div class="ps-pane active" data-security-pane="password">
                        <p class="ps-sub">Change the local account password used alongside your Bugence identity and linked providers.</p>
                        <div class="ps-security">
                            <div class="ps-field"><label for="currentPasswordInput">Current Password</label><input id="currentPasswordInput" type="password" /></div>
                            <div class="ps-field"></div>
                            <div class="ps-field"><label for="newPasswordInput">New Password</label><input id="newPasswordInput" type="password" /></div>
                            <div class="ps-field"><label for="confirmPasswordInput">Confirm Password</label><input id="confirmPasswordInput" type="password" /></div>
                        </div>
                        <div class="ps-actions"><button class="ps-btn-accent" type="button" id="changePasswordBtn"><i class="fa-solid fa-key"></i> Update Password</button><a class="ps-btn" asp-page="/Settings/ResetPassword"><i class="fa-solid fa-arrow-up-right-from-square"></i> Open Reset Page</a></div>
                    </div>
                    <div class="ps-pane" data-security-pane="twofactor">
                        <div class="ps-twofactor">
                            <div style="display:grid;gap:16px;">
                                <div class="ps-box"><strong style="color:var(--text);">Authenticator Status</strong><p class="ps-sub">Use Microsoft Authenticator, Google Authenticator, 1Password, or any TOTP-compatible app. Scan the QR code or enter the setup key manually.</p><span class="ps-status @(Model.TwoFactorEnabled ? "connected" : "pending")" id="twoFactorStatusChip"><i class="fa-solid @(Model.TwoFactorEnabled ? "fa-shield-check" : "fa-shield")"></i> <span id="twoFactorStatusText">@(Model.TwoFactorEnabled ? "Enabled" : "Not Enabled")</span></span></div>
                                <div class="ps-box"><strong style="color:var(--text);">Manual Setup Key</strong><div class="ps-code" id="twoFactorSharedKey">@Model.AuthenticatorKey</div><div class="ps-actions"><button class="ps-btn" type="button" id="copySharedKeyBtn"><i class="fa-regular fa-copy"></i> Copy Key</button><button class="ps-btn" type="button" id="refreshTwoFactorBtn"><i class="fa-solid fa-rotate"></i> Reset Key</button></div></div>
                                <div class="ps-field"><label for="twoFactorCodeInput">Authenticator Verification Code</label><input id="twoFactorCodeInput" inputmode="numeric" autocomplete="one-time-code" placeholder="Enter 6-digit code" /></div>
                                <div class="ps-actions"><button class="ps-btn-accent" type="button" id="enableTwoFactorBtn"><i class="fa-solid fa-shield-check"></i> Enable 2FA</button><button class="ps-btn-danger" type="button" id="disableTwoFactorBtn" @(Model.TwoFactorEnabled ? null : "disabled")><i class="fa-solid fa-shield-slash"></i> Disable 2FA</button><button class="ps-btn" type="button" id="generateRecoveryCodesBtn"><i class="fa-solid fa-notes-medical"></i> New Recovery Codes</button></div>
                                <div class="ps-box" id="recoveryCodesPanel" style="display:none;"><strong style="color:var(--text);">Recovery Codes</strong><div class="ps-recovery" id="recoveryCodesGrid"></div></div>
                            </div>
                            <aside class="ps-box ps-qr">@if (!string.IsNullOrWhiteSpace(qrPreviewUrl)) { <img src="@qrPreviewUrl" alt="Authenticator QR code" id="twoFactorQrImage" /> }<div class="ps-sub" style="text-align:center;">Recovery codes left: <strong id="recoveryCodesLeft">@Model.RecoveryCodesLeft</strong></div></aside>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div class="ps-stack">
            <section class="ps-card">
                <div class="ps-card-head"><div><h3 class="ps-name" style="font-size:1.05rem;">Workspace Company</h3><p class="ps-sub">Admins, the account creator, and the first workspace user can maintain company identity and branding from here.</p></div><span class="ps-status @(Model.CanManageCompany ? "connected" : "locked")"><i class="fa-solid @(Model.CanManageCompany ? "fa-pen-ruler" : "fa-lock")"></i> @(Model.CanManageCompany ? "Editable" : "View Only")</span></div>
                <div class="ps-card-body">
                    <div class="ps-logo"><div class="ps-logo-stage" id="companyLogoStage">@if (!string.IsNullOrWhiteSpace(companyLogoUrl)) { <img src="@companyLogoUrl" alt="Company logo" /> } else { <div class="ps-logo-fallback"><i class="fa-solid fa-building"></i></div> }</div><div><h3 class="ps-name" id="companyNameHeadline">@(string.IsNullOrWhiteSpace(Model.CompanyName) ? "Set your company profile" : Model.CompanyName)</h3><p class="ps-sub">Company branding is available to profile dropdowns and workspace-facing settings surfaces.</p><div class="ps-actions"><button class="ps-btn" type="button" id="uploadCompanyLogoBtn" @(Model.CanManageCompany ? null : "disabled")><i class="fa-solid fa-image"></i> Change Logo</button></div></div></div>
                    <input class="ps-hidden" type="file" id="companyLogoInput" accept=".png,.jpg,.jpeg,.webp,.svg" />
                    <div class="ps-company">
                        <div class="ps-field ps-span2"><label for="companyNameInput">Company Name</label><input id="companyNameInput" value="@Model.CompanyName" @(Model.CanManageCompany ? null : "readonly") /></div>
                        <div class="ps-field ps-span2"><label for="companyAddress1Input">Address Line 1</label><input id="companyAddress1Input" value="@Model.CompanyAddressLine1" @(Model.CanManageCompany ? null : "readonly") /></div>
                        <div class="ps-field ps-span2"><label for="companyAddress2Input">Address Line 2</label><input id="companyAddress2Input" value="@Model.CompanyAddressLine2" @(Model.CanManageCompany ? null : "readonly") /></div>
                        <div class="ps-field"><label for="companyCityInput">City</label><input id="companyCityInput" value="@Model.CompanyCity" @(Model.CanManageCompany ? null : "readonly") /></div>
                        <div class="ps-field"><label for="companyStateInput">State / Province</label><input id="companyStateInput" value="@Model.CompanyStateOrProvince" @(Model.CanManageCompany ? null : "readonly") /></div>
                        <div class="ps-field"><label for="companyPostalInput">Postal Code</label><input id="companyPostalInput" value="@Model.CompanyPostalCode" @(Model.CanManageCompany ? null : "readonly") /></div>
                        <div class="ps-field"><label for="companyCountryInput">Country</label><input id="companyCountryInput" value="@Model.CompanyCountry" @(Model.CanManageCompany ? null : "readonly") /></div>
                        <div class="ps-field"><label for="companyPhoneInput">Company Phone</label><input id="companyPhoneInput" value="@Model.CompanyPhoneNumber" @(Model.CanManageCompany ? null : "readonly") /></div>
                        <div class="ps-field"><label for="companySeatsInput">Expected Seats</label><input id="companySeatsInput" type="number" min="1" value="@(Model.CompanyExpectedUserCount?.ToString() ?? string.Empty)" @(Model.CanManageCompany ? null : "readonly") /></div>
                    </div>
                    <div class="ps-actions"><button class="ps-btn-accent" type="button" id="saveCompanyBtn" @(Model.CanManageCompany ? null : "disabled")><i class="fa-solid fa-building-circle-check"></i> Save Company</button></div>
                </div>
            </section>

            <section class="ps-card">
                <div class="ps-card-head"><div><h3 class="ps-name" style="font-size:1.05rem;">Connection Status</h3><p class="ps-sub">Current identity connections and authority posture for this workspace account.</p></div></div>
                <div class="ps-card-body"><div class="ps-connections">
                    <div class="ps-box"><strong>GitHub</strong><div class="ps-sub">Source control identity and developer linking.</div><span class="ps-status @(string.IsNullOrWhiteSpace(githubUsername) ? "pending" : "connected")">@(string.IsNullOrWhiteSpace(githubUsername) ? "Pending" : githubUsername)</span></div>
                    <div class="ps-box"><strong>Google</strong><div class="ps-sub">Federated access and profile data connection.</div><span class="ps-status @(string.IsNullOrWhiteSpace(googleAvatar) ? "pending" : "connected")">@(string.IsNullOrWhiteSpace(googleAvatar) ? "Pending" : "Connected")</span></div>
                    <div class="ps-box"><strong>Workspace Authority</strong><div class="ps-sub">Your current privilege level inside Bugence.</div><span class="ps-status locked">@Model.WorkspaceRole</span></div>
                    <div class="ps-box"><strong>Recovery Coverage</strong><div class="ps-sub">Recovery codes available for emergency sign-in.</div><span class="ps-status @(Model.RecoveryCodesLeft > 0 ? "connected" : "pending")"><span id="recoveryCodesCountLabel">@Model.RecoveryCodesLeft</span> left</span></div>
                </div></div>
            </section>
        </div>
    </div>
</div>

<div class="ps-toast" id="profileToast"><div class="ps-name" style="font-size:.96rem;" id="profileToastTitle">Saved</div><p class="ps-sub" id="profileToastBody">Profile updated.</p></div>
<form id="profileAntiForgery" method="post" style="display:none;">@Html.AntiForgeryToken()</form>

@section Scripts {
<script src="/js/settings-profile-page.js"></script>
}
