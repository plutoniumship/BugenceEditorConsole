@page
@model BugenceEditConsole.Pages.ProjectHub.CustomCodeModel
@{
    Layout = null;
    Response.Headers["Cache-Control"] = "no-store";
    var pid = Model.ProjectId;
    var projectName = Model.ProjectName;
    var serverFilesJson = "[]";
    IReadOnlyList<string> indexSource;
    if (Model.FileIndexPaths != null && Model.FileIndexPaths.Count > 0)
    {
        indexSource = Model.FileIndexPaths;
    }
    else
    {
        var list = new System.Collections.Generic.List<string>();
        foreach (var file in Model.CodeFiles)
        {
            list.Add(file.Path);
        }
        indexSource = list;
    }
    var serverFileIndexJson = System.Text.Json.JsonSerializer.Serialize(indexSource);
    var serverExtensionsJson = System.Text.Json.JsonSerializer.Serialize(Model.Extensions);
    var serverFilesPayload = System.Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(serverFilesJson));
    var serverFileIndexPayload = System.Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(serverFileIndexJson));
    var serverExtensionsPayload = System.Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(serverExtensionsJson));
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Code | Bugence</title>
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@900,700,500,400,300&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
    <style>
        :root {
            --bg-activity: #111114;
            --bg-sidebar: #09090b;
            --bg-editor: #1e1e1e;
            --bg-panel: #09090b;
            --bg-status: #06b6d4;
            --bg-modal: #1c1c1e;
            --bg-input: #27272a;
            --border: #27272a;
            --hover: #2a2d2e;
            --selection: #37373d;
            --text-main: #e4e4e7;
            --text-muted: #71717a;
            --accent: #06b6d4;
            --accent-glow: rgba(6, 182, 212, 0.2);
            --git-add: #10b981;
            --git-mod: #eab308;
            --git-del: #ef4444;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --tab-height: 35px;
            --status-height: 24px;
            --activity-width: 50px;
            --sidebar-width: 280px;
            --sidebar-resizer: 6px;
            --panel-collapsed-height: 44px;
        }

        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 0;
            background: #050505; color: var(--text-main);
            font-family: 'Satoshi', sans-serif;
            height: 100vh; width: 100vw; overflow: hidden;
        }

        .app-container { display: grid; grid-template-columns: 300px 1fr; height: 100vh; width: 100vw; }
        .main-content { display: flex; flex-direction: column; min-height: 0; background: #050505; }
        .ide-wrap { flex: 1; min-height: 0; padding: 0 20px 20px; }

        .ide-layout {
            display: grid;
            grid-template-columns: var(--activity-width) var(--sidebar-width) var(--sidebar-resizer) 1fr;
            grid-template-rows: 1fr var(--status-height);
            height: 100%; width: 100%;
            border: 1px solid #121215; border-radius: 18px; overflow: hidden;
            background: var(--bg-editor);
        }

        .activity-bar {
            grid-column: 1; grid-row: 1;
            background: var(--bg-activity); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center; padding-top: 15px; z-index: 200;
        }
        .act-item {
            width: 48px; height: 48px; display: grid; place-items: center;
            color: var(--text-muted); font-size: 1.2rem; cursor: pointer; position: relative;
            transition: all 0.2s;
        }
        .act-item:hover { color: white; background: rgba(255,255,255,0.03); }
        .act-item.active { color: white; border-left: 2px solid var(--accent); background: rgba(255,255,255,0.05); }
        .act-bottom { margin-top: auto; padding-bottom: 10px; display: flex; flex-direction: column; gap: 4px; }
        .act-label {
            position: absolute;
            left: 56px;
            top: 50%;
            transform: translateY(-50%);
            background: #0b0b0e;
            border: 1px solid rgba(255,255,255,0.08);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.72rem;
            color: #e5e7eb;
            opacity: 0;
            pointer-events: none;
            transition: 0.2s;
            white-space: nowrap;
        }
        .act-item:hover .act-label { opacity: 1; }

        .sidebar {
            grid-column: 2; grid-row: 1;
            background: var(--bg-sidebar); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        .sidebar-resizer {
            grid-column: 3; grid-row: 1;
            width: var(--sidebar-resizer); height: 100%;
            cursor: col-resize; background: #0b0b0e; border-right: 1px solid var(--border);
        }
        .sidebar-collapsed-bar {
            display: none;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            color: var(--text-muted);
            font-size: 1rem;
            cursor: pointer;
        }
        .ide-layout.sidebar-collapsed .sidebar-collapsed-bar { display: flex; }
        .ide-layout.sidebar-collapsed .sidebar-view { display: none; }
        .sidebar-view { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .sidebar-view.active { display: flex; }
        .sidebar-header {
            height: 40px; padding: 0 15px; display: flex; align-items: center; justify-content: space-between;
            font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1.5px;
        }

        .file-tree { flex: 1; overflow-y: auto; padding-top: 5px; }
        .tree-empty {
            padding: 18px 16px;
            color: var(--text-muted);
            font-size: 0.85rem;
            line-height: 1.5;
        }
        .tree-empty strong { color: #e2e8f0; }
        .tree-item {
            display: flex; align-items: center; padding: 5px 15px; gap: 8px; cursor: pointer;
            font-size: 0.88rem; color: #a1a1aa; border-left: 2px solid transparent; transition: 0.1s;
        }
        .tree-item:hover { background: var(--hover); color: #fff; }
        .tree-item.active { background: var(--selection); color: white; border-left-color: var(--accent); }
        .tree-badges { margin-left: auto; display: flex; gap: 6px; align-items: center; }
        .tree-badge {
            font-size: 0.68rem;
            color: #cbd5f5;
            border: 1px solid rgba(255,255,255,0.08);
            padding: 2px 6px;
            border-radius: 6px;
        }
        .tree-badge.warn { color: #f59e0b; border-color: rgba(245,158,11,0.35); }
        .tree-badge.lock { color: #fca5a5; border-color: rgba(248,113,113,0.35); }
        .tree-indent { display: inline-block; width: 14px; }
        .arrow { font-size: 0.6rem; color: var(--text-muted); transition: 0.2s; margin-right: 4px; }
        .folder-open > .tree-item .arrow { transform: rotate(90deg); color: white; }
        .sub-tree { display: none; border-left: 1px solid #1a1a1a; margin-left: 20px; }
        .folder-open > .sub-tree { display: block; }
        .tree-root > .tree-item { font-weight: 700; color: #e2e8f0; }
        .tree-root .arrow { visibility: hidden; }

        .sidebar-body { padding: 15px; }
        .filter-chips { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        .chip {
            background: #101013;
            color: #a1a1aa;
            border: 1px solid rgba(255,255,255,0.08);
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.72rem;
            cursor: pointer;
        }
        .chip.active { color: #0b0b0e; background: #d46f06; border-color: transparent; font-weight: 800; }
        .ide-input {
            width: 100%; background: var(--bg-input); border: 1px solid #333;
            color: white; padding: 10px; font-size: 0.85rem; margin-bottom: 12px; outline: none;
            border-radius: 4px;
        }
        .ide-input:focus { border-color: var(--accent); background: #111; }
        .btn-primary {
            width: 100%;
            background: var(--accent);
            border: none;
            padding: 10px;
            color: #121212;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.85rem;
            transition: 0.3s;
        }
        .btn-primary:hover { filter: brightness(1.2); box-shadow: 0 0 15px var(--accent-glow); }

        .editor-area {
            grid-column: 4; grid-row: 1;
            background: var(--bg-editor); display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        .tabs-container { height: var(--tab-height); background: var(--bg-sidebar); display: flex; border-bottom: 1px solid var(--border); align-items: center; }
        .tabs-list { display: flex; flex: 1; overflow-x: auto; }
        .tabs-actions { margin-left: auto; display: flex; align-items: center; gap: 8px; padding: 0 10px; }
        .tabs-action-btn {
            height: 28px; padding: 0 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.08);
            background: #0f1115; color: #e5e7eb; font-size: 0.7rem; font-weight: 800;
            display: inline-flex; align-items: center; gap: 6px; cursor: pointer;
        }
        .tabs-action-btn:hover { border-color: rgba(6,182,212,0.6); color: white; }
        .tabs-container.tabs-compact .tab { min-width: 110px; max-width: 180px; font-size: 0.78rem; padding: 0 8px 0 12px; }
        .tabs-container.tabs-large .tab { min-width: 180px; max-width: 260px; font-size: 0.95rem; padding: 0 12px 0 18px; }
        .tab {
            min-width: 140px; max-width: 220px; padding: 0 10px 0 15px; display: flex; align-items: center; gap: 10px;
            background: #141414; color: var(--text-muted); font-size: 0.85rem; cursor: pointer;
            border-right: 1px solid var(--border); border-top: 2px solid transparent; position: relative;
        }
        .tab.active { background: var(--bg-editor); color: white; border-top-color: var(--accent); }
        .tab.pinned { background: rgba(6,182,212,0.08); }
        .tab-close { margin-left: auto; font-size: 0.75rem; opacity: 0; width: 20px; height: 20px; display: grid; place-items: center; border-radius: 4px; }
        .tab:hover .tab-close { opacity: 1; }
        .tab-close:hover { background: #333; color: white; }
        .dirty-dot { width: 8px; height: 8px; background: white; border-radius: 50%; display: none; position: absolute; right: 12px; }
        .tab.dirty .dirty-dot { display: block; }
        .tab.dirty:hover .dirty-dot { display: none; }

        .editor-split { flex: 1; display: flex; min-height: 0; }
        .editor-pane { flex: 1 1 50%; display: flex; flex-direction: column; min-width: 0; }
        .editor-resizer {
            width: 6px;
            cursor: col-resize;
            background: #0b0b0e;
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
            display: none;
        }
        .editor-split.preview-active .editor-resizer { display: block; }
        .ide-layout.resizing, .editor-split.resizing { user-select: none; }
        .monaco-host { flex: 1; position: relative; overflow: hidden; min-height: 0; }
        #monaco-root { position: absolute; inset: 0; }
        #fallback-editor {
            position: absolute; inset: 0; width: 100%; height: 100%;
            background: #111; border: none; color: #e5e7eb; font-family: 'JetBrains Mono', monospace;
            font-size: 14px; padding: 16px; resize: none; display: none;
        }
        .preview-pane {
            flex: 1 1 50%;
            border-left: 1px solid var(--border); background: #0b0d11;
            display: none; flex-direction: column; min-width: 0;
        }
        .preview-pane.active { display: flex; }
        .preview-toolbar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 12px; border-bottom: 1px solid var(--border); background: #0e1117;
        }
        .preview-title { font-size: 0.8rem; font-weight: 800; color: #e5e7eb; display: flex; gap: 8px; align-items: center; }
        .preview-actions { display: flex; gap: 8px; align-items: center; }
        .preview-select { background: #0f1115; border: 1px solid rgba(255,255,255,0.08); color: #e5e7eb; border-radius: 8px; padding: 6px 8px; font-size: 0.72rem; }
        .preview-zoom { display: inline-flex; align-items: center; gap: 6px; font-size: 0.7rem; color: #9ca3af; }
        .preview-zoom input { accent-color: #d46f06; }
        .preview-toggle { display: inline-flex; align-items: center; gap: 6px; font-size: 0.7rem; color: #9ca3af; }
        .preview-actions button {
            height: 28px; padding: 0 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.08);
            background: #111827; color: #e5e7eb; font-size: 0.7rem; font-weight: 800; cursor: pointer;
        }
        .preview-actions button:hover { border-color: rgba(6,182,212,0.6); color: white; }
        .preview-stage {
            flex: 1;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 12px;
            overflow: auto;
        }
        .preview-shell {
            background: #0b0d11;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform-origin: top center;
            padding: 6px;
        }
        .preview-frame {
            width: 100%;
            height: 100%;
            border: 0;
            background: white;
            border-radius: 12px;
        }
        .command-modal, .quickopen-modal, .diff-modal, .search-modal {
            position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.7); z-index: 10050; backdrop-filter: blur(6px);
        }
        .command-modal.show, .quickopen-modal.show, .diff-modal.show, .search-modal.show { display: flex; }
        .command-card, .quickopen-card, .diff-card, .search-card {
            width: min(720px, 92vw); background: #0c0c0c; border: 1px solid rgba(255,255,255,0.08);
            border-radius: 18px; padding: 18px; box-shadow: 0 30px 90px rgba(0,0,0,0.7);
        }
        .command-input {
            width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08);
            background: #121212; color: #e5e7eb; font-weight: 700;
        }
        .search-card { width: min(880px, 94vw); height: min(70vh, 680px); display: flex; flex-direction: column; gap: 12px; }
        .search-row { display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; }
        .search-results { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .search-item { padding: 10px 12px; border-radius: 12px; background: #111; border: 1px solid rgba(255,255,255,0.06); }
        .search-item strong { color: #e5e7eb; font-size: 0.85rem; }
        .search-snippet { font-family: 'JetBrains Mono', monospace; font-size: 0.78rem; color: #94a3b8; margin-top: 6px; white-space: pre-wrap; }
        .search-actions { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .command-list { margin-top: 12px; max-height: 280px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; }
        .command-item {
            padding: 10px 12px; border-radius: 12px; background: #111; border: 1px solid transparent;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer; color: #e5e7eb; font-weight: 700;
        }
        .command-item:hover, .command-item.active { border-color: rgba(6,182,212,0.6); background: rgba(6,182,212,0.08); }
        .command-item small { color: #9ca3af; font-weight: 500; }
        .search-hit {
            display: flex; flex-direction: column; gap: 4px; padding: 10px 12px; border-radius: 12px;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
            cursor: pointer; margin-bottom: 6px;
        }
        .search-hit strong { font-size: 0.85rem; color: #e5e7eb; }
        .search-hit span { font-size: 0.75rem; color: #9ca3af; }
        .search-hit:hover { border-color: rgba(6,182,212,0.5); background: rgba(6,182,212,0.08); }
        .diff-card { width: min(1000px, 95vw); height: min(70vh, 680px); display: flex; flex-direction: column; padding: 0; }
        .diff-header { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; justify-content: space-between; align-items: center; }
        .diff-body { flex: 1; min-height: 0; }

        .bottom-panel {
            height: 220px; background: var(--bg-panel); border-top: 1px solid var(--border);
            display: flex; flex-direction: column; transition: height 0.15s ease;
        }
        .bottom-panel.collapsed {
            height: var(--panel-collapsed-height);
        }
        .panel-drag { height: 6px; cursor: row-resize; background: #0b0b0e; border-bottom: 1px solid var(--border); }
        .panel-nav {
            height: 35px; display: flex; align-items: center; padding: 0 15px; gap: 25px; border-bottom: 1px solid var(--border);
        }
        .p-tab {
            font-size: 0.72rem; text-transform: uppercase; font-weight: 700; color: var(--text-muted);
            cursor: pointer; height: 100%; display: flex; align-items: center; border-bottom: 2px solid transparent;
            letter-spacing: 0.5px;
        }
        .p-tab.active { color: white; border-bottom-color: var(--accent); }
        .p-actions { margin-left: auto; display: flex; gap: 15px; cursor: pointer; color: var(--text-muted); }
        .p-actions i:hover { color: white; }
        .panel-toggle-collapsed { transform: rotate(180deg); }

        .panel-content { flex: 1; display: none; padding: 12px; font-family: 'JetBrains Mono', monospace; font-size: 0.88rem; color: #ccc; overflow-y: auto; }
        .panel-content.active { display: block; }
        .bottom-panel.collapsed .panel-content { display: none; }
        .prompt { color: var(--accent); font-weight: 900; margin-right: 12px; }
        .cmd-in { background: transparent; border: none; color: white; font: inherit; outline: none; width: 75%; }
        .terminal-input-row { display: flex; align-items: center; gap: 8px; margin-top: 10px; }

        .status-bar {
            grid-column: 1 / span 4; grid-row: 2;
            background: #d46f06; color: black;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; font-size: 0.76rem; font-weight: 900; z-index: 50;
        }
        .sb-grp { display: flex; gap: 18px; align-items: center; }
        .tab-menu {
            position: fixed; background: #0f0f12; border: 1px solid rgba(255,255,255,0.12);
            border-radius: 10px; padding: 6px; display: none; flex-direction: column; gap: 4px;
            z-index: 10000; min-width: 160px; box-shadow: 0 14px 40px rgba(0,0,0,0.6);
        }
        .tab-menu.show { display: flex; }
        .tab-menu button {
            background: transparent; border: none; color: #e5e7eb; text-align: left; padding: 8px 10px;
            border-radius: 8px; cursor: pointer; font-size: 0.78rem;
        }
        .tab-menu button:hover { background: rgba(255,255,255,0.08); }
        .git-actions { display: flex; gap: 8px; margin-bottom: 12px; }

        .modal-portal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 10000;
            display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal-portal.show { display: flex; }
        .modal-card {
            width: 720px; background: linear-gradient(180deg, #151517 0%, #101012 100%);
            border: 1px solid #2a2a2f; border-radius: 16px;
            box-shadow: 0 30px 100px rgba(0,0,0,0.9); overflow: hidden; animation: zoomIn 0.3s;
        }
        .modal-header {
            padding: 18px 26px; border-bottom: 1px solid #2a2a2f; display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(90deg, rgba(6,182,212,0.12), rgba(255,255,255,0.02));
        }
        .modal-body { padding: 20px 26px 24px; color: #d4d4d8; max-height: 80vh; overflow-y: auto; line-height: 1.6; }
        .settings-tabs {
            display:flex; gap:8px; background:#0f0f0f; border:1px solid #2a2a2f; padding:6px;
            border-radius:14px; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
        }
        .settings-tab {
            padding:6px 12px; border-radius:9px; border:1px solid transparent; background:transparent;
            color:#9ca3af; font-weight:700; font-size:0.8rem; cursor:pointer; transition:0.2s;
        }
        .settings-tab.active { background:#1c1c22; color:white; border-color:#2f2f36; box-shadow: inset 0 0 0 1px rgba(6,182,212,0.15); }
        .settings-panel { display:none; flex-direction:column; gap:16px; margin-top:18px; }
        .settings-panel.active { display:flex; }
        .settings-row { display:flex; justify-content:space-between; align-items:center; gap:12px; }
        .settings-row .label { color:white; font-weight:700; }
        .settings-row .hint { font-size:0.8rem; color:var(--text-muted); }
        .settings-grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:14px; }
        .settings-card {
            background: linear-gradient(180deg, rgba(15,15,17,0.95), rgba(10,10,12,0.95));
            border: 1px solid #24242a; border-radius: 12px; padding: 12px;
            display:flex; flex-direction:column; gap:8px; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.35);
        }
        .settings-card::after {
            content: ""; position: absolute; inset: 0; border-radius: 12px; pointer-events: none;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
        }
        .settings-card select, .settings-card input[type="number"], .settings-card input[type="text"] { width:100%; }
        .settings-card label { font-size: 0.78rem; color: #cbd5f5; }
        .settings-card input[type="checkbox"] { accent-color: var(--accent); }
        .ide-layout.theme-dim { filter: brightness(0.92); }
        .ide-layout.theme-contrast { filter: contrast(1.08); }

        .doc-step { display: flex; gap: 20px; margin-bottom: 20px; }
        .doc-num { width: 34px; height: 34px; background: var(--accent); color: black; font-weight: 900; border-radius: 50%; display: grid; place-items: center; flex-shrink: 0; font-size: 0.95rem; }
        .doc-content h4 { color: white; margin: 0 0 6px; font-size: 1rem; }
        .doc-content pre { background: #000; padding: 14px; border-radius: 8px; border: 1px solid #333; margin-top: 10px; overflow-x: auto; font-family: 'JetBrains Mono', monospace; }

        .progress-track { width: 100%; height: 10px; background: #111; border-radius: 10px; margin: 18px 0; overflow: hidden; border: 1px solid #333; }
        .progress-fill { width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); transition: width 0.1s linear; }

        .toast {
            position: fixed; bottom: 45px; right: 25px; background: #252526; color: white;
            padding: 15px 25px; border-left: 5px solid var(--accent); box-shadow: 0 15px 40px rgba(0,0,0,0.6);
            transform: translateY(180px); transition: 0.45s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            z-index: 100000; border-radius: 4px; display:flex; align-items:center; gap:12px;
        }
        .toast.show { transform: translateY(0); opacity: 1; }

        @@keyframes zoomIn { from{opacity:0; transform:scale(0.96) translateY(10px);} to{opacity:1; transform:scale(1) translateY(0);} }

        .ext-card { border: 1px solid #1f1f22; border-radius: 10px; padding: 12px; background: #0b0b0e; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .ext-meta { display: flex; flex-direction: column; gap: 4px; }
        .ext-title { font-weight: 800; color: white; }
        .ext-desc { font-size: 0.8rem; color: var(--text-muted); }
        .ext-btn { background: #111; border: 1px solid #333; color: #fff; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-weight: 700; }
        .ext-btn.install { border-color: rgba(6,182,212,0.4); color: #a5f3fc; }
        .ext-btn.installed { border-color: rgba(16,185,129,0.4); color: #86efac; cursor: default; }
        .ext-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 999px; background: rgba(255,255,255,0.08); color: #d1d5db; }
        .ext-guide {
            border: 1px solid rgba(6,182,212,0.35);
            background: rgba(6,182,212,0.08);
            border-radius: 12px;
            padding: 14px;
            color: #cfeffd;
            display: none;
            margin-bottom: 16px;
            position: relative;
        }
        .ext-guide.show { display: block; }
        .ext-guide h5 { margin: 0 0 8px; font-size: 0.9rem; color: #e0f2fe; }
        .ext-guide ol { margin: 0 0 8px 18px; padding: 0; font-size: 0.82rem; color: #a5f3fc; }
        .ext-guide-close { position: absolute; top: 10px; right: 10px; cursor: pointer; color: #7dd3fc; }
        .ext-upload {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 12px;
            border: 1px dashed #2c2c2f;
            border-radius: 12px;
            background: rgba(255,255,255,0.02);
            margin-bottom: 14px;
        }
        .ext-upload input[type="file"] { color: #cbd5f5; font-size: 0.8rem; }
        .ext-row { display: flex; gap: 10px; }
        .ext-row .ide-input { flex: 1; margin: 0; }
        .ext-select { background: #0f0f12; border: 1px solid #333; color: #e5e7eb; padding: 8px 10px; border-radius: 8px; }
        .ext-theme-night { --accent: #22d3ee; --bg-panel: #0b1120; --bg-editor: #05070c; --bg-toolbar: #0f172a; }
        .ext-theme-night .editor-area, .ext-theme-night .sidebar, .ext-theme-night .activity-bar { background: #0a0b10; }
        .ext-theme-night .sidebar, .ext-theme-night .activity-bar { border-color: #1e293b; }

        @@media (max-width: 980px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            .ide-wrap {
                padding: 0 10px 12px;
            }
            .ide-layout {
                grid-template-columns: var(--activity-width) 1fr;
                border-radius: 14px;
                position: relative;
            }
            .sidebar {
                position: fixed;
                top: calc(78px + env(safe-area-inset-top));
                bottom: 8px;
                left: 58px;
                width: min(86vw, 320px);
                border-radius: 14px;
                border: 1px solid rgba(255,255,255,0.12);
                transform: translateX(-112%);
                transition: transform 0.22s ease;
                z-index: 260;
                box-shadow: 0 24px 55px rgba(0,0,0,0.55);
            }
            .ide-layout.ide-mobile-sidebar-open .sidebar {
                transform: translateX(0);
            }
            .sidebar-resizer {
                display: none !important;
            }
            .ide-layout.sidebar-collapsed .sidebar-collapsed-bar {
                display: none;
            }
            .preview-pane {
                position: fixed;
                left: 58px;
                right: 8px;
                bottom: 8px;
                top: calc(78px + env(safe-area-inset-top));
                z-index: 250;
                border-radius: 14px;
                border: 1px solid rgba(255,255,255,0.12);
                box-shadow: 0 24px 55px rgba(0,0,0,0.55);
            }
            .tabs-actions {
                gap: 6px;
            }
            .tabs-action-btn {
                padding: 0 8px;
            }
        }

        .tooltip { position: relative; }
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            bottom: calc(100% + 10px);
            transform: translateX(-50%) translateY(6px);
            background: #0b0b0e;
            border: 1px solid #1f1f22;
            color: #e5e7eb;
            font-size: 0.72rem;
            padding: 6px 8px;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: 0.2s ease;
            z-index: 10001;
        }
        .tooltip:hover::after { opacity: 1; transform: translateX(-50%) translateY(0); }
        .ph-mobile-toggle { z-index: 420 !important; }
        .ph-mobile-backdrop { z-index: 410 !important; }
        .ph-sidebar { z-index: 430 !important; }
    </style>
</head>
<body>
    <form id="antiforgeryForm" style="display:none;">
        @Html.AntiForgeryToken()
    </form>
    <div class="modal-portal" id="extModal">
        <div class="modal-card">
            <div class="modal-header">
                <strong style="font-weight:900; letter-spacing:1px;"><i class="fa-solid fa-puzzle-piece"></i> INSTALL EXTENSION</strong>
                <i class="fa-solid fa-xmark" style="cursor:pointer;" id="closeExtModal"></i>
            </div>
            <div class="modal-body">
                <div class="ext-upload">
                    <div class="ext-row">
                        <input class="ide-input" id="extName" placeholder="Extension name (e.g. Team Linter)" />
                        <select class="ext-select" id="extType">
                            <option value="utility">Utility</option>
                            <option value="lint">Lint</option>
                            <option value="formatter">Formatter</option>
                            <option value="theme">Theme</option>
                        </select>
                    </div>
                    <input type="file" id="extFile" accept=".zip,.bugenceext,.bugext,.gz,.tar" />
                    <div style="font-size:0.75rem; color:#94a3b8;">Supported: .zip, .bugenceext (max 20MB)</div>
                </div>
                <div class="doc-step">
                    <div class="doc-num">1</div>
                    <div class="doc-content">
                        <h4>Download Package</h4>
                        <div>We fetch the extension and verify its checksum.</div>
                    </div>
                </div>
                <div class="doc-step">
                    <div class="doc-num">2</div>
                    <div class="doc-content">
                        <h4>Install & Activate</h4>
                        <div>Extension is installed into the workspace and activated.</div>
                    </div>
                </div>
                <div class="doc-step">
                    <div class="doc-num">3</div>
                    <div class="doc-content">
                        <h4>Reload Editor</h4>
                        <div>We refresh the workspace to enable features.</div>
                    </div>
                </div>
                <div class="progress-track"><div class="progress-fill" id="extProgress"></div></div>
                <div id="extStatus" style="color:#a1a1aa; font-size:0.85rem;">Ready to install.</div>
                <div style="display:flex; gap:10px; margin-top:16px; justify-content:flex-end;">
                    <button class="ext-btn" id="extCancel">Cancel</button>
                    <button class="ext-btn install" id="extStart">Upload & Install</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-portal" id="settingsModal">
        <div class="modal-card" style="width:640px;">
            <div class="modal-header">
                <strong style="font-weight:900; letter-spacing:1px;"><i class="fa-solid fa-gear"></i> EDITOR SETTINGS</strong>
                <i class="fa-solid fa-xmark" style="cursor:pointer;" id="closeSettings"></i>
            </div>
            <div class="modal-body">
                <div class="settings-tabs" role="tablist">
                    <button class="settings-tab active" data-settings-tab="editor">Editor</button>
                    <button class="settings-tab" data-settings-tab="display">Display</button>
                    <button class="settings-tab" data-settings-tab="behavior">Behavior</button>
                    <button class="settings-tab" data-settings-tab="workspace">Workspace</button>
                    <button class="settings-tab" data-settings-tab="assist">Assist</button>
                </div>

                <div class="settings-panel active" data-settings-panel="editor">
                    <div class="settings-grid">
                        <div class="settings-card">
                            <div class="label">Editor Font Size</div>
                            <div class="hint">Adjust code readability</div>
                            <input type="number" class="ide-input" style="margin:0;" id="editorFontSize" min="12" max="24" value="14">
                        </div>
                        <div class="settings-card">
                            <div class="label">Font Family</div>
                            <div class="hint">Choose your code font</div>
                            <select class="ide-input" id="editorFontFamily" style="margin:0;">
                                <option value="JetBrains Mono">JetBrains Mono</option>
                                <option value="Fira Code">Fira Code</option>
                                <option value="Source Code Pro">Source Code Pro</option>
                                <option value="Monaspace Neon">Monaspace Neon</option>
                                <option value="Consolas">Consolas</option>
                            </select>
                        </div>
                        <div class="settings-card">
                            <div class="label">Line Height</div>
                            <div class="hint">Increase spacing between lines</div>
                            <input type="number" class="ide-input" style="margin:0;" id="editorLineHeight" min="1.2" max="2.4" step="0.1" value="1.6">
                        </div>
                        <div class="settings-card">
                            <div class="label">Tab Size</div>
                            <div class="hint">Spaces per tab</div>
                            <select class="ide-input" id="editorTabSize" style="margin:0;">
                                <option value="2">2 Spaces</option>
                                <option value="4">4 Spaces</option>
                                <option value="8">8 Spaces</option>
                            </select>
                        </div>
                        <div class="settings-card">
                            <div class="label">Cursor Style</div>
                            <div class="hint">How the caret behaves</div>
                            <select class="ide-input" id="editorCursorStyle" style="margin:0;">
                                <option value="line">Line</option>
                                <option value="block">Block</option>
                                <option value="underline">Underline</option>
                            </select>
                        </div>
                        <div class="settings-card">
                            <div class="label">Word Wrap</div>
                            <div class="hint">Wrap long lines in view</div>
                            <input type="checkbox" id="editorWordWrap">
                        </div>
                        <div class="settings-card">
                            <div class="label">Cursor Blinking</div>
                            <div class="hint">Blinking caret animation</div>
                            <select class="ide-input" id="editorCursorBlinking" style="margin:0;">
                                <option value="blink">Blink</option>
                                <option value="smooth">Smooth</option>
                                <option value="phase">Phase</option>
                                <option value="expand">Expand</option>
                                <option value="solid">Solid</option>
                            </select>
                        </div>
                        <div class="settings-card">
                            <div class="label">Scroll Beyond End</div>
                            <div class="hint">Extra space after last line</div>
                            <input type="checkbox" id="editorScrollBeyond">
                        </div>
                    </div>
                </div>

                <div class="settings-panel" data-settings-panel="display">
                    <div class="settings-grid">
                        <div class="settings-card">
                            <div class="label">Minimap</div>
                            <div class="hint">Toggle code overview</div>
                            <input type="checkbox" id="editorMinimap">
                        </div>
                        <div class="settings-card">
                            <div class="label">Minimap Size</div>
                            <div class="hint">Proportional, fill, or fit</div>
                            <select class="ide-input" id="editorMinimapSize" style="margin:0;">
                                <option value="proportional">Proportional</option>
                                <option value="fill">Fill</option>
                                <option value="fit">Fit</option>
                            </select>
                        </div>
                        <div class="settings-card">
                            <div class="label">Minimap Side</div>
                            <div class="hint">Left or right panel</div>
                            <select class="ide-input" id="editorMinimapSide" style="margin:0;">
                                <option value="right">Right</option>
                                <option value="left">Left</option>
                            </select>
                        </div>
                        <div class="settings-card">
                            <div class="label">Line Numbers</div>
                            <div class="hint">Show line numbers</div>
                            <input type="checkbox" id="editorLineNumbers">
                        </div>
                        <div class="settings-card">
                            <div class="label">Render Whitespace</div>
                            <div class="hint">Visualize spaces and tabs</div>
                            <select class="ide-input" id="editorWhitespace" style="margin:0;">
                                <option value="none">None</option>
                                <option value="boundary">Boundary</option>
                                <option value="all">All</option>
                            </select>
                        </div>
                        <div class="settings-card">
                            <div class="label">Active Line Highlight</div>
                            <div class="hint">Emphasize current line</div>
                            <input type="checkbox" id="editorLineHighlight">
                        </div>
                        <div class="settings-card">
                            <div class="label">Smooth Scrolling</div>
                            <div class="hint">Animated scroll</div>
                            <input type="checkbox" id="editorSmoothScroll">
                        </div>
                        <div class="settings-card">
                            <div class="label">Sticky Scroll</div>
                            <div class="hint">Pin active scope</div>
                            <input type="checkbox" id="editorStickyScroll">
                        </div>
                        <div class="settings-card">
                            <div class="label">Code Folding</div>
                            <div class="hint">Collapse code blocks</div>
                            <input type="checkbox" id="editorFolding">
                        </div>
                        <div class="settings-card">
                            <div class="label">Rulers</div>
                            <div class="hint">Comma-separated columns</div>
                            <input type="text" class="ide-input" style="margin:0;" id="editorRulers" placeholder="80,120">
                        </div>
                        <div class="settings-card">
                            <div class="label">Theme Mood</div>
                            <div class="hint">Adjust workspace contrast</div>
                            <select class="ide-input" id="editorTheme" style="margin:0;">
                                <option value="default">Default</option>
                                <option value="dim">Dim</option>
                                <option value="contrast">Contrast</option>
                            </select>
                        </div>
                        <div class="settings-card">
                            <div class="label">Accent Color</div>
                            <div class="hint">Editor highlight color</div>
                            <input type="color" id="editorAccent">
                        </div>
                        <div class="settings-card">
                            <div class="label">Background Color</div>
                            <div class="hint">Editor surface color</div>
                            <input type="color" id="editorBackground">
                        </div>
                        <div class="settings-card">
                            <div class="label">Tab Strip Density</div>
                            <div class="hint">Compact, normal, or large</div>
                            <select class="ide-input" id="editorTabStrip" style="margin:0;">
                                <option value="compact">Compact</option>
                                <option value="normal">Normal</option>
                                <option value="large">Large</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="settings-panel" data-settings-panel="behavior">
                    <div class="settings-grid">
                        <div class="settings-card">
                            <div class="label">Auto Save</div>
                            <div class="hint">Save after idle typing</div>
                            <input type="checkbox" id="editorAutoSave">
                        </div>
                        <div class="settings-card">
                            <div class="label">Auto Save Interval</div>
                            <div class="hint">Milliseconds between saves</div>
                            <input type="number" class="ide-input" style="margin:0;" id="editorAutoSaveInterval" min="500" max="10000" step="100" value="1200">
                        </div>
                        <div class="settings-card">
                            <div class="label">Format on Save</div>
                            <div class="hint">Auto-format code on save</div>
                            <input type="checkbox" id="editorFormatOnSave">
                        </div>
                        <div class="settings-card">
                            <div class="label">Quick Suggestions</div>
                            <div class="hint">Inline suggestion prompts</div>
                            <input type="checkbox" id="editorQuickSuggestions">
                        </div>
                        <div class="settings-card">
                            <div class="label">Trim Trailing Whitespace</div>
                            <div class="hint">Clean up extra spaces</div>
                            <input type="checkbox" id="editorTrimTrailing">
                        </div>
                        <div class="settings-card">
                            <div class="label">Indent Guides</div>
                            <div class="hint">Show indentation guides</div>
                            <input type="checkbox" id="editorIndentGuides">
                        </div>
                        <div class="settings-card">
                            <div class="label">Auto Close Brackets</div>
                            <div class="hint">Insert closing bracket</div>
                            <input type="checkbox" id="editorAutoCloseBrackets">
                        </div>
                        <div class="settings-card">
                            <div class="label">Auto Close Quotes</div>
                            <div class="hint">Insert closing quotes</div>
                            <input type="checkbox" id="editorAutoCloseQuotes">
                        </div>
                        <div class="settings-card">
                            <div class="label">Auto Close Tags</div>
                            <div class="hint">Close HTML tags automatically</div>
                            <input type="checkbox" id="editorAutoCloseTags">
                        </div>
                        <div class="settings-card">
                            <div class="label">Bracket Colorization</div>
                            <div class="hint">Color nested brackets</div>
                            <input type="checkbox" id="editorBracketColor">
                        </div>
                        <div class="settings-card">
                            <div class="label">Match Brackets</div>
                            <div class="hint">Highlight matching bracket</div>
                            <input type="checkbox" id="editorMatchBrackets">
                        </div>
                        <div class="settings-card">
                            <div class="label">Lint Severity</div>
                            <div class="hint">How strict linting feels</div>
                            <select class="ide-input" id="editorLintSeverity" style="margin:0;">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="settings-card">
                            <div class="label">Format Languages</div>
                            <div class="hint">Choose formats to apply</div>
                            <div style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:6px;">
                                <label><input type="checkbox" id="formatHtml"> HTML</label>
                                <label><input type="checkbox" id="formatCss"> CSS</label>
                                <label><input type="checkbox" id="formatJs"> JS</label>
                                <label><input type="checkbox" id="formatJson"> JSON</label>
                                <label><input type="checkbox" id="formatMd"> MD</label>
                                <label><input type="checkbox" id="formatTs"> TS</label>
                                <label><input type="checkbox" id="formatTsx"> TSX</label>
                                <label><input type="checkbox" id="formatScss"> SCSS</label>
                                <label><input type="checkbox" id="formatLess"> LESS</label>
                                <label><input type="checkbox" id="formatXml"> XML</label>
                                <label><input type="checkbox" id="formatYaml"> YAML</label>
                                <label><input type="checkbox" id="formatYml"> YML</label>
                                <label><input type="checkbox" id="formatSvg"> SVG</label>
                                <label><input type="checkbox" id="formatPhp"> PHP</label>
                                <label><input type="checkbox" id="formatPy"> Python</label>
                                <label><input type="checkbox" id="formatGo"> Go</label>
                                <label><input type="checkbox" id="formatRs"> Rust</label>
                                <label><input type="checkbox" id="formatJava"> Java</label>
                                <label><input type="checkbox" id="formatKt"> Kotlin</label>
                                <label><input type="checkbox" id="formatCs"> C#</label>
                                <label><input type="checkbox" id="formatRb"> Ruby</label>
                                <label><input type="checkbox" id="formatSql"> SQL</label>
                                <label><input type="checkbox" id="formatSh"> Shell</label>
                                <label><input type="checkbox" id="formatToml"> TOML</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-panel" data-settings-panel="workspace">
                    <div class="settings-grid">
                        <div class="settings-card">
                            <div class="label">Font Ligatures</div>
                            <div class="hint">Enable programming ligatures</div>
                            <input type="checkbox" id="editorFontLigatures">
                        </div>
                        <div class="settings-card">
                            <div class="label">Detect Indentation</div>
                            <div class="hint">Auto-detect tab size</div>
                            <input type="checkbox" id="editorDetectIndentation">
                        </div>
                        <div class="settings-card">
                            <div class="label">Auto Indent</div>
                            <div class="hint">Smart indentation behavior</div>
                            <select class="ide-input" id="editorAutoIndent" style="margin:0;">
                                <option value="none">None</option>
                                <option value="keep">Keep</option>
                                <option value="brackets">Brackets</option>
                                <option value="advanced">Advanced</option>
                                <option value="full">Full</option>
                            </select>
                        </div>
                        <div class="settings-card">
                            <div class="label">Mouse Wheel Zoom</div>
                            <div class="hint">Zoom with Ctrl + scroll</div>
                            <input type="checkbox" id="editorMouseWheelZoom">
                        </div>
                        <div class="settings-card">
                            <div class="label">Smooth Caret</div>
                            <div class="hint">Animated caret movement</div>
                            <input type="checkbox" id="editorCursorSmooth">
                        </div>
                        <div class="settings-card">
                            <div class="label">Render Final Newline</div>
                            <div class="hint">Keep files ending clean</div>
                            <input type="checkbox" id="editorRenderFinalNewline">
                        </div>
                        <div class="settings-card">
                            <div class="label">Control Characters</div>
                            <div class="hint">Show hidden control chars</div>
                            <input type="checkbox" id="editorRenderControlChars">
                        </div>
                    </div>
                </div>

                <div class="settings-panel" data-settings-panel="assist">
                    <div class="settings-grid">
                        <div class="settings-card">
                            <div class="label">Linked Editing</div>
                            <div class="hint">Update paired tags</div>
                            <input type="checkbox" id="editorLinkedEditing">
                        </div>
                        <div class="settings-card">
                            <div class="label">Inline Suggestions</div>
                            <div class="hint">Show ghost text hints</div>
                            <input type="checkbox" id="editorInlineSuggest">
                        </div>
                        <div class="settings-card">
                            <div class="label">Code Lens</div>
                            <div class="hint">Inline command hints</div>
                            <input type="checkbox" id="editorCodeLens">
                        </div>
                        <div class="settings-card">
                            <div class="label">Selection Highlight</div>
                            <div class="hint">Highlight matching text</div>
                            <input type="checkbox" id="editorSelectionHighlight">
                        </div>
                        <div class="settings-card">
                            <div class="label">Occurrences Highlight</div>
                            <div class="hint">Mark symbol occurrences</div>
                            <input type="checkbox" id="editorOccurrencesHighlight">
                        </div>
                        <div class="settings-card">
                            <div class="label">Breadcrumbs</div>
                            <div class="hint">Show file hierarchy</div>
                            <input type="checkbox" id="editorBreadcrumbs">
                        </div>
                    </div>
                </div>

                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:18px;">
                    <button class="ext-btn" id="settingsCancel">Cancel</button>
                    <button class="ext-btn install" id="settingsSave">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-portal" id="fileModal">
        <div class="modal-card" style="width:520px;">
            <div class="modal-header">
                <strong style="font-weight:900; letter-spacing:1px;" id="fileModalTitle"><i class="fa-solid fa-file-circle-plus"></i> NEW ITEM</strong>
                <i class="fa-solid fa-xmark" style="cursor:pointer;" id="closeFileModal"></i>
            </div>
            <div class="modal-body" style="display:flex; flex-direction:column; gap:18px;">
                <div style="color:#a1a1aa; font-size:0.85rem;" id="fileModalHint">Create a new file in your workspace.</div>
                <input type="text" class="ide-input" id="fileModalInput" placeholder="e.g. scripts/new.js" autocomplete="off">
                <div style="display:flex; justify-content:flex-end; gap:10px;">
                    <button class="ext-btn" id="fileModalCancel">Cancel</button>
                    <button class="ext-btn install" id="fileModalConfirm">Create</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <div class="quickopen-modal" id="quickOpenModal">
        <div class="quickopen-card">
            <input type="text" class="command-input" id="quickOpenInput" placeholder="Quick Open... (type a file name)">
            <div class="command-list" id="quickOpenList"></div>
        </div>
    </div>

    <div class="command-modal" id="commandModal">
        <div class="command-card">
            <input type="text" class="command-input" id="commandInput" placeholder="Type a command...">
            <div class="command-list" id="commandList"></div>
        </div>
    </div>

    <div class="diff-modal" id="diffModal">
        <div class="diff-card">
            <div class="diff-header">
                <strong>Diff Viewer</strong>
                <button class="ext-btn" id="closeDiff">Close</button>
            </div>
            <div class="diff-body" id="diffContainer"></div>
        </div>
    </div>

    <div class="search-modal" id="searchModal">
        <div class="search-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <strong>Workspace Search & Replace</strong>
                <button class="ext-btn" id="closeSearch">Close</button>
            </div>
            <div class="search-row">
                <input class="command-input" id="searchQuery" placeholder="Search in files..." />
                <input class="command-input" id="replaceQuery" placeholder="Replace with..." />
                <button class="btn-primary" id="replaceAllBtn">Replace All</button>
            </div>
            <div class="search-actions">
                <div style="color:#9ca3af; font-size:0.85rem;" id="workspaceSearchSummary">Enter a query to search the workspace.</div>
                <button class="btn-secondary" id="runSearchBtn">Search</button>
            </div>
            <div class="search-results" id="workspaceSearchResults"></div>
        </div>
    </div>

    <div class="tab-menu" id="tabMenu">
        <button data-action="close">Close</button>
        <button data-action="closeOthers">Close Others</button>
        <button data-action="closeAll">Close All</button>
        <button data-action="pin">Pin Tab</button>
    </div>

    <div class="app-container">
        @await Html.PartialAsync("_ProjectHubSidebar")
        <div class="main-content">
            @await Html.PartialAsync("_DashboardTopbar")
            <div class="ide-wrap">
                <div class="ide-layout" id="ideLayout">
                    <div class="activity-bar" id="activityBar">
                        <div class="act-item tooltip active" data-view="explorer" data-tooltip="Explorer">
                            <i class="fa-solid fa-folder"></i><span class="act-label">Explorer</span>
                        </div>
                        <div class="act-item tooltip" data-view="search" data-tooltip="Search">
                            <i class="fa-solid fa-magnifying-glass"></i><span class="act-label">Search</span>
                        </div>
                        <div class="act-item tooltip" data-view="git" data-tooltip="Source Control">
                            <i class="fa-solid fa-code-branch"></i><span class="act-label">Source</span>
                        </div>
                        <div class="act-item tooltip" data-view="extensions" data-tooltip="Extensions">
                            <i class="fa-solid fa-puzzle-piece"></i><span class="act-label">Add-ons</span>
                        </div>
                        <div class="act-bottom">
                            <div class="act-item tooltip" data-tooltip="Settings" id="openSettings">
                                <i class="fa-solid fa-gear"></i><span class="act-label">Settings</span>
                            </div>
                        </div>
                    </div>

                    <aside class="sidebar" id="sidebar">
                        <div class="sidebar-collapsed-bar tooltip" data-tooltip="Expand Explorer" id="sidebarCollapsedBar">
                            <i class="fa-solid fa-chevron-right"></i>
                        </div>
                        <div class="sidebar-view active" data-view="explorer">
                            <div class="sidebar-header">
                                Explorer
                                <div style="display:flex; gap:8px;">
                                    <i class="fa-solid fa-file-circle-plus tooltip" data-tooltip="New File" id="newFile"></i>
                                    <i class="fa-solid fa-folder-plus tooltip" data-tooltip="New Folder" id="newFolder"></i>
                                    <i class="fa-solid fa-chevron-left tooltip" data-tooltip="Collapse Explorer" id="sidebarToggle"></i>
                                </div>
                            </div>
                            <div class="sidebar-body">
                                <input class="ide-input" id="fileFilterInput" placeholder="Filter files..." />
                                <div class="filter-chips" id="fileFilterChips">
                                    <button class="chip active" data-filter="all">All</button>
                                    <button class="chip" data-filter="html">HTML</button>
                                    <button class="chip" data-filter="css">CSS</button>
                                    <button class="chip" data-filter="js">JS</button>
                                    <button class="chip" data-filter="assets">Assets</button>
                                </div>
                            </div>
                            <div class="file-tree" id="fileTree"></div>
                        </div>

                        <div class="sidebar-view" data-view="search">
                            <div class="sidebar-header">Search</div>
                            <div class="sidebar-body">
                                <input class="ide-input" id="searchInput" placeholder="Search in files...">
                                <div id="searchResults" style="font-size:0.85rem; color:#a1a1aa;"></div>
                            </div>
                        </div>

                        <div class="sidebar-view" data-view="git">
                            <div class="sidebar-header">Source Control</div>
                            <div class="sidebar-body">
                                <div class="git-actions">
                                    <button class="btn-secondary" id="refreshGit"><i class="fa-solid fa-rotate"></i> Refresh</button>
                                    <button class="btn-secondary" id="toggleStaged"><i class="fa-solid fa-layer-group"></i> Staged</button>
                                </div>
                                <div style="font-weight:800; margin-bottom:8px;">Changes</div>
                                <div id="gitChanges" style="font-size:0.85rem; color:#a1a1aa;"></div>
                                <button class="btn-primary tooltip" data-tooltip="Commit All Changes" id="commitBtn"><i class="fa-solid fa-check"></i> Commit All</button>
                            </div>
                        </div>

                        <div class="sidebar-view" data-view="extensions">
                            <div class="sidebar-header">Extensions</div>
                            <div class="sidebar-body">
                                <div class="ext-guide" id="extensionsGuide">
                                    <i class="fa-solid fa-xmark ext-guide-close" id="extensionsGuideClose"></i>
                                    <h5>Install a Custom Extension</h5>
                                    <ol>
                                        <li>Click Install Extension.</li>
                                        <li>Upload your .zip/.bugenceext package.</li>
                                        <li>Choose type and install to activate.</li>
                                    </ol>
                                    <div style="font-size:0.72rem; color:#a5f3fc;">You can activate or deactivate extensions anytime.</div>
                                </div>
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                    <div style="font-size:0.78rem; color:#94a3b8;">Custom & Core Extensions</div>
                                    <button class="btn-primary tooltip" data-tooltip="Install Custom Extension" id="openExtModal"><i class="fa-solid fa-plus"></i> Install Extension</button>
                                </div>
                                <div id="extensionsList"></div>
                            </div>
                        </div>
                    </aside>
                    <div class="sidebar-resizer" id="sidebarResizer"></div>

                    <section class="editor-area">
                        <div class="tabs-container">
                            <div class="tabs-list" id="tabs"></div>
                            <div class="tabs-actions">
                                <button class="tabs-action-btn tooltip" data-tooltip="Quick Open (Ctrl+P)" id="openQuickOpen"><i class="fa-solid fa-magnifying-glass"></i> Quick Open</button>
                                <button class="tabs-action-btn tooltip" data-tooltip="Command Palette (Ctrl+Shift+P)" id="openCommand"><i class="fa-solid fa-terminal"></i> Commands</button>
                                <button class="tabs-action-btn tooltip" data-tooltip="Toggle Live Preview" id="togglePreview"><i class="fa-solid fa-desktop"></i> Live Preview</button>
                            </div>
                        </div>
                        <div class="editor-split" id="editorSplit">
                            <div class="editor-pane">
                                <div class="monaco-host">
                                    <div id="monaco-root"></div>
                                    <textarea id="fallback-editor"></textarea>
                                </div>
                            </div>
                            <div class="editor-resizer" id="editorResizer"></div>
                            <div class="preview-pane" id="previewPane">
                                <div class="preview-toolbar">
                                    <div class="preview-title"><i class="fa-solid fa-bolt"></i> Live Preview</div>
                                    <div class="preview-actions">
                                        <select id="previewDevice" class="preview-select">
                                            <option value="desktop" selected>Desktop</option>
                                            <option value="tablet">Tablet</option>
                                            <option value="mobile">Mobile</option>
                                        </select>
                                        <div class="preview-zoom">
                                            <span>Zoom</span>
                                            <input type="range" min="60" max="140" value="100" id="previewZoom" />
                                            <span id="previewZoomValue">100%</span>
                                        </div>
                                        <label class="preview-toggle">
                                            <input type="checkbox" id="previewAutoRefresh" checked />
                                            <span>Refresh on save</span>
                                        </label>
                                        <button id="refreshPreview"><i class="fa-solid fa-rotate"></i> Refresh</button>
                                        <button id="openPreviewTab"><i class="fa-solid fa-arrow-up-right-from-square"></i> Open</button>
                                    </div>
                                </div>
                                <div class="preview-stage" id="previewStage">
                                    <div class="preview-shell" id="previewShell">
                                        <iframe class="preview-frame" id="previewFrame" title="Live Preview"></iframe>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bottom-panel" id="bottomPanel">
                            <div class="panel-drag" id="panelDrag"></div>
                            <div class="panel-nav">
                                <div class="p-tab active" data-panel="terminal">Terminal</div>
                                <div class="p-tab" data-panel="output">Output</div>
                                <div class="p-tab" data-panel="problems">Problems</div>
                                <div class="p-tab" data-panel="extensions">Extensions Log</div>
                                <div class="p-actions">
                                    <i class="fa-solid fa-broom tooltip" data-tooltip="Clear Terminal" id="terminalClear"></i>
                                    <i class="fa-solid fa-copy tooltip" data-tooltip="Copy Output" id="terminalCopy"></i>
                                    <i class="fa-solid fa-chevron-down tooltip" data-tooltip="Collapse Panel" id="panelToggle"></i>
                                </div>
                            </div>
                            <div class="panel-content active" data-panel="terminal">
                                <div id="terminalOutput">
                                    <div style="margin-top:10px;">$ npm run build</div>
                                    <div style="color:var(--success);"> Build completed</div>
                                </div>
                                <div class="terminal-input-row">
                                    <span class="prompt">bugence></span>
                                    <input class="cmd-in" placeholder="type a command" />
                                </div>
                            </div>
                            <div class="panel-content" data-panel="output">
                                <div>Preview refreshed for <span id="outputFile">index.html</span></div>
                            </div>
                            <div class="panel-content" data-panel="problems">
                                <div id="problemList">No issues detected.</div>
                            </div>
                            <div class="panel-content" data-panel="extensions">
                                <div id="extensionsLog">Extension activity will appear here.</div>
                            </div>
                        </div>
                    </section>

                    <div class="status-bar">
                        <div class="sb-grp">
                            <span id="statusFile">index.html</span>
                            <span id="statusState">Saved</span>
                            <button class="ext-btn install tooltip" data-tooltip="Save File" id="saveBtn" style="padding:4px 10px; font-size:0.72rem;">Save</button>
                        </div>
                        <div class="sb-grp">
                            <span id="statusLang">HTML</span>
                            <span id="statusPos">Ln 1, Col 1</span>
                            <span>Spaces: 2</span>
                            <span id="statusEncoding">UTF-8</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const projectId = @pid;
        const projectRootName = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(projectName ?? "Project"));
        const storageKey = `custom_code_${projectId}`;
        const serverFilesPayload = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(serverFilesPayload));
        const serverFileIndexPayload = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(serverFileIndexPayload));
        const serverExtensionsPayload = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(serverExtensionsPayload));
        const csrfInput = document.querySelector('#antiforgeryForm input[name="__RequestVerificationToken"]');
        const csrfToken = csrfInput ? csrfInput.value : "";
        const decodeBase64Utf8 = (payload) => {
            if (!payload) return '';
            const binary = atob(payload);
            if (typeof TextDecoder !== 'undefined') {
                const bytes = Uint8Array.from(binary, c => c.charCodeAt(0));
                return new TextDecoder('utf-8').decode(bytes);
            }
            let escaped = '';
            for (let i = 0; i < binary.length; i++) {
                escaped += '%' + ('00' + binary.charCodeAt(i).toString(16)).slice(-2);
            }
            return decodeURIComponent(escaped);
        };
        const decodeBase64Json = (payload, fallback) => {
            if (!payload) return fallback;
            try {
                const text = decodeBase64Utf8(payload);
                return text ? JSON.parse(text) : fallback;
            } catch {
                return fallback;
            }
        };
        const serverFiles = decodeBase64Json(serverFilesPayload, []);
        const serverFileIndex = decodeBase64Json(serverFileIndexPayload, []);
        const serverExtensions = decodeBase64Json(serverExtensionsPayload, []);
        const normalizedServerExtensions = (serverExtensions || []).map(ext => ({
            id: ext.id || ext.Id,
            name: ext.name || ext.Name,
            type: (ext.type || ext.Type || 'utility').toLowerCase(),
            fileName: ext.fileName || ext.FileName
        }));
        const toForm = (data) => {
            const form = new URLSearchParams();
            Object.entries(data || {}).forEach(([k, v]) => form.append(k, v === undefined || v === null ? "" : v));
            if (!("RequestVerificationToken" in data)) {
                form.append("__RequestVerificationToken", csrfToken);
            }
            return form;
        };
        const defaults = {
            files: {},
            open: [],
            active: "",
            dirty: {},
            settings: {
                fontSize: 14,
                fontFamily: 'JetBrains Mono',
                lineHeight: 1.6,
                tabSize: 2,
                cursorStyle: 'line',
                wordWrap: true,
                minimap: false,
                minimapSize: 'proportional',
                minimapSide: 'right',
                lineNumbers: true,
                renderWhitespace: 'none',
                lineHighlight: true,
                smoothScroll: true,
                theme: 'default',
                themeAccent: '#06b6d4',
                themeBackground: '#111111',
                autoSave: false,
                autoSaveInterval: 1200,
                formatOnSave: false,
                trimTrailing: true,
                indentGuides: true,
                autoCloseBrackets: true,
                autoCloseQuotes: true,
                lintSeverity: 'medium',
                tabStrip: 'normal',
                cursorBlinking: 'blink',
                cursorSmoothCaret: false,
                scrollBeyondLastLine: false,
                bracketColorization: true,
                matchBrackets: true,
                autoClosingTags: true,
                stickyScroll: true,
                folding: true,
                quickSuggestions: true,
                rulers: '80,120',
                formatLanguages: {
                    html: true,
                    css: true,
                    js: true,
                    json: true,
                    md: true,
                    ts: true,
                    tsx: true,
                    scss: true,
                    less: true,
                    xml: true,
                    yaml: true,
                    yml: true,
                    svg: true,
                    php: true,
                    py: true,
                    go: true,
                    rs: true,
                    java: true,
                    kt: true,
                    cs: true,
                    rb: true,
                    sql: true,
                    sh: true,
                    toml: true
                },
                fontLigatures: false,
                detectIndentation: true,
                autoIndent: 'advanced',
                mouseWheelZoom: false,
                renderFinalNewline: true,
                renderControlChars: false,
                linkedEditing: true,
                inlineSuggest: true,
                codeLens: true,
                selectionHighlight: true,
                occurrencesHighlight: true,
                breadcrumbs: true
            },
            customExtensions: [],
            activeExtensions: {},
            extensions: {
                "lint-pack": false,
                "theme-night": false,
                "formatter-pro": false
            },
            ui: {
                preview: true,
                previewDevice: 'desktop',
                previewZoom: 100,
                previewAutoRefresh: true,
                fileFilter: 'all',
                fileQuery: '',
                sidebarWidth: 280,
                sidebarCollapsed: false,
                panelHeight: 220,
                panelCollapsed: false,
                editorSplit: 0.5
            },
            pins: [],
            history: {}
        };

        const serverFileMap = (serverFiles || []).reduce((acc, f) => {
            acc[f.Path] = { language: f.Language, content: f.Content || "", readOnly: !!f.ReadOnly };
            return acc;
        }, {});
        const serverFileIndexPaths = Array.isArray(serverFileIndex)
            ? serverFileIndex.filter(p => typeof p === 'string' && p.trim().length)
            : [];

        let state = JSON.parse(JSON.stringify(defaults));
        const getFile = (path) => (state.files && state.files[path]) ? state.files[path] : null;
        const getFileContent = (path) => {
            const file = getFile(path);
            return file && typeof file.content === 'string' ? file.content : '';
        };

        const ideLayout = document.getElementById('ideLayout');
        const sidebar = document.getElementById('sidebar');
        const sidebarResizer = document.getElementById('sidebarResizer');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarCollapsedBar = document.getElementById('sidebarCollapsedBar');
        const editorSplit = document.getElementById('editorSplit');
        const editorResizer = document.getElementById('editorResizer');
        const editorPane = document.querySelector('.editor-pane');
        const fileTree = document.getElementById('fileTree');
        const tabs = document.getElementById('tabs');
        const statusFile = document.getElementById('statusFile');
        const statusLang = document.getElementById('statusLang');
        const statusState = document.getElementById('statusState');
        const statusPos = document.getElementById('statusPos');
        const statusEncoding = document.getElementById('statusEncoding');
        const outputFile = document.getElementById('outputFile');
        const problemList = document.getElementById('problemList');
        const gitChanges = document.getElementById('gitChanges');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const searchModal = document.getElementById('searchModal');
        const searchQueryInput = document.getElementById('searchQuery');
        const replaceQueryInput = document.getElementById('replaceQuery');
        const runSearchBtn = document.getElementById('runSearchBtn');
        const replaceAllBtn = document.getElementById('replaceAllBtn');
        const workspaceSearchResults = document.getElementById('workspaceSearchResults');
        const workspaceSearchSummary = document.getElementById('workspaceSearchSummary');
        const closeSearch = document.getElementById('closeSearch');
        const fileFilterInput = document.getElementById('fileFilterInput');
        const fileFilterChips = document.getElementById('fileFilterChips');
        const extensionsList = document.getElementById('extensionsList');
        const extensionsLog = document.getElementById('extensionsLog');
        const toast = document.getElementById('toast');
        const bottomPanel = document.getElementById('bottomPanel');
        const panelToggle = document.getElementById('panelToggle');
        const previewPane = document.getElementById('previewPane');
        const previewStage = document.getElementById('previewStage');
        const previewShell = document.getElementById('previewShell');
        const previewFrame = document.getElementById('previewFrame');
        const togglePreviewBtn = document.getElementById('togglePreview');
        const refreshPreviewBtn = document.getElementById('refreshPreview');
        const openPreviewTabBtn = document.getElementById('openPreviewTab');
        const previewDevice = document.getElementById('previewDevice');
        const previewZoom = document.getElementById('previewZoom');
        const previewZoomValue = document.getElementById('previewZoomValue');
        const previewAutoRefresh = document.getElementById('previewAutoRefresh');
        const quickOpenModal = document.getElementById('quickOpenModal');
        const quickOpenInput = document.getElementById('quickOpenInput');
        const quickOpenList = document.getElementById('quickOpenList');
        const commandModal = document.getElementById('commandModal');
        const commandInput = document.getElementById('commandInput');
        const commandList = document.getElementById('commandList');
        const diffModal = document.getElementById('diffModal');
        const diffContainer = document.getElementById('diffContainer');
        const closeDiff = document.getElementById('closeDiff');
        const terminalClear = document.getElementById('terminalClear');
        const terminalCopy = document.getElementById('terminalCopy');
        const panelDrag = document.getElementById('panelDrag');
        const tabMenu = document.getElementById('tabMenu');
        const refreshGitBtn = document.getElementById('refreshGit');
        const toggleStagedBtn = document.getElementById('toggleStaged');

        let editor = null;
        let editorReady = false;
        let isLoading = false;
        let autosaveTimer = null;
        let tabMenuTarget = null;
        const fileLoadPromises = {};

        const languageMap = {
            html: 'html',
            css: 'css',
            javascript: 'javascript',
            json: 'json',
            markdown: 'markdown'
        };

        function showToast(message, icon = 'fa-circle-check') {
            if (!toast) return;
            toast.innerHTML = `<i class="fa-solid ${icon}"></i><span>${message}</span>`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2200);
        }

        function updateStatusPos(line = 1, column = 1) {
            if (statusPos) statusPos.textContent = `Ln ${line}, Col ${column}`;
        }

        function updateStatusEncoding() {
            if (statusEncoding) statusEncoding.textContent = 'UTF-8';
        }

        function updateFallbackCursor(fallback) {
            if (!fallback) return;
            const pos = fallback.selectionStart || 0;
            const before = fallback.value.slice(0, pos);
            const lines = before.split('\n');
            const line = lines.length;
            const column = lines[lines.length - 1].length + 1;
            updateStatusPos(line, column);
        }

        function saveState() {
            localStorage.setItem(storageKey, JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem(storageKey);
            if (!saved) return;
            try {
                const parsed = JSON.parse(saved);
                state = {
                    ...state,
                    ...parsed,
                    files: parsed.files || state.files,
                    dirty: parsed.dirty || {},
                    settings: parsed.settings || state.settings,
                    customExtensions: parsed.customExtensions || state.customExtensions,
                    activeExtensions: parsed.activeExtensions || state.activeExtensions,
                    ui: parsed.ui || state.ui,
                    history: parsed.history || state.history
                };
            } catch { /* ignore */ }
        }

        function fileExtension(path) {
            const parts = path.split('.');
            return parts.length > 1 ? parts.pop().toLowerCase() : '';
        }

        function fileLanguage(path) {
            const ext = fileExtension(path);
            if (ext === 'html') return 'html';
            if (ext === 'css') return 'css';
            if (ext === 'js') return 'javascript';
            if (ext === 'ts') return 'typescript';
            if (ext === 'tsx') return 'typescript';
            if (ext === 'json') return 'json';
            if (ext === 'md') return 'markdown';
            if (ext === 'scss') return 'scss';
            if (ext === 'less') return 'less';
            if (ext === 'xml') return 'xml';
            if (ext === 'yaml' || ext === 'yml') return 'yaml';
            if (ext === 'svg') return 'xml';
            if (ext === 'php') return 'php';
            if (ext === 'py') return 'python';
            if (ext === 'go') return 'go';
            if (ext === 'rs') return 'rust';
            if (ext === 'java') return 'java';
            if (ext === 'kt') return 'kotlin';
            if (ext === 'cs') return 'csharp';
            if (ext === 'rb') return 'ruby';
            if (ext === 'sql') return 'sql';
            if (ext === 'sh') return 'shell';
            if (ext === 'toml') return 'toml';
            return 'plaintext';
        }

        function isAssetExtension(ext) {
            return [
                'png', 'jpg', 'jpeg', 'gif', 'webp', 'svg', 'ico',
                'mp4', 'mp3', 'wav', 'ogg',
                'woff', 'woff2', 'ttf', 'otf', 'eot',
                'pdf', 'zip', 'rar'
            ].includes(ext);
        }

        function isPathMatch(path) {
            if (!path) return false;
            if (path.endsWith('/.keep') || path.endsWith('.keep')) return false;
            const query = (state.ui && state.ui.fileQuery) ? state.ui.fileQuery.trim().toLowerCase() : '';
            if (query && !path.toLowerCase().includes(query)) return false;
            const filter = (state.ui && state.ui.fileFilter) ? state.ui.fileFilter : 'all';
            if (filter === 'all') return true;
            const ext = fileExtension(path);
            if (filter === 'html') return ext === 'html' || ext === 'htm';
            if (filter === 'css') return ext === 'css' || ext === 'scss' || ext === 'less';
            if (filter === 'js') return ['js', 'jsx', 'ts', 'tsx', 'mjs', 'cjs'].includes(ext);
            if (filter === 'assets') return isAssetExtension(ext);
            return true;
        }

        function seedFilesFromIndex(paths) {
            const map = {};
            (paths || []).forEach(p => {
                if (!p) return;
                map[p] = {
                    language: fileLanguage(p),
                    content: '',
                    readOnly: false,
                    needsLoad: true
                };
            });
            return map;
        }

        function bootstrapFromServer() {
            const fileKeys = Object.keys(serverFileMap);
            if (!fileKeys.length) return;
            state.files = serverFileMap;
            state.open = [fileKeys[0]];
            state.active = fileKeys[0];
            state.dirty = {};
        }

        function ensureOpen(path) {
            if (!state.open.includes(path)) state.open.push(path);
            state.active = path;
            renderTabs();
            loadActiveFile();
        }

        function setDirty(path, isDirty) {
            state.dirty[path] = isDirty;
            statusState.textContent = isDirty ? 'Unsaved' : 'Saved';
            renderTabs();
            renderGitChanges();
            saveState();
        }

        function renderTabs() {
            tabs.innerHTML = '';
            state.open.forEach(path => {
                const tab = document.createElement('div');
                const pinned = Array.isArray(state.pins) && state.pins.includes(path);
                tab.className = 'tab' + (path === state.active ? ' active' : '') + (state.dirty[path] ? ' dirty' : '') + (pinned ? ' pinned' : '');
                tab.setAttribute('data-tab', path);
                tab.innerHTML = `<i class="fa-solid fa-file"></i><span>${path.split('/').pop()}</span>${pinned ? '<i class="fa-solid fa-thumbtack" style="font-size:0.65rem; opacity:0.6;"></i>' : ''}<span class="dirty-dot"></span><span class="tab-close" data-close="${path}"></span>`;
                tab.addEventListener('click', () => {
                    state.active = path;
                    loadActiveFile();
                    renderTabs();
                });
                tab.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    if (!tabMenu) return;
                    tabMenuTarget = path;
                    tabMenu.style.left = `${e.clientX}px`;
                    tabMenu.style.top = `${e.clientY}px`;
                    tabMenu.classList.add('show');
                });
                const closeBtn = tab.querySelector('.tab-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        closeTab(path);
                    });
                }
                tabs.appendChild(tab);
            });
        }

        function closeTab(path) {
            const idx = state.open.indexOf(path);
            if (idx === -1) return;
            state.open.splice(idx, 1);
            if (Array.isArray(state.pins)) {
                state.pins = state.pins.filter(p => p !== path);
            }
            if (state.active === path) {
                state.active = state.open[idx - 1] || state.open[0] || '';
            }
            renderTabs();
            loadActiveFile();
            saveState();
        }

        function renderFileTree() {
            const filteredPaths = Object.keys(state.files).filter(p => isPathMatch(p));
            const tree = buildTree(filteredPaths);
            fileTree.innerHTML = '';
            if (!tree.length) {
                fileTree.innerHTML = `
                    <div class="tree-empty">
                        <strong>No files match the current filter.</strong><br>
                        Try a different filter or clear your search query.
                    </div>`;
                return;
            }
            const rootNode = {
                name: projectRootName || 'Project',
                children: tree,
                isFile: false,
                path: '__root__',
                isRoot: true
            };
            fileTree.appendChild(renderTreeNode(rootNode));
        }

        function buildTree(paths) {
            const root = [];
            paths.filter(p => !p.endsWith('/.keep') && !p.endsWith('.keep')).forEach(path => {
                const parts = path.split('/');
                let current = root;
                parts.forEach((part, idx) => {
                    let node = current.find(n => n.name === part);
                    if (!node) {
                        node = { name: part, children: [], isFile: idx === parts.length - 1, path: parts.slice(0, idx + 1).join('/') };
                        current.push(node);
                    }
                    current = node.children;
                });
            });
            return root;
        }

        function renderTreeNode(node, depth = 0) {
            const wrapper = document.createElement('div');
            if (node.isFile) {
                const ext = fileExtension(node.path);
                const fileMeta = getFile(node.path);
                const badges = [];
                if (ext) badges.push(`<span class="tree-badge">${ext.toUpperCase()}</span>`);
                if (state.dirty[node.path]) badges.push(`<span class="tree-badge warn">M</span>`);
                if (fileMeta && fileMeta.readOnly) badges.push(`<span class="tree-badge lock">RO</span>`);
                const item = document.createElement('div');
                item.className = 'tree-item' + (node.path === state.active ? ' active' : '');
                item.setAttribute('data-path', node.path);
                item.innerHTML = `<span class="tree-indent" style="width:${depth * 12}px"></span><i class="fa-solid fa-file"></i><span class="tree-name">${node.name}</span>${badges.length ? `<span class="tree-badges">${badges.join('')}</span>` : ''}`;
                item.addEventListener('click', () => ensureOpen(node.path));
                wrapper.appendChild(item);
                return wrapper;
            }

            wrapper.className = 'folder-node';
            if (node.isRoot) {
                wrapper.classList.add('folder-open', 'tree-root');
            }
            const row = document.createElement('div');
            row.className = 'tree-item';
            row.innerHTML = `<span class="tree-indent" style="width:${depth * 12}px"></span><i class="fa-solid fa-chevron-right arrow"></i><i class="fa-solid fa-folder"></i>${node.name}`;
            row.addEventListener('click', () => wrapper.classList.toggle('folder-open'));
            wrapper.appendChild(row);

            const children = document.createElement('div');
            children.className = 'sub-tree';
            node.children.forEach(child => children.appendChild(renderTreeNode(child, depth + 1)));
            wrapper.appendChild(children);
            return wrapper;
        }

        function updateEditorContent(text) {
            isLoading = true;
            if (editorReady && editor) {
                const model = editor.getModel();
                if (model) model.setValue(text);
            } else {
                const fallback = document.getElementById('fallback-editor');
                if (fallback) fallback.value = text;
            }
            isLoading = false;
        }

        function clearEditorView(message = 'No file selected') {
            statusFile.textContent = message;
            statusLang.textContent = '--';
            outputFile.textContent = '';
            statusState.textContent = 'Idle';
            updateEditorContent('');
            setEditorReadOnly(true);
            if (problemList) {
                problemList.textContent = 'Open a file to view diagnostics.';
            }
        }

        function loadFileFromServer(path) {
            if (fileLoadPromises[path]) return fileLoadPromises[path];
            const url = `/ProjectHub/CustomCode?handler=FileContent&projectId=${projectId}&path=${encodeURIComponent(path)}`;
            fileLoadPromises[path] = fetch(url)
                .then(r => {
                    if (!r.ok) throw new Error('Load failed');
                    return r.json();
                })
                .then(data => {
                    if (!data || !data.success) throw new Error('Load failed');
                    return {
                        content: data.content || '',
                        readOnly: !!data.readOnly,
                        language: data.language || fileLanguage(path)
                    };
                })
                .finally(() => {
                    delete fileLoadPromises[path];
                });
            return fileLoadPromises[path];
        }

        function applyEditorSettings() {
            const settings = state.settings || {};
            const fontSize = settings.fontSize || 14;
            const minimap = !!settings.minimap;
            const minimapSize = settings.minimapSize || 'proportional';
            const minimapSide = settings.minimapSide || 'right';
            const fontFamily = settings.fontFamily || 'JetBrains Mono';
            const lineHeight = settings.lineHeight ? Math.round(settings.lineHeight * fontSize) : Math.round(1.6 * fontSize);
            const tabSize = settings.tabSize || 2;
            const cursorStyle = settings.cursorStyle || 'line';
            const wordWrap = settings.wordWrap ? 'on' : 'off';
            const lineNumbers = settings.lineNumbers ? 'on' : 'off';
            const renderWhitespace = settings.renderWhitespace || 'none';
            const lineHighlight = settings.lineHighlight ? 'all' : 'none';
            const smoothScrolling = !!settings.smoothScroll;
            const renderIndentGuides = settings.indentGuides !== false;
            const autoClosingBrackets = settings.autoCloseBrackets ? 'always' : 'never';
            const autoClosingQuotes = settings.autoCloseQuotes ? 'always' : 'never';
            const cursorBlinking = settings.cursorBlinking || 'blink';
            const scrollBeyondLastLine = !!settings.scrollBeyondLastLine;
            const matchBrackets = settings.matchBrackets ? 'always' : 'never';
            const autoClosingTags = settings.autoClosingTags ? 'always' : 'never';
            const stickyScroll = settings.stickyScroll !== false;
            const folding = settings.folding !== false;
            const quickSuggestions = settings.quickSuggestions !== false;
            const bracketPairColorization = settings.bracketColorization !== false;
            const fontLigatures = !!settings.fontLigatures;
            const detectIndentation = settings.detectIndentation !== false;
            const autoIndent = settings.autoIndent || 'advanced';
            const mouseWheelZoom = !!settings.mouseWheelZoom;
            const renderFinalNewline = settings.renderFinalNewline !== false;
            const renderControlCharacters = !!settings.renderControlChars;
            const linkedEditing = settings.linkedEditing !== false;
            const inlineSuggest = settings.inlineSuggest !== false;
            const codeLens = settings.codeLens !== false;
            const selectionHighlight = settings.selectionHighlight !== false;
            const occurrencesHighlight = settings.occurrencesHighlight !== false;
            const breadcrumbs = settings.breadcrumbs !== false;
            const rulers = (settings.rulers || '')
                .split(',')
                .map(v => parseInt(v.trim(), 10))
                .filter(v => !Number.isNaN(v) && v > 0);
            if (editorReady && editor) {
                editor.updateOptions({
                    fontSize,
                    minimap: { enabled: minimap, size: minimapSize, side: minimapSide },
                    fontFamily,
                    fontLigatures,
                    lineHeight,
                    tabSize,
                    cursorStyle,
                    wordWrap,
                    lineNumbers,
                    renderWhitespace,
                    renderControlCharacters,
                    renderLineHighlight: lineHighlight,
                    smoothScrolling,
                    renderIndentGuides,
                    autoClosingBrackets,
                    autoClosingQuotes,
                    cursorBlinking,
                    cursorSmoothCaretAnimation: settings.cursorSmoothCaret ? 'on' : 'off',
                    scrollBeyondLastLine,
                    matchBrackets,
                    autoClosingTags,
                    stickyScroll: { enabled: stickyScroll },
                    folding,
                    quickSuggestions,
                    rulers,
                    bracketPairColorization: { enabled: bracketPairColorization },
                    detectIndentation,
                    autoIndent,
                    mouseWheelZoom,
                    renderFinalNewline,
                    linkedEditing: { enabled: linkedEditing },
                    inlineSuggest: { enabled: inlineSuggest },
                    codeLens,
                    selectionHighlight,
                    occurrencesHighlight,
                    breadcrumbs: { enabled: breadcrumbs }
                });
            }
            const fallback = document.getElementById('fallback-editor');
            if (fallback) {
                fallback.style.fontSize = `${fontSize}px`;
                fallback.style.fontFamily = fontFamily;
                fallback.style.lineHeight = settings.lineHeight ? `${settings.lineHeight}` : '1.6';
            }
            const layout = document.getElementById('ideLayout');
            if (layout) {
                layout.classList.toggle('theme-dim', settings.theme === 'dim');
                layout.classList.toggle('theme-contrast', settings.theme === 'contrast');
                layout.style.setProperty('--accent', settings.themeAccent || '#06b6d4');
                layout.style.setProperty('--bg-editor', settings.themeBackground || '#111111');
                const tabsContainer = document.getElementById('tabs');
                if (tabsContainer) {
                    tabsContainer.classList.toggle('tabs-compact', settings.tabStrip === 'compact');
                    tabsContainer.classList.toggle('tabs-large', settings.tabStrip === 'large');
                }
            }
        }

        function setEditorReadOnly(isReadOnly) {
            if (editorReady && editor) {
                editor.updateOptions({ readOnly: !!isReadOnly });
            }
            const fallback = document.getElementById('fallback-editor');
            if (fallback) {
                fallback.readOnly = !!isReadOnly;
            }
        }

        function readEditorContent() {
            if (editorReady && editor) {
                return editor.getValue();
            }
            const fallback = document.getElementById('fallback-editor');
            return fallback ? fallback.value : '';
        }

        function loadActiveFile() {
            const path = state.active;
            if (!path) {
                clearEditorView();
                return;
            }
            const file = state.files[path];
            if (!file) {
                clearEditorView();
                return;
            }
            if (file.needsLoad) {
                statusFile.textContent = path;
                statusLang.textContent = file.language.toUpperCase();
                statusState.textContent = 'Loading...';
                loadFileFromServer(path)
                    .then(result => {
                        state.files[path] = {
                            ...state.files[path],
                            content: result.content,
                            readOnly: result.readOnly,
                            language: result.language,
                            needsLoad: false
                        };
                        saveState();
                        loadActiveFile();
                    })
                    .catch(() => {
                        state.files[path].content = '// Unable to load file content.';
                        state.files[path].readOnly = true;
                        state.files[path].needsLoad = false;
                        saveState();
                        loadActiveFile();
                    });
                return;
            }
            statusFile.textContent = path;
            statusLang.textContent = file.language.toUpperCase();
            outputFile.textContent = path;
            updateEditorContent(file.content);
            statusState.textContent = file.readOnly ? 'Read only' : (state.dirty[path] ? 'Unsaved' : 'Saved');
            setEditorReadOnly(file.readOnly);
            if (problemList) {
                if (file.readOnly) {
                    problemList.textContent = 'Binary or large file opened as read-only.';
                } else {
                    updateLintStatus(file.content);
                }
            }
            highlightActiveTreeItem();
            loadActiveLanguage();
            updatePreviewVisibility();
            updateLivePreview(true);
        }

        function highlightActiveTreeItem() {
            document.querySelectorAll('.tree-item').forEach(item => item.classList.remove('active'));
            const active = document.querySelector(`.tree-item[data-path="${state.active}"]`);
            if (active) active.classList.add('active');
        }

        let previewTimer = null;

        function resolvePreviewBase(path) {
            if (!path) return `/Uploads/${encodeURIComponent(projectRootName)}/`;
            const parts = path.split('/');
            parts.pop();
            const dir = parts.length ? `${parts.join('/')}/` : '';
            return `/Uploads/${encodeURIComponent(projectRootName)}/${dir}`;
        }

        function resolvePreviewUrl(path) {
            if (!path) return '';
            return `/Uploads/${encodeURIComponent(projectRootName)}/${path}`;
        }

        function rewriteRootPaths(content, baseRoot) {
            if (!content) return content;
            const root = baseRoot.replace(/\/$/, '');
            const safeRoot = `${root}/`;
            const attrRootRegex = new RegExp('(href|src)=([\\\"\\\'])/(?!/)(?!Uploads/)', 'gi');
            const cssRootRegex = new RegExp('url\\(\\s*/(?!/)(?!Uploads/)', 'gi');
            return content
                .replace(/\$\{url\}/gi, safeRoot)
                .replace(attrRootRegex, '$1=$2' + root + '/')
                .replace(cssRootRegex, 'url(' + root + '/');
        }

        function buildPreviewHtml(content, baseHref, baseRoot) {
            if (!content) return '';
            const baseTag = `<base href="${baseHref}">`;
            let output = content;
            if (output.match(/<head[^>]*>/i)) {
                output = output.replace(/<head([^>]*)>/i, `<head$1>${baseTag}`);
            } else {
                output = `${baseTag}\n${output}`;
            }
            return rewriteRootPaths(output, baseRoot);
        }

        const previewBodyClose = '</bo' + 'dy>';
        const previewHtmlClose = '</ht' + 'ml>';
        function buildAssetPreviewDoc(path, ext) {
            const baseHref = resolvePreviewBase(path);
            const url = resolvePreviewUrl(path);
            const baseTag = `<base href="${baseHref}">`;
            if (ext === 'css') {
                const baseRoot = `/Uploads/${encodeURIComponent(projectRootName)}/`;
                const cssContent = rewriteRootPaths(getFileContent(path), baseRoot);
                return `<!doctype html><html><head>${baseTag}<style>${cssContent}</style></head><body style="padding:24px;font-family:Inter,system-ui;background:#0f1115;color:#e5e7eb;"><h2>CSS Preview</h2><p>Inline stylesheet: <code>${path}</code></p><div class="preview-demo">This is a preview canvas.</div>${previewBodyClose}${previewHtmlClose}`;
            }
            if (ext === 'js' || ext === 'mjs') {
                return `<!doctype html><html><head>${baseTag}</head><body style="padding:24px;font-family:Inter,system-ui;background:#0f1115;color:#e5e7eb;"><h2>JS Preview</h2><div id="app"></div><script src="${url}"><\\/script>${previewBodyClose}${previewHtmlClose}`;
            }
            if (ext === 'jsx' || ext === 'tsx') {
                const scriptClose = '</scr' + 'ipt>';
                const raw = getFileContent(path).split(scriptClose).join('<\\/script>');
                return `<!doctype html><html><head>${baseTag}<meta charset="utf-8"></head><body style="margin:0;font-family:Inter,system-ui;background:#0f1115;color:#e5e7eb;"><div id="root" style="padding:24px"></div><script src="https://unpkg.com/react@18/umd/react.development.js"><\\/script><script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"><\\/script><script src="https://unpkg.com/%40babel/standalone/babel.min.js"><\\/script><script type="text/babel">${raw}\nif (typeof ReactDOM !== 'undefined') {const rootEl = document.getElementById('root'); if (rootEl && typeof App !== 'undefined') {const root = ReactDOM.createRoot(rootEl); root.render(React.createElement(App));}}<\\/script>${previewBodyClose}${previewHtmlClose}`;
            }
            return `<!doctype html><html><head>${baseTag}</head><body style="padding:24px;font-family:Inter,system-ui;background:#0f1115;color:#e5e7eb;"><h2>No live preview for ${ext.toUpperCase()}</h2><p>Open an HTML, CSS, JS, or JSX file to render a preview.</p>${previewBodyClose}${previewHtmlClose}`;
        }

        const SIDEBAR_MIN = 180;
        const SIDEBAR_MAX = 520;
        const SIDEBAR_COLLAPSED = 56;
        const PANEL_MIN = 140;
        const PANEL_MAX = 520;
        const PANEL_COLLAPSED = 44;
        const EDITOR_SPLIT_MIN = 0.25;
        const EDITOR_SPLIT_MAX = 0.75;

        const isMobileIdeViewport = () => window.matchMedia('(max-width: 980px)').matches;

        function applySidebarWidth(width) {
            if (!ideLayout) return;
            const next = Math.min(SIDEBAR_MAX, Math.max(SIDEBAR_MIN, width));
            if (state.ui) state.ui.sidebarWidth = next;
            ideLayout.style.setProperty('--sidebar-width', `${next}px`);
        }

        function setSidebarCollapsed(collapsed, persist = true) {
            if (!ideLayout || !state.ui) return;
            state.ui.sidebarCollapsed = collapsed;
            ideLayout.classList.toggle('sidebar-collapsed', collapsed);
            if (isMobileIdeViewport()) {
                ideLayout.classList.toggle('ide-mobile-sidebar-open', !collapsed);
            }
            const width = collapsed ? SIDEBAR_COLLAPSED : (state.ui.sidebarWidth || 280);
            ideLayout.style.setProperty('--sidebar-width', `${width}px`);
            if (persist) saveState();
        }

        function applyPanelHeight(height) {
            if (!bottomPanel || !state.ui) return;
            const next = Math.min(PANEL_MAX, Math.max(PANEL_MIN, height));
            state.ui.panelHeight = next;
            bottomPanel.style.height = `${next}px`;
            if (bottomPanel.classList.contains('collapsed')) {
                bottomPanel.classList.remove('collapsed');
                state.ui.panelCollapsed = false;
            }
        }

        function setPanelCollapsed(collapsed, persist = true) {
            if (!bottomPanel || !state.ui) return;
            state.ui.panelCollapsed = collapsed;
            bottomPanel.classList.toggle('collapsed', collapsed);
            const height = collapsed ? PANEL_COLLAPSED : (state.ui.panelHeight || 220);
            bottomPanel.style.height = `${height}px`;
            if (persist) saveState();
            syncPanelToggle();
        }

        function applyEditorSplit(ratio) {
            if (!editorSplit || !editorPane || !previewPane || !state.ui) return;
            if (!state.ui.preview) {
                editorPane.style.flex = '';
                previewPane.style.flex = '';
                return;
            }
            const next = Math.min(EDITOR_SPLIT_MAX, Math.max(EDITOR_SPLIT_MIN, ratio || 0.5));
            state.ui.editorSplit = next;
            editorPane.style.flex = `0 0 ${next * 100}%`;
            previewPane.style.flex = `0 0 ${(1 - next) * 100}%`;
        }

        function applyLayoutState() {
            if (!state.ui) return;
            if (state.ui.sidebarCollapsed) {
                setSidebarCollapsed(true, false);
            } else {
                if (ideLayout) ideLayout.classList.remove('sidebar-collapsed');
                applySidebarWidth(state.ui.sidebarWidth || 280);
            }
            if (state.ui.panelCollapsed) {
                setPanelCollapsed(true, false);
            } else if (state.ui.panelHeight) {
                if (bottomPanel) bottomPanel.style.height = `${state.ui.panelHeight}px`;
            }
            applyEditorSplit(state.ui.editorSplit || 0.5);
            syncPanelToggle();
        }

        function updatePreviewVisibility() {
            if (!previewPane) return;
            const hasPreview = !!(state.ui && state.ui.preview);
            previewPane.classList.toggle('active', hasPreview);
            if (editorSplit) editorSplit.classList.toggle('preview-active', hasPreview);
            if (hasPreview) {
                applyEditorSplit(state.ui.editorSplit || 0.5);
            } else if (editorPane) {
                editorPane.style.flex = '';
                previewPane.style.flex = '';
            }
        }

        function applyPreviewLayout() {
            if (!previewShell || !previewFrame) return;
            const device = state.ui && state.ui.previewDevice ? state.ui.previewDevice : 'desktop';
            const map = {
                desktop: { w: 1280, h: 720 },
                tablet: { w: 900, h: 1180 },
                mobile: { w: 390, h: 844 }
            };
            const size = map[device] || map.desktop;
            const zoom = state.ui && state.ui.previewZoom ? state.ui.previewZoom : 100;
            previewShell.style.width = `${size.w}px`;
            previewShell.style.height = `${size.h}px`;
            previewShell.style.transform = `scale(${zoom / 100})`;
            previewFrame.style.width = '100%';
            previewFrame.style.height = '100%';
            if (previewZoomValue) previewZoomValue.textContent = `${zoom}%`;
        }

        function updateLivePreview(force = false) {
            if (!(state.ui && state.ui.preview) || !previewPane || !previewFrame) return;
            applyPreviewLayout();
            const path = state.active;
            if (!path) {
                previewFrame.srcdoc = buildAssetPreviewDoc('', 'txt');
                return;
            }
            const ext = fileExtension(path);
            if (!ext) return;
            if (ext === 'html') {
                const content = getFileContent(path);
                if (!content && !force) return;
                const baseHref = resolvePreviewBase(path);
                const baseRoot = `/Uploads/${encodeURIComponent(projectRootName)}/`;
                previewFrame.srcdoc = buildPreviewHtml(content, baseHref, baseRoot);
                return;
            }
            previewFrame.srcdoc = buildAssetPreviewDoc(path, ext);
        }

        function handleEditorChange() {
            if (isLoading) return;
            const path = state.active;
            if (!path) return;
            const value = readEditorContent();
            state.files[path].content = value;
            if (!state.dirty[path]) setDirty(path, true);
            updateLintStatus(value);
            if (state.ui && state.ui.preview && (!previewAutoRefresh || previewAutoRefresh.checked)) {
                if (previewTimer) clearTimeout(previewTimer);
                previewTimer = setTimeout(() => updateLivePreview(), 300);
            }
            if (state.settings.autoSave) {
                if (autosaveTimer) clearTimeout(autosaveTimer);
                const interval = Math.max(500, parseInt(state.settings.autoSaveInterval || 1200, 10));
                autosaveTimer = setTimeout(() => saveActiveFile(), interval);
            }
        }

        function isFormattingEnabled(path) {
            const ext = fileExtension(path);
            const map = state.settings.formatLanguages || {};
            if (ext === 'html') return map.html !== false;
            if (ext === 'css') return map.css !== false;
            if (ext === 'js') return map.js !== false;
            if (ext === 'ts') return map.ts !== false;
            if (ext === 'tsx') return map.tsx !== false;
            if (ext === 'json') return map.json !== false;
            if (ext === 'md') return map.md !== false;
            if (ext === 'scss') return map.scss !== false;
            if (ext === 'less') return map.less !== false;
            if (ext === 'xml') return map.xml !== false;
            if (ext === 'yaml' || ext === 'yml') return (ext === 'yml' ? map.yml : map.yaml) !== false;
            if (ext === 'svg') return map.svg !== false;
            if (ext === 'php') return map.php !== false;
            if (ext === 'py') return map.py !== false;
            if (ext === 'go') return map.go !== false;
            if (ext === 'rs') return map.rs !== false;
            if (ext === 'java') return map.java !== false;
            if (ext === 'kt') return map.kt !== false;
            if (ext === 'cs') return map.cs !== false;
            if (ext === 'rb') return map.rb !== false;
            if (ext === 'sql') return map.sql !== false;
            if (ext === 'sh') return map.sh !== false;
            if (ext === 'toml') return map.toml !== false;
            return true;
        }

        function normalizeContent(path, content) {
            let output = content;
            if (state.settings.trimTrailing) {
                output = output.split('\n').map(line => line.replace(/[ \t]+$/g, '')).join('\n');
            }
            if ((state.settings.formatOnSave && isFormattingEnabled(path)) || isExtensionActive('formatter-pro') || activeType('formatter')) {
                output = formatContent(path, output);
            }
            return output;
        }

        function saveActiveFile() {
            const path = state.active;
            if (!path) return;
            const file = getFile(path);
            if (file && file.readOnly) {
                showToast('Read-only file', 'fa-triangle-exclamation');
                return;
            }
            let content = readEditorContent();
            const normalized = normalizeContent(path, content);
            if (normalized !== content) {
                content = normalized;
                updateEditorContent(content);
            }
            state.files[path].content = content;
            saveFileToServer(path, state.files[path].content)
                .then(() => {
                    const history = state.history || {};
                    const entries = Array.isArray(history[path]) ? history[path] : [];
                    entries.unshift({ ts: new Date().toISOString(), content });
                    history[path] = entries.slice(0, 20);
                    state.history = history;
                    setDirty(path, false);
                    saveState();
                    showToast('File saved', 'fa-circle-check');
                    if (state.ui && state.ui.preview && (!previewAutoRefresh || previewAutoRefresh.checked)) {
                        updateLivePreview(true);
                    }
                })
                .catch(() => showToast('Save failed', 'fa-triangle-exclamation'));
        }

        function saveFileToServer(path, content) {
            return fetch(`/ProjectHub/CustomCode?handler=SaveFile`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: toForm({ projectId, path, content })
            }).then(r => {
                if (!r.ok) throw new Error('Save failed');
                return r.json();
            });
        }

        function uploadExtensionFile(file, name, type) {
            const form = new FormData();
            form.append('projectId', projectId);
            form.append('name', name);
            form.append('type', type);
            form.append('package', file);
            form.append('__RequestVerificationToken', csrfToken);
            return fetch(`/ProjectHub/CustomCode?handler=UploadExtension`, {
                method: 'POST',
                body: form
            }).then(r => {
                if (!r.ok) throw new Error('Upload failed');
                return r.json();
            }).then(data => {
                if (!data || !data.extension) throw new Error('Invalid response');
                const ext = data.extension;
                return {
                    id: ext.id || ext.Id,
                    name: ext.name || ext.Name,
                    type: (ext.type || ext.Type || 'utility').toLowerCase(),
                    fileName: ext.fileName || ext.FileName
                };
            });
        }

        function isExtensionActive(id) {
            return !!state.activeExtensions[id];
        }

        function activeType(type) {
            const custom = state.customExtensions || [];
            return custom.some(ext => ext.type === type && isExtensionActive(ext.id));
        }

        function applyExtensionEffects() {
            const layout = document.getElementById('ideLayout');
            if (!layout) return;
            const themeOn = isExtensionActive('theme-night') || activeType('theme');
            layout.classList.toggle('ext-theme-night', themeOn);
        }

        function formatContent(path, content) {
            const ext = fileExtension(path);
            if (![
                'html', 'css', 'js', 'json', 'md', 'ts', 'tsx', 'scss', 'less', 'xml', 'yaml', 'yml', 'svg',
                'php', 'py', 'go', 'rs', 'java', 'kt', 'cs', 'rb', 'sql', 'sh', 'toml'
            ].includes(ext)) return content;
            const lines = content.replace(/\t/g, '  ').split('\n').map(line => line.replace(/[ \t]+$/g, ''));
            let formatted = lines.join('\n');
            if (!formatted.endsWith('\n')) formatted += '\n';
            return formatted;
        }

        function updateLintStatus(content) {
            if (!problemList) return;
            if (!isExtensionActive('lint-pack') && !activeType('lint')) {
                problemList.textContent = 'No issues detected.';
                return;
            }
            const issues = [];
            if (content.includes('console.log')) issues.push('Avoid console.log in production.');
            if (content.includes('TODO')) issues.push('TODO found in code.');
            if (!issues.length) {
                problemList.textContent = 'No issues detected.';
                return;
            }
            const severity = state.settings.lintSeverity || 'medium';
            let visible = issues;
            if (severity === 'low') visible = issues.slice(0, 1);
            if (severity === 'high') visible = issues;
            const label = severity === 'low' ? 'Warnings' : severity === 'high' ? 'Critical' : 'Issues';
            problemList.innerHTML = `<strong>${label}</strong><br>` + visible.map(i => ` ${i}`).join('<br>');
        }

        function createFolder(path) {
            return fetch(`/ProjectHub/CustomCode?handler=CreateFolder`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: toForm({ projectId, path })
            }).then(r => {
                if (!r.ok) throw new Error('Create folder failed');
                return r.json();
            }).then(() => {
                const placeholder = `${path}/.keep`;
                if (!state.files[placeholder]) {
                    state.files[placeholder] = { language: 'plaintext', content: '', readOnly: true };
                }
                showToast('Folder created', 'fa-circle-check');
            }).catch(() => showToast('Folder create failed', 'fa-triangle-exclamation'));
        }

        function renderGitChanges() {
            if (!gitChanges) return;
            if (state.ui && state.ui.gitView === 'staged') {
                gitChanges.textContent = 'No staged changes.';
                return;
            }
            const dirtyFiles = Object.keys(state.dirty).filter(k => state.dirty[k]);
            if (!dirtyFiles.length) {
                gitChanges.textContent = 'No changes.';
                return;
            }
            gitChanges.innerHTML = dirtyFiles.map(f => ` ${f}`).join('<br>');
        }

        function applySearch(term) {
            if (!term) {
                searchResults.innerHTML = '<div>Type to search your files.</div>';
                return;
            }
            const searchLower = term.toLowerCase();
            const matches = Object.entries(state.files)
                .filter(([path, file]) => file.content.toLowerCase().includes(searchLower))
                .slice(0, 50);
            if (!matches.length) {
                searchResults.innerHTML = '<div>No matches found.</div>';
                return;
            }
            searchResults.innerHTML = matches.map(([path, file]) => {
                const idx = file.content.toLowerCase().indexOf(searchLower);
                const snippet = idx >= 0
                    ? file.content.slice(Math.max(0, idx - 18), idx + searchLower.length + 18).replace(/\s+/g, ' ')
                    : '';
                return `<div class="search-hit" data-open="${path}">
                    <strong>${path}</strong>
                    <span>${snippet}</span>
                </div>`;
            }).join('');
            searchResults.querySelectorAll('[data-open]').forEach(el => {
                el.addEventListener('click', () => ensureOpen(el.getAttribute('data-open')));
            });
        }

        function renderExtensions() {
            if (!extensionsList) return;
            const coreExtensions = [
                { id: 'lint-pack', name: 'Lint Pack', desc: 'Real-time linting for JS/CSS/HTML.' },
                { id: 'theme-night', name: 'Night Theme', desc: 'Ultra dark theme presets.' },
                { id: 'formatter-pro', name: 'Formatter Pro', desc: 'Opinionated formatting for project files.' }
            ];
            extensionsList.innerHTML = '';
            const custom = Array.isArray(state.customExtensions) ? state.customExtensions : [];
            if (!custom.length) {
                const empty = document.createElement('div');
                empty.style.color = '#9ca3af';
                empty.style.fontSize = '0.8rem';
                empty.style.marginBottom = '10px';
                empty.textContent = 'No custom extensions installed yet.';
                extensionsList.appendChild(empty);
            }
            custom.forEach(ext => {
                const active = !!state.activeExtensions[ext.id];
                const card = document.createElement('div');
                card.className = 'ext-card';
                const meta = document.createElement('div');
                meta.className = 'ext-meta';
                const title = document.createElement('div');
                title.className = 'ext-title';
                const badge = document.createElement('span');
                badge.className = 'ext-badge';
                if (active) {
                    badge.textContent = 'Active';
                } else {
                    badge.textContent = 'Installed';
                }
                title.textContent = ext.name || 'Extension';
                title.appendChild(badge);
                const desc = document.createElement('div');
                desc.className = 'ext-desc';
                let typeLabel = 'Custom Extension';
                if (ext.type) {
                    typeLabel = String(ext.type).toUpperCase() + ' Extension';
                }
                desc.textContent = typeLabel + '  ' + (ext.fileName || 'Package');
                meta.appendChild(title);
                meta.appendChild(desc);
                const actionBtn = document.createElement('button');
                let actionClass = 'install';
                let actionLabel = 'Activate';
                if (active) {
                    actionClass = 'installed';
                    actionLabel = 'Deactivate';
                }
                actionBtn.className = 'ext-btn ' + actionClass;
                actionBtn.setAttribute('data-ext', ext.id);
                actionBtn.textContent = actionLabel;
                actionBtn.addEventListener('click', () => toggleExtension(ext.id, ext.type, ext.name));
                card.appendChild(meta);
                card.appendChild(actionBtn);
                extensionsList.appendChild(card);
            });
            coreExtensions.forEach(ext => {
                const installed = !!state.extensions[ext.id];
                const active = !!state.activeExtensions[ext.id];
                const card = document.createElement('div');
                card.className = 'ext-card';
                const meta = document.createElement('div');
                meta.className = 'ext-meta';
                const title = document.createElement('div');
                title.className = 'ext-title';
                const badge = document.createElement('span');
                badge.className = 'ext-badge';
                if (!installed) {
                    badge.textContent = 'Available';
                } else if (active) {
                    badge.textContent = 'Active';
                } else {
                    badge.textContent = 'Installed';
                }
                title.textContent = ext.name || 'Extension';
                title.appendChild(badge);
                const desc = document.createElement('div');
                desc.className = 'ext-desc';
                desc.textContent = ext.desc || '';
                meta.appendChild(title);
                meta.appendChild(desc);
                const actionBtn = document.createElement('button');
                let actionClass = 'install';
                let actionLabel = 'Install';
                if (installed && active) {
                    actionClass = 'installed';
                    actionLabel = 'Active';
                } else if (installed) {
                    actionClass = 'install';
                    actionLabel = 'Activate';
                }
                actionBtn.className = 'ext-btn ' + actionClass;
                actionBtn.setAttribute('data-ext', ext.id);
                actionBtn.textContent = actionLabel;
                actionBtn.addEventListener('click', () => {
                    if (!installed) {
                        installCoreExtension(ext.id, ext.name);
                        return;
                    }
                    toggleExtension(ext.id, ext.type, ext.name);
                });
                card.appendChild(meta);
                card.appendChild(actionBtn);
                extensionsList.appendChild(card);
            });
        }

        function openExtensionModal() {
            const modal = document.getElementById('extModal');
            const status = document.getElementById('extStatus');
            const progress = document.getElementById('extProgress');
            const start = document.getElementById('extStart');
            const cancel = document.getElementById('extCancel');
            const nameInput = document.getElementById('extName');
            const typeInput = document.getElementById('extType');
            const fileInput = document.getElementById('extFile');
            modal.classList.add('show');
            let running = false;

            const reset = () => {
                progress.style.width = '0%';
                status.textContent = 'Ready to install.';
                running = false;
                start.disabled = false;
                start.textContent = 'Upload & Install';
                if (nameInput) nameInput.value = '';
                if (fileInput) fileInput.value = '';
                if (typeInput) typeInput.value = 'utility';
            };

            cancel.onclick = () => { modal.classList.remove('show'); reset(); };
            document.getElementById('closeExtModal').onclick = cancel.onclick;

            start.onclick = async () => {
                if (running) return;
                const file = (fileInput && fileInput.files && fileInput.files.length) ? fileInput.files[0] : null;
                const extName = ((nameInput && nameInput.value) ? nameInput.value : '').trim() || (file ? file.name.replace(/\.[^/.]+$/, '') : '');
                const extType = ((typeInput && typeInput.value) ? typeInput.value : 'utility').trim().toLowerCase();
                if (!file) {
                    showToast('Select an extension package', 'fa-triangle-exclamation');
                    return;
                }
                if (!extName) {
                    showToast('Enter an extension name', 'fa-triangle-exclamation');
                    return;
                }
                if (file.size > 20 * 1024 * 1024) {
                    showToast('File too large (20MB max)', 'fa-triangle-exclamation');
                    return;
                }
                running = true;
                start.disabled = true;
                start.textContent = 'Uploading...';
                const steps = [
                    { pct: 35, msg: 'Uploading package...' },
                    { pct: 60, msg: 'Verifying checksum...' },
                    { pct: 85, msg: 'Installing extension...' },
                    { pct: 100, msg: 'Activating extension...' }
                ];
                let idx = 0;
                const tick = () => {
                    const step = steps[idx];
                    if (!step) return;
                    progress.style.width = `${step.pct}%`;
                    status.textContent = step.msg;
                    idx += 1;
                };
                tick();
                setTimeout(tick, 400);
                try {
                    const result = await uploadExtensionFile(file, extName, extType);
                    setTimeout(() => {
                        tick();
                        setTimeout(() => {
                            tick();
                            state.customExtensions.push(result);
                            state.activeExtensions[result.id] = true;
                            saveState();
                            applyExtensionEffects();
                            if (state.active && state.files[state.active]) {
                                updateLintStatus(state.files[state.active].content || '');
                            }
                            renderExtensions();
                            extensionsLog.textContent = `${result.name} installed and activated.`;
                            modal.classList.remove('show');
                            showToast(`${result.name} installed`, 'fa-circle-check');
                            reset();
                        }, 400);
                    }, 400);
                } catch {
                    showToast('Extension install failed', 'fa-triangle-exclamation');
                    status.textContent = 'Install failed.';
                    running = false;
                    start.disabled = false;
                    start.textContent = 'Upload & Install';
                }
            };

            reset();
        }

        function installCoreExtension(id, name) {
            state.extensions[id] = true;
            state.activeExtensions[id] = true;
            saveState();
            applyExtensionEffects();
            if (state.active && state.files[state.active]) {
                updateLintStatus(state.files[state.active].content || '');
            }
            renderExtensions();
            extensionsLog.textContent = `${name} installed and activated.`;
            showToast(`${name} installed`, 'fa-circle-check');
        }

        function toggleExtension(id, type, name) {
            const isActive = !!state.activeExtensions[id];
            if (isActive) {
                state.activeExtensions[id] = false;
                extensionsLog.textContent = `${name || id} deactivated.`;
            } else {
                state.activeExtensions[id] = true;
                extensionsLog.textContent = `${name || id} activated.`;
            }
            saveState();
            applyExtensionEffects();
            if (state.active && state.files[state.active]) {
                updateLintStatus(state.files[state.active].content || '');
            }
            renderExtensions();
        }

        function initEditor() {
            const fallback = document.getElementById('fallback-editor');
            if (!window.require) {
                fallback.style.display = 'block';
                fallback.addEventListener('input', handleEditorChange);
                fallback.addEventListener('keyup', () => updateFallbackCursor(fallback));
                fallback.addEventListener('click', () => updateFallbackCursor(fallback));
                return;
            }
            window.require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' } });
            window.require(['vs/editor/editor.main'], () => {
                editor = monaco.editor.create(document.getElementById('monaco-root'), {
                    value: '',
                    language: 'html',
                    theme: 'vs-dark',
                    fontFamily: 'JetBrains Mono',
                    fontSize: state.settings.fontSize || 14,
                    minimap: { enabled: !!state.settings.minimap },
                    automaticLayout: true,
                    tabSize: 2
                });
                editorReady = true;
                editor.onDidChangeModelContent(handleEditorChange);
                editor.onDidChangeCursorPosition((e) => {
                    updateStatusPos(e.position.lineNumber, e.position.column);
                });
                loadActiveFile();
            }, () => {
                fallback.style.display = 'block';
                fallback.addEventListener('input', handleEditorChange);
                fallback.addEventListener('keyup', () => updateFallbackCursor(fallback));
                fallback.addEventListener('click', () => updateFallbackCursor(fallback));
            });
        }

        function loadActiveLanguage() {
            if (!editorReady || !editor) return;
            const path = state.active;
            const file = state.files[path];
            const lang = file ? file.language : fileLanguage(path);
            const model = editor.getModel();
            if (model) monaco.editor.setModelLanguage(model, lang);
        }

        function syncPanelToggle() {
            if (!panelToggle || !bottomPanel) return;
            const collapsed = bottomPanel.classList.contains('collapsed');
            panelToggle.classList.toggle('panel-toggle-collapsed', collapsed);
            panelToggle.setAttribute('data-tooltip', collapsed ? 'Expand Panel' : 'Collapse Panel');
        }

        function wirePanels() {
            document.querySelectorAll('.p-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.p-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const panel = tab.getAttribute('data-panel');
                    document.querySelectorAll('.panel-content').forEach(p => {
                        p.classList.toggle('active', p.getAttribute('data-panel') === panel);
                    });
                });
            });
            if (panelToggle) {
                panelToggle.addEventListener('click', () => {
                    if (!bottomPanel) return;
                    const collapsed = bottomPanel.classList.contains('collapsed');
                    if (collapsed) {
                        setPanelCollapsed(false);
                    } else {
                        setPanelCollapsed(true);
                    }
                });
            }
            syncPanelToggle();
        }

        function wireTerminal() {
            const output = document.getElementById('terminalOutput');
            const input = document.querySelector('.cmd-in');
            if (!output || !input) return;
            const history = [];
            let historyIndex = -1;

            const appendLine = (html, color) => {
                const line = document.createElement('div');
                if (color) line.style.color = color;
                line.innerHTML = html;
                output.appendChild(line);
                output.scrollTop = output.scrollHeight;
            };

            input.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowUp') {
                    if (!history.length) return;
                    historyIndex = Math.max(0, historyIndex - 1);
                    input.value = history[historyIndex] || '';
                    return;
                }
                if (e.key === 'ArrowDown') {
                    if (!history.length) return;
                    historyIndex = Math.min(history.length, historyIndex + 1);
                    input.value = historyIndex >= history.length ? '' : (history[historyIndex] || '');
                    return;
                }
                if (e.key !== 'Enter') return;
                e.preventDefault();
                const command = input.value.trim();
                if (!command) return;
                history.push(command);
                historyIndex = history.length;
                appendLine(`<span class="prompt">bugence&gt;</span> ${command}`);
                input.value = '';

                const [cmd, ...rest] = command.split(' ');
                const arg = rest.join(' ').trim();
                if (cmd === 'help') {
                    appendLine('Commands: <strong>help</strong>, <strong>ls</strong>, <strong>open &lt;file&gt;</strong>, <strong>cat &lt;file&gt;</strong>, <strong>preview</strong>, <strong>save</strong>, <strong>clear</strong>');
                    return;
                }
                if (cmd === 'clear') {
                    output.innerHTML = '';
                    return;
                }
                if (cmd === 'ls') {
                    const files = Object.keys(state.files).slice(0, 80);
                    appendLine(files.length ? files.join('<br>') : 'No files.');
                    return;
                }
                if (cmd === 'open') {
                    if (!arg) {
                        appendLine('Usage: open &lt;file&gt;', '#fca5a5');
                        return;
                    }
                    if (!state.files[arg]) {
                        appendLine('File not found.', '#fca5a5');
                        return;
                    }
                    ensureOpen(arg);
                    appendLine(`Opened ${arg}`, '#34d399');
                    return;
                }
                if (cmd === 'cat') {
                    if (!arg || !state.files[arg]) {
                        appendLine('File not found.', '#fca5a5');
                        return;
                    }
                    const snippet = (state.files[arg].content || '').split('\n').slice(0, 40).join('<br>');
                    appendLine(snippet || '(empty)');
                    return;
                }
                if (cmd === 'preview') {
                    state.ui.preview = true;
                    updatePreviewVisibility();
                    updateLivePreview(true);
                    appendLine('Live preview enabled.', '#34d399');
                    return;
                }
                if (cmd === 'save') {
                    saveActiveFile();
                    appendLine('Save requested.', '#34d399');
                    return;
                }
                appendLine('Unknown command. Type <strong>help</strong>.', '#fca5a5');
            });

            if (terminalClear) {
                terminalClear.addEventListener('click', () => {
                    output.innerHTML = '';
                });
            }
            if (terminalCopy) {
                terminalCopy.addEventListener('click', () => {
                    const text = output.innerText || '';
                    navigator.clipboard.writeText(text).then(() => {
                        showToast('Terminal copied', 'fa-circle-check');
                    }).catch(() => {
                        showToast('Copy failed', 'fa-triangle-exclamation');
                    });
                });
            }
        }

        function wireActivity() {
            document.querySelectorAll('.act-item[data-view]').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.act-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    const view = item.getAttribute('data-view');
                    if (state.ui && state.ui.sidebarCollapsed) {
                        setSidebarCollapsed(false);
                    }
                    document.querySelectorAll('.sidebar-view').forEach(v => v.classList.toggle('active', v.getAttribute('data-view') === view));
                    if (view === 'extensions') showExtensionsGuide();
                });
            });
        }

        function wireShortcuts() {
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
                    e.preventDefault();
                    saveActiveFile();
                }
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'p' && !e.shiftKey) {
                    e.preventDefault();
                    openQuickOpen();
                }
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'p') {
                    e.preventDefault();
                    openCommandPalette();
                }
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'f') {
                    e.preventDefault();
                    openWorkspaceSearch();
                }
            });
        }

        function wireActions() {
            const saveBtn = document.getElementById('saveBtn');
            const quickOpenBtn = document.getElementById('openQuickOpen');
            const commandBtn = document.getElementById('openCommand');
            if (saveBtn) saveBtn.addEventListener('click', saveActiveFile);
            if (quickOpenBtn) quickOpenBtn.addEventListener('click', openQuickOpen);
            if (commandBtn) commandBtn.addEventListener('click', openCommandPalette);
            if (runSearchBtn) runSearchBtn.addEventListener('click', runWorkspaceSearch);
            if (replaceAllBtn) replaceAllBtn.addEventListener('click', replaceAllWorkspace);
            if (closeSearch) closeSearch.addEventListener('click', closeWorkspaceSearch);
            if (searchQueryInput) searchQueryInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') runWorkspaceSearch();
                if (e.key === 'Escape') closeWorkspaceSearch();
            });
            if (replaceQueryInput) replaceQueryInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeWorkspaceSearch();
            });
            if (quickOpenInput) quickOpenInput.addEventListener('input', () => renderQuickOpenList(quickOpenInput.value));
            if (quickOpenInput) quickOpenInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeQuickOpen();
                }
                if (e.key === 'Enter') {
                    const first = quickOpenList ? quickOpenList.querySelector('[data-open]') : null;
                    if (first) {
                        ensureOpen(first.getAttribute('data-open'));
                        closeQuickOpen();
                    }
                }
            });
            if (commandInput) commandInput.addEventListener('input', () => renderCommandList(commandInput.value));
            if (commandInput) commandInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeCommandPalette();
                }
                if (e.key === 'Enter') {
                    const first = commandList ? commandList.querySelector('[data-command]') : null;
                    const cmdId = first ? first.getAttribute('data-command') : null;
                    if (cmdId) {
                        const handlers = {
                            save: saveActiveFile,
                            togglePreview: () => { if (togglePreviewBtn) togglePreviewBtn.click(); },
                            refreshPreview: () => updateLivePreview(true),
                            openQuick: openQuickOpen,
                            workspaceSearch: openWorkspaceSearch,
                            gotoSymbol: openSymbolPalette,
                            toggleMinimap,
                            newFile: () => openFileModal('file'),
                            newFolder: () => openFileModal('folder'),
                            diff: openDiffModal,
                            format: () => saveActiveFile()
                        };
                        if (handlers[cmdId]) handlers[cmdId]();
                        closeCommandPalette();
                    }
                }
            });
            if (togglePreviewBtn) togglePreviewBtn.addEventListener('click', () => {
                state.ui.preview = !state.ui.preview;
                updatePreviewVisibility();
                saveState();
                if (state.ui.preview) updateLivePreview(true);
            });
            if (refreshPreviewBtn) refreshPreviewBtn.addEventListener('click', () => updateLivePreview(true));
            if (openPreviewTabBtn) openPreviewTabBtn.addEventListener('click', () => {
                const path = state.active;
                if (!path) {
                    showToast('Open a file to preview', 'fa-triangle-exclamation');
                    return;
                }
                const url = `/Uploads/${encodeURIComponent(projectRootName)}/${path}`;
                window.open(url, '_blank', 'noopener');
            });
            const newFileBtn = document.getElementById('newFile');
            if (newFileBtn) newFileBtn.addEventListener('click', () => {
                openFileModal('file');
            });
            const newFolderBtn = document.getElementById('newFolder');
            if (newFolderBtn) newFolderBtn.addEventListener('click', () => {
                openFileModal('folder');
            });
            const commitBtn = document.getElementById('commitBtn');
            if (commitBtn) commitBtn.addEventListener('click', () => {
                if (!Object.values(state.dirty).some(Boolean)) {
                    showToast('No changes to commit', 'fa-circle-info');
                    return;
                }
                Object.keys(state.dirty).forEach(k => state.dirty[k] = false);
                statusState.textContent = 'Saved';
                renderTabs();
                renderGitChanges();
                saveState();
                showToast('Committed changes', 'fa-circle-check');
            });
            const settingsBtn = document.getElementById('openSettings');
            if (settingsBtn) settingsBtn.addEventListener('click', () => {
                openSettingsModal();
            });
            if (quickOpenModal) quickOpenModal.addEventListener('click', (e) => {
                if (e.target === quickOpenModal) closeQuickOpen();
            });
            if (commandModal) commandModal.addEventListener('click', (e) => {
                if (e.target === commandModal) closeCommandPalette();
            });
            if (closeDiff) closeDiff.addEventListener('click', closeDiffModal);
            if (searchModal) searchModal.addEventListener('click', (e) => {
                if (e.target === searchModal) closeWorkspaceSearch();
            });
            if (fileFilterInput) {
                fileFilterInput.value = state.ui && state.ui.fileQuery ? state.ui.fileQuery : '';
                fileFilterInput.addEventListener('input', () => {
                    state.ui.fileQuery = fileFilterInput.value;
                    renderFileTree();
                    saveState();
                });
            }
            if (fileFilterChips) {
                fileFilterChips.querySelectorAll('[data-filter]').forEach(chip => {
                    chip.classList.toggle('active', chip.getAttribute('data-filter') === (state.ui ? state.ui.fileFilter : 'all'));
                    chip.addEventListener('click', () => {
                        const filter = chip.getAttribute('data-filter') || 'all';
                        state.ui.fileFilter = filter;
                        fileFilterChips.querySelectorAll('[data-filter]').forEach(c => c.classList.remove('active'));
                        chip.classList.add('active');
                        renderFileTree();
                        saveState();
                    });
                });
            }
            if (previewDevice) {
                previewDevice.value = state.ui && state.ui.previewDevice ? state.ui.previewDevice : 'desktop';
                previewDevice.addEventListener('change', () => {
                    state.ui.previewDevice = previewDevice.value;
                    applyPreviewLayout();
                    saveState();
                });
            }
            if (previewZoom) {
                previewZoom.value = state.ui && state.ui.previewZoom ? state.ui.previewZoom : 100;
                previewZoom.addEventListener('input', () => {
                    state.ui.previewZoom = parseInt(previewZoom.value, 10);
                    applyPreviewLayout();
                    saveState();
                });
            }
            if (previewAutoRefresh) {
                previewAutoRefresh.checked = !state.ui || state.ui.previewAutoRefresh !== false;
                previewAutoRefresh.addEventListener('change', () => {
                    state.ui.previewAutoRefresh = previewAutoRefresh.checked;
                    saveState();
                });
            }
            if (refreshGitBtn) {
                refreshGitBtn.addEventListener('click', () => {
                    renderGitChanges();
                    showToast('Source control refreshed', 'fa-circle-info');
                });
            }
            if (toggleStagedBtn) {
                toggleStagedBtn.addEventListener('click', () => {
                    state.ui.gitView = state.ui.gitView === 'staged' ? 'changes' : 'staged';
                    toggleStagedBtn.classList.toggle('active', state.ui.gitView === 'staged');
                    renderGitChanges();
                    showToast(state.ui.gitView === 'staged' ? 'Showing staged' : 'Showing changes', 'fa-circle-info');
                    saveState();
                });
            }
        }

        function openFileModal(mode) {
            const modal = document.getElementById('fileModal');
            const title = document.getElementById('fileModalTitle');
            const hint = document.getElementById('fileModalHint');
            const input = document.getElementById('fileModalInput');
            modal.dataset.mode = mode;
            if (title) {
                title.innerHTML = mode === 'folder'
                    ? '<i class="fa-solid fa-folder-plus"></i> NEW FOLDER'
                    : '<i class="fa-solid fa-file-circle-plus"></i> NEW FILE';
            }
            if (hint) {
                hint.textContent = mode === 'folder'
                    ? 'Create a new folder in your workspace.'
                    : 'Create a new file in your workspace.';
            }
            if (input) {
                input.value = '';
                input.placeholder = mode === 'folder' ? 'e.g. assets' : 'e.g. scripts/new.js';
                setTimeout(() => input.focus(), 50);
            }
            if (modal) modal.classList.add('show');
        }

        function wireTabMenu() {
            if (!tabMenu) return;
            const closeMenu = () => {
                tabMenu.classList.remove('show');
                tabMenuTarget = null;
            };
            tabMenu.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button || !tabMenuTarget) return;
                const action = button.getAttribute('data-action');
                if (action === 'close') {
                    closeTab(tabMenuTarget);
                } else if (action === 'closeOthers') {
                    state.open = state.open.filter(p => p === tabMenuTarget);
                    state.active = tabMenuTarget;
                    renderTabs();
                    loadActiveFile();
                } else if (action === 'closeAll') {
                    state.open = [];
                    state.active = '';
                    renderTabs();
                    clearEditorView();
                } else if (action === 'pin') {
                    state.pins = Array.isArray(state.pins) ? state.pins : [];
                    if (state.pins.includes(tabMenuTarget)) {
                        state.pins = state.pins.filter(p => p !== tabMenuTarget);
                    } else {
                        state.pins.push(tabMenuTarget);
                    }
                    renderTabs();
                }
                saveState();
                closeMenu();
            });
            document.addEventListener('click', (e) => {
                if (!tabMenu.classList.contains('show')) return;
                if (!tabMenu.contains(e.target)) closeMenu();
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeMenu();
            });
        }

        function wirePanelDrag() {
            if (!panelDrag) return;
            if (!bottomPanel) return;
            let startY = 0;
            let startHeight = 0;
            const onMove = (e) => {
                const delta = startY - e.clientY;
                const next = startHeight + delta;
                applyPanelHeight(next);
                saveState();
            };
            const onUp = () => {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
            };
            panelDrag.addEventListener('mousedown', (e) => {
                setPanelCollapsed(false);
                startY = e.clientY;
                startHeight = bottomPanel.getBoundingClientRect().height;
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            });
        }

        function wireSidebarResize() {
            if (!sidebarResizer || !ideLayout) return;
            let startX = 0;
            let startWidth = 0;
            const onMove = (e) => {
                const next = startWidth + (e.clientX - startX);
                applySidebarWidth(next);
            };
            const onUp = () => {
                ideLayout.classList.remove('resizing');
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
                saveState();
            };
            sidebarResizer.addEventListener('mousedown', (e) => {
                if (state.ui && state.ui.sidebarCollapsed) {
                    setSidebarCollapsed(false);
                }
                const current = getComputedStyle(ideLayout).getPropertyValue('--sidebar-width');
                startWidth = parseInt(current, 10) || (state.ui ? state.ui.sidebarWidth : 280);
                startX = e.clientX;
                ideLayout.classList.add('resizing');
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            });
        }

        function wireSidebarToggle() {
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => setSidebarCollapsed(true));
            }
            if (sidebarCollapsedBar) {
                sidebarCollapsedBar.addEventListener('click', () => setSidebarCollapsed(false));
            }
            document.addEventListener('click', (event) => {
                if (!isMobileIdeViewport() || !ideLayout?.classList.contains('ide-mobile-sidebar-open')) return;
                const inSidebar = !!event.target?.closest?.('#sidebar');
                const inActivity = !!event.target?.closest?.('#activityBar');
                if (!inSidebar && !inActivity) {
                    setSidebarCollapsed(true);
                }
            });
            document.addEventListener('keydown', (event) => {
                if (event.key !== 'Escape') return;
                if (!isMobileIdeViewport()) return;
                if (ideLayout?.classList.contains('ide-mobile-sidebar-open')) {
                    setSidebarCollapsed(true);
                }
            });
            window.addEventListener('resize', () => {
                if (!isMobileIdeViewport()) {
                    ideLayout?.classList.remove('ide-mobile-sidebar-open');
                }
            });
        }

        function wireEditorSplitResize() {
            if (!editorResizer || !editorSplit || !editorPane || !previewPane) return;
            let startX = 0;
            let startRatio = 0.5;
            const onMove = (e) => {
                const bounds = editorSplit.getBoundingClientRect();
                const offset = e.clientX - bounds.left;
                const ratio = offset / bounds.width;
                applyEditorSplit(ratio);
            };
            const onUp = () => {
                editorSplit.classList.remove('resizing');
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
                saveState();
            };
            editorResizer.addEventListener('mousedown', (e) => {
                if (!(state.ui && state.ui.preview)) return;
                const bounds = editorSplit.getBoundingClientRect();
                startX = e.clientX;
                startRatio = (editorPane.getBoundingClientRect().width / bounds.width) || 0.5;
                applyEditorSplit(startRatio);
                editorSplit.classList.add('resizing');
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            });
        }

        function closeFileModal() {
            const fileModal = document.getElementById('fileModal');
            if (fileModal) fileModal.classList.remove('show');
        }

        function openQuickOpen() {
            if (!quickOpenModal || !quickOpenInput || !quickOpenList) return;
            quickOpenInput.value = '';
            renderQuickOpenList('');
            quickOpenModal.classList.add('show');
            setTimeout(() => quickOpenInput.focus(), 50);
        }

        function closeQuickOpen() {
            if (quickOpenModal) quickOpenModal.classList.remove('show');
        }

        function renderQuickOpenList(term) {
            if (!quickOpenList) return;
            const lower = term.toLowerCase();
            const entries = Object.keys(state.files)
                .filter(path => path.toLowerCase().includes(lower))
                .slice(0, 60);
            if (!entries.length) {
                quickOpenList.innerHTML = '<div style="color:#9ca3af; font-size:0.8rem;">No matching files.</div>';
                return;
            }
            quickOpenList.innerHTML = entries.map((path, idx) => `
                <div class="command-item ${idx === 0 ? 'active' : ''}" data-open="${path}">
                    <span>${path}</span>
                    <small>${fileLanguage(path)}</small>
                </div>`).join('');
            quickOpenList.querySelectorAll('[data-open]').forEach(item => {
                item.addEventListener('click', () => {
                    ensureOpen(item.getAttribute('data-open'));
                    closeQuickOpen();
                });
            });
        }

        function openWorkspaceSearch() {
            if (!searchModal || !searchQueryInput || !workspaceSearchResults) return;
            workspaceSearchResults.innerHTML = '';
            if (workspaceSearchSummary) {
                workspaceSearchSummary.textContent = 'Enter a query to search the workspace.';
            }
            searchQueryInput.value = '';
            replaceQueryInput.value = '';
            searchModal.classList.add('show');
            setTimeout(() => searchQueryInput.focus(), 50);
        }

        function closeWorkspaceSearch() {
            if (searchModal) searchModal.classList.remove('show');
        }

        function runWorkspaceSearch() {
            if (!workspaceSearchResults || !searchQueryInput) return;
            const query = searchQueryInput.value.trim();
            if (!query) {
                workspaceSearchResults.innerHTML = '';
                if (workspaceSearchSummary) workspaceSearchSummary.textContent = 'Enter a query to search the workspace.';
                return;
            }
            const results = [];
            Object.keys(state.files).forEach(path => {
                const content = getFileContent(path);
                const idx = content.toLowerCase().indexOf(query.toLowerCase());
                if (idx >= 0) {
                    const start = Math.max(0, idx - 40);
                    const end = Math.min(content.length, idx + query.length + 40);
                    const snippet = content.substring(start, end);
                    results.push({ path, snippet });
                }
            });
            if (workspaceSearchSummary) {
                workspaceSearchSummary.textContent = `${results.length} file(s) matched.`;
            }
            workspaceSearchResults.innerHTML = results.length
                ? results.map(item => `
                    <div class="search-item" data-open="${item.path}">
                        <strong>${item.path}</strong>
                        <div class="search-snippet">${item.snippet.replace(/</g, '&lt;')}</div>
                    </div>`).join('')
                : '<div style="color:#9ca3af; font-size:0.85rem;">No matches found.</div>';
            workspaceSearchResults.querySelectorAll('[data-open]').forEach(el => {
                el.addEventListener('click', () => {
                    ensureOpen(el.getAttribute('data-open'));
                    closeWorkspaceSearch();
                });
            });
        }

        function replaceAllWorkspace() {
            const query = searchQueryInput ? searchQueryInput.value.trim() : '';
            const replaceValue = replaceQueryInput ? replaceQueryInput.value : '';
            if (!query) return;
            Object.keys(state.files).forEach(path => {
                const content = getFileContent(path);
                if (content.includes(query)) {
                    state.files[path].content = content.split(query).join(replaceValue);
                    setDirty(path, true);
                }
            });
            saveState();
            runWorkspaceSearch();
        }

        function collectSymbolsForActive() {
            const path = state.active;
            if (!path) return [];
            const content = getFileContent(path);
            const lines = content.split('\n');
            const symbols = [];
            const patterns = [
                { regex: /^\s*(export\s+)?function\s+([A-Za-z0-9_$]+)/, type: 'fn' },
                { regex: /^\s*(export\s+)?class\s+([A-Za-z0-9_$]+)/, type: 'class' },
                { regex: /^\s*(const|let|var)\s+([A-Za-z0-9_$]+)\s*=\s*\(/, type: 'var' }
            ];
            lines.forEach((line, idx) => {
                for (const pattern of patterns) {
                    const match = line.match(pattern.regex);
                    if (match) {
                        symbols.push({ name: match[2], line: idx + 1, type: pattern.type });
                        break;
                    }
                }
            });
            return symbols;
        }

        function openSymbolPalette() {
            if (!quickOpenModal || !quickOpenInput || !quickOpenList) return;
            const symbols = collectSymbolsForActive();
            quickOpenInput.value = '';
            quickOpenList.innerHTML = symbols.length
                ? symbols.map((sym, idx) => `
                    <div class="command-item ${idx === 0 ? 'active' : ''}" data-line="${sym.line}">
                        <span>${sym.name}</span>
                        <small>${sym.type}  line ${sym.line}</small>
                    </div>`).join('')
                : '<div style="color:#9ca3af; font-size:0.8rem;">No symbols found.</div>';
            quickOpenList.querySelectorAll('[data-line]').forEach(item => {
                item.addEventListener('click', () => {
                    const line = parseInt(item.getAttribute('data-line'), 10);
                    if (editor && !Number.isNaN(line)) {
                        editor.revealLineInCenter(line);
                        editor.setPosition({ lineNumber: line, column: 1 });
                        editor.focus();
                    }
                    closeQuickOpen();
                });
            });
            quickOpenModal.classList.add('show');
            setTimeout(() => quickOpenInput.focus(), 50);
        }

        function toggleMinimap() {
            state.settings = state.settings || {};
            state.settings.minimap = !state.settings.minimap;
            applyEditorSettings();
            saveState();
        }

        function openCommandPalette() {
            if (!commandModal || !commandInput || !commandList) return;
            commandInput.value = '';
            renderCommandList('');
            commandModal.classList.add('show');
            setTimeout(() => commandInput.focus(), 50);
        }

        function closeCommandPalette() {
            if (commandModal) commandModal.classList.remove('show');
        }

        function renderCommandList(term) {
            if (!commandList) return;
            const commands = [
                { id: 'save', label: 'Save File', hint: 'Ctrl+S', action: saveActiveFile },
                { id: 'togglePreview', label: 'Toggle Live Preview', hint: 'Show/hide preview', action: () => { if (togglePreviewBtn) togglePreviewBtn.click(); } },
                { id: 'refreshPreview', label: 'Refresh Preview', hint: 'Rebuild iframe', action: () => updateLivePreview(true) },
                { id: 'openQuick', label: 'Quick Open', hint: 'Ctrl+P', action: openQuickOpen },
                { id: 'workspaceSearch', label: 'Workspace Search', hint: 'Ctrl+Shift+F', action: openWorkspaceSearch },
                { id: 'gotoSymbol', label: 'Go to Symbol', hint: 'Search in file', action: openSymbolPalette },
                { id: 'toggleMinimap', label: 'Toggle Minimap', hint: 'Editor setting', action: toggleMinimap },
                { id: 'newFile', label: 'New File', hint: 'Create file', action: () => openFileModal('file') },
                { id: 'newFolder', label: 'New Folder', hint: 'Create folder', action: () => openFileModal('folder') },
                { id: 'diff', label: 'Show Diff (Last Saved)', hint: 'Compare changes', action: openDiffModal },
                { id: 'format', label: 'Format File', hint: 'Normalize whitespace', action: () => saveActiveFile() }
            ];
            const lower = term.toLowerCase();
            const filtered = commands.filter(cmd => cmd.label.toLowerCase().includes(lower));
            if (!filtered.length) {
                commandList.innerHTML = '<div style="color:#9ca3af; font-size:0.8rem;">No commands found.</div>';
                return;
            }
            commandList.innerHTML = filtered.map((cmd, idx) => `
                <div class="command-item ${idx === 0 ? 'active' : ''}" data-command="${cmd.id}">
                    <span>${cmd.label}</span>
                    <small>${cmd.hint}</small>
                </div>`).join('');
            commandList.querySelectorAll('[data-command]').forEach(item => {
                item.addEventListener('click', () => {
                    const cmd = commands.find(c => c.id === item.getAttribute('data-command'));
                    if (cmd && cmd.action) cmd.action();
                    closeCommandPalette();
                });
            });
        }

        let diffEditor = null;
        let diffOriginalModel = null;
        let diffModifiedModel = null;

        function openDiffModal() {
            if (!diffModal || !diffContainer) return;
            const path = state.active;
            if (!path) {
                showToast('Open a file first', 'fa-triangle-exclamation');
                return;
            }
            const history = (state.history && state.history[path]) ? state.history[path] : [];
            if (!history.length) {
                diffContainer.innerHTML = '<div style="padding:16px; color:#9ca3af;">No saved history yet.</div>';
                diffModal.classList.add('show');
                return;
            }
            const last = history[0] ? history[0].content : '';
            const current = getFileContent(path);
            diffContainer.innerHTML = '';
            if (window.monaco) {
                diffEditor = diffEditor || monaco.editor.createDiffEditor(diffContainer, {
                    theme: 'vs-dark',
                    readOnly: true,
                    automaticLayout: true,
                    renderSideBySide: true,
                    minimap: { enabled: false }
                });
                if (diffOriginalModel) diffOriginalModel.dispose();
                if (diffModifiedModel) diffModifiedModel.dispose();
                diffOriginalModel = monaco.editor.createModel(last, fileLanguage(path));
                diffModifiedModel = monaco.editor.createModel(current, fileLanguage(path));
                diffEditor.setModel({ original: diffOriginalModel, modified: diffModifiedModel });
            } else {
                const left = document.createElement('textarea');
                const right = document.createElement('textarea');
                left.value = last;
                right.value = current;
                left.setAttribute('readonly', 'readonly');
                right.setAttribute('readonly', 'readonly');
                left.style.cssText = 'width:50%; height:100%; border:0; background:#0b0b0b; color:#9ca3af; padding:14px; font-family:JetBrains Mono; font-size:12px; resize:none;';
                right.style.cssText = 'width:50%; height:100%; border:0; background:#0f0f10; color:#e5e7eb; padding:14px; font-family:JetBrains Mono; font-size:12px; resize:none;';
                const wrap = document.createElement('div');
                wrap.style.cssText = 'display:flex; width:100%; height:100%;';
                wrap.append(left, right);
                diffContainer.appendChild(wrap);
            }
            diffModal.classList.add('show');
        }

        function closeDiffModal() {
            if (diffModal) diffModal.classList.remove('show');
        }

        function confirmFileModal() {
            const modal = document.getElementById('fileModal');
            const input = document.getElementById('fileModalInput');
            if (!modal || !input) return;
            const mode = modal.dataset.mode || 'file';
            const name = input.value.trim();
            if (!name) {
                showToast('Enter a valid name', 'fa-triangle-exclamation');
                return;
            }
            if (mode === 'file') {
                if (state.files[name]) {
                    showToast('File already exists', 'fa-triangle-exclamation');
                    return;
                }
                state.files[name] = { language: fileLanguage(name), content: '' };
                ensureOpen(name);
                renderFileTree();
                saveState();
                saveFileToServer(name, '')
                    .then(() => showToast('File created', 'fa-circle-check'))
                    .catch(() => showToast('File create failed', 'fa-triangle-exclamation'));
            } else {
                createFolder(name).then(() => {
                    renderFileTree();
                    saveState();
                });
            }
            closeFileModal();
        }

        function showExtensionsGuide() {
            const guide = document.getElementById('extensionsGuide');
            if (!guide) return;
            guide.classList.add('show');
        }

        function openSettingsModal() {
            const modal = document.getElementById('settingsModal');
            const fontInput = document.getElementById('editorFontSize');
            const minimapInput = document.getElementById('editorMinimap');
            const settings = state.settings || {};
            if (fontInput) fontInput.value = settings.fontSize || 14;
            if (minimapInput) minimapInput.checked = !!settings.minimap;
            const fontFamily = document.getElementById('editorFontFamily');
            if (fontFamily) fontFamily.value = settings.fontFamily || 'JetBrains Mono';
            const lineHeight = document.getElementById('editorLineHeight');
            if (lineHeight) lineHeight.value = settings.lineHeight || 1.6;
            const tabSize = document.getElementById('editorTabSize');
            if (tabSize) tabSize.value = settings.tabSize || 2;
            const cursorStyle = document.getElementById('editorCursorStyle');
            if (cursorStyle) cursorStyle.value = settings.cursorStyle || 'line';
            const wordWrap = document.getElementById('editorWordWrap');
            if (wordWrap) wordWrap.checked = !!settings.wordWrap;
            const cursorBlinking = document.getElementById('editorCursorBlinking');
            if (cursorBlinking) cursorBlinking.value = settings.cursorBlinking || 'blink';
            const scrollBeyond = document.getElementById('editorScrollBeyond');
            if (scrollBeyond) scrollBeyond.checked = !!settings.scrollBeyondLastLine;
            const lineNumbers = document.getElementById('editorLineNumbers');
            if (lineNumbers) lineNumbers.checked = settings.lineNumbers !== false;
            const minimapSize = document.getElementById('editorMinimapSize');
            if (minimapSize) minimapSize.value = settings.minimapSize || 'proportional';
            const minimapSide = document.getElementById('editorMinimapSide');
            if (minimapSide) minimapSide.value = settings.minimapSide || 'right';
            const whitespace = document.getElementById('editorWhitespace');
            if (whitespace) whitespace.value = settings.renderWhitespace || 'none';
            const lineHighlight = document.getElementById('editorLineHighlight');
            if (lineHighlight) lineHighlight.checked = settings.lineHighlight !== false;
            const smoothScroll = document.getElementById('editorSmoothScroll');
            if (smoothScroll) smoothScroll.checked = settings.smoothScroll !== false;
            const stickyScroll = document.getElementById('editorStickyScroll');
            if (stickyScroll) stickyScroll.checked = settings.stickyScroll !== false;
            const folding = document.getElementById('editorFolding');
            if (folding) folding.checked = settings.folding !== false;
            const rulers = document.getElementById('editorRulers');
            if (rulers) rulers.value = settings.rulers || '';
            const theme = document.getElementById('editorTheme');
            if (theme) theme.value = settings.theme || 'default';
            const accent = document.getElementById('editorAccent');
            if (accent) accent.value = settings.themeAccent || '#06b6d4';
            const background = document.getElementById('editorBackground');
            if (background) background.value = settings.themeBackground || '#111111';
            const tabStrip = document.getElementById('editorTabStrip');
            if (tabStrip) tabStrip.value = settings.tabStrip || 'normal';
            const autoSave = document.getElementById('editorAutoSave');
            if (autoSave) autoSave.checked = !!settings.autoSave;
            const autoSaveInterval = document.getElementById('editorAutoSaveInterval');
            if (autoSaveInterval) autoSaveInterval.value = settings.autoSaveInterval || 1200;
            const formatOnSave = document.getElementById('editorFormatOnSave');
            if (formatOnSave) formatOnSave.checked = !!settings.formatOnSave;
            const quickSuggestions = document.getElementById('editorQuickSuggestions');
            if (quickSuggestions) quickSuggestions.checked = settings.quickSuggestions !== false;
            const trimTrailing = document.getElementById('editorTrimTrailing');
            if (trimTrailing) trimTrailing.checked = settings.trimTrailing !== false;
            const indentGuides = document.getElementById('editorIndentGuides');
            if (indentGuides) indentGuides.checked = settings.indentGuides !== false;
            const autoCloseBrackets = document.getElementById('editorAutoCloseBrackets');
            if (autoCloseBrackets) autoCloseBrackets.checked = settings.autoCloseBrackets !== false;
            const autoCloseQuotes = document.getElementById('editorAutoCloseQuotes');
            if (autoCloseQuotes) autoCloseQuotes.checked = settings.autoCloseQuotes !== false;
            const autoCloseTags = document.getElementById('editorAutoCloseTags');
            if (autoCloseTags) autoCloseTags.checked = settings.autoClosingTags !== false;
            const bracketColor = document.getElementById('editorBracketColor');
            if (bracketColor) bracketColor.checked = settings.bracketColorization !== false;
            const matchBrackets = document.getElementById('editorMatchBrackets');
            if (matchBrackets) matchBrackets.checked = settings.matchBrackets !== false;
            const lintSeverity = document.getElementById('editorLintSeverity');
            if (lintSeverity) lintSeverity.value = settings.lintSeverity || 'medium';
            const fontLigatures = document.getElementById('editorFontLigatures');
            if (fontLigatures) fontLigatures.checked = !!settings.fontLigatures;
            const detectIndentation = document.getElementById('editorDetectIndentation');
            if (detectIndentation) detectIndentation.checked = settings.detectIndentation !== false;
            const autoIndent = document.getElementById('editorAutoIndent');
            if (autoIndent) autoIndent.value = settings.autoIndent || 'advanced';
            const mouseWheelZoom = document.getElementById('editorMouseWheelZoom');
            if (mouseWheelZoom) mouseWheelZoom.checked = !!settings.mouseWheelZoom;
            const cursorSmooth = document.getElementById('editorCursorSmooth');
            if (cursorSmooth) cursorSmooth.checked = !!settings.cursorSmoothCaret;
            const renderFinalNewline = document.getElementById('editorRenderFinalNewline');
            if (renderFinalNewline) renderFinalNewline.checked = settings.renderFinalNewline !== false;
            const renderControlChars = document.getElementById('editorRenderControlChars');
            if (renderControlChars) renderControlChars.checked = !!settings.renderControlChars;
            const linkedEditing = document.getElementById('editorLinkedEditing');
            if (linkedEditing) linkedEditing.checked = settings.linkedEditing !== false;
            const inlineSuggest = document.getElementById('editorInlineSuggest');
            if (inlineSuggest) inlineSuggest.checked = settings.inlineSuggest !== false;
            const codeLens = document.getElementById('editorCodeLens');
            if (codeLens) codeLens.checked = settings.codeLens !== false;
            const selectionHighlight = document.getElementById('editorSelectionHighlight');
            if (selectionHighlight) selectionHighlight.checked = settings.selectionHighlight !== false;
            const occurrencesHighlight = document.getElementById('editorOccurrencesHighlight');
            if (occurrencesHighlight) occurrencesHighlight.checked = settings.occurrencesHighlight !== false;
            const breadcrumbs = document.getElementById('editorBreadcrumbs');
            if (breadcrumbs) breadcrumbs.checked = settings.breadcrumbs !== false;
            const formatHtml = document.getElementById('formatHtml');
            if (formatHtml) formatHtml.checked = settings.formatLanguages && settings.formatLanguages.html !== false;
            const formatCss = document.getElementById('formatCss');
            if (formatCss) formatCss.checked = settings.formatLanguages && settings.formatLanguages.css !== false;
            const formatJs = document.getElementById('formatJs');
            if (formatJs) formatJs.checked = settings.formatLanguages && settings.formatLanguages.js !== false;
            const formatJson = document.getElementById('formatJson');
            if (formatJson) formatJson.checked = settings.formatLanguages && settings.formatLanguages.json !== false;
            const formatMd = document.getElementById('formatMd');
            if (formatMd) formatMd.checked = settings.formatLanguages && settings.formatLanguages.md !== false;
            const formatTs = document.getElementById('formatTs');
            if (formatTs) formatTs.checked = settings.formatLanguages && settings.formatLanguages.ts !== false;
            const formatTsx = document.getElementById('formatTsx');
            if (formatTsx) formatTsx.checked = settings.formatLanguages && settings.formatLanguages.tsx !== false;
            const formatScss = document.getElementById('formatScss');
            if (formatScss) formatScss.checked = settings.formatLanguages && settings.formatLanguages.scss !== false;
            const formatLess = document.getElementById('formatLess');
            if (formatLess) formatLess.checked = settings.formatLanguages && settings.formatLanguages.less !== false;
            const formatXml = document.getElementById('formatXml');
            if (formatXml) formatXml.checked = settings.formatLanguages && settings.formatLanguages.xml !== false;
            const formatYaml = document.getElementById('formatYaml');
            if (formatYaml) formatYaml.checked = settings.formatLanguages && settings.formatLanguages.yaml !== false;
            const formatYml = document.getElementById('formatYml');
            if (formatYml) formatYml.checked = settings.formatLanguages && settings.formatLanguages.yml !== false;
            const formatSvg = document.getElementById('formatSvg');
            if (formatSvg) formatSvg.checked = settings.formatLanguages && settings.formatLanguages.svg !== false;
            const formatPhp = document.getElementById('formatPhp');
            if (formatPhp) formatPhp.checked = settings.formatLanguages && settings.formatLanguages.php !== false;
            const formatPy = document.getElementById('formatPy');
            if (formatPy) formatPy.checked = settings.formatLanguages && settings.formatLanguages.py !== false;
            const formatGo = document.getElementById('formatGo');
            if (formatGo) formatGo.checked = settings.formatLanguages && settings.formatLanguages.go !== false;
            const formatRs = document.getElementById('formatRs');
            if (formatRs) formatRs.checked = settings.formatLanguages && settings.formatLanguages.rs !== false;
            const formatJava = document.getElementById('formatJava');
            if (formatJava) formatJava.checked = settings.formatLanguages && settings.formatLanguages.java !== false;
            const formatKt = document.getElementById('formatKt');
            if (formatKt) formatKt.checked = settings.formatLanguages && settings.formatLanguages.kt !== false;
            const formatCs = document.getElementById('formatCs');
            if (formatCs) formatCs.checked = settings.formatLanguages && settings.formatLanguages.cs !== false;
            const formatRb = document.getElementById('formatRb');
            if (formatRb) formatRb.checked = settings.formatLanguages && settings.formatLanguages.rb !== false;
            const formatSql = document.getElementById('formatSql');
            if (formatSql) formatSql.checked = settings.formatLanguages && settings.formatLanguages.sql !== false;
            const formatSh = document.getElementById('formatSh');
            if (formatSh) formatSh.checked = settings.formatLanguages && settings.formatLanguages.sh !== false;
            const formatToml = document.getElementById('formatToml');
            if (formatToml) formatToml.checked = settings.formatLanguages && settings.formatLanguages.toml !== false;
            if (modal) modal.classList.add('show');
        }

        function closeSettingsModal() {
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) settingsModal.classList.remove('show');
        }

        function init() {
            const saved = localStorage.getItem(storageKey);
            if (saved) {
                loadState();
                if (!Array.isArray(state.customExtensions)) state.customExtensions = [];
                if (!state.activeExtensions) state.activeExtensions = {};
                Object.keys(state.extensions || {}).forEach(id => {
                    if (state.extensions[id] && state.activeExtensions[id] === undefined) {
                        state.activeExtensions[id] = true;
                    }
                });
                const serverKeys = Object.keys(serverFileMap);
                if (serverKeys.length) {
                    state.files = serverFileMap;
                } else if (serverFileIndexPaths.length) {
                    const seeded = seedFilesFromIndex(serverFileIndexPaths);
                    Object.keys(seeded).forEach(path => {
                        if (getFileContent(path)) {
                            seeded[path] = { ...seeded[path], ...state.files[path], needsLoad: false };
                        }
                    });
                    state.files = seeded;
                } else {
                    state.files = state.files || {};
                }
                state.open = (state.open || []).filter(p => state.files[p]);
                if (!state.open.length && Object.keys(state.files).length) {
                    state.open = [Object.keys(state.files)[0]];
                }
                if (!state.active || !state.files[state.active]) {
                    state.active = state.open[0] || '';
                }
                state.dirty = {};
                if (Array.isArray(normalizedServerExtensions) && normalizedServerExtensions.length) {
                    const known = new Set((state.customExtensions || []).map(e => e.id));
                    normalizedServerExtensions.forEach(ext => {
                        if (!known.has(ext.id)) state.customExtensions.push(ext);
                    });
                }
            } else {
                if (Object.keys(serverFileMap).length) {
                    bootstrapFromServer();
                } else if (serverFileIndexPaths.length) {
                    state.files = seedFilesFromIndex(serverFileIndexPaths);
                    const first = Object.keys(state.files)[0];
                    state.open = first ? [first] : [];
                    state.active = first || '';
                } else {
                    state.files = {};
                    state.open = [];
                    state.active = '';
                }
                if (Array.isArray(normalizedServerExtensions) && normalizedServerExtensions.length) {
                    state.customExtensions = normalizedServerExtensions.slice();
                }
                if (!state.activeExtensions) state.activeExtensions = {};
            }
            if (!state.active || !state.files[state.active]) {
                const first = Object.keys(state.files)[0];
                state.active = first || '';
                state.open = first ? [first] : [];
            }
            renderFileTree();
            renderTabs();
            initEditor();
            applyEditorSettings();
            renderGitChanges();
            renderExtensions();
            applyExtensionEffects();
            applyLayoutState();
            wirePanels();
            wireActivity();
            wireShortcuts();
            wireActions();
            wireTabMenu();
            wirePanelDrag();
            wireSidebarResize();
            wireSidebarToggle();
            wireEditorSplitResize();
            wireTerminal();
            updatePreviewVisibility();
            applyPreviewLayout();
            updateStatusEncoding();
            updateStatusPos(1, 1);
            if (state.ui.preview) updateLivePreview(true);
            if (searchInput) {
                searchInput.addEventListener('input', () => applySearch(searchInput.value));
                applySearch('');
            }

            const settingsSaveBtn = document.getElementById('settingsSave');
            if (settingsSaveBtn) settingsSaveBtn.addEventListener('click', () => {
                const fontInput = document.getElementById('editorFontSize');
                const minimapInput = document.getElementById('editorMinimap');
                const size = Math.min(24, Math.max(12, parseInt((fontInput && fontInput.value) ? fontInput.value : '14', 10)));
                const fontFamily = (document.getElementById('editorFontFamily') || {}).value || 'JetBrains Mono';
                const lineHeight = parseFloat((document.getElementById('editorLineHeight') || {}).value || '1.6');
                const tabSize = parseInt((document.getElementById('editorTabSize') || {}).value || '2', 10);
                const cursorStyle = (document.getElementById('editorCursorStyle') || {}).value || 'line';
                const wordWrap = !!((document.getElementById('editorWordWrap') || {}).checked);
                const cursorBlinking = (document.getElementById('editorCursorBlinking') || {}).value || 'blink';
                const scrollBeyondLastLine = !!((document.getElementById('editorScrollBeyond') || {}).checked);
                const lineNumbers = !!((document.getElementById('editorLineNumbers') || {}).checked);
                const minimapSize = (document.getElementById('editorMinimapSize') || {}).value || 'proportional';
                const minimapSide = (document.getElementById('editorMinimapSide') || {}).value || 'right';
                const renderWhitespace = (document.getElementById('editorWhitespace') || {}).value || 'none';
                const lineHighlight = !!((document.getElementById('editorLineHighlight') || {}).checked);
                const smoothScroll = !!((document.getElementById('editorSmoothScroll') || {}).checked);
                const stickyScroll = !!((document.getElementById('editorStickyScroll') || {}).checked);
                const folding = !!((document.getElementById('editorFolding') || {}).checked);
                const rulers = (document.getElementById('editorRulers') || {}).value || '';
                const theme = (document.getElementById('editorTheme') || {}).value || 'default';
                const themeAccent = (document.getElementById('editorAccent') || {}).value || '#06b6d4';
                const themeBackground = (document.getElementById('editorBackground') || {}).value || '#111111';
                const tabStrip = (document.getElementById('editorTabStrip') || {}).value || 'normal';
                const autoSave = !!((document.getElementById('editorAutoSave') || {}).checked);
                const autoSaveInterval = parseInt((document.getElementById('editorAutoSaveInterval') || {}).value || '1200', 10);
                const formatOnSave = !!((document.getElementById('editorFormatOnSave') || {}).checked);
                const quickSuggestions = !!((document.getElementById('editorQuickSuggestions') || {}).checked);
                const trimTrailing = !!((document.getElementById('editorTrimTrailing') || {}).checked);
                const indentGuides = !!((document.getElementById('editorIndentGuides') || {}).checked);
                const autoCloseBrackets = !!((document.getElementById('editorAutoCloseBrackets') || {}).checked);
                const autoCloseQuotes = !!((document.getElementById('editorAutoCloseQuotes') || {}).checked);
                const autoCloseTags = !!((document.getElementById('editorAutoCloseTags') || {}).checked);
                const bracketColorization = !!((document.getElementById('editorBracketColor') || {}).checked);
                const matchBrackets = !!((document.getElementById('editorMatchBrackets') || {}).checked);
                const lintSeverity = (document.getElementById('editorLintSeverity') || {}).value || 'medium';
                const fontLigatures = !!((document.getElementById('editorFontLigatures') || {}).checked);
                const detectIndentation = !!((document.getElementById('editorDetectIndentation') || {}).checked);
                const autoIndent = (document.getElementById('editorAutoIndent') || {}).value || 'advanced';
                const mouseWheelZoom = !!((document.getElementById('editorMouseWheelZoom') || {}).checked);
                const cursorSmoothCaret = !!((document.getElementById('editorCursorSmooth') || {}).checked);
                const renderFinalNewline = !!((document.getElementById('editorRenderFinalNewline') || {}).checked);
                const renderControlChars = !!((document.getElementById('editorRenderControlChars') || {}).checked);
                const linkedEditing = !!((document.getElementById('editorLinkedEditing') || {}).checked);
                const inlineSuggest = !!((document.getElementById('editorInlineSuggest') || {}).checked);
                const codeLens = !!((document.getElementById('editorCodeLens') || {}).checked);
                const selectionHighlight = !!((document.getElementById('editorSelectionHighlight') || {}).checked);
                const occurrencesHighlight = !!((document.getElementById('editorOccurrencesHighlight') || {}).checked);
                const breadcrumbs = !!((document.getElementById('editorBreadcrumbs') || {}).checked);
                const formatLanguages = {
                    html: !!((document.getElementById('formatHtml') || {}).checked),
                    css: !!((document.getElementById('formatCss') || {}).checked),
                    js: !!((document.getElementById('formatJs') || {}).checked),
                    json: !!((document.getElementById('formatJson') || {}).checked),
                    md: !!((document.getElementById('formatMd') || {}).checked),
                    ts: !!((document.getElementById('formatTs') || {}).checked),
                    tsx: !!((document.getElementById('formatTsx') || {}).checked),
                    scss: !!((document.getElementById('formatScss') || {}).checked),
                    less: !!((document.getElementById('formatLess') || {}).checked),
                    xml: !!((document.getElementById('formatXml') || {}).checked),
                    yaml: !!((document.getElementById('formatYaml') || {}).checked),
                    yml: !!((document.getElementById('formatYml') || {}).checked),
                    svg: !!((document.getElementById('formatSvg') || {}).checked),
                    php: !!((document.getElementById('formatPhp') || {}).checked),
                    py: !!((document.getElementById('formatPy') || {}).checked),
                    go: !!((document.getElementById('formatGo') || {}).checked),
                    rs: !!((document.getElementById('formatRs') || {}).checked),
                    java: !!((document.getElementById('formatJava') || {}).checked),
                    kt: !!((document.getElementById('formatKt') || {}).checked),
                    cs: !!((document.getElementById('formatCs') || {}).checked),
                    rb: !!((document.getElementById('formatRb') || {}).checked),
                    sql: !!((document.getElementById('formatSql') || {}).checked),
                    sh: !!((document.getElementById('formatSh') || {}).checked),
                    toml: !!((document.getElementById('formatToml') || {}).checked)
                };

                state.settings.fontSize = size;
                state.settings.fontFamily = fontFamily;
                state.settings.lineHeight = lineHeight;
                state.settings.tabSize = tabSize;
                state.settings.cursorStyle = cursorStyle;
                state.settings.wordWrap = wordWrap;
                state.settings.cursorBlinking = cursorBlinking;
                state.settings.scrollBeyondLastLine = scrollBeyondLastLine;
                state.settings.minimap = !!(minimapInput && minimapInput.checked);
                state.settings.minimapSize = minimapSize;
                state.settings.minimapSide = minimapSide;
                state.settings.lineNumbers = lineNumbers;
                state.settings.renderWhitespace = renderWhitespace;
                state.settings.lineHighlight = lineHighlight;
                state.settings.smoothScroll = smoothScroll;
                state.settings.stickyScroll = stickyScroll;
                state.settings.folding = folding;
                state.settings.rulers = rulers;
                state.settings.theme = theme;
                state.settings.themeAccent = themeAccent;
                state.settings.themeBackground = themeBackground;
                state.settings.tabStrip = tabStrip;
                state.settings.autoSave = autoSave;
                state.settings.autoSaveInterval = autoSaveInterval;
                state.settings.formatOnSave = formatOnSave;
                state.settings.quickSuggestions = quickSuggestions;
                state.settings.trimTrailing = trimTrailing;
                state.settings.indentGuides = indentGuides;
                state.settings.autoCloseBrackets = autoCloseBrackets;
                state.settings.autoCloseQuotes = autoCloseQuotes;
                state.settings.autoClosingTags = autoCloseTags;
                state.settings.bracketColorization = bracketColorization;
                state.settings.matchBrackets = matchBrackets;
                state.settings.lintSeverity = lintSeverity;
                state.settings.formatLanguages = formatLanguages;
                state.settings.fontLigatures = fontLigatures;
                state.settings.detectIndentation = detectIndentation;
                state.settings.autoIndent = autoIndent;
                state.settings.mouseWheelZoom = mouseWheelZoom;
                state.settings.cursorSmoothCaret = cursorSmoothCaret;
                state.settings.renderFinalNewline = renderFinalNewline;
                state.settings.renderControlChars = renderControlChars;
                state.settings.linkedEditing = linkedEditing;
                state.settings.inlineSuggest = inlineSuggest;
                state.settings.codeLens = codeLens;
                state.settings.selectionHighlight = selectionHighlight;
                state.settings.occurrencesHighlight = occurrencesHighlight;
                state.settings.breadcrumbs = breadcrumbs;
                applyEditorSettings();
                saveState();
                closeSettingsModal();
                showToast('Settings saved', 'fa-circle-check');
            });
            const settingsCancel = document.getElementById('settingsCancel');
            const settingsClose = document.getElementById('closeSettings');
            if (settingsCancel) settingsCancel.addEventListener('click', closeSettingsModal);
            if (settingsClose) settingsClose.addEventListener('click', closeSettingsModal);
            document.querySelectorAll('[data-settings-tab]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.getAttribute('data-settings-tab');
                    document.querySelectorAll('[data-settings-tab]').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('[data-settings-panel]').forEach(panel => panel.classList.remove('active'));
                    btn.classList.add('active');
                    const panel = document.querySelector(`[data-settings-panel="${tab}"]`);
                    if (panel) panel.classList.add('active');
                });
            });
            const fileModalConfirm = document.getElementById('fileModalConfirm');
            const fileModalCancel = document.getElementById('fileModalCancel');
            const fileModalClose = document.getElementById('closeFileModal');
            const fileModalInput = document.getElementById('fileModalInput');
            if (fileModalConfirm) fileModalConfirm.addEventListener('click', confirmFileModal);
            if (fileModalCancel) fileModalCancel.addEventListener('click', closeFileModal);
            if (fileModalClose) fileModalClose.addEventListener('click', closeFileModal);
            if (fileModalInput) fileModalInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') confirmFileModal();
            });
            const openExtModal = document.getElementById('openExtModal');
            if (openExtModal) openExtModal.addEventListener('click', openExtensionModal);
            const extGuideClose = document.getElementById('extensionsGuideClose');
            if (extGuideClose) extGuideClose.addEventListener('click', () => {
                const extGuide = document.getElementById('extensionsGuide');
                if (extGuide) extGuide.classList.remove('show');
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
