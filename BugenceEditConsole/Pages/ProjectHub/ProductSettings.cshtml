@page
@model BugenceEditConsole.Pages.ProjectHub.ProductSettingsModel
@{
    Layout = null;
    var pid = Model.ProjectId;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Settings | Bugence</title>
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@900,700,500,400,300&f[]=cabinet-grotesk@800,500,700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg:#000; --panel:#0a0a0a; --line:rgba(255,255,255,.08); --muted:#9ca3af; --text:#fff; --cyan:#06b6d4; --green:#10b981; --yellow:#f59e0b; --red:#ef4444; --head:'Cabinet Grotesk',sans-serif; --body:'Satoshi',sans-serif; }
        * { box-sizing:border-box; }
        body { margin:0; min-height:100vh; background:var(--bg); color:var(--text); font-family:var(--body); overflow:hidden; }
        .app-shell { display:grid; grid-template-columns:300px minmax(0,1fr); min-height:100vh; }
        .main-content { min-width:0; overflow-y:auto; padding:32px; background-image:radial-gradient(circle at 0% 0%, rgba(6,182,212,.05), transparent 40%), linear-gradient(rgba(255,255,255,.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,.02) 1px, transparent 1px); background-size:100% 100%, 40px 40px, 40px 40px; }
        .content-shell { max-width:1480px; margin:0 auto; }
        .hero { display:grid; grid-template-columns:minmax(0,1.45fr) minmax(320px,.85fr); gap:18px; margin:22px 0 18px; }
        .panel, .card { background:linear-gradient(180deg, rgba(12,12,12,.96), rgba(6,6,6,.98)); border:1px solid var(--line); border-radius:24px; box-shadow:0 18px 36px rgba(0,0,0,.34); }
        .hero-main { padding:28px; display:grid; gap:16px; }
        .kicker, .chip, .pill { display:inline-flex; align-items:center; gap:8px; width:fit-content; padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.04); font-size:.78rem; font-weight:800; letter-spacing:.08em; text-transform:uppercase; }
        .kicker { border-color:rgba(6,182,212,.28); background:rgba(6,182,212,.08); color:#8fe8f5; }
        .hero h1 { margin:0; font-family:var(--head); font-size:clamp(2.2rem,4vw,3.35rem); line-height:.94; letter-spacing:-.04em; }
        .hero p, .card-desc, .helper, .small { margin:0; color:var(--muted); line-height:1.6; }
        .hero-row, .header-row, .toggle-row, .domain-row { display:flex; justify-content:space-between; align-items:center; gap:16px; }
        .hero-tags, .actions { display:flex; gap:10px; flex-wrap:wrap; }
        .save-btn, .ghost-btn { appearance:none; border:none; border-radius:12px; padding:12px 16px; font-weight:900; font-size:.94rem; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; gap:8px; }
        .save-btn { background:linear-gradient(135deg, #22d3ee, #06b6d4); color:#041017; box-shadow:0 12px 28px rgba(6,182,212,.24); }
        .ghost-btn { border:1px solid var(--line); background:rgba(255,255,255,.03); color:#fff; }
        .side-panel { padding:22px; display:grid; gap:14px; align-content:start; }
        .side-title, .card-title { margin:0 0 6px; font-size:1.2rem; font-weight:800; }
        .meta-box, .stat, .status-item, .domain-row, .route-row { border:1px solid var(--line); border-radius:16px; background:rgba(255,255,255,.02); }
        .meta-box, .status-item { padding:14px 16px; }
        .label { display:block; color:#7b8794; font-size:.74rem; letter-spacing:.16em; text-transform:uppercase; font-weight:700; margin-bottom:8px; }
        .value { display:block; font-size:1rem; font-weight:800; word-break:break-word; }
        .stats { display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:14px; margin-bottom:18px; }
        .stat { padding:16px 18px; }
        .stat .value { font-size:2rem; line-height:1; margin-bottom:8px; }
        .layout { display:grid; grid-template-columns:280px minmax(0,1fr); gap:18px; }
        .tabs { display:grid; gap:10px; align-content:start; }
        .tab-link { appearance:none; border:1px solid var(--line); background:linear-gradient(180deg, rgba(10,10,10,.96), rgba(6,6,6,.98)); color:#e5e7eb; padding:16px 18px; border-radius:18px; text-align:left; cursor:pointer; display:grid; gap:6px; }
        .tab-link .title { font-size:1rem; font-weight:800; }
        .tab-link .desc { color:var(--muted); font-size:.84rem; line-height:1.45; }
        .tab-link.active { border-color:rgba(6,182,212,.38); background:linear-gradient(180deg, rgba(6,182,212,.12), rgba(6,6,6,.98)); box-shadow:inset 0 0 0 1px rgba(6,182,212,.12); }
        .tab-pane { display:none; gap:18px; }
        .tab-pane.active { display:grid; }
        .card { padding:24px; }
        .grid-2, .status-grid { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:16px; }
        .span-2 { grid-column:1 / -1; }
        .field label { display:block; font-size:.78rem; text-transform:uppercase; letter-spacing:.12em; color:#8a94a1; margin-bottom:8px; font-weight:700; }
        .field input, .field textarea, .field select, .route-input { width:100%; border:1px solid var(--line); background:rgba(0,0,0,.9); color:#fff; border-radius:12px; padding:12px 14px; font:inherit; }
        .field textarea { min-height:120px; resize:vertical; }
        .toggle-row { padding:16px 0; border-top:1px solid rgba(255,255,255,.06); }
        .toggle-row:first-child { border-top:none; padding-top:0; }
        .toggle-copy strong { display:block; font-size:.98rem; margin-bottom:4px; }
        .switch { position:relative; width:48px; height:26px; flex:0 0 48px; }
        .switch input { opacity:0; width:0; height:0; }
        .slider { position:absolute; inset:0; border-radius:999px; background:#2c2c2c; transition:.2s; }
        .slider:before { content:""; position:absolute; width:20px; height:20px; left:3px; top:3px; border-radius:50%; background:#fff; transition:.2s; }
        .switch input:checked + .slider { background:var(--cyan); }
        .switch input:checked + .slider:before { transform:translateX(22px); }
        .domain-list, .route-list { display:grid; gap:12px; }
        .domain-row, .route-row { padding:14px 16px; }
        .domain-row { display:grid; grid-template-columns:minmax(0,1fr) auto auto; gap:12px; }
        .domain-name { font-weight:800; font-size:.98rem; word-break:break-word; }
        .domain-meta, .route-inline { display:flex; gap:8px; flex-wrap:wrap; }
        .pill.green { background:rgba(16,185,129,.12); border-color:rgba(16,185,129,.24); color:#7ff7c7; }
        .pill.yellow { background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.24); color:#ffd18a; }
        .pill.red { background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.24); color:#ffb3b3; }
        .route-row { display:grid; grid-template-columns:minmax(220px,.9fr) minmax(240px,1fr) auto; gap:14px; align-items:center; }
        .page-meta strong { display:block; font-size:.98rem; margin-bottom:4px; }
        .page-meta span { display:block; color:var(--muted); font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.82rem; word-break:break-word; }
        .landing-label { display:inline-flex; align-items:center; gap:8px; border:1px solid var(--line); border-radius:14px; padding:10px 12px; background:rgba(255,255,255,.03); font-size:.84rem; font-weight:700; white-space:nowrap; }
        .save-feedback { margin-top:12px; min-height:20px; font-size:.88rem; color:var(--muted); }
        @@media (max-width:1280px) { .hero, .stats, .layout, .grid-2, .status-grid, .domain-row, .route-row { grid-template-columns:1fr; } }
        @@media (max-width:1024px) { body { overflow-x:hidden; overflow-y:auto; min-height:100dvh; } .app-shell { grid-template-columns:1fr; min-height:100dvh; } .main-content { padding:12px 10px 20px; } .content-shell { margin-top:56px; } .tabs { grid-auto-flow:column; grid-auto-columns:minmax(240px,1fr); overflow-x:auto; padding-bottom:4px; } }
    </style>
</head>
<body>
    <div class="app-shell">
        @await Html.PartialAsync("_ProjectHubSidebar")
        <main class="main-content">
            <div class="content-shell">
                @await Html.PartialAsync("_DashboardTopbar")
                <form id="projectSettingsForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="projectId" value="@pid" />
                    <section class="hero">
                        <div class="panel hero-main">
                            <span class="kicker"><i class="fa-solid fa-sliders"></i> Project Control Surface</span>
                            <h1>Project Settings</h1>
                            <p>Configure the project identity, publishing behavior, page routing, domains, and security posture for <strong>@Model.ProjectName</strong>. The landing page selection and custom page URLs below are wired to the same project model used by dashboard local preview and published-site routing.</p>
                            <div class="hero-row">
                                <div class="hero-tags">
                                    <span class="chip">@Model.ProjectStatus</span>
                                    <span class="chip">@Model.HtmlPageCount HTML pages</span>
                                    <span class="chip">@Model.RouteOverrideCount custom routes</span>
                                </div>
                                <button type="submit" class="save-btn" id="saveBtn">Save Changes</button>
                            </div>
                        </div>
                        <div class="panel side-panel">
                            <h2 class="side-title">Project runtime</h2>
                            <div class="meta-box">
                                <span class="label">Publish root</span>
                                <span class="value">@Model.PublishRoot</span>
                            </div>
                            <div class="meta-box">
                                <span class="label">Last publish</span>
                                <span class="value">@Model.LastPublishedLabel</span>
                            </div>
                            <div class="meta-box">
                                <span class="label">Landing page</span>
                                <span class="value">@(string.IsNullOrWhiteSpace(Model.LandingPagePath) ? "Auto-select index or first page" : Model.LandingPagePath)</span>
                            </div>
                        </div>
                    </section>

                    <section class="stats">
                        <article class="stat">
                            <span class="label">Pages</span>
                            <span class="value">@Model.HtmlPageCount</span>
                            <span class="small">HTML pages available for visual routing.</span>
                        </article>
                        <article class="stat">
                            <span class="label">Domains</span>
                            <span class="value">@Model.Domains.Count</span>
                            <span class="small">Connected and pending project domains.</span>
                        </article>
                        <article class="stat">
                            <span class="label">Landing</span>
                            <span class="value">@(string.IsNullOrWhiteSpace(Model.LandingPagePath) ? "Auto" : "Set")</span>
                            <span class="small">Dashboard preview opens on the selected page.</span>
                        </article>
                        <article class="stat">
                            <span class="label">Route aliases</span>
                            <span class="value">@Model.RouteOverrideCount</span>
                            <span class="small">Custom URLs replacing raw file paths.</span>
                        </article>
                    </section>

                    <section class="layout">
                        <aside class="tabs">
                            <button type="button" class="tab-link active" data-tab="general"><span class="title">General</span><span class="desc">Project identity, metadata, and source details.</span></button>
                            <button type="button" class="tab-link" data-tab="domains"><span class="title">Domains</span><span class="desc">Actual project domains, status, and SSL posture.</span></button>
                            <button type="button" class="tab-link" data-tab="publishing"><span class="title">Publishing</span><span class="desc">Landing page control and clean page URL settings.</span></button>
                            <button type="button" class="tab-link" data-tab="security"><span class="title">Security</span><span class="desc">Runtime hardening for HTTPS and CSP.</span></button>
                        </aside>
                        <div>
                            <section class="tab-pane active" id="tab-general">
                                <article class="card">
                                    <div class="header-row">
                                        <div>
                                            <h2 class="card-title">Project identity</h2>
                                            <p class="card-desc">This metadata is shown across Project Hub, dashboard cards, and deployment readouts.</p>
                                        </div>
                                        <span class="chip"><i class="fa-solid fa-pen-ruler"></i> Active project</span>
                                    </div>
                                    <div class="grid-2">
                                        <div class="field">
                                            <label for="DisplayName">Project name</label>
                                            <input id="DisplayName" name="DisplayName" value="@Model.DisplayName" />
                                        </div>
                                        <div class="field">
                                            <label for="RepoUrlInput">Repository URL</label>
                                            <input id="RepoUrlInput" name="RepoUrlInput" value="@Model.RepoUrlInput" placeholder="https://github.com/org/repo" />
                                        </div>
                                        <div class="field span-2">
                                            <label for="DescriptionInput">Description</label>
                                            <textarea id="DescriptionInput" name="DescriptionInput" placeholder="Write a short operational description for this project.">@Model.DescriptionInput</textarea>
                                        </div>
                                    </div>
                                </article>

                                <article class="card">
                                    <div class="header-row">
                                        <div>
                                            <h2 class="card-title">Project runtime facts</h2>
                                            <p class="card-desc">A compact readout of what the system already knows about this project right now.</p>
                                        </div>
                                    </div>
                                    <div class="status-grid">
                                        <div class="status-item"><span class="label">Project status</span><span class="value">@Model.ProjectStatus</span></div>
                                        <div class="status-item"><span class="label">Publish root</span><span class="value">@Model.PublishRoot</span></div>
                                        <div class="status-item"><span class="label">Last published</span><span class="value">@Model.LastPublishedLabel</span></div>
                                        <div class="status-item"><span class="label">Visual editing capability</span><span class="value">@(Model.HasVisualEditing ? "Enabled for page routing controls" : "Not available on this project")</span></div>
                                    </div>
                                </article>
                            </section>

                            <section class="tab-pane" id="tab-domains">
                                <article class="card">
                                    <div class="header-row">
                                        <div>
                                            <h2 class="card-title">Domain bindings</h2>
                                            <p class="card-desc">These are the actual project domains currently attached to this project. Use the central Domains page for DNS onboarding and record management.</p>
                                        </div>
                                        <a href="/Settings/Domains" class="ghost-btn"><i class="fa-solid fa-globe"></i> Manage Domains</a>
                                    </div>
                                    @if (Model.Domains.Count == 0)
                                    {
                                        <div class="status-item">
                                            <span class="label">No project domains</span>
                                            <span class="value">This project is still using its internal preview surface only.</span>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="domain-list">
                                            @foreach (var domain in Model.Domains)
                                            {
                                                var stateClass = domain.IsConnected ? "green" : (string.Equals(domain.Status, "Failed", StringComparison.OrdinalIgnoreCase) ? "red" : "yellow");
                                                <div class="domain-row">
                                                    <div>
                                                        <div class="domain-name">@domain.DomainName</div>
                                                        <div class="domain-meta">
                                                            @if (domain.IsPrimary)
                                                            {
                                                                <span class="pill">Primary</span>
                                                            }
                                                            <span class="pill @stateClass">@domain.Status</span>
                                                            <span class="pill">SSL: @domain.SslStatus</span>
                                                        </div>
                                                    </div>
                                                    <span class="pill @(domain.IsConnected ? "green" : "yellow")">@(domain.IsConnected ? "Live routing ready" : "Needs attention")</span>
                                                    <a href="/Settings/Domains" class="ghost-btn"><i class="fa-solid fa-arrow-up-right-from-square"></i> Open</a>
                                                </div>
                                            }
                                        </div>
                                    }
                                </article>
                            </section>

                            <section class="tab-pane" id="tab-publishing">
                                <article class="card">
                                    <div class="header-row">
                                        <div>
                                            <h2 class="card-title">Landing page</h2>
                                            <p class="card-desc">Choose the page that should open first when the dashboard launches local preview for this project.</p>
                                        </div>
                                        <span class="chip"><i class="fa-solid fa-arrow-right-to-bracket"></i> Preview entrypoint</span>
                                    </div>
                                    <div class="field">
                                        <label for="LandingPagePath">Open local preview on</label>
                                        <select id="LandingPagePath" name="LandingPagePath">
                                            <option value="">Auto-select index or first HTML page</option>
                                            @foreach (var pageRow in Model.HtmlPages)
                                            {
                                                <option value="@pageRow.SourcePath" selected="@pageRow.IsLanding">@pageRow.FileName (@pageRow.SourcePath)</option>
                                            }
                                        </select>
                                        <small class="small">This setting feeds the dashboard “Open local preview” action directly.</small>
                                    </div>
                                </article>

                                <article class="card">
                                    <div class="header-row">
                                        <div>
                                            <h2 class="card-title">Clean page URLs</h2>
                                            <p class="card-desc">Replace raw page filenames like <code>/About.html</code> with cleaner paths such as <code>/About</code> or any custom route. These controls are intended for Visual Editor and Dynamic Visual Editor page projects.</p>
                                        </div>
                                        <span class="chip"><i class="fa-solid fa-link"></i> Route overrides</span>
                                    </div>
                                    @if (!Model.SupportsCustomRoutes)
                                    {
                                        <div class="status-item">
                                            <span class="label">Routing controls unavailable</span>
                                            <span class="value">This project does not currently expose page-based editor routing controls.</span>
                                        </div>
                                    }
                                    else if (Model.HtmlPages.Count == 0)
                                    {
                                        <div class="status-item">
                                            <span class="label">No HTML pages found</span>
                                            <span class="value">Upload or generate page files before configuring landing pages and aliases.</span>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="route-list">
                                            @for (var i = 0; i < Model.HtmlPages.Count; i++)
                                            {
                                                var pageRow = Model.HtmlPages[i];
                                                <div class="route-row">
                                                    <div class="page-meta">
                                                        <strong>@pageRow.FileName</strong>
                                                        <span>@pageRow.SourcePath</span>
                                                    </div>
                                                    <div>
                                                        <input type="hidden" name="PageRoutes[@i].SourcePath" value="@pageRow.SourcePath" />
                                                        <input class="route-input" name="PageRoutes[@i].RoutePath" value="@pageRow.RoutePath" placeholder="@(string.IsNullOrWhiteSpace(pageRow.SuggestedRoute) ? "Leave blank to use root /" : pageRow.SuggestedRoute)" />
                                                        <div class="helper">Suggested clean route: @(string.IsNullOrWhiteSpace(pageRow.SuggestedRoute) ? "/" : "/" + pageRow.SuggestedRoute)</div>
                                                    </div>
                                                    <label class="landing-label">
                                                        <input type="radio" name="LandingPagePath" value="@pageRow.SourcePath" checked="@pageRow.IsLanding" />
                                                        Make landing page
                                                    </label>
                                                </div>
                                            }
                                        </div>
                                    }
                                </article>

                                <article class="card">
                                    <div class="header-row">
                                        <div>
                                            <h2 class="card-title">Publishing automation</h2>
                                            <p class="card-desc">Basic deployment controls stored directly on the project for future expansion.</p>
                                        </div>
                                    </div>
                                    <div class="toggle-row">
                                        <div class="toggle-copy">
                                            <strong>Auto-deploy on push</strong>
                                            <span class="small">Keep this enabled if the project should deploy automatically after source changes or a publish trigger.</span>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" name="AutoDeployOnPush" value="true" @(Model.AutoDeployOnPush ? "checked" : null) />
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="toggle-row">
                                        <div class="toggle-copy">
                                            <strong>Preview deploys</strong>
                                            <span class="small">Allow preview environments and intermediate publish surfaces to be enabled on this project.</span>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" name="EnablePreviewDeploys" value="true" @(Model.EnablePreviewDeploys ? "checked" : null) />
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </article>
                            </section>

                            <section class="tab-pane" id="tab-security">
                                <article class="card">
                                    <div class="header-row">
                                        <div>
                                            <h2 class="card-title">Runtime hardening</h2>
                                            <p class="card-desc">Security defaults that shape how this project should be served when routing is expanded further.</p>
                                        </div>
                                        <span class="chip"><i class="fa-solid fa-shield-halved"></i> Saved on project</span>
                                    </div>
                                    <div class="toggle-row">
                                        <div class="toggle-copy">
                                            <strong>Enforce HTTPS</strong>
                                            <span class="small">Prefer secure delivery and redirect traffic away from plaintext endpoints when project routing allows it.</span>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" name="EnforceHttps" value="true" @(Model.EnforceHttps ? "checked" : null) />
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="toggle-row">
                                        <div class="toggle-copy">
                                            <strong>Content Security Policy</strong>
                                            <span class="small">Store the intent to serve this project with a stricter content policy as security routing expands.</span>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" name="EnableContentSecurityPolicy" value="true" @(Model.EnableContentSecurityPolicy ? "checked" : null) />
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </article>
                            </section>
                        </div>
                    </section>

                    <div class="save-feedback" id="saveFeedback"></div>
                </form>
            </div>
        </main>
    </div>
    <script>
        const tabs = document.querySelectorAll('.tab-link');
        const panes = document.querySelectorAll('.tab-pane');
        const form = document.getElementById('projectSettingsForm');
        const saveBtn = document.getElementById('saveBtn');
        const saveFeedback = document.getElementById('saveFeedback');

        tabs.forEach((tab) => {
            tab.addEventListener('click', () => {
                const key = tab.getAttribute('data-tab');
                tabs.forEach((item) => item.classList.toggle('active', item === tab));
                panes.forEach((pane) => pane.classList.toggle('active', pane.id === `tab-${key}`));
            });
        });

        form?.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!saveBtn) return;

            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            if (saveFeedback) saveFeedback.textContent = '';

            const payload = new FormData(form);
            if (!payload.has('AutoDeployOnPush')) payload.append('AutoDeployOnPush', 'false');
            if (!payload.has('EnablePreviewDeploys')) payload.append('EnablePreviewDeploys', 'false');
            if (!payload.has('EnforceHttps')) payload.append('EnforceHttps', 'false');
            if (!payload.has('EnableContentSecurityPolicy')) payload.append('EnableContentSecurityPolicy', 'false');

            try {
                const response = await fetch(`/ProjectHub/ProductSettings?handler=Save&projectId=@pid`, {
                    method: 'POST',
                    body: payload
                });
                const data = await response.json();
                if (!response.ok || !data?.success) {
                    throw new Error(data?.message || 'Unable to save project settings.');
                }

                saveBtn.textContent = 'Saved';
                if (saveFeedback) {
                    saveFeedback.textContent = 'Project settings updated. Landing page and custom routes are now active for preview and published routing.';
                }
                setTimeout(() => {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Changes';
                }, 1000);
            } catch (error) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
                if (saveFeedback) {
                    saveFeedback.textContent = error?.message || 'Unable to save project settings.';
                }
            }
        });
    </script>
</body>
</html>
