@page
@model BugenceEditConsole.Pages.Editor.IndexModel
@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Editor | Bugence</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://api.fontshare.com/v2/css?f[]=space-grotesk@700,600,500,400&f[]=satoshi@900,700,500,400&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --bg-soft: #0d0d0d;
            --bg-panel: #111111;
            --bg-card: #161616;
            --border: #2a2a2a;
            --text: #f8f8f8;
            --muted: #a3a3a3;
            --accent: #ffffff;
            --accent-2: #ffffff;
            --warning: #ffffff;
            --shadow: 0 35px 80px rgba(0,0,0,0.6);
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: "Satoshi", system-ui, sans-serif;
            background: radial-gradient(circle at 20% 15%, rgba(255,255,255,0.08), transparent 45%),
                        radial-gradient(circle at 80% 10%, rgba(255,255,255,0.05), transparent 35%),
                        var(--bg);
            color: var(--text);
        }
        .editor-shell {
            display: grid;
            grid-template-columns: 78px 300px 1fr 320px;
            grid-template-rows: 68px 1fr;
            min-height: 100vh;
        }
        .topbar {
            grid-column: 1 / -1;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            backdrop-filter: blur(16px);
            position: sticky;
            top: 0;
            z-index: 20;
        }
        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
            letter-spacing: 0.08em;
        }
        .brand img {
            width: 22px;
            height: 22px;
            object-fit: contain;
            filter: drop-shadow(0 6px 14px rgba(0,0,0,0.35));
        }
        .brand span {
            letter-spacing: 0.08em;
        }
        .brand i { color: var(--accent); }
        .file-meta {
            display: flex;
            flex-direction: column;
            margin-left: 18px;
        }
        .file-meta span:first-child { font-weight: 700; font-family: "Space Grotesk", sans-serif; }
        .file-meta span:last-child { color: var(--muted); font-size: 0.78rem; }
        .top-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--bg-panel);
            color: var(--muted);
            font-size: 0.8rem;
        }
        .integrity-pill {
            border-color: rgba(255,255,255,0.2);
            color: #e2e8f0;
        }
        .integrity-pill.is-safe {
            border-color: rgba(34,197,94,0.45);
            color: #86efac;
            background: rgba(34,197,94,0.12);
        }
        .integrity-pill.is-warning {
            border-color: rgba(250,204,21,0.45);
            color: #fde68a;
            background: rgba(250,204,21,0.12);
        }
        .integrity-pill.is-error {
            border-color: rgba(239,68,68,0.45);
            color: #fca5a5;
            background: rgba(239,68,68,0.12);
        }
        .btn {
            border: none;
            background: var(--bg-panel);
            color: var(--text);
            padding: 10px 16px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn.primary { background: #3b82f6; color: #0b1120; box-shadow: 0 12px 24px rgba(59,130,246,0.25); }
        .btn.ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn.publish { background: #22c55e; color: #07180d; box-shadow: 0 12px 24px rgba(34,197,94,0.25); }
        .editor-mobile-panel-btn { display: none !important; }
        .mini-toolbar {
            grid-row: 2;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 18px 0;
            gap: 16px;
        }
        .tool-btn {
            width: 46px;
            height: 46px;
            border-radius: 14px;
            display: grid;
            place-items: center;
            background: var(--bg-card);
            color: var(--muted);
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }
        .tool-btn.active, .tool-btn:hover { color: var(--text); background: rgba(255,255,255,0.08); }
        .tool-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 60px;
            top: 50%;
            transform: translateY(-50%) translateX(-6px);
            background: var(--bg-panel);
            color: var(--text);
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 0.72rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: 0.2s ease;
            box-shadow: 0 10px 24px rgba(0,0,0,0.35);
            z-index: 50;
        }
        .tool-btn:hover::after,
        .tool-btn:focus-visible::after {
            opacity: 1;
            visibility: visible;
            transform: translateY(-50%) translateX(0);
        }
        .tool-drawer {
            position: fixed;
            left: 84px;
            top: 140px;
            width: 210px;
            background: var(--bg-panel);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 12px;
            display: none;
            flex-direction: column;
            gap: 14px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.35);
            z-index: 30;
        }
        .tool-drawer.is-open { display: flex; }
        .tool-drawer [data-drawer-section] { display: none; }
        .tool-drawer[data-mode="shapes"] [data-drawer-section="shapes"],
        .tool-drawer[data-mode="tools"] [data-drawer-section="tools"] {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        .tool-group-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--muted);
            margin-bottom: 6px;
        }
        .tool-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
        }
        .tool-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.03);
            color: var(--text);
            font-size: 0.72rem;
            cursor: pointer;
            transition: border 0.15s ease, background 0.15s ease, transform 0.15s ease;
        }
        .tool-item:hover {
            border-color: rgba(6,182,212,0.5);
            background: rgba(6,182,212,0.12);
            transform: translateY(-1px);
        }
        .tool-item.is-active {
            border-color: rgba(6,182,212,0.7);
            background: rgba(6,182,212,0.18);
        }
        .asset-modal {
            position: fixed;
            inset: 0;
            background: rgba(3,6,10,0.75);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 80;
        }
        .asset-modal.active { display: flex; }
        .asset-card {
            width: min(920px, 92vw);
            max-height: 84vh;
            background: var(--bg-panel);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .asset-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .asset-title {
            font-weight: 700;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            font-size: 0.8rem;
            color: var(--muted);
        }
        .asset-close {
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.05);
            color: var(--text);
            border-radius: 10px;
            padding: 6px 10px;
            cursor: pointer;
        }
        .asset-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 18px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .asset-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 18px 12px;
            flex-wrap: wrap;
        }
        .asset-status {
            font-size: 0.76rem;
            color: var(--muted);
        }
        .asset-tabs {
            display: inline-flex;
            gap: 6px;
            background: rgba(255,255,255,0.04);
            padding: 4px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .asset-tab {
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.72rem;
            color: var(--muted);
            cursor: pointer;
        }
        .asset-tab.active {
            background: rgba(6,182,212,0.18);
            color: var(--accent);
        }
        .asset-search {
            flex: 1;
            min-width: 160px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 999px;
            padding: 8px 14px;
            color: var(--text);
            font-size: 0.8rem;
        }
        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            padding: 16px 18px 20px;
            overflow-y: auto;
        }
        .asset-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px;
            overflow: hidden;
            cursor: pointer;
            transition: border 0.2s ease, transform 0.2s ease;
            position: relative;
        }
        .asset-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(12,12,12,0.6);
            color: var(--text);
            display: grid;
            place-items: center;
            cursor: pointer;
        }
        .asset-delete:hover {
            border-color: rgba(239,68,68,0.6);
            color: #fecaca;
        }
        .asset-item:hover {
            border-color: rgba(6,182,212,0.5);
            transform: translateY(-2px);
        }
        .asset-thumb {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
            background: rgba(255,255,255,0.06);
        }
        .asset-name {
            padding: 8px 10px 10px;
            font-size: 0.72rem;
            color: var(--muted);
            word-break: break-all;
        }
        .missing-body {
            padding: 16px 18px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }
        .missing-summary {
            color: var(--muted);
            font-size: 0.82rem;
        }
        .missing-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .missing-status {
            font-size: 0.78rem;
            color: var(--muted);
        }
        .missing-list {
            display: grid;
            gap: 10px;
            overflow: auto;
            padding-bottom: 6px;
        }
        .missing-item {
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 10px 12px;
            background: rgba(255,255,255,0.03);
        }
        .missing-item .missing-file {
            font-size: 0.74rem;
            color: var(--muted);
            margin-bottom: 6px;
        }
        .missing-item .missing-path {
            font-size: 0.78rem;
            color: var(--text);
            word-break: break-all;
        }
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 14px;
            padding: 12px 18px 4px;
            overflow: auto;
        }
        .template-toolbar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 14px 18px 4px;
        }
        .template-meta {
            font-size: 0.72rem;
            color: var(--muted);
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .template-search {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.04);
            color: var(--text);
        }
        .template-search input {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 0.78rem;
            outline: none;
            min-width: 180px;
        }
        .template-card {
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px;
            background: rgba(255,255,255,0.03);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            cursor: pointer;
            transition: border 0.2s ease, transform 0.2s ease;
        }
        .template-card:hover {
            border-color: rgba(6,182,212,0.45);
            transform: translateY(-2px);
        }
        .template-card.is-active {
            border-color: rgba(6,182,212,0.75);
            box-shadow: 0 12px 26px rgba(6,182,212,0.18);
        }
        .template-preview {
            border-radius: 12px;
            padding: 12px;
            min-height: 120px;
            background: rgba(255,255,255,0.04);
            color: var(--text);
            font-size: 0.7rem;
            display: grid;
            gap: 8px;
        }
        .template-label {
            font-weight: 700;
        }
        .template-desc {
            font-size: 0.75rem;
            color: var(--muted);
        }
        .template-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 12px 18px 16px;
            border-top: 1px solid rgba(255,255,255,0.08);
        }
        .template-form {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
            flex: 1;
            min-width: 240px;
        }
        .template-field {
            display: grid;
            gap: 6px;
        }
        .template-field label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--muted);
        }
        .template-actions-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .share-grid {
            display: grid;
            gap: 12px;
            padding: 16px 18px 18px;
        }
        .share-row {
            display: grid;
            gap: 8px;
        }
        .share-row label {
            font-size: 0.72rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.12em;
        }
        .share-input {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            align-items: center;
        }
        .share-input input {
            width: 100%;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 10px;
            color: var(--text);
        }
        .btn[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }
        body.focus-mode .left-panel,
        body.focus-mode .right-panel {
            display: none;
        }
        body.focus-mode .editor-shell {
            grid-template-columns: 62px 1fr;
        }
        body.focus-mode .canvas-area {
            grid-column: 2;
        }
        .left-panel {
            grid-row: 2;
            background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(0,0,0,0.12)), var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 12px 12px 14px;
            gap: 12px;
            position: relative;
            box-shadow: inset -1px 0 0 rgba(255,255,255,0.05), 0 22px 50px rgba(0,0,0,0.45);
        }
        .panel-tabs {
            display: flex;
            gap: 8px;
            padding: 6px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.06);
            background: rgba(255,255,255,0.03);
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 8px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            color: var(--muted);
            border: 1px solid transparent;
            transition: background 0.18s ease, border-color 0.18s ease, color 0.18s ease;
        }
        .tab:hover {
            color: var(--text);
            border-color: rgba(6,182,212,0.35);
            background: rgba(6,182,212,0.08);
        }
        .tab.active {
            color: var(--text);
            border-color: rgba(6,182,212,0.4);
            background: rgba(6,182,212,0.1);
        }
        .panel-body {
            padding: 16px 18px;
            overflow-y: auto;
            flex: 1;
        }
        .panel-shell {
            flex: 1;
            min-height: 0;
            border: 1px solid var(--border);
            border-radius: 18px;
            background: var(--bg-card);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 18px 40px rgba(0,0,0,0.4);
        }
        .panel-shell .panel-body {
            padding: 14px;
            overflow: hidden;
            min-height: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .panel-scroll {
            overflow-y: auto;
            padding-right: 6px;
            margin-right: -6px;
            scrollbar-gutter: stable;
        }
        #panelElements {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            gap: 12px;
            min-height: 0;
            height: 100%;
        }
        #panelStructure,
        #panelPages {
            min-height: 0;
        }
        #panelPages {
            overflow-y: auto;
            padding-right: 6px;
            margin-right: -6px;
            scrollbar-gutter: stable;
        }
        .pages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .pages-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: calc(100vh - 420px);
            overflow-y: auto;
            padding-right: 6px;
            margin-right: -6px;
        }
        .page-card {
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.04);
            padding: 10px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            cursor: pointer;
            transition: border 0.15s ease, background 0.15s ease;
        }
        .page-card:hover {
            border-color: rgba(6,182,212,0.45);
            background: rgba(6,182,212,0.08);
        }
        .page-card.active {
            border-color: rgba(6,182,212,0.7);
            background: rgba(6,182,212,0.12);
        }
        .page-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }
        .page-title {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text);
        }
        .page-meta {
            font-size: 0.7rem;
            color: var(--muted);
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .page-pill {
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 0.62rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .page-pill.home {
            border-color: rgba(34,197,94,0.4);
            color: #bbf7d0;
        }
        .page-pill.draft {
            border-color: rgba(250,204,21,0.4);
            color: #fde68a;
        }
        .page-actions {
            display: flex;
            gap: 6px;
        }
        .page-action {
            width: 26px;
            height: 26px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.05);
            display: grid;
            place-items: center;
            color: var(--text);
            font-size: 0.7rem;
            cursor: pointer;
        }
        .page-action:hover {
            border-color: rgba(6,182,212,0.5);
            background: rgba(6,182,212,0.16);
        }
        .pages-form {
            margin-top: 12px;
            border: 1px dashed rgba(255,255,255,0.12);
            border-radius: 14px;
            padding: 12px;
            background: rgba(255,255,255,0.03);
        }
        #structureDockTarget {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding-right: 6px;
            margin-right: -6px;
            scrollbar-gutter: stable;
        }
        #elementsScroll {
            flex: 1 1 0;
            min-height: 0;
            overflow-y: auto;
            padding-right: 6px;
            margin-right: -6px;
            scrollbar-gutter: stable;
            max-height: calc(100vh - 360px);
        }
        #elementsCatalog {
            padding-bottom: 12px;
        }
        .favorites {
            margin-bottom: 12px;
        }
        .favorite-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.04);
            color: var(--text);
            font-size: 0.7rem;
            cursor: pointer;
            margin: 0 6px 6px 0;
        }
        .favorite-chip:hover {
            background: rgba(255,255,255,0.1);
        }
        .favorite-chip.dragging {
            opacity: 0.5;
        }
        .search {
            background: var(--bg-soft);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 12px;
            color: var(--muted);
            width: 100%;
            margin-bottom: 14px;
        }
        .section-title {
            font-size: 0.72rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.18em;
            margin: 18px 0 10px;
        }
        .element-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .element-category {
            font-size: 0.7rem;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            color: var(--muted);
            margin: 18px 0 10px;
        }
        .element-card .el-title {
            font-weight: 600;
            color: var(--text);
        }
        .element-card .el-sub {
            font-size: 0.68rem;
            color: var(--muted);
        }
        .el-pin {
            opacity: 0;
            transition: opacity 0.15s ease, transform 0.15s ease;
        }
        .element-card:hover .el-pin {
            opacity: 1;
            transform: scale(1.05);
        }
        .element-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            color: var(--muted);
            font-size: 0.75rem;
        }
        .symbol-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .element-card:hover .symbol-actions {
            opacity: 1;
        }
        .symbol-actions button {
            all: unset;
            cursor: pointer;
            width: 22px;
            height: 22px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: var(--muted);
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
        }
        .symbol-actions button:hover {
            color: var(--accent);
            border-color: rgba(6,182,212,0.7);
        }
        .element-card[data-element] {
            cursor: grab;
        }
        .element-card[data-element]:active {
            cursor: grabbing;
        }
        .floating-panel {
            position: fixed;
            top: 120px;
            right: 28px;
            width: 320px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 18px;
            z-index: 50;
            box-shadow: 0 26px 60px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        .floating-panel.hidden {
            display: none;
        }
        .floating-panel .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: rgba(255,255,255,0.04);
            border-bottom: 1px solid var(--border);
            cursor: grab;
        }
        .floating-panel .panel-header:active {
            cursor: grabbing;
        }
        .floating-panel .panel-header span {
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--text);
        }
        .floating-panel .panel-body {
            padding: 12px;
            max-height: 60vh;
            overflow-y: auto;
        }
        .dock-pill {
            position: fixed;
            right: 18px;
            top: 140px;
            background: rgba(6,182,212,0.16);
            border: 1px solid rgba(6,182,212,0.4);
            color: var(--accent);
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 0.7rem;
            cursor: pointer;
            z-index: 49;
            display: none;
        }
        .dock-pill.show {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .grid-chooser {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }
        .grid-chooser.active {
            display: flex;
        }
        .grid-chooser .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 18px;
            min-width: 280px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .grid-chooser .panel h4 {
            margin: 0 0 12px;
            font-size: 0.85rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--muted);
        }
        .grid-chooser .grid-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .grid-chooser .grid-option {
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-size: 0.78rem;
            color: var(--text);
        }
        .grid-chooser .grid-option:hover {
            background: rgba(255,255,255,0.1);
        }
        .element-card i { font-size: 1.2rem; color: var(--accent); }
        .ai-cta {
            margin-top: auto;
            background: linear-gradient(135deg, rgba(6,182,212,0.16), rgba(59,130,246,0.12), rgba(255,255,255,0.04));
            border: 1px solid rgba(6,182,212,0.35);
            padding: 14px;
            border-radius: 18px;
            box-shadow: 0 16px 30px rgba(0,0,0,0.35);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .ai-cta-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
        }
        .ai-cta-title {
            font-weight: 700;
            font-size: 0.88rem;
            color: var(--text);
        }
        .ai-cta-sub {
            font-size: 0.72rem;
            color: var(--muted);
            line-height: 1.4;
        }
        .ai-pill {
            font-size: 0.58rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid rgba(6,182,212,0.5);
            background: rgba(6,182,212,0.2);
            color: #c7f9ff;
            font-weight: 700;
        }
        .ai-cta-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .btn.ai-primary {
            width: 100%;
            justify-content: center;
            background: linear-gradient(135deg, #38bdf8, #60a5fa);
            color: #05101e;
            box-shadow: 0 16px 30px rgba(56,189,248,0.35);
        }
        .btn.ai-primary:hover {
            filter: brightness(1.05);
        }
        .ai-cta-footer {
            font-size: 0.68rem;
            color: rgba(255,255,255,0.75);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .canvas-area {
            grid-row: 2;
            background: var(--bg);
            padding: 24px;
            position: relative;
            overflow: hidden;
        }
        .canvas-area::before {
            content: "";
            position: absolute;
            inset: 0;
            background:
                radial-gradient(circle at 15% 20%, rgba(6,182,212,0.12), transparent 45%),
                radial-gradient(circle at 85% 15%, rgba(99,102,241,0.12), transparent 40%),
                radial-gradient(circle at 50% 80%, rgba(34,197,94,0.08), transparent 45%);
            pointer-events: none;
            z-index: 0;
        }
        .canvas-area > * {
            position: relative;
            z-index: 1;
        }
        .canvas-wrap {
            background: #ffffff;
            border-radius: 22px;
            height: calc(100vh - 140px);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .canvas-wrap.is-paused .canvas-frame {
            pointer-events: none;
            filter: grayscale(0.15);
        }
        .canvas-pause {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
            background: rgba(7,10,14,0.65);
            color: var(--text);
            z-index: 5;
            text-align: center;
            padding: 24px;
        }
        .canvas-wrap.is-paused .canvas-pause { display: flex; }
        .canvas-wrap.is-mobile {
            max-width: 430px;
            margin: 0 auto;
            height: 860px;
            background: var(--bg-panel);
            padding: 18px 14px 22px;
            border-radius: 32px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.6);
        }
        .canvas-wrap.is-tablet {
            max-width: 860px;
            margin: 0 auto;
            height: 980px;
            background: var(--bg-panel);
            padding: 16px 16px 20px;
            border-radius: 28px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.6);
        }
        .canvas-wrap.is-mobile::before {
            content: "";
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            height: 18px;
            border-radius: 999px;
            background: var(--bg-soft);
            border: 1px solid var(--border);
            z-index: 3;
        }
        .canvas-wrap.is-tablet::before {
            content: "";
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 6px;
            border-radius: 999px;
            background: var(--bg-soft);
            border: 1px solid var(--border);
            z-index: 3;
        }
        .canvas-wrap.is-mobile .canvas-frame {
            border-radius: 22px;
            background: #ffffff;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
        }
        .canvas-wrap.is-tablet .canvas-frame {
            border-radius: 20px;
            background: #ffffff;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
        }
        .canvas-wrap.is-mobile .floating-tools {
            bottom: 10px;
        }
        .canvas-wrap.is-tablet .floating-tools {
            bottom: 10px;
        }
        .canvas-path {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 14px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--bg-panel);
            color: var(--text);
            font-size: 0.78rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            margin: 0 0 14px 6px;
            box-shadow: 0 10px 24px rgba(0,0,0,0.35);
        }
        .canvas-path i { color: var(--muted); opacity: 0.9; }
        .canvas-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--bg-panel);
            color: var(--text);
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            box-shadow: 0 10px 24px rgba(0,0,0,0.35);
            cursor: pointer;
        }
        .canvas-pill i { opacity: 0.7; }
        .canvas-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 0 14px 6px;
            flex-wrap: wrap;
        }
        .view-select {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.12);
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
            color: var(--text);
            font-size: 0.78rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            box-shadow: 0 12px 22px rgba(0,0,0,0.28);
            transition: border-color 0.2s ease, transform 0.2s ease;
        }
        .view-select:hover {
            border-color: rgba(6,182,212,0.4);
            transform: translateY(-1px);
        }
        .view-select select {
            background: transparent;
            border: none;
            color: var(--text);
            font-weight: 700;
            font-size: 0.78rem;
            outline: none;
            appearance: none;
            padding-right: 20px;
            cursor: pointer;
        }
        .view-select i.fa-chevron-down {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-left: -12px;
            pointer-events: none;
        }
        .canvas-top {
            position: absolute;
            top: 14px;
            left: 14px;
            right: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 5;
            color: var(--text);
            font-weight: 700;
            font-size: 0.78rem;
        }
        .canvas-top .chip {
            background: rgba(15,23,42,0.1);
            border-radius: 999px;
            padding: 6px 10px;
        }
        .canvas-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }
        .floating-tools {
            position: absolute;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            background: rgba(8, 10, 14, 0.92);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px;
            padding: 8px 10px;
            color: var(--text);
            z-index: 6;
            box-shadow: 0 16px 36px rgba(0,0,0,0.45);
        }
        .floating-tools i { color: var(--accent); }
        .tool-chip {
            width: 34px;
            height: 34px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.04);
            display: grid;
            place-items: center;
            color: var(--text);
            cursor: pointer;
        }
        .tool-chip:hover {
            border-color: rgba(6,182,212,0.5);
            background: rgba(6,182,212,0.16);
        }
        .zoom-pill {
            min-width: 58px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.06);
            font-size: 0.78rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tool-divider {
            width: 1px;
            background: rgba(255,255,255,0.1);
            margin: 0 2px;
        }
        .right-panel {
            grid-row: 2;
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            padding: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .right-panel .panel-shell {
            flex: 1;
        }
        .right-panel .panel-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 14px;
        }
        .right-panel.pulse {
            box-shadow: inset 0 0 0 1px rgba(6,182,212,0.6), 0 0 22px rgba(6,182,212,0.2);
        }
        .panel-block {
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px;
            margin-bottom: 14px;
            background: var(--bg-card);
        }
        .sidebar-toggle {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 54px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.16);
            background: var(--bg-card);
            color: var(--text);
            display: grid;
            place-items: center;
            cursor: pointer;
            z-index: 45;
            box-shadow: 0 10px 24px rgba(0,0,0,0.35);
            transition: transform 0.2s ease, background 0.2s ease, border-color 0.2s ease;
            backdrop-filter: blur(6px);
        }
        .sidebar-toggle:hover {
            transform: translateY(-50%) scale(1.03);
            border-color: rgba(6,182,212,0.4);
            background: rgba(6,182,212,0.12);
        }
        .left-panel .sidebar-toggle {
            right: -14px;
        }
        .right-panel .sidebar-toggle {
            left: -14px;
        }
        body.left-collapsed .editor-shell {
            grid-template-columns: 78px 0 1fr 320px;
        }
        body.right-collapsed .editor-shell {
            grid-template-columns: 78px 300px 1fr 0;
        }
        body.left-collapsed .left-panel {
            padding: 0;
            border-right: none;
            justify-content: center;
            width: 0;
            min-width: 0;
            max-width: 0;
            overflow: visible;
            pointer-events: none;
        }
        body.left-collapsed .left-panel .panel-tabs,
        body.left-collapsed .left-panel .panel-shell {
            display: none;
        }
        body.left-collapsed .left-panel .sidebar-toggle {
            pointer-events: auto;
            right: -24px;
        }
        body.right-collapsed .right-panel {
            padding: 0;
            border-left: none;
            justify-content: center;
            width: 0;
            min-width: 0;
            max-width: 0;
            overflow: visible;
            pointer-events: none;
        }
        body.right-collapsed .right-panel .panel-shell {
            display: none;
        }
        body.right-collapsed .right-panel .sidebar-toggle {
            pointer-events: auto;
            left: -24px;
        }
        .panel-block h4 {
            margin: 0 0 10px;
            font-size: 0.85rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--muted);
        }
        .action-row {
            display: flex;
            gap: 10px;
        }
        .action-btn {
            flex: 1;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.04);
            color: var(--text);
            padding: 8px 10px;
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
        }
        .action-btn:hover {
            background: rgba(255,255,255,0.08);
        }
        .action-btn.danger {
            border-color: rgba(239,68,68,0.35);
            color: #fecaca;
        }
        .upload-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.05);
            font-size: 0.75rem;
            cursor: pointer;
        }
        .upload-btn input {
            display: none;
        }
        .hint-text {
            margin-top: 8px;
            font-size: 0.7rem;
            color: var(--muted);
        }
        .gallery-upload-list {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .gallery-upload-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 8px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.03);
            font-size: 0.72rem;
        }
        .gallery-upload-thumb {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            background: rgba(255,255,255,0.08);
            object-fit: cover;
        }
        .gallery-upload-status {
            margin-left: auto;
            font-size: 0.68rem;
            color: var(--muted);
        }
        .structure-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .structure-tree {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .structure-node {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .structure-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.04);
            cursor: pointer;
            font-size: 0.72rem;
            color: var(--text);
        }
        .structure-item .name {
            font-weight: 600;
        }
        .structure-item .meta {
            color: var(--muted);
            margin-left: auto;
            font-size: 0.65rem;
        }
        .structure-toggle {
            width: 18px;
            height: 18px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.05);
            color: var(--text);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            transition: transform 0.15s ease, background 0.15s ease, border-color 0.15s ease;
        }
        .structure-toggle.hidden {
            visibility: hidden;
        }
        .structure-toggle.is-open {
            transform: rotate(90deg);
            background: rgba(6,182,212,0.18);
            border-color: rgba(6,182,212,0.5);
        }
        .structure-children {
            margin-left: 12px;
            padding-left: 10px;
            border-left: 1px dashed rgba(255,255,255,0.08);
            display: none;
            flex-direction: column;
            gap: 6px;
        }
        .structure-children.is-open {
            display: flex;
        }
        .structure-item.active {
            border-color: rgba(6,182,212,0.5);
            background: rgba(6,182,212,0.12);
            color: var(--accent);
        }
        .structure-item.drop-before {
            position: relative;
        }
        .structure-item.drop-before::before {
            content: "";
            position: absolute;
            left: 8px;
            right: 8px;
            top: -2px;
            height: 2px;
            background: rgba(6,182,212,0.85);
            border-radius: 999px;
        }
        .structure-item.drop-after {
            position: relative;
        }
        .structure-item.drop-after::after {
            content: "";
            position: absolute;
            left: 8px;
            right: 8px;
            bottom: -2px;
            height: 2px;
            background: rgba(6,182,212,0.85);
            border-radius: 999px;
        }
        .structure-item.drop-inside {
            border-color: rgba(6,182,212,0.7);
            background: rgba(6,182,212,0.08);
        }
        .structure-item .tag {
            color: var(--muted);
        }
        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.78rem;
            margin-bottom: 8px;
        }
        .mini-input {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 6px 8px;
            color: var(--text);
            width: 100%;
        }
        .double {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .label-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            font-size: 0.68rem;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 6px;
        }
        .token-top {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .token-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
        }
        .token-field label {
            font-size: 0.62rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--muted);
        }
        .token-actions {
            display: flex;
            gap: 8px;
        }
        .token-grid {
            display: grid;
            gap: 10px;
            margin-bottom: 12px;
        }
        .token-grid-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .token-grid-4 {
            grid-template-columns: repeat(4, minmax(0, 1fr));
        }
        .token-field.small .mini-input {
            text-align: center;
        }
        .token-group-title {
            font-size: 0.62rem;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: var(--muted);
            margin: 4px 0 8px;
        }
        .badge-row {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .badge {
            flex: 1;
            border-radius: 12px;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            color: var(--text);
            text-align: center;
            font-size: 0.72rem;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.15s ease, color 0.15s ease, box-shadow 0.15s ease;
        }
        .badge.is-active {
            background: rgba(56, 178, 246, 0.18);
            color: var(--text);
            box-shadow: inset 0 0 0 1px rgba(56, 178, 246, 0.5);
        }
        .badge.is-disabled {
            opacity: 0.45;
            cursor: not-allowed;
            pointer-events: none;
        }
        .right-panel .toggle-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .toggle-pill {
            padding: 6px 10px;
            border-radius: 999px;
            background: var(--bg-soft);
            color: var(--muted);
            font-size: 0.7rem;
            cursor: pointer;
            transition: background 0.15s ease, color 0.15s ease, box-shadow 0.15s ease;
        }
        .toggle-pill.is-active {
            background: rgba(56, 178, 246, 0.2);
            color: var(--text);
            box-shadow: inset 0 0 0 1px rgba(56, 178, 246, 0.45);
        }
        .utility-panel {
            position: fixed;
            left: 84px;
            bottom: 28px;
            width: 300px;
            max-height: calc(100vh - 160px);
            background: var(--bg-panel);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 18px;
            box-shadow: 0 24px 60px rgba(0,0,0,0.45);
            display: none;
            flex-direction: column;
            z-index: 40;
        }
        .utility-panel.is-open {
            display: flex;
        }
        .utility-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .utility-title {
            font-size: 0.7rem;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            color: var(--muted);
        }
        .utility-close {
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.05);
            color: var(--text);
            border-radius: 10px;
            padding: 4px 8px;
            font-size: 0.7rem;
            cursor: pointer;
        }
        .utility-body {
            padding: 12px 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
        }
        .icon-search {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.04);
            color: var(--text);
        }
        .icon-search input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            outline: none;
            font-size: 0.78rem;
        }
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(72px, 1fr));
            gap: 8px;
            max-height: 240px;
            overflow: auto;
            padding-right: 2px;
        }
        .icon-card {
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 12px;
            background: rgba(255,255,255,0.04);
            padding: 10px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: var(--muted);
            font-size: 0.65rem;
            text-align: center;
            transition: border-color 0.2s ease, transform 0.2s ease, color 0.2s ease;
        }
        .icon-card i {
            font-size: 18px;
            color: var(--text);
        }
        .icon-card:hover {
            border-color: rgba(6,182,212,0.45);
            color: var(--text);
            transform: translateY(-1px);
        }
        .utility-section {
            display: none;
            flex-direction: column;
            gap: 12px;
        }
        .utility-section.is-active {
            display: flex;
        }
        .utility-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .utility-btn {
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.05);
            color: var(--text);
            padding: 6px 10px;
            font-size: 0.72rem;
            cursor: pointer;
        }
        .utility-btn:hover {
            background: rgba(6,182,212,0.16);
            border-color: rgba(6,182,212,0.45);
        }
        .utility-btn.is-active {
            background: rgba(6,182,212,0.22);
            border-color: rgba(6,182,212,0.6);
            color: var(--text);
        }
        .utility-btn.is-loading,
        .utility-btn:disabled {
            opacity: 0.55;
            cursor: progress;
        }
        .utility-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .utility-item {
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.04);
            font-size: 0.72rem;
            color: var(--text);
        }
        .utility-item small {
            display: block;
            color: var(--muted);
            margin-top: 4px;
        }
        .motion-card {
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.03);
            border-radius: 14px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .motion-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .motion-row label {
            font-size: 0.68rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .motion-target {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text);
        }
        .motion-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
        }
        .motion-timeline {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            align-items: center;
        }
        #motionPlayhead {
            width: 100%;
        }
        .keyframe-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .keyframe-item {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 6px;
            align-items: center;
        }
        .keyframe-item input {
            width: 100%;
        }
        .keyframe-item button {
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.05);
            color: var(--text);
            padding: 4px 6px;
            cursor: pointer;
        }
        .motion-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.78rem;
        }
        .motion-badge {
            font-size: 0.68rem;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(6,182,212,0.12);
            color: var(--accent);
        }
        .settings-tabs {
            display: inline-flex;
            gap: 6px;
            background: rgba(255,255,255,0.04);
            padding: 4px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .settings-tab {
            border: none;
            background: transparent;
            color: var(--muted);
            font-size: 0.7rem;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 999px;
            cursor: pointer;
        }
        .settings-tab.is-active {
            background: rgba(6,182,212,0.18);
            color: var(--accent);
        }
        .settings-pane {
            display: none;
            flex-direction: column;
            gap: 12px;
        }
        .settings-pane.is-active {
            display: flex;
        }
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }
        .theme-card {
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.04);
            padding: 10px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: transform 0.15s ease, border-color 0.15s ease;
        }
        .theme-card:hover {
            transform: translateY(-2px);
            border-color: rgba(6,182,212,0.45);
        }
        .theme-card.is-active {
            border-color: rgba(6,182,212,0.7);
            box-shadow: inset 0 0 0 1px rgba(6,182,212,0.4);
        }
        .theme-swatch {
            height: 46px;
            border-radius: 10px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .theme-swatch span {
            display: block;
        }
        .theme-label {
            font-size: 0.72rem;
            font-weight: 700;
            color: var(--text);
        }
        .theme-controls {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }
        .theme-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .theme-field label {
            font-size: 0.62rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--muted);
        }
        .theme-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .theme-input input[type="color"] {
            width: 30px;
            height: 30px;
            border-radius: 10px;
            border: none;
            background: none;
            padding: 0;
            cursor: pointer;
        }
        .theme-input span {
            font-size: 0.72rem;
            color: var(--text);
        }
        .variant-modal {
            position: fixed;
            inset: 0;
            background: rgba(3,6,10,0.75);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 90;
        }
        .variant-modal.active {
            display: flex;
        }
        .variant-card-shell {
            width: min(720px, 92vw);
            max-height: 82vh;
            background: #0a0d12;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .variant-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .variant-title {
            font-size: 0.8rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--muted);
            font-weight: 700;
        }
        .variant-grid {
            padding: 18px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 14px;
            overflow-y: auto;
        }
        .variant-card {
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.03);
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            cursor: pointer;
            transition: transform 0.15s ease, border-color 0.15s ease;
        }
        .variant-card:hover {
            transform: translateY(-2px);
            border-color: rgba(6,182,212,0.5);
        }
        .variant-preview {
            min-height: 64px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.08);
            display: grid;
            place-items: center;
            background: rgba(255,255,255,0.03);
        }
        .variant-meta strong {
            display: block;
            font-size: 0.75rem;
            color: var(--text);
        }
        .variant-meta span {
            font-size: 0.68rem;
            color: var(--muted);
        }
        .text-mode-tooltip {
            position: fixed;
            z-index: 2147483647;
            background: var(--bg-panel);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text);
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 0.7rem;
            letter-spacing: 0.01em;
            box-shadow: 0 12px 24px rgba(0,0,0,0.35);
            opacity: 0;
            transform: translateY(4px);
            transition: opacity 0.18s ease, transform 0.18s ease;
            pointer-events: none;
        }
        .text-mode-tooltip.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
        .autosave-toast {
            position: fixed;
            right: 24px;
            bottom: 24px;
            background: var(--bg-panel);
            border: 1px solid rgba(255,255,255,0.12);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.78rem;
            letter-spacing: 0.01em;
            box-shadow: 0 16px 32px rgba(0,0,0,0.4);
            opacity: 0;
            transform: translateY(8px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            pointer-events: none;
            z-index: 2147483647;
        }
        .autosave-toast.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
        .warn-icon {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            color: #fbbf24;
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        .warn-icon.is-visible {
            opacity: 1;
        }
        .selection-meta {
            font-size: 0.72rem;
            color: var(--muted);
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }
        .selection-meta strong {
            color: var(--text);
            font-weight: 700;
        }
        .selection-selector {
            margin-top: 8px;
            padding: 6px 8px;
            border-radius: 8px;
            background: rgba(255,255,255,0.06);
            font-family: "JetBrains Mono", monospace;
            font-size: 0.68rem;
            color: var(--text);
            word-break: break-all;
        }
        .color-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 0.78rem;
            margin-bottom: 8px;
        }
        .color-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.72rem;
            color: var(--text);
        }
        .color-pill.is-transparent {
            background:
                linear-gradient(45deg, rgba(255,255,255,0.08) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.08) 75%),
                linear-gradient(45deg, rgba(255,255,255,0.08) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.08) 75%);
            background-position: 0 0, 8px 8px;
            background-size: 16px 16px;
        }
        .color-input {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: none;
            background: none;
            padding: 0;
            cursor: pointer;
        }
        .color-input::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .color-input::-webkit-color-swatch {
            border: 1px solid rgba(255,255,255,0.35);
            border-radius: 50%;
        }
        .color-input.is-disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }
        .appearance-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 0.75rem;
            color: var(--muted);
            margin: 6px 0 10px;
        }
        .appearance-toggle label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }
        .select-shell {
            position: relative;
            width: 100%;
        }
        .select-shell select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding-right: 28px;
            cursor: pointer;
        }
        .select-shell::after {
            content: "";
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 6px solid rgba(255,255,255,0.6);
            pointer-events: none;
        }
        @@media (max-width: 1200px) {
            .editor-shell { grid-template-columns: 62px 260px 1fr 280px; }
        }
        @@media (max-width: 980px) {
            body {
                overflow: hidden;
            }
            .editor-shell {
                grid-template-columns: 60px 1fr;
                grid-template-rows: auto 1fr;
                min-height: 100dvh;
            }
            .topbar {
                grid-column: 1 / -1;
                position: sticky;
                top: 0;
                z-index: 100;
            }
            .mini-toolbar {
                grid-row: 2;
                z-index: 90;
            }
            .canvas-area {
                grid-column: 2;
                grid-row: 2;
                min-width: 0;
            }
            .left-panel,
            .right-panel {
                grid-column: auto;
                grid-row: auto;
                position: fixed;
                top: calc(76px + env(safe-area-inset-top));
                bottom: 12px;
                width: min(88vw, 360px);
                max-width: 360px;
                z-index: 180;
                transition: transform 0.22s ease;
                box-shadow: 0 24px 50px rgba(0, 0, 0, 0.55);
            }
            .left-panel {
                left: 8px;
                transform: translateX(-112%);
                border-radius: 16px;
            }
            .right-panel {
                right: 8px;
                transform: translateX(112%);
                border-radius: 16px;
            }
            body.editor-mobile-left-open .left-panel {
                transform: translateX(0);
            }
            body.editor-mobile-right-open .right-panel {
                transform: translateX(0);
            }
            .sidebar-toggle {
                top: 20px;
                transform: none;
            }
            .left-panel .sidebar-toggle { right: 12px; }
            .right-panel .sidebar-toggle { left: 12px; }
            .editor-mobile-panel-btn {
                display: inline-flex !important;
            }
            .utility-panel {
                width: min(92vw, 420px);
                right: 8px;
                top: calc(76px + env(safe-area-inset-top));
                bottom: 12px;
                border-radius: 16px;
                transform: translateX(112%);
                z-index: 190;
            }
            .utility-panel.is-open {
                transform: translateX(0);
            }
            .floating-panel {
                left: 8px;
                right: 8px;
                top: calc(88px + env(safe-area-inset-top));
                width: auto;
                max-height: 52dvh;
                z-index: 192;
            }
        }
        @@media (max-width: 720px) {
            .topbar { gap: 10px; padding: 12px; align-items: stretch; }
            .top-actions { flex-wrap: wrap; width: 100%; }
            .canvas-wrap { height: calc(100dvh - 230px); }
            .file-meta { display: none; }
            .btn { padding: 9px 12px; border-radius: 10px; }
            .left-panel,
            .right-panel {
                top: calc(70px + env(safe-area-inset-top));
                bottom: 8px;
                width: calc(100vw - 16px);
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <form id="antiforgeryForm" style="display:none;">
        @Html.AntiForgeryToken()
    </form>
    <div class="editor-shell">
        <div class="topbar">
            <div style="display:flex; align-items:center;">
                <a class="brand" href="/Dashboard/Index" aria-label="Go to Dashboard">
                    <img src="/favicon.ico" alt="Bugence">
                    <span>BUGENCE</span>
                </a>
                <div class="file-meta">
                    <span>@Model.FileName</span>
                    <span>@Model.ProjectName  Canvas Editor</span>
                </div>
            </div>
            <div class="top-actions">
                <button class="btn ghost editor-mobile-panel-btn" id="mobileLeftPanelBtn" type="button"><i class="fa-solid fa-bars"></i></button>
                <button class="btn ghost editor-mobile-panel-btn" id="mobileRightPanelBtn" type="button"><i class="fa-solid fa-sliders"></i></button>
                <span class="view-select">
                    <i class="fa-solid fa-display"></i>
                    <select id="deviceSelect" aria-label="Device Preview">
                        <option value="desktop" selected>Desktop</option>
                        <option value="tablet">Tablet</option>
                        <option value="mobile">Mobile</option>
                    </select>
                    <i class="fa-solid fa-chevron-down"></i>
                </span>
                <button class="btn ghost" id="undoBtn"><i class="fa-solid fa-rotate-left"></i> Undo</button>
                <button class="btn ghost" id="redoBtn"><i class="fa-solid fa-rotate-right"></i> Redo</button>
                <button class="btn ghost" id="templatesBtn"><i class="fa-solid fa-layer-group"></i> Templates</button>
                <button class="btn ghost" id="createNewBtn"><i class="fa-solid fa-plus"></i> Create New</button>
                <button class="btn ghost" id="shareBtn"><i class="fa-solid fa-share-nodes"></i> Share</button>
                <button class="btn ghost" id="missingAssetsBtn"><i class="fa-solid fa-triangle-exclamation"></i> Missing Assets</button>
                <span class="pill integrity-pill" id="integrityBadge"><i class="fa-solid fa-shield-check"></i> Integrity: Unknown</span>
                <button class="btn ghost" id="openPreviewBtn"><i class="fa-solid fa-eye"></i> Preview</button>
                <button class="btn ghost" id="openPublishedBtn"><i class="fa-solid fa-up-right-from-square"></i> Live</button>
                <button class="btn ghost" id="restoreSnapshotBtn"><i class="fa-solid fa-life-ring"></i> Restore</button>
                <button class="btn primary" id="saveBtn"><i class="fa-solid fa-floppy-disk"></i> Save</button>
                <button class="btn publish" id="publishBtn"><i class="fa-solid fa-rocket"></i> Publish</button>
            </div>
        </div>

        <aside class="mini-toolbar">
            <div class="tool-btn active" data-tooltip="Elements" data-tool="elements" title="Elements"><i class="fa-solid fa-cube"></i></div>
            <div class="tool-btn" data-tooltip="Shapes" data-tool="drawer" data-drawer="shapes" title="Shapes"><i class="fa-solid fa-shapes"></i></div>
            <div class="tool-btn" data-tooltip="Icons" data-tool="utility" data-utility="icons" title="Icons"><i class="fa-solid fa-icons"></i></div>
            <div class="tool-btn" data-tooltip="Tools" data-tool="drawer" data-drawer="tools" title="Tools"><i class="fa-solid fa-toolbox"></i></div>
            <div class="tool-btn" data-tooltip="Style" data-tool="utility" data-utility="style" title="Style"><i class="fa-solid fa-pen-ruler"></i></div>
            <div class="tool-btn" data-tooltip="AI Assist" data-tool="utility" data-utility="ai" title="AI Assist"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
            <div class="tool-btn" data-tooltip="Motion Studio" data-tool="utility" data-utility="motion" title="Motion Studio"><i class="fa-solid fa-wave-square"></i></div>
            <div class="tool-btn" data-tooltip="Layers" data-tool="layers" title="Layers"><i class="fa-solid fa-object-group"></i></div>
            <div class="tool-btn" data-tooltip="Search" data-tool="utility" data-utility="search" title="Search"><i class="fa-solid fa-magnifying-glass"></i></div>
            <div class="tool-btn" data-tooltip="History" data-tool="utility" data-utility="history" title="History"><i class="fa-solid fa-clock-rotate-left"></i></div>
            <div class="tool-btn" data-tooltip="Settings" data-tool="utility" data-utility="settings" title="Settings"><i class="fa-solid fa-gear"></i></div>
        </aside>
        <div class="tool-drawer" id="toolDrawer" data-mode="shapes">
            <div data-drawer-section="shapes">
                <div class="tool-group-title">Shapes</div>
                <div class="tool-grid">
                    <button class="tool-item" data-tool-shape="shape-rect" type="button"><i class="fa-regular fa-square"></i>Rect</button>
                    <button class="tool-item" data-tool-shape="shape-circle" type="button"><i class="fa-regular fa-circle"></i>Circle</button>
                    <button class="tool-item" data-tool-shape="shape-pill" type="button"><i class="fa-solid fa-capsules"></i>Pill</button>
                    <button class="tool-item" data-tool-shape="shape-triangle" type="button"><i class="fa-solid fa-play"></i>Triangle</button>
                    <button class="tool-item" data-tool-shape="shape-hex" type="button"><i class="fa-solid fa-draw-polygon"></i>Hex</button>
                    <button class="tool-item" data-tool-shape="shape-star" type="button"><i class="fa-solid fa-star"></i>Star</button>
                    <button class="tool-item" data-tool-shape="shape-ring" type="button"><i class="fa-regular fa-circle-dot"></i>Ring</button>
                    <button class="tool-item" data-tool-shape="shape-wave" type="button"><i class="fa-solid fa-wave-square"></i>Wave</button>
                    <button class="tool-item" data-tool-shape="shape-blob" type="button"><i class="fa-solid fa-droplet"></i>Blob</button>
                    <button class="tool-item" data-tool-shape="shape-line" type="button"><i class="fa-solid fa-minus"></i>Line</button>
                    <button class="tool-item" data-tool-shape="shape-arrow" type="button"><i class="fa-solid fa-arrow-right"></i>Arrow</button>
                </div>
            </div>
            <div data-drawer-section="tools">
                <div class="tool-group-title">Tools</div>
                <a href="/Tools/Applications" class="nav-item"><i class="fa-solid fa-table nav-icon"></i> Applications</a>
                <a href="/Tools/DatabaseQuerySelector" class="nav-item"><i class="fa-solid fa-database nav-icon"></i> Database Query Selector</a>
            <a href="/Tools/TempleteViewer" class="nav-item"><i class="fa-solid fa-layer-group nav-icon"></i> Templete Viewer</a>
            <a href="/Tools/ReactBuilder" class="nav-item"><i class="fa-brands fa-react nav-icon"></i> React Builder</a>
                <div class="tool-grid">
                    <button class="tool-item" data-tool-toggle="canvas-grid" type="button"><i class="fa-solid fa-border-all"></i>Grid</button>
                    <button class="tool-item" data-tool-toggle="focus-mode" type="button"><i class="fa-solid fa-eye"></i>Focus</button>
                </div>
            </div>
        </div>
        <div class="utility-panel" id="utilityPanel">
            <div class="utility-header">
                <div class="utility-title" id="utilityTitle">Quick Tools</div>
                <button class="utility-close" id="utilityCloseBtn" type="button">Close</button>
            </div>
            <div class="utility-body">
                <div class="utility-section" data-utility-panel="ai">
                    <div style="font-weight:600;">AI Assist</div>
                    <textarea class="mini-input" id="aiPromptInput" placeholder="Describe what you want to rewrite..." style="min-height:90px;resize:vertical;"></textarea>
                    <div class="utility-actions">
                        <button class="utility-btn" data-ai-action="improve" type="button">Polish</button>
                        <button class="utility-btn" data-ai-action="shorten" type="button">Shorten</button>
                        <button class="utility-btn" data-ai-action="expand" type="button">Expand</button>
                        <button class="utility-btn" data-ai-action="title" type="button">Title Case</button>
                        <button class="utility-btn" data-ai-action="bullets" type="button">Make Bullets</button>
                        <button class="utility-btn" data-ai-action="clear" type="button">Clear</button>
                    </div>
                    <div class="hint-text">Works on the current selection or the prompt text.</div>
                </div>
                <div class="utility-section" data-utility-panel="motion">
                    <div style="font-weight:600;">Motion Studio</div>
                    <div class="motion-card">
                        <div class="motion-target">
                            <span id="motionTargetLabel">No selection</span>
                            <span class="motion-badge" id="motionTrackBadge">Opacity</span>
                        </div>
                        <div class="motion-row">
                            <label>Property</label>
                            <select class="mini-input" id="motionPropertySelect">
                                <option value="opacity">Opacity</option>
                                <option value="translateY">Translate Y</option>
                                <option value="scale">Scale</option>
                                <option value="rotate">Rotate</option>
                            </select>
                        </div>
                        <div class="motion-row">
                            <label>Easing</label>
                            <select class="mini-input" id="motionEasingSelect">
                                <option value="linear">Linear</option>
                                <option value="ease">Ease</option>
                                <option value="ease-in-out">Ease In Out</option>
                                <option value="ease-out">Ease Out</option>
                            </select>
                        </div>
                        <div class="motion-row">
                            <label>Timeline</label>
                            <div class="motion-timeline">
                                <input type="range" id="motionPlayhead" min="0" max="100" value="0">
                                <span id="motionPlayheadValue">0%</span>
                            </div>
                        </div>
                        <div class="utility-actions">
                            <button class="utility-btn" id="motionAddKeyframeBtn" type="button">Add Keyframe</button>
                            <button class="utility-btn" id="motionClearKeyframesBtn" type="button">Clear Track</button>
                        </div>
                        <div class="keyframe-list" id="motionKeyframes"></div>
                    </div>
                    <div class="motion-card">
                        <div style="font-weight:600;">Scroll Triggers</div>
                        <label class="motion-toggle"><input type="checkbox" id="motionScrollEnabled"> Enable scroll animation</label>
                        <div class="motion-grid">
                            <div class="motion-row">
                                <label>Start %</label>
                                <input class="mini-input" id="motionScrollStart" type="number" min="0" max="100" value="10">
                            </div>
                            <div class="motion-row">
                                <label>End %</label>
                                <input class="mini-input" id="motionScrollEnd" type="number" min="0" max="100" value="90">
                            </div>
                            <div class="motion-row">
                                <label>Scrub</label>
                                <input class="mini-input" id="motionScrollScrub" type="number" min="0" max="1" step="0.05" value="1">
                            </div>
                        </div>
                        <div class="hint-text">Offsets are based on viewport height.</div>
                    </div>
                    <div class="motion-card">
                        <div style="font-weight:600;">Lottie</div>
                        <input class="mini-input" id="lottieUrlInput" placeholder="https://.../animation.json">
                        <div class="motion-grid">
                            <label class="motion-toggle"><input type="checkbox" id="lottieLoopInput" checked> Loop</label>
                            <label class="motion-toggle"><input type="checkbox" id="lottieAutoplayInput" checked> Autoplay</label>
                        </div>
                        <div class="utility-actions">
                            <button class="utility-btn" id="applyLottieBtn" type="button">Apply Lottie</button>
                            <button class="utility-btn" id="pickLottieBtn" type="button">Pick Asset</button>
                            <button class="utility-btn" id="lottieScrubBtn" type="button">Scrub Preview</button>
                        </div>
                    </div>
                    <div class="motion-card">
                        <div style="font-weight:600;">SVG Paths</div>
                        <div class="keyframe-list" id="svgPathList"></div>
                    </div>
                </div>
                <div class="utility-section" data-utility-panel="icons">
                    <div style="font-weight:600;">Icons</div>
                    <div class="icon-search">
                        <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                        <input id="iconSearchInput" placeholder="Search icons...">
                    </div>
                    <div class="icon-grid" id="iconGrid"></div>
                    <div class="hint-text">Click an icon to insert it on the canvas.</div>
                </div>
                <div class="utility-section" data-utility-panel="search">
                    <div style="font-weight:600;">Search Canvas</div>
                    <input class="mini-input" id="canvasSearchInput" placeholder="Search text or tag (e.g. h2)" />
                    <div class="utility-list" id="canvasSearchResults"></div>
                </div>
                <div class="utility-section" data-utility-panel="history">
                    <div style="font-weight:600;">History</div>
                    <div class="utility-actions">
                        <button class="utility-btn" id="historyUndoBtn" type="button">Undo</button>
                        <button class="utility-btn" id="historyRedoBtn" type="button">Redo</button>
                        <button class="utility-btn" id="historyClearBtn" type="button">Clear</button>
                    </div>
                    <div class="utility-list" id="historyList"></div>
                </div>
                <div class="utility-section" data-utility-panel="settings">
                    <div style="font-weight:600;">Editor Settings</div>
                    <div class="settings-tabs">
                        <button class="settings-tab is-active" data-settings-tab="prefs" type="button">Preferences</button>
                        <button class="settings-tab" data-settings-tab="theme" type="button">Customize Editor</button>
                    </div>
                    <div class="settings-pane is-active" data-settings-pane="prefs">
                        <div class="utility-actions">
                            <button class="utility-btn" data-setting="grid" type="button">Toggle Grid</button>
                            <button class="utility-btn" data-setting="focus" type="button">Focus Mode</button>
                            <button class="utility-btn" data-setting="inline-add" type="button">Inline Add</button>
                        </div>
                        <div class="hint-text">Settings apply to the live canvas.</div>
                    </div>
                    <div class="settings-pane" data-settings-pane="theme">
                        <div class="theme-grid" id="editorThemeGrid"></div>
                        <div class="theme-controls">
                            <div class="theme-field">
                                <label for="editorThemeBg">Background</label>
                                <div class="theme-input">
                                    <input type="color" id="editorThemeBg">
                                    <span id="editorThemeBgValue">#050505</span>
                                </div>
                            </div>
                            <div class="theme-field">
                                <label for="editorThemePanel">Panel</label>
                                <div class="theme-input">
                                    <input type="color" id="editorThemePanel">
                                    <span id="editorThemePanelValue">#0d0d0d</span>
                                </div>
                            </div>
                            <div class="theme-field">
                                <label for="editorThemeCard">Card</label>
                                <div class="theme-input">
                                    <input type="color" id="editorThemeCard">
                                    <span id="editorThemeCardValue">#161616</span>
                                </div>
                            </div>
                            <div class="theme-field">
                                <label for="editorThemeBorder">Border</label>
                                <div class="theme-input">
                                    <input type="color" id="editorThemeBorder">
                                    <span id="editorThemeBorderValue">#2a2a2a</span>
                                </div>
                            </div>
                            <div class="theme-field">
                                <label for="editorThemeText">Text</label>
                                <div class="theme-input">
                                    <input type="color" id="editorThemeText">
                                    <span id="editorThemeTextValue">#f8f8f8</span>
                                </div>
                            </div>
                            <div class="theme-field">
                                <label for="editorThemeMuted">Muted</label>
                                <div class="theme-input">
                                    <input type="color" id="editorThemeMuted">
                                    <span id="editorThemeMutedValue">#a3a3a3</span>
                                </div>
                            </div>
                            <div class="theme-field">
                                <label for="editorThemeAccent">Accent</label>
                                <div class="theme-input">
                                    <input type="color" id="editorThemeAccent">
                                    <span id="editorThemeAccentValue">#ffffff</span>
                                </div>
                            </div>
                            <div class="theme-field">
                                <label for="editorThemeAccent2">Accent 2</label>
                                <div class="theme-input">
                                    <input type="color" id="editorThemeAccent2">
                                    <span id="editorThemeAccent2Value">#ffffff</span>
                                </div>
                            </div>
                            <div class="theme-field" style="grid-column: span 2;">
                                <label for="customThemeName">Custom Theme Name</label>
                                <input class="mini-input" id="customThemeName" placeholder="e.g. Studio Crimson">
                            </div>
                        </div>
                        <div class="action-row">
                            <button class="action-btn" id="saveCustomThemeBtn" type="button">Save Theme</button>
                            <button class="action-btn" id="resetEditorThemeBtn" type="button">Reset Theme</button>
                        </div>
                    </div>
                </div>
                <div class="utility-section" data-utility-panel="style">
                    <div style="font-weight:600;">Quick Style</div>
                    <div class="utility-actions">
                        <button class="utility-btn" data-style-action="accent" type="button">Accent Glow</button>
                        <button class="utility-btn" data-style-action="soft-shadow" type="button">Soft Shadow</button>
                        <button class="utility-btn" data-style-action="reset" type="button">Reset Styles</button>
                    </div>
                    <div class="hint-text">Applies to the selected element.</div>
                </div>
            </div>
        </div>

        <aside class="left-panel">
            <div class="panel-tabs">
                <div class="tab active" data-tab="elements">Elements</div>
                <div class="tab" data-tab="structure">Structure</div>
                <div class="tab" data-tab="pages">Pages</div>
            </div>
            <div class="panel-shell">
                <div class="panel-body" id="panelElements">
                    <input class="search" id="elementsSearch" placeholder="Search elements...">
                    <div id="elementsScroll">
                        <div class="favorites" id="elementsFavorites"></div>
                        <div id="elementsCatalog"></div>
                    </div>
                    <div class="ai-cta">
                        <div class="ai-cta-header">
                            <div>
                                <div class="ai-cta-title">Launch AI Studio</div>
                                <div class="ai-cta-sub">Generate layouts, rewrite copy, and remix sections in seconds.</div>
                            </div>
                            <span class="ai-pill">New</span>
                        </div>
                        <div class="ai-cta-actions">
                            <button class="btn ai-primary" id="launchAiStudioBtn" type="button">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> Launch AI Studio
                            </button>
                        </div>
                        <div class="ai-cta-footer"><i class="fa-solid fa-bolt"></i> Works with the current selection.</div>
                    </div>
                </div>
                <div class="panel-body" id="panelStructure" style="display:none;">
                    <div class="section-title">Layers</div>
                    <div id="structureDockTarget"></div>
                </div>
                <div class="panel-body" id="panelPages" style="display:none;">
                    <div class="pages-header">
                        <div class="section-title" style="margin:0;">Pages</div>
                        <button class="btn ghost" id="newPageBtn" type="button"><i class="fa-solid fa-plus"></i> New</button>
                    </div>
                    <input class="search" id="pagesSearch" placeholder="Search pages...">
                    <div class="pages-list" id="pagesList"></div>
                    <div class="pages-form" id="pagesForm" style="display:none;">
                        <div class="section-title" style="margin:0 0 8px;">Create Page</div>
                        <div class="control-row"><span>Name</span></div>
                        <input class="mini-input" id="pageNameInput" placeholder="About Us">
                        <div class="control-row" style="margin-top:8px;"><span>Path</span></div>
                        <input class="mini-input" id="pagePathInput" placeholder="about.html">
                        <div class="control-row" style="margin-top:8px;"><span>Template</span></div>
                        <select class="mini-input" id="pageTemplateInput">
                            <option value="blank">Blank</option>
                            <option value="hero">Hero + CTA</option>
                            <option value="contact">Contact</option>
                        </select>
                        <div class="action-row" style="margin-top:10px;">
                            <button class="action-btn" id="createPageBtn" type="button">Create Page</button>
                            <button class="action-btn danger" id="cancelPageBtn" type="button">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
            <button class="sidebar-toggle" id="leftPanelToggle" type="button" title="Toggle sidebar">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
        </aside>

        <div class="floating-panel" id="structureFloating">
            <div class="panel-header" id="structureDragHandle">
                <span>Structure</span>
                <div class="action-row">
                    <button class="action-btn" id="dockStructureBtn" type="button">Dock</button>
                    <button class="action-btn danger" id="closeStructureBtn" type="button">Close</button>
                </div>
            </div>
            <div class="panel-body" id="structureFloatTarget"></div>
        </div>
        <div class="dock-pill" id="structureDockPill"><i class="fa-solid fa-diagram-project"></i> Structure</div>

        <div class="grid-chooser" id="gridChooser">
            <div class="panel">
                <h4>Select grid columns</h4>
                <div class="grid-options">
                    <div class="grid-option" data-cols="2">2 Columns</div>
                    <div class="grid-option" data-cols="3">3 Columns</div>
                    <div class="grid-option" data-cols="4">4 Columns</div>
                    <div class="grid-option" data-cols="6">6 Columns</div>
                </div>
            </div>
        </div>

        <section class="canvas-area">
            <div class="canvas-header">
                <div class="canvas-path">
                    <i class="fa-solid fa-link"></i>
                    <span>@Model.ResolvedPath/@Model.FileName</span>
                </div>
            <button class="canvas-pill" id="liveCanvasToggle" type="button"><i class="fa-solid fa-wave-square"></i> Live Canvas</button>
            </div>
            <div class="canvas-wrap">
                <div class="canvas-top">
                </div>
                <div class="canvas-pause" id="canvasPauseOverlay">
                    <div style="font-weight:700;">Canvas Paused</div>
                    <div style="opacity:0.7;font-size:0.8rem;">Resume to interact with and edit the page.</div>
                    <button class="btn ghost" id="resumeCanvasBtn" type="button">Resume</button>
                </div>
                <iframe class="canvas-frame" src="@Model.PreviewUrl" title="Live Canvas"></iframe>
                <div class="floating-tools" id="canvasToolbar">
                    <button class="tool-chip" data-zoom="out" title="Zoom out"><i class="fa-solid fa-minus"></i></button>
                    <div class="zoom-pill"><span id="canvasZoomLabel">100%</span></div>
                    <button class="tool-chip" data-zoom="in" title="Zoom in"><i class="fa-solid fa-plus"></i></button>
                    <button class="tool-chip" data-zoom="reset" title="Reset zoom"><i class="fa-solid fa-crosshairs"></i></button>
                    <div class="tool-divider"></div>
                    <button class="tool-chip" data-canvas-action="fit" title="Fit to view"><i class="fa-solid fa-expand"></i></button>
                    <button class="tool-chip" data-canvas-action="grid" title="Toggle grid"><i class="fa-solid fa-border-all"></i></button>
                    <button class="tool-chip" data-canvas-action="center" title="Center canvas"><i class="fa-solid fa-location-crosshairs"></i></button>
                </div>
            </div>
        </section>

        <aside class="right-panel">
            <div class="panel-shell">
                <div class="panel-scroll">
            <div class="panel-block">
                <h4>Selection</h4>
                <div class="selection-meta">
                    <span id="selectionTag">None</span>
                    <strong id="selectionSummary">Select an element</strong>
                </div>
                <div class="selection-selector" id="selectionSelector"></div>
            </div>
            <div class="panel-block">
                <h4>Link Settings</h4>
                <div class="control-row">
                    <span>URL</span>
                    <span style="color:var(--accent); font-weight:700;">Valid</span>
                </div>
                <input class="mini-input" id="linkUrlInput" value="https://bugence.app">
                <div class="control-row" style="margin-top:10px;">
                    <span>Workflow Trigger</span>
                    <span style="color:var(--muted); font-size:0.75rem;">Optional</span>
                </div>
                <select class="mini-input" id="workflowSelect">
                    <option value="">No workflow</option>
                </select>
                <div style="font-size:0.75rem; color:var(--muted); margin-top:6px;">
                    Attach a workflow that triggers on click for this element.
                </div>
            </div>
            <div class="panel-block">
                <h4>Typography</h4>
                <div class="control-row"><span>Weight</span><span id="fontWeightLabel">600 Bold</span></div>
                <div class="double">
                    <div class="select-shell">
                        <select class="mini-input" id="fontFamilyInput">
                            <option value="Inter Tight">Inter Tight</option>
                            <option value="Inter">Inter</option>
                            <option value="Poppins">Poppins</option>
                            <option value="Manrope">Manrope</option>
                            <option value="Plus Jakarta Sans">Plus Jakarta Sans</option>
                            <option value="DM Sans">DM Sans</option>
                            <option value="Space Grotesk">Space Grotesk</option>
                            <option value="IBM Plex Sans">IBM Plex Sans</option>
                            <option value="Montserrat">Montserrat</option>
                            <option value="Raleway">Raleway</option>
                            <option value="Sora">Sora</option>
                            <option value="Outfit">Outfit</option>
                            <option value="Rubik">Rubik</option>
                            <option value="Work Sans">Work Sans</option>
                            <option value="Lato">Lato</option>
                            <option value="Nunito">Nunito</option>
                            <option value="Merriweather">Merriweather</option>
                            <option value="Playfair Display">Playfair Display</option>
                            <option value="Bebas Neue">Bebas Neue</option>
                            <option value="Oswald">Oswald</option>
                            <option value="Roboto Slab">Roboto Slab</option>
                            <option value="Source Sans 3">Source Sans 3</option>
                            <option value="system-ui">system-ui</option>
                        </select>
                    </div>
                    <input class="mini-input" id="fontSizeInput" value="16px">
                </div>
                <div class="control-row" style="margin-top:8px;">
                    <span>Text</span>
                    <span class="warn-icon" id="textEditWarning"><i class="fa-solid fa-triangle-exclamation"></i> Not editable</span>
                </div>
                <input class="mini-input" id="textContentInput" placeholder="Edit selected text..." spellcheck="false">
                <div class="badge-row" style="margin-top:8px;">
                    <div class="badge" data-textmode="html">HTML</div>
                    <div class="badge is-active" data-textmode="plain">Plain</div>
                </div>
                <div class="badge-row">
                    <div class="badge" data-align="left">Left</div>
                    <div class="badge" data-align="center">Center</div>
                    <div class="badge" data-align="right">Right</div>
                </div>
            </div>
            <div class="panel-block">
                <h4>Appearance</h4>
                <div class="color-row">
                    <span>Text</span>
                    <span class="color-pill">
                        <input type="color" id="textColorInput" class="color-input" value="#111111">
                        <span id="textColorValue">#111111</span>
                    </span>
                </div>
                <div class="color-row">
                    <span>Background</span>
                    <span class="color-pill" id="bgColorPill">
                        <input type="color" id="bgColorInput" class="color-input" value="#38B2F6">
                        <span id="bgColorValue">#38B2F6</span>
                    </span>
                </div>
                <div class="appearance-toggle">
                    <span>Background Mode</span>
                    <label>
                        <input type="checkbox" id="bgTransparentToggle">
                        Use Transparent
                    </label>
                </div>
                <div class="control-row">
                    <span>Corner Radius</span>
                    <input class="mini-input" id="radiusInput" value="12px" style="max-width:120px;">
                </div>
            </div>
            <div class="panel-block" id="elementActions" style="display:none;">
                <h4>Element Actions</h4>
                <div class="action-row">
                    <button class="action-btn" id="duplicateElementBtn" type="button">Duplicate</button>
                    <button class="action-btn danger" id="deleteElementBtn" type="button">Delete</button>
                </div>
                <div class="action-row" style="margin-top:10px;">
                    <button class="action-btn" id="saveSymbolBtn" type="button">Save as Symbol</button>
                    <button class="action-btn" id="updateSymbolBtn" type="button" style="display:none;">Update Instances</button>
                </div>
            </div>
            <div class="panel-block" id="mediaControls" style="display:none;">
                <h4>Media</h4>
                <input class="mini-input" id="mediaUrlInput" placeholder="Paste image/video URL">
                <div class="action-row" style="margin-top:10px;">
                    <button class="action-btn" id="mediaChooseBtn" type="button">Choose from Assets</button>
                </div>
                <div class="control-row" style="margin-top:10px;">
                    <span>Upload</span>
                    <label class="upload-btn">
                        <input type="file" id="mediaUploadInput" accept="image/*,video/*">
                        Choose file
                    </label>
                </div>
                <div class="hint-text" id="mediaHint">Supports images and videos.</div>
            </div>
            <div class="panel-block" id="layoutControls" style="display:none;">
                <h4>Layout</h4>
                <div class="control-row">
                    <span>Columns</span>
                    <input class="mini-input" id="gridColsInput" value="3" style="max-width:90px;">
                </div>
                <div class="control-row">
                    <span>Rows</span>
                    <input class="mini-input" id="gridRowsInput" value="auto" style="max-width:90px;">
                </div>
                <div class="control-row">
                    <span>Gap</span>
                    <input class="mini-input" id="gridGapInput" value="12" style="max-width:90px;">
                </div>
                <div class="control-row">
                    <span>Auto Flow</span>
                    <select class="mini-input" id="gridFlowInput" style="max-width:120px;">
                        <option value="row">Row</option>
                        <option value="column">Column</option>
                    </select>
                </div>
            </div>
            <div class="panel-block" id="mapControls" style="display:none;">
                <h4>Map</h4>
                <div class="control-row">
                    <span>Location</span>
                </div>
                <input class="mini-input" id="mapLocationInput" placeholder="e.g., Dubai Silicon Oasis">
                <div class="control-row" style="margin-top:10px;">
                    <span>Zoom</span>
                    <input class="mini-input" id="mapZoomInput" value="12" style="max-width:90px;">
                </div>
            </div>
            <div class="panel-block" id="fieldControls" style="display:none;">
                <h4>Field</h4>
                <div class="control-row">
                    <span>Placeholder</span>
                </div>
                <input class="mini-input" id="fieldPlaceholderInput" placeholder="Placeholder text">
            </div>
            <div class="panel-block" id="carouselControls" style="display:none;">
                <h4>Carousel</h4>
                <div class="action-row">
                    <button class="action-btn" id="addCarouselSlideBtn" type="button">Add Slide</button>
                    <button class="action-btn danger" id="removeCarouselSlideBtn" type="button">Remove</button>
                </div>
            </div>
            <div class="panel-block" id="tabsControls" style="display:none;">
                <h4>Tabs</h4>
                <div class="action-row">
                    <button class="action-btn" id="addTabBtn" type="button">Add Tab</button>
                    <button class="action-btn danger" id="removeTabBtn" type="button">Remove Tab</button>
                </div>
            </div>
            <div class="panel-block" id="accordionControls" style="display:none;">
                <h4>Accordion</h4>
                <div class="action-row">
                    <button class="action-btn" id="addAccordionItemBtn" type="button">Add Item</button>
                    <button class="action-btn danger" id="removeAccordionItemBtn" type="button">Remove</button>
                </div>
            </div>
            <div class="panel-block" id="pricingControls" style="display:none;">
                <h4>Pricing</h4>
                <div class="control-row">
                    <span>Plan</span>
                </div>
                <input class="mini-input" id="pricingTitleInput" placeholder="Starter">
                <div class="control-row" style="margin-top:10px;">
                    <span>Price</span>
                </div>
                <input class="mini-input" id="pricingPriceInput" placeholder="$19">
                <div class="control-row" style="margin-top:10px;">
                    <span>Description</span>
                </div>
                <input class="mini-input" id="pricingDescInput" placeholder="Short description">
            </div>
            <div class="panel-block" id="galleryControls" style="display:none;">
                <h4>Gallery</h4>
                <div class="action-row">
                    <button class="action-btn" id="addGalleryImageBtn" type="button">Add Image</button>
                    <button class="action-btn danger" id="removeGalleryImageBtn" type="button">Remove</button>
                </div>
                <div class="control-row" style="margin-top:10px;">
                    <span>Image URL</span>
                </div>
                <input class="mini-input" id="galleryImageUrlInput" placeholder="Paste image URL">
                <div class="control-row" style="margin-top:10px;">
                    <span>Upload</span>
                    <label class="upload-btn">
                        <input type="file" id="galleryUploadInput" accept="image/*" multiple>
                        Choose file
                    </label>
                </div>
                <div class="hint-text" id="galleryUploadHint">Supports multiple images.</div>
                <div class="gallery-upload-list" id="galleryUploadList"></div>
            </div>
            <div class="panel-block" id="contentControls" style="display:none;">
                <h4>Content</h4>
                <div class="control-row">
                    <span>Items</span>
                    <input class="mini-input" id="contentItemsInput" value="6" style="max-width:90px;">
                </div>
                <div class="control-row">
                    <span>Columns</span>
                    <input class="mini-input" id="contentColsInput" value="3" style="max-width:90px;">
                </div>
                <div class="control-row">
                    <span>Layout</span>
                    <select class="mini-input" id="contentLayoutInput" style="max-width:140px;">
                        <option value="cards">Cards</option>
                        <option value="compact">Compact</option>
                    </select>
                </div>
            </div>
            <div class="panel-block" id="widgetControls" style="display:none;">
                <h4>Widget</h4>
                <div class="control-row">
                    <span>Items</span>
                    <input class="mini-input" id="widgetItemsInput" value="4" style="max-width:90px;">
                </div>
                <div class="control-row">
                    <span>Columns</span>
                    <input class="mini-input" id="widgetColsInput" value="3" style="max-width:90px;">
                </div>
                <div class="control-row">
                    <span>Value</span>
                    <input class="mini-input" id="widgetValueInput" value="75" style="max-width:120px;">
                </div>
                <div class="control-row">
                    <span>Embed URL</span>
                </div>
                <input class="mini-input" id="widgetEmbedInput" placeholder="https://...">
            </div>
            <div class="panel-block" id="designSystemControls">
                <h4>Theme Tokens</h4>
                <div class="token-top">
                    <div class="token-field">
                        <label for="tokenPresetSelect">Preset</label>
                        <select class="mini-input" id="tokenPresetSelect">
                            <option value="current">Current</option>
                        </select>
                    </div>
                    <div class="token-actions">
                        <button class="action-btn" id="saveTokenPresetBtn" type="button">Save Preset</button>
                        <button class="action-btn" id="exportTokensBtn" type="button">Export</button>
                    </div>
                </div>
                <div class="token-grid token-grid-2">
                    <div class="token-field">
                        <label for="tokenTextPrimary">Primary Text</label>
                        <input class="mini-input" id="tokenTextPrimary" value="#ffffff">
                    </div>
                    <div class="token-field">
                        <label for="tokenTextSecondary">Secondary Text</label>
                        <input class="mini-input" id="tokenTextSecondary" value="#a1a1aa">
                    </div>
                    <div class="token-field">
                        <label for="tokenBgBlack">Background</label>
                        <input class="mini-input" id="tokenBgBlack" value="#020202">
                    </div>
                    <div class="token-field">
                        <label for="tokenAccentCyan">Accent Cyan</label>
                        <input class="mini-input" id="tokenAccentCyan" value="#06b6d4">
                    </div>
                    <div class="token-field">
                        <label for="tokenAccentBlue">Accent Blue</label>
                        <input class="mini-input" id="tokenAccentBlue" value="#2563eb">
                    </div>
                </div>
                <div class="token-group-title">Spacing Scale (px)</div>
                <div class="token-grid token-grid-4">
                    <div class="token-field small">
                        <label for="tokenSpaceSm">Sm</label>
                        <input class="mini-input" id="tokenSpaceSm" value="8">
                    </div>
                    <div class="token-field small">
                        <label for="tokenSpaceMd">Md</label>
                        <input class="mini-input" id="tokenSpaceMd" value="16">
                    </div>
                    <div class="token-field small">
                        <label for="tokenSpaceLg">Lg</label>
                        <input class="mini-input" id="tokenSpaceLg" value="24">
                    </div>
                    <div class="token-field small">
                        <label for="tokenSpaceXl">Xl</label>
                        <input class="mini-input" id="tokenSpaceXl" value="32">
                    </div>
                </div>
                <div class="token-group-title">Radius Scale (px)</div>
                <div class="token-grid token-grid-4">
                    <div class="token-field small">
                        <label for="tokenRadiusSm">Sm</label>
                        <input class="mini-input" id="tokenRadiusSm" value="6">
                    </div>
                    <div class="token-field small">
                        <label for="tokenRadiusMd">Md</label>
                        <input class="mini-input" id="tokenRadiusMd" value="12">
                    </div>
                    <div class="token-field small">
                        <label for="tokenRadiusLg">Lg</label>
                        <input class="mini-input" id="tokenRadiusLg" value="20">
                    </div>
                    <div class="token-field small">
                        <label for="tokenRadiusXl">Xl</label>
                        <input class="mini-input" id="tokenRadiusXl" value="28">
                    </div>
                </div>
                <div class="token-grid token-grid-2">
                    <div class="token-field">
                        <label for="tokenFontBase">Font Base (px)</label>
                        <input class="mini-input" id="tokenFontBase" value="16">
                    </div>
                    <div class="token-field">
                        <label for="tokenFontScale">Font Scale</label>
                        <input class="mini-input" id="tokenFontScale" value="1.12">
                    </div>
                </div>
            </div>
            <div class="panel-block" id="tabsContentControls" style="display:none;">
                <h4>Tabs Content</h4>
                <div class="control-row">
                    <span>Active Tab Title</span>
                </div>
                <input class="mini-input" id="tabTitleInput" placeholder="Tab title">
                <div class="control-row" style="margin-top:10px;">
                    <span>Active Tab Content</span>
                </div>
                <input class="mini-input" id="tabContentInput" placeholder="Tab content">
            </div>
            <div class="panel-block">
                <h4>Spacing</h4>
                <div class="label-row">
                    <span>Margin Y</span>
                    <span>Margin X</span>
                </div>
                <div class="double">
                    <input class="mini-input" id="marginYInput" value="Auto">
                    <input class="mini-input" id="marginXInput" value="Auto">
                </div>
                <div class="label-row" style="margin-top:10px;">
                    <span>Padding Y</span>
                    <span>Padding X</span>
                </div>
                <div class="double" style="margin-top:8px;">
                    <input class="mini-input" id="paddingYInput" value="8">
                    <input class="mini-input" id="paddingXInput" value="8">
                </div>
            </div>
            <div class="panel-block">
                <h4>Layout Engine</h4>
                <div class="toggle-row">
                    <div class="toggle-pill" data-layout="block">Block</div>
                    <div class="toggle-pill" data-layout="flex">Flex</div>
                    <div class="toggle-pill" data-layout="grid">Grid</div>
                </div>
            </div>
                </div>
            </div>
            <button class="sidebar-toggle" id="rightPanelToggle" type="button" title="Toggle sidebar">
                <i class="fa-solid fa-chevron-right"></i>
            </button>
        </aside>
    </div>
    <div class="autosave-toast" id="autosaveToast">Draft saved</div>
    <div class="asset-modal" id="assetModal">
        <div class="asset-card">
            <div class="asset-header">
                <div class="asset-title">Project Assets</div>
                <button class="asset-close" id="assetCloseBtn" type="button">Close</button>
            </div>
            <div class="asset-toolbar">
                <div class="asset-tabs">
                    <div class="asset-tab active" data-asset-tab="all">All</div>
                    <div class="asset-tab" data-asset-tab="image">Images</div>
                    <div class="asset-tab" data-asset-tab="video">Videos</div>
                    <div class="asset-tab" data-asset-tab="lottie">Lottie</div>
                </div>
                <input class="asset-search" id="assetSearch" placeholder="Search assets...">
            </div>
            <div class="asset-actions">
                <input type="file" id="assetUploadInput" multiple style="display:none;">
                <button class="btn ghost" id="assetUploadBtn" type="button"><i class="fa-solid fa-upload"></i> Upload</button>
                <button class="btn ghost" id="assetRefreshBtn" type="button"><i class="fa-solid fa-rotate"></i> Refresh</button>
                <span class="asset-status" id="assetUploadStatus"></span>
            </div>
            <div class="asset-grid" id="assetGrid"></div>
        </div>
    </div>
    <div class="asset-modal" id="templateModal">
        <div class="asset-card">
            <div class="asset-header">
                <div class="asset-title">Templates</div>
                <button class="asset-close" id="templateCloseBtn" type="button">Close</button>
            </div>
            <div class="template-toolbar">
                <div class="template-meta" id="templateCount">Templates</div>
                <label class="template-search">
                    <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                    <input id="templateSearchInput" placeholder="Search templates...">
                </label>
            </div>
            <div class="template-grid" id="templateGrid"></div>
            <div class="template-actions">
                <div class="template-form">
                    <div class="template-field">
                        <label for="templatePageNameInput">Page Name</label>
                        <input class="mini-input" id="templatePageNameInput" placeholder="Page name">
                    </div>
                    <div class="template-field">
                        <label for="templatePagePathInput">Page Path</label>
                        <input class="mini-input" id="templatePagePathInput" placeholder="page-name.html">
                    </div>
                </div>
                <div class="template-actions-group">
                    <button class="btn ghost" id="templateApplyBtn" type="button"><i class="fa-solid fa-wand-sparkles"></i> Apply to Current Page</button>
                    <button class="btn primary" id="templateCreateBtn" type="button"><i class="fa-solid fa-plus"></i> Create Page</button>
                </div>
            </div>
        </div>
    </div>
    <div class="asset-modal" id="shareModal">
        <div class="asset-card">
            <div class="asset-header">
                <div class="asset-title">Share</div>
                <button class="asset-close" id="shareCloseBtn" type="button">Close</button>
            </div>
            <div class="share-grid">
                <div class="share-row">
                    <label>Editor Link</label>
                    <div class="share-input">
                        <input id="shareEditorLink" readonly>
                        <button class="btn ghost" data-share-copy="editor" type="button">Copy</button>
                    </div>
                </div>
                <div class="share-row">
                    <label>Preview Link</label>
                    <div class="share-input">
                        <input id="sharePreviewLink" readonly>
                        <button class="btn ghost" data-share-copy="preview" type="button">Copy</button>
                    </div>
                </div>
                <div class="share-row">
                    <label>Published Link</label>
                    <div class="share-input">
                        <input id="sharePublishedLink" readonly>
                        <button class="btn ghost" data-share-copy="published" type="button">Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="asset-modal" id="missingAssetsModal">
        <div class="asset-card">
            <div class="asset-header">
                <div class="asset-title">Missing Assets</div>
                <button class="asset-close" id="missingAssetsCloseBtn" type="button">Close</button>
            </div>
            <div class="missing-body">
                <div class="missing-summary" id="missingAssetsSummary">Scanning...</div>
                <div class="missing-actions">
                    <button class="btn ghost" id="missingAssetsFixBtn" type="button">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> Auto Fix
                    </button>
                    <div class="missing-status" id="missingAssetsStatus"></div>
                </div>
                <div class="missing-list" id="missingAssetsList"></div>
            </div>
        </div>
    </div>
    <div class="variant-modal" id="variantModal">
        <div class="variant-card-shell">
            <div class="variant-header">
                <div class="variant-title" id="variantTitle">Choose a Style</div>
                <button class="asset-close" id="variantCloseBtn" type="button">Close</button>
            </div>
            <div class="variant-grid" id="variantGrid"></div>
        </div>
    </div>

    <script>
        document.querySelectorAll('script[src="/_framework/aspnetcore-browser-refresh.js"]').forEach(el => el.remove());
        document.querySelectorAll('script[src^="/_vs/browserLink"]').forEach(el => el.remove());

        window.addEventListener('error', (event) => {
            if (event?.message?.includes('Invalid regular expression flags')) {
                event.preventDefault();
                return true;
            }
            return false;
        });

        const projectId = @Model.ProjectId;
        const projectFolder = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ProjectName ?? "Project"));
        const projectResolvedPath = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ResolvedPath ?? string.Empty));
        const editorFilePath = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.FilePath ?? "index.html"));
        const filePath = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.FilePath));
        const csrfToken = document.querySelector('#antiforgeryForm input[name="__RequestVerificationToken"]')?.value || "";
        const previewPrefix = `/Editor?handler=Preview&projectId=${projectId}&file=`;
        const assetPrefix = `/Editor?handler=Asset&projectId=${projectId}&path=`;
        const hasTemplateMarker = (value) => {
            if (typeof value !== 'string') return false;
            const lowered = value.toLowerCase();
            return value.includes('${') || lowered.includes('%7b') || lowered.includes('%7d');
        };
        const safeUrlValue = (value) => {
            if (typeof value !== 'string') return '';
            const trimmed = value.trim();
            if (!trimmed || hasTemplateMarker(trimmed)) return '';
            return trimmed;
        };
        const buildSvgPlaceholder = (width, height, label, fontSize) => {
            const size = fontSize || Math.max(12, Math.round(Math.min(width, height) / 8));
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}"><rect width="100%" height="100%" fill="#e2e8f0"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#94a3b8" font-size="${size}" font-family="Arial">${label}</text></svg>`;
            return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svg)}`;
        };
        const editorIframe = document.querySelector('.canvas-frame');
        const editorBridge = {
            ready: false,
            selection: null,
            multiSelection: []
        };
        const controlRefs = {
            linkUrlInput: document.getElementById('linkUrlInput'),
            workflowSelect: document.getElementById('workflowSelect'),
            fontWeightLabel: document.getElementById('fontWeightLabel'),
            fontFamilyInput: document.getElementById('fontFamilyInput'),
            fontSizeInput: document.getElementById('fontSizeInput'),
            textContentInput: document.getElementById('textContentInput'),
            textModeBadges: Array.from(document.querySelectorAll('[data-textmode]')),
            alignBadges: Array.from(document.querySelectorAll('.badge-row [data-align]')),
            textColorValue: document.getElementById('textColorValue'),
            bgColorValue: document.getElementById('bgColorValue'),
            bgColorPill: document.getElementById('bgColorPill'),
            radiusValue: document.getElementById('radiusValue'),
            textColorInput: document.getElementById('textColorInput'),
            bgColorInput: document.getElementById('bgColorInput'),
            bgTransparentToggle: document.getElementById('bgTransparentToggle'),
            radiusInput: document.getElementById('radiusInput'),
            marginYInput: document.getElementById('marginYInput'),
            marginXInput: document.getElementById('marginXInput'),
            paddingYInput: document.getElementById('paddingYInput'),
            paddingXInput: document.getElementById('paddingXInput'),
            layoutPills: Array.from(document.querySelectorAll('.toggle-pill[data-layout]')),
            selectionTag: document.getElementById('selectionTag'),
            selectionSummary: document.getElementById('selectionSummary'),
            selectionSelector: document.getElementById('selectionSelector'),
            textEditWarning: document.getElementById('textEditWarning'),
            autosaveToast: document.getElementById('autosaveToast'),
            undoBtn: document.getElementById('undoBtn'),
            redoBtn: document.getElementById('redoBtn'),
            templatesBtn: document.getElementById('templatesBtn'),
            createNewBtn: document.getElementById('createNewBtn'),
            shareBtn: document.getElementById('shareBtn'),
            openPreviewBtn: document.getElementById('openPreviewBtn'),
            openPublishedBtn: document.getElementById('openPublishedBtn'),
            restoreSnapshotBtn: document.getElementById('restoreSnapshotBtn'),
            integrityBadge: document.getElementById('integrityBadge'),
            liveCanvasToggle: document.getElementById('liveCanvasToggle'),
            canvasPauseOverlay: document.getElementById('canvasPauseOverlay'),
            resumeCanvasBtn: document.getElementById('resumeCanvasBtn'),
            elementsSearch: document.getElementById('elementsSearch'),
            elementsFavorites: document.getElementById('elementsFavorites'),
            elementsCatalog: document.getElementById('elementsCatalog'),
            launchAiStudioBtn: document.getElementById('launchAiStudioBtn'),
            pagesList: document.getElementById('pagesList'),
            pagesSearch: document.getElementById('pagesSearch'),
            newPageBtn: document.getElementById('newPageBtn'),
            pagesForm: document.getElementById('pagesForm'),
            pageNameInput: document.getElementById('pageNameInput'),
            pagePathInput: document.getElementById('pagePathInput'),
            pageTemplateInput: document.getElementById('pageTemplateInput'),
            createPageBtn: document.getElementById('createPageBtn'),
            cancelPageBtn: document.getElementById('cancelPageBtn'),
            duplicateElementBtn: document.getElementById('duplicateElementBtn'),
            deleteElementBtn: document.getElementById('deleteElementBtn'),
            saveSymbolBtn: document.getElementById('saveSymbolBtn'),
            updateSymbolBtn: document.getElementById('updateSymbolBtn'),
            mediaControls: document.getElementById('mediaControls'),
            mediaUrlInput: document.getElementById('mediaUrlInput'),
            mediaUploadInput: document.getElementById('mediaUploadInput'),
            mediaChooseBtn: document.getElementById('mediaChooseBtn'),
            elementActions: document.getElementById('elementActions'),
            layoutControls: document.getElementById('layoutControls'),
            gridColsInput: document.getElementById('gridColsInput'),
            gridRowsInput: document.getElementById('gridRowsInput'),
            gridGapInput: document.getElementById('gridGapInput'),
            gridFlowInput: document.getElementById('gridFlowInput'),
            mapControls: document.getElementById('mapControls'),
            mapLocationInput: document.getElementById('mapLocationInput'),
            mapZoomInput: document.getElementById('mapZoomInput'),
            fieldControls: document.getElementById('fieldControls'),
            fieldPlaceholderInput: document.getElementById('fieldPlaceholderInput'),
            carouselControls: document.getElementById('carouselControls'),
            addCarouselSlideBtn: document.getElementById('addCarouselSlideBtn'),
            removeCarouselSlideBtn: document.getElementById('removeCarouselSlideBtn'),
            tabsControls: document.getElementById('tabsControls'),
            addTabBtn: document.getElementById('addTabBtn'),
            removeTabBtn: document.getElementById('removeTabBtn'),
            accordionControls: document.getElementById('accordionControls'),
            addAccordionItemBtn: document.getElementById('addAccordionItemBtn'),
            removeAccordionItemBtn: document.getElementById('removeAccordionItemBtn'),
            pricingControls: document.getElementById('pricingControls'),
            pricingTitleInput: document.getElementById('pricingTitleInput'),
            pricingPriceInput: document.getElementById('pricingPriceInput'),
            pricingDescInput: document.getElementById('pricingDescInput'),
            galleryControls: document.getElementById('galleryControls'),
            addGalleryImageBtn: document.getElementById('addGalleryImageBtn'),
            removeGalleryImageBtn: document.getElementById('removeGalleryImageBtn'),
            galleryImageUrlInput: document.getElementById('galleryImageUrlInput'),
            galleryUploadInput: document.getElementById('galleryUploadInput'),
            galleryUploadHint: document.getElementById('galleryUploadHint'),
            galleryUploadList: document.getElementById('galleryUploadList'),
            contentControls: document.getElementById('contentControls'),
            contentItemsInput: document.getElementById('contentItemsInput'),
            contentColsInput: document.getElementById('contentColsInput'),
            contentLayoutInput: document.getElementById('contentLayoutInput'),
            widgetControls: document.getElementById('widgetControls'),
            widgetItemsInput: document.getElementById('widgetItemsInput'),
            widgetColsInput: document.getElementById('widgetColsInput'),
            widgetValueInput: document.getElementById('widgetValueInput'),
            widgetEmbedInput: document.getElementById('widgetEmbedInput'),
            designSystemControls: document.getElementById('designSystemControls'),
            tokenPresetSelect: document.getElementById('tokenPresetSelect'),
            saveTokenPresetBtn: document.getElementById('saveTokenPresetBtn'),
            exportTokensBtn: document.getElementById('exportTokensBtn'),
            tokenTextPrimary: document.getElementById('tokenTextPrimary'),
            tokenTextSecondary: document.getElementById('tokenTextSecondary'),
            tokenBgBlack: document.getElementById('tokenBgBlack'),
            tokenAccentCyan: document.getElementById('tokenAccentCyan'),
            tokenAccentBlue: document.getElementById('tokenAccentBlue'),
            tokenSpaceSm: document.getElementById('tokenSpaceSm'),
            tokenSpaceMd: document.getElementById('tokenSpaceMd'),
            tokenSpaceLg: document.getElementById('tokenSpaceLg'),
            tokenSpaceXl: document.getElementById('tokenSpaceXl'),
            tokenRadiusSm: document.getElementById('tokenRadiusSm'),
            tokenRadiusMd: document.getElementById('tokenRadiusMd'),
            tokenRadiusLg: document.getElementById('tokenRadiusLg'),
            tokenRadiusXl: document.getElementById('tokenRadiusXl'),
            tokenFontBase: document.getElementById('tokenFontBase'),
            tokenFontScale: document.getElementById('tokenFontScale'),
            tabsContentControls: document.getElementById('tabsContentControls'),
            tabTitleInput: document.getElementById('tabTitleInput'),
            tabContentInput: document.getElementById('tabContentInput'),
            structureFloating: document.getElementById('structureFloating'),
            structureFloatTarget: document.getElementById('structureFloatTarget'),
            structureDockTarget: document.getElementById('structureDockTarget'),
            structureDockPill: document.getElementById('structureDockPill'),
            structureDragHandle: document.getElementById('structureDragHandle'),
            dockStructureBtn: document.getElementById('dockStructureBtn'),
            closeStructureBtn: document.getElementById('closeStructureBtn'),
            gridChooser: document.getElementById('gridChooser'),
            missingAssetsBtn: document.getElementById('missingAssetsBtn'),
            missingAssetsModal: document.getElementById('missingAssetsModal'),
            missingAssetsSummary: document.getElementById('missingAssetsSummary'),
            missingAssetsList: document.getElementById('missingAssetsList'),
            missingAssetsCloseBtn: document.getElementById('missingAssetsCloseBtn'),
            missingAssetsFixBtn: document.getElementById('missingAssetsFixBtn'),
            missingAssetsStatus: document.getElementById('missingAssetsStatus'),
            templateModal: document.getElementById('templateModal'),
            templateGrid: document.getElementById('templateGrid'),
            templateCloseBtn: document.getElementById('templateCloseBtn'),
            templateApplyBtn: document.getElementById('templateApplyBtn'),
            templateCreateBtn: document.getElementById('templateCreateBtn'),
            templatePageNameInput: document.getElementById('templatePageNameInput'),
            templatePagePathInput: document.getElementById('templatePagePathInput'),
            templateSearchInput: document.getElementById('templateSearchInput'),
            templateCount: document.getElementById('templateCount'),
            shareModal: document.getElementById('shareModal'),
            shareCloseBtn: document.getElementById('shareCloseBtn'),
            shareEditorLink: document.getElementById('shareEditorLink'),
            sharePreviewLink: document.getElementById('sharePreviewLink'),
            sharePublishedLink: document.getElementById('sharePublishedLink'),
            assetModal: document.getElementById('assetModal'),
            assetGrid: document.getElementById('assetGrid'),
            assetSearch: document.getElementById('assetSearch'),
            assetCloseBtn: document.getElementById('assetCloseBtn'),
            assetUploadInput: document.getElementById('assetUploadInput'),
            assetUploadBtn: document.getElementById('assetUploadBtn'),
            assetRefreshBtn: document.getElementById('assetRefreshBtn'),
            assetUploadStatus: document.getElementById('assetUploadStatus'),
            toolDrawer: document.getElementById('toolDrawer'),
            utilityPanel: document.getElementById('utilityPanel'),
            utilityTitle: document.getElementById('utilityTitle'),
            utilityCloseBtn: document.getElementById('utilityCloseBtn'),
            aiPromptInput: document.getElementById('aiPromptInput'),
            motionTargetLabel: document.getElementById('motionTargetLabel'),
            motionTrackBadge: document.getElementById('motionTrackBadge'),
            motionPropertySelect: document.getElementById('motionPropertySelect'),
            motionEasingSelect: document.getElementById('motionEasingSelect'),
            motionPlayhead: document.getElementById('motionPlayhead'),
            motionPlayheadValue: document.getElementById('motionPlayheadValue'),
            motionKeyframes: document.getElementById('motionKeyframes'),
            motionAddKeyframeBtn: document.getElementById('motionAddKeyframeBtn'),
            motionClearKeyframesBtn: document.getElementById('motionClearKeyframesBtn'),
            motionScrollEnabled: document.getElementById('motionScrollEnabled'),
            motionScrollStart: document.getElementById('motionScrollStart'),
            motionScrollEnd: document.getElementById('motionScrollEnd'),
            motionScrollScrub: document.getElementById('motionScrollScrub'),
            lottieUrlInput: document.getElementById('lottieUrlInput'),
            lottieLoopInput: document.getElementById('lottieLoopInput'),
            lottieAutoplayInput: document.getElementById('lottieAutoplayInput'),
            applyLottieBtn: document.getElementById('applyLottieBtn'),
            pickLottieBtn: document.getElementById('pickLottieBtn'),
            lottieScrubBtn: document.getElementById('lottieScrubBtn'),
            svgPathList: document.getElementById('svgPathList'),
            canvasSearchInput: document.getElementById('canvasSearchInput'),
            canvasSearchResults: document.getElementById('canvasSearchResults'),
            iconSearchInput: document.getElementById('iconSearchInput'),
            iconGrid: document.getElementById('iconGrid'),
            historyList: document.getElementById('historyList'),
            historyUndoBtn: document.getElementById('historyUndoBtn'),
            historyRedoBtn: document.getElementById('historyRedoBtn'),
            historyClearBtn: document.getElementById('historyClearBtn'),
            variantModal: document.getElementById('variantModal'),
            variantTitle: document.getElementById('variantTitle'),
            variantGrid: document.getElementById('variantGrid'),
            variantCloseBtn: document.getElementById('variantCloseBtn'),
            canvasToolbar: document.getElementById('canvasToolbar'),
            canvasZoomLabel: document.getElementById('canvasZoomLabel'),
            leftPanelToggle: document.getElementById('leftPanelToggle'),
            rightPanelToggle: document.getElementById('rightPanelToggle'),
            mobileLeftPanelBtn: document.getElementById('mobileLeftPanelBtn'),
            mobileRightPanelBtn: document.getElementById('mobileRightPanelBtn'),
            editorThemeGrid: document.getElementById('editorThemeGrid'),
            editorThemeBg: document.getElementById('editorThemeBg'),
            editorThemeBgValue: document.getElementById('editorThemeBgValue'),
            editorThemePanel: document.getElementById('editorThemePanel'),
            editorThemePanelValue: document.getElementById('editorThemePanelValue'),
            editorThemeCard: document.getElementById('editorThemeCard'),
            editorThemeCardValue: document.getElementById('editorThemeCardValue'),
            editorThemeBorder: document.getElementById('editorThemeBorder'),
            editorThemeBorderValue: document.getElementById('editorThemeBorderValue'),
            editorThemeText: document.getElementById('editorThemeText'),
            editorThemeTextValue: document.getElementById('editorThemeTextValue'),
            editorThemeMuted: document.getElementById('editorThemeMuted'),
            editorThemeMutedValue: document.getElementById('editorThemeMutedValue'),
            editorThemeAccent: document.getElementById('editorThemeAccent'),
            editorThemeAccentValue: document.getElementById('editorThemeAccentValue'),
            editorThemeAccent2: document.getElementById('editorThemeAccent2'),
            editorThemeAccent2Value: document.getElementById('editorThemeAccent2Value'),
            resetEditorThemeBtn: document.getElementById('resetEditorThemeBtn'),
            customThemeName: document.getElementById('customThemeName'),
            saveCustomThemeBtn: document.getElementById('saveCustomThemeBtn')
        };
        const leftSidebarState = {
            activeTab: 'elements',
            selectedNodeId: null,
            elements: [
                {
                    category: 'Layout',
                    items: [
                        { id: 'section', label: 'Section', icon: 'fa-solid fa-square-full', desc: 'Production section shells' },
                        { id: 'container', label: 'Container', icon: 'fa-solid fa-box', desc: 'Card and wrapper variants' },
                        { id: 'grid', label: 'Grid', icon: 'fa-solid fa-table-cells-large', desc: 'Stats/cards grid presets' },
                        { id: 'columns', label: 'Columns', icon: 'fa-solid fa-columns', desc: 'Sidebar and split layouts' },
                        { id: 'stack', label: 'Stack', icon: 'fa-solid fa-layer-group', desc: 'Vertical stack' },
                        { id: 'divider', label: 'Divider', icon: 'fa-solid fa-grip-lines', desc: 'Section divider' },
                        { id: 'spacer', label: 'Spacer', icon: 'fa-solid fa-arrows-up-down', desc: 'Vertical spacing' }
                    ]
                },
                {
                    category: 'Essentials',
                    items: [
                        { id: 'heading', label: 'Heading', icon: 'fa-solid fa-heading', desc: 'Hero/section/eyebrow titles' },
                        { id: 'text', label: 'Text', icon: 'fa-solid fa-font', desc: 'Lead/body/caption text styles' },
                        { id: 'button', label: 'Button', icon: 'fa-solid fa-hand-pointer', desc: 'Primary and outline CTA' },
                        { id: 'link', label: 'Link', icon: 'fa-solid fa-link', desc: 'Inline link' },
                        { id: 'badge', label: 'Badge', icon: 'fa-solid fa-certificate', desc: 'Highlight label' }
                    ]
                },
                {
                    category: 'Media',
                    items: [
                        { id: 'image', label: 'Image', icon: 'fa-regular fa-image', desc: 'Single image' },
                        { id: 'image-card', label: 'Image Card', icon: 'fa-regular fa-id-card', desc: 'Media + content card' },
                        { id: 'video', label: 'Video', icon: 'fa-solid fa-video', desc: 'Video player' },
                        { id: 'gallery', label: 'Gallery', icon: 'fa-regular fa-images', desc: 'Image gallery' },
                        { id: 'carousel', label: 'Carousel', icon: 'fa-solid fa-cubes', desc: 'Sliding carousel' },
                        { id: 'audio', label: 'Audio', icon: 'fa-solid fa-volume-high', desc: 'Audio player' }
                    ]
                },
                {
                    category: 'Forms',
                    items: [
                        { id: 'form', label: 'Form', icon: 'fa-solid fa-rectangle-list', desc: 'Form block' },
                        { id: 'input', label: 'Input', icon: 'fa-solid fa-i-cursor', desc: 'Text input' },
                        { id: 'textarea', label: 'Textarea', icon: 'fa-solid fa-align-left', desc: 'Multi-line input' },
                        { id: 'select', label: 'Select', icon: 'fa-solid fa-caret-down', desc: 'Dropdown select' },
                        { id: 'checkbox', label: 'Checkbox', icon: 'fa-regular fa-square-check', desc: 'Checkbox' },
                        { id: 'radio', label: 'Radio', icon: 'fa-regular fa-circle-dot', desc: 'Radio options' }
                    ]
                },
                {
                    category: 'Data & Content',
                    items: [
                        { id: 'tabs', label: 'Tabs', icon: 'fa-solid fa-folder', desc: 'Tabbed content' },
                        { id: 'accordion', label: 'Accordion', icon: 'fa-solid fa-list', desc: 'Collapse panels' },
                        { id: 'faq', label: 'FAQ', icon: 'fa-regular fa-circle-question', desc: 'FAQ list' },
                        { id: 'testimonial', label: 'Testimonial', icon: 'fa-solid fa-quote-left', desc: 'Testimonial' },
                        { id: 'pricing', label: 'Pricing Table', icon: 'fa-solid fa-tag', desc: 'Pricing' },
                        { id: 'counter', label: 'Counter', icon: 'fa-solid fa-hashtag', desc: 'Animated number' },
                        { id: 'progress', label: 'Progress Bar', icon: 'fa-solid fa-chart-simple', desc: 'Progress' },
                        { id: 'timeline', label: 'Timeline', icon: 'fa-solid fa-timeline', desc: 'Timeline' },
                        { id: 'posts', label: 'Posts', icon: 'fa-regular fa-newspaper', desc: 'Latest posts' },
                        { id: 'loop-grid', label: 'Loop Grid', icon: 'fa-solid fa-grip', desc: 'Dynamic grid' },
                        { id: 'portfolio', label: 'Portfolio', icon: 'fa-solid fa-briefcase', desc: 'Project showcase' },
                        { id: 'team', label: 'Team', icon: 'fa-solid fa-user-group', desc: 'Team members' }
                    ]
                },
                {
                    category: 'Navigation',
                    items: [
                        { id: 'menu', label: 'Nav Menu', icon: 'fa-solid fa-bars', desc: 'Navigation menu' },
                        { id: 'breadcrumbs', label: 'Breadcrumbs', icon: 'fa-solid fa-ellipsis', desc: 'Breadcrumb trail' },
                        { id: 'pagination', label: 'Pagination', icon: 'fa-solid fa-angles-right', desc: 'Page nav' },
                        { id: 'search', label: 'Search', icon: 'fa-solid fa-magnifying-glass', desc: 'Search bar' }
                    ]
                },
                {
                    category: 'Social',
                    items: [
                        { id: 'social-icons', label: 'Social Icons', icon: 'fa-brands fa-facebook', desc: 'Social links' },
                        { id: 'share', label: 'Share Buttons', icon: 'fa-solid fa-share-nodes', desc: 'Share' },
                        { id: 'reviews', label: 'Reviews', icon: 'fa-solid fa-star', desc: 'Ratings' }
                    ]
                },
                {
                    category: 'Embeds',
                    items: [
                        { id: 'embed', label: 'Embed', icon: 'fa-solid fa-code', desc: 'HTML embed' },
                        { id: 'map', label: 'Map', icon: 'fa-solid fa-location-dot', desc: 'Google map' },
                        { id: 'youtube', label: 'YouTube', icon: 'fa-brands fa-youtube', desc: 'Video embed' },
                        { id: 'vimeo', label: 'Vimeo', icon: 'fa-brands fa-vimeo', desc: 'Video embed' },
                        { id: 'lottie', label: 'Lottie', icon: 'fa-solid fa-wand-magic-sparkles', desc: 'Animation' }
                    ]
                },
                {
                    category: 'Commerce',
                    items: [
                        { id: 'product-grid', label: 'Product Grid', icon: 'fa-solid fa-store', desc: 'Shop grid' },
                        { id: 'cart-button', label: 'Cart Button', icon: 'fa-solid fa-cart-shopping', desc: 'Add to cart' }
                    ]
                },
                {
                    category: 'Advanced',
                    items: [
                        { id: 'image-box', label: 'Image Box', icon: 'fa-regular fa-image', desc: 'Image + text' },
                        { id: 'table', label: 'Table', icon: 'fa-solid fa-table', desc: 'Data table' }
                    ]
                }
            ],
            structure: {
                nodes: [],
                expanded: new Set()
            },
            pages: {
                items: []
            }
        };
        const pagesStorageKey = `bugence-editor-pages-${projectId}`;
        const pagesState = {
            items: [],
            activeId: null
        };
        let isSyncingControls = false;
        let isUserFontChange = false;
        let recentFonts = [];
        let textMode = 'plain';
        const baseFontOptions = controlRefs.fontFamilyInput
            ? Array.from(controlRefs.fontFamilyInput.options).map(option => ({ value: option.value, text: option.textContent }))
            : [];
        const recentFontKey = 'bugence-editor-recent-fonts';
        let textModeTooltip;
        let textModeTooltipTimer;
        let isBgTransparent = false;
        let autoSaveTimer;
        let historyTimer;
        let historyOps = [];
        let historyIndex = -1;
        let isRestoringHistory = false;
        let pendingHistory = null;
        let lastSelectionHtml = null;
        let iframeHistoryDoc = null;
        let assetCache = null;
        let assetCacheTime = 0;
        let assetFilter = 'all';
        let selectionOverlayRaf = null;
        let multiSelectStyleInjected = false;
        let inlineAddEnabled = localStorage.getItem('bugence-inline-add') !== '0';
        let liveCanvasEnabled = localStorage.getItem('bugence-live-canvas') !== '0';
        let activeUtilityPanel = null;
        let pendingVariantInsert = null;
        let baselineNormalizedHtml = null;
        let lastSavedNormalizedHtml = null;
        const editTracker = {
            text: 0,
            style: 0,
            structural: 0
        };
        let lastPaletteType = 'text';
        let canvasZoom = 1;
        let aiBusy = false;
        let motionState = { tracks: [], scroll: { enabled: false, start: 10, end: 90, scrub: 1 } };
        let motionPlayheadValue = 0;
        let assetPickerContext = 'media';
        let selectedTemplateId = 'blank';

        const sendToIframe = (type, payload) => {
            if (!editorIframe || !editorIframe.contentWindow) return;
            const bypassPause = type === 'bugence-editor:ping' || type === 'bugence-editor:live-mode';
            if (!liveCanvasEnabled && !bypassPause) return;
            editorIframe.contentWindow.postMessage({ source: 'bugence-editor-host', type, payload }, '*');
        };

        let editorPrefsSaveTimer = null;
        let isApplyingEditorPrefs = false;

        function safeJsonParse(value, fallback) {
            if (!value) return fallback;
            try {
                return JSON.parse(value);
            } catch {
                return fallback;
            }
        }

        function collectEditorPrefs() {
            const device = document.getElementById('deviceSelect')?.value || 'desktop';
            return {
                theme: safeJsonParse(localStorage.getItem('bugence-editor-theme'), null),
                customThemes: safeJsonParse(localStorage.getItem('bugence-editor-custom-themes'), []),
                favorites: safeJsonParse(localStorage.getItem('bugence-elements-favorites'), []),
                recentFonts: safeJsonParse(localStorage.getItem('bugence-editor-recent-fonts'), []),
                canvasGrid: localStorage.getItem('bugence-canvas-grid') === '1',
                focusMode: document.body.classList.contains('focus-mode'),
                inlineAdd: inlineAddEnabled,
                leftCollapsed: document.body.classList.contains('left-collapsed'),
                rightCollapsed: document.body.classList.contains('right-collapsed'),
                deviceView: device,
                liveCanvas: liveCanvasEnabled
            };
        }

        async function loadEditorPrefs() {
            if (!projectId) return;
            try {
                const response = await fetch(`/Editor?handler=EditorPrefs&projectId=${projectId}`);
                if (!response.ok) return;
                const payload = await response.json();
                if (payload && typeof payload === 'object') {
                    applyEditorPrefs(payload);
                }
            } catch {
                // ignore
            }
        }

        function applyEditorPrefs(prefs) {
            if (!prefs || typeof prefs !== 'object') return;
            isApplyingEditorPrefs = true;
            if (prefs.theme) {
                localStorage.setItem('bugence-editor-theme', JSON.stringify(prefs.theme));
            }
            if (Array.isArray(prefs.customThemes)) {
                localStorage.setItem('bugence-editor-custom-themes', JSON.stringify(prefs.customThemes));
            }
            if (Array.isArray(prefs.favorites)) {
                localStorage.setItem('bugence-elements-favorites', JSON.stringify(prefs.favorites));
            }
            if (Array.isArray(prefs.recentFonts)) {
                localStorage.setItem('bugence-editor-recent-fonts', JSON.stringify(prefs.recentFonts));
            }
            if (typeof prefs.canvasGrid === 'boolean') {
                localStorage.setItem('bugence-canvas-grid', prefs.canvasGrid ? '1' : '0');
            }
            if (typeof prefs.focusMode === 'boolean') {
                localStorage.setItem('bugence-focus-mode', prefs.focusMode ? '1' : '0');
            }
            if (typeof prefs.inlineAdd === 'boolean') {
                localStorage.setItem('bugence-inline-add', prefs.inlineAdd ? '1' : '0');
            }
            if (typeof prefs.leftCollapsed === 'boolean') {
                localStorage.setItem('bugence-left-collapsed', prefs.leftCollapsed ? '1' : '0');
                localStorage.setItem('bugence-left-collapsed-set', '1');
            }
            if (typeof prefs.rightCollapsed === 'boolean') {
                localStorage.setItem('bugence-right-collapsed', prefs.rightCollapsed ? '1' : '0');
                localStorage.setItem('bugence-right-collapsed-set', '1');
            }
            if (typeof prefs.liveCanvas === 'boolean') {
                localStorage.setItem('bugence-live-canvas', prefs.liveCanvas ? '1' : '0');
                liveCanvasEnabled = prefs.liveCanvas;
            }
            if (typeof prefs.focusMode === 'boolean') {
                toggleFocusMode(prefs.focusMode);
            }
            if (typeof prefs.inlineAdd === 'boolean') {
                setInlineAddEnabled(prefs.inlineAdd);
            }
            if (typeof prefs.leftCollapsed === 'boolean') {
                setLeftSidebarCollapsed(prefs.leftCollapsed);
            }
            if (typeof prefs.rightCollapsed === 'boolean') {
                setRightSidebarCollapsed(prefs.rightCollapsed);
            }
            if (typeof prefs.liveCanvas === 'boolean') {
                setLiveCanvasEnabled(prefs.liveCanvas);
            }
            if (typeof prefs.canvasGrid === 'boolean') {
                toggleCanvasGrid(prefs.canvasGrid);
            }
            if (prefs.deviceView) {
                const deviceSelect = document.getElementById('deviceSelect');
                if (deviceSelect) {
                    deviceSelect.value = prefs.deviceView;
                    deviceSelect.dispatchEvent(new Event('change'));
                }
            }
            isApplyingEditorPrefs = false;
        }

        function queueEditorPrefsSave() {
            if (!projectId || isApplyingEditorPrefs) return;
            if (editorPrefsSaveTimer) clearTimeout(editorPrefsSaveTimer);
            editorPrefsSaveTimer = setTimeout(async () => {
                try {
                    await fetch(`/Editor?handler=EditorPrefs&projectId=${projectId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': csrfToken
                        },
                        body: JSON.stringify(collectEditorPrefs())
                    });
                } catch {
                    // ignore
                }
            }, 600);
        }

        const buildElementsCatalog = (query) => {
            if (!controlRefs.elementsCatalog) return;
            const term = (query || '').trim().toLowerCase();
            controlRefs.elementsCatalog.innerHTML = '';
            const favorites = loadFavorites();
            const symbols = loadSymbols().filter(symbol => {
                if (!term) return true;
                return symbol.name.toLowerCase().includes(term);
            });
            if (symbols.length) {
                const heading = document.createElement('div');
                heading.className = 'element-category';
                heading.textContent = 'Symbols';
                controlRefs.elementsCatalog.appendChild(heading);
                const grid = document.createElement('div');
                grid.className = 'element-grid';
                symbols.forEach(symbol => {
                    const card = document.createElement('div');
                    card.className = 'element-card';
                    card.setAttribute('data-element', `symbol:${symbol.id}`);
                    card.innerHTML = `
                        <i class="fa-solid fa-layer-group"></i>
                        <div class="el-title">${symbol.name}</div>
                        <div class="el-sub">Saved symbol</div>
                        <div class="symbol-actions" data-symbol-actions="true">
                            <button type="button" data-symbol-action="rename" data-symbol-id="${symbol.id}" title="Rename"></button>
                            <button type="button" data-symbol-action="update" data-symbol-id="${symbol.id}" title="Update from selection"></button>
                            <button type="button" data-symbol-action="delete" data-symbol-id="${symbol.id}" title="Delete"></button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                controlRefs.elementsCatalog.appendChild(grid);
            }
            leftSidebarState.elements.forEach(group => {
                const items = group.items.filter(item => {
                    if (!term) return true;
                    return item.label.toLowerCase().includes(term) || item.desc.toLowerCase().includes(term);
                });
                if (!items.length) return;
                const heading = document.createElement('div');
                heading.className = 'element-category';
                heading.textContent = group.category;
                controlRefs.elementsCatalog.appendChild(heading);
                const grid = document.createElement('div');
                grid.className = 'element-grid';
                items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'element-card';
                    card.setAttribute('data-element', item.id);
                    card.innerHTML = `
                        <i class="${item.icon}"></i>
                        <div class="el-title">${item.label}</div>
                        <div class="el-sub">${item.desc}</div>
                        <div class="el-pin" data-pin="${item.id}" title="${favorites.includes(item.id) ? 'Unpin' : 'Pin'}">
                            <i class="fa-solid fa-thumbtack"></i>
                        </div>
                    `;
                    const pin = card.querySelector('.el-pin');
                    if (pin) {
                        pin.style.position = 'absolute';
                        pin.style.top = '8px';
                        pin.style.right = '8px';
                        pin.style.fontSize = '0.65rem';
                        pin.style.color = favorites.includes(item.id) ? '#67e8f9' : 'rgba(255,255,255,0.35)';
                        pin.style.cursor = 'pointer';
                    }
                    card.style.position = 'relative';
                    grid.appendChild(card);
                });
                controlRefs.elementsCatalog.appendChild(grid);
            });
        };

        const loadPagesStateFromStorage = () => {
            let items = [];
            try {
                const raw = localStorage.getItem(pagesStorageKey);
                items = raw ? JSON.parse(raw) : [];
            } catch {
                items = [];
            }
            if (!items.length) {
                items = [
                    { id: 'home', name: 'Home', path: 'index.html', status: 'published', isHome: true, updatedAt: Date.now() },
                    { id: 'about', name: 'About', path: 'about.html', status: 'draft', isHome: false, updatedAt: Date.now() },
                    { id: 'pricing', name: 'Pricing', path: 'pricing.html', status: 'draft', isHome: false, updatedAt: Date.now() }
                ];
            }
            return items;
        };

        const savePagesState = () => {
            localStorage.setItem(pagesStorageKey, JSON.stringify(pagesState.items));
        };

        const persistPagesState = async () => {
            savePagesState();
            if (!projectId) return;
            try {
                await fetch(`/Editor?handler=Pages&projectId=${projectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({ items: pagesState.items })
                });
            } catch {
                // ignore
            }
        };

        const fetchPagesState = async () => {
            if (!projectId) return null;
            try {
                const response = await fetch(`/Editor?handler=Pages&projectId=${projectId}`);
                if (!response.ok) throw new Error('Failed to fetch pages');
                const data = await response.json();
                return Array.isArray(data.items) ? data.items : null;
            } catch {
                return null;
            }
        };

        const loadPagesState = async () => {
            let items = await fetchPagesState();
            if (!items || !items.length) {
                items = loadPagesStateFromStorage();
            }
            if (filePath) {
                const normalized = filePath.split('/').pop() || filePath;
                const exists = items.some(item => item.path === normalized);
                if (!exists) {
                    items.unshift({
                        id: `page-${Date.now()}`,
                        name: normalized.replace(/\.html$/i, ''),
                        path: normalized,
                        status: 'draft',
                        isHome: items.every(item => !item.isHome),
                        updatedAt: Date.now()
                    });
                }
            }
            pagesState.items = items;
            pagesState.activeId = items.find(item => item.path === (filePath?.split('/').pop() || filePath))?.id || items[0]?.id || null;
            savePagesState();
        };

        const normalizePagePath = (value) => {
            const trimmed = (value || '').trim().replace(/^\//, '');
            if (!trimmed) return '';
            return trimmed.endsWith('.html') ? trimmed : `${trimmed}.html`;
        };

        const slugifyPageName = (value) => {
            return (value || '')
                .toLowerCase()
                .trim()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '') || 'new-page';
        };

        const buildPageTemplate = (template, title) => {
            const safeTitle = title || 'New Page';
            const closeBody = '</bo' + 'dy>';
            const closeHtml = '</ht' + 'ml>';
            if (template === 'hero') {
                return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${safeTitle}</title>
</head>
<body style="font-family:Arial, sans-serif; background:#ffffff; color:#111;">
  <section data-bugence-type="section" style="padding:60px 24px;">
    <div data-bugence-dropzone="true" style="max-width:900px;margin:0 auto;display:flex;flex-direction:column;gap:16px;">
      <span style="letter-spacing:0.2em;text-transform:uppercase;font-size:12px;">Hero</span>
      <h1 style="font-size:42px;line-height:1.1;margin:0;">Build a stunning hero section</h1>
      <p style="font-size:18px;opacity:0.7;">Introduce your product and drive attention to the primary CTA.</p>
      <a href="#" role="button" style="display:inline-flex;align-items:center;justify-content:center;padding:12px 18px;border-radius:999px;background:#0f172a;color:#fff;text-decoration:none;width:fit-content;">Get Started</a>
    </div>
  </section>
${closeBody}
${closeHtml}`;
            }
            if (template === 'contact') {
                return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${safeTitle}</title>
</head>
<body style="font-family:Arial, sans-serif; background:#ffffff; color:#111;">
  <section data-bugence-type="section" style="padding:60px 24px;">
    <div data-bugence-dropzone="true" style="max-width:800px;margin:0 auto;display:grid;gap:20px;">
      <h2 style="font-size:32px;margin:0;">Let's talk</h2>
      <p style="opacity:0.7;">Share your project details and we'll reach out shortly.</p>
      <form style="display:grid;gap:12px;">
        <input type="text" placeholder="Full name" style="padding:12px;border-radius:10px;border:1px solid #e2e8f0;">
        <input type="email" placeholder="Email" style="padding:12px;border-radius:10px;border:1px solid #e2e8f0;">
        <textarea rows="4" placeholder="Tell us more..." style="padding:12px;border-radius:10px;border:1px solid #e2e8f0;"></textarea>
        <button type="button" style="padding:12px 18px;border-radius:12px;background:#2563eb;color:white;border:none;">Send message</button>
      </form>
    </div>
  </section>
${closeBody}
${closeHtml}`;
            }
            return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${safeTitle}</title>
</head>
<body style="font-family:Arial, sans-serif; background:#ffffff; color:#111;">
  <section data-bugence-type="section" style="padding:60px 24px;">
    <div data-bugence-dropzone="true" style="max-width:900px;margin:0 auto;min-height:200px;display:flex;align-items:center;justify-content:center;border:1px dashed #cbd5f5;border-radius:16px;">
      <span style="opacity:0.6;">Drop content here</span>
    </div>
  </section>
${closeBody}
${closeHtml}`;
        };

        const templatePresets = [
            { id: 'blank', label: 'Blank Canvas', desc: 'Start from scratch.' },
            { id: 'hero', label: 'Hero + CTA', desc: 'Bold opener with a call-to-action.' },
            { id: 'contact', label: 'Contact', desc: 'Lead capture form and intro copy.' }
        ];
        const iconLibrary = [
            { label: 'Home', value: 'fa-solid fa-house' },
            { label: 'Star', value: 'fa-solid fa-star' },
            { label: 'Heart', value: 'fa-solid fa-heart' },
            { label: 'Bolt', value: 'fa-solid fa-bolt' },
            { label: 'Music', value: 'fa-solid fa-music' },
            { label: 'Camera', value: 'fa-solid fa-camera' },
            { label: 'Play', value: 'fa-solid fa-play' },
            { label: 'Pause', value: 'fa-solid fa-pause' },
            { label: 'Stop', value: 'fa-solid fa-stop' },
            { label: 'Check', value: 'fa-solid fa-check' },
            { label: 'Close', value: 'fa-solid fa-xmark' },
            { label: 'Mail', value: 'fa-solid fa-envelope' },
            { label: 'Phone', value: 'fa-solid fa-phone' },
            { label: 'Location', value: 'fa-solid fa-location-dot' },
            { label: 'Globe', value: 'fa-solid fa-globe' },
            { label: 'User', value: 'fa-solid fa-user' },
            { label: 'Users', value: 'fa-solid fa-users' },
            { label: 'Briefcase', value: 'fa-solid fa-briefcase' },
            { label: 'Calendar', value: 'fa-solid fa-calendar' },
            { label: 'Clock', value: 'fa-solid fa-clock' },
            { label: 'Chat', value: 'fa-solid fa-comments' },
            { label: 'Chart', value: 'fa-solid fa-chart-line' },
            { label: 'Pie', value: 'fa-solid fa-chart-pie' },
            { label: 'Cloud', value: 'fa-solid fa-cloud' },
            { label: 'Gem', value: 'fa-solid fa-gem' },
            { label: 'Leaf', value: 'fa-solid fa-leaf' },
            { label: 'Idea', value: 'fa-solid fa-lightbulb' },
            { label: 'Lock', value: 'fa-solid fa-lock' },
            { label: 'Shield', value: 'fa-solid fa-shield-halved' },
            { label: 'Search', value: 'fa-solid fa-magnifying-glass' },
            { label: 'Send', value: 'fa-solid fa-paper-plane' },
            { label: 'Rocket', value: 'fa-solid fa-rocket' },
            { label: 'Cart', value: 'fa-solid fa-cart-shopping' },
            { label: 'Tag', value: 'fa-solid fa-tag' },
            { label: 'WiFi', value: 'fa-solid fa-wifi' },
            { label: 'Settings', value: 'fa-solid fa-gear' },
            { label: 'Sliders', value: 'fa-solid fa-sliders' },
            { label: 'Pen', value: 'fa-solid fa-pen' },
            { label: 'Book', value: 'fa-solid fa-book' },
            { label: 'Info', value: 'fa-solid fa-circle-info' },
            { label: 'Alert', value: 'fa-solid fa-triangle-exclamation' },
            { label: 'Facebook', value: 'fa-brands fa-facebook' },
            { label: 'Instagram', value: 'fa-brands fa-instagram' },
            { label: 'Twitter', value: 'fa-brands fa-x-twitter' },
            { label: 'LinkedIn', value: 'fa-brands fa-linkedin' },
            { label: 'YouTube', value: 'fa-brands fa-youtube' },
            { label: 'GitHub', value: 'fa-brands fa-github' },
            { label: 'Discord', value: 'fa-brands fa-discord' },
            { label: 'TikTok', value: 'fa-brands fa-tiktok' }
        ];

        const buildTemplatePreview = (templateId) => {
            if (templateId === 'hero') {
                return `
                    <div style="font-weight:700;font-size:0.95rem;">Hero Headline</div>
                    <div style="opacity:.7;">Short supporting copy for your offer.</div>
                    <div style="display:inline-flex;padding:6px 10px;border-radius:999px;background:#0f172a;color:#fff;width:max-content;">Get Started</div>
                `;
            }
            if (templateId === 'contact') {
                return `
                    <div style="font-weight:700;font-size:0.9rem;">Let's talk</div>
                    <div style="opacity:.7;">Share your details.</div>
                    <div style="height:32px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);"></div>
                    <div style="height:32px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);"></div>
                `;
            }
            return `
                <div style="opacity:.7;">Blank layout</div>
                <div style="height:10px;border-radius:6px;background:rgba(255,255,255,0.12);"></div>
                <div style="height:10px;border-radius:6px;background:rgba(255,255,255,0.08);width:70%;"></div>
            `;
        };
        const renderIconGrid = (query = '') => {
            if (!controlRefs.iconGrid) return;
            const term = (query || '').trim().toLowerCase();
            const items = term
                ? iconLibrary.filter(icon => icon.label.toLowerCase().includes(term) || icon.value.toLowerCase().includes(term))
                : iconLibrary;
            controlRefs.iconGrid.innerHTML = '';
            if (!items.length) {
                controlRefs.iconGrid.innerHTML = '<div class="hint-text">No icons found.</div>';
                return;
            }
            items.forEach(icon => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'icon-card';
                button.setAttribute('data-icon-class', icon.value);
                button.setAttribute('data-icon-label', icon.label);
                button.innerHTML = `<i class="${icon.value}" aria-hidden="true"></i><span>${icon.label}</span>`;
                controlRefs.iconGrid.appendChild(button);
            });
        };

        const renderTemplateGrid = () => {
            if (!controlRefs.templateGrid) return;
            const term = (controlRefs.templateSearchInput?.value || '').trim().toLowerCase();
            const filtered = term
                ? templatePresets.filter(template =>
                    template.label.toLowerCase().includes(term) ||
                    template.desc.toLowerCase().includes(term) ||
                    template.id.toLowerCase().includes(term))
                : templatePresets;
            controlRefs.templateGrid.innerHTML = '';
            if (controlRefs.templateCount) {
                controlRefs.templateCount.textContent = `${filtered.length} templates`;
            }
            if (!filtered.length) {
                controlRefs.templateGrid.innerHTML = '<div class="hint-text">No templates match your search.</div>';
                return;
            }
            filtered.forEach(template => {
                const card = document.createElement('div');
                card.className = 'template-card';
                if (template.id === selectedTemplateId) {
                    card.classList.add('is-active');
                }
                const preview = document.createElement('div');
                preview.className = 'template-preview';
                preview.innerHTML = buildTemplatePreview(template.id);
                const label = document.createElement('div');
                label.className = 'template-label';
                label.textContent = template.label;
                const desc = document.createElement('div');
                desc.className = 'template-desc';
                desc.textContent = template.desc;
                card.appendChild(preview);
                card.appendChild(label);
                card.appendChild(desc);
                card.addEventListener('click', () => {
                    selectedTemplateId = template.id;
                    renderTemplateGrid();
                    if (controlRefs.templatePageNameInput && !controlRefs.templatePageNameInput.value) {
                        controlRefs.templatePageNameInput.value = template.label;
                    }
                    if (controlRefs.templatePagePathInput && !controlRefs.templatePagePathInput.value) {
                        const slug = slugifyPageName(controlRefs.templatePageNameInput?.value || template.label);
                        controlRefs.templatePagePathInput.value = `${slug}.html`;
                    }
                });
                controlRefs.templateGrid.appendChild(card);
            });
        };

        const openTemplateModal = () => {
            if (!controlRefs.templateModal) return;
            if (controlRefs.templateSearchInput) {
                controlRefs.templateSearchInput.value = '';
            }
            renderTemplateGrid();
            setTimeout(() => controlRefs.templateSearchInput?.focus(), 0);
            if (controlRefs.templatePageNameInput && !controlRefs.templatePageNameInput.value) {
                const active = templatePresets.find(item => item.id === selectedTemplateId);
                controlRefs.templatePageNameInput.value = active?.label || 'New Page';
            }
            if (controlRefs.templatePagePathInput && !controlRefs.templatePagePathInput.value) {
                const slug = slugifyPageName(controlRefs.templatePageNameInput?.value || 'new-page');
                controlRefs.templatePagePathInput.value = `${slug}.html`;
            }
            controlRefs.templateModal.classList.add('active');
        };

        const closeTemplateModal = () => {
            controlRefs.templateModal?.classList.remove('active');
        };

        const applyTemplateToCurrentPage = async () => {
            const template = selectedTemplateId || 'blank';
            const currentName = (filePath || '').split('/').pop()?.replace(/\.html$/i, '') || 'New Page';
            const confirmReplace = window.confirm('Replace the current page with this template? This will overwrite the current content.');
            if (!confirmReplace) return;
            const html = buildPageTemplate(template, currentName);
            try {
                await postEditorChange('SavePage', html, filePath || 'index.html');
                reloadIframe(filePath || 'index.html');
                showToast('Template applied.');
                closeTemplateModal();
            } catch {
                showToast('Apply template failed.');
            }
        };

        const createPageFromTemplate = async ({ name, path, template }) => {
            const nameInput = (name || '').trim();
            const pathInput = (path || '').trim();
            const templateId = template || 'blank';
            if (!nameInput && !pathInput) {
                showToast('Add a page name or path.');
                return false;
            }
            const pageName = nameInput || pathInput.replace(/\.html$/i, '');
            const pagePath = normalizePagePath(pathInput || slugifyPageName(pageName));
            if (!pagePath) {
                showToast('Invalid path.');
                return false;
            }
            if (pagesState.items.some(item => item.path === pagePath)) {
                showToast('That page already exists.');
                return false;
            }
            const html = buildPageTemplate(templateId, pageName);
            try {
                await postEditorChange('SavePage', html, pagePath);
            } catch {
                showToast('Create page failed.');
                return false;
            }
            const newPage = {
                id: `page-${Date.now()}`,
                name: pageName,
                path: pagePath,
                status: 'draft',
                isHome: pagesState.items.every(item => !item.isHome),
                updatedAt: Date.now()
            };
            pagesState.items.unshift(newPage);
            await persistPagesState();
            refreshPagesList();
            togglePagesForm(false);
            if (controlRefs.pageNameInput) controlRefs.pageNameInput.value = '';
            if (controlRefs.pagePathInput) controlRefs.pagePathInput.value = '';
            if (controlRefs.templatePageNameInput) controlRefs.templatePageNameInput.value = '';
            if (controlRefs.templatePagePathInput) controlRefs.templatePagePathInput.value = '';
            openPage(newPage);
            return true;
        };

        const getShareLinks = () => {
            const origin = window.location.origin;
            const cleanFile = (filePath || 'index.html').replace(/^\/+/, '');
            const encodedFile = encodeURIComponent(cleanFile);
            const editorLink = `${origin}/Editor?projectId=${projectId}&file=${encodedFile}`;
            const previewLink = `${origin}${previewPrefix}${encodedFile}`;
            const publishedLink = `${origin}/Published/${encodeURIComponent(projectFolder)}/${encodeURI(cleanFile)}`;
            return { editorLink, previewLink, publishedLink };
        };

        const openShareModal = () => {
            if (!controlRefs.shareModal) return;
            const links = getShareLinks();
            if (controlRefs.shareEditorLink) controlRefs.shareEditorLink.value = links.editorLink;
            if (controlRefs.sharePreviewLink) controlRefs.sharePreviewLink.value = links.previewLink;
            if (controlRefs.sharePublishedLink) controlRefs.sharePublishedLink.value = links.publishedLink;
            controlRefs.shareModal.classList.add('active');
        };

        const closeShareModal = () => {
            controlRefs.shareModal?.classList.remove('active');
        };

        const copyToClipboard = async (text) => {
            if (!text) return false;
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch {
                const temp = document.createElement('textarea');
                temp.value = text;
                temp.style.position = 'fixed';
                temp.style.left = '-9999px';
                document.body.appendChild(temp);
                temp.select();
                try {
                    document.execCommand('copy');
                    return true;
                } catch {
                    return false;
                } finally {
                    temp.remove();
                }
            }
        };

        const renderPagesList = (query) => {
            if (!controlRefs.pagesList) return;
            const term = (query || '').trim().toLowerCase();
            controlRefs.pagesList.innerHTML = '';
            const filtered = pagesState.items.filter(page => {
                if (!term) return true;
                return page.name.toLowerCase().includes(term) || page.path.toLowerCase().includes(term);
            });
            if (!filtered.length) {
                controlRefs.pagesList.innerHTML = '<div class="hint-text">No pages found.</div>';
                return;
            }
            filtered.forEach(page => {
                const card = document.createElement('div');
                card.className = 'page-card';
                if (page.id === pagesState.activeId) {
                    card.classList.add('active');
                }
                card.setAttribute('data-page-id', page.id);
                const status = page.status || 'draft';
                card.innerHTML = `
                    <div class="page-info">
                        <div class="page-title">${page.name}</div>
                        <div class="page-meta">
                            <span>${page.path}</span>
                            <span class="page-pill ${page.isHome ? 'home' : status}">${page.isHome ? 'Home' : status}</span>
                        </div>
                    </div>
                    <div class="page-actions">
                        <button class="page-action" data-page-action="open" title="Open"><i class="fa-solid fa-arrow-up-right-from-square"></i></button>
                        <button class="page-action" data-page-action="rename" title="Rename"><i class="fa-solid fa-pen"></i></button>
                        <button class="page-action" data-page-action="duplicate" title="Duplicate"><i class="fa-solid fa-copy"></i></button>
                        <button class="page-action" data-page-action="status" title="Toggle status"><i class="fa-solid fa-circle-check"></i></button>
                        <button class="page-action" data-page-action="home" title="Set Home"><i class="fa-solid fa-house"></i></button>
                        <button class="page-action" data-page-action="delete" title="Delete"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                controlRefs.pagesList.appendChild(card);
            });
        };

        const parseMotionData = (value) => {
            if (!value) return null;
            try {
                const parsed = JSON.parse(value);
                if (!parsed || typeof parsed !== 'object') return null;
                const tracks = Array.isArray(parsed.tracks) ? parsed.tracks : [];
                const scroll = parsed.scroll && typeof parsed.scroll === 'object' ? parsed.scroll : {};
                return {
                    tracks,
                    scroll: {
                        enabled: !!scroll.enabled,
                        start: typeof scroll.start === 'number' ? scroll.start : 10,
                        end: typeof scroll.end === 'number' ? scroll.end : 90,
                        scrub: typeof scroll.scrub === 'number' ? scroll.scrub : 1
                    }
                };
            } catch {
                return null;
            }
        };

        const getMotionTarget = () => {
            const selected = getSelectedElementNode();
            if (!selected) return null;
            const id = ensureBugenceId(selected);
            if (id && editorBridge.selection?.attributes) {
                editorBridge.selection.attributes['data-bugence-id'] = id;
            }
            return selected;
        };

        const ensureMotionTrack = (data, property) => {
            if (!data) return null;
            if (!Array.isArray(data.tracks)) {
                data.tracks = [];
            }
            let track = data.tracks.find(item => item.property === property);
            if (!track) {
                track = { property, easing: 'linear', keyframes: [] };
                data.tracks.push(track);
            }
            if (!Array.isArray(track.keyframes)) {
                track.keyframes = [];
            }
            return track;
        };

        const getActiveMotionProperty = () => controlRefs.motionPropertySelect?.value || 'opacity';

        const getActiveMotionTrack = () => {
            const property = getActiveMotionProperty();
            return ensureMotionTrack(motionState, property);
        };

        const updateMotionBadge = () => {
            const label = controlRefs.motionPropertySelect?.selectedOptions?.[0]?.textContent || 'Motion';
            if (controlRefs.motionTrackBadge) {
                controlRefs.motionTrackBadge.textContent = label;
            }
        };

        const parseMatrix = (transform, doc) => {
            if (!transform || transform === 'none') {
                return { a: 1, b: 0, c: 0, d: 1, e: 0, f: 0 };
            }
            const Matrix = doc?.defaultView?.DOMMatrixReadOnly || doc?.defaultView?.DOMMatrix;
            if (Matrix) {
                const matrix = new Matrix(transform);
                return { a: matrix.a, b: matrix.b, c: matrix.c, d: matrix.d, e: matrix.e, f: matrix.f };
            }
            const match = transform.match(/matrix\(([^)]+)\)/);
            if (!match) return { a: 1, b: 0, c: 0, d: 1, e: 0, f: 0 };
            const parts = match[1].split(',').map(item => parseFloat(item.trim()));
            return {
                a: parts[0] || 1,
                b: parts[1] || 0,
                c: parts[2] || 0,
                d: parts[3] || 1,
                e: parts[4] || 0,
                f: parts[5] || 0
            };
        };

        const captureMotionValue = (el, property) => {
            const doc = getCanvasDocument();
            if (!doc || !el) return 0;
            const computed = doc.defaultView?.getComputedStyle(el);
            if (!computed) return 0;
            if (property === 'opacity') {
                return parseFloat(computed.opacity || '1') || 1;
            }
            const matrix = parseMatrix(computed.transform, doc);
            if (property === 'translateY') {
                return Math.round(matrix.f || 0);
            }
            if (property === 'scale') {
                return Number((matrix.a || 1).toFixed(2));
            }
            if (property === 'rotate') {
                const radians = Math.atan2(matrix.b, matrix.a);
                return Math.round((radians * 180) / Math.PI);
            }
            return 0;
        };

        const persistMotionState = () => {
            const target = getMotionTarget();
            if (!target) return;
            const id = ensureBugenceId(target);
            if (!id) return;
            const beforeMotion = target.getAttribute('data-bugence-motion') || '';
            const afterMotion = JSON.stringify(motionState || { tracks: [], scroll: { enabled: false, start: 10, end: 90, scrub: 1 } });
            sendToIframe('bugence-editor:motion-update', {
                selector: `[data-bugence-id="${id}"]`,
                motion: motionState
            });
            if (beforeMotion !== afterMotion) {
                pushHistoryOp({
                    type: 'motion',
                    targetId: id,
                    beforeMotion,
                    afterMotion
                });
            }
            scheduleAutoSave();
        };

        const previewMotionAt = (progress) => {
            const target = getMotionTarget();
            if (!target) return;
            const id = ensureBugenceId(target);
            if (!id) return;
            sendToIframe('bugence-editor:motion-preview', {
                selector: `[data-bugence-id="${id}"]`,
                progress
            });
            sendToIframe('bugence-editor:lottie-seek', {
                selector: `[data-bugence-id="${id}"]`,
                progress
            });
        };

        const renderMotionKeyframes = () => {
            if (!controlRefs.motionKeyframes) return;
            const track = getActiveMotionTrack();
            controlRefs.motionKeyframes.innerHTML = '';
            if (!track || !track.keyframes.length) {
                controlRefs.motionKeyframes.innerHTML = '<div class="hint-text">No keyframes yet.</div>';
                return;
            }
            const property = track.property;
            const step = property === 'opacity' || property === 'scale' ? '0.05' : '1';
            const min = property === 'opacity' ? '0' : '';
            const max = property === 'opacity' ? '1' : '';
            track.keyframes
                .sort((a, b) => a.t - b.t)
                .forEach((kf, index) => {
                    const row = document.createElement('div');
                    row.className = 'keyframe-item';
                    const timeInput = document.createElement('input');
                    timeInput.type = 'number';
                    timeInput.min = '0';
                    timeInput.max = '100';
                    timeInput.step = '1';
                    timeInput.value = kf.t;
                    const valueInput = document.createElement('input');
                    valueInput.type = 'number';
                    if (min) valueInput.min = min;
                    if (max) valueInput.max = max;
                    valueInput.step = step;
                    valueInput.value = kf.value;
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.textContent = '';
                    timeInput.addEventListener('change', () => {
                        kf.t = Math.min(100, Math.max(0, parseFloat(timeInput.value) || 0));
                        persistMotionState();
                        renderMotionKeyframes();
                    });
                    valueInput.addEventListener('input', () => {
                        kf.value = parseFloat(valueInput.value) || 0;
                        persistMotionState();
                        previewMotionAt(motionPlayheadValue);
                    });
                    removeBtn.addEventListener('click', () => {
                        track.keyframes.splice(index, 1);
                        persistMotionState();
                        renderMotionKeyframes();
                    });
                    row.appendChild(timeInput);
                    row.appendChild(valueInput);
                    row.appendChild(removeBtn);
                    controlRefs.motionKeyframes.appendChild(row);
                });
        };

        const syncMotionControlsFromSelection = () => {
            const target = getMotionTarget();
            const label = target
                ? `<${target.tagName.toLowerCase()}> ${target.id ? `#${target.id}` : ''}`.trim()
                : 'No selection';
            if (controlRefs.motionTargetLabel) {
                controlRefs.motionTargetLabel.textContent = label;
            }
            if (!target) {
                motionState = { tracks: [], scroll: { enabled: false, start: 10, end: 90, scrub: 1 } };
                renderMotionKeyframes();
                renderSvgPathList();
                return;
            }
            const raw = target.getAttribute('data-bugence-motion');
            motionState = parseMotionData(raw) || { tracks: [], scroll: { enabled: false, start: 10, end: 90, scrub: 1 } };
            if (controlRefs.lottieUrlInput) {
                const lottieTarget = target.tagName?.toLowerCase() === 'lottie-player'
                    ? target
                    : target.querySelector?.('lottie-player');
                controlRefs.lottieUrlInput.value = target.getAttribute('data-bugence-lottie')
                    || lottieTarget?.getAttribute?.('src')
                    || '';
            }
            if (controlRefs.lottieLoopInput) {
                const lottieTarget = target.tagName?.toLowerCase() === 'lottie-player'
                    ? target
                    : target.querySelector?.('lottie-player');
                controlRefs.lottieLoopInput.checked = !!lottieTarget?.hasAttribute?.('loop');
            }
            if (controlRefs.lottieAutoplayInput) {
                const lottieTarget = target.tagName?.toLowerCase() === 'lottie-player'
                    ? target
                    : target.querySelector?.('lottie-player');
                controlRefs.lottieAutoplayInput.checked = !!lottieTarget?.hasAttribute?.('autoplay');
            }
            const track = getActiveMotionTrack();
            if (controlRefs.motionEasingSelect && track?.easing) {
                controlRefs.motionEasingSelect.value = track.easing;
            }
            if (controlRefs.motionScrollEnabled) {
                controlRefs.motionScrollEnabled.checked = !!motionState.scroll?.enabled;
            }
            if (controlRefs.motionScrollStart) {
                controlRefs.motionScrollStart.value = motionState.scroll?.start ?? 10;
            }
            if (controlRefs.motionScrollEnd) {
                controlRefs.motionScrollEnd.value = motionState.scroll?.end ?? 90;
            }
            if (controlRefs.motionScrollScrub) {
                controlRefs.motionScrollScrub.value = motionState.scroll?.scrub ?? 1;
            }
            updateMotionBadge();
            renderMotionKeyframes();
            renderSvgPathList();
        };

        const renderSvgPathList = () => {
            if (!controlRefs.svgPathList) return;
            controlRefs.svgPathList.innerHTML = '';
            const doc = getCanvasDocument();
            const target = getMotionTarget();
            if (!doc || !target) {
                controlRefs.svgPathList.innerHTML = '<div class="hint-text">Select an SVG element.</div>';
                return;
            }
            const svg = target.tagName?.toLowerCase() === 'svg'
                ? target
                : target.querySelector?.('svg');
            if (!svg) {
                controlRefs.svgPathList.innerHTML = '<div class="hint-text">Select an SVG to edit paths.</div>';
                return;
            }
            const paths = Array.from(svg.querySelectorAll('path'));
            if (!paths.length) {
                controlRefs.svgPathList.innerHTML = '<div class="hint-text">No SVG paths found.</div>';
                return;
            }
            paths.forEach((path, index) => {
                const row = document.createElement('div');
                row.className = 'keyframe-item';
                const fillInput = document.createElement('input');
                fillInput.type = 'color';
                const strokeInput = document.createElement('input');
                strokeInput.type = 'color';
                const fillValue = normalizeColor(path.getAttribute('fill') || doc.defaultView?.getComputedStyle(path).fill || '#ffffff');
                const strokeValue = normalizeColor(path.getAttribute('stroke') || doc.defaultView?.getComputedStyle(path).stroke || '#ffffff');
                fillInput.value = fillValue.startsWith('#') ? fillValue : '#ffffff';
                strokeInput.value = strokeValue.startsWith('#') ? strokeValue : '#ffffff';
                const label = document.createElement('div');
                label.textContent = `Path ${index + 1}`;
                label.style.fontSize = '0.7rem';
                label.style.color = 'var(--muted)';
                row.appendChild(fillInput);
                row.appendChild(strokeInput);
                row.appendChild(label);
                fillInput.addEventListener('input', () => {
                    path.setAttribute('fill', fillInput.value);
                    scheduleHistorySnapshot();
                    scheduleAutoSave();
                });
                strokeInput.addEventListener('input', () => {
                    path.setAttribute('stroke', strokeInput.value);
                    scheduleHistorySnapshot();
                    scheduleAutoSave();
                });
                controlRefs.svgPathList.appendChild(row);
            });
        };

        const updateMotionScrollSettings = () => {
            const clampValue = (value, min, max) => Math.min(max, Math.max(min, value));
            motionState.scroll = {
                enabled: !!controlRefs.motionScrollEnabled?.checked,
                start: clampValue(parseFloat(controlRefs.motionScrollStart?.value) || 0, 0, 100),
                end: clampValue(parseFloat(controlRefs.motionScrollEnd?.value) || 100, 0, 100),
                scrub: clampValue(parseFloat(controlRefs.motionScrollScrub?.value) || 1, 0, 1)
            };
            persistMotionState();
        };

        const getPageById = (id) => pagesState.items.find(page => page.id === id);

        const openPage = (page) => {
            if (!page?.path || !projectId) return;
            const next = `/Editor?projectId=${projectId}&file=${encodeURIComponent(page.path)}`;
            window.location.href = next;
        };

        const togglePagesForm = (show) => {
            if (!controlRefs.pagesForm) return;
            controlRefs.pagesForm.style.display = show ? 'block' : 'none';
        };

        const refreshPagesList = () => {
            renderPagesList(controlRefs.pagesSearch?.value || '');
        };

        const renamePage = async (page) => {
            if (!page) return;
            const name = window.prompt('Rename page', page.name || page.path);
            if (!name || !name.trim()) return;
            const pathPrompt = window.prompt('Update file path', page.path);
            if (!pathPrompt) return;
            const newPath = normalizePagePath(pathPrompt);
            if (!newPath) return;
            const pathExists = pagesState.items.some(item => item.path === newPath && item.id !== page.id);
            if (pathExists) {
                showToast('That path already exists.');
                return;
            }
            if (newPath !== page.path) {
                try {
                    const response = await fetch(`/Editor?handler=RenamePage&projectId=${projectId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': csrfToken
                        },
                        body: JSON.stringify({ path: page.path, newPath })
                    });
                    if (!response.ok) throw new Error('Rename failed');
                } catch {
                    showToast('Rename failed.');
                    return;
                }
            }
            page.name = name.trim();
            page.path = newPath;
            page.updatedAt = Date.now();
            await persistPagesState();
            refreshPagesList();
            if (page.id === pagesState.activeId && newPath !== (filePath?.split('/').pop() || filePath)) {
                openPage(page);
            }
        };

        const duplicatePage = async (page) => {
            if (!page) return;
            const name = window.prompt('Duplicate page name', `${page.name} Copy`);
            if (!name || !name.trim()) return;
            const suggestedPath = `${slugifyPageName(name)}.html`;
            const pathPrompt = window.prompt('New file path', suggestedPath);
            if (!pathPrompt) return;
            const newPath = normalizePagePath(pathPrompt);
            if (!newPath) return;
            const pathExists = pagesState.items.some(item => item.path === newPath);
            if (pathExists) {
                showToast('That path already exists.');
                return;
            }
            try {
                const response = await fetch(`/Editor?handler=DuplicatePage&projectId=${projectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({ sourcePath: page.path, destinationPath: newPath })
                });
                if (!response.ok) throw new Error('Duplicate failed');
            } catch {
                showToast('Duplicate failed.');
                return;
            }
            pagesState.items.unshift({
                id: `page-${Date.now()}`,
                name: name.trim(),
                path: newPath,
                status: 'draft',
                isHome: false,
                updatedAt: Date.now()
            });
            await persistPagesState();
            refreshPagesList();
        };

        const deletePage = async (page) => {
            if (!page) return;
            if (!window.confirm(`Delete ${page.name}?`)) return;
            try {
                const response = await fetch(`/Editor?handler=DeletePage&projectId=${projectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({ path: page.path })
                });
                if (!response.ok) throw new Error('Delete failed');
            } catch {
                showToast('Delete failed.');
                return;
            }
            pagesState.items = pagesState.items.filter(item => item.id !== page.id);
            if (page.id === pagesState.activeId) {
                const home = pagesState.items.find(item => item.isHome) || pagesState.items[0];
                pagesState.activeId = home?.id || null;
                await persistPagesState();
                refreshPagesList();
                if (home) openPage(home);
                return;
            }
            await persistPagesState();
            refreshPagesList();
        };

        const togglePageStatus = async (page) => {
            if (!page) return;
            page.status = page.status === 'published' ? 'draft' : 'published';
            page.updatedAt = Date.now();
            await persistPagesState();
            refreshPagesList();
            if (page.id === pagesState.activeId && page.status === 'published') {
                const html = normalizeEditorUrls(getIframeHtml());
                if (html) {
                    try {
                        await postEditorChange('PublishPage', html, page.path);
                        showToast('Page published.');
                    } catch {
                        showToast('Publish failed.');
                    }
                }
            }
            try {
                await fetch(`/Editor?handler=PublishStatus&projectId=${projectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({ published: page.status === 'published' })
                });
            } catch {
                // ignore
            }
        };

        const setHomePage = async (page) => {
            if (!page) return;
            pagesState.items.forEach(item => {
                item.isHome = item.id === page.id;
            });
            page.updatedAt = Date.now();
            await persistPagesState();
            refreshPagesList();
        };

        const defaultFavorites = ['section', 'container', 'grid', 'heading', 'text', 'button', 'image'];
        const favoritesKey = 'bugence-elements-favorites';
        const symbolsKey = 'bugence-editor-symbols';
        const designTokensKey = 'bugence-editor-design-system';
        let symbolsState = null;
        let designSystemState = null;

        const loadSymbols = () => {
            if (symbolsState) return symbolsState;
            try {
                const raw = localStorage.getItem(symbolsKey);
                const parsed = JSON.parse(raw || '[]');
                symbolsState = Array.isArray(parsed) ? parsed : [];
                return symbolsState;
            } catch {
                symbolsState = [];
                return symbolsState;
            }
        };

        const saveSymbols = (symbols) => {
            symbolsState = Array.isArray(symbols) ? symbols : [];
            try {
                localStorage.setItem(symbolsKey, JSON.stringify(symbolsState));
            } catch {
                // ignore
            }
        };

        const persistSymbols = async (symbols) => {
            saveSymbols(symbols);
            if (!projectId) return;
            try {
                await fetch(`/Editor?handler=Symbols&projectId=${projectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({ items: symbols })
                });
            } catch {
                // ignore
            }
        };

        const fetchSymbols = async () => {
            if (!projectId) return loadSymbols();
            try {
                const response = await fetch(`/Editor?handler=Symbols&projectId=${projectId}`);
                if (!response.ok) throw new Error('Failed to fetch symbols');
                const data = await response.json();
                const items = Array.isArray(data.items) ? data.items : [];
                saveSymbols(items);
                return items;
            } catch {
                return loadSymbols();
            }
        };

        const defaultDesignTokens = {
            textPrimary: '#ffffff',
            textSecondary: '#a1a1aa',
            bgBlack: '#020202',
            accentCyan: '#06b6d4',
            accentBlue: '#2563eb',
            spaceSm: '8',
            spaceMd: '16',
            spaceLg: '24',
            spaceXl: '32',
            radiusSm: '6',
            radiusMd: '12',
            radiusLg: '20',
            radiusXl: '28',
            fontBase: '16',
            fontScale: '1.12'
        };

        const loadDesignSystemState = () => {
            try {
                const raw = localStorage.getItem(designTokensKey);
                const parsed = JSON.parse(raw || '{}');
                return {
                    presets: Array.isArray(parsed.presets) ? parsed.presets : [],
                    pages: typeof parsed.pages === 'object' && parsed.pages ? parsed.pages : {}
                };
            } catch {
                return { presets: [], pages: {} };
            }
        };

        const loadDesignTokens = () => {
            if (!designSystemState) {
                designSystemState = loadDesignSystemState();
            }
            const pageTokens = designSystemState.pages?.[editorFilePath] || {};
            return { ...defaultDesignTokens, ...pageTokens };
        };

        const saveDesignSystemStateLocal = (state) => {
            try {
                localStorage.setItem(designTokensKey, JSON.stringify(state));
            } catch {
                // ignore
            }
        };

        const persistDesignSystemState = async () => {
            if (!designSystemState) return;
            saveDesignSystemStateLocal(designSystemState);
            if (!projectId) return;
            try {
                await fetch(`/Editor?handler=DesignTokens&projectId=${projectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify(designSystemState)
                });
            } catch {
                // ignore
            }
        };

        const saveDesignTokens = (tokens) => {
            if (!designSystemState) {
                designSystemState = loadDesignSystemState();
            }
            designSystemState.pages = designSystemState.pages || {};
            designSystemState.pages[editorFilePath] = tokens;
            persistDesignSystemState();
        };

        const fetchDesignSystemState = async () => {
            if (!projectId) {
                designSystemState = loadDesignSystemState();
                return designSystemState;
            }
            try {
                const response = await fetch(`/Editor?handler=DesignTokens&projectId=${projectId}`);
                if (!response.ok) throw new Error('Failed to load design tokens');
                const data = await response.json();
                designSystemState = {
                    presets: Array.isArray(data.presets) ? data.presets : [],
                    pages: typeof data.pages === 'object' && data.pages ? data.pages : {}
                };
                saveDesignSystemStateLocal(designSystemState);
                return designSystemState;
            } catch {
                designSystemState = loadDesignSystemState();
                return designSystemState;
            }
        };

        const hexToRgba = (hex, alpha) => {
            const cleaned = (hex || '').replace('#', '').trim();
            if (![3, 6].includes(cleaned.length)) return `rgba(6,182,212,${alpha})`;
            const normalized = cleaned.length === 3
                ? cleaned.split('').map((c) => `${c}${c}`).join('')
                : cleaned;
            const num = parseInt(normalized, 16);
            if (Number.isNaN(num)) return `rgba(6,182,212,${alpha})`;
            const r = (num >> 16) & 255;
            const g = (num >> 8) & 255;
            const b = num & 255;
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };

        const applyDesignTokens = (doc, tokens) => {
            if (!doc || !tokens) return;
            const root = doc.documentElement;
            root.style.setProperty('--text-primary', tokens.textPrimary);
            root.style.setProperty('--text-secondary', tokens.textSecondary);
            root.style.setProperty('--bg-black', tokens.bgBlack);
            root.style.setProperty('--accent-cyan', tokens.accentCyan);
            root.style.setProperty('--accent-blue', tokens.accentBlue);
            root.style.setProperty('--accent-glow', hexToRgba(tokens.accentCyan, 0.5));
            root.style.setProperty('--space-sm', `${tokens.spaceSm}px`);
            root.style.setProperty('--space-md', `${tokens.spaceMd}px`);
            root.style.setProperty('--space-lg', `${tokens.spaceLg}px`);
            root.style.setProperty('--space-xl', `${tokens.spaceXl}px`);
            root.style.setProperty('--radius-sm', `${tokens.radiusSm}px`);
            root.style.setProperty('--radius-md', `${tokens.radiusMd}px`);
            root.style.setProperty('--radius-lg', `${tokens.radiusLg}px`);
            root.style.setProperty('--radius-xl', `${tokens.radiusXl}px`);
            root.style.setProperty('--font-base', `${tokens.fontBase}px`);
            root.style.setProperty('--font-scale', tokens.fontScale);
            if (tokens.fontBase) {
                root.style.fontSize = `${tokens.fontBase}px`;
            }
        };

        const syncDesignTokenInputs = (tokens) => {
            if (controlRefs.tokenTextPrimary) controlRefs.tokenTextPrimary.value = tokens.textPrimary;
            if (controlRefs.tokenTextSecondary) controlRefs.tokenTextSecondary.value = tokens.textSecondary;
            if (controlRefs.tokenBgBlack) controlRefs.tokenBgBlack.value = tokens.bgBlack;
            if (controlRefs.tokenAccentCyan) controlRefs.tokenAccentCyan.value = tokens.accentCyan;
            if (controlRefs.tokenAccentBlue) controlRefs.tokenAccentBlue.value = tokens.accentBlue;
            if (controlRefs.tokenSpaceSm) controlRefs.tokenSpaceSm.value = tokens.spaceSm;
            if (controlRefs.tokenSpaceMd) controlRefs.tokenSpaceMd.value = tokens.spaceMd;
            if (controlRefs.tokenSpaceLg) controlRefs.tokenSpaceLg.value = tokens.spaceLg;
            if (controlRefs.tokenSpaceXl) controlRefs.tokenSpaceXl.value = tokens.spaceXl;
            if (controlRefs.tokenRadiusSm) controlRefs.tokenRadiusSm.value = tokens.radiusSm;
            if (controlRefs.tokenRadiusMd) controlRefs.tokenRadiusMd.value = tokens.radiusMd;
            if (controlRefs.tokenRadiusLg) controlRefs.tokenRadiusLg.value = tokens.radiusLg;
            if (controlRefs.tokenRadiusXl) controlRefs.tokenRadiusXl.value = tokens.radiusXl;
            if (controlRefs.tokenFontBase) controlRefs.tokenFontBase.value = tokens.fontBase;
            if (controlRefs.tokenFontScale) controlRefs.tokenFontScale.value = tokens.fontScale;
        };

        const getDesignTokensFromInputs = () => ({
            textPrimary: controlRefs.tokenTextPrimary?.value || defaultDesignTokens.textPrimary,
            textSecondary: controlRefs.tokenTextSecondary?.value || defaultDesignTokens.textSecondary,
            bgBlack: controlRefs.tokenBgBlack?.value || defaultDesignTokens.bgBlack,
            accentCyan: controlRefs.tokenAccentCyan?.value || defaultDesignTokens.accentCyan,
            accentBlue: controlRefs.tokenAccentBlue?.value || defaultDesignTokens.accentBlue,
            spaceSm: controlRefs.tokenSpaceSm?.value || defaultDesignTokens.spaceSm,
            spaceMd: controlRefs.tokenSpaceMd?.value || defaultDesignTokens.spaceMd,
            spaceLg: controlRefs.tokenSpaceLg?.value || defaultDesignTokens.spaceLg,
            spaceXl: controlRefs.tokenSpaceXl?.value || defaultDesignTokens.spaceXl,
            radiusSm: controlRefs.tokenRadiusSm?.value || defaultDesignTokens.radiusSm,
            radiusMd: controlRefs.tokenRadiusMd?.value || defaultDesignTokens.radiusMd,
            radiusLg: controlRefs.tokenRadiusLg?.value || defaultDesignTokens.radiusLg,
            radiusXl: controlRefs.tokenRadiusXl?.value || defaultDesignTokens.radiusXl,
            fontBase: controlRefs.tokenFontBase?.value || defaultDesignTokens.fontBase,
            fontScale: controlRefs.tokenFontScale?.value || defaultDesignTokens.fontScale
        });

        const applyDesignTokensToIframe = (tokens) => {
            const doc = getCanvasDocument();
            if (!doc) return;
            const nextTokens = tokens || loadDesignTokens();
            applyDesignTokens(doc, nextTokens);
        };

        const refreshTokenPresetSelect = () => {
            if (!controlRefs.tokenPresetSelect) return;
            const state = designSystemState || loadDesignSystemState();
            const presets = state.presets || [];
            controlRefs.tokenPresetSelect.innerHTML = '<option value="current">Current</option>';
            presets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                controlRefs.tokenPresetSelect.appendChild(option);
            });
        };

        const applyPresetTokens = (presetId) => {
            if (!presetId || presetId === 'current') return;
            const state = designSystemState || loadDesignSystemState();
            const preset = (state.presets || []).find(item => item.id === presetId);
            if (!preset || !preset.tokens) return;
            syncDesignTokenInputs({ ...defaultDesignTokens, ...preset.tokens });
            handleDesignTokenInput();
        };

        const loadFavorites = () => {
            try {
                const raw = localStorage.getItem(favoritesKey);
                if (!raw) return defaultFavorites.slice();
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed)) return parsed;
            } catch {
                // ignore
            }
            return defaultFavorites.slice();
        };

        const saveFavorites = (items) => {
            try {
                localStorage.setItem(favoritesKey, JSON.stringify(items));
            } catch {
                // ignore
            }
            queueEditorPrefsSave();
        };

        const buildFavorites = () => {
            if (!controlRefs.elementsFavorites) return;
            controlRefs.elementsFavorites.innerHTML = '';
            const favorites = loadFavorites().map(id => {
                for (const group of leftSidebarState.elements) {
                    const match = group.items.find(item => item.id === id);
                    if (match) return match;
                }
                return null;
            }).filter(Boolean);
            favorites.forEach(item => {
                const chip = document.createElement('div');
                chip.className = 'favorite-chip';
                chip.setAttribute('data-element', item.id);
                chip.setAttribute('draggable', 'true');
                chip.innerHTML = `<i class="${item.icon}"></i>${item.label}`;
                controlRefs.elementsFavorites.appendChild(chip);
            });
        };

        const structureContent = document.createElement('div');
        structureContent.innerHTML = `
            <div class="action-row" style="margin-bottom:10px;">
                <button class="action-btn" id="dockStructureBtnInline" type="button">Docked</button>
                <button class="action-btn" id="floatStructureBtn" type="button">Floating</button>
            </div>
            <div class="structure-list" id="structureList"></div>
        `;

        const setStructureDocked = (docked) => {
            const dockTarget = controlRefs.structureDockTarget;
            const floatTarget = controlRefs.structureFloatTarget;
            const floating = controlRefs.structureFloating;
            const dockPill = controlRefs.structureDockPill;
            if (!dockTarget || !floatTarget || !floating || !dockPill) return;
            if (docked) {
                dockTarget.appendChild(structureContent);
                floating.classList.add('hidden');
                dockPill.classList.remove('show');
            } else {
                floatTarget.appendChild(structureContent);
                floating.classList.remove('hidden');
                dockPill.classList.remove('show');
            }
            const dockBtnInline = structureContent.querySelector('#dockStructureBtnInline');
            const floatBtn = structureContent.querySelector('#floatStructureBtn');
            dockBtnInline?.classList.toggle('is-active', docked);
            floatBtn?.classList.toggle('is-active', !docked);
            localStorage.setItem('bugence-structure-docked', docked ? '1' : '0');
        };

        const initStructurePanel = () => {
            const storedDocked = localStorage.getItem('bugence-structure-docked');
            const docked = storedDocked == null ? isMobileEditorViewport() : storedDocked === '1';
            setStructureDocked(docked ? true : false);
            const floatBtn = structureContent.querySelector('#floatStructureBtn');
            const dockBtnInline = structureContent.querySelector('#dockStructureBtnInline');
            floatBtn?.addEventListener('click', () => setStructureDocked(false));
            dockBtnInline?.addEventListener('click', () => setStructureDocked(true));
            controlRefs.dockStructureBtn?.addEventListener('click', () => setStructureDocked(true));
            controlRefs.closeStructureBtn?.addEventListener('click', () => {
                controlRefs.structureFloating?.classList.add('hidden');
                controlRefs.structureDockPill?.classList.add('show');
            });
            controlRefs.structureDockPill?.addEventListener('click', () => {
                controlRefs.structureDockPill?.classList.remove('show');
                setStructureDocked(false);
            });
        };

        const setToolDrawerOpen = (open, mode) => {
            if (!controlRefs.toolDrawer) return;
            if (mode) {
                controlRefs.toolDrawer.dataset.mode = mode;
            }
            controlRefs.toolDrawer.classList.toggle('is-open', open);
            const activeMode = controlRefs.toolDrawer.dataset.mode || mode;
            document.querySelectorAll('.tool-btn[data-tool="drawer"]').forEach(btn => {
                const btnMode = btn.getAttribute('data-drawer');
                btn.classList.toggle('active', open && (!activeMode || btnMode === activeMode));
            });
        };

        const toggleToolDrawer = (mode) => {
            if (!controlRefs.toolDrawer) return;
            const activeMode = controlRefs.toolDrawer.dataset.mode || 'shapes';
            const nextMode = mode || activeMode;
            const isOpen = controlRefs.toolDrawer.classList.contains('is-open');
            if (isOpen && activeMode === nextMode) {
                setToolDrawerOpen(false);
                return;
            }
            setToolDrawerOpen(true, nextMode);
        };

        const setActiveToolButton = (target) => {
            document.querySelectorAll('.tool-btn').forEach(btn => {
                if (btn.getAttribute('data-tool') === 'drawer') return;
                btn.classList.toggle('active', btn === target);
            });
        };

        const openUtilityPanel = (panelKey) => {
            if (!controlRefs.utilityPanel || !panelKey) return;
            if (isMobileEditorViewport()) {
                setMobilePanelOpen('left', false);
                setMobilePanelOpen('right', false);
            }
            activeUtilityPanel = panelKey;
            controlRefs.utilityPanel.classList.add('is-open');
            const titleMap = {
                ai: 'AI Assist',
                motion: 'Motion Studio',
                search: 'Search',
                history: 'History',
                settings: 'Settings',
                style: 'Quick Style',
                icons: 'Icons'
            };
            if (controlRefs.utilityTitle) {
                controlRefs.utilityTitle.textContent = titleMap[panelKey] || 'Quick Tools';
            }
            document.querySelectorAll('[data-utility-panel]').forEach(section => {
                section.classList.toggle('is-active', section.getAttribute('data-utility-panel') === panelKey);
            });
            if (panelKey === 'history') {
                renderHistoryPanel();
            }
            if (panelKey === 'search') {
                setTimeout(() => controlRefs.canvasSearchInput?.focus(), 0);
            }
            if (panelKey === 'settings') {
                syncUtilitySettingsState();
            }
            if (panelKey === 'motion') {
                syncMotionControlsFromSelection();
            }
            if (panelKey === 'icons') {
                renderIconGrid(controlRefs.iconSearchInput?.value || '');
                setTimeout(() => controlRefs.iconSearchInput?.focus(), 0);
            }
        };

        const closeUtilityPanel = () => {
            if (!controlRefs.utilityPanel) return;
            controlRefs.utilityPanel.classList.remove('is-open');
            activeUtilityPanel = null;
            document.querySelectorAll('[data-utility-panel]').forEach(section => {
                section.classList.remove('is-active');
            });
            const elementsBtn = document.querySelector('.tool-btn[data-tool="elements"]');
            if (elementsBtn) setActiveToolButton(elementsBtn);
        };

        const toggleUtilityPanel = (panelKey) => {
            if (!panelKey) return;
            if (activeUtilityPanel === panelKey && controlRefs.utilityPanel?.classList.contains('is-open')) {
                closeUtilityPanel();
                return;
            }
            openUtilityPanel(panelKey);
        };

        const toggleCanvasGrid = (enabled) => {
            const doc = getCanvasDocument();
            if (!doc) return;
            let grid = doc.getElementById('bugence-canvas-grid');
            if (enabled) {
                if (!grid) {
                    grid = doc.createElement('div');
                    grid.id = 'bugence-canvas-grid';
                    grid.setAttribute('data-bugence-editor', 'true');
                    grid.style.position = 'fixed';
                    grid.style.inset = '0';
                    grid.style.pointerEvents = 'none';
                    grid.style.zIndex = '2147483000';
                    grid.style.backgroundImage = 'linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px)';
                    grid.style.backgroundSize = '40px 40px';
                    grid.style.opacity = '0.35';
                    (doc.documentElement || doc.body).appendChild(grid);
                }
            } else if (grid) {
                grid.remove();
            }
            localStorage.setItem('bugence-canvas-grid', enabled ? '1' : '0');
            document.querySelectorAll('[data-tool-toggle="canvas-grid"]').forEach(btn => {
                btn.classList.toggle('is-active', enabled);
            });
            syncUtilitySettingsState();
            queueEditorPrefsSave();
        };

        const toggleFocusMode = (enabled) => {
            document.body.classList.toggle('focus-mode', enabled);
            localStorage.setItem('bugence-focus-mode', enabled ? '1' : '0');
            document.querySelectorAll('[data-tool-toggle="focus-mode"]').forEach(btn => {
                btn.classList.toggle('is-active', enabled);
            });
            syncUtilitySettingsState();
            queueEditorPrefsSave();
        };

        const setInlineAddEnabled = (enabled) => {
            inlineAddEnabled = enabled;
            localStorage.setItem('bugence-inline-add', enabled ? '1' : '0');
            rebuildInlineAdd();
            syncUtilitySettingsState();
            queueEditorPrefsSave();
        };

        const setLiveCanvasEnabled = (enabled) => {
            liveCanvasEnabled = !!enabled;
            localStorage.setItem('bugence-live-canvas', liveCanvasEnabled ? '1' : '0');
            const wrap = document.querySelector('.canvas-wrap');
            if (wrap) {
                wrap.classList.toggle('is-paused', !liveCanvasEnabled);
            }
            if (controlRefs.liveCanvasToggle) {
                controlRefs.liveCanvasToggle.innerHTML = liveCanvasEnabled
                    ? '<i class="fa-solid fa-wave-square"></i> Live Canvas'
                    : '<i class="fa-solid fa-pause"></i> Canvas Paused';
            }
            if (editorIframe) {
                editorIframe.style.pointerEvents = liveCanvasEnabled ? 'auto' : 'none';
            }
            sendToIframe('bugence-editor:live-mode', { enabled: liveCanvasEnabled });
            queueEditorPrefsSave();
        };

        const isMobileEditorViewport = () => window.matchMedia('(max-width: 980px)').matches;

        const setMobilePanelOpen = (side, open) => {
            const isLeft = side === 'left';
            if (!isMobileEditorViewport()) {
                document.body.classList.remove('editor-mobile-left-open', 'editor-mobile-right-open');
                return;
            }
            if (open) {
                if (isLeft) {
                    document.body.classList.add('editor-mobile-left-open');
                    document.body.classList.remove('editor-mobile-right-open');
                } else {
                    document.body.classList.add('editor-mobile-right-open');
                    document.body.classList.remove('editor-mobile-left-open');
                }
                return;
            }
            if (isLeft) {
                document.body.classList.remove('editor-mobile-left-open');
            } else {
                document.body.classList.remove('editor-mobile-right-open');
            }
        };

        const setLeftSidebarCollapsed = (collapsed) => {
            document.body.classList.toggle('left-collapsed', collapsed);
            localStorage.setItem('bugence-left-collapsed', collapsed ? '1' : '0');
            const icon = controlRefs.leftPanelToggle?.querySelector('i');
            if (icon) {
                icon.className = collapsed ? 'fa-solid fa-chevron-right' : 'fa-solid fa-chevron-left';
            }
            queueEditorPrefsSave();
        };

        const setRightSidebarCollapsed = (collapsed) => {
            document.body.classList.toggle('right-collapsed', collapsed);
            localStorage.setItem('bugence-right-collapsed', collapsed ? '1' : '0');
            const icon = controlRefs.rightPanelToggle?.querySelector('i');
            if (icon) {
                icon.className = collapsed ? 'fa-solid fa-chevron-left' : 'fa-solid fa-chevron-right';
            }
            queueEditorPrefsSave();
        };

        const syncSidebarCollapseState = () => {
            const leftExplicit = localStorage.getItem('bugence-left-collapsed-set') === '1';
            const rightExplicit = localStorage.getItem('bugence-right-collapsed-set') === '1';
            const leftStored = localStorage.getItem('bugence-left-collapsed') === '1';
            const rightStored = localStorage.getItem('bugence-right-collapsed') === '1';
            setLeftSidebarCollapsed(leftExplicit && leftStored);
            setRightSidebarCollapsed(rightExplicit && rightStored);
        };

        const applyCanvasZoom = (value) => {
            const next = Math.min(2, Math.max(0.5, value));
            canvasZoom = next;
            if (editorIframe) {
                editorIframe.style.transformOrigin = 'top left';
                editorIframe.style.transform = `scale(${canvasZoom})`;
                editorIframe.style.width = `${100 / canvasZoom}%`;
                editorIframe.style.height = `${100 / canvasZoom}%`;
            }
            if (controlRefs.canvasZoomLabel) {
                controlRefs.canvasZoomLabel.textContent = `${Math.round(canvasZoom * 100)}%`;
            }
        };

        const fitCanvasToView = () => {
            const wrap = document.querySelector('.canvas-wrap');
            if (!wrap) {
                applyCanvasZoom(1);
                return;
            }
            const width = wrap.clientWidth;
            const height = wrap.clientHeight;
            if (!width || !height) {
                applyCanvasZoom(1);
                return;
            }
            const scale = Math.min(1, Math.max(0.5, width / 1200));
            applyCanvasZoom(scale);
        };

        const syncUtilitySettingsState = () => {
            document.querySelectorAll('[data-setting="grid"]').forEach(btn => {
                btn.classList.toggle('is-active', localStorage.getItem('bugence-canvas-grid') === '1');
            });
            document.querySelectorAll('[data-setting="focus"]').forEach(btn => {
                btn.classList.toggle('is-active', document.body.classList.contains('focus-mode'));
            });
            document.querySelectorAll('[data-setting="inline-add"]').forEach(btn => {
                btn.classList.toggle('is-active', inlineAddEnabled);
            });
        };

        const fetchProjectAssets = async () => {
            if (!projectId) return [];
            const now = Date.now();
            if (assetCache && now - assetCacheTime < 20000) return assetCache;
            try {
                const response = await fetch(`/Editor?handler=Assets&projectId=${projectId}`);
                if (!response.ok) return [];
                const contentType = response.headers.get('content-type') || '';
                if (!contentType.includes('application/json')) return [];
                const data = await response.json();
                assetCache = Array.isArray(data.items) ? data.items : [];
                assetCacheTime = now;
                return assetCache;
            } catch {
                return [];
            }
        };

        const renderAssetGrid = (items) => {
            if (!controlRefs.assetGrid) return;
            controlRefs.assetGrid.innerHTML = '';
            if (!items.length) {
                controlRefs.assetGrid.innerHTML = '<div class="hint-text">No assets found for this project.</div>';
                return;
            }
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'asset-item';
                const assetUrl = safeUrlValue(item.url || '');
                const assetPath = item.path || '';
                card.setAttribute('data-asset-url', assetUrl);
                card.setAttribute('data-asset-type', item.type || 'other');
                card.setAttribute('data-asset-path', assetPath);
                const thumb = document.createElement('img');
                thumb.className = 'asset-thumb';
                thumb.alt = item.name || '';
                if (item.type !== 'video' && assetUrl) {
                    thumb.src = assetUrl;
                }
                const name = document.createElement('div');
                name.className = 'asset-name';
                name.textContent = item.name || '';
                card.appendChild(thumb);
                card.appendChild(name);
                if (assetPath) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'asset-delete';
                    deleteBtn.type = 'button';
                    deleteBtn.setAttribute('data-asset-delete', 'true');
                    deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                    card.appendChild(deleteBtn);
                }
                if (item.type === 'video') {
                    thumb.removeAttribute('src');
                    thumb.style.background = 'linear-gradient(135deg, rgba(6,182,212,0.2), rgba(59,130,246,0.1))';
                    thumb.style.display = 'flex';
                }
                if (item.type === 'lottie') {
                    thumb.removeAttribute('src');
                    thumb.style.background = 'linear-gradient(135deg, rgba(99,102,241,0.2), rgba(59,130,246,0.1))';
                    thumb.style.display = 'flex';
                }
                controlRefs.assetGrid.appendChild(card);
            });
        };

        const setAssetStatus = (message) => {
            if (controlRefs.assetUploadStatus) {
                controlRefs.assetUploadStatus.textContent = message || '';
            }
        };

        const resetAssetCache = () => {
            assetCache = null;
            assetCacheTime = 0;
        };

        const uploadAssets = async (files) => {
            if (!projectId || !files?.length) return;
            setAssetStatus('Uploading...');
            try {
                const form = new FormData();
                Array.from(files).forEach(file => form.append('files', file));
                form.append('__RequestVerificationToken', csrfToken);
                const response = await fetch(`/Editor?handler=UploadAsset&projectId=${projectId}`, {
                    method: 'POST',
                    body: form
                });
                if (!response.ok) throw new Error('Upload failed');
                const payload = await response.json();
                const count = Number(payload.saved || 0);
                setAssetStatus(count ? `Uploaded ${count} file${count === 1 ? '' : 's'}.` : 'Upload complete.');
                resetAssetCache();
                openAssetModal(assetFilter);
            } catch {
                setAssetStatus('Upload failed.');
            }
            setTimeout(() => setAssetStatus(''), 2000);
        };

        const deleteAsset = async (path) => {
            if (!projectId || !path) return;
            const confirmDelete = window.confirm(`Delete asset ${path}?`);
            if (!confirmDelete) return;
            setAssetStatus('Deleting...');
            try {
                const response = await fetch(`/Editor?handler=DeleteAsset&projectId=${projectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({ path })
                });
                if (!response.ok) throw new Error('Delete failed');
                setAssetStatus('Asset deleted.');
                resetAssetCache();
                openAssetModal(assetFilter);
            } catch {
                setAssetStatus('Delete failed.');
            }
            setTimeout(() => setAssetStatus(''), 2000);
        };

        const openAssetModal = async (typeFilter = 'all') => {
            if (!controlRefs.assetModal) return;
            assetFilter = typeFilter;
            controlRefs.assetModal.classList.add('active');
            document.querySelectorAll('.asset-tab').forEach(tab => {
                tab.classList.toggle('active', tab.getAttribute('data-asset-tab') === assetFilter);
            });
            const assets = await fetchProjectAssets();
            const search = controlRefs.assetSearch?.value?.trim().toLowerCase() || '';
            const filtered = assets.filter(asset => {
                if (assetFilter !== 'all' && asset.type !== assetFilter) return false;
                if (!search) return true;
                return asset.name.toLowerCase().includes(search) || asset.path.toLowerCase().includes(search);
            });
            renderAssetGrid(filtered);
        };

        const closeAssetModal = () => {
            controlRefs.assetModal?.classList.remove('active');
        };

        const setMissingAssetsFixEnabled = (enabled) => {
            if (!controlRefs.missingAssetsFixBtn) return;
            controlRefs.missingAssetsFixBtn.disabled = !enabled;
        };

        const setMissingAssetsStatus = (message) => {
            if (controlRefs.missingAssetsStatus) {
                controlRefs.missingAssetsStatus.textContent = message || '';
            }
        };

        const refreshMissingAssets = async () => {
            if (controlRefs.missingAssetsSummary) {
                controlRefs.missingAssetsSummary.textContent = 'Scanning...';
            }
            if (controlRefs.missingAssetsList) {
                controlRefs.missingAssetsList.innerHTML = '';
            }
            setMissingAssetsFixEnabled(false);
            try {
                const response = await fetch(`/Editor?handler=MissingAssets&projectId=${projectId}`);
                if (!response.ok) throw new Error('Missing assets scan failed.');
                const payload = await response.json();
                const items = Array.isArray(payload.items) ? payload.items : [];
                const total = Number(payload.count || items.length);
                const files = Number(payload.files || 0);
                if (controlRefs.missingAssetsSummary) {
                    if (!items.length) {
                        controlRefs.missingAssetsSummary.textContent = 'No missing assets found.';
                    } else if (total > items.length) {
                        controlRefs.missingAssetsSummary.textContent = `Found ${total} missing assets across ${files} files. Showing ${items.length}.`;
                    } else {
                        controlRefs.missingAssetsSummary.textContent = `Found ${total} missing assets across ${files} files.`;
                    }
                }
                if (controlRefs.missingAssetsList) {
                    controlRefs.missingAssetsList.innerHTML = '';
                    items.forEach(item => {
                        const row = document.createElement('div');
                        row.className = 'missing-item';
                        const file = document.createElement('div');
                        file.className = 'missing-file';
                        file.textContent = item.file || 'Unknown file';
                        const ref = document.createElement('div');
                        ref.className = 'missing-path';
                        ref.textContent = item.reference || item.resolvedPath || 'Unknown reference';
                        const resolved = document.createElement('div');
                        resolved.className = 'missing-path';
                        resolved.textContent = item.resolvedPath ? `Resolved: ${item.resolvedPath}` : '';
                        row.appendChild(file);
                        row.appendChild(ref);
                        if (resolved.textContent) row.appendChild(resolved);
                        controlRefs.missingAssetsList.appendChild(row);
                    });
                }
                setMissingAssetsFixEnabled(items.length > 0);
            } catch {
                if (controlRefs.missingAssetsSummary) {
                    controlRefs.missingAssetsSummary.textContent = 'Failed to scan missing assets.';
                }
            }
        };

        const openMissingAssetsModal = async () => {
            if (!controlRefs.missingAssetsModal) return;
            controlRefs.missingAssetsModal.classList.add('active');
            setMissingAssetsStatus('');
            await refreshMissingAssets();
        };

        const fixMissingAssets = async () => {
            if (!projectId) return;
            setMissingAssetsFixEnabled(false);
            setMissingAssetsStatus('Fixing missing assets...');
            try {
                const response = await fetch(`/Editor?handler=FixMissingAssets&projectId=${projectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({})
                });
                if (!response.ok) throw new Error('Fix missing assets failed.');
                const payload = await response.json();
                const fixed = Number(payload.fixed || 0);
                const remaining = Number(payload.remaining || 0);
                const total = Number(payload.total || 0);
                if (!total) {
                    setMissingAssetsStatus('No missing assets found.');
                } else if (fixed > 0) {
                    setMissingAssetsStatus(`Auto-fix copied ${fixed} assets. ${remaining} still missing.`);
                } else {
                    setMissingAssetsStatus(`No matches found. ${remaining} still missing.`);
                }
            } catch {
                setMissingAssetsStatus('Auto-fix failed.');
            }
            await refreshMissingAssets();
        };

        const closeMissingAssetsModal = () => {
            controlRefs.missingAssetsModal?.classList.remove('active');
        };

        let structureTimer;
        const structureExpanded = new Set(JSON.parse(localStorage.getItem('bugence-structure-expanded') || '[]'));
        const persistStructureExpanded = () => {
            localStorage.setItem('bugence-structure-expanded', JSON.stringify(Array.from(structureExpanded)));
        };
        const buildStructureTree = () => {
            const list = structureContent.querySelector('#structureList');
            const doc = getCanvasDocument();
            if (!list || !doc?.body) return;
            list.innerHTML = '';
            const isEditorNode = (el) => !!(el && el.closest && el.closest('[data-bugence-editor="true"]'));
            const isInlineAdd = (el) => el?.hasAttribute?.('data-bugence-inline-add') || el?.hasAttribute?.('data-bugence-inline-menu');
            const isDropzone = (el) => el?.hasAttribute?.('data-bugence-dropzone');
            const isMajorRoot = (el) => {
                if (!el || el.nodeType !== 1) return false;
                const tag = el.tagName.toLowerCase();
                if (['nav', 'footer'].includes(tag)) return true;
                if (tag === 'section' || tag === 'header') return true;
                return el.getAttribute('data-bugence-type') === 'section';
            };
            const collectChildren = (el) => {
                const children = Array.from(el.children).filter(child =>
                    child.nodeType === 1 && !isEditorNode(child) && !isInlineAdd(child) && child.id !== 'bugence-editor-bridge'
                );
                const flattened = [];
                children.forEach(child => {
                    if (isDropzone(child)) {
                        flattened.push(...collectChildren(child));
                    } else {
                        flattened.push(child);
                    }
                });
                return flattened;
            };
            let heroAssigned = false;
            let sectionCount = 0;
            const resolveRootLabel = (el) => {
                const tag = el.tagName.toLowerCase();
                if (tag === 'nav') return 'NavBar';
                if (tag === 'footer') return 'Footer';
                if (tag === 'section' || tag === 'header' || el.getAttribute('data-bugence-type') === 'section') {
                    if (!heroAssigned) {
                        heroAssigned = true;
                        return 'Hero Section';
                    }
                    sectionCount += 1;
                    return `Section ${sectionCount}`;
                }
                return el.getAttribute('data-bugence-type') || tag;
            };
            const resolveTypeLabel = (el) => {
                const tag = el.tagName.toLowerCase();
                if (tag === 'nav') return 'NavBar';
                if (tag === 'footer') return 'Footer';
                return el.getAttribute('data-bugence-type') || tag;
            };
            const buildNode = (el, depth, labelOverride) => {
                if (!el || el.nodeType !== 1) return;
                if (isEditorNode(el) || isInlineAdd(el) || el.id === 'bugence-editor-bridge') return;
                const id = ensureBugenceId(el);
                const type = labelOverride || resolveTypeLabel(el);
                const node = document.createElement('div');
                node.className = 'structure-node';
                const item = document.createElement('div');
                item.className = 'structure-item';
                item.setAttribute('data-struct-id', id);
                item.setAttribute('draggable', 'true');
                item.setAttribute('tabindex', '0');
                const children = collectChildren(el);
                const hasChildren = children.length > 0;
                const expanded = structureExpanded.has(id);
                item.innerHTML = `
                    <button class="structure-toggle ${expanded ? 'is-open' : ''} ${hasChildren ? '' : 'hidden'}" data-struct-toggle="${id}" type="button" aria-label="Toggle children"></button>
                    <span class="tag">&lt;${el.tagName.toLowerCase()}&gt;</span>
                    <span class="name">${type}</span>
                    ${hasChildren ? `<span class="meta">${children.length}</span>` : ''}
                `;
                if (editorBridge.selection?.attributes?.['data-bugence-id'] === id) {
                    item.classList.add('active');
                }
                item.addEventListener('click', () => {
                    sendToIframe('bugence-editor:select', { selector: `[data-bugence-id="${id}"]` });
                });
                item.addEventListener('keydown', (event) => {
                    const items = Array.from(list.querySelectorAll('.structure-item'));
                    const idx = items.indexOf(item);
                    if (event.key === 'ArrowDown' && idx >= 0) {
                        event.preventDefault();
                        items[Math.min(items.length - 1, idx + 1)]?.focus();
                    } else if (event.key === 'ArrowUp' && idx >= 0) {
                        event.preventDefault();
                        items[Math.max(0, idx - 1)]?.focus();
                    } else if (event.key === 'Enter') {
                        event.preventDefault();
                        insertElementFromPalette(lastPaletteType || 'text', doc.querySelector(`[data-bugence-id="${id}"]`), 'after');
                    }
                });
                item.addEventListener('dragstart', (event) => {
                    event.dataTransfer?.setData('text/plain', id);
                    event.dataTransfer?.setData('application/x-bugence-struct', id);
                    event.dataTransfer?.setData('application/x-bugence-node', id);
                    if (event.dataTransfer) event.dataTransfer.effectAllowed = 'move';
                });
                item.addEventListener('dragover', (event) => {
                    event.preventDefault();
                    if (event.dataTransfer) event.dataTransfer.dropEffect = 'move';
                    const rect = item.getBoundingClientRect();
                    const y = event.clientY - rect.top;
                    item.classList.remove('drop-before', 'drop-after', 'drop-inside');
                    if (y < rect.height * 0.25) {
                        item.classList.add('drop-before');
                        item.setAttribute('data-drop-pos', 'before');
                    } else if (y > rect.height * 0.75) {
                        item.classList.add('drop-after');
                        item.setAttribute('data-drop-pos', 'after');
                    } else if (isDropContainer(doc.querySelector(`[data-bugence-id="${id}"]`))) {
                        item.classList.add('drop-inside');
                        item.setAttribute('data-drop-pos', 'inside');
                    } else {
                        item.classList.add('drop-after');
                        item.setAttribute('data-drop-pos', 'after');
                    }
                });
                item.addEventListener('drop', (event) => {
                    event.preventDefault();
                    const dragId = event.dataTransfer?.getData('application/x-bugence-struct')
                        || event.dataTransfer?.getData('text/plain');
                    if (!dragId || dragId === id) return;
                    const dragEl = doc.querySelector(`[data-bugence-id="${dragId}"]`);
                    const targetEl = doc.querySelector(`[data-bugence-id="${id}"]`);
                    if (!dragEl || !targetEl) return;
                    if (dragEl.contains(targetEl)) return;
                    const dropPos = item.getAttribute('data-drop-pos') || 'after';
                    const fromParent = dragEl.parentElement;
                    const fromIndex = fromParent ? Array.from(fromParent.children).indexOf(dragEl) : -1;
                    if (dropPos === 'inside' && canMoveInside(dragEl, targetEl)) {
                        const zone = targetEl.querySelector('[data-bugence-dropzone="true"]') || targetEl;
                        zone.appendChild(dragEl);
                    } else if (dropPos === 'before' && targetEl.parentElement) {
                        targetEl.parentElement.insertBefore(dragEl, targetEl);
                    } else if (targetEl.parentElement) {
                        targetEl.parentElement.insertBefore(dragEl, targetEl.nextSibling);
                    }
                    const toParent = dragEl.parentElement;
                    const toIndex = toParent ? Array.from(toParent.children).indexOf(dragEl) : -1;
                    if (fromParent && toParent && fromIndex !== -1 && toIndex !== -1) {
                        pushHistoryOp({
                            type: 'move',
                            targetId: dragId,
                            fromParentId: ensureBugenceId(fromParent),
                            fromIndex,
                            toParentId: ensureBugenceId(toParent),
                            toIndex
                        });
                    }
                    rebuildInlineAdd();
                    markEdit('structural');
                    scheduleAutoSave();
                    buildStructureTree();
                });
                item.addEventListener('dragleave', () => {
                    item.classList.remove('drop-before', 'drop-after', 'drop-inside');
                });
                node.appendChild(item);
                if (hasChildren) {
                    const childrenWrap = document.createElement('div');
                    childrenWrap.className = `structure-children ${expanded ? 'is-open' : ''}`;
                    children.forEach(child => {
                        const childNode = buildNode(child, depth + 1);
                        if (childNode) childrenWrap.appendChild(childNode);
                    });
                    node.appendChild(childrenWrap);
                }
                item.querySelector('[data-struct-toggle]')?.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (structureExpanded.has(id)) {
                        structureExpanded.delete(id);
                    } else {
                        structureExpanded.add(id);
                    }
                    persistStructureExpanded();
                    buildStructureTree();
                });
                return node;
            };
            const tree = document.createElement('div');
            tree.className = 'structure-tree';
            const majorRoots = Array.from(doc.body.children).filter(child =>
                child.nodeType === 1 &&
                !isEditorNode(child) &&
                !isInlineAdd(child) &&
                child.id !== 'bugence-editor-bridge' &&
                isMajorRoot(child)
            );
            majorRoots.forEach((child) => {
                const label = resolveRootLabel(child);
                const node = buildNode(child, 0, label);
                if (node) tree.appendChild(node);
            });
            list.appendChild(tree);
        };

        const scheduleStructureUpdate = () => {
            clearTimeout(structureTimer);
            structureTimer = setTimeout(buildStructureTree, 120);
        };

        let inlineAddClickBound = false;
        const parseRgba = (value) => {
            if (!value) return null;
            if (value === 'transparent') return null;
            const match = value.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([0-9.]+))?\)/i);
            if (!match) return null;
            return {
                r: Number(match[1]),
                g: Number(match[2]),
                b: Number(match[3]),
                a: match[4] !== undefined ? Number(match[4]) : 1
            };
        };
        const getEffectiveBackground = (el, doc) => {
            let node = el;
            while (node && node !== doc.body) {
                const color = doc.defaultView?.getComputedStyle(node).backgroundColor || '';
                const parsed = parseRgba(color);
                if (parsed && parsed.a > 0.02) return parsed;
                node = node.parentElement;
            }
            const bodyColor = doc.defaultView?.getComputedStyle(doc.body).backgroundColor || '';
            return parseRgba(bodyColor) || { r: 5, g: 5, b: 5, a: 1 };
        };
        const getReadableTextColor = (el, doc) => {
            if (!el || !doc) return '#f8fafc';
            const bg = getEffectiveBackground(el, doc);
            const luminance = (0.299 * bg.r + 0.587 * bg.g + 0.114 * bg.b) / 255;
            return luminance > 0.65 ? '#0b0b0b' : '#f8fafc';
        };
        const getReadableTextColorAtPoint = (doc, x, y) => {
            if (!doc || !doc.elementsFromPoint) return getReadableTextColor(doc?.body, doc);
            const stack = doc.elementsFromPoint(x, y) || [];
            for (const el of stack) {
                if (!el || el.closest?.('[data-bugence-editor="true"]')) continue;
                return getReadableTextColor(el, doc);
            }
            return getReadableTextColor(doc.body, doc);
        };
        const closeInlineAddMenus = (doc) => {
            if (!doc) return;
            doc.querySelectorAll('[data-bugence-inline-menu="true"]').forEach(el => el.remove());
        };
        const rebuildInlineAdd = () => {
            const doc = getCanvasDocument();
            if (!doc || !doc.body) return;
            doc.querySelectorAll('[data-bugence-inline-add="true"]').forEach(el => el.remove());
            if (!inlineAddEnabled) {
                closeInlineAddMenus(doc);
                return;
            }
            const children = Array.from(doc.body.children).filter(el =>
                el.nodeType === 1 && !el.hasAttribute('data-bugence-editor') && el.id !== 'bugence-editor-bridge'
            );
            children.forEach((el, index) => {
                if (index === children.length - 1) return;
                const handle = doc.createElement('div');
                handle.setAttribute('data-bugence-inline-add', 'true');
                handle.setAttribute('data-bugence-editor', 'true');
                handle.style.position = 'relative';
                handle.style.height = '20px';
                handle.style.margin = '10px 0';
                handle.style.pointerEvents = 'auto';
                handle.style.display = 'flex';
                handle.style.alignItems = 'center';
                handle.style.justifyContent = 'center';
                const line = doc.createElement('div');
                line.style.position = 'absolute';
                line.style.left = '0';
                line.style.right = '0';
                line.style.top = '50%';
                line.style.height = '2px';
                line.style.background = 'linear-gradient(90deg, rgba(6,182,212,0.05), rgba(6,182,212,0.45), rgba(6,182,212,0.05))';
                line.style.transform = 'translateY(-50%)';
                line.style.opacity = '0';
                line.style.transition = 'opacity 0.15s ease';
                handle.appendChild(line);
                const button = doc.createElement('button');
                button.type = 'button';
                button.textContent = '+';
                button.style.position = 'absolute';
                button.style.left = '50%';
                button.style.top = '50%';
                button.style.transform = 'translate(-50%, -50%)';
                button.style.width = '28px';
                button.style.height = '28px';
                button.style.borderRadius = '999px';
                button.style.border = '1px solid rgba(6,182,212,0.75)';
                button.style.background = 'rgba(6,182,212,0.28)';
                button.style.color = getReadableTextColor(el, doc);
                button.style.fontSize = '16px';
                button.style.fontWeight = '700';
                button.style.lineHeight = '1';
                button.style.cursor = 'pointer';
                button.style.opacity = '0';
                button.style.transition = 'opacity 0.15s ease, transform 0.15s ease, box-shadow 0.15s ease';
                button.style.pointerEvents = 'auto';
                button.style.textShadow = '0 1px 2px rgba(0,0,0,0.35)';
                button.setAttribute('data-inline-add', 'true');
                const targetId = ensureBugenceId(el);
                button.setAttribute('data-target-id', targetId);
                button.setAttribute('data-position', 'after');
                handle.appendChild(button);
                el.insertAdjacentElement('afterend', handle);

                const updateButtonColor = () => {
                    const rect = handle.getBoundingClientRect();
                    button.style.color = getReadableTextColorAtPoint(doc, rect.left + rect.width / 2, rect.top + rect.height / 2);
                };
                updateButtonColor();
                const reveal = () => {
                    updateButtonColor();
                    line.style.opacity = '1';
                    button.style.opacity = '1';
                    button.style.transform = 'translate(-50%, -50%) scale(1.05)';
                    button.style.boxShadow = '0 8px 20px rgba(6,182,212,0.3)';
                };
                const hide = () => {
                    line.style.opacity = '0';
                    button.style.opacity = '0';
                    button.style.transform = 'translate(-50%, -50%)';
                    button.style.boxShadow = 'none';
                };
                handle.addEventListener('mouseenter', reveal);
                handle.addEventListener('mouseleave', hide);
            });

            doc.querySelectorAll('[data-bugence-dropzone="true"]').forEach((zone) => {
                if (zone.querySelector('[data-bugence-inline-add="true"]')) return;
                const hasContent = Array.from(zone.children).some(child =>
                    child.nodeType === 1 &&
                    !child.hasAttribute('data-bugence-editor') &&
                    !child.hasAttribute('data-bugence-inline-add') &&
                    child.id !== 'bugence-editor-bridge'
                );
                if (hasContent) return;
                const handle = doc.createElement('div');
                handle.setAttribute('data-bugence-inline-add', 'true');
                handle.setAttribute('data-bugence-editor', 'true');
                handle.style.position = 'relative';
                handle.style.height = '22px';
                handle.style.margin = '8px 0';
                handle.style.pointerEvents = 'auto';
                handle.style.display = 'flex';
                handle.style.alignItems = 'center';
                handle.style.justifyContent = 'center';
                handle.style.width = '100%';
                const line = doc.createElement('div');
                line.style.position = 'absolute';
                line.style.left = '0';
                line.style.right = '0';
                line.style.top = '50%';
                line.style.height = '2px';
                line.style.background = 'linear-gradient(90deg, rgba(6,182,212,0.05), rgba(6,182,212,0.45), rgba(6,182,212,0.05))';
                line.style.transform = 'translateY(-50%)';
                line.style.opacity = '0.6';
                handle.appendChild(line);
                const button = doc.createElement('button');
                button.type = 'button';
                button.textContent = '+';
                button.style.position = 'absolute';
                button.style.left = '50%';
                button.style.top = '50%';
                button.style.transform = 'translate(-50%, -50%)';
                button.style.width = '26px';
                button.style.height = '26px';
                button.style.borderRadius = '999px';
                button.style.border = '1px solid rgba(6,182,212,0.8)';
                button.style.background = 'rgba(6,182,212,0.32)';
                button.style.color = getReadableTextColor(zone, doc);
                button.style.fontSize = '15px';
                button.style.fontWeight = '700';
                button.style.lineHeight = '1';
                button.style.cursor = 'pointer';
                button.style.opacity = '1';
                button.style.transition = 'transform 0.15s ease, box-shadow 0.15s ease';
                button.style.pointerEvents = 'auto';
                button.style.textShadow = '0 1px 2px rgba(0,0,0,0.35)';
                button.setAttribute('data-inline-add', 'true');
                const targetId = ensureBugenceId(zone);
                button.setAttribute('data-target-id', targetId);
                button.setAttribute('data-position', 'after');
                handle.appendChild(button);
                zone.appendChild(handle);

                const updateButtonColor = () => {
                    const rect = handle.getBoundingClientRect();
                    button.style.color = getReadableTextColorAtPoint(doc, rect.left + rect.width / 2, rect.top + rect.height / 2);
                };
                updateButtonColor();
                const reveal = () => {
                    updateButtonColor();
                    button.style.transform = 'translate(-50%, -50%) scale(1.08)';
                    button.style.boxShadow = '0 10px 20px rgba(6,182,212,0.35)';
                };
                const hide = () => {
                    button.style.transform = 'translate(-50%, -50%)';
                    button.style.boxShadow = '0 8px 16px rgba(6,182,212,0.22)';
                };
                handle.addEventListener('mouseenter', reveal);
                handle.addEventListener('mouseleave', hide);
            });

            if (!inlineAddClickBound) {
                inlineAddClickBound = true;
                doc.addEventListener('click', (event) => {
                    const btn = event.target?.closest?.('[data-inline-add="true"]');
                    if (!btn) {
                        closeInlineAddMenus(doc);
                        return;
                    }
                    event.preventDefault();
                    event.stopPropagation();
                    const targetId = btn.getAttribute('data-target-id');
                    const target = doc.querySelector(`[data-bugence-id="${targetId}"]`);
                    if (!target) return;
                    const position = btn.getAttribute('data-position') || 'after';
                    openInlineAddMenu(doc, btn.parentElement || btn, target, position);
                });
            }
        };

        const openInlineAddMenu = (doc, anchor, target, position = 'after') => {
            if (!doc || !anchor || !target) return;
            closeInlineAddMenus(doc);
            const menu = doc.createElement('div');
            menu.setAttribute('data-bugence-inline-menu', 'true');
            menu.style.position = 'absolute';
            menu.style.top = '32px';
            menu.style.left = '50%';
            menu.style.transform = 'translateX(-50%)';
            menu.style.display = 'flex';
            menu.style.gap = '8px';
            menu.style.background = 'rgba(10,10,10,0.9)';
            menu.style.border = '1px solid rgba(255,255,255,0.12)';
            menu.style.borderRadius = '10px';
            menu.style.padding = '6px';
            menu.style.zIndex = '2147483646';
            menu.style.pointerEvents = 'auto';
            menu.innerHTML = `
                <button data-inline-type="container" style="all:unset;cursor:pointer;padding:6px 12px;border-radius:8px;color:#e5e7eb;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);">Container</button>
                <div style="width:1px;background:rgba(255,255,255,0.12);margin:0 2px;"></div>
                <button data-inline-type="grid" data-inline-cols="2" title="2 columns" style="all:unset;cursor:pointer;padding:6px 10px;border-radius:8px;color:#e5e7eb;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);">Grid 2</button>
                <button data-inline-type="grid" data-inline-cols="3" title="3 columns" style="all:unset;cursor:pointer;padding:6px 10px;border-radius:8px;color:#e5e7eb;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);">Grid 3</button>
                <button data-inline-type="grid" data-inline-cols="4" title="4 columns" style="all:unset;cursor:pointer;padding:6px 10px;border-radius:8px;color:#e5e7eb;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);">Grid 4</button>
                <button data-inline-type="grid" data-inline-cols="6" title="6 columns" style="all:unset;cursor:pointer;padding:6px 10px;border-radius:8px;color:#e5e7eb;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);">Grid 6</button>
            `;
            anchor.querySelectorAll('[data-bugence-inline-menu]').forEach(el => el.remove());
            anchor.appendChild(menu);
            const closeOnOutside = (event) => {
                if (menu.contains(event.target)) return;
                if (event.target?.closest?.('[data-inline-add="true"]')) return;
                closeInlineAddMenus(doc);
                doc.defaultView?.removeEventListener('click', closeOnOutside, true);
                doc.defaultView?.removeEventListener('keydown', closeOnEscape, true);
            };
            const closeOnEscape = (event) => {
                if (event.key !== 'Escape') return;
                closeInlineAddMenus(doc);
                doc.defaultView?.removeEventListener('click', closeOnOutside, true);
                doc.defaultView?.removeEventListener('keydown', closeOnEscape, true);
            };
            setTimeout(() => {
                doc.defaultView?.addEventListener('click', closeOnOutside, true);
                doc.defaultView?.addEventListener('keydown', closeOnEscape, true);
            }, 0);
            menu.addEventListener('click', (ev) => {
                const type = ev.target?.getAttribute?.('data-inline-type');
                if (!type) return;
                menu.remove();
                const cols = Number(ev.target?.getAttribute?.('data-inline-cols'));
                const options = cols ? { cols } : {};
                insertElementFromPalette(type, target, position, options);
                rebuildInlineAdd();
            });
        };

        const initSectionAddOverlay = () => {
            const doc = getCanvasDocument();
            if (!doc || !doc.body) return;
            let overlay = doc.getElementById('bugence-section-add');
            let style = doc.getElementById('bugence-section-add-style');
            if (!style) {
                style = doc.createElement('style');
                style.id = 'bugence-section-add-style';
                style.textContent = `
                    #bugence-section-add {
                        position: fixed;
                        left: 0;
                        top: 0;
                        height: 0;
                        pointer-events: none;
                        z-index: 2147483646;
                        display: none;
                    }
                    #bugence-section-add .line {
                        position: absolute;
                        left: 0;
                        top: 0;
                        height: 2px;
                        background: rgba(6,182,212,0.7);
                        box-shadow: 0 8px 18px rgba(6,182,212,0.2);
                        border-radius: 999px;
                    }
                    #bugence-section-add button {
                        position: absolute;
                        top: -14px;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 38px;
                        height: 38px;
                        border-radius: 999px;
                        border: 1px solid rgba(6,182,212,0.85);
                        background: linear-gradient(135deg, rgba(6,182,212,0.45), rgba(59,130,246,0.35));
                        color: #f8fbff;
                        font-weight: 800;
                        font-size: 20px;
                        line-height: 1;
                        cursor: pointer;
                        pointer-events: auto;
                        box-shadow: 0 12px 26px rgba(6,182,212,0.35);
                    }
                `;
                doc.head?.appendChild(style);
            }
            if (!overlay) {
                overlay = doc.createElement('div');
                overlay.id = 'bugence-section-add';
                overlay.setAttribute('data-bugence-editor', 'true');
                overlay.innerHTML = `<div class="line"></div><button type="button" data-section-add="true">+</button>`;
                doc.body.appendChild(overlay);
            }

            const button = overlay.querySelector('button');
            button?.addEventListener('click', (event) => {
                event.stopPropagation();
                event.preventDefault();
                const targetId = overlay.dataset.targetId;
                if (!targetId) return;
                const position = overlay.dataset.position || 'after';
                const target = doc.querySelector(`[data-bugence-id="${targetId}"]`);
                if (!target) return;
                openInlineAddMenu(doc, overlay, target, position);
            });

            let raf = false;
            const updateOverlay = (event) => {
                if (!inlineAddEnabled) {
                    overlay.style.display = 'none';
                    return;
                }
                const blocks = Array.from(doc.body.children).filter(el =>
                    el.nodeType === 1 && !el.hasAttribute('data-bugence-editor') && el.id !== 'bugence-editor-bridge'
                );
                if (!blocks.length) {
                    overlay.style.display = 'none';
                    return;
                }
                const mouseY = event.clientY;
                let target = null;
                let position = 'after';
                let lineTop = 0;
                let lineLeft = 0;
                let lineWidth = 0;

                const firstRect = blocks[0].getBoundingClientRect();
                if (mouseY < firstRect.top && firstRect.top - mouseY < 80) {
                    target = blocks[0];
                    position = 'before';
                    lineTop = Math.max(10, firstRect.top - 18);
                    lineLeft = firstRect.left;
                    lineWidth = firstRect.width;
                } else {
                    for (let i = 0; i < blocks.length - 1; i += 1) {
                        const rect = blocks[i].getBoundingClientRect();
                        const nextRect = blocks[i + 1].getBoundingClientRect();
                        if (mouseY > rect.bottom && mouseY < nextRect.top) {
                            const gap = nextRect.top - rect.bottom;
                            if (gap < 12) break;
                            target = blocks[i];
                            position = 'after';
                            lineTop = rect.bottom + gap / 2;
                            lineLeft = rect.left;
                            lineWidth = rect.width;
                            break;
                        }
                    }
                }
                const lastRect = blocks[blocks.length - 1].getBoundingClientRect();
                if (!target && mouseY > lastRect.bottom && mouseY - lastRect.bottom < 80) {
                    target = blocks[blocks.length - 1];
                    position = 'after';
                    lineTop = lastRect.bottom + 18;
                    lineLeft = lastRect.left;
                    lineWidth = lastRect.width;
                }
                if (!target) {
                    overlay.style.display = 'none';
                    return;
                }
                overlay.dataset.targetId = ensureBugenceId(target);
                overlay.dataset.position = position;
                overlay.style.display = 'block';
                overlay.style.left = `${lineLeft}px`;
                overlay.style.top = `${lineTop}px`;
                overlay.style.width = `${Math.max(120, lineWidth)}px`;
                const line = overlay.querySelector('.line');
                if (line) {
                    line.style.width = '100%';
                }
                const actionButton = overlay.querySelector('button');
                if (actionButton) {
                    actionButton.style.color = getReadableTextColorAtPoint(doc, lineLeft + lineWidth / 2, lineTop);
                    actionButton.style.textShadow = '0 1px 2px rgba(0,0,0,0.35)';
                }
            };

            doc.addEventListener('mousemove', (event) => {
                if (raf) return;
                raf = true;
                requestAnimationFrame(() => {
                    raf = false;
                    updateOverlay(event);
                });
            });
            doc.addEventListener('mouseleave', () => {
                overlay.style.display = 'none';
            });
        };

        let selectionOverlayBound = false;
        let selectionOverlayPinned = false;
        let selectionOverlayPinnedPos = null;
        let selectionOverlayDismissedId = null;
        let selectionOverlayLastId = null;
        let directMoveBound = false;
        let freeDragBound = false;
        let freeDragState = null;
        let moveDragState = null;
        let moveMarker = null;
        let snapLineX = null;
        let snapLineY = null;
        const ensureSelectionOverlay = (doc) => {
            let style = doc.getElementById('bugence-selection-overlay-style');
            if (!style) {
                style = doc.createElement('style');
                style.id = 'bugence-selection-overlay-style';
                style.textContent = `
                    #bugence-selection-overlay {
                        position: fixed;
                        display: none;
                        align-items: center;
                        gap: 8px;
                        padding: 10px 12px 9px;
                        border-radius: 14px;
                        border: 1px solid rgba(255,255,255,0.16);
                        background: rgba(10,12,16,0.92);
                        color: #f8fafc;
                        font-size: 12px;
                        z-index: 2147483647;
                        pointer-events: auto;
                        box-shadow: 0 10px 24px rgba(0,0,0,0.35);
                        user-select: none;
                    }
                    #bugence-selection-overlay.is-dragging {
                        cursor: grabbing;
                    }
                    #bugence-selection-overlay .sel-handle {
                        display: grid;
                        grid-template-columns: repeat(2, 4px);
                        grid-auto-rows: 4px;
                        gap: 4px;
                        padding: 2px;
                        cursor: grab;
                        opacity: 0.8;
                    }
                    #bugence-selection-overlay .sel-handle span {
                        width: 4px;
                        height: 4px;
                        border-radius: 999px;
                        background: rgba(255,255,255,0.55);
                    }
                    #bugence-selection-overlay .label {
                        font-weight: 600;
                        color: #c7f9ff;
                    }
                    #bugence-selection-overlay .sel-actions {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    }
                    #bugence-selection-overlay .sel-btn {
                        all: unset;
                        cursor: pointer;
                        padding: 5px 7px;
                        border-radius: 8px;
                        border: 1px solid rgba(255,255,255,0.12);
                        background: rgba(255,255,255,0.06);
                        color: #f8fafc;
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        gap: 4px;
                        min-width: 24px;
                    }
                    #bugence-selection-overlay .sel-btn:hover {
                        background: rgba(6,182,212,0.18);
                        border-color: rgba(6,182,212,0.5);
                    }
                    #bugence-selection-overlay .sel-btn svg {
                        width: 12px;
                        height: 12px;
                        stroke: currentColor;
                        fill: none;
                        stroke-width: 2;
                    }
                    #bugence-selection-overlay .sel-close {
                        position: absolute;
                        top: -10px;
                        right: -10px;
                        width: 22px;
                        height: 22px;
                        border-radius: 999px;
                        border: 1px solid rgba(255,255,255,0.3);
                        background: rgba(15,23,42,0.95);
                        color: #f8fafc;
                        display: grid;
                        place-items: center;
                        cursor: pointer;
                        box-shadow: 0 8px 16px rgba(0,0,0,0.35);
                    }
                    #bugence-selection-overlay .sel-close:hover {
                        background: rgba(244,63,94,0.2);
                        border-color: rgba(244,63,94,0.6);
                    }
                    #bugence-selection-overlay .sel-close svg {
                        width: 11px;
                        height: 11px;
                        stroke: currentColor;
                        fill: none;
                        stroke-width: 2;
                    }
                `;
                doc.head?.appendChild(style);
            }
            let overlay = doc.getElementById('bugence-selection-overlay');
            if (!overlay) {
                overlay = doc.createElement('div');
                overlay.id = 'bugence-selection-overlay';
                overlay.setAttribute('data-bugence-editor', 'true');
                overlay.innerHTML = `
                    <button class="sel-close" type="button" data-selection-action="close" title="Hide toolbar">
                        <svg viewBox="0 0 24 24"><path d="M6 6l12 12"/><path d="M18 6l-12 12"/></svg>
                    </button>
                    <div class="sel-handle" data-selection-drag title="Drag toolbar">
                        <span></span><span></span>
                        <span></span><span></span>
                        <span></span><span></span>
                    </div>
                    <span class="label" data-selection-label>Element</span>
                    <div class="sel-actions">
                        <button class="sel-btn" type="button" data-selection-action="move" title="Move">
                            <svg viewBox="0 0 24 24"><path d="M12 2v20M2 12h20"/><path d="M6 6l6-4 6 4M6 18l6 4 6-4"/></svg>
                        </button>
                        <button class="sel-btn" type="button" data-selection-action="align-left" title="Align left">
                            <svg viewBox="0 0 24 24"><line x1="5" y1="6" x2="19" y2="6"/><line x1="5" y1="12" x2="14" y2="12"/><line x1="5" y1="18" x2="17" y2="18"/></svg>
                        </button>
                        <button class="sel-btn" type="button" data-selection-action="align-center" title="Align center">
                            <svg viewBox="0 0 24 24"><line x1="4" y1="6" x2="20" y2="6"/><line x1="7" y1="12" x2="17" y2="12"/><line x1="6" y1="18" x2="18" y2="18"/></svg>
                        </button>
                        <button class="sel-btn" type="button" data-selection-action="align-right" title="Align right">
                            <svg viewBox="0 0 24 24"><line x1="5" y1="6" x2="19" y2="6"/><line x1="10" y1="12" x2="19" y2="12"/><line x1="7" y1="18" x2="19" y2="18"/></svg>
                        </button>
                        <button class="sel-btn" type="button" data-selection-action="settings" title="Settings">
                            <svg viewBox="0 0 24 24"><line x1="4" y1="6" x2="20" y2="6"/><circle cx="9" cy="6" r="2"/><line x1="4" y1="12" x2="20" y2="12"/><circle cx="15" cy="12" r="2"/><line x1="4" y1="18" x2="20" y2="18"/><circle cx="11" cy="18" r="2"/></svg>
                        </button>
                        <button class="sel-btn" type="button" data-selection-action="duplicate" title="Duplicate">
                            <svg viewBox="0 0 24 24"><rect x="8" y="8" width="10" height="10" rx="2"/><rect x="4" y="4" width="10" height="10" rx="2"/></svg>
                        </button>
                        <button class="sel-btn" type="button" data-selection-action="delete" title="Delete">
                            <svg viewBox="0 0 24 24"><path d="M4 7h16"/><path d="M9 7V5h6v2"/><rect x="6" y="7" width="12" height="12" rx="2"/></svg>
                        </button>
                    </div>
                `;
                doc.body.appendChild(overlay);
                overlay.addEventListener('click', (event) => {
                    const button = event.target?.closest?.('button[data-selection-action]');
                    const action = button?.getAttribute?.('data-selection-action');
                    if (!action) return;
                    event.preventDefault();
                    event.stopPropagation();
                    if (action === 'close') {
                        selectionOverlayPinned = false;
                        selectionOverlayPinnedPos = null;
                        selectionOverlayDismissedId = editorBridge.selection?.attributes?.['data-bugence-id'] || null;
                        overlay.style.display = 'none';
                    } else if (action === 'delete') {
                        deleteSelectedElement();
                    } else if (action === 'duplicate') {
                        duplicateSelectedElement();
                    } else if (action === 'align-left' || action === 'align-center' || action === 'align-right') {
                        const alignValue = action === 'align-left' ? 'left' : action === 'align-center' ? 'center' : 'right';
                        applyAlignmentToSelection(alignValue);
                    } else if (action === 'settings') {
                        document.body.classList.remove('focus-mode');
                        const panel = document.querySelector('.right-panel');
                        panel?.classList.add('pulse');
                        setTimeout(() => panel?.classList.remove('pulse'), 700);
                    }
                });
            }
            return overlay;
        };

        const ensureMoveMarker = (doc) => {
            if (!doc) return null;
            if (moveMarker && moveMarker.ownerDocument === doc) return moveMarker;
            moveMarker = doc.createElement('div');
            moveMarker.id = 'bugence-move-marker';
            moveMarker.setAttribute('data-bugence-editor', 'true');
            moveMarker.style.position = 'fixed';
            moveMarker.style.border = '2px dashed rgba(6,182,212,0.7)';
            moveMarker.style.borderRadius = '10px';
            moveMarker.style.background = 'rgba(6,182,212,0.08)';
            moveMarker.style.pointerEvents = 'none';
            moveMarker.style.zIndex = '2147483646';
            moveMarker.style.display = 'none';
            doc.body.appendChild(moveMarker);
            return moveMarker;
        };

        const ensureSnapGuides = (doc) => {
            if (!doc) return;
            if (!snapLineX) {
                snapLineX = doc.createElement('div');
                snapLineX.setAttribute('data-bugence-editor', 'true');
                snapLineX.style.position = 'fixed';
                snapLineX.style.height = '2px';
                snapLineX.style.background = 'rgba(6,182,212,0.7)';
                snapLineX.style.boxShadow = '0 6px 16px rgba(6,182,212,0.25)';
                snapLineX.style.zIndex = '2147483645';
                snapLineX.style.display = 'none';
                doc.body.appendChild(snapLineX);
            }
            if (!snapLineY) {
                snapLineY = doc.createElement('div');
                snapLineY.setAttribute('data-bugence-editor', 'true');
                snapLineY.style.position = 'fixed';
                snapLineY.style.width = '2px';
                snapLineY.style.background = 'rgba(6,182,212,0.7)';
                snapLineY.style.boxShadow = '0 6px 16px rgba(6,182,212,0.25)';
                snapLineY.style.zIndex = '2147483645';
                snapLineY.style.display = 'none';
                doc.body.appendChild(snapLineY);
            }
        };

        const flashSnapGuides = (rect) => {
            const doc = getCanvasDocument();
            if (!doc || !rect) return;
            ensureSnapGuides(doc);
            if (snapLineY) {
                snapLineY.style.left = `${rect.left}px`;
                snapLineY.style.top = `${rect.top}px`;
                snapLineY.style.height = `${rect.height}px`;
                snapLineY.style.display = 'block';
            }
            if (snapLineX) {
                snapLineX.style.left = `${rect.left}px`;
                snapLineX.style.top = `${rect.top}px`;
                snapLineX.style.width = `${rect.width}px`;
                snapLineX.style.display = 'block';
            }
            setTimeout(() => {
                if (snapLineY) snapLineY.style.display = 'none';
                if (snapLineX) snapLineX.style.display = 'none';
            }, 240);
        };

        const ensureMultiSelectStyles = (doc) => {
            if (!doc || multiSelectStyleInjected) return;
            const style = doc.createElement('style');
            style.id = 'bugence-multi-select-style';
            style.textContent = `
                .bugence-editor-multi {
                    outline: 2px dashed rgba(6,182,212,0.6);
                    outline-offset: 2px;
                }
            `;
            doc.head?.appendChild(style);
            multiSelectStyleInjected = true;
        };

        const getMultiSelectionElements = () => {
            const doc = getCanvasDocument();
            if (!doc) return [];
            const ids = editorBridge.multiSelection || [];
            if (!ids.length) {
                const selected = getSelectedElementNode();
                return selected ? [selected] : [];
            }
            return ids.map(id => doc.querySelector(`[data-bugence-id="${id}"]`)).filter(Boolean);
        };

        const updateMultiSelectionClasses = () => {
            const doc = getCanvasDocument();
            if (!doc) return;
            ensureMultiSelectStyles(doc);
            doc.querySelectorAll('.bugence-editor-multi').forEach(el => el.classList.remove('bugence-editor-multi'));
            const elements = getMultiSelectionElements();
            elements.forEach(el => {
                if (el.getAttribute('data-bugence-id') !== editorBridge.selection?.attributes?.['data-bugence-id']) {
                    el.classList.add('bugence-editor-multi');
                }
            });
        };

        const pushBatchUpdateHistory = (elements, beforeMap) => {
            elements.forEach(el => {
                const id = ensureBugenceId(el);
                if (!id) return;
                const beforeHtml = beforeMap.get(id);
                const afterHtml = el.outerHTML;
                if (beforeHtml && beforeHtml !== afterHtml) {
                    pushHistoryOp({
                        type: 'update',
                        targetId: id,
                        beforeHtml,
                        afterHtml
                    });
                }
            });
        };

        const nudgeSelection = (dx, dy) => {
            const elements = getMultiSelectionElements();
            if (!elements.length) return;
            const beforeMap = new Map();
            elements.forEach(el => {
                const id = ensureBugenceId(el);
                if (id) beforeMap.set(id, el.outerHTML);
            });
            elements.forEach(el => {
                const style = el.style;
                const currentLeft = parseFloat(style.marginLeft || '0') || 0;
                const currentTop = parseFloat(style.marginTop || '0') || 0;
                style.marginLeft = `${currentLeft + dx}px`;
                style.marginTop = `${currentTop + dy}px`;
            });
            pushBatchUpdateHistory(elements, beforeMap);
            scheduleAutoSave();
            updateSelectionOverlay();
            updateMultiSelectionClasses();
        };

        const applyAlignmentToSelection = (alignValue) => {
            const elements = getMultiSelectionElements();
            if (!elements.length) return;
            const doc = getCanvasDocument();
            const beforeMap = new Map();
            elements.forEach(el => {
                const id = ensureBugenceId(el);
                if (id) beforeMap.set(id, el.outerHTML);
            });
            elements.forEach(el => {
                const tag = el.tagName.toLowerCase();
                const isText = ['p', 'span', 'strong', 'em', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'a', 'button'].includes(tag);
                if (isText) {
                    el.style.textAlign = alignValue;
                    return;
                }
                const parent = el.parentElement;
                if (parent) {
                    const parentDisplay = doc.defaultView?.getComputedStyle(parent)?.display || '';
                    const isGrid = parentDisplay.includes('grid');
                    if (parentDisplay.includes('flex')) {
                        el.style.alignSelf = alignValue === 'left'
                            ? 'flex-start'
                            : alignValue === 'right'
                                ? 'flex-end'
                                : 'center';
                    } else if (isGrid) {
                        el.style.justifySelf = alignValue === 'left'
                            ? 'start'
                            : alignValue === 'right'
                                ? 'end'
                                : 'center';
                    } else {
                        el.style.marginLeft = alignValue === 'right' || alignValue === 'center' ? 'auto' : '0';
                        el.style.marginRight = alignValue === 'left' || alignValue === 'center' ? 'auto' : '0';
                    }
                }
            });
            pushBatchUpdateHistory(elements, beforeMap);
            scheduleAutoSave();
            updateSelectionOverlay();
            if (elements.length) {
                flashSnapGuides(elements[0].getBoundingClientRect());
            }
        };

        const beginMoveDrag = (event, doc) => {
            const el = getSelectedElementNode();
            if (!el || el.hasAttribute('data-bugence-editor')) return;
            const marker = ensureMoveMarker(doc);
            const fromParent = el.parentElement;
            const fromIndex = fromParent ? Array.from(fromParent.children).indexOf(el) : -1;
            moveDragState = { el, fromParent, fromIndex, target: null, mode: null };
            marker.style.display = 'none';
            updateSelectionOverlay();
            let raf = null;
            let lastEvent = null;
            const updateMarker = () => {
                raf = null;
                if (!lastEvent) return;
                const target = doc.elementFromPoint(lastEvent.clientX, lastEvent.clientY);
                if (!target || target.closest?.('[data-bugence-editor="true"]')) return;
                if (target === el || el.contains(target)) {
                    marker.style.display = 'none';
                    moveDragState.target = null;
                    moveDragState.mode = null;
                    return;
                }
                const dropzone = target.closest?.('[data-bugence-dropzone="true"]');
                const rect = (dropzone || target).getBoundingClientRect();
                const before = lastEvent.clientY < rect.top + rect.height / 2;
                if (dropzone) {
                    marker.style.left = `${rect.left}px`;
                    marker.style.top = `${rect.top}px`;
                    marker.style.width = `${rect.width}px`;
                    marker.style.height = `${rect.height}px`;
                    marker.style.borderStyle = 'dashed';
                    marker.style.background = 'rgba(6,182,212,0.08)';
                    moveDragState.target = dropzone;
                    moveDragState.mode = 'inside';
                } else {
                    marker.style.left = `${rect.left}px`;
                    marker.style.top = `${before ? rect.top : rect.bottom}px`;
                    marker.style.width = `${rect.width}px`;
                    marker.style.height = '2px';
                    marker.style.borderStyle = 'solid';
                    marker.style.background = 'rgba(6,182,212,0.8)';
                    moveDragState.target = target;
                    moveDragState.mode = before ? 'before' : 'after';
                }
                marker.style.display = 'block';
            };
            const onMove = (moveEvent) => {
                lastEvent = moveEvent;
                if (raf) return;
                raf = requestAnimationFrame(updateMarker);
            };
            const onUp = () => {
                doc.removeEventListener('mousemove', onMove);
                doc.removeEventListener('mouseup', onUp);
                marker.style.display = 'none';
                lastEvent = null;
                if (raf) {
                    cancelAnimationFrame(raf);
                    raf = null;
                }
                if (!moveDragState || !moveDragState.target || !moveDragState.mode) {
                    moveDragState = null;
                    return;
                }
                const dropTarget = moveDragState.target;
                const mode = moveDragState.mode;
                const moving = moveDragState.el;
                const originParent = moveDragState.fromParent;
                const originIndex = moveDragState.fromIndex;
                if (!moving || !dropTarget) {
                    moveDragState = null;
                    return;
                }
                if (mode === 'inside') {
                    dropTarget.appendChild(moving);
                } else if (dropTarget.parentElement) {
                    if (mode === 'before') {
                        dropTarget.parentElement.insertBefore(moving, dropTarget);
                    } else {
                        dropTarget.parentElement.insertBefore(moving, dropTarget.nextSibling);
                    }
                }
                const toParent = moving.parentElement;
                const toIndex = toParent ? Array.from(toParent.children).indexOf(moving) : -1;
                if (originParent && toParent && originIndex !== -1 && toIndex !== -1) {
                    pushHistoryOp({
                        type: 'move',
                        targetId: ensureBugenceId(moving),
                        fromParentId: ensureBugenceId(originParent),
                        fromIndex: originIndex,
                        toParentId: ensureBugenceId(toParent),
                        toIndex
                    });
                }
                rebuildInlineAdd();
                markEdit('structural');
                scheduleAutoSave();
                scheduleStructureUpdate();
                updateSelectionOverlay();
                updateMultiSelectionClasses();
                moveDragState = null;
            };
            doc.addEventListener('mousemove', onMove);
            doc.addEventListener('mouseup', onUp);
        };

        const beginFreeDrag = (event, doc, el) => {
            if (!el || el.hasAttribute('data-bugence-editor')) return;
            const rect = el.getBoundingClientRect();
            const scrollX = doc.defaultView?.pageXOffset || 0;
            const scrollY = doc.defaultView?.pageYOffset || 0;
            const offsetX = event.clientX - rect.left;
            const offsetY = event.clientY - rect.top;
            const beforeHtml = el.outerHTML;
            const host = doc.body;
            if (el.parentElement !== host) {
                host.appendChild(el);
            }
            el.style.position = 'absolute';
            el.style.left = `${rect.left + scrollX}px`;
            el.style.top = `${rect.top + scrollY}px`;
            el.style.width = `${rect.width}px`;
            el.style.zIndex = '25';
            doc.body.style.cursor = 'grabbing';
            freeDragState = { el, beforeHtml };

            let raf = null;
            let lastEvent = null;
            const updatePosition = () => {
                raf = null;
                if (!lastEvent) return;
                const nextLeft = lastEvent.clientX + scrollX - offsetX;
                const nextTop = lastEvent.clientY + scrollY - offsetY;
                el.style.left = `${Math.max(0, nextLeft)}px`;
                el.style.top = `${Math.max(0, nextTop)}px`;
            };
            const onMove = (moveEvent) => {
                lastEvent = moveEvent;
                if (raf) return;
                raf = requestAnimationFrame(updatePosition);
            };
            const onUp = () => {
                doc.removeEventListener('mousemove', onMove);
                doc.removeEventListener('mouseup', onUp);
                doc.body.style.cursor = '';
                if (raf) {
                    cancelAnimationFrame(raf);
                    raf = null;
                }
                lastEvent = null;
                const afterHtml = el.outerHTML;
                if (freeDragState?.beforeHtml && freeDragState.beforeHtml !== afterHtml) {
                    pushHistoryOp({
                        type: 'update',
                        targetId: ensureBugenceId(el),
                        beforeHtml: freeDragState.beforeHtml,
                        afterHtml
                    });
                    lastSelectionHtml = afterHtml;
                    scheduleAutoSave();
                }
                freeDragState = null;
                updateSelectionOverlay();
                updateMultiSelectionClasses();
            };
            doc.addEventListener('mousemove', onMove);
            doc.addEventListener('mouseup', onUp);
        };

        const updateSelectionOverlay = () => {
            if (selectionOverlayRaf) return;
            selectionOverlayRaf = requestAnimationFrame(() => {
                selectionOverlayRaf = null;
                const doc = getCanvasDocument();
                if (!doc) return;
                const overlay = ensureSelectionOverlay(doc);
                const el = getSelectedElementNode();
                if (!el || el.hasAttribute('data-bugence-editor')) {
                    overlay.style.display = 'none';
                    return;
                }
                const rect = el.getBoundingClientRect();
                if (!rect.width || !rect.height) {
                    overlay.style.display = 'none';
                    return;
                }
                const selectionId = editorBridge.selection?.attributes?.['data-bugence-id'] || el.getAttribute('data-bugence-id');
                if (selectionOverlayDismissedId && selectionId === selectionOverlayDismissedId) {
                    overlay.style.display = 'none';
                    return;
                }
                const label = overlay.querySelector('[data-selection-label]');
                if (label) {
                    const count = (editorBridge.multiSelection || []).length;
                    const base = el.getAttribute('data-bugence-type') || el.tagName.toLowerCase();
                    label.textContent = count > 1 ? `${base} (${count})` : base;
                }
                overlay.style.display = 'flex';
                const padding = 12;
                const maxLeft = doc.documentElement.clientWidth - overlay.offsetWidth - padding;
                const maxTop = doc.documentElement.clientHeight - overlay.offsetHeight - padding;
                if (selectionOverlayPinned && selectionOverlayPinnedPos) {
                    const pinnedLeft = Math.min(Math.max(padding, selectionOverlayPinnedPos.left), Math.max(padding, maxLeft));
                    const pinnedTop = Math.min(Math.max(padding, selectionOverlayPinnedPos.top), Math.max(padding, maxTop));
                    overlay.style.left = `${pinnedLeft}px`;
                    overlay.style.top = `${pinnedTop}px`;
                    selectionOverlayPinnedPos = { left: pinnedLeft, top: pinnedTop };
                    return;
                }
                const idealLeft = rect.right - overlay.offsetWidth;
                const nextLeft = Math.min(Math.max(padding, idealLeft), Math.max(padding, maxLeft));
                let nextTop = rect.top - overlay.offsetHeight - 10;
                if (nextTop < padding) {
                    nextTop = rect.bottom + 10;
                }
                if (nextTop > maxTop) {
                    nextTop = Math.min(Math.max(padding, rect.top + 8), Math.max(padding, maxTop));
                }
                overlay.style.left = `${nextLeft}px`;
                overlay.style.top = `${nextTop}px`;
            });
        };

        const initSelectionOverlay = () => {
            const doc = getCanvasDocument();
            if (!doc || selectionOverlayBound) return;
            selectionOverlayBound = true;
            ensureMultiSelectStyles(doc);
            doc.defaultView?.addEventListener('scroll', updateSelectionOverlay, { passive: true });
            doc.defaultView?.addEventListener('resize', updateSelectionOverlay);
            const overlay = ensureSelectionOverlay(doc);
            const dragHandle = overlay?.querySelector?.('[data-selection-drag]');
            if (overlay && dragHandle && !dragHandle.dataset.bugenceDragBound) {
                dragHandle.dataset.bugenceDragBound = '1';
                dragHandle.addEventListener('mousedown', (event) => {
                    if (event.button !== 0) return;
                    event.preventDefault();
                    event.stopPropagation();
                    selectionOverlayPinned = true;
                    selectionOverlayDismissedId = null;
                    const startLeft = overlay.offsetLeft;
                    const startTop = overlay.offsetTop;
                    const startX = event.clientX;
                    const startY = event.clientY;
                    overlay.classList.add('is-dragging');
                    const onMove = (moveEvent) => {
                        const deltaX = moveEvent.clientX - startX;
                        const deltaY = moveEvent.clientY - startY;
                        const maxLeft = doc.documentElement.clientWidth - overlay.offsetWidth - 12;
                        const maxTop = doc.documentElement.clientHeight - overlay.offsetHeight - 12;
                        const nextLeft = Math.min(Math.max(12, startLeft + deltaX), Math.max(12, maxLeft));
                        const nextTop = Math.min(Math.max(12, startTop + deltaY), Math.max(12, maxTop));
                        overlay.style.left = `${nextLeft}px`;
                        overlay.style.top = `${nextTop}px`;
                        selectionOverlayPinnedPos = { left: nextLeft, top: nextTop };
                    };
                    const onUp = () => {
                        overlay.classList.remove('is-dragging');
                        doc.removeEventListener('mousemove', onMove);
                        doc.removeEventListener('mouseup', onUp);
                    };
                    doc.addEventListener('mousemove', onMove);
                    doc.addEventListener('mouseup', onUp, { once: true });
                });
            }
            if (overlay && !overlay.dataset.bugenceMoveBound) {
                overlay.dataset.bugenceMoveBound = '1';
                overlay.addEventListener('mousedown', (event) => {
                    const button = event.target?.closest?.('button[data-selection-action]');
                    const action = button?.getAttribute?.('data-selection-action');
                    if (action !== 'move') return;
                    event.preventDefault();
                    event.stopPropagation();
                    beginMoveDrag(event, doc);
                });
            }
            if (!directMoveBound) {
                directMoveBound = true;
                doc.addEventListener('mousedown', (event) => {
                    if (event.button !== 0) return;
                    if (!event.shiftKey) return;
                    if (event.target?.closest?.('[data-bugence-editor="true"]')) return;
                    const tag = event.target?.tagName?.toLowerCase();
                    if (['input', 'textarea', 'select'].includes(tag) || event.target?.isContentEditable) return;
                    const selected = getSelectedElementNode();
                    if (!selected || !(selected === event.target || selected.contains(event.target))) return;
                    const startX = event.clientX;
                    const startY = event.clientY;
                    const onMove = (moveEvent) => {
                        const dx = Math.abs(moveEvent.clientX - startX);
                        const dy = Math.abs(moveEvent.clientY - startY);
                        if (dx < 4 && dy < 4) return;
                        doc.removeEventListener('mousemove', onMove);
                        doc.removeEventListener('mouseup', onUp);
                        moveEvent.preventDefault();
                        beginMoveDrag(moveEvent, doc);
                    };
                    const onUp = () => {
                        doc.removeEventListener('mousemove', onMove);
                    };
                    doc.addEventListener('mousemove', onMove);
                    doc.addEventListener('mouseup', onUp, { once: true });
                }, true);
            }
            if (!freeDragBound) {
                freeDragBound = true;
                doc.addEventListener('mousedown', (event) => {
                    if (event.button !== 0) return;
                    if (!event.altKey) return;
                    if (event.target?.closest?.('[data-bugence-editor="true"]')) return;
                    const tag = event.target?.tagName?.toLowerCase();
                    if (['input', 'textarea', 'select'].includes(tag) || event.target?.isContentEditable) return;
                    const el = event.target?.closest?.('[data-bugence-id]') || event.target;
                    if (!el || el === doc.body || el === doc.documentElement) return;
                    const startX = event.clientX;
                    const startY = event.clientY;
                    const onMove = (moveEvent) => {
                        const dx = Math.abs(moveEvent.clientX - startX);
                        const dy = Math.abs(moveEvent.clientY - startY);
                        if (dx < 4 && dy < 4) return;
                        doc.removeEventListener('mousemove', onMove);
                        doc.removeEventListener('mouseup', onUp);
                        const id = ensureBugenceId(el);
                        if (id) {
                            sendToIframe('bugence-editor:select', { selector: `[data-bugence-id="${id}"]` });
                        }
                        beginFreeDrag(moveEvent, doc, el);
                    };
                    const onUp = () => {
                        doc.removeEventListener('mousemove', onMove);
                    };
                    doc.addEventListener('mousemove', onMove);
                    doc.addEventListener('mouseup', onUp, { once: true });
                }, true);
            }
            doc.defaultView?.addEventListener('keydown', (event) => {
                if (event.defaultPrevented) return;
                const tag = event.target?.tagName?.toLowerCase();
                if (['input', 'textarea', 'select'].includes(tag)) return;
                const keys = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
                if (!keys.includes(event.key)) return;
                event.preventDefault();
                const step = event.shiftKey ? 10 : 1;
                const dx = event.key === 'ArrowLeft' ? -step : event.key === 'ArrowRight' ? step : 0;
                const dy = event.key === 'ArrowUp' ? -step : event.key === 'ArrowDown' ? step : 0;
                nudgeSelection(dx, dy);
            });
        };

        const initTabsInteractions = () => {
            const doc = getCanvasDocument();
            if (!doc) return;
            doc.querySelectorAll('[data-bugence-type="tabs"]').forEach(tabs => {
                const bar = tabs.querySelector('[data-bugence-tabs="buttons"]');
                const panes = tabs.querySelector('[data-bugence-tabs="panes"]');
                if (!bar || !panes) return;
                const firstBtn = bar.querySelector('button[data-tab-id]');
                const activeId = tabs.dataset.bugenceActiveTab || firstBtn?.getAttribute('data-tab-id');
                if (activeId) {
                    tabs.dataset.bugenceActiveTab = activeId;
                }
                bar.querySelectorAll('button[data-tab-id]').forEach(btn => {
                    btn.onclick = () => {
                        const id = btn.getAttribute('data-tab-id');
                        if (!id) return;
                        tabs.dataset.bugenceActiveTab = id;
                        setActiveTab(tabs, id);
                        updateTabsContentInputs(tabs);
                    };
                });
                if (activeId) {
                    setActiveTab(tabs, activeId);
                }
            });
        };

        const initGalleryInteractions = () => {
            const doc = getCanvasDocument();
            if (!doc) return;
            doc.querySelectorAll('[data-bugence-type="gallery"]').forEach(gallery => {
                gallery.querySelectorAll('img').forEach(img => {
                    if (img.dataset.bugenceGalleryBound) return;
                    img.dataset.bugenceGalleryBound = '1';
                    img.setAttribute('draggable', 'true');
                    img.addEventListener('dragstart', (event) => {
                        event.dataTransfer?.setData('text/plain', 'gallery-image');
                        img.classList.add('dragging');
                    });
                    img.addEventListener('dragend', () => {
                        img.classList.remove('dragging');
                    });
                });
                gallery.addEventListener('dragover', (event) => {
                    event.preventDefault();
                    const dragging = gallery.querySelector('img.dragging');
                    const target = event.target?.closest?.('img');
                    if (!dragging || !target || dragging === target) return;
                    const rect = target.getBoundingClientRect();
                    const before = event.clientX < rect.left + rect.width / 2;
                    gallery.insertBefore(dragging, before ? target : target.nextSibling);
                });
                gallery.addEventListener('drop', () => {
                    scheduleHistorySnapshot();
                    scheduleAutoSave();
                });
            });
        };

        const initGalleryLightbox = () => {
            const doc = getCanvasDocument();
            if (!doc) return;
            let overlay = doc.getElementById('bugence-lightbox');
            if (!overlay) {
                overlay = doc.createElement('div');
                overlay.id = 'bugence-lightbox';
                overlay.setAttribute('data-bugence-editor', 'true');
                overlay.style.position = 'fixed';
                overlay.style.inset = '0';
                overlay.style.background = 'rgba(0,0,0,0.8)';
                overlay.style.display = 'none';
                overlay.style.alignItems = 'center';
                overlay.style.justifyContent = 'center';
                overlay.style.zIndex = '2147483647';
                overlay.innerHTML = `
                    <button type="button" data-bugence-lightbox-close="true" style="position:absolute;top:24px;right:24px;width:36px;height:36px;border-radius:999px;border:1px solid rgba(255,255,255,0.2);background:rgba(10,10,10,0.6);color:#f8fafc;font-size:20px;cursor:pointer;"></button>
                    <img style="max-width:90%;max-height:90%;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.6);" />
                `;
                doc.body.appendChild(overlay);
                overlay.addEventListener('click', () => {
                    overlay.style.display = 'none';
                });
                const closeBtn = overlay.querySelector('[data-bugence-lightbox-close]');
                closeBtn?.addEventListener('click', (event) => {
                    event.stopPropagation();
                    overlay.style.display = 'none';
                });
                if (!overlay.dataset.bugenceEscBound) {
                    overlay.dataset.bugenceEscBound = '1';
                    doc.defaultView?.addEventListener('keydown', (event) => {
                        if (event.key === 'Escape' && overlay.style.display === 'flex') {
                            overlay.style.display = 'none';
                        }
                    });
                }
            }
            doc.querySelectorAll('[data-bugence-type="gallery"] img').forEach(img => {
                if (img.dataset.bugenceLightboxBound) return;
                img.dataset.bugenceLightboxBound = '1';
                img.addEventListener('click', () => {
                    const target = overlay.querySelector('img');
                    if (target) target.src = img.src;
                    overlay.style.display = 'flex';
                });
            });
        };

        const bindIframeHistoryListeners = () => {
            const doc = getCanvasDocument();
            if (!doc || iframeHistoryDoc === doc) return;
            iframeHistoryDoc = doc;
            const shouldTrack = (target) => {
                if (!target || target.closest?.('[data-bugence-editor="true"]')) return false;
                const tag = target.tagName?.toLowerCase();
                if (['input', 'textarea', 'select'].includes(tag)) return true;
                return !!target.isContentEditable;
            };
            doc.addEventListener('input', (event) => {
                if (!shouldTrack(event.target)) return;
                scheduleHistorySnapshot();
                scheduleAutoSave();
            }, true);
            doc.addEventListener('change', (event) => {
                if (!shouldTrack(event.target)) return;
                scheduleHistorySnapshot();
                scheduleAutoSave();
            }, true);
        };

        const sanitizeEmbedSources = () => {
            const doc = getCanvasDocument();
            if (!doc) return;
            const placeholderHtml = '<div style="opacity:.7;font-size:12px;">Paste an embed URL in Widget settings.</div>';
            doc.querySelectorAll('[data-bugence-type="embed"], [data-bugence-type="lottie"]').forEach(el => {
                const raw = el.getAttribute('data-bugence-embed') || '';
                const safe = safeUrlValue(raw);
                if (!safe && raw) {
                    el.removeAttribute('data-bugence-embed');
                    el.innerHTML = placeholderHtml;
                }
            });
            doc.querySelectorAll('[data-bugence-type="youtube"], [data-bugence-type="vimeo"], iframe').forEach(el => {
                const raw = el.getAttribute('data-bugence-embed') || el.getAttribute('src') || '';
                const safe = safeUrlValue(raw);
                if (!safe && raw) {
                    el.removeAttribute('data-bugence-embed');
                    if (el.tagName.toLowerCase() === 'iframe') {
                        el.removeAttribute('src');
                    }
                }
            });
        };
        const applyOverlayPassThrough = () => {
            const doc = getCanvasDocument();
            if (!doc) return;
            const win = doc.defaultView;
            if (!win) return;
            const viewport = doc.documentElement.getBoundingClientRect();
            const candidates = Array.from(doc.querySelectorAll('div, span, section, header, footer, main, article'));
            candidates.forEach(el => {
                if (!el || el.closest?.('[data-bugence-editor="true"]')) return;
                if (el.hasAttribute('data-bugence-dropzone') || el.getAttribute('data-bugence-type')) return;
                if (el.getAttribute('data-bugence-overlay') === 'keep' || el.closest?.('[data-bugence-overlay="keep"]')) return;
                if (el.childElementCount > 0) return;
                if (el.textContent?.trim()) return;
                const style = win.getComputedStyle(el);
                if (style.pointerEvents === 'none') return;
                const position = style.position;
                if (position !== 'absolute' && position !== 'fixed') return;
                if (style.display === 'none' || style.visibility === 'hidden') return;
                const rect = el.getBoundingClientRect();
                if (!rect.width || !rect.height) return;
                const parent = el.offsetParent || el.parentElement;
                const parentRect = parent ? parent.getBoundingClientRect() : viewport;
                if (!parentRect.width || !parentRect.height) return;
                const coversWidth = rect.width >= parentRect.width * 0.88;
                const coversHeight = rect.height >= parentRect.height * 0.6;
                const nearLeft = Math.abs(rect.left - parentRect.left) < 8;
                const nearTop = Math.abs(rect.top - parentRect.top) < 8;
                const hasInsetClass = el.classList?.contains('inset-0');
                const zIndex = parseInt(style.zIndex, 10);
                const layered = Number.isNaN(zIndex) ? false : zIndex >= 1;
                const overlayLike = (coversWidth && coversHeight && nearLeft && nearTop && layered) || hasInsetClass;
                if (!overlayLike) return;
                el.style.pointerEvents = 'none';
                el.setAttribute('data-bugence-overlay', 'auto');
            });
        };
        const initIframeEnhancements = () => {
            initTabsInteractions();
            initGalleryInteractions();
            initGalleryLightbox();
            bindIframeHistoryListeners();
            sanitizeEmbedSources();
            applyOverlayPassThrough();
        };

        const getTabsRootFromSelection = () => {
            const node = getSelectedElementNode();
            if (!node) return null;
            if (node.getAttribute?.('data-bugence-type') === 'tabs') return node;
            return node.closest?.('[data-bugence-type="tabs"]');
        };

        const getActiveTabParts = (tabs) => {
            if (!tabs) return {};
            const bar = tabs.querySelector('[data-bugence-tabs="buttons"]');
            const panes = tabs.querySelector('[data-bugence-tabs="panes"]');
            if (!bar || !panes) return { bar, panes };
            const activeId = tabs.dataset.bugenceActiveTab || bar.querySelector('button[data-tab-id]')?.getAttribute('data-tab-id');
            if (activeId && !tabs.dataset.bugenceActiveTab) {
                tabs.dataset.bugenceActiveTab = activeId;
            }
            const activeButton = activeId ? bar.querySelector(`button[data-tab-id="${activeId}"]`) : null;
            const activePane = activeId ? panes.querySelector(`[data-tab-id="${activeId}"]`) : null;
            return { bar, panes, activeId, activeButton, activePane };
        };

        const setActiveTab = (tabs, id) => {
            if (!tabs || !id) return;
            const { bar, panes } = getActiveTabParts(tabs);
            if (!bar || !panes) return;
            bar.querySelectorAll('button[data-tab-id]').forEach(b => {
                b.style.background = 'transparent';
                b.style.opacity = '0.7';
            });
            const target = bar.querySelector(`button[data-tab-id="${id}"]`);
            if (target) {
                target.style.background = 'rgba(255,255,255,0.08)';
                target.style.opacity = '1';
            }
            panes.querySelectorAll('[data-tab-id]').forEach(pane => {
                pane.style.display = pane.getAttribute('data-tab-id') === id ? 'block' : 'none';
            });
        };

        const updateTabsContentInputs = (tabs) => {
            if (!tabs || !controlRefs.tabTitleInput || !controlRefs.tabContentInput) return;
            const { activeButton, activePane } = getActiveTabParts(tabs);
            if (!activeButton || !activePane) return;
            controlRefs.tabTitleInput.value = activeButton.textContent || '';
            controlRefs.tabContentInput.value = activePane.textContent || '';
        };

        const initStructureDragging = () => {
            const panel = controlRefs.structureFloating;
            const handle = controlRefs.structureDragHandle;
            if (!panel || !handle) return;
            let isDragging = false;
            let startX = 0;
            let startY = 0;
            let startLeft = 0;
            let startTop = 0;
            handle.addEventListener('mousedown', (event) => {
                isDragging = true;
                startX = event.clientX;
                startY = event.clientY;
                const rect = panel.getBoundingClientRect();
                startLeft = rect.left;
                startTop = rect.top;
                event.preventDefault();
            });
            window.addEventListener('mousemove', (event) => {
                if (!isDragging) return;
                const nextLeft = Math.max(10, Math.min(window.innerWidth - panel.offsetWidth - 10, startLeft + (event.clientX - startX)));
                const nextTop = Math.max(10, Math.min(window.innerHeight - panel.offsetHeight - 10, startTop + (event.clientY - startY)));
                panel.style.left = `${nextLeft}px`;
                panel.style.top = `${nextTop}px`;
                panel.style.right = 'auto';
            });
            window.addEventListener('mouseup', () => {
                isDragging = false;
            });
        };

        const normalizeCssValue = (value) => {
            const trimmed = String(value ?? '').trim();
            if (!trimmed) return '';
            if (trimmed.toLowerCase() === 'auto') return 'auto';
            if (/^-?\d+(\.\d+)?$/.test(trimmed)) return `${trimmed}px`;
            return trimmed;
        };

        const formatSpacingValue = (value) => {
            if (!value) return '';
            if (value.toLowerCase() === 'auto') return 'Auto';
            return value.replace(/px$/i, '');
        };

        const decodeHtmlEntities = (value) => {
            if (!value || typeof value !== 'string') return value || '';
            if (!value.includes('&')) return value;
            const map = {
                '&lt;': '<',
                '&gt;': '>',
                '&amp;': '&',
                '&quot;': '"',
                '&#39;': "'"
            };
            return value.replace(/&(lt|gt|amp|quot|#39);/g, (match) => map[match] || match);
        };

        const normalizeColor = (value) => {
            if (!value) return '';
            if (value.startsWith('#')) return value;
            const match = value.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([0-9.]+))?\)/i);
            if (match) {
                const alpha = match[4];
                if (alpha !== undefined && Number(alpha) === 0) return 'transparent';
                const toHex = (num) => Number(num).toString(16).padStart(2, '0');
                return `#${toHex(match[1])}${toHex(match[2])}${toHex(match[3])}`;
            }
            return value;
        };
        const isTransparentColor = (value) => {
            if (!value) return true;
            const trimmed = String(value).trim().toLowerCase();
            if (!trimmed || trimmed === 'transparent') return true;
            const rgbaMatch = trimmed.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([0-9.]+)\)/i);
            if (rgbaMatch && Number(rgbaMatch[4]) === 0) return true;
            return false;
        };
        const setBackgroundControlState = (colorValue, transparent) => {
            isBgTransparent = !!transparent;
            if (controlRefs.bgTransparentToggle) {
                controlRefs.bgTransparentToggle.checked = isBgTransparent;
            }
            if (controlRefs.bgColorPill) {
                controlRefs.bgColorPill.classList.toggle('is-transparent', isBgTransparent);
            }
            if (controlRefs.bgColorInput) {
                controlRefs.bgColorInput.disabled = isBgTransparent;
                controlRefs.bgColorInput.classList.toggle('is-disabled', isBgTransparent);
            }
            if (controlRefs.bgColorValue) {
                controlRefs.bgColorValue.textContent = isBgTransparent ? 'transparent' : (colorValue || '#000000');
            }
        };
        const hexToRgb = (hex) => {
            if (!hex || !hex.startsWith('#')) return null;
            const normalized = hex.length === 4
                ? `#${hex[1]}${hex[1]}${hex[2]}${hex[2]}${hex[3]}${hex[3]}`
                : hex;
            const match = normalized.match(/^#([0-9a-f]{6})$/i);
            if (!match) return null;
            const intVal = parseInt(match[1], 16);
            return {
                r: (intVal >> 16) & 255,
                g: (intVal >> 8) & 255,
                b: intVal & 255
            };
        };
        const getLuminance = (hex) => {
            const rgb = hexToRgb(hex);
            if (!rgb) return null;
            const transform = (value) => {
                const normalized = value / 255;
                return normalized <= 0.03928
                    ? normalized / 12.92
                    : Math.pow((normalized + 0.055) / 1.055, 2.4);
            };
            const r = transform(rgb.r);
            const g = transform(rgb.g);
            const b = transform(rgb.b);
            return 0.2126 * r + 0.7152 * g + 0.0722 * b;
        };
        const isLightColor = (hex) => {
            const luminance = getLuminance(hex);
            return luminance !== null && luminance > 0.62;
        };
        const ensureThemeContrast = (vars) => {
            const next = { ...(vars || {}) };
            const base = normalizeColor(next['--bg-panel'] || next['--bg'] || '');
            if (!base || !base.startsWith('#')) return next;
            if (!isLightColor(base)) return next;
            const text = normalizeColor(next['--text'] || '');
            if (!text || (text.startsWith('#') && isLightColor(text))) {
                next['--text'] = '#0f172a';
            }
            const muted = normalizeColor(next['--muted'] || '');
            if (!muted || (muted.startsWith('#') && isLightColor(muted))) {
                next['--muted'] = '#475569';
            }
            const border = normalizeColor(next['--border'] || '');
            if (!border || (border.startsWith('#') && isLightColor(border))) {
                next['--border'] = '#d7dde6';
            }
            return next;
        };

        const describeWeight = (value) => {
            const weight = parseInt(value, 10);
            if (Number.isNaN(weight)) return value || '';
            if (weight >= 700) return `${weight} Bold`;
            if (weight >= 600) return `${weight} Semi`;
            if (weight >= 500) return `${weight} Medium`;
            if (weight >= 400) return `${weight} Regular`;
            return `${weight} Light`;
        };

        const showToast = (message) => {
            if (!controlRefs.autosaveToast) return;
            controlRefs.autosaveToast.textContent = message;
            controlRefs.autosaveToast.classList.add('is-visible');
            clearTimeout(controlRefs.autosaveToast._timer);
            controlRefs.autosaveToast._timer = setTimeout(() => {
                controlRefs.autosaveToast.classList.remove('is-visible');
            }, 1600);
        };

        const renderHistoryPanel = () => {
            if (!controlRefs.historyList) return;
            controlRefs.historyList.innerHTML = '';
            if (!historyOps.length) {
                controlRefs.historyList.innerHTML = '<div class="hint-text">No history yet.</div>';
                return;
            }
            const doc = getCanvasDocument();
            const items = historyOps.slice(-12).reverse();
            items.forEach((op) => {
                const item = document.createElement('div');
                item.className = 'utility-item';
                const type = op.type ? op.type.charAt(0).toUpperCase() + op.type.slice(1) : 'Update';
                const target = doc ? doc.querySelector(`[data-bugence-id="${op.targetId}"]`) : null;
                const tagLabel = target ? `<${target.tagName.toLowerCase()}>` : 'Element';
                item.textContent = `${type} ${tagLabel}`;
                const meta = document.createElement('small');
                meta.textContent = op.targetId ? op.targetId.slice(-6) : '';
                item.appendChild(meta);
                if (op.targetId) {
                    item.addEventListener('click', () => {
                        sendToIframe('bugence-editor:select', { selector: `[data-bugence-id="${op.targetId}"]` });
                    });
                }
                controlRefs.historyList.appendChild(item);
            });
        };

        const updateHistoryButtons = () => {
            if (controlRefs.undoBtn) {
                controlRefs.undoBtn.disabled = historyIndex < 0;
            }
            if (controlRefs.redoBtn) {
                controlRefs.redoBtn.disabled = historyIndex >= historyOps.length - 1;
            }
            if (controlRefs.historyUndoBtn) {
                controlRefs.historyUndoBtn.disabled = historyIndex < 0;
            }
            if (controlRefs.historyRedoBtn) {
                controlRefs.historyRedoBtn.disabled = historyIndex >= historyOps.length - 1;
            }
            renderHistoryPanel();
        };

        const pushHistoryOp = (op) => {
            if (!op) return;
            if (historyIndex < historyOps.length - 1) {
                historyOps = historyOps.slice(0, historyIndex + 1);
            }
            const last = historyOps[historyOps.length - 1];
            if (last && op.type === 'update' && last.type === 'update' && last.targetId === op.targetId) {
                last.afterHtml = op.afterHtml;
                historyIndex = historyOps.length - 1;
            } else {
                historyOps.push(op);
                historyIndex = historyOps.length - 1;
            }
            updateHistoryButtons();
        };

        const getSelectedElementNode = () => {
            const doc = getCanvasDocument();
            if (!doc) return null;
            const selection = editorBridge.selection;
            if (selection?.attributes?.['data-bugence-id']) {
                const el = doc.querySelector(`[data-bugence-id="${selection.attributes['data-bugence-id']}"]`);
                if (el) return el;
            }
            if (!selection?.selector) return null;
            try {
                return doc.querySelector(selection.selector);
            } catch {
                return null;
            }
        };

        const ensureBugenceId = (el) => {
            if (!el) return null;
            if (!el.dataset.bugenceId) {
                el.dataset.bugenceId = `bugence-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
            }
            return el.dataset.bugenceId;
        };

        const scheduleHistorySnapshot = () => {
            if (isRestoringHistory) return;
            const el = getSelectedElementNode();
            if (!el) return;
            const targetId = ensureBugenceId(el);
            if (!targetId) return;
            if (!pendingHistory || pendingHistory.targetId !== targetId) {
                pendingHistory = {
                    targetId,
                    beforeHtml: lastSelectionHtml || el.outerHTML
                };
            }
            clearTimeout(historyTimer);
            historyTimer = setTimeout(() => {
                const doc = getCanvasDocument();
                if (!doc || !pendingHistory) return;
                const current = doc.querySelector(`[data-bugence-id="${pendingHistory.targetId}"]`);
                if (!current) {
                    pendingHistory = null;
                    return;
                }
                const afterHtml = current.outerHTML;
                if (pendingHistory.beforeHtml !== afterHtml) {
                    pushHistoryOp({
                        type: 'update',
                        targetId: pendingHistory.targetId,
                        beforeHtml: pendingHistory.beforeHtml,
                        afterHtml
                    });
                    lastSelectionHtml = afterHtml;
                }
                pendingHistory = null;
            }, 320);
        };

        const scheduleAutoSave = () => {
            if (isRestoringHistory) return;
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(async () => {
                const html = normalizeEditorUrls(getIframeHtml());
                if (!html) return;
                try {
                    await postEditorChange('SaveDraft', html);
                    showToast('Draft saved');
                } catch {
                    // Best-effort autosave.
                }
            }, 1200);
        };

        updateHistoryButtons();

        const ensureSelectOption = (select, value) => {
            if (!select || !value) return;
            const exists = Array.from(select.options).some(option => option.value === value);
            if (exists) return;
            const option = document.createElement('option');
            option.value = value;
            option.textContent = `${value} (current)`;
            select.appendChild(option);
        };

        const loadWorkflowOptions = async () => {
            if (!controlRefs.workflowSelect) return;
            try {
                const res = await fetch('/Workflows/Index?handler=List');
                const data = await res.json();
                const currentValue = controlRefs.workflowSelect.value;
                controlRefs.workflowSelect.innerHTML = '<option value="">No workflow</option>';
                (Array.isArray(data) ? data : []).forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    controlRefs.workflowSelect.appendChild(option);
                });
                if (currentValue) {
                    ensureSelectOption(controlRefs.workflowSelect, currentValue);
                    controlRefs.workflowSelect.value = currentValue;
                }
            } catch {
                // ignore
            }
        };

        const loadRecentFonts = () => {
            try {
                const stored = JSON.parse(localStorage.getItem(recentFontKey) || '[]');
                if (Array.isArray(stored)) {
                    recentFonts = stored.filter(Boolean);
                }
            } catch {
                recentFonts = [];
            }
        };

        const saveRecentFonts = () => {
            localStorage.setItem(recentFontKey, JSON.stringify(recentFonts.slice(0, 6)));
            queueEditorPrefsSave();
        };

        const rebuildFontOptions = (currentValue) => {
            const select = controlRefs.fontFamilyInput;
            if (!select) return;
            select.innerHTML = '';
            const recentGroup = document.createElement('optgroup');
            recentGroup.label = 'Recent';
            const recentValues = recentFonts.filter(value => value && value !== currentValue);
            if (currentValue) {
                const option = document.createElement('option');
                option.value = currentValue;
                option.textContent = currentValue;
                recentGroup.appendChild(option);
            }
            recentValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                recentGroup.appendChild(option);
            });
            if (recentGroup.children.length) {
                select.appendChild(recentGroup);
            }
            const fontGroup = document.createElement('optgroup');
            fontGroup.label = 'Fonts';
            baseFontOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                fontGroup.appendChild(option);
            });
            select.appendChild(fontGroup);
            if (currentValue && !Array.from(select.options).some(option => option.value === currentValue)) {
                ensureSelectOption(select, currentValue);
            }
            if (currentValue) {
                select.value = currentValue;
            }
        };

        const updateRecentFonts = (value) => {
            if (!value) return;
            recentFonts = [value, ...recentFonts.filter(font => font !== value)].slice(0, 6);
            saveRecentFonts();
        };

        const pickPrimaryFont = (value) => {
            if (!value) return '';
            return value.split(',')[0].trim().replace(/^["']|["']$/g, '');
        };

        const setActiveGroup = (items, activeValue, attrName) => {
            items.forEach(item => {
                const value = item.getAttribute(attrName);
                item.classList.toggle('is-active', value === activeValue);
            });
        };

        const updateControlEnabledState = (payload) => {
            const tag = (payload?.tagName || '').toLowerCase();
            const isLink = tag === 'a';
            const isTextEditable = !['img', 'video', 'audio', 'iframe', 'canvas', 'svg', 'path', 'source', 'picture', 'input', 'select'].includes(tag);
            const isValueEditable = ['input', 'textarea'].includes(tag);
            const isMedia = ['img', 'video', 'audio', 'source'].includes(tag);
            const bugenceType = payload?.attributes?.['data-bugence-type'] || '';
            const isTriggerable = ['a', 'button'].includes(tag) || bugenceType.includes('button');
            const tabsRoot = getTabsRootFromSelection();
            const isGridLike = bugenceType === 'grid' || (payload?.computedStyles?.display || '') === 'grid';
            const isMap = bugenceType === 'map' || (tag === 'iframe' && payload?.attributes?.src?.includes('google.com/maps'));
            const isField = ['input', 'textarea'].includes(tag);
            const isCarousel = bugenceType === 'carousel';
            const isTabs = bugenceType === 'tabs' || !!tabsRoot;
            const isAccordion = bugenceType === 'accordion' || bugenceType === 'faq';
            const isPricing = bugenceType === 'pricing';
            const isGallery = bugenceType === 'gallery';
            const isContent = ['posts', 'loop-grid', 'portfolio', 'team'].includes(bugenceType);
            const isWidget = ['menu', 'breadcrumbs', 'pagination', 'social-icons', 'share', 'reviews', 'timeline', 'counter', 'progress', 'table', 'embed', 'lottie', 'youtube', 'vimeo', 'product-grid', 'icon', 'icon-box', 'image-box', 'carousel', 'gallery', 'map'].includes(bugenceType);

            if (controlRefs.linkUrlInput) {
                controlRefs.linkUrlInput.disabled = !isLink;
                controlRefs.linkUrlInput.placeholder = isLink ? 'https://...' : 'Link only';
            }
            if (controlRefs.workflowSelect) {
                controlRefs.workflowSelect.disabled = !isTriggerable;
                controlRefs.workflowSelect.title = isTriggerable ? '' : 'Select a button or link to assign a workflow';
            }
            if (controlRefs.textContentInput) {
                controlRefs.textContentInput.disabled = !(isTextEditable || isValueEditable);
                controlRefs.textContentInput.placeholder = isTextEditable || isValueEditable
                    ? 'Edit selected text...'
                    : `Text editing not available for <${tag || 'element'}>`;
            }
            if (controlRefs.textModeBadges.length) {
                controlRefs.textModeBadges.forEach(badge => {
                    badge.classList.toggle('is-disabled', !(isTextEditable || isValueEditable));
                });
            }
            if (controlRefs.textEditWarning) {
                controlRefs.textEditWarning.classList.toggle('is-visible', !(isTextEditable || isValueEditable));
            }
            if (controlRefs.mediaControls) {
                controlRefs.mediaControls.style.display = isMedia ? 'block' : 'none';
            }
            if (controlRefs.elementActions) {
                controlRefs.elementActions.style.display = payload?.tagName ? 'block' : 'none';
            }
            if (controlRefs.updateSymbolBtn) {
                const symbolId = getSelectedSymbolId();
                controlRefs.updateSymbolBtn.style.display = symbolId ? 'inline-flex' : 'none';
            }
            if (controlRefs.layoutControls) {
                controlRefs.layoutControls.style.display = isGridLike ? 'block' : 'none';
            }
            if (controlRefs.mapControls) {
                controlRefs.mapControls.style.display = isMap ? 'block' : 'none';
            }
            if (controlRefs.fieldControls) {
                controlRefs.fieldControls.style.display = isField ? 'block' : 'none';
            }
            if (controlRefs.carouselControls) {
                controlRefs.carouselControls.style.display = isCarousel ? 'block' : 'none';
            }
            if (controlRefs.tabsControls) {
                controlRefs.tabsControls.style.display = isTabs ? 'block' : 'none';
            }
            if (controlRefs.tabsContentControls) {
                controlRefs.tabsContentControls.style.display = isTabs ? 'block' : 'none';
            }
            if (controlRefs.accordionControls) {
                controlRefs.accordionControls.style.display = isAccordion ? 'block' : 'none';
            }
            if (controlRefs.pricingControls) {
                controlRefs.pricingControls.style.display = isPricing ? 'block' : 'none';
            }
            if (controlRefs.galleryControls) {
                controlRefs.galleryControls.style.display = isGallery ? 'block' : 'none';
            }
            if (controlRefs.contentControls) {
                controlRefs.contentControls.style.display = isContent ? 'block' : 'none';
            }
            if (controlRefs.widgetControls) {
                controlRefs.widgetControls.style.display = isWidget ? 'block' : 'none';
            }
        };

        const syncControlsFromSelection = (payload) => {
            if (!payload) return;
            const styles = payload.computedStyles || {};
            const attrs = payload.attributes || {};
            if (payload.html && /<[^>]+>/.test(payload.html)) {
                textMode = 'html';
            }
            isSyncingControls = true;
            updateControlEnabledState(payload);
            if (controlRefs.linkUrlInput) {
                controlRefs.linkUrlInput.value = attrs.href || '';
            }
            if (controlRefs.workflowSelect) {
                controlRefs.workflowSelect.value = attrs['data-bugence-workflow-id'] || '';
            }
            if (controlRefs.fontWeightLabel) {
                controlRefs.fontWeightLabel.textContent = describeWeight(styles.fontWeight || '');
            }
            if (controlRefs.fontFamilyInput) {
                const primary = pickPrimaryFont(styles.fontFamily || '');
                rebuildFontOptions(primary);
            }
            if (controlRefs.fontSizeInput) {
                controlRefs.fontSizeInput.value = styles.fontSize || '';
            }
            if (controlRefs.textContentInput) {
                controlRefs.textContentInput.value = textMode === 'plain'
                    ? (payload.text || '')
                    : (payload.html || payload.text || '');
            }
            if (controlRefs.textColorValue) {
                const textColor = normalizeColor(styles.color || '');
                controlRefs.textColorValue.textContent = textColor || '#111111';
                if (controlRefs.textColorInput && textColor.startsWith('#')) {
                    controlRefs.textColorInput.value = textColor;
                }
            }
            if (controlRefs.bgColorValue) {
                const bgColor = normalizeColor(styles.backgroundColor || '');
                const transparent = isTransparentColor(styles.backgroundColor || bgColor);
                if (controlRefs.bgColorInput && bgColor.startsWith('#')) {
                    controlRefs.bgColorInput.value = bgColor;
                }
                setBackgroundControlState(
                    controlRefs.bgColorInput?.value || bgColor || '#000000',
                    transparent
                );
            }
            if (controlRefs.radiusInput) {
                controlRefs.radiusInput.value = styles.borderRadius || '0px';
            }
            if (controlRefs.layoutControls) {
                const gridCols = (styles.gridTemplateColumns || '').trim();
                const cols = gridCols ? gridCols.split(' ').length : '';
                if (controlRefs.gridColsInput) {
                    controlRefs.gridColsInput.value = cols || '';
                }
                if (controlRefs.gridRowsInput) {
                    controlRefs.gridRowsInput.value = (styles.gridTemplateRows || '').replace(/repeat\((\d+),.+\)/i, '$1') || '';
                }
                if (controlRefs.gridGapInput) {
                    controlRefs.gridGapInput.value = formatSpacingValue(styles.gap || '');
                }
                if (controlRefs.gridFlowInput && styles.gridAutoFlow) {
                    controlRefs.gridFlowInput.value = styles.gridAutoFlow;
                }
            }
            if (controlRefs.mapControls) {
                const src = attrs.src || '';
                const match = src.match(/q=([^&]+)/);
                const zoomMatch = src.match(/z=(\d+)/);
                if (controlRefs.mapLocationInput) {
                    controlRefs.mapLocationInput.value = match ? decodeURIComponent(match[1].replace(/\+/g, ' ')) : '';
                }
                if (controlRefs.mapZoomInput) {
                    controlRefs.mapZoomInput.value = zoomMatch ? zoomMatch[1] : '12';
                }
            }
            if (controlRefs.fieldControls && controlRefs.fieldPlaceholderInput) {
                controlRefs.fieldPlaceholderInput.value = attrs.placeholder || '';
            }
            if (controlRefs.pricingControls) {
                const node = getSelectedElementNode();
                if (node && node.getAttribute('data-bugence-type') === 'pricing') {
                    const parts = node.querySelectorAll('strong, div');
                    if (controlRefs.pricingTitleInput) {
                        controlRefs.pricingTitleInput.value = node.querySelector('strong')?.textContent || '';
                    }
                    if (controlRefs.pricingPriceInput) {
                        controlRefs.pricingPriceInput.value = node.querySelector('div')?.textContent || '';
                    }
                    if (controlRefs.pricingDescInput) {
                        controlRefs.pricingDescInput.value = node.querySelectorAll('div')[1]?.textContent || '';
                    }
                }
            }
            if (controlRefs.mediaUrlInput) {
                const tag = (payload.tagName || '').toLowerCase();
                if (tag === 'img') {
                    controlRefs.mediaUrlInput.value = attrs.src || '';
                } else if (tag === 'video') {
                    const node = getSelectedElementNode();
                    const source = node?.querySelector?.('source');
                    controlRefs.mediaUrlInput.value = attrs.src || source?.getAttribute('src') || '';
                } else if (tag === 'source') {
                    controlRefs.mediaUrlInput.value = attrs.src || '';
                } else {
                    controlRefs.mediaUrlInput.value = '';
                }
            }
            if (controlRefs.contentControls) {
                const node = getSelectedElementNode();
                const contentType = node?.getAttribute?.('data-bugence-type') || '';
                if (['posts', 'loop-grid', 'portfolio', 'team'].includes(contentType)) {
                    const items = Number(node.getAttribute('data-bugence-items') || node.children.length || 0);
                    const cols = Number(node.getAttribute('data-bugence-cols') || (styles.gridTemplateColumns || '').split(' ').length || 0);
                    if (controlRefs.contentItemsInput) {
                        controlRefs.contentItemsInput.value = items ? String(items) : '6';
                    }
                    if (controlRefs.contentColsInput) {
                        controlRefs.contentColsInput.value = cols ? String(cols) : '3';
                    }
                    if (controlRefs.contentLayoutInput) {
                        controlRefs.contentLayoutInput.value = node.getAttribute('data-bugence-layout') || 'cards';
                    }
                }
            }
            if (controlRefs.widgetControls) {
                const node = getSelectedElementNode();
                const type = node?.getAttribute?.('data-bugence-type') || '';
                if (['menu', 'breadcrumbs', 'pagination', 'social-icons', 'share', 'reviews', 'timeline', 'counter', 'progress', 'table', 'embed', 'lottie', 'youtube', 'vimeo', 'product-grid', 'icon', 'icon-box', 'image-box', 'carousel', 'gallery', 'map'].includes(type)) {
                    const items = type === 'carousel'
                        ? (node.querySelector('[data-bugence-carousel-track]')?.children.length || node.children.length || 0)
                        : type === 'gallery'
                            ? node.querySelectorAll('img').length
                            : Number(node.getAttribute('data-bugence-items') || node.children.length || 0);
                    const cols = type === 'gallery'
                        ? (styles.gridTemplateColumns || '').split(' ').length
                        : Number(node.getAttribute('data-bugence-cols') || (styles.gridTemplateColumns || '').split(' ').length || 0);
                    const value = node.getAttribute('data-bugence-value') || '';
                    if (controlRefs.widgetItemsInput) {
                        controlRefs.widgetItemsInput.value = items ? String(items) : '4';
                    }
                    if (controlRefs.widgetColsInput) {
                        controlRefs.widgetColsInput.value = cols ? String(cols) : '3';
                    }
                    if (controlRefs.widgetValueInput) {
                        controlRefs.widgetValueInput.value = value || (type === 'progress' ? '75' : type === 'counter' ? '120' : type === 'icon' ? 'fa-solid fa-star' : '5');
                    }
                    if (controlRefs.widgetEmbedInput) {
                        const embedValue = safeUrlValue(node.getAttribute('data-bugence-embed') || node.getAttribute('src') || '');
                        controlRefs.widgetEmbedInput.value = embedValue;
                    }
                }
            }
            if (controlRefs.tabsContentControls) {
                const tabs = getTabsRootFromSelection();
                if (tabs) {
                    updateTabsContentInputs(tabs);
                }
            }
            if (controlRefs.marginYInput) {
                const marginY = styles.marginTop === styles.marginBottom ? styles.marginTop : styles.marginTop || '';
                controlRefs.marginYInput.value = formatSpacingValue(marginY);
            }
            if (controlRefs.marginXInput) {
                const marginX = styles.marginLeft === styles.marginRight ? styles.marginLeft : styles.marginLeft || '';
                controlRefs.marginXInput.value = formatSpacingValue(marginX);
            }
            if (controlRefs.paddingYInput) {
                const paddingY = styles.paddingTop === styles.paddingBottom ? styles.paddingTop : styles.paddingTop || '';
                controlRefs.paddingYInput.value = formatSpacingValue(paddingY);
            }
            if (controlRefs.paddingXInput) {
                const paddingX = styles.paddingLeft === styles.paddingRight ? styles.paddingLeft : styles.paddingLeft || '';
                controlRefs.paddingXInput.value = formatSpacingValue(paddingX);
            }
            const align = (styles.textAlign || '').toLowerCase();
            if (controlRefs.alignBadges.length) {
                setActiveGroup(controlRefs.alignBadges, align, 'data-align');
            }
            const display = (styles.display || '').toLowerCase();
            if (controlRefs.layoutPills.length) {
                setActiveGroup(controlRefs.layoutPills, display, 'data-layout');
            }
            if (controlRefs.textModeBadges.length) {
                setActiveGroup(controlRefs.textModeBadges, textMode, 'data-textmode');
            }
            if (controlRefs.selectionTag) {
                controlRefs.selectionTag.textContent = payload.tagName ? `<${payload.tagName}>` : 'None';
            }
            if (controlRefs.selectionSummary) {
                const id = payload.id ? `#${payload.id}` : '';
                const className = payload.className ? `.${payload.className.toString().trim().split(/\\s+/).slice(0, 2).join('.')}` : '';
                controlRefs.selectionSummary.textContent = payload.tagName ? `${id}${className}` || 'Element' : 'Select an element';
            }
            if (controlRefs.selectionSelector) {
                controlRefs.selectionSelector.textContent = payload.selector || '';
            }
            isSyncingControls = false;
        };

        const sendUpdate = (payload) => {
            if (!editorBridge.ready || !editorBridge.selection) return;
            if (payload?.styles && Object.keys(payload.styles).length) {
                markEdit('style');
            }
            if ((typeof payload?.text === 'string' || typeof payload?.html === 'string') && !payload?.attributes) {
                markEdit('text');
            }
            if (payload?.attributes && Object.keys(payload.attributes).length) {
                markEdit('structural');
            }
            sendToIframe('bugence-editor:update', payload);
        };

        const applyTextUpdate = (nextText) => {
            if (!editorBridge.selection) {
                showToast('Select a text element first.');
                return false;
            }
            if (controlRefs.textContentInput?.disabled) {
                showToast('Text editing is not available for this element.');
                return false;
            }
            const value = (nextText || '').trim();
            if (textMode === 'plain') {
                sendUpdate({ text: value });
            } else {
                sendUpdate({ html: value });
            }
            if (controlRefs.textContentInput) {
                controlRefs.textContentInput.value = value;
            }
            scheduleAutoSave();
            scheduleHistorySnapshot();
            return true;
        };

        const isEditableTag = (tag) => {
            return ['p', 'span', 'strong', 'em', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'a', 'button', 'li'].includes(tag);
        };

        const resolveEditableSelection = () => {
            const doc = getCanvasDocument();
            const selected = getSelectedElementNode();
            if (!doc || !selected) return null;
            const tag = selected.tagName?.toLowerCase() || '';
            if (isEditableTag(tag) || selected.isContentEditable) {
                return selected;
            }
            const candidate = selected.querySelector?.('h1,h2,h3,h4,h5,h6,p,span,button,a,li,[contenteditable="true"]');
            if (!candidate) return null;
            const id = ensureBugenceId(candidate);
            if (id) {
                sendToIframe('bugence-editor:select', { selector: `[data-bugence-id="${id}"]` });
                return candidate;
            }
            return null;
        };

        const normalizeCopy = (text) => (text || '').replace(/\s+/g, ' ').trim();
        const toTitleCase = (text) => normalizeCopy(text).replace(/\w\S*/g, (word) => {
            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        });
        const toBullets = (text) => {
            const trimmed = normalizeCopy(text);
            if (!trimmed) return '';
            const parts = trimmed.split(/[.!?]\s+/).filter(Boolean);
            if (!parts.length) return trimmed;
            return parts.map(part => `- ${part.trim()}`).join('\n');
        };

        const applyLocalAiTransform = (action, source) => {
            let result = source;
            if (action === 'improve') {
                result = normalizeCopy(source);
                if (result && !/[.!?]$/.test(result)) {
                    result += '.';
                }
            } else if (action === 'shorten') {
                const trimmed = normalizeCopy(source);
                if (trimmed.length > 140) {
                    result = trimmed.slice(0, 140).replace(/\s+\S*$/, '');
                    result = `${result}...`;
                } else {
                    result = trimmed;
                }
            } else if (action === 'expand') {
                const trimmed = normalizeCopy(source);
                result = trimmed;
                if (result && !/[.!?]$/.test(result)) {
                    result += '.';
                }
                result += ' Add a supporting detail that reinforces the main idea.';
            } else if (action === 'title') {
                result = toTitleCase(source);
            } else if (action === 'bullets') {
                result = toBullets(source);
            }
            return result;
        };

        const sanitizeAiOutput = (value) => {
            if (!value) return '';
            let output = value.trim();
            output = output.replace(/^```[a-z]*\n?/i, '').replace(/```$/, '').trim();
            return output;
        };

        const setAiBusy = (busy) => {
            aiBusy = busy;
            document.querySelectorAll('[data-ai-action]').forEach(btn => {
                if (btn.getAttribute('data-ai-action') === 'clear') return;
                btn.disabled = busy;
                btn.classList.toggle('is-loading', busy);
            });
        };

        const getAiContextSnippet = () => {
            const doc = getCanvasDocument();
            const selected = resolveEditableSelection() || getSelectedElementNode();
            if (!doc || !selected) return '';
            const section = selected.closest?.('section') || selected.closest?.('[data-bugence-type="section"]') || selected.parentElement;
            const text = (section?.innerText || selected.innerText || '').trim();
            return text.slice(0, 1200);
        };

        const requestAiAssist = async (action, prompt, selection) => {
            if (!projectId) throw new Error('AI unavailable');
            const response = await fetch(`/Editor?handler=AiAssist&projectId=${projectId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': csrfToken
                },
                body: JSON.stringify({
                    action,
                    prompt,
                    selection,
                    context: getAiContextSnippet()
                })
            });
            const data = await response.json().catch(() => ({}));
            if (!response.ok || !data?.success) {
                throw new Error(data?.message || 'AI request failed');
            }
            return sanitizeAiOutput(data.output || '');
        };

        const handleAiAction = async (action) => {
            const prompt = controlRefs.aiPromptInput?.value?.trim() || '';
            const selectionText = controlRefs.textContentInput?.value?.trim() || '';
            const source = prompt || selectionText;
            if (!source) {
                showToast('Enter a prompt or select text to transform.');
                return;
            }
            if (action === 'clear') {
                if (controlRefs.aiPromptInput) controlRefs.aiPromptInput.value = '';
                return;
            }
            if (aiBusy) return;
            setAiBusy(true);
            try {
                const output = await requestAiAssist(action, prompt, selectionText);
                const result = output || applyLocalAiTransform(action, source);
                if (controlRefs.textContentInput?.disabled) {
                    const resolved = resolveEditableSelection();
                    if (!resolved) {
                        showToast('Select a text element to apply this change.');
                        return;
                    }
                    setTimeout(() => applyTextUpdate(result), 80);
                } else {
                    applyTextUpdate(result);
                }
                showToast('AI updated the text.');
            } catch {
                const fallback = applyLocalAiTransform(action, source);
                if (controlRefs.textContentInput?.disabled) {
                    const resolved = resolveEditableSelection();
                    if (!resolved) {
                        showToast('Select a text element to apply this change.');
                        return;
                    }
                    setTimeout(() => applyTextUpdate(fallback), 80);
                } else {
                    applyTextUpdate(fallback);
                }
                showToast('AI unavailable. Applied local refinement.');
            } finally {
                setAiBusy(false);
            }
        };

        const runCanvasSearch = (query) => {
            if (!controlRefs.canvasSearchResults) return;
            const doc = getCanvasDocument();
            if (!doc?.body) return;
            const term = (query || '').trim().toLowerCase();
            const cleanTerm = term.replace(/[<>]/g, '');
            controlRefs.canvasSearchResults.innerHTML = '';
            if (!cleanTerm) return;
            const results = [];
            const nodes = Array.from(doc.body.querySelectorAll('*')).filter(node =>
                node.nodeType === 1 && !node.closest?.('[data-bugence-editor="true"]')
            );
            nodes.forEach(node => {
                const tag = node.tagName.toLowerCase();
                const text = (node.textContent || '').trim().toLowerCase();
                if (tag === cleanTerm || text.includes(cleanTerm)) {
                    results.push(node);
                }
            });
            results.slice(0, 12).forEach(node => {
                const id = ensureBugenceId(node);
                const item = document.createElement('div');
                item.className = 'utility-item';
                const textSnippet = (node.textContent || '').trim().slice(0, 60);
                item.textContent = `<${node.tagName.toLowerCase()}> ${textSnippet}`;
                const meta = document.createElement('small');
                meta.textContent = id ? id.slice(-6) : '';
                item.appendChild(meta);
                item.addEventListener('click', () => {
                    sendToIframe('bugence-editor:select', { selector: `[data-bugence-id="${id}"]` });
                    node.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
                controlRefs.canvasSearchResults.appendChild(item);
            });
            if (!results.length) {
                controlRefs.canvasSearchResults.innerHTML = '<div class="hint-text">No matches found.</div>';
            }
        };

        const applyStyleAction = (action) => {
            const selected = getSelectedElementNode();
            if (!editorBridge.selection || !selected) {
                showToast('Select an element to style.');
                return;
            }
            if (!liveCanvasEnabled) {
                setLiveCanvasEnabled(true);
            }
            const tag = selected.tagName ? selected.tagName.toLowerCase() : '';
            const isText = ['p', 'span', 'strong', 'em', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'a', 'label'].includes(tag) || !selected.children.length;
            const styles = {};
            if (action === 'accent') {
                styles.boxShadow = '0 18px 36px rgba(6,182,212,0.35)';
                styles.outline = '1px solid rgba(6,182,212,0.35)';
                if (isText) {
                    styles.textShadow = '0 6px 18px rgba(6,182,212,0.35)';
                }
            } else if (action === 'soft-shadow') {
                styles.boxShadow = '0 16px 30px rgba(15,23,42,0.2)';
                if (isText) {
                    styles.textShadow = '0 4px 12px rgba(15,23,42,0.25)';
                }
            } else if (action === 'reset') {
                styles.boxShadow = '';
                styles.outline = '';
                styles.textShadow = '';
            }
            sendUpdate({ styles });
            scheduleAutoSave();
            scheduleHistorySnapshot();
        };

        const initSettingsTabs = () => {
            const tabs = Array.from(document.querySelectorAll('[data-settings-tab]'));
            const panes = Array.from(document.querySelectorAll('[data-settings-pane]'));
            if (!tabs.length || !panes.length) return;
            const setActive = (name) => {
                tabs.forEach(tab => tab.classList.toggle('is-active', tab.getAttribute('data-settings-tab') === name));
                panes.forEach(pane => pane.classList.toggle('is-active', pane.getAttribute('data-settings-pane') === name));
            };
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const name = tab.getAttribute('data-settings-tab');
                    if (name) setActive(name);
                });
            });
            setActive('prefs');
        };

        const editorThemePresets = [
            {
                id: 'noir',
                label: 'Noir',
                vars: {
                    '--bg': '#050505',
                    '--bg-panel': '#0d0d0d',
                    '--bg-card': '#161616',
                    '--border': '#2a2a2a',
                    '--text': '#f8f8f8',
                    '--muted': '#a3a3a3',
                    '--accent': '#ffffff',
                    '--accent-2': '#ffffff'
                }
            },
            {
                id: 'slate',
                label: 'Slate',
                vars: {
                    '--bg': '#0b0f16',
                    '--bg-panel': '#121826',
                    '--bg-card': '#1b2233',
                    '--border': '#253044',
                    '--text': '#f8fafc',
                    '--muted': '#9ca3af',
                    '--accent': '#38bdf8',
                    '--accent-2': '#a78bfa'
                }
            },
            {
                id: 'pearl',
                label: 'Pearl',
                vars: {
                    '--bg': '#f7f7f5',
                    '--bg-panel': '#ffffff',
                    '--bg-card': '#f1f3f6',
                    '--border': '#d6dae1',
                    '--text': '#0f172a',
                    '--muted': '#475569',
                    '--accent': '#2563eb',
                    '--accent-2': '#0f766e'
                }
            },
            {
                id: 'emerald',
                label: 'Emerald',
                vars: {
                    '--bg': '#04130c',
                    '--bg-panel': '#0a1e16',
                    '--bg-card': '#0f2a1e',
                    '--border': '#1c3a2b',
                    '--text': '#e7fff3',
                    '--muted': '#9bd3b8',
                    '--accent': '#34d399',
                    '--accent-2': '#22c55e'
                }
            },
            {
                id: 'ruby',
                label: 'Red',
                vars: {
                    '--bg': '#120606',
                    '--bg-panel': '#1a0b0b',
                    '--bg-card': '#231010',
                    '--border': '#3a1a1a',
                    '--text': '#fff5f5',
                    '--muted': '#f0b4b4',
                    '--accent': '#ef4444',
                    '--accent-2': '#f97316'
                }
            },
            {
                id: 'mint',
                label: 'Light Green',
                vars: {
                    '--bg': '#f3fbf6',
                    '--bg-panel': '#ffffff',
                    '--bg-card': '#e8f4ee',
                    '--border': '#cfe3d7',
                    '--text': '#0a2f17',
                    '--muted': '#4d7a5a',
                    '--accent': '#22c55e',
                    '--accent-2': '#16a34a'
                }
            },
            {
                id: 'sky',
                label: 'Light Blue',
                vars: {
                    '--bg': '#f4f8ff',
                    '--bg-panel': '#ffffff',
                    '--bg-card': '#eaf1ff',
                    '--border': '#cfd8f0',
                    '--text': '#0f172a',
                    '--muted': '#5472a1',
                    '--accent': '#3b82f6',
                    '--accent-2': '#38bdf8'
                }
            },
            {
                id: 'sunset',
                label: 'Sunset Gold',
                vars: {
                    '--bg': '#0b0804',
                    '--bg-panel': '#14100a',
                    '--bg-card': '#1c160c',
                    '--border': '#2f2516',
                    '--text': '#fff6e1',
                    '--muted': '#d5b58c',
                    '--accent': '#f59e0b',
                    '--accent-2': '#f97316'
                }
            },
            {
                id: 'neon',
                label: 'Neon Blue',
                vars: {
                    '--bg': '#05080f',
                    '--bg-panel': '#0a1322',
                    '--bg-card': '#111c2e',
                    '--border': '#1f2c46',
                    '--text': '#e6f4ff',
                    '--muted': '#8aa4c2',
                    '--accent': '#22d3ee',
                    '--accent-2': '#3b82f6'
                }
            }
        ];

        const getEditorThemeDefaults = () => {
            const styles = getComputedStyle(document.documentElement);
            return {
                '--bg': normalizeColor(styles.getPropertyValue('--bg').trim()) || '#050505',
                '--bg-panel': normalizeColor(styles.getPropertyValue('--bg-panel').trim()) || '#0d0d0d',
                '--bg-card': normalizeColor(styles.getPropertyValue('--bg-card').trim()) || '#161616',
                '--border': normalizeColor(styles.getPropertyValue('--border').trim()) || '#2a2a2a',
                '--text': normalizeColor(styles.getPropertyValue('--text').trim()) || '#f8f8f8',
                '--muted': normalizeColor(styles.getPropertyValue('--muted').trim()) || '#a3a3a3',
                '--accent': normalizeColor(styles.getPropertyValue('--accent').trim()) || '#ffffff',
                '--accent-2': normalizeColor(styles.getPropertyValue('--accent-2').trim()) || '#ffffff'
            };
        };

        const setEditorThemeVars = (vars) => {
            const root = document.documentElement.style;
            const nextVars = ensureThemeContrast({ ...(vars || {}) });
            if (!nextVars['--bg-soft']) {
                const fallback = nextVars['--bg-panel'] || nextVars['--bg'] || getComputedStyle(document.documentElement).getPropertyValue('--bg-soft').trim() || '#0d0d0d';
                nextVars['--bg-soft'] = normalizeColor(fallback) || fallback;
            }
            Object.entries(nextVars).forEach(([key, value]) => {
                if (value) root.setProperty(key, value);
            });
        };

        const syncEditorThemeInputs = (vars) => {
            if (!vars) return;
            const map = [
                { key: '--bg', input: controlRefs.editorThemeBg, value: controlRefs.editorThemeBgValue },
                { key: '--bg-panel', input: controlRefs.editorThemePanel, value: controlRefs.editorThemePanelValue },
                { key: '--bg-card', input: controlRefs.editorThemeCard, value: controlRefs.editorThemeCardValue },
                { key: '--border', input: controlRefs.editorThemeBorder, value: controlRefs.editorThemeBorderValue },
                { key: '--text', input: controlRefs.editorThemeText, value: controlRefs.editorThemeTextValue },
                { key: '--muted', input: controlRefs.editorThemeMuted, value: controlRefs.editorThemeMutedValue },
                { key: '--accent', input: controlRefs.editorThemeAccent, value: controlRefs.editorThemeAccentValue },
                { key: '--accent-2', input: controlRefs.editorThemeAccent2, value: controlRefs.editorThemeAccent2Value }
            ];
            map.forEach(item => {
                const next = normalizeColor(vars[item.key] || '');
                if (!next) return;
                if (item.input) item.input.value = next;
                if (item.value) item.value.textContent = next;
            });
        };

        const setActiveThemeCard = (id) => {
            document.querySelectorAll('[data-theme-id]').forEach(card => {
                card.classList.toggle('is-active', card.getAttribute('data-theme-id') === id);
            });
        };

        const saveEditorThemeState = (id, vars) => {
            localStorage.setItem('bugence-editor-theme', JSON.stringify({ id, vars }));
            queueEditorPrefsSave();
        };

        const loadCustomEditorThemes = () => {
            try {
                const raw = localStorage.getItem('bugence-editor-custom-themes');
                return raw ? JSON.parse(raw) : [];
            } catch {
                return [];
            }
        };

        const saveCustomEditorThemes = (themes) => {
            localStorage.setItem('bugence-editor-custom-themes', JSON.stringify(themes));
            queueEditorPrefsSave();
        };

        const createCustomTheme = (name) => {
            const trimmed = (name || '').trim();
            if (!trimmed) {
                showToast('Name your theme to save it.');
                return;
            }
            const vars = getEditorThemeDefaults();
            const id = `custom-${Date.now()}`;
            const themes = loadCustomEditorThemes();
            themes.push({ id, label: trimmed, vars });
            saveCustomEditorThemes(themes);
            renderEditorThemeCards();
            applyEditorTheme(id, vars);
            if (controlRefs.customThemeName) controlRefs.customThemeName.value = '';
            showToast('Theme saved.');
        };

        const applyEditorTheme = (id, vars) => {
            setEditorThemeVars(vars);
            syncEditorThemeInputs(vars);
            setActiveThemeCard(id);
            saveEditorThemeState(id, vars);
            if (id === 'custom') {
                const card = document.querySelector('[data-theme-id="custom"] .theme-swatch');
                if (card) {
                    const swatches = card.querySelectorAll('span');
                    if (swatches[0]) swatches[0].style.background = vars['--bg'];
                    if (swatches[1]) swatches[1].style.background = vars['--bg-panel'];
                    if (swatches[2]) swatches[2].style.background = vars['--accent'];
                }
            }
        };

        const renderEditorThemeCards = () => {
            if (!controlRefs.editorThemeGrid) return;
            controlRefs.editorThemeGrid.innerHTML = '';
            const customThemes = loadCustomEditorThemes();
            const presets = [
                ...editorThemePresets,
                ...customThemes,
                { id: 'custom', label: 'Custom', vars: getEditorThemeDefaults() }
            ];
            presets.forEach(theme => {
                const card = document.createElement('div');
                card.className = 'theme-card';
                card.setAttribute('data-theme-id', theme.id);
                card.innerHTML = `
                    <div class="theme-swatch">
                        <span style="background:${theme.vars['--bg']};"></span>
                        <span style="background:${theme.vars['--bg-panel']};"></span>
                        <span style="background:${theme.vars['--accent']};"></span>
                    </div>
                    <div class="theme-label">${theme.label}</div>
                `;
                card.addEventListener('click', () => {
                    if (theme.id === 'custom') {
                        const vars = getEditorThemeDefaults();
                        applyEditorTheme('custom', vars);
                        return;
                    }
                    applyEditorTheme(theme.id, theme.vars);
                });
                controlRefs.editorThemeGrid.appendChild(card);
            });
        };

        const loadEditorTheme = () => {
            const raw = localStorage.getItem('bugence-editor-theme');
            if (!raw) {
                const fallback = editorThemePresets[0];
                applyEditorTheme(fallback.id, fallback.vars);
                return;
            }
            try {
                const saved = JSON.parse(raw);
                if (saved?.vars) {
                    applyEditorTheme(saved.id || 'custom', saved.vars);
                }
            } catch {
                const fallback = editorThemePresets[0];
                applyEditorTheme(fallback.id, fallback.vars);
            }
        };

        const bindEditorThemeInputs = () => {
            const map = [
                { key: '--bg', input: controlRefs.editorThemeBg, value: controlRefs.editorThemeBgValue },
                { key: '--bg-panel', input: controlRefs.editorThemePanel, value: controlRefs.editorThemePanelValue },
                { key: '--bg-card', input: controlRefs.editorThemeCard, value: controlRefs.editorThemeCardValue },
                { key: '--border', input: controlRefs.editorThemeBorder, value: controlRefs.editorThemeBorderValue },
                { key: '--text', input: controlRefs.editorThemeText, value: controlRefs.editorThemeTextValue },
                { key: '--muted', input: controlRefs.editorThemeMuted, value: controlRefs.editorThemeMutedValue },
                { key: '--accent', input: controlRefs.editorThemeAccent, value: controlRefs.editorThemeAccentValue },
                { key: '--accent-2', input: controlRefs.editorThemeAccent2, value: controlRefs.editorThemeAccent2Value }
            ];
            map.forEach(item => {
                if (!item.input) return;
                item.input.addEventListener('input', () => {
                    const value = item.input.value;
                    document.documentElement.style.setProperty(item.key, value);
                    if (item.value) item.value.textContent = value;
                    setActiveThemeCard('custom');
                    saveEditorThemeState('custom', getEditorThemeDefaults());
                });
            });
        };

        const openVariantModal = (type, dropTarget, dropPosition) => {
            if (!controlRefs.variantModal || !controlRefs.variantGrid) return;
            pendingVariantInsert = {
                type,
                dropTargetId: dropTarget ? ensureBugenceId(dropTarget) : null,
                dropPosition: dropPosition || 'after'
            };
            const titleMap = {
                button: 'Pick a Button Style',
                heading: 'Pick a Heading Style',
                section: 'Pick a Section Layout',
                container: 'Pick a Container Style',
                grid: 'Pick a Grid Layout',
                columns: 'Pick a Columns Layout',
                text: 'Pick a Text Style',
                form: 'Pick a Form Layout',
                'image-card': 'Pick an Image Card Style'
            };
            if (controlRefs.variantTitle) {
                controlRefs.variantTitle.textContent = titleMap[type] || 'Choose a Style';
            }
            renderVariantOptions(type);
            controlRefs.variantModal.classList.add('active');
        };

        const closeVariantModal = () => {
            controlRefs.variantModal?.classList.remove('active');
            pendingVariantInsert = null;
        };

        const getVariantOptions = (type) => {
            if (type === 'button') {
                return [
                    { id: 'primary', label: 'Primary', desc: 'Bold gradient' },
                    { id: 'outline', label: 'Outline', desc: 'Clean border' },
                    { id: 'soft', label: 'Soft', desc: 'Muted fill' },
                    { id: 'pill', label: 'Pill', desc: 'Rounded action' }
                ];
            }
            if (type === 'heading') {
                return [
                    { id: 'hero', label: 'Hero', desc: 'Large headline' },
                    { id: 'section', label: 'Section', desc: 'Section title' },
                    { id: 'eyebrow', label: 'Eyebrow', desc: 'Label text' }
                ];
            }
            if (type === 'section') {
                return [
                    { id: 'hero', label: 'Hero Shell', desc: 'Headline + body + CTA zone' },
                    { id: 'split', label: 'Split Content', desc: 'Two-column content shell' },
                    { id: 'feature', label: 'Feature Block', desc: 'Title with cards row' }
                ];
            }
            if (type === 'container') {
                return [
                    { id: 'card', label: 'Card', desc: 'Elevated glass card' },
                    { id: 'outlined', label: 'Outlined', desc: 'Minimal bordered box' },
                    { id: 'soft', label: 'Soft', desc: 'Muted background wrapper' }
                ];
            }
            if (type === 'grid') {
                return [
                    { id: 'stats-3', label: 'Stats 3-Up', desc: 'Three metric cards' },
                    { id: 'cards-4', label: 'Cards 4-Up', desc: 'Four content cards' },
                    { id: 'masonry', label: 'Masonry Mix', desc: 'Staggered card rhythm' }
                ];
            }
            if (type === 'columns') {
                return [
                    { id: 'two-equal', label: '2 Equal', desc: 'Balanced two-column' },
                    { id: 'sidebar-left', label: 'Sidebar Left', desc: '30/70 sidebar layout' },
                    { id: 'sidebar-right', label: 'Sidebar Right', desc: '70/30 sidebar layout' }
                ];
            }
            if (type === 'text') {
                return [
                    { id: 'body', label: 'Body', desc: 'Readable paragraph' },
                    { id: 'lead', label: 'Lead', desc: 'Intro paragraph style' },
                    { id: 'caption', label: 'Caption', desc: 'Small supporting text' }
                ];
            }
            if (type === 'form') {
                return [
                    { id: 'contact', label: 'Contact', desc: 'Name + email + message' },
                    { id: 'newsletter', label: 'Newsletter', desc: 'Inline email subscribe' },
                    { id: 'quote', label: 'Quote Request', desc: 'Multi-field intake form' }
                ];
            }
            if (type === 'image-card') {
                return [
                    { id: 'media-top', label: 'Media Top', desc: 'Image above text' },
                    { id: 'media-left', label: 'Media Left', desc: 'Horizontal card layout' },
                    { id: 'overlay', label: 'Overlay', desc: 'Text on image gradient' }
                ];
            }
            return [];
        };

        const buildVariantPreview = (type, variant) => {
            const preview = document.createElement('div');
            if (type === 'button') {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = variant.label;
                btn.style.border = 'none';
                btn.style.cursor = 'pointer';
                btn.style.padding = '8px 16px';
                btn.style.borderRadius = '12px';
                btn.style.fontWeight = '700';
                btn.style.fontSize = '0.8rem';
                if (variant.id === 'primary') {
                    btn.style.background = 'linear-gradient(135deg, #22d3ee, #3b82f6)';
                    btn.style.color = '#0b1120';
                    btn.style.boxShadow = '0 10px 20px rgba(34,211,238,0.25)';
                } else if (variant.id === 'outline') {
                    btn.style.background = 'transparent';
                    btn.style.color = '#e5e7eb';
                    btn.style.border = '1px solid rgba(255,255,255,0.3)';
                } else if (variant.id === 'pill') {
                    btn.style.background = '#22c55e';
                    btn.style.color = '#04210f';
                    btn.style.borderRadius = '999px';
                } else {
                    btn.style.background = 'rgba(255,255,255,0.1)';
                    btn.style.color = '#e5e7eb';
                    btn.style.border = '1px solid rgba(255,255,255,0.2)';
                }
                preview.appendChild(btn);
                return preview;
            }
            if (type === 'heading') {
                const text = document.createElement(variant.id === 'hero' ? 'h2' : variant.id === 'section' ? 'h4' : 'span');
                text.textContent = variant.label;
                text.style.margin = '0';
                if (variant.id === 'hero') {
                    text.style.fontSize = '1.4rem';
                    text.style.fontWeight = '700';
                } else if (variant.id === 'section') {
                    text.style.fontSize = '1rem';
                    text.style.fontWeight = '600';
                } else {
                    text.style.fontSize = '0.7rem';
                    text.style.letterSpacing = '0.2em';
                    text.style.textTransform = 'uppercase';
                    text.style.opacity = '0.7';
                }
                preview.appendChild(text);
                return preview;
            }
            if (type === 'section') {
                preview.innerHTML = `<div style="padding:10px;border:1px dashed rgba(255,255,255,0.3);border-radius:10px;display:grid;gap:6px;"><div style="height:8px;width:${variant.id === 'split' ? '55%' : '70%'};background:rgba(255,255,255,0.8);border-radius:999px;"></div><div style="height:6px;width:90%;background:rgba(255,255,255,0.35);border-radius:999px;"></div><div style="height:6px;width:${variant.id === 'feature' ? '78%' : '84%'};background:rgba(255,255,255,0.25);border-radius:999px;"></div></div>`;
                return preview;
            }
            if (type === 'container' || type === 'image-card') {
                preview.innerHTML = `<div style="height:70px;border-radius:10px;border:1px solid rgba(255,255,255,0.22);background:${type === 'image-card' ? 'linear-gradient(135deg, rgba(148,163,184,0.35), rgba(59,130,246,0.35))' : 'rgba(255,255,255,0.08)'};"></div>`;
                return preview;
            }
            if (type === 'grid' || type === 'columns') {
                preview.innerHTML = `<div style="display:grid;grid-template-columns:${type === 'columns' ? '1fr 1fr' : '1fr 1fr 1fr'};gap:6px;">${new Array(type === 'columns' ? 2 : 3).fill(0).map(() => '<span style="height:28px;border:1px dashed rgba(255,255,255,0.3);border-radius:8px;display:block;"></span>').join('')}</div>`;
                return preview;
            }
            if (type === 'text') {
                preview.innerHTML = `<div style="display:grid;gap:5px;"><span style="height:7px;width:95%;background:rgba(255,255,255,0.35);border-radius:999px;"></span><span style="height:7px;width:88%;background:rgba(255,255,255,0.25);border-radius:999px;"></span><span style="height:7px;width:66%;background:rgba(255,255,255,0.2);border-radius:999px;"></span></div>`;
                return preview;
            }
            if (type === 'form') {
                preview.innerHTML = `<div style="display:grid;gap:6px;"><span style="height:20px;border:1px solid rgba(255,255,255,0.3);border-radius:6px;display:block;"></span><span style="height:20px;border:1px solid rgba(255,255,255,0.3);border-radius:6px;display:block;"></span><span style="height:22px;border-radius:6px;display:block;background:rgba(34,211,238,0.35);"></span></div>`;
                return preview;
            }
            return preview;
        };

        const renderVariantOptions = (type) => {
            if (!controlRefs.variantGrid) return;
            controlRefs.variantGrid.innerHTML = '';
            const options = getVariantOptions(type);
            options.forEach(option => {
                const card = document.createElement('div');
                card.className = 'variant-card';
                const preview = document.createElement('div');
                preview.className = 'variant-preview';
                preview.appendChild(buildVariantPreview(type, option));
                const meta = document.createElement('div');
                meta.className = 'variant-meta';
                meta.innerHTML = `<strong>${option.label}</strong><span>${option.desc}</span>`;
                card.appendChild(preview);
                card.appendChild(meta);
                card.addEventListener('click', () => {
                    const payload = pendingVariantInsert || {};
                    const doc = getCanvasDocument();
                    const target = payload.dropTargetId ? doc?.querySelector(`[data-bugence-id="${payload.dropTargetId}"]`) : null;
                    insertElementFromPalette(type, target, payload.dropPosition || 'after', { variantId: option.id });
                    closeVariantModal();
                });
                controlRefs.variantGrid.appendChild(card);
            });
        };

        window.addEventListener('message', (event) => {
            const data = event.data || {};
            if (data.source !== 'bugence-editor-iframe') return;
            if (data.type === 'bugence-editor:ready') {
                editorBridge.ready = true;
            }
            if (data.type === 'bugence-editor:preview-error') {
                const payload = data.payload || {};
                if (localStorage.getItem('bugence-preview-errors') === '1') {
                    console.warn(
                        `[Bugence Preview Error] ${payload.message || 'Unknown error'} @@ ${payload.filename || 'inline'}:${payload.lineno || 0}:${payload.colno || 0}`
                    );
                }
            }
            if (data.type === 'bugence-editor:select') {
                editorBridge.selection = data.payload || null;
                window.__bugenceEditorSelection = editorBridge.selection;
                pendingHistory = null;
                const selectedEl = getSelectedElementNode();
                if (selectedEl) {
                    const id = ensureBugenceId(selectedEl);
                    if (id && editorBridge.selection?.attributes) {
                        editorBridge.selection.attributes['data-bugence-id'] = id;
                    }
                    lastSelectionHtml = selectedEl.outerHTML;
                }
                if (data.payload?.multiAction) {
                    const id = editorBridge.selection?.attributes?.['data-bugence-id'];
                    if (id) {
                        if (data.payload.multiAction === 'set') {
                            editorBridge.multiSelection = [id];
                        } else if (data.payload.multiAction === 'add') {
                            editorBridge.multiSelection = Array.from(new Set([...(editorBridge.multiSelection || []), id]));
                        } else if (data.payload.multiAction === 'toggle') {
                            if (editorBridge.multiSelection?.includes(id)) {
                                editorBridge.multiSelection = editorBridge.multiSelection.filter(item => item !== id);
                            } else {
                                editorBridge.multiSelection = Array.from(new Set([...(editorBridge.multiSelection || []), id]));
                            }
                        }
                    }
                } else {
                    const id = editorBridge.selection?.attributes?.['data-bugence-id'];
                    editorBridge.multiSelection = id ? [id] : [];
                }
                const nextSelectionId = editorBridge.selection?.attributes?.['data-bugence-id'] || null;
                if (nextSelectionId !== selectionOverlayLastId) {
                    selectionOverlayPinned = false;
                    selectionOverlayPinnedPos = null;
                    selectionOverlayDismissedId = null;
                    selectionOverlayLastId = nextSelectionId;
                }
                syncControlsFromSelection(editorBridge.selection);
                syncMotionControlsFromSelection();
                scheduleStructureUpdate();
                updateSelectionOverlay();
                updateMultiSelectionClasses();
            }
        });

        editorIframe?.addEventListener('load', () => {
            editorBridge.ready = false;
            sendToIframe('bugence-editor:ping');
        });

        const findByBugenceId = (doc, id) => {
            if (!doc || !id) return null;
            return doc.querySelector(`[data-bugence-id="${id}"]`);
        };

        const applyHistoryOp = (op, direction) => {
            const doc = getCanvasDocument();
            if (!doc || !op) return;
            isRestoringHistory = true;
            try {
                if (op.type === 'update') {
                    const target = findByBugenceId(doc, op.targetId);
                    if (!target) return;
                    const html = direction === 'undo' ? op.beforeHtml : op.afterHtml;
                    const temp = doc.createElement('div');
                    temp.innerHTML = html;
                    const next = temp.firstElementChild;
                    if (!next) return;
                    target.replaceWith(next);
                    lastSelectionHtml = next.outerHTML;
                    sendToIframe('bugence-editor:select', { selector: `[data-bugence-id="${op.targetId}"]` });
                } else if (op.type === 'insert') {
                    const parent = findByBugenceId(doc, op.parentId);
                    if (!parent) return;
                    if (direction === 'undo') {
                        const target = findByBugenceId(doc, op.targetId);
                        if (target) target.remove();
                    } else {
                        const temp = doc.createElement('div');
                        temp.innerHTML = op.html;
                        const node = temp.firstElementChild;
                        if (!node) return;
                        const children = parent.children;
                        if (op.index >= 0 && op.index < children.length) {
                            parent.insertBefore(node, children[op.index]);
                        } else {
                            parent.appendChild(node);
                        }
                        lastSelectionHtml = node.outerHTML;
                        sendToIframe('bugence-editor:select', { selector: `[data-bugence-id="${op.targetId}"]` });
                    }
                } else if (op.type === 'remove') {
                    const parent = findByBugenceId(doc, op.parentId);
                    if (!parent) return;
                    if (direction === 'undo') {
                        const temp = doc.createElement('div');
                        temp.innerHTML = op.html;
                        const node = temp.firstElementChild;
                        if (!node) return;
                        const children = parent.children;
                        if (op.index >= 0 && op.index < children.length) {
                            parent.insertBefore(node, children[op.index]);
                        } else {
                            parent.appendChild(node);
                        }
                        lastSelectionHtml = node.outerHTML;
                        sendToIframe('bugence-editor:select', { selector: `[data-bugence-id="${op.targetId}"]` });
                    } else {
                        const target = findByBugenceId(doc, op.targetId);
                        if (target) target.remove();
                    }
                } else if (op.type === 'move') {
                    const target = findByBugenceId(doc, op.targetId);
                    if (!target) return;
                    const fromParent = findByBugenceId(doc, op.fromParentId);
                    const toParent = findByBugenceId(doc, op.toParentId);
                    if (!fromParent || !toParent) return;
                    const applyMove = (parent, index) => {
                        const children = parent.children;
                        if (index >= 0 && index < children.length) {
                            parent.insertBefore(target, children[index]);
                        } else {
                            parent.appendChild(target);
                        }
                    };
                    if (direction === 'undo') {
                        applyMove(fromParent, op.fromIndex);
                    } else {
                        applyMove(toParent, op.toIndex);
                    }
                    sendToIframe('bugence-editor:select', { selector: `[data-bugence-id="${op.targetId}"]` });
                } else if (op.type === 'motion') {
                    const target = findByBugenceId(doc, op.targetId);
                    if (!target) return;
                    const payload = direction === 'undo' ? op.beforeMotion : op.afterMotion;
                    if (payload) {
                        target.setAttribute('data-bugence-motion', payload);
                        try {
                            const motion = JSON.parse(payload);
                            sendToIframe('bugence-editor:motion-update', {
                                selector: `[data-bugence-id="${op.targetId}"]`,
                                motion
                            });
                        } catch {
                            target.removeAttribute('data-bugence-motion');
                        }
                    } else {
                        target.removeAttribute('data-bugence-motion');
                    }
                    sendToIframe('bugence-editor:select', { selector: `[data-bugence-id="${op.targetId}"]` });
                }
            } finally {
                setTimeout(() => {
                    isRestoringHistory = false;
                }, 80);
            }
        };

        controlRefs.undoBtn?.addEventListener('click', async () => {
            if (historyIndex < 0) return;
            const op = historyOps[historyIndex];
            historyIndex -= 1;
            updateHistoryButtons();
            applyHistoryOp(op, 'undo');
        });

        controlRefs.redoBtn?.addEventListener('click', async () => {
            if (historyIndex >= historyOps.length - 1) return;
            historyIndex += 1;
            updateHistoryButtons();
            const op = historyOps[historyIndex];
            applyHistoryOp(op, 'redo');
        });

        document.addEventListener('keydown', (event) => {
            const target = event.target;
            const isEditable = target && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable);
            if (isEditable) return;
            const isModifier = event.ctrlKey || event.metaKey;
            if (!isModifier) return;
            if (event.key.toLowerCase() === 'z' && !event.shiftKey) {
                event.preventDefault();
                controlRefs.undoBtn?.click();
            } else if (event.key.toLowerCase() === 'y' || (event.key.toLowerCase() === 'z' && event.shiftKey)) {
                event.preventDefault();
                controlRefs.redoBtn?.click();
            } else if (event.key.toLowerCase() === 'd') {
                event.preventDefault();
                duplicateSelectedElement();
            }
        });

        controlRefs.linkUrlInput?.addEventListener('input', () => {
            if (isSyncingControls) return;
            sendUpdate({ attributes: { href: controlRefs.linkUrlInput.value.trim() } });
            scheduleAutoSave();
            scheduleHistorySnapshot();
        });

        controlRefs.workflowSelect?.addEventListener('change', () => {
            if (isSyncingControls) return;
            const value = controlRefs.workflowSelect.value || '';
            const attributes = value
                ? { 'data-bugence-workflow-id': value }
                : { 'data-bugence-workflow-id': '' };
            sendUpdate({ attributes });
            scheduleAutoSave();
            scheduleHistorySnapshot();
        });

        controlRefs.fontFamilyInput?.addEventListener('input', () => {
            if (isSyncingControls) return;
            isUserFontChange = true;
            const value = controlRefs.fontFamilyInput.value;
            updateRecentFonts(value);
            rebuildFontOptions(value);
            sendUpdate({ styles: { fontFamily: value } });
            scheduleAutoSave();
            scheduleHistorySnapshot();
            isUserFontChange = false;
        });
        controlRefs.fontFamilyInput?.addEventListener('change', () => {
            if (isSyncingControls) return;
            if (isUserFontChange) return;
            const value = controlRefs.fontFamilyInput.value;
            updateRecentFonts(value);
            rebuildFontOptions(value);
            sendUpdate({ styles: { fontFamily: value } });
            scheduleAutoSave();
            scheduleHistorySnapshot();
        });

        controlRefs.fontSizeInput?.addEventListener('input', () => {
            if (isSyncingControls) return;
            sendUpdate({ styles: { fontSize: normalizeCssValue(controlRefs.fontSizeInput.value) } });
            scheduleAutoSave();
            scheduleHistorySnapshot();
        });

        controlRefs.alignBadges.forEach(badge => {
            badge.addEventListener('click', () => {
                if (isSyncingControls) return;
                const align = badge.getAttribute('data-align');
                if (align) {
                    setActiveGroup(controlRefs.alignBadges, align, 'data-align');
                    sendUpdate({ styles: { textAlign: align } });
                    scheduleAutoSave();
                    scheduleHistorySnapshot();
                }
            });
        });

        controlRefs.layoutPills.forEach(pill => {
            pill.addEventListener('click', () => {
                if (isSyncingControls) return;
                const layout = pill.getAttribute('data-layout');
                if (layout) {
                    setActiveGroup(controlRefs.layoutPills, layout, 'data-layout');
                    sendUpdate({ styles: { display: layout } });
                    scheduleAutoSave();
                    scheduleHistorySnapshot();
                }
            });
        });

        controlRefs.textColorInput?.addEventListener('input', () => {
            if (isSyncingControls) return;
            const value = controlRefs.textColorInput.value;
            controlRefs.textColorValue.textContent = value;
            sendUpdate({ styles: { color: value } });
        });
        controlRefs.textColorInput?.addEventListener('change', () => {
            if (isSyncingControls) return;
            scheduleAutoSave();
            scheduleHistorySnapshot();
        });
        controlRefs.bgColorInput?.addEventListener('input', () => {
            if (isSyncingControls) return;
            if (isBgTransparent) {
                isBgTransparent = false;
                if (controlRefs.bgTransparentToggle) {
                    controlRefs.bgTransparentToggle.checked = false;
                }
            }
            const value = controlRefs.bgColorInput.value;
            setBackgroundControlState(value, false);
            sendUpdate({ styles: { backgroundColor: value } });
        });
        controlRefs.bgColorInput?.addEventListener('change', () => {
            if (isSyncingControls) return;
            scheduleAutoSave();
            scheduleHistorySnapshot();
        });
        controlRefs.bgTransparentToggle?.addEventListener('change', () => {
            if (isSyncingControls) return;
            const enabled = !!controlRefs.bgTransparentToggle?.checked;
            if (enabled) {
                setBackgroundControlState(controlRefs.bgColorInput?.value || '#000000', true);
                sendUpdate({ styles: { backgroundColor: 'transparent' } });
            } else {
                const value = controlRefs.bgColorInput?.value || '#000000';
                setBackgroundControlState(value, false);
                sendUpdate({ styles: { backgroundColor: value } });
            }
            scheduleAutoSave();
            scheduleHistorySnapshot();
        });
        controlRefs.radiusInput?.addEventListener('input', () => {
            if (isSyncingControls) return;
            const value = normalizeCssValue(controlRefs.radiusInput.value);
            controlRefs.radiusInput.value = value || '0px';
            sendUpdate({ styles: { borderRadius: value || '0px' } });
            scheduleAutoSave();
            scheduleHistorySnapshot();
        });

        controlRefs.textContentInput?.addEventListener('input', () => {
            if (isSyncingControls) return;
            if (textMode === 'plain') {
                sendUpdate({ text: controlRefs.textContentInput.value });
            } else {
                const html = decodeHtmlEntities(controlRefs.textContentInput.value);
                sendUpdate({ html });
            }
            scheduleAutoSave();
            scheduleHistorySnapshot();
        });

        loadRecentFonts();
        loadWorkflowOptions();
        rebuildFontOptions(controlRefs.fontFamilyInput?.value || '');
        updateHistoryButtons();
        setBackgroundControlState(controlRefs.bgColorInput?.value || '#000000', false);

        controlRefs.textModeBadges.forEach(badge => {
            badge.addEventListener('click', () => {
                if (badge.classList.contains('is-disabled')) return;
                const mode = badge.getAttribute('data-textmode');
                if (!mode) return;
                textMode = mode;
                setActiveGroup(controlRefs.textModeBadges, textMode, 'data-textmode');
                if (editorBridge.selection && controlRefs.textContentInput) {
                    controlRefs.textContentInput.value = textMode === 'plain'
                        ? (editorBridge.selection.text || '')
                        : (editorBridge.selection.html || editorBridge.selection.text || '');
                }
                if (textMode === 'html') {
                    if (!textModeTooltip) {
                        textModeTooltip = document.createElement('div');
                        textModeTooltip.className = 'text-mode-tooltip';
                        document.body.appendChild(textModeTooltip);
                    }
                    textModeTooltip.textContent = 'HTML mode can affect layout. Paste trusted markup only.';
                    textModeTooltip.style.visibility = 'hidden';
                    textModeTooltip.classList.remove('is-visible');
                    const rect = badge.getBoundingClientRect();
                    textModeTooltip.style.top = `${rect.bottom + 8}px`;
                    textModeTooltip.style.left = `${rect.left}px`;
                    textModeTooltip.style.visibility = 'visible';
                    const maxLeft = window.innerWidth - textModeTooltip.offsetWidth - 12;
                    if (rect.left > maxLeft) {
                        textModeTooltip.style.left = `${Math.max(12, maxLeft)}px`;
                    }
                    requestAnimationFrame(() => textModeTooltip.classList.add('is-visible'));
                    clearTimeout(textModeTooltipTimer);
                    textModeTooltipTimer = setTimeout(() => {
                        textModeTooltip.classList.remove('is-visible');
                    }, 2200);
                }
            });
        });

        const applySpacingUpdate = () => {
            if (isSyncingControls) return;
            const styles = {};
            const marginY = controlRefs.marginYInput?.value;
            const marginX = controlRefs.marginXInput?.value;
            const paddingY = controlRefs.paddingYInput?.value;
            const paddingX = controlRefs.paddingXInput?.value;
            if (marginY !== undefined && marginY !== '') {
                const value = normalizeCssValue(marginY);
                styles.marginTop = value;
                styles.marginBottom = value;
            }
            if (marginX !== undefined && marginX !== '') {
                const value = normalizeCssValue(marginX);
                styles.marginLeft = value;
                styles.marginRight = value;
            }
            if (paddingY !== undefined && paddingY !== '') {
                const value = normalizeCssValue(paddingY);
                styles.paddingTop = value;
                styles.paddingBottom = value;
            }
            if (paddingX !== undefined && paddingX !== '') {
                const value = normalizeCssValue(paddingX);
                styles.paddingLeft = value;
                styles.paddingRight = value;
            }
            if (Object.keys(styles).length) {
                sendUpdate({ styles });
                scheduleAutoSave();
                scheduleHistorySnapshot();
            }
        };

        controlRefs.marginYInput?.addEventListener('input', applySpacingUpdate);
        controlRefs.marginXInput?.addEventListener('input', applySpacingUpdate);
        controlRefs.paddingYInput?.addEventListener('input', applySpacingUpdate);
        controlRefs.paddingXInput?.addEventListener('input', applySpacingUpdate);

        const deleteSelectedElement = () => {
            const el = getSelectedElementNode();
            if (!el || !el.parentElement) return;
            const parent = el.parentElement;
            const targetId = ensureBugenceId(el);
            const parentId = ensureBugenceId(parent);
            const index = Array.from(parent.children).indexOf(el);
            pushHistoryOp({
                type: 'remove',
                targetId,
                parentId,
                index,
                html: el.outerHTML
            });
            el.remove();
            sendToIframe('bugence-editor:select', { selector: `[data-bugence-id="${parentId}"]` });
            markEdit('structural');
            scheduleAutoSave();
            rebuildInlineAdd();
            scheduleStructureUpdate();
            initIframeEnhancements();
        };

        const duplicateSelectedElement = () => {
            const el = getSelectedElementNode();
            if (!el || !el.parentElement) return;
            const parent = el.parentElement;
            const clone = el.cloneNode(true);
            clone.dataset.bugenceId = `bugence-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
            clone.id = `bugence-el-${Date.now()}-${elementIdCounter++}`;
            parent.insertBefore(clone, el.nextSibling);
            const parentId = ensureBugenceId(parent);
            const index = Array.from(parent.children).indexOf(clone);
            pushHistoryOp({
                type: 'insert',
                targetId: clone.dataset.bugenceId,
                parentId,
                index,
                html: clone.outerHTML
            });
            sendToIframe('bugence-editor:select', { selector: `[data-bugence-id="${clone.dataset.bugenceId}"]` });
            markEdit('structural');
            scheduleAutoSave();
            rebuildInlineAdd();
            scheduleStructureUpdate();
            initIframeEnhancements();
        };

        const getSelectedSymbolId = () => {
            const el = getSelectedElementNode();
            const symbolId = el?.getAttribute?.('data-bugence-symbol-id');
            if (!symbolId) return null;
            const symbols = loadSymbols();
            const exists = symbols.find(item => item.id === symbolId);
            return exists ? symbolId : null;
        };

        const updateSymbolInstances = (symbolId, html) => {
            const doc = getCanvasDocument();
            if (!doc || !symbolId || !html) return;
            const instances = Array.from(doc.querySelectorAll(`[data-bugence-symbol-id="${symbolId}"]`));
            if (!instances.length) return;
            const template = doc.createElement('template');
            template.innerHTML = html.trim();
            const base = template.content.firstElementChild;
            if (!base) return;
            const beforeMap = new Map();
            instances.forEach(instance => {
                const id = ensureBugenceId(instance);
                beforeMap.set(id, instance.outerHTML);
            });
            instances.forEach(instance => {
                const clone = base.cloneNode(true);
                clone.removeAttribute('data-bugence-id');
                clone.removeAttribute('data-bugence-generated');
                clone.removeAttribute('data-bugence-editor');
                clone.removeAttribute('data-bugence-symbol-id');
                clone.querySelectorAll('[data-bugence-id],[data-bugence-generated],[data-bugence-editor],[data-bugence-symbol-id]').forEach(node => {
                    node.removeAttribute('data-bugence-id');
                    node.removeAttribute('data-bugence-generated');
                    node.removeAttribute('data-bugence-editor');
                    node.removeAttribute('data-bugence-symbol-id');
                });
                const id = instance.getAttribute('data-bugence-id');
                if (id) clone.setAttribute('data-bugence-id', id);
                if (instance.id) clone.id = instance.id;
                clone.setAttribute('data-bugence-symbol-id', symbolId);
                clone.setAttribute('data-bugence-generated', 'true');
                instance.replaceWith(clone);
            });
            instances.forEach(instance => {
                const id = instance.getAttribute('data-bugence-id');
                const updated = id ? doc.querySelector(`[data-bugence-id="${id}"]`) : null;
                const beforeHtml = id ? beforeMap.get(id) : null;
                if (updated && beforeHtml && beforeHtml !== updated.outerHTML) {
                    pushHistoryOp({
                        type: 'update',
                        targetId: id,
                        beforeHtml,
                        afterHtml: updated.outerHTML
                    });
                }
            });
            markEdit('structural');
            scheduleAutoSave();
            scheduleStructureUpdate();
            initIframeEnhancements();
            updateSelectionOverlay();
            updateMultiSelectionClasses();
        };

        const applyMediaSource = (src) => {
            const el = getSelectedElementNode();
            if (!el) return;
            const tag = el.tagName.toLowerCase();
            if (tag === 'img') {
                el.setAttribute('src', src);
            } else if (tag === 'video') {
                const source = el.querySelector('source');
                if (source) {
                    source.setAttribute('src', src);
                } else {
                    el.setAttribute('src', src);
                }
                el.load?.();
            } else if (tag === 'source') {
                el.setAttribute('src', src);
                el.parentElement?.load?.();
            }
            scheduleHistorySnapshot();
            scheduleAutoSave();
            sendToIframe('bugence-editor:select', { selector: `[data-bugence-id="${ensureBugenceId(el)}"]` });
        };

        controlRefs.deleteElementBtn?.addEventListener('click', deleteSelectedElement);
        controlRefs.duplicateElementBtn?.addEventListener('click', duplicateSelectedElement);
        controlRefs.saveSymbolBtn?.addEventListener('click', () => {
            const el = getSelectedElementNode();
            if (!el) return;
            const fallbackName = el.getAttribute('data-bugence-type') || el.tagName.toLowerCase();
            const name = window.prompt('Symbol name', fallbackName);
            if (!name || !name.trim()) return;
            const symbols = loadSymbols();
            const id = `symbol-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 6)}`;
            symbols.unshift({
                id,
                name: name.trim(),
                html: el.outerHTML,
                createdAt: new Date().toISOString()
            });
            persistSymbols(symbols);
            buildElementsCatalog(controlRefs.elementsSearch?.value || '');
            bindPaletteInteractions();
        });
        controlRefs.updateSymbolBtn?.addEventListener('click', () => {
            const el = getSelectedElementNode();
            if (!el) return;
            const symbolId = el.getAttribute('data-bugence-symbol-id');
            if (!symbolId) return;
            const symbols = loadSymbols();
            const index = symbols.findIndex(item => item.id === symbolId);
            if (index === -1) return;
            symbols[index] = {
                ...symbols[index],
                html: el.outerHTML,
                updatedAt: new Date().toISOString()
            };
            persistSymbols(symbols);
            updateSymbolInstances(symbolId, el.outerHTML);
        });
        controlRefs.mediaUrlInput?.addEventListener('change', () => {
            if (!controlRefs.mediaUrlInput) return;
            const value = controlRefs.mediaUrlInput.value.trim();
            if (!value) return;
            applyMediaSource(value);
        });
        controlRefs.mediaUploadInput?.addEventListener('change', (event) => {
            const file = event.target?.files?.[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                if (typeof reader.result === 'string') {
                    applyMediaSource(reader.result);
                }
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        });
        controlRefs.mediaChooseBtn?.addEventListener('click', () => {
            const el = getSelectedElementNode();
            const tag = el?.tagName?.toLowerCase();
            const type = tag === 'video' ? 'video' : 'image';
            assetPickerContext = 'media';
            openAssetModal(type);
        });

        const handleDesignTokenInput = () => {
            const tokens = getDesignTokensFromInputs();
            saveDesignTokens(tokens);
            applyDesignTokensToIframe(tokens);
        };
        controlRefs.tokenTextPrimary?.addEventListener('input', handleDesignTokenInput);
        controlRefs.tokenTextSecondary?.addEventListener('input', handleDesignTokenInput);
        controlRefs.tokenBgBlack?.addEventListener('input', handleDesignTokenInput);
        controlRefs.tokenAccentCyan?.addEventListener('input', handleDesignTokenInput);
        controlRefs.tokenAccentBlue?.addEventListener('input', handleDesignTokenInput);
        controlRefs.tokenSpaceSm?.addEventListener('input', handleDesignTokenInput);
        controlRefs.tokenSpaceMd?.addEventListener('input', handleDesignTokenInput);
        controlRefs.tokenSpaceLg?.addEventListener('input', handleDesignTokenInput);
        controlRefs.tokenSpaceXl?.addEventListener('input', handleDesignTokenInput);
        controlRefs.tokenRadiusSm?.addEventListener('input', handleDesignTokenInput);
        controlRefs.tokenRadiusMd?.addEventListener('input', handleDesignTokenInput);
        controlRefs.tokenRadiusLg?.addEventListener('input', handleDesignTokenInput);
        controlRefs.tokenRadiusXl?.addEventListener('input', handleDesignTokenInput);
        controlRefs.tokenFontBase?.addEventListener('input', handleDesignTokenInput);
        controlRefs.tokenFontScale?.addEventListener('input', handleDesignTokenInput);
        controlRefs.tokenPresetSelect?.addEventListener('change', (event) => {
            applyPresetTokens(event.target?.value);
        });
        controlRefs.saveTokenPresetBtn?.addEventListener('click', () => {
            const name = window.prompt('Preset name');
            if (!name || !name.trim()) return;
            if (!designSystemState) {
                designSystemState = loadDesignSystemState();
            }
            const tokens = getDesignTokensFromInputs();
            const existing = designSystemState.presets.find(preset => preset.name.toLowerCase() === name.trim().toLowerCase());
            if (existing) {
                existing.tokens = tokens;
                existing.updatedAt = new Date().toISOString();
            } else {
                designSystemState.presets.push({
                    id: `preset-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 6)}`,
                    name: name.trim(),
                    tokens,
                    createdAt: new Date().toISOString()
                });
            }
            refreshTokenPresetSelect();
            persistDesignSystemState();
        });
        controlRefs.exportTokensBtn?.addEventListener('click', () => {
            const state = designSystemState || loadDesignSystemState();
            const payload = JSON.stringify(state, null, 2);
            const blob = new Blob([payload], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `bugence-design-system-${projectId || 'project'}.json`;
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
        });

        controlRefs.assetCloseBtn?.addEventListener('click', closeAssetModal);
        controlRefs.assetModal?.addEventListener('click', (event) => {
            if (event.target === controlRefs.assetModal) closeAssetModal();
        });
        controlRefs.assetUploadBtn?.addEventListener('click', () => {
            controlRefs.assetUploadInput?.click();
        });
        controlRefs.assetUploadInput?.addEventListener('change', (event) => {
            const files = event.target?.files;
            if (!files || !files.length) return;
            uploadAssets(files);
            event.target.value = '';
        });
        controlRefs.assetRefreshBtn?.addEventListener('click', () => {
            resetAssetCache();
            openAssetModal(assetFilter);
        });
        controlRefs.missingAssetsBtn?.addEventListener('click', openMissingAssetsModal);
        controlRefs.missingAssetsFixBtn?.addEventListener('click', fixMissingAssets);
        controlRefs.missingAssetsCloseBtn?.addEventListener('click', closeMissingAssetsModal);
        controlRefs.missingAssetsModal?.addEventListener('click', (event) => {
            if (event.target === controlRefs.missingAssetsModal) closeMissingAssetsModal();
        });
        controlRefs.assetSearch?.addEventListener('input', () => {
            openAssetModal(assetFilter);
        });
        controlRefs.assetGrid?.addEventListener('click', (event) => {
            const deleteBtn = event.target?.closest?.('[data-asset-delete]');
            if (deleteBtn) {
                event.preventDefault();
                event.stopPropagation();
                const card = deleteBtn.closest('.asset-item');
                const path = card?.getAttribute?.('data-asset-path');
                if (path) deleteAsset(path);
                return;
            }
            const card = event.target?.closest?.('.asset-item');
            const url = card?.getAttribute?.('data-asset-url');
            const type = card?.getAttribute?.('data-asset-type');
            if (!url) return;
            if (assetPickerContext === 'lottie') {
                if (type !== 'lottie') {
                    showToast('Pick a Lottie JSON asset.');
                    return;
                }
                if (controlRefs.lottieUrlInput) {
                    controlRefs.lottieUrlInput.value = url;
                }
                controlRefs.applyLottieBtn?.click();
            } else {
                if (type === 'lottie') {
                    showToast('Use Motion Studio to apply Lottie assets.');
                    return;
                }
                applyMediaSource(url);
            }
            closeAssetModal();
        });

        const applyGridControls = () => {
            const el = getSelectedElementNode();
            if (!el || !controlRefs.layoutControls) return;
            const cols = Number(controlRefs.gridColsInput?.value || 0);
            const rows = Number(controlRefs.gridRowsInput?.value || 0);
            const gap = controlRefs.gridGapInput?.value || '';
            const flow = controlRefs.gridFlowInput?.value || 'row';
            if (cols > 0) {
                el.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
            }
            if (rows > 0) {
                el.style.gridTemplateRows = `repeat(${rows}, minmax(0, 1fr))`;
            }
            if (gap !== '') {
                el.style.gap = normalizeCssValue(gap);
            }
            el.style.gridAutoFlow = flow;
            scheduleHistorySnapshot();
            scheduleAutoSave();
        };

        controlRefs.gridColsInput?.addEventListener('input', applyGridControls);
        controlRefs.gridRowsInput?.addEventListener('input', applyGridControls);
        controlRefs.gridGapInput?.addEventListener('input', applyGridControls);
        controlRefs.gridFlowInput?.addEventListener('change', applyGridControls);

        const applyMapControls = () => {
            const el = getSelectedElementNode();
            if (!el || el.tagName.toLowerCase() !== 'iframe') return;
            const loc = controlRefs.mapLocationInput?.value?.trim() || '';
            const zoom = controlRefs.mapZoomInput?.value?.trim() || '12';
            if (!loc) return;
            const src = `https://www.google.com/maps?q=${encodeURIComponent(loc)}&z=${encodeURIComponent(zoom)}&output=embed`;
            el.setAttribute('src', src);
            el.setAttribute('data-bugence-type', 'map');
            scheduleHistorySnapshot();
            scheduleAutoSave();
            sendToIframe('bugence-editor:select', { selector: `[data-bugence-id="${ensureBugenceId(el)}"]` });
        };

        controlRefs.mapLocationInput?.addEventListener('change', applyMapControls);
        controlRefs.mapZoomInput?.addEventListener('change', applyMapControls);

        controlRefs.fieldPlaceholderInput?.addEventListener('input', () => {
            const el = getSelectedElementNode();
            if (!el || !['input', 'textarea'].includes(el.tagName.toLowerCase())) return;
            el.setAttribute('placeholder', controlRefs.fieldPlaceholderInput.value || '');
            scheduleHistorySnapshot();
            scheduleAutoSave();
        });

        controlRefs.addCarouselSlideBtn?.addEventListener('click', () => {
            const el = getSelectedElementNode();
            if (!el) return;
            const bugenceType = el.getAttribute('data-bugence-type');
            if (bugenceType !== 'carousel') return;
            const track = el.querySelector('[data-bugence-carousel-track]') || el;
            const slide = el.ownerDocument.createElement('div');
            slide.style.flex = '0 0 220px';
            slide.style.padding = '12px';
            slide.style.border = '1px solid rgba(255,255,255,0.12)';
            slide.style.borderRadius = '12px';
            slide.style.background = 'rgba(10,10,10,0.6)';
            slide.innerHTML = `
                <div style="height:120px;border-radius:10px;background:rgba(255,255,255,0.08);margin-bottom:10px;display:flex;align-items:center;justify-content:center;font-size:12px;opacity:.6;">Image</div>
                <div style="font-weight:600;">Slide ${track.children.length + 1}</div>
                <div style="opacity:.7;font-size:12px;margin-top:4px;">Subtitle</div>
            `;
            track.appendChild(slide);
            scheduleHistorySnapshot();
            scheduleAutoSave();
        });
        controlRefs.removeCarouselSlideBtn?.addEventListener('click', () => {
            const el = getSelectedElementNode();
            if (!el || el.getAttribute('data-bugence-type') !== 'carousel') return;
            const track = el.querySelector('[data-bugence-carousel-track]') || el;
            if (track.lastElementChild) {
                track.removeChild(track.lastElementChild);
                scheduleHistorySnapshot();
                scheduleAutoSave();
            }
        });

        controlRefs.addGalleryImageBtn?.addEventListener('click', () => {
            const el = getSelectedElementNode();
            if (!el || el.getAttribute('data-bugence-type') !== 'gallery') return;
            const img = el.ownerDocument.createElement('img');
            img.src = buildSvgPlaceholder(200, 160, 'Image', 20);
            img.style.width = '100%';
            img.style.borderRadius = '8px';
            el.appendChild(img);
            initGalleryInteractions();
            initGalleryLightbox();
            scheduleHistorySnapshot();
            scheduleAutoSave();
        });
        controlRefs.removeGalleryImageBtn?.addEventListener('click', () => {
            const el = getSelectedElementNode();
            if (!el || el.getAttribute('data-bugence-type') !== 'gallery') return;
            if (el.lastElementChild) {
                el.removeChild(el.lastElementChild);
                scheduleHistorySnapshot();
                scheduleAutoSave();
            }
        });
        const addGalleryImage = (url) => {
            if (isSyncingControls || !url) return;
            const el = getSelectedElementNode();
            if (!el || el.getAttribute('data-bugence-type') !== 'gallery') return;
            const img = el.ownerDocument.createElement('img');
            img.src = url;
            img.style.width = '100%';
            img.style.borderRadius = '8px';
            el.appendChild(img);
            initGalleryInteractions();
            initGalleryLightbox();
            scheduleHistorySnapshot();
            scheduleAutoSave();
        };
        const addGalleryImageFromUrl = () => {
            const url = controlRefs.galleryImageUrlInput?.value?.trim();
            if (!url) return;
            addGalleryImage(url);
            controlRefs.galleryImageUrlInput.value = '';
        };
        controlRefs.galleryImageUrlInput?.addEventListener('change', addGalleryImageFromUrl);
        controlRefs.galleryImageUrlInput?.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                addGalleryImageFromUrl();
            }
        });
        controlRefs.galleryUploadInput?.addEventListener('change', (event) => {
            const files = Array.from(event.target?.files || []);
            if (!files.length) return;
            if (controlRefs.galleryUploadHint) {
                controlRefs.galleryUploadHint.textContent = `Uploading ${files.length} image${files.length > 1 ? 's' : ''}...`;
            }
            if (controlRefs.galleryUploadList) {
                controlRefs.galleryUploadList.innerHTML = '';
            }
            let completed = 0;
            files.forEach(file => {
                let row = null;
                let statusEl = null;
                if (controlRefs.galleryUploadList) {
                    row = document.createElement('div');
                    row.className = 'gallery-upload-item';
                    const thumb = document.createElement('img');
                    thumb.className = 'gallery-upload-thumb';
                    const name = document.createElement('span');
                    name.textContent = file.name || 'Image';
                    statusEl = document.createElement('span');
                    statusEl.className = 'gallery-upload-status';
                    statusEl.textContent = 'Queued';
                    row.appendChild(thumb);
                    row.appendChild(name);
                    row.appendChild(statusEl);
                    controlRefs.galleryUploadList.appendChild(row);
                }
                const reader = new FileReader();
                reader.onload = () => {
                    if (typeof reader.result === 'string') {
                        addGalleryImage(reader.result);
                        if (row) {
                            const thumb = row.querySelector('img');
                            if (thumb) thumb.src = reader.result;
                        }
                    }
                    completed += 1;
                    if (statusEl) {
                        statusEl.textContent = 'Added';
                    }
                    if (controlRefs.galleryUploadHint) {
                        controlRefs.galleryUploadHint.textContent = completed === files.length
                            ? `Added ${completed} image${completed > 1 ? 's' : ''}.`
                            : `Uploading ${files.length - completed} image${files.length - completed > 1 ? 's' : ''}...`;
                    }
                };
                reader.readAsDataURL(file);
            });
            event.target.value = '';
        });

        controlRefs.addTabBtn?.addEventListener('click', () => {
            const el = getSelectedElementNode();
            if (!el || el.getAttribute('data-bugence-type') !== 'tabs') return;
            const bar = el.querySelector('[data-bugence-tabs="buttons"]');
            const panes = el.querySelector('[data-bugence-tabs="panes"]');
            if (!bar || !panes) return;
            const btn = el.ownerDocument.createElement('button');
            btn.type = 'button';
            btn.style.all = 'unset';
            btn.style.cursor = 'pointer';
            btn.style.padding = '6px 10px';
            btn.style.borderRadius = '8px';
            const id = `tab-${Date.now()}`;
            btn.setAttribute('data-tab-id', id);
            btn.textContent = `Tab ${bar.children.length + 1}`;
            bar.appendChild(btn);
            const pane = el.ownerDocument.createElement('div');
            pane.setAttribute('data-tab-id', id);
            pane.style.opacity = '.8';
            pane.style.display = 'none';
            pane.textContent = 'Tab content goes here.';
            panes.appendChild(pane);
            el.dataset.bugenceActiveTab = id;
            setActiveTab(el, id);
            updateTabsContentInputs(el);
            scheduleHistorySnapshot();
            scheduleAutoSave();
        });
        controlRefs.removeTabBtn?.addEventListener('click', () => {
            const el = getSelectedElementNode();
            if (!el || el.getAttribute('data-bugence-type') !== 'tabs') return;
            const bar = el.querySelector('[data-bugence-tabs="buttons"]');
            const panes = el.querySelector('[data-bugence-tabs="panes"]');
            if (bar?.lastElementChild) {
                const lastId = bar.lastElementChild.getAttribute('data-tab-id');
                bar.removeChild(bar.lastElementChild);
                if (lastId) {
                    const pane = panes?.querySelector(`[data-tab-id="${lastId}"]`);
                    pane?.remove();
                }
                const nextId = bar?.querySelector('button[data-tab-id]')?.getAttribute('data-tab-id');
                if (nextId) {
                    el.dataset.bugenceActiveTab = nextId;
                    setActiveTab(el, nextId);
                    updateTabsContentInputs(el);
                }
                scheduleHistorySnapshot();
                scheduleAutoSave();
            }
        });

        const applyTabContentInputs = () => {
            if (isSyncingControls) return;
            const tabs = getTabsRootFromSelection();
            if (!tabs) return;
            const { activeButton, activePane } = getActiveTabParts(tabs);
            if (!activeButton || !activePane) return;
            if (controlRefs.tabTitleInput) {
                activeButton.textContent = controlRefs.tabTitleInput.value || 'Tab';
            }
            if (controlRefs.tabContentInput) {
                activePane.textContent = controlRefs.tabContentInput.value || '';
            }
            scheduleHistorySnapshot();
            scheduleAutoSave();
        };
        controlRefs.tabTitleInput?.addEventListener('input', applyTabContentInputs);
        controlRefs.tabContentInput?.addEventListener('input', applyTabContentInputs);

        controlRefs.addAccordionItemBtn?.addEventListener('click', () => {
            const el = getSelectedElementNode();
            const type = el?.getAttribute('data-bugence-type');
            if (!el || (type !== 'accordion' && type !== 'faq')) return;
            const item = el.ownerDocument.createElement('div');
            item.style.border = '1px solid rgba(255,255,255,0.12)';
            item.style.borderRadius = '12px';
            item.style.padding = '10px';
            item.style.marginTop = '8px';
            item.innerHTML = '<strong>Question</strong><div style="opacity:.8;margin-top:6px;">Answer text goes here.</div>';
            el.appendChild(item);
            scheduleHistorySnapshot();
            scheduleAutoSave();
        });
        controlRefs.removeAccordionItemBtn?.addEventListener('click', () => {
            const el = getSelectedElementNode();
            const type = el?.getAttribute('data-bugence-type');
            if (!el || (type !== 'accordion' && type !== 'faq')) return;
            if (el.lastElementChild) {
                el.removeChild(el.lastElementChild);
                scheduleHistorySnapshot();
                scheduleAutoSave();
            }
        });

        const updatePricingFromInputs = () => {
            const el = getSelectedElementNode();
            if (!el || el.getAttribute('data-bugence-type') !== 'pricing') return;
            const title = controlRefs.pricingTitleInput?.value || '';
            const price = controlRefs.pricingPriceInput?.value || '';
            const desc = controlRefs.pricingDescInput?.value || '';
            const titleEl = el.querySelector('strong');
            const divs = el.querySelectorAll('div');
            if (titleEl) titleEl.textContent = title;
            if (divs[0]) divs[0].textContent = price;
            if (divs[1]) divs[1].textContent = desc;
            scheduleHistorySnapshot();
            scheduleAutoSave();
        };

        controlRefs.pricingTitleInput?.addEventListener('input', updatePricingFromInputs);
        controlRefs.pricingPriceInput?.addEventListener('input', updatePricingFromInputs);
        controlRefs.pricingDescInput?.addEventListener('input', updatePricingFromInputs);

        const updateContentGrid = () => {
            const el = getSelectedElementNode();
            const type = el?.getAttribute('data-bugence-type');
            if (!el || !['posts', 'loop-grid', 'portfolio', 'team'].includes(type || '')) return;
            const items = Math.max(1, Number(controlRefs.contentItemsInput?.value || 6));
            const cols = Math.max(1, Number(controlRefs.contentColsInput?.value || 3));
            const layout = controlRefs.contentLayoutInput?.value || 'cards';
            el.setAttribute('data-bugence-items', String(items));
            el.setAttribute('data-bugence-cols', String(cols));
            el.setAttribute('data-bugence-layout', layout);
            el.style.display = 'grid';
            el.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
            el.style.gap = layout === 'compact' ? '10px' : '14px';
            const buildCard = (index) => {
                const card = el.ownerDocument.createElement('div');
                card.style.border = '1px solid rgba(255,255,255,0.12)';
                card.style.borderRadius = layout === 'compact' ? '10px' : '14px';
                card.style.padding = layout === 'compact' ? '10px' : '12px';
                card.style.background = 'rgba(10,10,10,0.6)';
                const title = type === 'team' ? 'Team Member' : type === 'portfolio' ? 'Project Title' : 'Post Title';
                const meta = type === 'team' ? 'Product Lead' : 'Short description goes here.';
                card.innerHTML = `
                    <div style="height:${layout === 'compact' ? '90px' : '120px'};border-radius:10px;background:rgba(255,255,255,0.08);margin-bottom:10px;display:flex;align-items:center;justify-content:center;font-size:12px;color:rgba(255,255,255,0.4);">Image</div>
                    <div style="font-weight:600;">${title} ${index + 1}</div>
                    <div style="font-size:12px;opacity:.7;margin-top:4px;">${meta}</div>
                `;
                return card;
            };
            const current = Array.from(el.children);
            if (current.length > items) {
                current.slice(items).forEach(child => child.remove());
            } else {
                for (let i = current.length; i < items; i += 1) {
                    el.appendChild(buildCard(i));
                }
            }
            Array.from(el.children).forEach((child, index) => {
                if (child.nodeType !== 1) return;
                child.replaceWith(buildCard(index));
            });
            scheduleHistorySnapshot();
            scheduleAutoSave();
        };

        controlRefs.contentItemsInput?.addEventListener('input', updateContentGrid);
        controlRefs.contentColsInput?.addEventListener('input', updateContentGrid);
        controlRefs.contentLayoutInput?.addEventListener('change', updateContentGrid);

        const updateWidgetSettings = () => {
            const el = getSelectedElementNode();
            const type = el?.getAttribute('data-bugence-type') || '';
            if (!el || !['menu', 'breadcrumbs', 'pagination', 'social-icons', 'share', 'reviews', 'timeline', 'counter', 'progress', 'table', 'embed', 'lottie', 'youtube', 'vimeo', 'product-grid', 'icon', 'icon-box', 'image-box', 'carousel', 'gallery', 'map'].includes(type)) return;
            if (['social-icons', 'share', 'icon', 'icon-box'].includes(type)) {
                ensureFontAwesomeLink(el.ownerDocument);
            }
            const items = Math.max(1, Number(controlRefs.widgetItemsInput?.value || 4));
            const cols = Math.max(1, Number(controlRefs.widgetColsInput?.value || 3));
            const value = controlRefs.widgetValueInput?.value || '';
            const embed = safeUrlValue(controlRefs.widgetEmbedInput?.value || '');
            el.setAttribute('data-bugence-items', String(items));
            el.setAttribute('data-bugence-cols', String(cols));
            if (value) {
                el.setAttribute('data-bugence-value', value);
            }
            if (embed) {
                el.setAttribute('data-bugence-embed', embed);
            } else {
                el.removeAttribute('data-bugence-embed');
            }
            const updateInputs = () => {
                if (controlRefs.widgetItemsInput) controlRefs.widgetItemsInput.value = String(items);
                if (controlRefs.widgetColsInput) controlRefs.widgetColsInput.value = String(cols);
                if (controlRefs.widgetValueInput) controlRefs.widgetValueInput.value = value || '';
            };

            if (type === 'menu' || type === 'breadcrumbs') {
                const labels = Array.from({ length: items }).map((_, i) => `Item ${i + 1}`);
                if (type === 'menu') {
                    const list = el.querySelector('ul') || el.ownerDocument.createElement('ul');
                    list.innerHTML = '';
                    list.style.display = 'inline-flex';
                    list.style.gap = '16px';
                    list.style.listStyle = 'none';
                    list.style.padding = '0';
                    list.style.margin = '0';
                    labels.forEach(label => {
                        const li = el.ownerDocument.createElement('li');
                        li.innerHTML = `<a href="#" style="text-decoration:none;color:inherit;">${label}</a>`;
                        list.appendChild(li);
                    });
                    if (!el.contains(list)) el.appendChild(list);
                } else {
                    const list = el.querySelector('ol') || el.ownerDocument.createElement('ol');
                    list.innerHTML = '';
                    list.style.display = 'inline-flex';
                    list.style.gap = '8px';
                    list.style.listStyle = 'none';
                    list.style.padding = '0';
                    list.style.margin = '0';
                    labels.forEach((label, idx) => {
                        const li = el.ownerDocument.createElement('li');
                        li.innerHTML = idx === labels.length - 1
                            ? `<span style="opacity:.7;">${label}</span>`
                            : `<a href="#" style="text-decoration:none;color:inherit;">${label}</a><span style="opacity:.4;margin:0 6px;">/</span>`;
                        list.appendChild(li);
                    });
                    if (!el.contains(list)) el.appendChild(list);
                }
            }

            if (type === 'pagination') {
                const list = el.querySelector('ul') || el.ownerDocument.createElement('ul');
                list.innerHTML = '';
                list.style.display = 'inline-flex';
                list.style.gap = '8px';
                list.style.listStyle = 'none';
                list.style.padding = '0';
                list.style.margin = '0';
                const labels = ['Prev', ...Array.from({ length: Math.max(1, items - 2) }).map((_, i) => `${i + 1}`), 'Next'];
                labels.forEach(label => {
                    const li = el.ownerDocument.createElement('li');
                    li.innerHTML = `<a href="#" style="display:inline-flex;padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);text-decoration:none;color:inherit;">${label}</a>`;
                    list.appendChild(li);
                });
                if (!el.contains(list)) el.appendChild(list);
            }

            if (type === 'social-icons' || type === 'share') {
                const icons = [
                    '<i class="fa-brands fa-x-twitter"></i>',
                    '<i class="fa-brands fa-instagram"></i>',
                    '<i class="fa-brands fa-youtube"></i>',
                    '<i class="fa-brands fa-github"></i>',
                    '<i class="fa-brands fa-linkedin"></i>'
                ];
                el.innerHTML = '';
                el.style.display = 'inline-flex';
                el.style.gap = '10px';
                const count = Math.min(items, icons.length);
                for (let i = 0; i < count; i += 1) {
                    const node = el.ownerDocument.createElement('a');
                    node.href = '#';
                    node.style.color = 'inherit';
                    node.innerHTML = icons[i];
                    el.appendChild(node);
                }
            }

            if (type === 'reviews') {
                const stars = Math.max(1, Math.min(5, Number(value || 5)));
                el.innerHTML = `<span style="color:#facc15;">${''.repeat(stars)}</span><span style="opacity:.7;margin-left:6px;">4.${stars} (124 reviews)</span>`;
                updateInputs();
            }

            if (type === 'timeline') {
                el.innerHTML = '';
                el.style.display = 'grid';
                el.style.gap = '12px';
                for (let i = 0; i < items; i += 1) {
                    const item = el.ownerDocument.createElement('div');
                    item.style.display = 'flex';
                    item.style.gap = '10px';
                    item.innerHTML = `
                        <div style="width:10px;height:10px;border-radius:50%;background:rgba(6,182,212,${0.8 - i * 0.15});margin-top:6px;"></div>
                        <div><strong>Milestone ${i + 1}</strong><div style="opacity:.7;">Description text.</div></div>
                    `;
                    el.appendChild(item);
                }
            }

            if (type === 'counter') {
                el.innerHTML = `<div style="font-size:28px;font-weight:700;">${value || 120}+</div><div style="opacity:.7;">Projects</div>`;
                updateInputs();
            }

            if (type === 'progress') {
                const pct = Math.max(1, Math.min(100, Number(value || 75)));
                el.innerHTML = `
                    <div style="font-size:12px;opacity:.7;margin-bottom:6px;">Progress</div>
                    <div style="height:8px;border-radius:999px;background:rgba(255,255,255,0.1);overflow:hidden;">
                        <div style="height:100%;width:${pct}%;background:linear-gradient(90deg, rgba(6,182,212,0.8), rgba(59,130,246,0.8));"></div>
                    </div>
                    <div style="font-size:12px;opacity:.7;margin-top:6px;">${pct}%</div>
                `;
                if (controlRefs.widgetValueInput) controlRefs.widgetValueInput.value = String(pct);
            }

            if (type === 'table') {
                const table = el.querySelector('table') || el.ownerDocument.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                const colsCount = Math.max(1, cols);
                const rowsCount = Math.max(1, items);
                const head = el.ownerDocument.createElement('thead');
                const headRow = el.ownerDocument.createElement('tr');
                for (let i = 0; i < colsCount; i += 1) {
                    const th = el.ownerDocument.createElement('th');
                    th.textContent = `Col ${i + 1}`;
                    th.style.textAlign = 'left';
                    th.style.padding = '6px 8px';
                    th.style.borderBottom = '1px solid rgba(255,255,255,0.15)';
                    headRow.appendChild(th);
                }
                head.appendChild(headRow);
                const body = el.ownerDocument.createElement('tbody');
                for (let r = 0; r < rowsCount; r += 1) {
                    const row = el.ownerDocument.createElement('tr');
                    for (let c = 0; c < colsCount; c += 1) {
                        const td = el.ownerDocument.createElement('td');
                        td.textContent = `Row ${r + 1}`;
                        td.style.padding = '6px 8px';
                        td.style.borderBottom = '1px solid rgba(255,255,255,0.06)';
                        row.appendChild(td);
                    }
                    body.appendChild(row);
                }
                table.innerHTML = '';
                table.appendChild(head);
                table.appendChild(body);
                el.innerHTML = '';
                el.appendChild(table);
            }

            if (type === 'embed' || type === 'lottie') {
                el.innerHTML = embed
                    ? `<iframe src="${embed}" style="width:100%;height:280px;border:0;border-radius:12px;"></iframe>`
                    : '<div style="opacity:.7;font-size:12px;">Paste an embed URL in Widget settings.</div>';
            }

            if (type === 'youtube' || type === 'vimeo') {
                if (embed) {
                    el.setAttribute('src', embed);
                }
            }

            if (type === 'product-grid') {
                el.style.display = 'grid';
                el.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
                el.style.gap = '10px';
                el.innerHTML = '';
                for (let i = 0; i < items; i += 1) {
                    const card = el.ownerDocument.createElement('div');
                    card.style.border = '1px solid rgba(255,255,255,0.12)';
                    card.style.borderRadius = '10px';
                    card.style.padding = '8px';
                    card.innerHTML = `
                        <div style="height:120px;border-radius:8px;background:rgba(255,255,255,0.08);margin-bottom:8px;display:flex;align-items:center;justify-content:center;font-size:12px;opacity:.6;">Image</div>
                        <div style="font-weight:600;">Product ${i + 1}</div>
                        <div style="opacity:.7;font-size:12px;margin-top:4px;">$49</div>
                    `;
                    el.appendChild(card);
                }
            }

            if (type === 'carousel') {
                const track = el.querySelector('[data-bugence-carousel-track]') || el;
                const buildSlide = (index) => {
                    const slide = el.ownerDocument.createElement('div');
                    slide.style.flex = '0 0 220px';
                    slide.style.borderRadius = '12px';
                    slide.style.border = '1px solid rgba(255,255,255,0.12)';
                    slide.style.padding = '12px';
                    slide.style.background = 'rgba(10,10,10,0.6)';
                    slide.innerHTML = `
                        <div style="height:120px;border-radius:10px;background:rgba(255,255,255,0.08);margin-bottom:10px;display:flex;align-items:center;justify-content:center;font-size:12px;opacity:.6;">Image</div>
                        <div style="font-weight:600;">Slide ${index + 1}</div>
                        <div style="opacity:.7;font-size:12px;margin-top:4px;">Subtitle</div>
                    `;
                    return slide;
                };
                track.style.display = 'flex';
                track.style.gap = '12px';
                track.style.overflow = 'hidden';
                const currentSlides = Array.from(track.children).filter(child => child.nodeType === 1);
                if (currentSlides.length > items) {
                    currentSlides.slice(items).forEach(child => child.remove());
                } else {
                    for (let i = currentSlides.length; i < items; i += 1) {
                        track.appendChild(buildSlide(i));
                    }
                }
            }

            if (type === 'gallery') {
                el.style.display = 'grid';
                el.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
                el.style.gap = '8px';
                const current = Array.from(el.querySelectorAll('img'));
                if (current.length > items) {
                    current.slice(items).forEach(node => node.remove());
                } else {
                    for (let i = current.length; i < items; i += 1) {
                        const img = el.ownerDocument.createElement('img');
                        img.src = buildSvgPlaceholder(200, 160, 'Image', 20);
                        img.style.width = '100%';
                        img.style.borderRadius = '8px';
                        el.appendChild(img);
                    }
                }
            }

            if (type === 'map') {
                if (embed) {
                    el.setAttribute('src', embed);
                }
            }

            if (type === 'icon') {
                const iconValue = value || 'fa-solid fa-star';
                el.setAttribute('data-bugence-value', iconValue);
                if (iconValue.includes('fa-')) {
                    el.innerHTML = `<i class="${iconValue}" aria-hidden="true"></i>`;
                } else {
                    el.textContent = iconValue;
                }
            }

            if (type === 'icon-box' || type === 'image-box') {
                el.style.display = 'grid';
                el.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
                el.style.gap = '12px';
                el.innerHTML = '';
                for (let i = 0; i < items; i += 1) {
                    const card = el.ownerDocument.createElement('div');
                    card.style.border = '1px solid rgba(255,255,255,0.12)';
                    card.style.borderRadius = '14px';
                    card.style.padding = '12px';
                    card.style.background = 'rgba(10,10,10,0.6)';
                    const title = type === 'image-box' ? 'Image Title' : 'Feature Title';
                    const media = type === 'image-box'
                        ? '<div style="height:120px;border-radius:10px;background:rgba(255,255,255,0.08);margin-bottom:10px;display:flex;align-items:center;justify-content:center;font-size:12px;color:rgba(255,255,255,0.4);">Image</div>'
                        : '<div style="width:40px;height:40px;border-radius:12px;background:rgba(6,182,212,0.2);display:flex;align-items:center;justify-content:center;margin-bottom:10px;"><i class="fa-solid fa-bolt"></i></div>';
                    card.innerHTML = `
                        ${media}
                        <div style="font-weight:600;">${title} ${i + 1}</div>
                        <div style="opacity:.7;font-size:12px;margin-top:6px;">Short description text.</div>
                    `;
                    el.appendChild(card);
                }
            }

            scheduleHistorySnapshot();
            scheduleAutoSave();
        };

        controlRefs.widgetItemsInput?.addEventListener('input', updateWidgetSettings);
        controlRefs.widgetColsInput?.addEventListener('input', updateWidgetSettings);
        controlRefs.widgetValueInput?.addEventListener('input', updateWidgetSettings);
        controlRefs.widgetEmbedInput?.addEventListener('change', updateWidgetSettings);

        const tabs = document.querySelectorAll('.tab');
        const panels = {
            elements: document.getElementById('panelElements'),
            structure: document.getElementById('panelStructure'),
            pages: document.getElementById('panelPages')
        };

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                Object.keys(panels).forEach(key => panels[key].style.display = 'none');
                const name = tab.getAttribute('data-tab');
                if (name) {
                    leftSidebarState.activeTab = name;
                }
                if (panels[name]) panels[name].style.display = 'block';
            });
        });

        const deviceSelect = document.getElementById('deviceSelect');
        const canvasWrap = document.querySelector('.canvas-wrap');
        deviceSelect?.addEventListener('change', () => {
            if (!canvasWrap) return;
            const view = deviceSelect.value;
            canvasWrap.classList.toggle('is-mobile', view === 'mobile');
            canvasWrap.classList.toggle('is-tablet', view === 'tablet');
            applyCanvasZoom(1);
            queueEditorPrefsSave();
        });

        let elementIdCounter = 0;
        const getCanvasDocument = () => editorIframe?.contentDocument || null;

        const findInsertionParent = (doc, target) => {
            if (!doc) return null;
            if (!target || target === doc.documentElement || target === doc.body) return doc.body;
            const dropZone = target.closest?.('[data-bugence-dropzone="true"]');
            if (dropZone) return dropZone;
            const tag = target.tagName ? target.tagName.toLowerCase() : '';
            if (['img', 'video', 'input', 'textarea', 'select', 'svg', 'path', 'canvas'].includes(tag)) {
                return target.parentElement || doc.body;
            }
            return target;
        };
        const ensureFontAwesomeLink = (doc) => {
            if (!doc?.head) return;
            const existing = doc.querySelector('link[href*="font-awesome"], link[href*="fontawesome"]');
            if (existing) return;
            const link = doc.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
            link.setAttribute('data-bugence-fa', 'true');
            doc.head.appendChild(link);
        };
        const dropContainerSelector = '[data-bugence-dropzone="true"],[data-bugence-type="section"],[data-bugence-type="container"],[data-bugence-type="grid"],[data-bugence-type="columns"],[data-bugence-type="stack"],[data-bugence-type="form"],[data-bugence-type="tabs"],[data-bugence-type="accordion"],[data-bugence-type="faq"],section,main,article,aside';
        const isInlineElement = (el) => {
            if (!el) return false;
            const tag = el.tagName ? el.tagName.toLowerCase() : '';
            return ['a', 'span', 'strong', 'em', 'b', 'i', 'u', 'small', 'code', 'label', 'input', 'textarea', 'select', 'button', 'img', 'video', 'svg', 'path'].includes(tag);
        };
        const isDropContainer = (el) => {
            if (!el) return false;
            if (el.hasAttribute?.('data-bugence-dropzone')) return true;
            const type = el.getAttribute?.('data-bugence-type') || '';
            if (['section', 'container', 'grid', 'columns', 'stack', 'form', 'tabs', 'accordion', 'faq', 'pricing', 'gallery', 'carousel', 'posts', 'loop-grid', 'portfolio', 'team'].includes(type)) {
                return true;
            }
            const tag = el.tagName ? el.tagName.toLowerCase() : '';
            return ['section', 'main', 'article', 'aside'].includes(tag);
        };
        const resolveDropContainer = (target) => {
            if (!target) return null;
            if (target.hasAttribute?.('data-bugence-dropzone')) return target;
            const dropZone = target.closest?.('[data-bugence-dropzone="true"]');
            if (dropZone) return dropZone;
            const container = target.closest?.(dropContainerSelector);
            return container || null;
        };
        const canMoveInside = (dragEl, targetEl) => {
            if (!dragEl || !targetEl) return false;
            if (dragEl === targetEl) return false;
            if (dragEl.contains(targetEl)) return false;
            return isDropContainer(targetEl) && !isInlineElement(targetEl);
        };
        const resolveInsertionPlan = (doc, dropTarget, requestedPosition) => {
            const target = dropTarget || doc?.body;
            const position = requestedPosition || (target && isDropContainer(target) && !isInlineElement(target) ? 'inside' : 'after');
            let parent = findInsertionParent(doc, target) || doc.body;
            let insertBefore = null;
            let insertAfter = null;
            if (position === 'inside' && target && isDropContainer(target) && !isInlineElement(target)) {
                parent = resolveDropContainer(target) || target;
            } else if (target && target !== doc.body && target !== doc.documentElement) {
                const targetParent = target.parentElement || parent;
                parent = targetParent;
                if (position === 'before') {
                    insertBefore = target;
                } else {
                    insertAfter = target;
                }
            }
            return { parent, insertBefore, insertAfter, target, position };
        };

        const buildElementNode = (type, doc, options = {}) => {
            const safeDoc = doc || document;
            const createWrapper = (tag, text) => {
                const node = safeDoc.createElement(tag);
                if (text) node.textContent = text;
                return node;
            };
            switch (type) {
                case 'image': {
                    const img = safeDoc.createElement('img');
                    img.src = buildSvgPlaceholder(600, 400, '600 x 400', 32);
                    img.alt = 'Placeholder image';
                    img.setAttribute('data-bugence-type', 'image');
                    img.style.maxWidth = '100%';
                    img.style.display = 'block';
                    img.style.borderRadius = '12px';
                    return img;
                }
                case 'image-card': {
                    const variant = options.variantId || 'media-top';
                    const card = safeDoc.createElement('article');
                    card.setAttribute('data-bugence-type', 'image-card');
                    card.setAttribute('data-bugence-variant', variant);
                    card.style.border = '1px solid rgba(255,255,255,0.18)';
                    card.style.borderRadius = '16px';
                    card.style.overflow = 'hidden';
                    card.style.background = 'rgba(2,6,23,0.65)';
                    card.style.display = variant === 'media-left' ? 'grid' : 'block';
                    if (variant === 'media-left') {
                        card.style.gridTemplateColumns = 'minmax(180px, 42%) 1fr';
                    }
                    const media = safeDoc.createElement('img');
                    media.src = buildSvgPlaceholder(900, 560, 'Media', 42);
                    media.alt = 'Image card media';
                    media.style.width = '100%';
                    media.style.height = variant === 'media-left' ? '100%' : '220px';
                    media.style.objectFit = 'cover';
                    const body = safeDoc.createElement('div');
                    body.style.padding = '16px';
                    if (variant === 'overlay') {
                        card.style.position = 'relative';
                        media.style.height = '260px';
                        body.style.position = 'absolute';
                        body.style.inset = '0';
                        body.style.display = 'flex';
                        body.style.flexDirection = 'column';
                        body.style.justifyContent = 'flex-end';
                        body.style.background = 'linear-gradient(180deg, rgba(2,6,23,0.08), rgba(2,6,23,0.86))';
                    }
                    body.innerHTML = `<h3 style="margin:0 0 8px;font-size:1.1rem;">Feature Card</h3><p style="margin:0;opacity:0.88;line-height:1.6;">Use this card to highlight outcomes, capabilities, or project snapshots.</p>`;
                    card.appendChild(media);
                    card.appendChild(body);
                    return card;
                }
                case 'video': {
                    const video = safeDoc.createElement('video');
                    video.controls = true;
                    video.setAttribute('data-bugence-type', 'video');
                    video.style.width = '100%';
                    video.style.borderRadius = '12px';
                    video.innerHTML = '<source src="" type="video/mp4">';
                    return video;
                }
                case 'heading': {
                    const variant = options.variantId || 'section';
                    let tag = 'h2';
                    let text = 'New Heading';
                    if (variant === 'hero') {
                        tag = 'h1';
                        text = 'Hero Headline';
                    } else if (variant === 'eyebrow') {
                        tag = 'span';
                        text = 'Eyebrow';
                    }
                    const heading = safeDoc.createElement(tag);
                    heading.textContent = text;
                    if (variant === 'hero') {
                        heading.style.fontSize = '42px';
                        heading.style.fontWeight = '700';
                        heading.style.lineHeight = '1.1';
                    } else if (variant === 'eyebrow') {
                        heading.style.textTransform = 'uppercase';
                        heading.style.letterSpacing = '0.3em';
                        heading.style.fontSize = '12px';
                        heading.style.opacity = '0.7';
                    } else {
                        heading.style.fontSize = '28px';
                        heading.style.fontWeight = '600';
                    }
                    heading.setAttribute('data-bugence-type', 'heading');
                    heading.setAttribute('data-bugence-variant', variant);
                    return heading;
                }
                case 'text': {
                    const variant = options.variantId || 'body';
                    const text = safeDoc.createElement('p');
                    text.setAttribute('data-bugence-type', 'text');
                    text.setAttribute('data-bugence-variant', variant);
                    text.style.margin = '0';
                    text.style.lineHeight = '1.7';
                    if (variant === 'lead') {
                        text.textContent = 'Use this lead paragraph to summarize your value proposition clearly and quickly.';
                        text.style.fontSize = '1.125rem';
                        text.style.fontWeight = '500';
                        text.style.maxWidth = '62ch';
                        text.style.color = 'rgba(248,250,252,0.92)';
                    } else if (variant === 'caption') {
                        text.textContent = 'Supporting caption text';
                        text.style.fontSize = '0.78rem';
                        text.style.letterSpacing = '0.08em';
                        text.style.textTransform = 'uppercase';
                        text.style.opacity = '0.75';
                    } else {
                        text.textContent = 'Add your text here. Keep paragraphs focused and readable with clear spacing and line length.';
                        text.style.fontSize = '1rem';
                        text.style.maxWidth = '70ch';
                        text.style.color = 'rgba(226,232,240,0.9)';
                    }
                    return text;
                }
                case 'link': {
                    const link = safeDoc.createElement('a');
                    link.href = '#';
                    link.textContent = 'New Link';
                    return link;
                }
                case 'grid': {
                    const variant = options.variantId || 'stats-3';
                    const grid = safeDoc.createElement('div');
                    grid.setAttribute('data-bugence-type', 'grid');
                    grid.setAttribute('data-bugence-variant', variant);
                    grid.style.display = 'grid';
                    const cols = Number(options.cols) || (variant === 'cards-4' ? 4 : 3);
                    grid.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
                    grid.style.gap = variant === 'masonry' ? '16px' : '14px';
                    grid.style.padding = '10px';
                    grid.style.border = '1px dashed rgba(255,255,255,0.25)';
                    grid.style.borderRadius = '14px';
                    for (let i = 0; i < cols; i += 1) {
                        const cell = safeDoc.createElement('div');
                        cell.setAttribute('data-bugence-dropzone', 'true');
                        cell.style.minHeight = variant === 'masonry' ? `${120 + (i % 2) * 60}px` : '140px';
                        cell.style.display = 'flex';
                        cell.style.alignItems = 'center';
                        cell.style.justifyContent = 'center';
                        cell.style.color = 'rgba(255,255,255,0.68)';
                        cell.style.padding = '14px';
                        cell.style.border = '1px dashed rgba(255,255,255,0.2)';
                        cell.style.borderRadius = '12px';
                        if (variant === 'stats-3') {
                            cell.innerHTML = `<div style="text-align:center;"><div style="font-size:1.5rem;font-weight:700;">${(i + 1) * 12}%</div><div style="font-size:12px;opacity:.78;">Metric ${i + 1}</div></div>`;
                        } else if (variant === 'cards-4') {
                            cell.innerHTML = `<div style="text-align:left;width:100%;"><strong style="display:block;margin-bottom:6px;">Card ${i + 1}</strong><span style="font-size:12px;opacity:.78;">Drop content widgets inside</span></div>`;
                        } else {
                            cell.innerHTML = '<span style="font-size:12px;">Masonry cell</span>';
                        }
                        grid.appendChild(cell);
                    }
                    return grid;
                }
                case 'section': {
                    const variant = options.variantId || 'hero';
                    const section = safeDoc.createElement('section');
                    section.setAttribute('data-bugence-type', 'section');
                    section.setAttribute('data-bugence-variant', variant);
                    section.style.padding = variant === 'hero' ? '48px 32px' : '28px 24px';
                    section.style.border = '1px dashed rgba(255,255,255,0.25)';
                    section.style.borderRadius = '18px';
                    section.style.background = variant === 'feature'
                        ? 'linear-gradient(135deg, rgba(15,23,42,0.92), rgba(30,41,59,0.72))'
                        : 'transparent';
                    const drop = safeDoc.createElement('div');
                    drop.setAttribute('data-bugence-dropzone', 'true');
                    drop.style.minHeight = variant === 'hero' ? '240px' : '180px';
                    drop.style.display = variant === 'split' ? 'grid' : 'flex';
                    if (variant === 'split') {
                        drop.style.gridTemplateColumns = '1fr 1fr';
                        drop.style.gap = '16px';
                    } else {
                        drop.style.flexDirection = 'column';
                        drop.style.gap = '12px';
                        drop.style.alignItems = 'center';
                        drop.style.justifyContent = 'center';
                    }
                    drop.style.color = 'rgba(255,255,255,0.6)';
                    drop.style.border = '1px dashed rgba(255,255,255,0.2)';
                    drop.style.borderRadius = '12px';
                    drop.innerHTML = variant === 'split'
                        ? '<div style="padding:12px;border:1px dashed rgba(255,255,255,0.18);border-radius:10px;">Left Column</div><div style="padding:12px;border:1px dashed rgba(255,255,255,0.18);border-radius:10px;">Right Column</div>'
                        : '<span style="font-size:12px;">Drop widgets here</span>';
                    section.appendChild(drop);
                    return section;
                }
                case 'columns': {
                    const variant = options.variantId || 'two-equal';
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', 'columns');
                    wrap.setAttribute('data-bugence-variant', variant);
                    wrap.style.display = 'grid';
                    wrap.style.gridTemplateColumns = variant === 'sidebar-left'
                        ? 'minmax(220px, 30%) 1fr'
                        : (variant === 'sidebar-right' ? '1fr minmax(220px, 30%)' : 'repeat(2, minmax(0, 1fr))');
                    wrap.style.gap = '16px';
                    for (let i = 0; i < 2; i += 1) {
                        const col = safeDoc.createElement('div');
                        col.setAttribute('data-bugence-dropzone', 'true');
                        col.style.padding = '12px';
                        col.style.border = '1px dashed rgba(255,255,255,0.3)';
                        col.style.borderRadius = '8px';
                        col.style.minHeight = '140px';
                        col.style.display = 'flex';
                        col.style.alignItems = 'center';
                        col.style.justifyContent = 'center';
                        col.style.color = 'rgba(255,255,255,0.5)';
                        col.innerHTML = `<span style="font-size:12px;">Column ${i + 1}</span>`;
                        wrap.appendChild(col);
                    }
                    return wrap;
                }
                case 'container': {
                    const variant = options.variantId || 'card';
                    const container = safeDoc.createElement('div');
                    container.setAttribute('data-bugence-type', 'container');
                    container.setAttribute('data-bugence-variant', variant);
                    container.style.padding = '16px';
                    container.style.border = variant === 'soft' ? '1px solid rgba(255,255,255,0.16)' : '1px dashed rgba(255,255,255,0.3)';
                    container.style.borderRadius = '14px';
                    container.style.background = variant === 'card'
                        ? 'linear-gradient(135deg, rgba(15,23,42,0.8), rgba(30,41,59,0.55))'
                        : (variant === 'soft' ? 'rgba(255,255,255,0.04)' : 'transparent');
                    if (variant === 'card') {
                        container.style.boxShadow = '0 16px 36px rgba(2,8,23,0.35)';
                    }
                    const drop = safeDoc.createElement('div');
                    drop.setAttribute('data-bugence-dropzone', 'true');
                    drop.style.minHeight = '140px';
                    drop.style.display = 'flex';
                    drop.style.alignItems = 'center';
                    drop.style.justifyContent = 'center';
                    drop.style.color = 'rgba(255,255,255,0.5)';
                    drop.style.border = '1px dashed rgba(255,255,255,0.2)';
                    drop.style.borderRadius = '10px';
                    drop.innerHTML = '<span style="font-size:12px;">Drop widgets here</span>';
                    container.appendChild(drop);
                    return container;
                }
                case 'stack': {
                    const stack = safeDoc.createElement('div');
                    stack.setAttribute('data-bugence-type', 'stack');
                    stack.style.display = 'flex';
                    stack.style.flexDirection = 'column';
                    stack.style.gap = '12px';
                    stack.style.padding = '12px';
                    stack.style.border = '1px dashed rgba(255,255,255,0.25)';
                    stack.style.borderRadius = '12px';
                    const drop = safeDoc.createElement('div');
                    drop.setAttribute('data-bugence-dropzone', 'true');
                    drop.style.minHeight = '120px';
                    drop.style.display = 'flex';
                    drop.style.alignItems = 'center';
                    drop.style.justifyContent = 'center';
                    drop.style.color = 'rgba(255,255,255,0.5)';
                    drop.style.border = '1px dashed rgba(255,255,255,0.2)';
                    drop.style.borderRadius = '8px';
                    drop.innerHTML = '<span style="font-size:12px;">Stack drop zone</span>';
                    stack.appendChild(drop);
                    return stack;
                }
                case 'divider': {
                    const hr = safeDoc.createElement('hr');
                    hr.style.border = 'none';
                    hr.style.borderTop = '1px solid rgba(255,255,255,0.2)';
                    hr.style.margin = '16px 0';
                    return hr;
                }
                case 'spacer': {
                    const spacer = safeDoc.createElement('div');
                    spacer.style.height = '40px';
                    spacer.style.border = '1px dashed rgba(255,255,255,0.2)';
                    spacer.style.borderRadius = '8px';
                    spacer.style.opacity = '0.6';
                    return spacer;
                }
                case 'form': {
                    const variant = options.variantId || 'contact';
                    const form = safeDoc.createElement('form');
                    form.setAttribute('data-bugence-type', 'form');
                    form.setAttribute('data-bugence-variant', variant);
                    if (variant === 'newsletter') {
                        form.innerHTML = `<div style="display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;"><input type="email" placeholder="Enter your work email" style="padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.24);background:transparent;color:inherit;"><button type="button" style="padding:12px 18px;border-radius:12px;border:0;background:linear-gradient(135deg,#22d3ee,#3b82f6);color:#031225;font-weight:700;">Subscribe</button></div>`;
                    } else if (variant === 'quote') {
                        form.innerHTML = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"><input type="text" placeholder="First name" style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.22);background:transparent;color:inherit;"><input type="text" placeholder="Last name" style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.22);background:transparent;color:inherit;"><input type="email" placeholder="Email" style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.22);background:transparent;color:inherit;"><input type="tel" placeholder="Phone" style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.22);background:transparent;color:inherit;"><textarea rows="4" placeholder="Project scope and timeline" style="grid-column:1/-1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.22);background:transparent;color:inherit;"></textarea><button type="button" style="grid-column:1/-1;padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.08);color:inherit;">Request Proposal</button></div>`;
                    } else {
                        form.innerHTML = `<div style="display:grid;gap:10px;"><input type="text" placeholder="Full name" style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.22);background:transparent;color:inherit;"><input type="email" placeholder="Email address" style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.22);background:transparent;color:inherit;"><textarea rows="4" placeholder="Message" style="padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.22);background:transparent;color:inherit;"></textarea><button type="button" style="padding:10px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.08);color:inherit;">Send Message</button></div>`;
                    }
                    return form;
                }
                case 'cta': {
                    const btn = safeDoc.createElement('button');
                    btn.type = 'button';
                    btn.setAttribute('data-bugence-type', 'cta');
                    btn.textContent = 'Call to Action';
                    btn.style.padding = '10px 16px';
                    btn.style.borderRadius = '999px';
                    btn.style.border = '1px solid rgba(255,255,255,0.25)';
                    btn.style.background = 'transparent';
                    btn.style.color = 'inherit';
                    return btn;
                }
                case 'button': {
                    const btn = safeDoc.createElement('a');
                    const variant = options.variantId || 'soft';
                    btn.href = '#';
                    btn.setAttribute('role', 'button');
                    btn.setAttribute('data-bugence-type', 'button');
                    btn.setAttribute('data-bugence-variant', variant);
                    btn.textContent = variant === 'outline' ? 'Learn More' : variant === 'pill' ? 'Get Started' : 'Button';
                    btn.style.padding = '10px 18px';
                    btn.style.borderRadius = variant === 'pill' ? '999px' : '12px';
                    btn.style.fontWeight = '700';
                    btn.style.display = 'inline-flex';
                    btn.style.alignItems = 'center';
                    btn.style.justifyContent = 'center';
                    btn.style.gap = '8px';
                    btn.style.textDecoration = 'none';
                    if (variant === 'primary') {
                        btn.style.background = 'linear-gradient(135deg, #22d3ee, #3b82f6)';
                        btn.style.color = '#0b1120';
                        btn.style.border = 'none';
                        btn.style.boxShadow = '0 12px 24px rgba(34,211,238,0.25)';
                    } else if (variant === 'outline') {
                        btn.style.background = 'transparent';
                        btn.style.color = 'inherit';
                        btn.style.border = '1px solid rgba(255,255,255,0.35)';
                    } else if (variant === 'pill') {
                        btn.style.background = '#22c55e';
                        btn.style.color = '#04130c';
                        btn.style.border = 'none';
                        btn.style.boxShadow = '0 12px 22px rgba(34,197,94,0.2)';
                    } else {
                        btn.style.border = '1px solid rgba(255,255,255,0.2)';
                        btn.style.background = 'rgba(255,255,255,0.08)';
                        btn.style.color = 'inherit';
                    }
                    return btn;
                }
                case 'badge': {
                    const badge = safeDoc.createElement('span');
                    badge.setAttribute('data-bugence-type', 'badge');
                    badge.textContent = 'Badge';
                    badge.style.display = 'inline-flex';
                    badge.style.padding = '4px 10px';
                    badge.style.borderRadius = '999px';
                    badge.style.border = '1px solid rgba(255,255,255,0.2)';
                    badge.style.fontSize = '12px';
                    return badge;
                }
                case 'shape-rect': {
                    const shape = safeDoc.createElement('div');
                    shape.setAttribute('data-bugence-type', 'shape');
                    shape.setAttribute('data-bugence-shape', 'rect');
                    shape.style.width = '240px';
                    shape.style.height = '140px';
                    shape.style.borderRadius = '18px';
                    shape.style.background = 'linear-gradient(135deg, rgba(6,182,212,0.45), rgba(59,130,246,0.25))';
                    shape.style.border = '1px solid rgba(255,255,255,0.18)';
                    return shape;
                }
                case 'shape-circle': {
                    const shape = safeDoc.createElement('div');
                    shape.setAttribute('data-bugence-type', 'shape');
                    shape.setAttribute('data-bugence-shape', 'circle');
                    shape.style.width = '140px';
                    shape.style.height = '140px';
                    shape.style.borderRadius = '999px';
                    shape.style.background = 'radial-gradient(circle at top, rgba(255,255,255,0.25), rgba(6,182,212,0.2))';
                    shape.style.border = '1px solid rgba(255,255,255,0.18)';
                    return shape;
                }
                case 'shape-pill': {
                    const shape = safeDoc.createElement('div');
                    shape.setAttribute('data-bugence-type', 'shape');
                    shape.setAttribute('data-bugence-shape', 'pill');
                    shape.style.width = '240px';
                    shape.style.height = '90px';
                    shape.style.borderRadius = '999px';
                    shape.style.background = 'linear-gradient(135deg, rgba(6,182,212,0.5), rgba(34,197,94,0.35))';
                    shape.style.border = '1px solid rgba(255,255,255,0.18)';
                    return shape;
                }
                case 'shape-triangle': {
                    const shape = safeDoc.createElement('div');
                    shape.setAttribute('data-bugence-type', 'shape');
                    shape.setAttribute('data-bugence-shape', 'triangle');
                    shape.style.width = '180px';
                    shape.style.height = '160px';
                    shape.style.background = 'linear-gradient(160deg, rgba(59,130,246,0.55), rgba(6,182,212,0.35))';
                    shape.style.clipPath = 'polygon(50% 0%, 100% 100%, 0% 100%)';
                    return shape;
                }
                case 'shape-hex': {
                    const shape = safeDoc.createElement('div');
                    shape.setAttribute('data-bugence-type', 'shape');
                    shape.setAttribute('data-bugence-shape', 'hex');
                    shape.style.width = '180px';
                    shape.style.height = '160px';
                    shape.style.background = 'linear-gradient(135deg, rgba(251,191,36,0.55), rgba(249,115,22,0.35))';
                    shape.style.clipPath = 'polygon(25% 6%, 75% 6%, 100% 50%, 75% 94%, 25% 94%, 0% 50%)';
                    return shape;
                }
                case 'shape-star': {
                    const shape = safeDoc.createElement('div');
                    shape.setAttribute('data-bugence-type', 'shape');
                    shape.setAttribute('data-bugence-shape', 'star');
                    shape.style.width = '180px';
                    shape.style.height = '180px';
                    shape.style.background = 'linear-gradient(135deg, rgba(244,114,182,0.6), rgba(59,130,246,0.35))';
                    shape.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
                    return shape;
                }
                case 'shape-ring': {
                    const shape = safeDoc.createElement('div');
                    shape.setAttribute('data-bugence-type', 'shape');
                    shape.setAttribute('data-bugence-shape', 'ring');
                    shape.style.width = '160px';
                    shape.style.height = '160px';
                    shape.style.borderRadius = '50%';
                    shape.style.border = '10px solid rgba(6,182,212,0.6)';
                    shape.style.boxShadow = '0 0 18px rgba(6,182,212,0.35)';
                    shape.style.background = 'transparent';
                    return shape;
                }
                case 'shape-wave': {
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', 'shape');
                    wrap.setAttribute('data-bugence-shape', 'wave');
                    wrap.innerHTML = `
                        <svg viewBox="0 0 240 60" width="240" height="60" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="bugence-wave" x1="0" x2="1" y1="0" y2="0">
                                    <stop offset="0%" stop-color="#22d3ee"/>
                                    <stop offset="100%" stop-color="#3b82f6"/>
                                </linearGradient>
                            </defs>
                            <path d="M0 40c24 0 24-20 48-20s24 20 48 20 24-20 48-20 24 20 48 20 24-20 48-20v20H0z" fill="url(#bugence-wave)"/>
                        </svg>
                    `;
                    return wrap;
                }
                case 'shape-blob': {
                    const shape = safeDoc.createElement('div');
                    shape.setAttribute('data-bugence-type', 'shape');
                    shape.setAttribute('data-bugence-shape', 'blob');
                    shape.style.width = '200px';
                    shape.style.height = '180px';
                    shape.style.borderRadius = '60% 40% 45% 55% / 55% 45% 55% 45%';
                    shape.style.background = 'linear-gradient(135deg, rgba(6,182,212,0.4), rgba(59,130,246,0.35))';
                    shape.style.border = '1px solid rgba(255,255,255,0.18)';
                    return shape;
                }
                case 'shape-line': {
                    const shape = safeDoc.createElement('div');
                    shape.setAttribute('data-bugence-type', 'shape');
                    shape.setAttribute('data-bugence-shape', 'line');
                    shape.style.width = '220px';
                    shape.style.height = '8px';
                    shape.style.borderRadius = '999px';
                    shape.style.background = 'rgba(6,182,212,0.7)';
                    shape.style.boxShadow = '0 0 16px rgba(6,182,212,0.35)';
                    return shape;
                }
                case 'shape-arrow': {
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', 'shape');
                    wrap.setAttribute('data-bugence-shape', 'arrow');
                    wrap.innerHTML = `
                        <svg viewBox="0 0 220 60" width="220" height="60" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="bugence-arrow" x1="0" x2="1" y1="0" y2="0">
                                    <stop offset="0%" stop-color="#22d3ee"/>
                                    <stop offset="100%" stop-color="#3b82f6"/>
                                </linearGradient>
                            </defs>
                            <path d="M10 30h160l-14-14 6-6 28 28-28 28-6-6 14-14H10z" fill="url(#bugence-arrow)"/>
                        </svg>
                    `;
                    return wrap;
                }
                case 'gallery': {
                    const gallery = safeDoc.createElement('div');
                    gallery.setAttribute('data-bugence-type', 'gallery');
                    gallery.style.display = 'grid';
                    gallery.style.gridTemplateColumns = 'repeat(3, minmax(0, 1fr))';
                    gallery.style.gap = '8px';
                    for (let i = 0; i < 3; i += 1) {
                        const img = safeDoc.createElement('img');
                        img.src = buildSvgPlaceholder(200, 160, 'Image', 20);
                        img.style.width = '100%';
                        img.style.borderRadius = '8px';
                        gallery.appendChild(img);
                    }
                    return gallery;
                }
                case 'audio': {
                    const audio = safeDoc.createElement('audio');
                    audio.setAttribute('data-bugence-type', 'audio');
                    audio.controls = true;
                    audio.innerHTML = '<source src="" type="audio/mpeg">';
                    return audio;
                }
                case 'input': {
                    const input = safeDoc.createElement('input');
                    input.setAttribute('data-bugence-type', 'input');
                    input.type = 'text';
                    input.placeholder = 'Input';
                    input.style.padding = '8px 10px';
                    input.style.borderRadius = '8px';
                    input.style.border = '1px solid rgba(255,255,255,0.2)';
                    input.style.background = 'transparent';
                    input.style.color = 'inherit';
                    return input;
                }
                case 'textarea': {
                    const textarea = safeDoc.createElement('textarea');
                    textarea.setAttribute('data-bugence-type', 'textarea');
                    textarea.rows = 3;
                    textarea.placeholder = 'Textarea';
                    textarea.style.padding = '8px 10px';
                    textarea.style.borderRadius = '8px';
                    textarea.style.border = '1px solid rgba(255,255,255,0.2)';
                    textarea.style.background = 'transparent';
                    textarea.style.color = 'inherit';
                    return textarea;
                }
                case 'select': {
                    const select = safeDoc.createElement('select');
                    select.setAttribute('data-bugence-type', 'select');
                    select.innerHTML = '<option>Option 1</option><option>Option 2</option>';
                    select.style.padding = '8px 10px';
                    select.style.borderRadius = '8px';
                    select.style.border = '1px solid rgba(255,255,255,0.2)';
                    select.style.background = 'transparent';
                    select.style.color = 'inherit';
                    return select;
                }
                case 'checkbox': {
                    const wrap = safeDoc.createElement('label');
                    wrap.setAttribute('data-bugence-type', 'checkbox');
                    wrap.style.display = 'inline-flex';
                    wrap.style.gap = '8px';
                    wrap.style.alignItems = 'center';
                    wrap.innerHTML = '<input type="checkbox"> Checkbox';
                    return wrap;
                }
                case 'radio': {
                    const wrap = safeDoc.createElement('label');
                    wrap.setAttribute('data-bugence-type', 'radio');
                    wrap.style.display = 'inline-flex';
                    wrap.style.gap = '8px';
                    wrap.style.alignItems = 'center';
                    wrap.innerHTML = '<input type="radio" name="radio"> Radio';
                    return wrap;
                }
                case 'tabs': {
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', 'tabs');
                    wrap.innerHTML = `
                        <div data-bugence-tabs="buttons" style="display:flex;gap:8px;border-bottom:1px solid rgba(255,255,255,0.12);padding-bottom:8px;">
                            <button type="button" data-tab-id="tab-1" style="all:unset;cursor:pointer;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.08);">Tab 1</button>
                            <button type="button" data-tab-id="tab-2" style="all:unset;cursor:pointer;padding:6px 10px;border-radius:8px;">Tab 2</button>
                        </div>
                        <div data-bugence-tabs="panes" style="margin-top:10px;">
                            <div data-tab-id="tab-1" style="opacity:.8;">Tab 1 content goes here.</div>
                            <div data-tab-id="tab-2" style="opacity:.8;display:none;">Tab 2 content goes here.</div>
                        </div>
                    `;
                    return wrap;
                }
                case 'accordion':
                case 'faq': {
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', type);
                    wrap.innerHTML = `
                        <div style="border:1px solid rgba(255,255,255,0.12);border-radius:12px;padding:10px;margin-bottom:8px;">
                            <strong>Question 1</strong>
                            <div style="opacity:.8;margin-top:6px;">Answer text goes here.</div>
                        </div>
                        <div style="border:1px solid rgba(255,255,255,0.12);border-radius:12px;padding:10px;">
                            <strong>Question 2</strong>
                            <div style="opacity:.8;margin-top:6px;">Answer text goes here.</div>
                        </div>
                    `;
                    return wrap;
                }
                case 'testimonial': {
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', 'testimonial');
                    wrap.style.border = '1px solid rgba(255,255,255,0.12)';
                    wrap.style.borderRadius = '12px';
                    wrap.style.padding = '12px';
                    wrap.innerHTML = `<div style="opacity:.8;">A standout experience with clear results.</div><div style="margin-top:8px;font-weight:600;"> Alex Rivera</div>`;
                    return wrap;
                }
                case 'posts':
                case 'loop-grid':
                case 'portfolio':
                case 'team': {
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', type);
                    wrap.setAttribute('data-bugence-layout', 'cards');
                    wrap.setAttribute('data-bugence-items', '6');
                    wrap.setAttribute('data-bugence-cols', '3');
                    wrap.style.display = 'grid';
                    wrap.style.gridTemplateColumns = 'repeat(3, minmax(0, 1fr))';
                    wrap.style.gap = '14px';
                    const buildCard = (index) => {
                        const card = safeDoc.createElement('div');
                        card.style.border = '1px solid rgba(255,255,255,0.12)';
                        card.style.borderRadius = '14px';
                        card.style.padding = '12px';
                        card.style.background = 'rgba(10,10,10,0.6)';
                        card.innerHTML = `
                            <div style="height:120px;border-radius:10px;background:rgba(255,255,255,0.08);margin-bottom:10px;display:flex;align-items:center;justify-content:center;font-size:12px;color:rgba(255,255,255,0.4);">Image</div>
                            <div style="font-weight:600;">${type === 'team' ? 'Team Member' : type === 'portfolio' ? 'Project Title' : 'Post Title'} ${index + 1}</div>
                            <div style="font-size:12px;opacity:.7;margin-top:4px;">${type === 'team' ? 'Product Lead' : 'Short description goes here.'}</div>
                        `;
                        return card;
                    };
                    for (let i = 0; i < 6; i += 1) {
                        wrap.appendChild(buildCard(i));
                    }
                    return wrap;
                }
                case 'pricing': {
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', 'pricing');
                    wrap.style.border = '1px solid rgba(255,255,255,0.12)';
                    wrap.style.borderRadius = '12px';
                    wrap.style.padding = '12px';
                    wrap.innerHTML = `<strong>Starter</strong><div style="font-size:24px;margin:6px 0;">$19</div><div style="opacity:.8;">Best for simple sites.</div>`;
                    return wrap;
                }
                case 'counter': {
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', 'counter');
                    wrap.innerHTML = `<div style="font-size:28px;font-weight:700;">120+</div><div style="opacity:.7;">Projects</div>`;
                    return wrap;
                }
                case 'progress': {
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', 'progress');
                    wrap.innerHTML = `
                        <div style="font-size:12px;opacity:.7;margin-bottom:6px;">Progress</div>
                        <div style="height:8px;border-radius:999px;background:rgba(255,255,255,0.12);overflow:hidden;">
                            <div style="width:65%;height:100%;background:rgba(6,182,212,0.8);"></div>
                        </div>
                    `;
                    return wrap;
                }
                case 'timeline': {
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', 'timeline');
                    wrap.setAttribute('data-bugence-items', '3');
                    wrap.style.display = 'grid';
                    wrap.style.gap = '12px';
                    wrap.innerHTML = `
                        <div style="display:flex;gap:10px;align-items:flex-start;">
                            <div style="width:10px;height:10px;border-radius:50%;background:rgba(6,182,212,0.8);margin-top:6px;"></div>
                            <div><strong>Milestone 1</strong><div style="opacity:.7;">Description text.</div></div>
                        </div>
                        <div style="display:flex;gap:10px;align-items:flex-start;">
                            <div style="width:10px;height:10px;border-radius:50%;background:rgba(6,182,212,0.5);margin-top:6px;"></div>
                            <div><strong>Milestone 2</strong><div style="opacity:.7;">Description text.</div></div>
                        </div>
                        <div style="display:flex;gap:10px;align-items:flex-start;">
                            <div style="width:10px;height:10px;border-radius:50%;background:rgba(6,182,212,0.3);margin-top:6px;"></div>
                            <div><strong>Milestone 3</strong><div style="opacity:.7;">Description text.</div></div>
                        </div>
                    `;
                    return wrap;
                }
                case 'menu': {
                    const nav = safeDoc.createElement('nav');
                    nav.setAttribute('data-bugence-type', 'menu');
                    nav.setAttribute('data-bugence-items', '4');
                    const list = safeDoc.createElement('ul');
                    list.style.display = 'inline-flex';
                    list.style.gap = '16px';
                    list.style.listStyle = 'none';
                    list.style.padding = '0';
                    list.style.margin = '0';
                    ['Home', 'Features', 'Pricing', 'Contact'].forEach(label => {
                        const li = safeDoc.createElement('li');
                        li.innerHTML = `<a href="#" style="text-decoration:none;color:inherit;">${label}</a>`;
                        list.appendChild(li);
                    });
                    nav.appendChild(list);
                    return nav;
                }
                case 'breadcrumbs': {
                    const nav = safeDoc.createElement('nav');
                    nav.setAttribute('data-bugence-type', 'breadcrumbs');
                    nav.setAttribute('data-bugence-items', '3');
                    const list = safeDoc.createElement('ol');
                    list.style.display = 'inline-flex';
                    list.style.gap = '8px';
                    list.style.listStyle = 'none';
                    list.style.padding = '0';
                    list.style.margin = '0';
                    ['Home', 'Section', 'Page'].forEach((label, idx, arr) => {
                        const li = safeDoc.createElement('li');
                        li.innerHTML = idx === arr.length - 1
                            ? `<span style="opacity:.7;">${label}</span>`
                            : `<a href="#" style="text-decoration:none;color:inherit;">${label}</a><span style="opacity:.4;margin:0 6px;">/</span>`;
                        list.appendChild(li);
                    });
                    nav.appendChild(list);
                    return nav;
                }
                case 'pagination': {
                    const nav = safeDoc.createElement('nav');
                    nav.setAttribute('data-bugence-type', 'pagination');
                    nav.setAttribute('data-bugence-items', '5');
                    const list = safeDoc.createElement('ul');
                    list.style.display = 'inline-flex';
                    list.style.gap = '8px';
                    list.style.listStyle = 'none';
                    list.style.padding = '0';
                    list.style.margin = '0';
                    const labels = ['Prev', '1', '2', '3', 'Next'];
                    labels.forEach(label => {
                        const li = safeDoc.createElement('li');
                        li.innerHTML = `<a href="#" style="display:inline-flex;padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);text-decoration:none;color:inherit;">${label}</a>`;
                        list.appendChild(li);
                    });
                    nav.appendChild(list);
                    return nav;
                }
                case 'search': {
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', 'search');
                    wrap.innerHTML = `
                        <div style="display:flex;gap:8px;align-items:center;">
                            <input type="search" placeholder="Search..." style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:inherit;">
                            <button type="button" style="padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:inherit;">Go</button>
                        </div>
                    `;
                    return wrap;
                }
                case 'social-icons': {
                    ensureFontAwesomeLink(safeDoc);
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', 'social-icons');
                    wrap.setAttribute('data-bugence-items', '3');
                    wrap.style.display = 'inline-flex';
                    wrap.style.gap = '10px';
                    wrap.innerHTML = `
                        <a href="#" aria-label="Twitter" style="color:inherit;"><i class="fa-brands fa-x-twitter"></i></a>
                        <a href="#" aria-label="Instagram" style="color:inherit;"><i class="fa-brands fa-instagram"></i></a>
                        <a href="#" aria-label="YouTube" style="color:inherit;"><i class="fa-brands fa-youtube"></i></a>
                    `;
                    return wrap;
                }
                case 'share': {
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', 'share');
                    wrap.setAttribute('data-bugence-items', '2');
                    wrap.style.display = 'inline-flex';
                    wrap.style.gap = '8px';
                    wrap.innerHTML = `
                        <button type="button" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:inherit;">Copy Link</button>
                        <button type="button" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:inherit;">Share</button>
                    `;
                    return wrap;
                }
                case 'reviews': {
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', 'reviews');
                    wrap.setAttribute('data-bugence-items', '5');
                    wrap.setAttribute('data-bugence-value', '5');
                    wrap.innerHTML = `
                        <span style="color:#facc15;"></span>
                        <span style="opacity:.7;margin-left:6px;">4.9 (124 reviews)</span>
                    `;
                    return wrap;
                }
                case 'embed': {
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', 'embed');
                    wrap.setAttribute('data-bugence-embed', '');
                    wrap.style.border = '1px dashed rgba(255,255,255,0.25)';
                    wrap.style.borderRadius = '12px';
                    wrap.style.padding = '12px';
                    wrap.innerHTML = '<div style="opacity:.7;font-size:12px;">Paste an embed URL in Widget settings.</div>';
                    return wrap;
                }
                case 'map': {
                    const frame = safeDoc.createElement('iframe');
                    frame.setAttribute('data-bugence-type', 'map');
                    frame.setAttribute('loading', 'lazy');
                    frame.style.width = '100%';
                    frame.style.height = '280px';
                    frame.style.border = '0';
                    frame.src = 'https://www.google.com/maps?q=Dubai%20Silicon%20Oasis&z=12&output=embed';
                    return frame;
                }
                case 'youtube':
                case 'vimeo': {
                    const frame = safeDoc.createElement('iframe');
                    frame.setAttribute('data-bugence-type', type);
                    frame.setAttribute('data-bugence-embed', frame.src);
                    frame.style.width = '100%';
                    frame.style.height = '280px';
                    frame.style.border = '0';
                    frame.src = 'https://www.youtube.com/embed/dQw4w9WgXcQ';
                    return frame;
                }
                case 'lottie': {
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', 'lottie');
                    wrap.setAttribute('data-bugence-embed', '');
                    wrap.style.padding = '12px';
                    wrap.style.border = '1px dashed rgba(255,255,255,0.25)';
                    wrap.style.borderRadius = '12px';
                    wrap.innerHTML = '<div style="opacity:.7;font-size:12px;">Lottie URL goes in Widget settings.</div>';
                    return wrap;
                }
                case 'product-grid': {
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', 'product-grid');
                    wrap.setAttribute('data-bugence-items', '6');
                    wrap.setAttribute('data-bugence-cols', '3');
                    wrap.style.display = 'grid';
                    wrap.style.gridTemplateColumns = 'repeat(3, minmax(0, 1fr))';
                    wrap.style.gap = '10px';
                    for (let i = 0; i < 6; i += 1) {
                        const card = safeDoc.createElement('div');
                        card.style.border = '1px solid rgba(255,255,255,0.12)';
                        card.style.borderRadius = '10px';
                        card.style.padding = '8px';
                        card.innerHTML = `
                            <div style="height:120px;border-radius:8px;background:rgba(255,255,255,0.08);margin-bottom:8px;display:flex;align-items:center;justify-content:center;font-size:12px;opacity:.6;">Image</div>
                            <div style="font-weight:600;">Product ${i + 1}</div>
                            <div style="opacity:.7;font-size:12px;margin-top:4px;">$49</div>
                        `;
                        wrap.appendChild(card);
                    }
                    return wrap;
                }
                case 'cart-button': {
                    ensureFontAwesomeLink(safeDoc);
                    const btn = safeDoc.createElement('button');
                    btn.setAttribute('data-bugence-type', 'cart-button');
                    btn.type = 'button';
                    btn.innerHTML = '<i class="fa-solid fa-cart-plus" style="margin-right:6px;"></i>Add to Cart';
                    return btn;
                }
                case 'shape': {
                    const box = safeDoc.createElement('div');
                    box.setAttribute('data-bugence-type', 'shape');
                    box.style.width = '80px';
                    box.style.height = '80px';
                    box.style.borderRadius = '12px';
                    box.style.background = 'rgba(6,182,212,0.2)';
                    return box;
                }
                case 'icon': {
                    ensureFontAwesomeLink(safeDoc);
                    const span = safeDoc.createElement('span');
                    const iconClass = options.iconClass || options.value || 'fa-solid fa-star';
                    span.setAttribute('data-bugence-type', 'icon');
                    span.setAttribute('data-bugence-value', iconClass);
                    span.style.display = 'inline-flex';
                    span.style.alignItems = 'center';
                    span.style.justifyContent = 'center';
                    span.style.fontSize = '24px';
                    span.innerHTML = `<i class="${iconClass}" aria-hidden="true"></i>`;
                    return span;
                }
                case 'icon-box':
                case 'image-box': {
                    if (type === 'icon-box') {
                        ensureFontAwesomeLink(safeDoc);
                    }
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', type);
                    wrap.setAttribute('data-bugence-items', '3');
                    wrap.setAttribute('data-bugence-cols', '3');
                    wrap.style.display = 'grid';
                    wrap.style.gridTemplateColumns = 'repeat(3, minmax(0, 1fr))';
                    wrap.style.gap = '12px';
                    for (let i = 0; i < 3; i += 1) {
                        const card = safeDoc.createElement('div');
                        card.style.border = '1px solid rgba(255,255,255,0.12)';
                        card.style.borderRadius = '14px';
                        card.style.padding = '12px';
                        card.style.background = 'rgba(10,10,10,0.6)';
                        const title = type === 'image-box' ? 'Image Title' : 'Feature Title';
                        const media = type === 'image-box'
                            ? '<div style="height:120px;border-radius:10px;background:rgba(255,255,255,0.08);margin-bottom:10px;display:flex;align-items:center;justify-content:center;font-size:12px;color:rgba(255,255,255,0.4);">Image</div>'
                            : '<div style="width:40px;height:40px;border-radius:12px;background:rgba(6,182,212,0.2);display:flex;align-items:center;justify-content:center;margin-bottom:10px;"><i class="fa-solid fa-bolt"></i></div>';
                        card.innerHTML = `
                            ${media}
                            <div style="font-weight:600;">${title} ${i + 1}</div>
                            <div style="opacity:.7;font-size:12px;margin-top:6px;">Short description text.</div>
                        `;
                        wrap.appendChild(card);
                    }
                    return wrap;
                }
                case 'table': {
                    const table = safeDoc.createElement('table');
                    table.setAttribute('data-bugence-type', 'table');
                    table.setAttribute('data-bugence-items', '4');
                    table.setAttribute('data-bugence-cols', '3');
                    table.innerHTML = '<tr><th>Header</th><th>Header</th><th>Header</th></tr><tr><td>Row 1</td><td>Value</td><td>Value</td></tr><tr><td>Row 2</td><td>Value</td><td>Value</td></tr><tr><td>Row 3</td><td>Value</td><td>Value</td></tr>';
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    table.querySelectorAll('th,td').forEach(cell => {
                        cell.style.border = '1px solid rgba(255,255,255,0.12)';
                        cell.style.padding = '6px';
                    });
                    return table;
                }
                case 'carousel': {
                    const wrap = safeDoc.createElement('div');
                    wrap.setAttribute('data-bugence-type', 'carousel');
                    wrap.setAttribute('data-bugence-items', '3');
                    wrap.style.display = 'grid';
                    wrap.style.gap = '12px';
                    wrap.innerHTML = `
                        <div data-bugence-carousel-track style="display:flex;gap:12px;overflow:hidden;">
                            <div style="flex:0 0 220px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);padding:12px;background:rgba(10,10,10,0.6);">
                                <div style="height:120px;border-radius:10px;background:rgba(255,255,255,0.08);margin-bottom:10px;display:flex;align-items:center;justify-content:center;font-size:12px;opacity:.6;">Image</div>
                                <div style="font-weight:600;">Slide 1</div>
                                <div style="opacity:.7;font-size:12px;margin-top:4px;">Subtitle</div>
                            </div>
                            <div style="flex:0 0 220px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);padding:12px;background:rgba(10,10,10,0.6);">
                                <div style="height:120px;border-radius:10px;background:rgba(255,255,255,0.08);margin-bottom:10px;display:flex;align-items:center;justify-content:center;font-size:12px;opacity:.6;">Image</div>
                                <div style="font-weight:600;">Slide 2</div>
                                <div style="opacity:.7;font-size:12px;margin-top:4px;">Subtitle</div>
                            </div>
                            <div style="flex:0 0 220px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);padding:12px;background:rgba(10,10,10,0.6);">
                                <div style="height:120px;border-radius:10px;background:rgba(255,255,255,0.08);margin-bottom:10px;display:flex;align-items:center;justify-content:center;font-size:12px;opacity:.6;">Image</div>
                                <div style="font-weight:600;">Slide 3</div>
                                <div style="opacity:.7;font-size:12px;margin-top:4px;">Subtitle</div>
                            </div>
                        </div>
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <button type="button" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:inherit;">Prev</button>
                            <div style="display:flex;gap:6px;">
                                <span style="width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,0.4);"></span>
                                <span style="width:8px;height:8px;border-radius:999px;background:rgba(6,182,212,0.7);"></span>
                                <span style="width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,0.4);"></span>
                            </div>
                            <button type="button" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:inherit;">Next</button>
                        </div>
                    `;
                    return wrap;
                }
                default:
                    return createWrapper('div', 'New Element');
            }
        };

        let pendingGridInsert = null;
        const openGridChooser = (payload) => {
            pendingGridInsert = payload;
            controlRefs.gridChooser?.classList.add('active');
        };

        const closeGridChooser = () => {
            controlRefs.gridChooser?.classList.remove('active');
            pendingGridInsert = null;
        };

        controlRefs.gridChooser?.addEventListener('click', (event) => {
            if (event.target === controlRefs.gridChooser) {
                closeGridChooser();
            }
            const option = event.target?.closest?.('.grid-option');
            if (!option || !pendingGridInsert) return;
            const cols = Number(option.getAttribute('data-cols'));
            const next = { ...pendingGridInsert, options: { cols } };
            closeGridChooser();
            insertElementFromPalette(next.type, next.dropTarget, next.dropPosition, next.options);
        });

        const insertElementFromPalette = (type, dropTarget, dropPosition, options = {}) => {
            if (type === 'grid' && !options.cols) {
                openGridChooser({ type, dropTarget, dropPosition });
                return;
            }
            const doc = getCanvasDocument();
            if (!doc) return;
            if (['button', 'heading', 'section', 'container', 'grid', 'columns', 'text', 'form', 'image-card'].includes(type) && !options.variantId) {
                openVariantModal(type, dropTarget, dropPosition);
                return;
            }
            const normalizeDropTarget = (target) => {
                if (!target) return target;
                return resolveDropContainer(target) || target;
            };
            dropTarget = normalizeDropTarget(dropTarget);
            const containerTarget = resolveDropContainer(dropTarget) || dropTarget;
            if (containerTarget?.hasAttribute?.('data-bugence-dropzone')) {
                dropPosition = 'inside';
            }
            if (!dropPosition && containerTarget && !isInlineElement(containerTarget)) {
                dropPosition = 'inside';
            }
            const stripBugenceIds = (node) => {
                if (!node) return;
                node.removeAttribute('id');
                node.removeAttribute('data-bugence-id');
                node.removeAttribute('data-bugence-generated');
                node.removeAttribute('data-bugence-editor');
                node.removeAttribute('data-bugence-symbol-id');
                node.querySelectorAll('[id],[data-bugence-id],[data-bugence-generated],[data-bugence-editor],[data-bugence-symbol-id]').forEach(child => {
                    child.removeAttribute('id');
                    child.removeAttribute('data-bugence-id');
                    child.removeAttribute('data-bugence-generated');
                    child.removeAttribute('data-bugence-editor');
                    child.removeAttribute('data-bugence-symbol-id');
                });
            };
            if (type && type.startsWith('symbol:')) {
                const symbolId = type.slice('symbol:'.length);
                const symbols = loadSymbols();
                const symbol = symbols.find(item => item.id === symbolId);
                if (!symbol || !symbol.html) return;
                const template = doc.createElement('template');
                template.innerHTML = symbol.html.trim();
                const node = template.content.firstElementChild;
                if (!node) return;
                stripBugenceIds(node);
                options = { ...options, symbolName: symbol.name };
                type = 'symbol';
                const id = `bugence-el-${Date.now()}-${elementIdCounter++}`;
                if (!node.id) node.id = id;
                if (!node.dataset.bugenceId) {
                    node.dataset.bugenceId = `bugence-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
                }
                node.setAttribute('data-bugence-symbol-id', symbolId);
                node.setAttribute('data-bugence-generated', 'true');
                const plan = resolveInsertionPlan(doc, dropTarget, dropPosition);
                const parent = plan.parent;
                const insertBefore = plan.insertBefore;
                const insertAfter = plan.insertAfter;
                if (insertBefore && insertBefore.parentElement === parent) {
                    parent.insertBefore(node, insertBefore);
                } else if (insertAfter && insertAfter.parentElement === parent) {
                    parent.insertBefore(node, insertAfter.nextSibling);
                } else {
                    parent.appendChild(node);
                }
                const parentId = ensureBugenceId(parent) || '';
                const index = Array.from(parent.children).indexOf(node);
                pushHistoryOp({
                    type: 'insert',
                    targetId: node.dataset.bugenceId,
                    parentId,
                    index,
                    html: node.outerHTML
                });
                if (node.scrollIntoView) {
                    node.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                sendToIframe('bugence-editor:select', { selector: `[data-bugence-id="${node.dataset.bugenceId}"]` });
                markEdit('structural');
                scheduleAutoSave();
                rebuildInlineAdd();
                scheduleStructureUpdate();
                initIframeEnhancements();
                return;
            }
            const plan = resolveInsertionPlan(doc, dropTarget, dropPosition);
            const parent = plan.parent;
            const insertBefore = plan.insertBefore;
            const insertAfter = plan.insertAfter;
            const node = buildElementNode(type, doc, options);
            if (!node) return;
            const id = `bugence-el-${Date.now()}-${elementIdCounter++}`;
            if (!node.id) node.id = id;
            if (!node.dataset.bugenceId) {
                node.dataset.bugenceId = `bugence-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
            }
            node.setAttribute('data-bugence-generated', 'true');
            if (insertBefore && insertBefore.parentElement === parent) {
                parent.insertBefore(node, insertBefore);
            } else if (insertAfter && insertAfter.parentElement === parent) {
                parent.insertBefore(node, insertAfter.nextSibling);
            } else {
                parent.appendChild(node);
            }
            const parentId = ensureBugenceId(parent) || '';
            const index = Array.from(parent.children).indexOf(node);
            pushHistoryOp({
                type: 'insert',
                targetId: node.dataset.bugenceId,
                parentId,
                index,
                html: node.outerHTML
            });
            if (node.scrollIntoView) {
                node.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            sendToIframe('bugence-editor:select', { selector: `[data-bugence-id="${node.dataset.bugenceId}"]` });
            markEdit('structural');
            scheduleAutoSave();
            rebuildInlineAdd();
            scheduleStructureUpdate();
            initIframeEnhancements();
        };

        let dragGhostSize = null;
        const getGhostSizeForType = (type, doc) => {
            const canvasWidth = doc?.documentElement?.clientWidth || 960;
            const scale = Math.min(1.1, Math.max(0.7, canvasWidth / 1200));
            const maxWidth = Math.max(240, canvasWidth * 0.7);
            const base = {
                image: { width: 420, height: 240 },
                'image-card': { width: 420, height: 220 },
                video: { width: 420, height: 240 },
                symbol: { width: 420, height: 180 },
                heading: { width: 360, height: 54 },
                text: { width: 420, height: 90 },
                link: { width: 220, height: 32 },
                grid: { width: 420, height: 180 },
                section: { width: 520, height: 200 },
                columns: { width: 520, height: 180 },
                container: { width: 420, height: 140 },
                divider: { width: 420, height: 18 },
                form: { width: 420, height: 60 },
                cta: { width: 220, height: 42 },
                carousel: { width: 420, height: 140 },
                embed: { width: 420, height: 120 }
            };
            const size = base[type] || { width: 360, height: 120 };
            const scaled = {
                width: size.width * scale,
                height: size.height * scale
            };
            return {
                width: Math.min(Math.max(200, scaled.width), maxWidth),
                height: Math.max(28, scaled.height)
            };
        };

        const bindPaletteInteractions = () => {
            const cards = Array.from(document.querySelectorAll('.element-card[data-element], .favorite-chip[data-element]'));
            cards.forEach(card => {
                card.setAttribute('draggable', 'true');
                card.addEventListener('click', (event) => {
                    if (event.target?.closest?.('[data-symbol-action]') || event.target?.closest?.('[data-symbol-actions]')) {
                        return;
                    }
                    const type = card.getAttribute('data-element') || '';
                    if (type) lastPaletteType = type;
                    insertElementFromPalette(type, null);
                });
                card.addEventListener('dragstart', (event) => {
                    const type = card.getAttribute('data-element') || '';
                    if (type) lastPaletteType = type;
                    event.dataTransfer?.setData('text/plain', type);
                    event.dataTransfer?.setData('application/x-bugence-element', type);
                    if (event.dataTransfer) event.dataTransfer.effectAllowed = 'copy';
                    dragGhostSize = getGhostSizeForType(type, getCanvasDocument());
                });
                card.addEventListener('dragend', () => {
                    dragGhostSize = null;
                });
            });
        };

        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', (event) => {
                event.stopPropagation();
                const tool = btn.getAttribute('data-tool');
                if (tool === 'drawer') {
                    toggleToolDrawer(btn.getAttribute('data-drawer'));
                    return;
                }
                setToolDrawerOpen(false);
                if (tool === 'elements') {
                    setActiveToolButton(btn);
                    closeUtilityPanel();
                    document.querySelector('.tab[data-tab="elements"]')?.click();
                    return;
                }
                if (tool === 'layers') {
                    setActiveToolButton(btn);
                    closeUtilityPanel();
                    if (controlRefs.structureFloating?.classList.contains('hidden')) {
                        setStructureDocked(false);
                    } else {
                        controlRefs.structureFloating?.classList.add('hidden');
                        controlRefs.structureDockPill?.classList.add('show');
                    }
                    return;
                }
                if (tool === 'utility') {
                    setActiveToolButton(btn);
                    toggleUtilityPanel(btn.getAttribute('data-utility'));
                }
            });
        });
        document.querySelectorAll('.asset-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabValue = tab.getAttribute('data-asset-tab') || 'all';
                assetFilter = tabValue;
                openAssetModal(tabValue);
            });
        });
        document.addEventListener('click', (event) => {
            if (controlRefs.toolDrawer?.classList.contains('is-open')) {
                if (!event.target?.closest?.('#toolDrawer') && !event.target?.closest?.('.tool-btn[data-tool="drawer"]')) {
                    setToolDrawerOpen(false);
                }
            }
            if (controlRefs.utilityPanel?.classList.contains('is-open')) {
                if (!event.target?.closest?.('#utilityPanel') && !event.target?.closest?.('.tool-btn[data-tool="utility"]')) {
                    closeUtilityPanel();
                }
            }
        });
        controlRefs.toolDrawer?.addEventListener('click', (event) => {
            const shape = event.target?.closest?.('[data-tool-shape]');
            if (shape) {
                const type = shape.getAttribute('data-tool-shape');
                if (type) insertElementFromPalette(type, null);
                return;
            }
            const toggle = event.target?.closest?.('[data-tool-toggle]');
            if (toggle) {
                const mode = toggle.getAttribute('data-tool-toggle');
                if (mode === 'canvas-grid') {
                    const enabled = localStorage.getItem('bugence-canvas-grid') !== '1';
                    toggleCanvasGrid(enabled);
                }
                if (mode === 'focus-mode') {
                    const enabled = !document.body.classList.contains('focus-mode');
                    toggleFocusMode(enabled);
                }
            }
        });
        controlRefs.canvasToolbar?.addEventListener('click', (event) => {
            const zoomButton = event.target?.closest?.('[data-zoom]');
            if (zoomButton) {
                const action = zoomButton.getAttribute('data-zoom');
                if (action === 'in') {
                    applyCanvasZoom(canvasZoom + 0.1);
                } else if (action === 'out') {
                    applyCanvasZoom(canvasZoom - 0.1);
                } else if (action === 'reset') {
                    applyCanvasZoom(1);
                }
                return;
            }
            const canvasAction = event.target?.closest?.('[data-canvas-action]');
            if (!canvasAction) return;
            const action = canvasAction.getAttribute('data-canvas-action');
            if (action === 'fit') {
                fitCanvasToView();
            } else if (action === 'grid') {
                const enabled = localStorage.getItem('bugence-canvas-grid') !== '1';
                toggleCanvasGrid(enabled);
            } else if (action === 'center') {
                const doc = getCanvasDocument();
                doc?.documentElement?.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
            }
        });

        controlRefs.utilityCloseBtn?.addEventListener('click', () => {
            closeUtilityPanel();
        });
        controlRefs.launchAiStudioBtn?.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            openUtilityPanel('ai');
            const aiTool = document.querySelector('.tool-btn[data-tool="utility"][data-utility="ai"]');
            if (aiTool) {
                setActiveToolButton(aiTool);
            }
            controlRefs.aiPromptInput?.focus();
        });
        controlRefs.canvasSearchInput?.addEventListener('input', (event) => {
            runCanvasSearch(event.target?.value);
        });
        controlRefs.iconSearchInput?.addEventListener('input', (event) => {
            renderIconGrid(event.target?.value || '');
        });
        controlRefs.iconGrid?.addEventListener('click', (event) => {
            const card = event.target?.closest?.('[data-icon-class]');
            if (!card) return;
            const iconClass = card.getAttribute('data-icon-class');
            if (!iconClass) return;
            insertElementFromPalette('icon', null, null, { iconClass });
        });
        document.querySelectorAll('[data-ai-action]').forEach(btn => {
            btn.addEventListener('click', () => {
                const action = btn.getAttribute('data-ai-action');
                if (action) handleAiAction(action);
            });
        });
        controlRefs.motionPropertySelect?.addEventListener('change', () => {
            const track = getActiveMotionTrack();
            if (controlRefs.motionEasingSelect && track?.easing) {
                controlRefs.motionEasingSelect.value = track.easing;
            }
            updateMotionBadge();
            renderMotionKeyframes();
        });
        controlRefs.motionEasingSelect?.addEventListener('change', () => {
            const track = getActiveMotionTrack();
            if (!track) return;
            track.easing = controlRefs.motionEasingSelect?.value || 'linear';
            persistMotionState();
        });
        controlRefs.motionPlayhead?.addEventListener('input', (event) => {
            motionPlayheadValue = parseFloat(event.target?.value) || 0;
            if (controlRefs.motionPlayheadValue) {
                controlRefs.motionPlayheadValue.textContent = `${Math.round(motionPlayheadValue)}%`;
            }
            previewMotionAt(motionPlayheadValue);
        });
        if (controlRefs.motionPlayhead && controlRefs.motionPlayheadValue) {
            motionPlayheadValue = parseFloat(controlRefs.motionPlayhead.value) || 0;
            controlRefs.motionPlayheadValue.textContent = `${Math.round(motionPlayheadValue)}%`;
        }
        controlRefs.motionAddKeyframeBtn?.addEventListener('click', () => {
            const target = getMotionTarget();
            if (!target) {
                showToast('Select an element to add keyframes.');
                return;
            }
            const track = getActiveMotionTrack();
            if (!track) return;
            const value = captureMotionValue(target, track.property);
            const existing = track.keyframes.find(kf => kf.t === motionPlayheadValue);
            if (existing) {
                existing.value = value;
            } else {
                track.keyframes.push({ t: motionPlayheadValue, value });
            }
            persistMotionState();
            renderMotionKeyframes();
        });
        controlRefs.motionClearKeyframesBtn?.addEventListener('click', () => {
            const track = getActiveMotionTrack();
            if (!track) return;
            track.keyframes = [];
            persistMotionState();
            renderMotionKeyframes();
        });
        controlRefs.motionScrollEnabled?.addEventListener('change', updateMotionScrollSettings);
        controlRefs.motionScrollStart?.addEventListener('input', updateMotionScrollSettings);
        controlRefs.motionScrollEnd?.addEventListener('input', updateMotionScrollSettings);
        controlRefs.motionScrollScrub?.addEventListener('input', updateMotionScrollSettings);
        controlRefs.applyLottieBtn?.addEventListener('click', () => {
            const target = getMotionTarget();
            const doc = getCanvasDocument();
            const url = controlRefs.lottieUrlInput?.value?.trim();
            if (!target || !doc || !url) {
                showToast('Select an element and provide a Lottie URL.');
                return;
            }
            const id = ensureBugenceId(target);
            if (!id) return;
            const loop = !!controlRefs.lottieLoopInput?.checked;
            const autoplay = !!controlRefs.lottieAutoplayInput?.checked;
            sendToIframe('bugence-editor:lottie-apply', {
                selector: `[data-bugence-id="${id}"]`,
                url,
                loop,
                autoplay
            });
            scheduleHistorySnapshot();
            scheduleAutoSave();
        });
        controlRefs.pickLottieBtn?.addEventListener('click', () => {
            assetPickerContext = 'lottie';
            openAssetModal('lottie');
        });
        controlRefs.lottieScrubBtn?.addEventListener('click', () => {
            const target = getMotionTarget();
            if (!target) return;
            const id = ensureBugenceId(target);
            if (!id) return;
            sendToIframe('bugence-editor:lottie-seek', {
                selector: `[data-bugence-id="${id}"]`,
                progress: motionPlayheadValue
            });
        });
        document.querySelectorAll('[data-style-action]').forEach(btn => {
            btn.addEventListener('click', () => {
                const action = btn.getAttribute('data-style-action');
                if (action) applyStyleAction(action);
            });
        });
        document.querySelectorAll('[data-setting]').forEach(btn => {
            btn.addEventListener('click', () => {
                const setting = btn.getAttribute('data-setting');
                if (setting === 'grid') {
                    const enabled = localStorage.getItem('bugence-canvas-grid') !== '1';
                    toggleCanvasGrid(enabled);
                } else if (setting === 'focus') {
                    const enabled = !document.body.classList.contains('focus-mode');
                    toggleFocusMode(enabled);
                } else if (setting === 'inline-add') {
                    setInlineAddEnabled(!inlineAddEnabled);
                }
            });
        });
        controlRefs.historyUndoBtn?.addEventListener('click', () => {
            controlRefs.undoBtn?.click();
        });
        controlRefs.historyRedoBtn?.addEventListener('click', () => {
            controlRefs.redoBtn?.click();
        });
        controlRefs.historyClearBtn?.addEventListener('click', () => {
            historyOps = [];
            historyIndex = -1;
            pendingHistory = null;
            updateHistoryButtons();
        });
        controlRefs.variantCloseBtn?.addEventListener('click', closeVariantModal);
        controlRefs.variantModal?.addEventListener('click', (event) => {
            if (event.target === controlRefs.variantModal) {
                closeVariantModal();
            }
        });
        document.addEventListener('keydown', (event) => {
            if (event.key !== 'Escape') return;
            if (controlRefs.variantModal?.classList.contains('active')) {
                closeVariantModal();
            }
            if (controlRefs.templateModal?.classList.contains('active')) {
                closeTemplateModal();
            }
            if (controlRefs.shareModal?.classList.contains('active')) {
                closeShareModal();
            }
            if (isMobileEditorViewport()) {
                setMobilePanelOpen('left', false);
                setMobilePanelOpen('right', false);
                closeUtilityPanel();
            }
        });
        controlRefs.resetEditorThemeBtn?.addEventListener('click', () => {
            const fallback = editorThemePresets[0];
            applyEditorTheme(fallback.id, fallback.vars);
        });
        controlRefs.saveCustomThemeBtn?.addEventListener('click', () => {
            createCustomTheme(controlRefs.customThemeName?.value);
        });
        controlRefs.leftPanelToggle?.addEventListener('click', () => {
            if (isMobileEditorViewport()) {
                const open = !document.body.classList.contains('editor-mobile-left-open');
                setMobilePanelOpen('left', open);
                closeUtilityPanel();
                return;
            }
            localStorage.setItem('bugence-left-collapsed-set', '1');
            const collapsed = !document.body.classList.contains('left-collapsed');
            setLeftSidebarCollapsed(collapsed);
        });
        controlRefs.rightPanelToggle?.addEventListener('click', () => {
            if (isMobileEditorViewport()) {
                const open = !document.body.classList.contains('editor-mobile-right-open');
                setMobilePanelOpen('right', open);
                closeUtilityPanel();
                return;
            }
            localStorage.setItem('bugence-right-collapsed-set', '1');
            const collapsed = !document.body.classList.contains('right-collapsed');
            setRightSidebarCollapsed(collapsed);
        });
        controlRefs.mobileLeftPanelBtn?.addEventListener('click', () => {
            const open = !document.body.classList.contains('editor-mobile-left-open');
            setMobilePanelOpen('left', open);
            closeUtilityPanel();
        });
        controlRefs.mobileRightPanelBtn?.addEventListener('click', () => {
            const open = !document.body.classList.contains('editor-mobile-right-open');
            setMobilePanelOpen('right', open);
            closeUtilityPanel();
        });

        document.addEventListener('click', (event) => {
            const pin = event.target?.closest?.('.el-pin');
            if (!pin) return;
            event.preventDefault();
            event.stopPropagation();
            const id = pin.getAttribute('data-pin');
            if (!id) return;
            const current = loadFavorites();
            const next = current.includes(id)
                ? current.filter(item => item !== id)
                : [...current, id];
            saveFavorites(next);
            buildFavorites();
            buildElementsCatalog(controlRefs.elementsSearch?.value || '');
            bindPaletteInteractions();
        });

        document.addEventListener('click', (event) => {
            const actionBtn = event.target?.closest?.('[data-symbol-action]');
            if (!actionBtn) return;
            event.preventDefault();
            event.stopPropagation();
            const action = actionBtn.getAttribute('data-symbol-action');
            const symbolId = actionBtn.getAttribute('data-symbol-id');
            if (!action || !symbolId) return;
            const symbols = loadSymbols();
            const index = symbols.findIndex(item => item.id === symbolId);
            if (index === -1) return;
            if (action === 'rename') {
                const name = window.prompt('Rename symbol', symbols[index].name || '');
                if (!name || !name.trim()) return;
                symbols[index].name = name.trim();
                symbols[index].updatedAt = new Date().toISOString();
                persistSymbols(symbols);
                buildElementsCatalog(controlRefs.elementsSearch?.value || '');
                bindPaletteInteractions();
            }
            if (action === 'delete') {
                if (!window.confirm('Delete this symbol? Existing instances will remain on the canvas.')) return;
                const next = symbols.filter(item => item.id !== symbolId);
                persistSymbols(next);
                buildElementsCatalog(controlRefs.elementsSearch?.value || '');
                bindPaletteInteractions();
            }
            if (action === 'update') {
                const el = getSelectedElementNode();
                if (!el) {
                    alert('Select an element on the canvas to update this symbol.');
                    return;
                }
                symbols[index] = {
                    ...symbols[index],
                    html: el.outerHTML,
                    updatedAt: new Date().toISOString()
                };
                persistSymbols(symbols);
                updateSymbolInstances(symbolId, el.outerHTML);
            }
        });

        window.addEventListener('resize', () => {
            if (!isMobileEditorViewport()) {
                document.body.classList.remove('editor-mobile-left-open', 'editor-mobile-right-open');
            }
        });

        const initFavoritesDrag = () => {
            const container = controlRefs.elementsFavorites;
            if (!container) return;
            let dragId = null;
            container.addEventListener('dragstart', (event) => {
                const chip = event.target?.closest?.('.favorite-chip');
                if (!chip) return;
                dragId = chip.getAttribute('data-element');
                chip.classList.add('dragging');
                event.dataTransfer?.setData('text/plain', dragId || '');
                if (event.dataTransfer) event.dataTransfer.effectAllowed = 'move';
            });
            container.addEventListener('dragend', (event) => {
                const chip = event.target?.closest?.('.favorite-chip');
                chip?.classList.remove('dragging');
                dragId = null;
            });
            container.addEventListener('dragover', (event) => {
                event.preventDefault();
                const chip = event.target?.closest?.('.favorite-chip');
                if (!chip || !dragId) return;
                const dragging = container.querySelector('.favorite-chip.dragging');
                if (!dragging || dragging === chip) return;
                const rect = chip.getBoundingClientRect();
                const before = event.clientX < rect.left + rect.width / 2;
                container.insertBefore(dragging, before ? chip : chip.nextSibling);
            });
            container.addEventListener('drop', (event) => {
                event.preventDefault();
                const ordered = Array.from(container.querySelectorAll('.favorite-chip'))
                    .map(chip => chip.getAttribute('data-element'))
                    .filter(Boolean);
                saveFavorites(ordered);
            });
        };

        const bindIframeDropzone = () => {
            const doc = getCanvasDocument();
            if (!doc) return;
            let dropMarker = doc.getElementById('bugence-drop-marker');
            let dropGhost = doc.getElementById('bugence-drop-ghost');
            let dropLabel = doc.getElementById('bugence-drop-label');
            let dropStyle = doc.getElementById('bugence-drop-style');
            let rafPending = false;
            let dropPreview = { target: null, position: 'after' };
            const scrollEl = doc.scrollingElement || doc.documentElement;
            const clearDropIndicators = () => {
                if (dropMarker) dropMarker.style.display = 'none';
                if (dropGhost) dropGhost.style.display = 'none';
                if (dropLabel) dropLabel.style.display = 'none';
                dropPreview = { target: null, position: 'after' };
            };
            const autoScroll = (event) => {
                if (!scrollEl) return;
                const viewHeight = doc.documentElement.clientHeight || doc.defaultView?.innerHeight || 0;
                if (!viewHeight) return;
                const threshold = 70;
                const speed = 18;
                if (event.clientY < threshold) {
                    scrollEl.scrollTop -= speed;
                } else if (event.clientY > viewHeight - threshold) {
                    scrollEl.scrollTop += speed;
                }
            };

            const ensureDropMarker = () => {
                if (!dropStyle) {
                    dropStyle = doc.createElement('style');
                    dropStyle.id = 'bugence-drop-style';
                    dropStyle.textContent = `
                        #bugence-drop-marker{
                            position: fixed;
                            height: 2px;
                            background: rgba(6,182,212,0.95);
                            box-shadow: 0 0 0 1px rgba(6,182,212,0.35), 0 6px 18px rgba(6,182,212,0.35);
                            border-radius: 999px;
                            pointer-events: none;
                            z-index: 2147483646;
                            display: none;
                        }
                        #bugence-drop-ghost{
                            position: fixed;
                            border: 2px dashed rgba(6,182,212,0.65);
                            background: rgba(6,182,212,0.08);
                            border-radius: 10px;
                            pointer-events: none;
                            z-index: 2147483645;
                            display: none;
                            transition: width 0.08s ease, height 0.08s ease;
                        }
                        #bugence-drop-label{
                            position: fixed;
                            pointer-events: none;
                            z-index: 2147483647;
                            display: none;
                            padding: 4px 8px;
                            border-radius: 999px;
                            border: 1px solid rgba(6,182,212,0.65);
                            background: rgba(2,8,23,0.92);
                            color: #67e8f9;
                            font-size: 11px;
                            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
                            white-space: nowrap;
                        }
                    `;
                    doc.head?.appendChild(dropStyle);
                }
                if (!dropMarker) {
                    dropMarker = doc.createElement('div');
                    dropMarker.id = 'bugence-drop-marker';
                    dropMarker.setAttribute('data-bugence-editor', 'true');
                    doc.body?.appendChild(dropMarker);
                }
                if (!dropGhost) {
                    dropGhost = doc.createElement('div');
                    dropGhost.id = 'bugence-drop-ghost';
                    dropGhost.setAttribute('data-bugence-editor', 'true');
                    doc.body?.appendChild(dropGhost);
                }
                if (!dropLabel) {
                    dropLabel = doc.createElement('div');
                    dropLabel.id = 'bugence-drop-label';
                    dropLabel.setAttribute('data-bugence-editor', 'true');
                    doc.body?.appendChild(dropLabel);
                }
            };

            const isEditorOverlay = (el) => el?.closest?.('[data-bugence-editor="true"]');
            const pickTarget = (event) => {
                const stack = doc.elementsFromPoint
                    ? doc.elementsFromPoint(event.clientX, event.clientY)
                    : [doc.elementFromPoint(event.clientX, event.clientY)];
                for (const el of stack) {
                    if (!el) continue;
                    if (isEditorOverlay(el)) continue;
                    const container = resolveDropContainer(el);
                    if (container) return container;
                    return el;
                }
                return doc.body;
            };

            const updateMarker = (event) => {
                ensureDropMarker();
                const target = pickTarget(event);
                if (!target) return;
                const rect = target.getBoundingClientRect();
                if (!rect) return;
                const canNest = isDropContainer(target) && !isInlineElement(target);
                const pointerRatio = rect.height > 0 ? ((event.clientY - rect.top) / rect.height) : 0.5;
                const topThreshold = 0.28;
                const bottomThreshold = 0.72;
                const before = pointerRatio <= topThreshold;
                const after = pointerRatio >= bottomThreshold;
                const inside = canNest && !before && !after;
                const top = before ? rect.top : rect.bottom;
                if (inside) {
                    dropMarker.style.display = 'none';
                    const inset = Math.min(12, Math.max(6, rect.width * 0.02));
                    const ghostLeft = rect.left + inset;
                    const ghostTop = rect.top + inset;
                    const ghostWidth = Math.max(60, rect.width - inset * 2);
                    const ghostHeight = Math.max(40, rect.height - inset * 2);
                    dropGhost.style.left = `${ghostLeft}px`;
                    dropGhost.style.top = `${ghostTop}px`;
                    dropGhost.style.width = `${ghostWidth}px`;
                    dropGhost.style.height = `${ghostHeight}px`;
                    dropGhost.style.display = 'block';
                    dropPreview = { target, position: 'inside' };
                } else {
                    dropMarker.style.left = `${rect.left}px`;
                    dropMarker.style.top = `${top}px`;
                    dropMarker.style.width = `${Math.max(40, rect.width)}px`;
                    dropMarker.style.display = 'block';
                    const ghostWidth = dragGhostSize?.width || Math.max(40, rect.width);
                    const ghostHeight = dragGhostSize?.height || Math.max(28, rect.height);
                    const ghostLeft = rect.left;
                    const ghostTop = before ? rect.top : Math.min(rect.bottom, rect.top + rect.height - ghostHeight);
                    dropGhost.style.left = `${ghostLeft}px`;
                    dropGhost.style.top = `${ghostTop}px`;
                    dropGhost.style.width = `${ghostWidth}px`;
                    dropGhost.style.height = `${ghostHeight}px`;
                    dropGhost.style.display = 'block';
                    dropPreview = { target, position: before ? 'before' : 'after' };
                }
                const tag = target.tagName?.toLowerCase() || 'element';
                const classLabel = (target.className || '').toString().trim().split(/\s+/).filter(Boolean)[0];
                const targetLabel = classLabel ? `${tag}.${classLabel}` : tag;
                const mode = inside ? 'inside' : (before ? 'before' : 'after');
                dropLabel.textContent = `Insert ${mode} <${targetLabel}>`;
                dropLabel.style.left = `${Math.max(10, rect.left)}px`;
                dropLabel.style.top = `${Math.max(8, rect.top - 26)}px`;
                dropLabel.style.display = 'block';
            };

            doc.addEventListener('dragover', (event) => {
                event.preventDefault();
                event.stopPropagation();
                if (event.dataTransfer) {
                    const isMove = Boolean(event.dataTransfer.getData('application/x-bugence-struct') || event.dataTransfer.getData('application/x-bugence-node'));
                    event.dataTransfer.dropEffect = isMove ? 'move' : 'copy';
                }
                autoScroll(event);
                if (rafPending) return;
                rafPending = true;
                requestAnimationFrame(() => {
                    rafPending = false;
                    updateMarker(event);
                });
            });
            doc.addEventListener('dragleave', (event) => {
                if (!doc.contains(event.relatedTarget)) {
                    clearDropIndicators();
                }
            });
            doc.addEventListener('drop', (event) => {
                event.preventDefault();
                event.stopPropagation();
                const preview = { ...dropPreview };
                clearDropIndicators();
                const structId = event.dataTransfer?.getData('application/x-bugence-struct')
                    || event.dataTransfer?.getData('application/x-bugence-node');
                if (structId) {
                    const moving = doc.querySelector(`[data-bugence-id="${structId}"]`);
                    const target = preview.target || pickTarget(event) || event.target;
                    if (!moving || !target || moving === target) return;
                    const fromParent = moving.parentElement;
                    const fromIndex = fromParent ? Array.from(fromParent.children).indexOf(moving) : -1;
                    const position = preview.position || (isDropContainer(target) ? 'inside' : 'after');
                    if (position === 'inside') {
                        if (!canMoveInside(moving, target)) return;
                        const container = resolveDropContainer(target) || target;
                        container.appendChild(moving);
                    } else if (position === 'before' && target.parentElement && !moving.contains(target)) {
                        target.parentElement.insertBefore(moving, target);
                    } else if (target.parentElement && !moving.contains(target)) {
                        target.parentElement.insertBefore(moving, target.nextSibling);
                    }
                    const toParent = moving.parentElement;
                    const toIndex = toParent ? Array.from(toParent.children).indexOf(moving) : -1;
                    if (fromParent && toParent && fromIndex !== -1 && toIndex !== -1 && (fromParent !== toParent || fromIndex !== toIndex)) {
                        pushHistoryOp({
                            type: 'move',
                            targetId: structId,
                            fromParentId: ensureBugenceId(fromParent),
                            fromIndex,
                            toParentId: ensureBugenceId(toParent),
                            toIndex
                        });
                        markEdit('structural');
                        scheduleAutoSave();
                        rebuildInlineAdd();
                        scheduleStructureUpdate();
                    }
                    return;
                }
                const type = event.dataTransfer?.getData('application/x-bugence-element')
                    || event.dataTransfer?.getData('text/plain');
                if (!type) return;
                const target = preview.target || pickTarget(event) || event.target;
                const position = preview.position
                    || ((isDropContainer(target) && !isInlineElement(target)) ? 'inside' : 'after');
                insertElementFromPalette(type, target, position);
            });
            doc.addEventListener('dragend', clearDropIndicators);
            doc.addEventListener('dragstart', (event) => {
                if (event.target?.closest?.('[data-bugence-type="gallery"]')) return;
                event.preventDefault();
            });
        };

        const initializeEditorState = async () => {
            await fetchSymbols();
            await fetchDesignSystemState();
            refreshTokenPresetSelect();
            const initialTokens = loadDesignTokens();
            syncDesignTokenInputs(initialTokens);
            applyDesignTokensToIframe(initialTokens);
            buildElementsCatalog();
            buildFavorites();
            bindPaletteInteractions();
            initFavoritesDrag();
            await loadPagesState();
            refreshPagesList();
            syncMotionControlsFromSelection();
            initStructurePanel();
            initStructureDragging();
        };
        const bootstrapEditor = async () => {
            await loadEditorPrefs();
            await initializeEditorState();
            applyCanvasZoom(1);
            syncSidebarCollapseState();
            initSettingsTabs();
            renderEditorThemeCards();
            bindEditorThemeInputs();
            loadEditorTheme();
            syncUtilitySettingsState();
            toggleFocusMode(localStorage.getItem('bugence-focus-mode') === '1');
            setLiveCanvasEnabled(liveCanvasEnabled);
        };
        bootstrapEditor();
        controlRefs.elementsSearch?.addEventListener('input', (event) => {
            buildElementsCatalog(event.target?.value);
            bindPaletteInteractions();
        });
        controlRefs.pagesSearch?.addEventListener('input', (event) => {
            renderPagesList(event.target?.value);
        });
        controlRefs.newPageBtn?.addEventListener('click', () => {
            togglePagesForm(true);
            controlRefs.pageNameInput?.focus();
        });
        controlRefs.createNewBtn?.addEventListener('click', () => {
            document.querySelector('.tab[data-tab="pages"]')?.click();
            togglePagesForm(true);
            controlRefs.pageNameInput?.focus();
        });
        controlRefs.templatesBtn?.addEventListener('click', openTemplateModal);
        controlRefs.shareBtn?.addEventListener('click', openShareModal);
        controlRefs.liveCanvasToggle?.addEventListener('click', () => {
            setLiveCanvasEnabled(!liveCanvasEnabled);
        });
        controlRefs.resumeCanvasBtn?.addEventListener('click', () => {
            setLiveCanvasEnabled(true);
        });
        controlRefs.cancelPageBtn?.addEventListener('click', () => {
            togglePagesForm(false);
        });
        controlRefs.pageNameInput?.addEventListener('input', (event) => {
            if (!controlRefs.pagePathInput || controlRefs.pagePathInput.value) return;
            const guess = slugifyPageName(event.target?.value || '');
            if (guess) {
                controlRefs.pagePathInput.value = `${guess}.html`;
            }
        });
        controlRefs.templatePageNameInput?.addEventListener('input', (event) => {
            if (!controlRefs.templatePagePathInput || controlRefs.templatePagePathInput.value) return;
            const guess = slugifyPageName(event.target?.value || '');
            if (guess) {
                controlRefs.templatePagePathInput.value = `${guess}.html`;
            }
        });
        controlRefs.templateSearchInput?.addEventListener('input', renderTemplateGrid);
        controlRefs.templateApplyBtn?.addEventListener('click', applyTemplateToCurrentPage);
        controlRefs.templateCreateBtn?.addEventListener('click', async () => {
            const created = await createPageFromTemplate({
                name: controlRefs.templatePageNameInput?.value || '',
                path: controlRefs.templatePagePathInput?.value || '',
                template: selectedTemplateId || 'blank'
            });
            if (created) closeTemplateModal();
        });
        controlRefs.templateCloseBtn?.addEventListener('click', closeTemplateModal);
        controlRefs.templateModal?.addEventListener('click', (event) => {
            if (event.target === controlRefs.templateModal) closeTemplateModal();
        });
        controlRefs.shareCloseBtn?.addEventListener('click', closeShareModal);
        controlRefs.shareModal?.addEventListener('click', async (event) => {
            if (event.target === controlRefs.shareModal) closeShareModal();
            const copyBtn = event.target?.closest?.('[data-share-copy]');
            if (!copyBtn) return;
            const type = copyBtn.getAttribute('data-share-copy');
            const links = getShareLinks();
            const value = type === 'editor' ? links.editorLink
                : type === 'preview' ? links.previewLink
                : links.publishedLink;
            const ok = await copyToClipboard(value);
            showToast(ok ? 'Link copied.' : 'Copy failed.');
        });
        controlRefs.createPageBtn?.addEventListener('click', async () => {
            await createPageFromTemplate({
                name: controlRefs.pageNameInput?.value || '',
                path: controlRefs.pagePathInput?.value || '',
                template: controlRefs.pageTemplateInput?.value || 'blank'
            });
        });
        controlRefs.pagesList?.addEventListener('click', (event) => {
            const card = event.target?.closest?.('.page-card');
            if (!card) return;
            const pageId = card.getAttribute('data-page-id');
            const page = pageId ? getPageById(pageId) : null;
            if (!page) return;
            const actionBtn = event.target?.closest?.('[data-page-action]');
            if (!actionBtn) {
                openPage(page);
                return;
            }
            const action = actionBtn.getAttribute('data-page-action');
            if (action === 'open') {
                openPage(page);
            } else if (action === 'rename') {
                renamePage(page);
            } else if (action === 'duplicate') {
                duplicatePage(page);
            } else if (action === 'status') {
                togglePageStatus(page);
            } else if (action === 'home') {
                setHomePage(page);
            } else if (action === 'delete') {
                deletePage(page);
            }
        });
        editorIframe?.addEventListener('load', () => {
            multiSelectStyleInjected = false;
            setTimeout(rebuildInlineAdd, 120);
            setTimeout(buildStructureTree, 180);
            setTimeout(initIframeEnhancements, 220);
            setTimeout(initSectionAddOverlay, 240);
            setTimeout(initSelectionOverlay, 240);
            setTimeout(() => {
                if (localStorage.getItem('bugence-canvas-grid') === '1') {
                    toggleCanvasGrid(true);
                }
            }, 260);
            setTimeout(() => {
                applyDesignTokensToIframe();
            }, 280);
            setTimeout(() => {
                sendToIframe('bugence-editor:live-mode', { enabled: liveCanvasEnabled });
            }, 320);
            setTimeout(async () => {
                const raw = getIframeHtml();
                const normalized = normalizeEditorUrls(raw);
                if (normalized) {
                    await runIntegrityCheck(raw || '', normalized, false);
                    baselineNormalizedHtml = normalized;
                    lastSavedNormalizedHtml = normalized;
                    resetEditTracker();
                }
            }, 360);
        });
        editorIframe?.addEventListener('load', bindIframeDropzone);
        if (editorIframe?.contentDocument?.readyState === 'complete') {
            bindIframeDropzone();
        }

        function getIframeHtml() {
            const iframe = document.querySelector('.canvas-frame');
            const doc = iframe?.contentDocument;
            if (!doc) return null;
            return doc.documentElement.outerHTML;
        }

        function reloadIframe(targetFile) {
            if (!editorIframe) return;
            const nextFile = targetFile || filePath || 'index.html';
            const encoded = encodeURIComponent(nextFile);
            editorIframe.src = `${previewPrefix}${encoded}&t=${Date.now()}`;
        }

        const getProjectUploadsRoot = () => {
            const fromModel = (projectResolvedPath || '').trim();
            if (fromModel) {
                return `/${fromModel.replace(/^\/+/, '').replace(/\/+$/, '')}`;
            }
            const fallbackName = (projectFolder || '').trim().replace(/^\/+|\/+$/g, '');
            return fallbackName ? `/Uploads/${fallbackName}` : '/Uploads';
        };

        function normalizeEditorUrls(html) {
            if (!html) return html;
            const decodePath = (path) => {
                try { return decodeURIComponent(path); } catch { return path; }
            };
            const stripAmp = (value) => (value && value.includes('&amp;'))
                ? value.split('&amp;').join('&')
                : value;
            const projectUploadsRoot = getProjectUploadsRoot();
            const unwrapEditorUrl = (value) => {
                if (!value) return value;
                const trimmed = value.trim();
                if (!trimmed.startsWith('/Editor?')) {
                    return trimmed;
                }
                let current = stripAmp(trimmed);
                for (let i = 0; i < 5; i += 1) {
                    if (!current.startsWith('/Editor?')) break;
                    const queryIndex = current.indexOf('?');
                    if (queryIndex === -1) break;
                    const params = new URLSearchParams(current.slice(queryIndex + 1));
                    const handler = (params.get('handler') || '').trim().toLowerCase();
                    const key = handler === 'preview'
                        ? 'file'
                        : (handler === 'asset' ? 'path' : null);
                    if (!key) break;
                    const nextValue = params.get(key);
                    if (!nextValue) break;
                    const clean = stripAmp(decodePath(nextValue)).replace(/^\/+/, '');
                    if (!clean) break;
                    if (handler === 'preview') {
                        current = `/${clean}`;
                    } else {
                        current = `${projectUploadsRoot}/${clean}`;
                    }
                }
                return current;
            };
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            doc.querySelectorAll('[data-bugence-editor="true"]').forEach(el => el.remove());
            doc.getElementById('bugence-editor-bridge-style')?.remove();
            doc.getElementById('bugence-editor-bridge')?.remove();
            doc.querySelectorAll('base').forEach(el => {
                const href = stripAmp((el.getAttribute('href') || '').trim());
                const isPreviewBase = href.startsWith('/Editor?handler=Preview') || href.startsWith('/Editor?handler=preview');
                const isTaggedPreviewBase = el.getAttribute('data-bugence-preview') === 'true';
                if (!isPreviewBase && !isTaggedPreviewBase) {
                    return;
                }
                const originalHref = el.getAttribute('data-bugence-original-href');
                if (originalHref) {
                    el.setAttribute('href', originalHref);
                    el.removeAttribute('data-bugence-preview');
                    el.removeAttribute('data-bugence-original-href');
                    return;
                }
                el.remove();
            });
            doc.querySelectorAll('script[src="/_framework/aspnetcore-browser-refresh.js"]').forEach(el => el.remove());
            doc.querySelectorAll('script[src^="/_vs/browserLink"]').forEach(el => el.remove());
            doc.querySelectorAll('#bugence-workflow-runner').forEach((node, index) => {
                if (index > 0) node.remove();
            });
            const existingRunner = doc.getElementById('bugence-workflow-runner');
            if (existingRunner && existingRunner.tagName.toLowerCase() === 'script') {
                existingRunner.removeAttribute('data-bugence-inline');
                existingRunner.textContent = '';
                existingRunner.setAttribute('src', '/js/workflow-trigger-runner.js');
            } else if (!existingRunner) {
                const script = doc.createElement('script');
                script.id = 'bugence-workflow-runner';
                script.setAttribute('src', '/js/workflow-trigger-runner.js');
                doc.body.appendChild(script);
            }
            doc.querySelectorAll('[src]').forEach(el => {
                const value = el.getAttribute('src');
                const normalized = unwrapEditorUrl(value || '');
                if (normalized && normalized !== value) {
                    el.setAttribute('src', normalized);
                }
            });
            doc.querySelectorAll('[href]').forEach(el => {
                const value = el.getAttribute('href');
                const normalized = unwrapEditorUrl(value || '');
                if (normalized && normalized !== value) {
                    el.setAttribute('href', normalized);
                }
            });
            doc.querySelectorAll('[srcset]').forEach(el => {
                const value = el.getAttribute('srcset');
                if (!value) return;
                const parts = value.split(',');
                const normalizedParts = parts.map(part => {
                    const trimmed = part.trim();
                    if (!trimmed) return trimmed;
                    const segments = trimmed.split(/\s+/, 2);
                    const url = segments[0];
                    const descriptor = segments[1] ? ` ${segments[1]}` : '';
                    const normalized = unwrapEditorUrl(url);
                    return `${normalized}${descriptor}`;
                });
                const nextValue = normalizedParts.join(', ');
                if (nextValue !== value) {
                    el.setAttribute('srcset', nextValue);
                }
            });
            return doc.documentElement.outerHTML;
        }

        const normalizeAssetRef = (value) => {
            if (!value || typeof value !== 'string') return '';
            return value.trim().replace(/&amp;/g, '&');
        };

        const markEdit = (kind) => {
            if (kind === 'text') {
                editTracker.text += 1;
                return;
            }
            if (kind === 'style') {
                editTracker.style += 1;
                return;
            }
            editTracker.structural += 1;
        };

        const resetEditTracker = () => {
            editTracker.text = 0;
            editTracker.style = 0;
            editTracker.structural = 0;
        };

        const isTextOrStyleOnlyEdit = () => editTracker.structural === 0 && (editTracker.text > 0 || editTracker.style > 0);

        const parseHtmlSafe = (html) => {
            const parser = new DOMParser();
            return parser.parseFromString(html || '', 'text/html');
        };

        const stripEditorArtifactsFromDoc = (doc) => {
            doc.querySelectorAll('base[data-bugence-preview="true"]').forEach((node) => node.remove());
            doc.querySelectorAll('[data-bugence-editor="true"]').forEach((node) => node.remove());
            doc.getElementById('bugence-editor-bridge')?.remove();
            doc.getElementById('bugence-editor-bridge-style')?.remove();
        };

        const collectIntegritySignals = (html) => {
            const doc = parseHtmlSafe(html);
            const cssRefs = new Set();
            const jsRefs = new Set();
            const absoluteRefs = new Set();
            stripEditorArtifactsFromDoc(doc);

            doc.querySelectorAll('link[href]').forEach((el) => {
                const href = normalizeAssetRef(el.getAttribute('href') || '');
                if (!href) return;
                const rel = (el.getAttribute('rel') || '').toLowerCase();
                if (rel.includes('stylesheet')) cssRefs.add(href);
                if (href.startsWith('/') && !href.startsWith('/Editor?')) absoluteRefs.add(href);
            });

            doc.querySelectorAll('script[src]').forEach((el) => {
                const src = normalizeAssetRef(el.getAttribute('src') || '');
                if (!src) return;
                jsRefs.add(src);
                if (src.startsWith('/') && !src.startsWith('/Editor?')) absoluteRefs.add(src);
            });

            doc.querySelectorAll('[src],[poster],[href],[srcset]').forEach((el) => {
                const attrs = ['src', 'poster', 'href'];
                attrs.forEach((attr) => {
                    const val = normalizeAssetRef(el.getAttribute(attr) || '');
                    if (!val) return;
                    if (val.startsWith('/') && !val.startsWith('/Editor?')) absoluteRefs.add(val);
                });
                const srcset = el.getAttribute('srcset');
                if (!srcset) return;
                srcset.split(',').forEach((part) => {
                    const trimmed = part.trim();
                    if (!trimmed) return;
                    const url = trimmed.split(/\s+/, 1)[0];
                    const normalized = normalizeAssetRef(url);
                    if (normalized.startsWith('/') && !normalized.startsWith('/Editor?')) {
                        absoluteRefs.add(normalized);
                    }
                });
            });

            return {
                cssCount: cssRefs.size,
                jsCount: jsRefs.size,
                absoluteRefs,
                cssRefs,
                jsRefs
            };
        };

        const collectStructureSignals = (html) => {
            const doc = parseHtmlSafe(html);
            stripEditorArtifactsFromDoc(doc);
            return {
                mainCount: doc.querySelectorAll('main').length,
                sectionCount: doc.querySelectorAll('section').length,
                bodyChildCount: Array.from(doc.body?.children || []).length
            };
        };

        const setIntegrityBadge = ({ safe, cssCount, jsCount, missingCount, changedAbsoluteCount }) => {
            if (!controlRefs.integrityBadge) return;
            controlRefs.integrityBadge.classList.remove('is-safe', 'is-warning', 'is-error');
            if (safe) {
                controlRefs.integrityBadge.classList.add('is-safe');
            } else if ((changedAbsoluteCount || 0) <= 2) {
                controlRefs.integrityBadge.classList.add('is-warning');
            } else {
                controlRefs.integrityBadge.classList.add('is-error');
            }
            const missingText = typeof missingCount === 'number' ? missingCount : '-';
            controlRefs.integrityBadge.innerHTML = `<i class="fa-solid fa-shield-check"></i> Integrity: ${safe ? 'Safe' : 'Review'}  CSS ${cssCount}  JS ${jsCount}  Missing ${missingText}`;
        };

        const fetchMissingAssetsCount = async () => {
            try {
                const response = await fetch(`/Editor?handler=MissingAssets&projectId=${projectId}`);
                if (!response.ok) return null;
                const payload = await response.json();
                return Number(payload.count || 0);
            } catch {
                return null;
            }
        };

        const runIntegrityCheck = async (rawHtml, normalizedHtml, includeMissingCount) => {
            const before = collectIntegritySignals(rawHtml || '');
            const after = collectIntegritySignals(normalizedHtml || '');
            const changedAbsolute = Array.from(before.absoluteRefs).filter(ref => !after.absoluteRefs.has(ref));
            const safe = changedAbsolute.length === 0;
            const missingCount = includeMissingCount ? await fetchMissingAssetsCount() : null;
            setIntegrityBadge({
                safe,
                cssCount: after.cssCount,
                jsCount: after.jsCount,
                missingCount,
                changedAbsoluteCount: changedAbsolute.length
            });
            if (!safe) {
                showToast(`Integrity warning: ${changedAbsolute.length} absolute asset reference(s) changed.`);
            }
            return {
                safe,
                changedAbsolute,
                before,
                after
            };
        };

        const runTextStyleInvariantCheck = (normalizedHtml) => {
            if (!baselineNormalizedHtml || !isTextOrStyleOnlyEdit()) {
                return { safe: true, reasons: [] };
            }
            const before = collectIntegritySignals(baselineNormalizedHtml);
            const after = collectIntegritySignals(normalizedHtml || '');
            const beforeStruct = collectStructureSignals(baselineNormalizedHtml);
            const afterStruct = collectStructureSignals(normalizedHtml || '');
            const reasons = [];
            const removedCss = Array.from(before.cssRefs).filter((ref) => !after.cssRefs.has(ref));
            const removedJs = Array.from(before.jsRefs).filter((ref) => !after.jsRefs.has(ref));
            if (removedCss.length) reasons.push(`Removed CSS reference(s): ${removedCss.slice(0, 5).join(', ')}`);
            if (removedJs.length) reasons.push(`Removed JS reference(s): ${removedJs.slice(0, 5).join(', ')}`);
            if (beforeStruct.mainCount > 0 && afterStruct.mainCount === 0) reasons.push('Main container removed.');
            if (beforeStruct.sectionCount > 0 && afterStruct.sectionCount === 0) reasons.push('All section containers removed.');
            if (beforeStruct.bodyChildCount > 1 && afterStruct.bodyChildCount < 1) reasons.push('Body content collapsed unexpectedly.');
            return {
                safe: reasons.length === 0,
                reasons
            };
        };

        function postEditorChange(handler, html, targetFile, options) {
            const form = new URLSearchParams();
            form.append('projectId', projectId);
            form.append('file', targetFile || filePath || 'index.html');
            form.append('html', html || '');
            if (options?.overrideRisk) {
                form.append('overrideRisk', 'true');
            }
            form.append('__RequestVerificationToken', csrfToken);
            return fetch(`/Editor?handler=${handler}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: form
            }).then(r => {
                if (!r.ok) throw new Error('Save failed');
                return r.json();
            });
        }

        async function runServerPreflight(html) {
            const form = new URLSearchParams();
            form.append('projectId', projectId);
            form.append('file', filePath || 'index.html');
            form.append('html', html || '');
            form.append('__RequestVerificationToken', csrfToken);
            const response = await fetch('/Editor?handler=PreflightPublish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: form
            });
            const payload = await response.json().catch(() => ({}));
            if (!response.ok || !payload?.success) {
                throw new Error(payload?.message || 'Preflight failed');
            }
            return payload;
        }

        function explainPreflight(preflight) {
            const blockers = Array.isArray(preflight?.blockers) ? preflight.blockers : [];
            const warnings = Array.isArray(preflight?.warnings) ? preflight.warnings : [];
            const lines = [`Preflight score: ${preflight?.score ?? '-'}`];
            if (blockers.length) {
                lines.push('Blockers:');
                blockers.slice(0, 8).forEach((item) => lines.push(`- ${item}`));
            }
            if (warnings.length) {
                lines.push('Warnings:');
                warnings.slice(0, 8).forEach((item) => lines.push(`- ${item}`));
            }
            return lines.join('\n');
        }

        function setButtonState(btn, text, disabled) {
            if (!btn) return;
            btn.disabled = disabled;
            const label = btn.querySelector('span');
            if (label) {
                label.textContent = text;
            } else {
                btn.innerHTML = `<i class="${btn.id === 'publishBtn' ? 'fa-solid fa-rocket' : 'fa-solid fa-floppy-disk'}"></i> ${text}`;
            }
        }

        controlRefs.openPreviewBtn?.addEventListener('click', () => {
            const links = getShareLinks();
            window.open(links.previewLink, '_blank', 'noopener');
        });

        controlRefs.openPublishedBtn?.addEventListener('click', () => {
            const links = getShareLinks();
            window.open(links.publishedLink, '_blank', 'noopener');
        });

        controlRefs.restoreSnapshotBtn?.addEventListener('click', () => {
            if (!lastSavedNormalizedHtml) {
                showToast('No snapshot available to restore.');
                return;
            }
            const proceed = window.confirm('Restore canvas to the last saved snapshot for this session?');
            if (!proceed) return;
            const doc = getCanvasDocument();
            if (!doc) return;
            doc.open();
            doc.write(lastSavedNormalizedHtml);
            doc.close();
            showToast('Restored from last saved snapshot.');
            markEdit('structural');
            scheduleStructureUpdate();
            setTimeout(() => bindIframeDropzone(), 120);
        });

        document.getElementById('saveBtn')?.addEventListener('click', async () => {
            const rawHtml = getIframeHtml();
            const html = normalizeEditorUrls(rawHtml);
            if (!html) return;
            let preflight;
            try {
                preflight = await runServerPreflight(html);
            } catch (error) {
                alert(`Preflight failed: ${error?.message || 'Unknown error'}`);
                return;
            }
            if (Array.isArray(preflight?.blockers) && preflight.blockers.length) {
                alert(`Save blocked by preflight.\n\n${explainPreflight(preflight)}`);
                return;
            }
            const invariant = runTextStyleInvariantCheck(html);
            if (!invariant.safe) {
                const message = `Blocked save: text/style edit removed core layout assets.\n\n${invariant.reasons.join('\n')}`;
                alert(message);
                return;
            }
            const integrity = await runIntegrityCheck(rawHtml || '', html, false);
            if (!integrity.safe) {
                const changedPreview = integrity.changedAbsolute.slice(0, 6).join('\n');
                const proceed = window.confirm(`Potential asset path risk detected (${integrity.changedAbsolute.length} absolute URL change(s)).\n\nChanged refs:\n${changedPreview || '(none)'}\n\nContinue save?`);
                if (!proceed) return;
            }
            const btn = document.getElementById('saveBtn');
            setButtonState(btn, 'Saving...', true);
            try {
                await postEditorChange('SavePage', html, null, { overrideRisk: false });
                setButtonState(btn, 'Saved', false);
                setTimeout(() => setButtonState(btn, 'Save', false), 1200);
                lastSavedNormalizedHtml = html;
                baselineNormalizedHtml = html;
                resetEditTracker();
            } catch {
                setButtonState(btn, 'Save', false);
                alert('Save failed.');
            }
        });

        document.getElementById('publishBtn')?.addEventListener('click', async () => {
            const rawHtml = getIframeHtml();
            const html = normalizeEditorUrls(rawHtml);
            if (!html) return;
            let preflight;
            try {
                preflight = await runServerPreflight(html);
            } catch (error) {
                alert(`Preflight failed: ${error?.message || 'Unknown error'}`);
                return;
            }
            const invariant = runTextStyleInvariantCheck(html);
            if (!invariant.safe) {
                const message = `Blocked publish: text/style edit removed core layout assets.\n\n${invariant.reasons.join('\n')}`;
                alert(message);
                return;
            }
            let allowOverrideRisk = false;
            if (Array.isArray(preflight?.blockers) && preflight.blockers.length) {
                alert(`Publish blocked by preflight.\n\n${explainPreflight(preflight)}`);
                return;
            }
            if (Array.isArray(preflight?.warnings) && preflight.warnings.length) {
                const proceed = window.confirm(`Preflight warnings found.\n\n${explainPreflight(preflight)}\n\nPublish anyway?`);
                if (!proceed) return;
                allowOverrideRisk = true;
            }
            const integrity = await runIntegrityCheck(rawHtml || '', html, true);
            if (!integrity.safe) {
                const changedPreview = integrity.changedAbsolute.slice(0, 8).join('\n');
                const proceed = window.confirm(`Potential asset path risk detected (${integrity.changedAbsolute.length} absolute URL change(s)).\n\nChanged refs:\n${changedPreview || '(none)'}\n\nContinue publish?`);
                if (!proceed) return;
            }
            const btn = document.getElementById('publishBtn');
            setButtonState(btn, 'Publishing...', true);
            try {
                await postEditorChange('PublishPage', html, null, { overrideRisk: allowOverrideRisk });
                setButtonState(btn, 'Published', false);
                setTimeout(() => setButtonState(btn, 'Publish', false), 1400);
                lastSavedNormalizedHtml = html;
                baselineNormalizedHtml = html;
                resetEditTracker();
                const links = getShareLinks();
                showToast('Published. Use Preview/Live buttons to verify.');
                console.info('[Editor Publish] Preview:', links.previewLink);
                console.info('[Editor Publish] Live:', links.publishedLink);
            } catch {
                setButtonState(btn, 'Publish', false);
                alert('Publish failed.');
            }
        });
    </script>
</body>
</html>
