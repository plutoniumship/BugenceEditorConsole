@page
@model BugenceEditConsole.Pages.Tools.SystemPropertiesModel
@{
    ViewData["Title"] = "System Properties";
    ViewData["BodyClass"] = "page-tools-systemproperties-custom";
    var canManage = Model.CanManage;
}
@section Head {
    <style>
        :root { --bg:#050505; --surface:#0a0a0a; --border:rgba(255,255,255,0.08); --text:#fff; --muted:#a1a1aa; --accent:#06b6d4; --danger:#ef4444; --warning:#f59e0b; }
        * { box-sizing:border-box; outline:none; }
        .system-properties-page { background: radial-gradient(circle at 0% 0%, rgba(6,182,212,0.03), transparent 40%); position:relative; min-height:100%; }
        .header { margin-bottom:24px; display:flex; align-items:flex-start; justify-content:space-between; gap:16px; }
        .header h1 { font-family:'Cabinet Grotesk',sans-serif; font-size:2.5rem; margin:0 0 8px; }
        .header p { margin:0; color:var(--muted); font-size:0.95rem; }
        .primary-btn { background:var(--accent); color:#00131a; border:none; border-radius:10px; font-weight:700; padding:12px 16px; cursor:pointer; display:inline-flex; align-items:center; gap:8px; }
        .primary-btn:hover { background:#0891b2; color:white; }
        .table-wrapper { background:var(--surface); border:1px solid var(--border); border-radius:16px; overflow:hidden; }
        table { width:100%; border-collapse:collapse; }
        th { text-align:left; padding:16px 14px; background:rgba(255,255,255,0.02); border-bottom:1px solid var(--border); color:var(--muted); font-size:0.72rem; text-transform:uppercase; font-weight:700; letter-spacing:1px; }
        td { padding:16px 14px; border-bottom:1px solid var(--border); vertical-align:top; color:var(--text); font-size:0.88rem; }
        tr:last-child td { border-bottom:none; }
        tr:hover td { background:rgba(255,255,255,0.03); }
        .muted { color:var(--muted); font-size:0.82rem; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:0.8rem; }
        .empty-state { padding:40px; text-align:center; color:var(--muted); }
        .drawer { position:fixed; inset:0; display:none; z-index:200; }
        .drawer.show { display:flex; }
        .drawer-backdrop { flex:1; background:rgba(2,6,23,0.65); }
        .drawer-panel { width:min(560px, 92vw); background:#050607; border-left:1px solid rgba(148,163,184,0.2); padding:24px; overflow-y:auto; }
        .drawer-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .drawer-header h3 { margin:0; font-family:'Cabinet Grotesk',sans-serif; font-size:1.4rem; }
        .drawer-sub { color:#94a3b8; font-size:0.85rem; }
        .drawer-section { border:1px solid rgba(148,163,184,0.12); border-radius:16px; padding:16px; background:linear-gradient(180deg, rgba(8,10,14,0.98), rgba(4,6,10,0.98)); margin-top:14px; }
        .drawer-section h4 { margin:0 0 8px; font-size:0.95rem; color:#e2e8f0; }
        .two-col { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        .form-input { width:100%; background:#0b0b0b; border:1px solid rgba(148,163,184,0.2); padding:12px 14px; border-radius:10px; color:white; outline:none; transition:0.2s; font-family:inherit; font-size:0.92rem; }
        .form-input:focus { border-color:var(--accent); }
        .form-textarea { min-height:90px; resize:vertical; }
        .id-display { background:#0b0b0b; border:1px solid rgba(148,163,184,0.2); padding:12px 14px; border-radius:10px; color:#e2e8f0; font-weight:700; letter-spacing:0.2px; }
        .chip-btn { background:rgba(255,255,255,0.06); border:1px solid var(--border); color:#e2e8f0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
        .chip-btn:hover { border-color:var(--accent); color:white; }
        .footer-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:18px; }
        .drawer-panel::-webkit-scrollbar { width:8px; }
        .drawer-panel::-webkit-scrollbar-track { background:transparent; }
        .drawer-panel::-webkit-scrollbar-thumb { background:rgba(148,163,184,0.2); border-radius:999px; }
        .drawer-panel::-webkit-scrollbar-thumb:hover { background:rgba(148,163,184,0.4); }
        .action-group { display:inline-flex; gap:8px; align-items:center; justify-content:flex-end; }
        .action-btn { background:transparent; border:1px solid var(--border); color:var(--muted); width:34px; height:34px; border-radius:8px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; transition:0.2s; }
        .action-btn:hover { color:white; border-color:white; }
        .action-btn.delete:hover { color:var(--danger); border-color:var(--danger); }
        .confirm-modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:220; }
        .confirm-modal.show { display:flex; }
        .confirm-card { width:min(420px, 92vw); background:#0b0e14; border:1px solid rgba(148,163,184,0.2); border-radius:16px; padding:20px; box-shadow:0 30px 60px rgba(0,0,0,0.5); }
        .confirm-card h4 { margin:0 0 6px; font-family:'Cabinet Grotesk',sans-serif; }
        .confirm-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:16px; }
        .table-toolbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
        .search-input { width:min(360px, 100%); background:#0b0b0b; border:1px solid rgba(148,163,184,0.2); padding:10px 14px; border-radius:10px; color:white; font-size:0.9rem; }
        .search-input:focus { border-color:var(--accent); }
        .pagination { display:flex; align-items:center; gap:8px; margin-top:16px; justify-content:flex-end; }
        .page-btn { background:rgba(255,255,255,0.06); border:1px solid var(--border); color:#e2e8f0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
        .page-btn:disabled { opacity:0.4; cursor:not-allowed; }
        .page-info { color:var(--muted); font-size:0.85rem; }
        @@media (max-width: 900px) { .header h1 { font-size:2rem; } }
    </style>
}
<div class="system-properties-page">
            <div class="header">
                <div>
                    <h1>System Properties</h1>
                    <p>Store sensitive SMTP credentials, route URLs, and system-level key settings in one secure table.</p>
                </div>
            </div>

            <div class="table-toolbar">
                <input class="search-input" id="propertySearch" placeholder="Search by name, category, username, route, or host..." />
                @if (canManage)
                {
                    <button class="primary-btn" id="openDrawer"><i class="fa-solid fa-plus"></i> New Record</button>
                }
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th style="width:7%;">ID</th>
                            <th style="width:14%;">Name</th>
                            <th style="width:10%;">Category</th>
                            <th style="width:11%;">Username</th>
                            <th>Route / Host</th>
                            <th style="width:10%;">Password</th>
                            <th style="width:10%;">Updated</th>
                            <th style="width:16%;">DGUID</th>
                            <th style="width:9%; text-align:right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Properties.Count == 0)
                        {
                            <tr>
                                <td colspan="9" class="empty-state">No system properties yet. Create your first secure property record.</td>
                            </tr>
                        }
                        else
                        {
                            foreach (var property in Model.Properties)
                            {
                                var masked = string.IsNullOrWhiteSpace(property.Password) ? "-" : new string('â€¢', Math.Min(Math.Max(property.Password.Length, 6), 12));
                                <tr data-property-id="@property.Id">
                                    <td><strong>#@property.Id</strong></td>
                                    <td>@property.Name</td>
                                    <td class="muted">@property.Category</td>
                                    <td class="muted">@(string.IsNullOrWhiteSpace(property.Username) ? "-" : property.Username)</td>
                                    <td class="muted">@(string.IsNullOrWhiteSpace(property.RouteUrl) ? (string.IsNullOrWhiteSpace(property.Host) ? "-" : $"{property.Host}:{property.Port}") : property.RouteUrl)</td>
                                    <td class="mono">@masked</td>
                                    <td class="muted">@property.UpdatedAtUtc.ToLocalTime().ToString("MMM d, yyyy")</td>
                                    <td class="mono">@property.Dguid</td>
                                    <td style="text-align:right;">
                                        @if (canManage)
                                        {
                                            <div class="action-group">
                                                <button class="action-btn edit-property" type="button" data-property-id="@property.Id" title="Edit">
                                                    <i class="fa-solid fa-pen"></i>
                                                </button>
                                                <button class="action-btn delete delete-property" type="button" data-property-id="@property.Id" title="Delete">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="muted">-</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="propertyPagination" style="display:none;">
                <button class="page-btn" id="prevPage">Previous</button>
                <span class="page-info" id="pageInfo">Page 1 of 1</span>
                <button class="page-btn" id="nextPage">Next</button>
            </div>
</div>

    <div class="drawer" id="drawer">
        <div class="drawer-backdrop" id="drawerBackdrop"></div>
        <div class="drawer-panel">
            <div class="drawer-header">
                <div>
                    <h3 id="drawerTitle">Create System Property</h3>
                    <div class="drawer-sub" id="drawerSubtitle">Define secure credentials or route configuration records.</div>
                </div>
                <button class="action-btn" id="closeDrawer" type="button"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="drawer-section">
                <h4>Record Identity</h4>
                <div class="two-col">
                    <div>
                        <label class="muted">ID</label>
                        <div class="id-display" id="idDisplay">1</div>
                    </div>
                    <div>
                        <label class="muted">DGUID</label>
                        <div class="id-display mono" id="dguidDisplay">Generating...</div>
                    </div>
                </div>
                <input type="hidden" id="propertyId" />
            </div>

            <div class="drawer-section">
                <h4>Core Details</h4>
                <div class="two-col">
                    <input class="form-input" id="propertyName" placeholder="Name (required)" />
                    <select class="form-input" id="propertyCategory">
                        <option value="">Category (required)</option>
                        <option value="SMTP">SMTP</option>
                        <option value="Route">Route</option>
                        <option value="Credential">Credential</option>
                        <option value="API">API</option>
                        <option value="OAuthGoogle">OAuth Google</option>
                        <option value="General">General</option>
                    </select>
                </div>
            </div>

            <div class="drawer-section">
                <h4 id="credentialsHeading">Credentials</h4>
                <div class="two-col">
                    <input class="form-input" id="propertyUsername" placeholder="Username" />
                    <input class="form-input" id="propertyPassword" type="password" placeholder="Password" />
                </div>
                <div class="muted" style="margin-top:8px;" id="credentialsHint">For `SMTP`, `Credential`, and `API`, username and password are required. Password is encrypted at rest.</div>
            </div>

            <div class="drawer-section">
                <h4 id="routeHeading">Connection / Route</h4>
                <div class="two-col">
                    <input class="form-input" id="propertyHost" placeholder="Host (e.g. smtp.office365.com)" />
                    <input class="form-input" id="propertyPort" placeholder="Port (e.g. 587)" />
                </div>
                <input class="form-input" id="propertyRouteUrl" placeholder="Route URL (required when category is Route)" style="margin-top:10px;" />
            </div>

            <div class="drawer-section">
                <h4>Notes</h4>
                <textarea class="form-input form-textarea" id="propertyNotes" placeholder="Optional notes or usage details"></textarea>
            </div>

            <div class="muted" id="formStatus" style="margin-top:12px;"></div>
            <div class="footer-actions">
                <button class="chip-btn" id="cancelDrawer" type="button">Cancel</button>
                <button class="primary-btn" id="saveProperty" type="button">Save Record</button>
            </div>
        </div>
    </div>

    <div class="confirm-modal" id="confirmModal">
        <div class="drawer-backdrop"></div>
        <div class="confirm-card">
            <h4>Delete Record</h4>
            <div class="muted">Are you sure you want to delete this system property record?</div>
            <div class="confirm-actions">
                <button class="chip-btn" id="cancelDelete">Cancel</button>
                <button class="primary-btn" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>

    <form id="antiForgery" method="post" style="display:none;">
        @Html.AntiForgeryToken()
    </form>

@section Scripts {
    <script src="/js/tool-database-sync.js"></script>
    <script>
const canManage = @canManage.ToString().ToLowerInvariant();
        const drawer = document.getElementById('drawer');
        const openDrawer = document.getElementById('openDrawer');
        const closeDrawer = document.getElementById('closeDrawer');
        const drawerBackdrop = document.getElementById('drawerBackdrop');
        const cancelDrawer = document.getElementById('cancelDrawer');
        const propertyId = document.getElementById('propertyId');
        const propertyName = document.getElementById('propertyName');
        const propertyCategory = document.getElementById('propertyCategory');
        const propertyUsername = document.getElementById('propertyUsername');
        const propertyPassword = document.getElementById('propertyPassword');
        const propertyHost = document.getElementById('propertyHost');
        const propertyPort = document.getElementById('propertyPort');
        const propertyRouteUrl = document.getElementById('propertyRouteUrl');
        const propertyNotes = document.getElementById('propertyNotes');
        const credentialsHeading = document.getElementById('credentialsHeading');
        const credentialsHint = document.getElementById('credentialsHint');
        const routeHeading = document.getElementById('routeHeading');
        const idDisplay = document.getElementById('idDisplay');
        const dguidDisplay = document.getElementById('dguidDisplay');
        const drawerTitle = document.getElementById('drawerTitle');
        const drawerSubtitle = document.getElementById('drawerSubtitle');
        const saveProperty = document.getElementById('saveProperty');
        const formStatus = document.getElementById('formStatus');
        const csrfToken = document.querySelector('#antiForgery input[name="__RequestVerificationToken"]')?.value || '';
        const propertiesData = @Html.Raw(Model.PropertiesJson);
        const propertySearchMap = new Map(propertiesData.map(property => [String(property.id || ''), `${(property.name || '')} ${(property.category || '')} ${(property.username || '')} ${(property.routeUrl || '')} ${(property.host || '')} ${(property.dguid || '')}`.toLowerCase()]));

        const confirmModal = document.getElementById('confirmModal');
        const cancelDelete = document.getElementById('cancelDelete');
        const confirmDelete = document.getElementById('confirmDelete');
        let deletePropertyId = null;

        const propertySearch = document.getElementById('propertySearch');
        const propertyPagination = document.getElementById('propertyPagination');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const pageInfo = document.getElementById('pageInfo');
        const tableRows = Array.from(document.querySelectorAll('tbody tr[data-property-id]'));
        let currentPage = 1;
        const pageSize = 6;

        const showDrawer = (show) => {
            if (!drawer) return;
            drawer.classList.toggle('show', show);
        };

        const showConfirm = (show) => {
            if (!confirmModal) return;
            confirmModal.classList.toggle('show', show);
        };

        const setStatus = (message, isError = false) => {
            if (!formStatus) return;
            formStatus.textContent = message;
            formStatus.style.color = isError ? '#f59e0b' : '#94a3b8';
        };

        const categoryNeedsCredentials = (value) => ['smtp', 'credential', 'api', 'oauthgoogle'].includes((value || '').toLowerCase());
        const categoryNeedsRoute = (value) => ['route', 'oauthgoogle'].includes((value || '').toLowerCase());
        const isOAuthGoogle = (value) => (value || '').toLowerCase() === 'oauthgoogle';

        const applyCategoryPreset = () => {
            const category = propertyCategory?.value || '';
            const oauth = isOAuthGoogle(category);

            if (credentialsHeading) {
                credentialsHeading.textContent = oauth ? 'OAuth Client Credentials' : 'Credentials';
            }
            if (routeHeading) {
                routeHeading.textContent = oauth ? 'OAuth Redirect / Connection' : 'Connection / Route';
            }
            if (propertyUsername) {
                propertyUsername.placeholder = oauth ? 'Google Client ID (required)' : 'Username';
            }
            if (propertyPassword) {
                propertyPassword.placeholder = oauth ? 'Google Client Secret (required)' : 'Password';
            }
            if (propertyRouteUrl) {
                propertyRouteUrl.placeholder = oauth
                    ? 'Redirect URI (required, e.g. http://localhost:5019/signin-google)'
                    : 'Route URL (required when category is Route)';
            }
            if (propertyHost) {
                propertyHost.placeholder = oauth ? 'Optional (e.g. accounts.google.com)' : 'Host (e.g. smtp.office365.com)';
            }
            if (propertyPort) {
                propertyPort.placeholder = oauth ? 'Optional' : 'Port (e.g. 587)';
            }
            if (credentialsHint) {
                credentialsHint.textContent = oauth
                    ? 'Store Google OAuth secrets here. Client Secret is encrypted at rest.'
                    : 'For `SMTP`, `Credential`, and `API`, username and password are required. Password is encrypted at rest.';
            }
            if (oauth && propertyName && !propertyName.value.trim()) {
                propertyName.value = 'Google OAuth';
            }
        };

        const resetDrawer = async () => {
            if (propertyId) propertyId.value = '';
            if (propertyName) propertyName.value = '';
            if (propertyCategory) propertyCategory.value = '';
            if (propertyUsername) propertyUsername.value = '';
            if (propertyPassword) propertyPassword.value = '';
            if (propertyHost) propertyHost.value = '';
            if (propertyPort) propertyPort.value = '';
            if (propertyRouteUrl) propertyRouteUrl.value = '';
            if (propertyNotes) propertyNotes.value = '';
            if (drawerTitle) drawerTitle.textContent = 'Create System Property';
            if (drawerSubtitle) drawerSubtitle.textContent = 'Define secure credentials or route configuration records.';
            if (saveProperty) saveProperty.textContent = 'Save Record';
            setStatus('');
            if (idDisplay) idDisplay.textContent = '1';
            if (dguidDisplay) dguidDisplay.textContent = 'Generating...';

            try {
                const res = await fetch('/Tools/SystemProperties?handler=NextIdentity', {
                    method: 'GET',
                    credentials: 'include'
                });
                if (res.ok) {
                    const data = await res.json();
                    if (data?.success) {
                        if (idDisplay) idDisplay.textContent = String(data.nextId || '1');
                        if (dguidDisplay) dguidDisplay.textContent = String(data.dguid || '');
                    }
                }
            } catch {
                if (idDisplay) idDisplay.textContent = '1';
                if (dguidDisplay) dguidDisplay.textContent = '';
            }
            applyCategoryPreset();
        };

        openDrawer?.addEventListener('click', async () => {
            await resetDrawer();
            showDrawer(true);
        });
        closeDrawer?.addEventListener('click', () => showDrawer(false));
        drawerBackdrop?.addEventListener('click', () => showDrawer(false));
        cancelDrawer?.addEventListener('click', () => showDrawer(false));

        saveProperty?.addEventListener('click', async () => {
            if (!canManage) return;
            const nameValue = propertyName?.value?.trim() || '';
            const categoryValue = propertyCategory?.value?.trim() || '';
            const usernameValue = propertyUsername?.value?.trim() || '';
            const passwordValue = propertyPassword?.value?.trim() || '';
            const hostValue = propertyHost?.value?.trim() || '';
            const portValue = propertyPort?.value?.trim() || '';
            const routeValue = propertyRouteUrl?.value?.trim() || '';
            const notesValue = propertyNotes?.value?.trim() || '';
            const dguidValue = dguidDisplay?.textContent?.trim() || '';

            if (!nameValue || !categoryValue) {
                setStatus('Name and category are required.', true);
                return;
            }
            if (categoryNeedsCredentials(categoryValue) && (!usernameValue || !passwordValue)) {
                setStatus(isOAuthGoogle(categoryValue)
                    ? 'Google Client ID and Google Client Secret are required for OAuth Google.'
                    : 'Username and password are required for this category.', true);
                return;
            }
            if (categoryNeedsRoute(categoryValue) && !routeValue) {
                setStatus(isOAuthGoogle(categoryValue)
                    ? 'Redirect URI is required for OAuth Google.'
                    : 'Route URL is required when category is Route.', true);
                return;
            }
            if (portValue) {
                const parsed = Number(portValue);
                if (!Number.isInteger(parsed) || parsed < 1 || parsed > 65535) {
                    setStatus('Port must be a number between 1 and 65535.', true);
                    return;
                }
            }

            const isEdit = !!(propertyId?.value);
            setStatus(isEdit ? 'Updating record...' : 'Creating record...');
            saveProperty.disabled = true;
            try {
                const res = await fetch(`/Tools/SystemProperties?handler=${isEdit ? 'Update' : 'Create'}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({
                        id: Number(propertyId?.value || 0),
                        dguid: dguidValue,
                        name: nameValue,
                        category: categoryValue,
                        username: usernameValue,
                        password: passwordValue,
                        host: hostValue,
                        port: portValue,
                        routeUrl: routeValue,
                        notes: notesValue
                    })
                });
                if (res.redirected) {
                    window.location.href = res.url;
                    return;
                }
                const data = await res.json();
                if (!res.ok || !data?.success) {
                    setStatus(data?.message || 'Unable to save record.', true);
                    return;
                }
                setStatus(isEdit ? 'Record updated.' : 'Record created.');
                window.location.reload();
            } catch {
                setStatus('Unable to save record.', true);
            } finally {
                saveProperty.disabled = false;
            }
        });

        document.querySelectorAll('.edit-property').forEach((button) => {
            button.addEventListener('click', () => {
                const id = button.getAttribute('data-property-id');
                const property = propertiesData.find(p => (p.id || '').toString() === (id || ''));
                if (!property) return;

                if (propertyId) propertyId.value = String(property.id || '');
                if (idDisplay) idDisplay.textContent = String(property.id || '1');
                if (dguidDisplay) dguidDisplay.textContent = property.dguid || '';
                if (propertyName) propertyName.value = property.name || '';
                if (propertyCategory) propertyCategory.value = property.category || '';
                if (propertyUsername) propertyUsername.value = property.username || '';
                if (propertyPassword) propertyPassword.value = property.password || '';
                if (propertyHost) propertyHost.value = property.host || '';
                if (propertyPort) propertyPort.value = property.port || '';
                if (propertyRouteUrl) propertyRouteUrl.value = property.routeUrl || '';
                if (propertyNotes) propertyNotes.value = property.notes || '';
                if (drawerTitle) drawerTitle.textContent = 'Edit System Property';
                if (drawerSubtitle) drawerSubtitle.textContent = 'Update secure property details and credentials.';
                if (saveProperty) saveProperty.textContent = 'Save Changes';
                setStatus('');
                applyCategoryPreset();
                showDrawer(true);
            });
        });

        propertyCategory?.addEventListener('change', applyCategoryPreset);

        document.querySelectorAll('.delete-property').forEach((button) => {
            button.addEventListener('click', () => {
                deletePropertyId = button.getAttribute('data-property-id');
                showConfirm(true);
            });
        });

        cancelDelete?.addEventListener('click', () => showConfirm(false));
        confirmModal?.querySelector('.drawer-backdrop')?.addEventListener('click', () => showConfirm(false));
        confirmDelete?.addEventListener('click', async () => {
            if (!deletePropertyId) return;
            confirmDelete.disabled = true;
            try {
                const res = await fetch('/Tools/SystemProperties?handler=Delete', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({ id: Number(deletePropertyId) })
                });
                if (res.redirected) {
                    window.location.href = res.url;
                    return;
                }
                const data = await res.json();
                if (!res.ok || !data?.success) {
                    setStatus(data?.message || 'Unable to delete record.', true);
                    return;
                }
                window.location.reload();
            } catch {
                setStatus('Unable to delete record.', true);
            } finally {
                confirmDelete.disabled = false;
                showConfirm(false);
                deletePropertyId = null;
            }
        });

        const applyFilters = () => {
            const term = (propertySearch?.value || '').trim().toLowerCase();
            const filtered = tableRows.filter((row) => {
                if (!term) return true;
                const searchValue = propertySearchMap.get(row.dataset.propertyId || '') || '';
                return searchValue.includes(term);
            });

            const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
            if (currentPage > totalPages) currentPage = totalPages;

            tableRows.forEach(row => row.style.display = 'none');
            const start = (currentPage - 1) * pageSize;
            const pageItems = filtered.slice(start, start + pageSize);
            pageItems.forEach(row => row.style.display = '');

            if (propertyPagination) {
                propertyPagination.style.display = filtered.length > pageSize ? 'flex' : 'none';
            }
            if (pageInfo) {
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            }
            if (prevPage) prevPage.disabled = currentPage <= 1;
            if (nextPage) nextPage.disabled = currentPage >= totalPages;
        };

        propertySearch?.addEventListener('input', () => {
            currentPage = 1;
            applyFilters();
        });

        prevPage?.addEventListener('click', () => {
            currentPage = Math.max(1, currentPage - 1);
            applyFilters();
        });

        nextPage?.addEventListener('click', () => {
            currentPage += 1;
            applyFilters();
        });

        window.BugenceToolDbSync?.init({
            endpoint: '/Tools/SystemProperties?handler=DatabaseSync',
            requestVerificationToken: csrfToken,
            topButtonAnchorId: 'openDrawer',
            editButtonAnchorId: 'saveProperty',
            editRecordIdElementId: 'propertyId',
            editRowButtonSelector: '.edit-property'
        });

        applyFilters();
    </script>
}
