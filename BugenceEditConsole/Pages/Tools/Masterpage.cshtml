@page
@model BugenceEditConsole.Pages.Tools.MasterpageModel
@{
    ViewData["Title"] = "Masterpage";
    ViewData["BodyClass"] = "page-tools-masterpage";
    var canManage = Model.CanManage;
}
@section Head {
<style>
        :root { --bg:#050505; --surface:#0a0a0a; --border:rgba(255,255,255,0.08); --text:#fff; --muted:#a1a1aa; --accent:#06b6d4; --success:#10b981; --danger:#ef4444; --warning:#f59e0b; --purple:#8b5cf6; }
        * { box-sizing:border-box; outline:none; }
        .tool-page-main { flex-grow:1; padding:40px 60px; overflow-y:auto; background: radial-gradient(circle at 0% 0%, rgba(6,182,212,0.03), transparent 40%); position:relative; }
        .header { margin-bottom:24px; display:flex; align-items:flex-start; justify-content:space-between; gap:16px; }
        .header h1 { font-family:'Cabinet Grotesk',sans-serif; font-size:2.5rem; margin:0 0 8px; }
        .header p { margin:0; color:var(--muted); font-size:0.95rem; }
        .primary-btn { background:var(--accent); color:#00131a; border:none; border-radius:10px; font-weight:700; padding:12px 16px; cursor:pointer; display:inline-flex; align-items:center; gap:8px; }
        .primary-btn:hover { background:#0891b2; color:white; }
        .table-wrapper { background:var(--surface); border:1px solid var(--border); border-radius:16px; overflow:hidden; }
        table { width:100%; border-collapse:collapse; }
        th { text-align:left; padding:18px 25px; background:rgba(255,255,255,0.02); border-bottom:1px solid var(--border); color:var(--muted); font-size:0.75rem; text-transform:uppercase; font-weight:700; letter-spacing:1px; }
        td { padding:20px 25px; border-bottom:1px solid var(--border); vertical-align:top; color:var(--text); }
        tr:last-child td { border-bottom:none; }
        tr:hover td { background:rgba(255,255,255,0.03); }
        .muted { color:var(--muted); font-size:0.85rem; }
        .empty-state { padding:40px; text-align:center; color:var(--muted); }
        .drawer { position:fixed; inset:0; display:none; z-index:200; }
        .drawer.show { display:flex; }
        .drawer-backdrop { flex:1; background:rgba(2,6,23,0.65); }
        .drawer-panel { width:min(520px, 92vw); background:#050607; border-left:1px solid rgba(148,163,184,0.2); padding:24px; overflow-y:auto; }
        .drawer-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .drawer-header h3 { margin:0; font-family:'Cabinet Grotesk',sans-serif; font-size:1.4rem; }
        .drawer-sub { color:#94a3b8; font-size:0.85rem; }
        .drawer-section { border:1px solid rgba(148,163,184,0.12); border-radius:16px; padding:16px; background:linear-gradient(180deg, rgba(8,10,14,0.98), rgba(4,6,10,0.98)); margin-top:14px; }
        .drawer-section h4 { margin:0 0 8px; font-size:0.95rem; color:#e2e8f0; }
        .form-input { width:100%; background:#0b0b0b; border:1px solid rgba(148,163,184,0.2); padding:12px 14px; border-radius:10px; color:white; outline:none; transition:0.2s; font-family:inherit; font-size:0.95rem; }
        .form-input:focus { border-color:var(--accent); }
        .form-textarea { min-height:120px; resize:vertical; }
        .id-display { background:#0b0b0b; border:1px solid rgba(148,163,184,0.2); padding:12px 14px; border-radius:10px; color:#e2e8f0; font-weight:700; letter-spacing:0.3px; }
        .chip-btn { background:rgba(255,255,255,0.06); border:1px solid var(--border); color:#e2e8f0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
        .chip-btn:hover { border-color:var(--accent); color:white; }
        .footer-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:18px; }
        .drawer-panel::-webkit-scrollbar { width:8px; }
        .drawer-panel::-webkit-scrollbar-track { background:transparent; }
        .drawer-panel::-webkit-scrollbar-thumb { background:rgba(148,163,184,0.2); border-radius:999px; }
        .drawer-panel::-webkit-scrollbar-thumb:hover { background:rgba(148,163,184,0.4); }
        .action-group { display:inline-flex; gap:8px; align-items:center; justify-content:flex-end; }
        .action-btn { background:transparent; border:1px solid var(--border); color:var(--muted); width:34px; height:34px; border-radius:8px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; transition:0.2s; }
        .action-btn:hover { color:white; border-color:white; }
        .action-btn.delete:hover { color:var(--danger); border-color:var(--danger); }
        .confirm-modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:220; }
        .confirm-modal.show { display:flex; }
        .confirm-card { width:min(420px, 92vw); background:#0b0e14; border:1px solid rgba(148,163,184,0.2); border-radius:16px; padding:20px; box-shadow:0 30px 60px rgba(0,0,0,0.5); }
        .confirm-card h4 { margin:0 0 6px; font-family:'Cabinet Grotesk',sans-serif; }
        .confirm-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:16px; }
        .table-toolbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
        .search-input { width:min(360px, 100%); background:#0b0b0b; border:1px solid rgba(148,163,184,0.2); padding:10px 14px; border-radius:10px; color:white; font-size:0.9rem; }
        .search-input:focus { border-color:var(--accent); }
        .pagination { display:flex; align-items:center; gap:8px; margin-top:16px; justify-content:flex-end; }
        .page-btn { background:rgba(255,255,255,0.06); border:1px solid var(--border); color:#e2e8f0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
        .page-btn:disabled { opacity:0.4; cursor:not-allowed; }
        .page-info { color:var(--muted); font-size:0.85rem; }
        .linked-cell-btn { background:transparent; border:none; padding:0; color:#67e8f9; cursor:pointer; font:inherit; text-align:left; }
        .linked-cell-btn:hover { color:#a5f3fc; text-decoration:underline; }
        @@media (max-width: 900px) { main { padding:32px 24px; } aside { display:none; } }
    </style>
}
<main class="tool-page-main">
            <div class="header">
                <div>
                    <h1>Masterpage</h1>
                    <p>Store masterpage layouts and link them to template viewer records.</p>
                </div>
            </div>

            <div class="table-toolbar">
                <input class="search-input" id="masterSearch" placeholder="Search by name or template viewer..." />
                @if (canManage)
                {
                    <button class="primary-btn" id="openDrawer"><i class="fa-solid fa-plus"></i> New Record</button>
                }
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th style="width:12%;">ID</th>
                            <th style="width:14%;">Name</th>
                            <th style="width:20%;">Templete Viewer</th>
                            <th style="width:14%;">Updated</th>
                            <th style="width:16%;">DGUID</th>
                            <th style="width:12%; text-align:right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Masterpages.Count == 0)
                        {
                            <tr>
                                <td colspan="6" class="empty-state">No masterpages yet. Create your first record to get started.</td>
                            </tr>
                        }
                        else
                        {
                            foreach (var master in Model.Masterpages)
                            {
                                <tr data-master-id="@master.Id">
                                    <td><strong>#@master.Id</strong></td>
                                    <td>@master.Name</td>
                                    <td class="muted">
                                        <button class="linked-cell-btn view-template-viewer" type="button" data-template-viewer-id="@master.TemplateViewerId" title="Open template viewer details">
                                            @master.TemplateViewerName
                                        </button>
                                    </td>
                                    <td class="muted">@master.UpdatedAtUtc.ToLocalTime().ToString("MMM d, yyyy")</td>
                                    <td class="muted" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:0.75rem;">@master.Dguid</td>
                                    <td style="text-align:right;">
                                        @if (canManage)
                                        {
                                            <div class="action-group">
                                                <button class="action-btn edit-master" type="button" data-master-id="@master.Id" title="Edit">
                                                    <i class="fa-solid fa-pen"></i>
                                                </button>
                                                <button class="action-btn delete delete-master" type="button" data-master-id="@master.Id" title="Delete">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="muted">—</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="masterPagination" style="display:none;">
                <button class="page-btn" id="prevPage">Previous</button>
                <span class="page-info" id="pageInfo">Page 1 of 1</span>
                <button class="page-btn" id="nextPage">Next</button>
            </div>
        </main>

    <div class="drawer" id="drawer">
        <div class="drawer-backdrop" id="drawerBackdrop"></div>
        <div class="drawer-panel">
            <div class="drawer-header">
                <div>
                    <h3 id="drawerTitle">Create Masterpage</h3>
                    <div class="drawer-sub" id="drawerSubtitle">Capture your masterpage details.</div>
                </div>
                <button class="action-btn" id="closeDrawer" type="button"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="drawer-section">
                <h4>Record Details</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <div>
                        <label class="muted">ID</label>
                        <div class="id-display" id="idDisplay">1</div>
                    </div>
                    <div>
                        <label class="muted">DGUID</label>
                        <div class="id-display" id="dguidDisplay" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:0.75rem;">Auto</div>
                    </div>
                </div>
                <input type="hidden" id="masterId" />
            </div>

            <div class="drawer-section">
                <h4>Name</h4>
                <input class="form-input" id="masterName" placeholder="Masterpage name" />
            </div>

            <div class="drawer-section">
                <h4>Select Templete Viewer</h4>
                <select class="form-input" id="templateViewerId">
                    <option value="">Select template viewer</option>
                    @foreach (var item in Model.TemplateViewers)
                    {
                        <option value="@item.Id">@item.Name</option>
                    }
                </select>
            </div>

            <div class="drawer-section">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                    <h4 style="margin:0;">Masterpage</h4>
                    <button class="chip-btn" id="openEditor" type="button"><i class="fa-solid fa-pen"></i> Edit in Template</button>
                </div>
                <textarea class="form-input form-textarea" id="masterTemplate" placeholder="Write masterpage markup or use the template editor..."></textarea>
            </div>

            <div class="muted" id="formStatus" style="margin-top:12px;"></div>
            <div class="footer-actions">
                <button class="chip-btn" id="cancelDrawer" type="button">Cancel</button>
                <button class="primary-btn" id="saveMaster" type="button">Save Record</button>
            </div>
        </div>
    </div>

    <div class="confirm-modal" id="confirmModal">
        <div class="drawer-backdrop"></div>
        <div class="confirm-card">
            <h4>Delete Record</h4>
            <div class="muted">Are you sure you want to delete this masterpage?</div>
            <div class="confirm-actions">
                <button class="chip-btn" id="cancelDelete">Cancel</button>
                <button class="primary-btn" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>

    <div class="drawer" id="templateViewerDrawer">
        <div class="drawer-backdrop" id="templateViewerDrawerBackdrop"></div>
        <div class="drawer-panel">
            <div class="drawer-header">
                <div>
                    <h3 id="templateViewerDrawerTitle">Template Viewer Details</h3>
                    <div class="drawer-sub" id="templateViewerDrawerSubtitle">Review and edit linked template viewer data.</div>
                </div>
                <button class="action-btn" id="closeTemplateViewerDrawer" type="button"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="drawer-section">
                <h4>Record Details</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <div>
                        <label class="muted">ID</label>
                        <div class="id-display" id="templateViewerIdDisplay">—</div>
                    </div>
                    <div>
                        <label class="muted">DGUID</label>
                        <div class="id-display" id="templateViewerDguidDisplay" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:0.75rem;">—</div>
                    </div>
                </div>
                <input type="hidden" id="templateViewerRecordId" />
            </div>

            <div class="drawer-section">
                <h4>Name</h4>
                <input class="form-input" id="templateViewerRecordName" placeholder="Template viewer name" />
            </div>

            <div class="drawer-section">
                <h4>Viewer Type</h4>
                <select class="form-input" id="templateViewerRecordType">
                    <option value="">Select viewer type</option>
                    <option value="Page Templete Viewer">Page Templete Viewer</option>
                    <option value="MasterPage Templete Viewer">MasterPage Templete Viewer</option>
                    <option value="Templete Viewer DB">Templete Viewer DB</option>
                    <option value="Master Page">Master Page</option>
                    <option value="Sub Templete">Sub Templete</option>
                </select>
            </div>

            <div class="drawer-section">
                <h4>Templete Viewer</h4>
                <textarea class="form-input form-textarea" id="templateViewerRecordText" placeholder="Template text"></textarea>
            </div>

            <div class="muted" id="templateViewerFormStatus" style="margin-top:12px;"></div>
            <div class="footer-actions">
                <button class="chip-btn" id="cancelTemplateViewerDrawer" type="button">Close</button>
                <button class="primary-btn" id="saveTemplateViewerFromMaster" type="button">Save Changes</button>
            </div>
        </div>
    </div>

    <form id="antiForgery" method="post" style="display:none;">
        @Html.AntiForgeryToken()
    </form>

    <script src="/js/tool-database-sync.js"></script>
@section Scripts {
    <script>
        const canManage = @canManage.ToString().ToLowerInvariant();
        const masterpagesData = @Html.Raw(Model.MasterpagesJson);
        const templateViewersData = @Html.Raw(Model.TemplateViewersJson);
        const masterSearchMap = new Map(masterpagesData.map(item => [String(item.id || ''), `${(item.name || '')} ${(item.templateViewerName || '')} ${(item.dguid || '')}`.toLowerCase()]));

        const drawer = document.getElementById('drawer');
        const openDrawer = document.getElementById('openDrawer');
        const closeDrawer = document.getElementById('closeDrawer');
        const drawerBackdrop = document.getElementById('drawerBackdrop');
        const cancelDrawer = document.getElementById('cancelDrawer');
        const masterId = document.getElementById('masterId');
        const masterName = document.getElementById('masterName');
        const templateViewerId = document.getElementById('templateViewerId');
        const masterTemplate = document.getElementById('masterTemplate');
        const idDisplay = document.getElementById('idDisplay');
        const dguidDisplay = document.getElementById('dguidDisplay');
        const drawerTitle = document.getElementById('drawerTitle');
        const drawerSubtitle = document.getElementById('drawerSubtitle');
        const saveMaster = document.getElementById('saveMaster');
        const formStatus = document.getElementById('formStatus');
        const csrfToken = document.querySelector('#antiForgery input[name="__RequestVerificationToken"]')?.value || '';
        window.BugenceToolDbSync?.init({
            endpoint: '/Tools/Masterpage?handler=DatabaseSync',
            requestVerificationToken: csrfToken,
            topButtonAnchorId: 'openDrawer',
            editButtonAnchorId: 'saveMaster',
            editRecordIdElementId: 'masterId',
            editRowButtonSelector: '.edit-master'
        });
        const templateViewerDrawer = document.getElementById('templateViewerDrawer');
        const templateViewerDrawerBackdrop = document.getElementById('templateViewerDrawerBackdrop');
        const closeTemplateViewerDrawer = document.getElementById('closeTemplateViewerDrawer');
        const cancelTemplateViewerDrawer = document.getElementById('cancelTemplateViewerDrawer');
        const templateViewerRecordId = document.getElementById('templateViewerRecordId');
        const templateViewerIdDisplay = document.getElementById('templateViewerIdDisplay');
        const templateViewerDguidDisplay = document.getElementById('templateViewerDguidDisplay');
        const templateViewerRecordName = document.getElementById('templateViewerRecordName');
        const templateViewerRecordType = document.getElementById('templateViewerRecordType');
        const templateViewerRecordText = document.getElementById('templateViewerRecordText');
        const templateViewerFormStatus = document.getElementById('templateViewerFormStatus');
        const saveTemplateViewerFromMaster = document.getElementById('saveTemplateViewerFromMaster');

        const confirmModal = document.getElementById('confirmModal');
        const cancelDelete = document.getElementById('cancelDelete');
        const confirmDelete = document.getElementById('confirmDelete');
        let deleteMasterId = null;

        const masterSearch = document.getElementById('masterSearch');
        const masterPagination = document.getElementById('masterPagination');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const pageInfo = document.getElementById('pageInfo');
        const tableRows = Array.from(document.querySelectorAll('tbody tr[data-master-id]'));
        let currentPage = 1;
        const pageSize = 6;

        let editorWindow = null;
        const openEditor = document.getElementById('openEditor');

        const showDrawer = (show) => {
            if (!drawer) return;
            drawer.classList.toggle('show', show);
        };

        const showConfirm = (show) => {
            if (!confirmModal) return;
            confirmModal.classList.toggle('show', show);
        };

        const showTemplateViewerDrawer = (show) => {
            if (!templateViewerDrawer) return;
            templateViewerDrawer.classList.toggle('show', show);
        };

        const setStatus = (message, isError = false) => {
            if (!formStatus) return;
            formStatus.textContent = message;
            formStatus.style.color = isError ? '#f59e0b' : '#94a3b8';
        };

        const setTemplateViewerStatus = (message, isError = false) => {
            if (!templateViewerFormStatus) return;
            templateViewerFormStatus.textContent = message || '';
            templateViewerFormStatus.style.color = isError ? '#f59e0b' : '#94a3b8';
        };

        const resetDrawer = async () => {
            if (masterId) masterId.value = '';
            if (masterName) masterName.value = '';
            if (templateViewerId) templateViewerId.value = '';
            if (masterTemplate) masterTemplate.value = '';
            if (drawerTitle) drawerTitle.textContent = 'Create Masterpage';
            if (drawerSubtitle) drawerSubtitle.textContent = 'Capture your masterpage details.';
            if (saveMaster) saveMaster.textContent = 'Save Record';
            setStatus('');
            if (dguidDisplay) dguidDisplay.textContent = 'Generating...';
            if (idDisplay) {
                idDisplay.textContent = '1';
                try {
                    const res = await fetch('/Tools/Masterpage?handler=NextIdentity', {
                        method: 'GET',
                        credentials: 'include'
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data?.success) {
                            idDisplay.textContent = data.nextId ?? '1';
                            if (dguidDisplay) dguidDisplay.textContent = data.dguid || '';
                        }
                    }
                } catch (err) {
                    idDisplay.textContent = '1';
                    if (dguidDisplay) dguidDisplay.textContent = '';
                }
            }
        };

        openDrawer?.addEventListener('click', async () => {
            await resetDrawer();
            showDrawer(true);
        });
        closeDrawer?.addEventListener('click', () => showDrawer(false));
        drawerBackdrop?.addEventListener('click', () => showDrawer(false));
        cancelDrawer?.addEventListener('click', () => showDrawer(false));
        closeTemplateViewerDrawer?.addEventListener('click', () => showTemplateViewerDrawer(false));
        templateViewerDrawerBackdrop?.addEventListener('click', () => showTemplateViewerDrawer(false));
        cancelTemplateViewerDrawer?.addEventListener('click', () => showTemplateViewerDrawer(false));

        const getApplicationTables = async () => {
            try {
                const res = await fetch('/Tools/TempleteViewer?handler=AppTables', {
                    method: 'GET',
                    credentials: 'include'
                });
                if (!res.ok) return [];
                const data = await res.json();
                if (Array.isArray(data?.tables)) return data.tables;
                return [];
            } catch (err) {
                return [];
            }
        };

        const getQuerySelectors = async () => {
            try {
                const res = await fetch('/Tools/TempleteViewer?handler=AppQueries', {
                    method: 'GET',
                    credentials: 'include'
                });
                if (!res.ok) return [];
                const data = await res.json();
                if (Array.isArray(data?.queries)) return data.queries;
                return [];
            } catch (err) {
                return [];
            }
        };

        const getSubTemplates = async () => {
            try {
                const res = await fetch('/Tools/TempleteViewer?handler=SubTemplates', {
                    method: 'GET',
                    credentials: 'include'
                });
                if (!res.ok) return [];
                const data = await res.json();
                if (Array.isArray(data?.subTemplates)) return data.subTemplates;
                return [];
            } catch (err) {
                return [];
            }
        };

        // Popup contract: keep this callable from all masterpage editor entry points.
        const openEditorPopup = async () => {
            const width = 900;
            const height = 560;
            const left = Math.max(0, (screen.width - width) / 2);
            const top = Math.max(0, (screen.height - height) / 2);
            if (editorWindow && !editorWindow.closed) {
                editorWindow.focus();
                return;
            }
            editorWindow = window.open('', 'BugenceMasterpageEditor', `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=no`);
            if (!editorWindow) return;

            const initialValue = (masterTemplate?.value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/`/g, '&#96;')
                .replace(/\$/g, '&#36;');
            const html = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masterpage Editor</title>
    <style>
        :root {
            --bg:#040404;
            --bg-soft:#090909;
            --panel:#0c0c0c;
            --panel-soft:#111111;
            --border:rgba(255,255,255,0.12);
            --border-strong:rgba(255,255,255,0.2);
            --text:#f7f7f7;
            --muted:#9b9b9b;
            --accent:#29c4df;
            --sunset-1:#f8d48a;
            --sunset-2:#efac53;
            --sunset-3:#ca7a2f;
        }
        * { box-sizing:border-box; }
        body {
            margin:0;
            font-family:'Satoshi',system-ui,-apple-system,sans-serif;
            color:var(--text);
            background:
                radial-gradient(1200px 520px at 0% -20%, rgba(255,170,72,0.13), transparent 52%),
                radial-gradient(900px 520px at 100% -10%, rgba(41,196,223,0.1), transparent 50%),
                linear-gradient(180deg, #030303 0%, #060606 100%);
        }
        .chrome-bar {
            height:56px;
            border-bottom:1px solid var(--border);
            background:linear-gradient(180deg, rgba(18,18,18,0.92), rgba(10,10,10,0.9));
            display:flex;
            align-items:center;
            justify-content:center;
            padding:0 18px;
        }
        .title {
            font-family:'Cabinet Grotesk','Satoshi',sans-serif;
            font-weight:700;
            font-size:1rem;
            letter-spacing:0.35px;
            color:#fef3d4;
            text-shadow:0 1px 18px rgba(245,179,87,0.2);
        }
        .editor-shell {
            height:calc(100vh - 56px);
            padding:16px 18px 18px;
            display:flex;
            flex-direction:column;
            gap:14px;
        }
        .editor-grid {
            flex:1;
            min-height:0;
            display:grid;
            grid-template-columns:minmax(0,1fr) 320px;
            gap:14px;
        }
        .editor-body {
            min-height:0;
            border:1px solid var(--border);
            border-radius:14px;
            overflow:hidden;
            background:linear-gradient(180deg, #0d0d0d 0%, #0a0a0a 100%);
            box-shadow:0 14px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.05);
        }
        textarea {
            width:100%;
            height:100%;
            resize:none;
            border:none;
            background:transparent;
            color:#f0f0f0;
            font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;
            padding:14px 14px 18px;
            font-size:0.9rem;
            line-height:1.62;
            outline:none;
        }
        .CodeMirror { height:100% !important; background:transparent !important; font-size:0.9rem; }
        .CodeMirror-gutters { background:#0f0f0f !important; border-right:1px solid rgba(255,255,255,0.08) !important; }
        .editor-footer { display:flex; justify-content:flex-end; gap:10px; align-items:center; }
        .sidebar {
            min-height:0;
            border:1px solid var(--border);
            border-radius:14px;
            background:linear-gradient(180deg, #0f0f0f 0%, #0b0b0b 100%);
            display:flex;
            flex-direction:column;
            overflow:hidden;
            box-shadow:0 12px 26px rgba(0,0,0,0.32), inset 0 1px 0 rgba(255,255,255,0.04);
        }
        .sidebar-header {
            padding:14px 14px 10px;
            border-bottom:1px solid rgba(255,255,255,0.1);
            font-family:'Cabinet Grotesk','Satoshi',sans-serif;
            font-weight:700;
            font-size:0.92rem;
            letter-spacing:0.2px;
            color:#f6f6f6;
        }
        .sidebar-tools {
            padding:10px 14px 12px;
            border-bottom:1px solid rgba(255,255,255,0.08);
            display:flex;
            flex-direction:column;
            gap:9px;
        }
        .tab-row { display:flex; gap:6px; flex-wrap:wrap; }
        .tab-btn {
            border:1px solid rgba(255,255,255,0.2);
            background:rgba(255,255,255,0.02);
            color:#cfcfcf;
            border-radius:999px;
            padding:5px 10px;
            font-size:0.72rem;
            line-height:1;
            font-weight:600;
            cursor:pointer;
            transition:all .18s ease;
        }
        .tab-btn:hover { border-color:rgba(255,255,255,0.35); color:#fff; }
        .tab-btn.active {
            border-color:rgba(41,196,223,0.75);
            color:#e6fbff;
            background:rgba(41,196,223,0.18);
            box-shadow:inset 0 0 0 1px rgba(41,196,223,0.16);
        }
        .sidebar-search {
            width:100%;
            background:#090909;
            border:1px solid rgba(255,255,255,0.14);
            color:#ebebeb;
            border-radius:10px;
            padding:8px 10px;
            font-size:0.79rem;
        }
        .sidebar-search:focus {
            border-color:rgba(41,196,223,0.75);
            box-shadow:0 0 0 3px rgba(41,196,223,0.14);
            outline:none;
        }
        .sidebar-body { padding:10px; overflow:auto; }
        .sidebar-body::-webkit-scrollbar { width:8px; }
        .sidebar-body::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.14); border-radius:999px; }
        .group-label {
            font-size:0.72rem;
            color:#8f8f8f;
            margin:7px 2px 10px;
            letter-spacing:0.35px;
            text-transform:uppercase;
            font-weight:700;
        }
        .app-section {
            border:1px solid rgba(255,255,255,0.1);
            border-radius:11px;
            margin-bottom:10px;
            overflow:hidden;
            background:#111;
        }
        .app-header {
            width:100%;
            background:rgba(255,255,255,0.025);
            border:none;
            color:#f0f0f0;
            font-weight:700;
            padding:10px 11px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            cursor:pointer;
            text-align:left;
        }
        .app-header span { font-size:0.72rem; color:#9a9a9a; }
        .app-body { display:none; padding:10px 10px 8px; border-top:1px solid rgba(255,255,255,0.08); background:#0e0e0e; }
        .app-section.open .app-body { display:block; }
        .token-btn {
            width:100%;
            text-align:left;
            border:1px solid rgba(255,255,255,0.12);
            background:rgba(255,255,255,0.03);
            color:#ececec;
            padding:8px 10px;
            border-radius:9px;
            font-size:0.79rem;
            margin-bottom:7px;
            cursor:pointer;
            transition:all .18s ease;
        }
        .token-btn:hover {
            border-color:rgba(41,196,223,0.72);
            background:rgba(41,196,223,0.11);
            color:#ffffff;
        }
        .btn {
            border:1px solid rgba(255,255,255,0.2);
            background:rgba(255,255,255,0.03);
            color:#f3f3f3;
            padding:9px 16px;
            border-radius:10px;
            font-weight:700;
            letter-spacing:0.2px;
            cursor:pointer;
            transition:all .2s ease;
        }
        .btn:hover { border-color:rgba(255,255,255,0.36); }
        .btn.primary {
            border:none;
            color:#251402;
            background:linear-gradient(135deg, var(--sunset-1), var(--sunset-2) 52%, var(--sunset-3));
            box-shadow:0 10px 24px rgba(234,154,68,0.34), inset 0 1px 0 rgba(255,255,255,0.35);
        }
        .btn.primary:hover {
            transform:translateY(-1px);
            filter:saturate(1.05) brightness(1.03);
            box-shadow:0 14px 26px rgba(234,154,68,0.4), inset 0 1px 0 rgba(255,255,255,0.42);
        }
        @@media (max-width: 980px) {
            .editor-grid { grid-template-columns:minmax(0,1fr); }
            .sidebar { min-height:280px; }
        }
    </style>
}
<body>
    <div class="chrome-bar">
        <div class="title">Masterpage Editor</div>
    </div>
    <div class="editor-shell">
        <div class="editor-grid">
            <div class="editor-body">
                <textarea id="editorTextarea" spellcheck="false">${initialValue}</textarea>
            </div>
            <aside class="sidebar">
                <div class="sidebar-header">Masterpage Repeaters</div>
                <div class="sidebar-tools">
                    <div class="tab-row" id="repeaterTabs">
                        <button type="button" class="tab-btn active" data-category="all">All</button>
                        <button type="button" class="tab-btn" data-category="query">Queries</button>
                        <button type="button" class="tab-btn" data-category="application">Apps</button>
                        <button type="button" class="tab-btn" data-category="template">Sub</button>
                    </div>
                    <input class="sidebar-search" id="repeaterSearch" placeholder="Filter repeaters..." />
                </div>
                <div class="sidebar-body" id="repeaterList"></div>
            </aside>
        </div>
        <div class="editor-footer">
            <button class="btn" id="cancelBtn">Cancel</button>
            <button class="btn primary" id="submitBtn">Submit</button>
        </div>
    </div>
</body>
</html>`;
            editorWindow.document.open();
            editorWindow.document.write(html);
            editorWindow.document.close();
            editorWindow.focus();

            const doc = editorWindow.document;
            const textarea = doc.getElementById('editorTextarea');
            const submitBtn = doc.getElementById('submitBtn');
            const cancelBtn = doc.getElementById('cancelBtn');
            const repeaterList = doc.getElementById('repeaterList');
            const repeaterSearch = doc.getElementById('repeaterSearch');
            const repeaterTabs = Array.from(doc.querySelectorAll('#repeaterTabs .tab-btn'));

            const loadCss = (href) => new Promise((resolve) => {
                const link = doc.createElement('link');
                link.rel = 'stylesheet';
                link.href = href;
                link.onload = () => resolve();
                link.onerror = () => resolve();
                doc.head.appendChild(link);
            });
            const loadScript = (src) => new Promise((resolve) => {
                const script = doc.createElement('script');
                script.src = src;
                script.onload = () => resolve();
                script.onerror = () => resolve();
                doc.body.appendChild(script);
            });

            await loadCss('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css');
            await loadCss('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css');
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js');
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js');
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js');
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js');
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js');

            let editorInstance = null;
            if (editorWindow.CodeMirror && textarea) {
                editorInstance = editorWindow.CodeMirror.fromTextArea(textarea, {
                    mode: 'htmlmixed',
                    theme: 'material-darker',
                    lineNumbers: true,
                    lineWrapping: true
                });
                editorInstance.setSize('100%', '100%');
            }

            const isImageColumn = (value) => /(?:image|img|photo|picture|pic|avatar|logo)/i.test(value || '');
            const insertToken = (token) => {
                if (editorInstance) {
                    editorInstance.replaceSelection(token);
                    editorInstance.focus();
                    return;
                }
                if (textarea) {
                    const start = textarea.selectionStart || 0;
                    const end = textarea.selectionEnd || 0;
                    const current = textarea.value || '';
                    textarea.value = current.slice(0, start) + token + current.slice(end);
                    textarea.selectionStart = textarea.selectionEnd = start + token.length;
                    textarea.focus();
                }
            };

            let activeCategory = 'all';
            const applyTokenFilters = () => {
                if (!repeaterList) return;
                const term = (repeaterSearch?.value || '').trim().toLowerCase();
                const nodes = repeaterList.querySelectorAll('[data-category]');
                nodes.forEach((node) => {
                    const category = (node.getAttribute('data-category') || 'all').toLowerCase();
                    const text = (node.textContent || '').toLowerCase();
                    const showCategory = activeCategory === 'all' || category === activeCategory;
                    const showText = !term || text.includes(term);
                    node.style.display = showCategory && showText ? '' : 'none';
                });
            };
            repeaterTabs.forEach((btn) => {
                btn.addEventListener('click', () => {
                    activeCategory = btn.getAttribute('data-category') || 'all';
                    repeaterTabs.forEach((item) => item.classList.toggle('active', item === btn));
                    applyTokenFilters();
                });
            });
            repeaterSearch?.addEventListener('input', applyTokenFilters);

            if (repeaterList) {
                repeaterList.innerHTML = '';
                const toTokenName = (value) => (value || '').replace(/[^a-zA-Z0-9]/g, '');

                const masterpageLabel = doc.createElement('div');
                masterpageLabel.className = 'group-label';
                masterpageLabel.setAttribute('data-category', 'all');
                masterpageLabel.textContent = 'Masterpage Zone Repeaters';
                repeaterList.appendChild(masterpageLabel);

                const addMasterpageTokenButton = (labelText, token) => {
                    const zoneBtn = doc.createElement('button');
                    zoneBtn.type = 'button';
                    zoneBtn.className = 'token-btn';
                    zoneBtn.setAttribute('data-category', 'all');
                    zoneBtn.textContent = labelText;
                    zoneBtn.addEventListener('click', () => insertToken(token));
                    repeaterList.appendChild(zoneBtn);
                };

                addMasterpageTokenButton('Sidebar Repeater', '<Masterpage-Sidebar>');
                addMasterpageTokenButton('Topbar Repeater', '<Masterpage-Topbar>');
                addMasterpageTokenButton('Body Repeater', '<Masterpage-Body>');

                const querySelectors = await getQuerySelectors();
                if (querySelectors.length) {
                    const label = doc.createElement('div');
                    label.className = 'group-label';
                    label.setAttribute('data-category', 'query');
                    label.textContent = 'Query Selector Repeaters';
                    repeaterList.appendChild(label);
                }
                querySelectors.forEach((query) => {
                    const section = doc.createElement('div');
                    section.className = 'app-section';
                    section.setAttribute('data-category', 'query');
                    const header = doc.createElement('button');
                    header.type = 'button';
                    header.className = 'app-header';
                    header.innerHTML = `<div>${query.name}</div><span>${query.dguidToken}</span>`;
                    const body = doc.createElement('div');
                    body.className = 'app-body';

                    const addTokenButton = (labelText, token) => {
                        const btn = doc.createElement('button');
                        btn.type = 'button';
                        btn.className = 'token-btn';
                        btn.textContent = labelText;
                        btn.addEventListener('click', () => insertToken(token));
                        body.appendChild(btn);
                    };

                    addTokenButton('Opening Repeater', `<Repeater-${query.dguidToken}>`);
                    if ((query.columns || []).length === 0 || (query.columns || []).includes('*')) {
                        addTokenButton('All Columns', `<Repeater-${query.dguidToken}-AllColumns>`);
                    } else {
                        (query.columns || []).forEach((col) => {
                            const tokenName = toTokenName(col);
                            if (!tokenName) return;
                            addTokenButton(col, `<Repeater-${query.dguidToken}-${tokenName}>`);
                            if (isImageColumn(col)) {
                                addTokenButton(`${col} <img>`, `<img src="<Repeater-${query.dguidToken}-${tokenName}>" alt="${col}">`);
                            }
                        });
                    }
                    addTokenButton('Closing Repeater', `<Repeater-${query.dguidToken}/>`);

                    header.addEventListener('click', () => {
                        section.classList.toggle('open');
                    });

                    section.appendChild(header);
                    section.appendChild(body);
                    repeaterList.appendChild(section);
                });

                const tablesToRender = await getApplicationTables();
                if (tablesToRender.length) {
                    const label = doc.createElement('div');
                    label.className = 'group-label';
                    label.setAttribute('data-category', 'application');
                    label.textContent = 'Application Repeaters';
                    repeaterList.appendChild(label);
                }
                tablesToRender.forEach((table) => {
                    const section = doc.createElement('div');
                    section.className = 'app-section';
                    section.setAttribute('data-category', 'application');
                    const header = doc.createElement('button');
                    header.type = 'button';
                    header.className = 'app-header';
                    header.innerHTML = `<div>${table.tableName}</div><span>${table.dguidToken}</span>`;
                    const body = doc.createElement('div');
                    body.className = 'app-body';

                    const addTokenButton = (labelText, token) => {
                        const btn = doc.createElement('button');
                        btn.type = 'button';
                        btn.className = 'token-btn';
                        btn.textContent = labelText;
                        btn.addEventListener('click', () => insertToken(token));
                        body.appendChild(btn);
                    };

                    addTokenButton('Opening Repeater', `<Repeater-${table.dguidToken}>`);
                    (table.columns || []).forEach((col) => {
                        const tokenName = toTokenName(col);
                        if (!tokenName) return;
                        addTokenButton(col, `<Repeater-${table.dguidToken}-${tokenName}>`);
                        if (isImageColumn(col)) {
                            addTokenButton(`${col} <img>`, `<img src="<Repeater-${table.dguidToken}-${tokenName}>" alt="${col}">`);
                        }
                    });
                    addTokenButton('Closing Repeater', `<Repeater-${table.dguidToken}/>`);

                    header.addEventListener('click', () => {
                        section.classList.toggle('open');
                    });

                    section.appendChild(header);
                    section.appendChild(body);
                    repeaterList.appendChild(section);
                });

                const subTemplates = await getSubTemplates();
                if (subTemplates.length) {
                    const label = doc.createElement('div');
                    label.className = 'group-label';
                    label.setAttribute('data-category', 'template');
                    label.textContent = 'Sub Templete Repeaters';
                    repeaterList.appendChild(label);
                }
                subTemplates.forEach((sub) => {
                    const section = doc.createElement('div');
                    section.className = 'app-section open';
                    section.setAttribute('data-category', 'template');
                    const header = doc.createElement('button');
                    header.type = 'button';
                    header.className = 'app-header';
                    header.innerHTML = `<div>${sub.name}</div><span>${sub.dguidToken}</span>`;
                    const body = doc.createElement('div');
                    body.className = 'app-body';

                    const btn = doc.createElement('button');
                    btn.type = 'button';
                    btn.className = 'token-btn';
                    btn.textContent = 'Insert Sub Templete';
                    btn.addEventListener('click', () => insertToken(`<SubTemplete-${sub.dguidToken}>`));
                    body.appendChild(btn);

                    header.addEventListener('click', () => {
                        section.classList.toggle('open');
                    });

                    section.appendChild(header);
                    section.appendChild(body);
                    repeaterList.appendChild(section);
                });
                applyTokenFilters();
            }

            submitBtn?.addEventListener('click', () => {
                if (masterTemplate) {
                    masterTemplate.value = editorInstance ? editorInstance.getValue() : (textarea?.value || '');
                }
                editorWindow?.close();
            });
            cancelBtn?.addEventListener('click', () => editorWindow?.close());
        };

        openEditor?.addEventListener('click', () => {
            openEditorPopup();
        });

        document.querySelectorAll('.view-template-viewer').forEach((button) => {
            button.addEventListener('click', () => {
                const id = Number(button.getAttribute('data-template-viewer-id') || '0');
                const viewer = templateViewersData.find(item => Number(item.id || 0) === id);
                if (!viewer) {
                    setStatus('Template viewer record not found.', true);
                    return;
                }
                if (templateViewerRecordId) templateViewerRecordId.value = String(viewer.id || '');
                if (templateViewerIdDisplay) templateViewerIdDisplay.textContent = `#${viewer.id || '—'}`;
                if (templateViewerDguidDisplay) templateViewerDguidDisplay.textContent = viewer.dguid || '—';
                if (templateViewerRecordName) templateViewerRecordName.value = viewer.name || '';
                if (templateViewerRecordType) templateViewerRecordType.value = viewer.viewerType || '';
                if (templateViewerRecordText) templateViewerRecordText.value = viewer.templateText || '';
                if (templateViewerRecordName) templateViewerRecordName.disabled = !canManage;
                if (templateViewerRecordType) templateViewerRecordType.disabled = !canManage;
                if (templateViewerRecordText) templateViewerRecordText.disabled = !canManage;
                if (saveTemplateViewerFromMaster) saveTemplateViewerFromMaster.style.display = canManage ? 'inline-flex' : 'none';
                setTemplateViewerStatus('');
                showTemplateViewerDrawer(true);
            });
        });

        saveTemplateViewerFromMaster?.addEventListener('click', async () => {
            if (!canManage) return;
            const idValue = Number(templateViewerRecordId?.value || '0');
            const nameValue = templateViewerRecordName?.value?.trim() || '';
            const typeValue = templateViewerRecordType?.value?.trim() || '';
            const textValue = templateViewerRecordText?.value?.trim() || '';
            if (!idValue || !nameValue || !typeValue || !textValue) {
                setTemplateViewerStatus('Please provide name, viewer type and templete viewer.', true);
                return;
            }
            setTemplateViewerStatus('Saving changes...');
            if (saveTemplateViewerFromMaster) saveTemplateViewerFromMaster.disabled = true;
            try {
                const res = await fetch('/Tools/TempleteViewer?handler=Update', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({
                        id: idValue,
                        name: nameValue,
                        viewerType: typeValue,
                        templateText: textValue
                    })
                });
                if (res.redirected) {
                    window.location.href = res.url;
                    return;
                }
                const data = await res.json();
                if (!res.ok || !data?.success) {
                    setTemplateViewerStatus(data?.message || 'Unable to save template viewer.', true);
                    return;
                }
                setTemplateViewerStatus('Template viewer updated.');
                window.location.reload();
            } catch (err) {
                setTemplateViewerStatus('Unable to save template viewer.', true);
            } finally {
                if (saveTemplateViewerFromMaster) saveTemplateViewerFromMaster.disabled = false;
            }
        });

        saveMaster?.addEventListener('click', async () => {
            if (!canManage) return;
            const nameValue = masterName?.value?.trim() || '';
            const viewerValue = templateViewerId?.value?.trim() || '';
            const templateValue = masterTemplate?.value?.trim() || '';
            const dguidValue = dguidDisplay?.textContent?.trim() || '';
            if (!nameValue || !viewerValue || !templateValue) {
                setStatus('Please provide name, template viewer and masterpage.', true);
                return;
            }
            const isEdit = !!(masterId?.value);
            setStatus(isEdit ? 'Updating record...' : 'Creating record...');
            saveMaster.disabled = true;
            try {
                const res = await fetch(`/Tools/Masterpage?handler=${isEdit ? 'Update' : 'Create'}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({
                        id: masterId?.value || 0,
                        dguid: !isEdit ? dguidValue : undefined,
                        name: nameValue,
                        templateViewerId: Number(viewerValue),
                        masterpageText: templateValue
                    })
                });
                if (res.redirected) {
                    window.location.href = res.url;
                    return;
                }
                const data = await res.json();
                if (!res.ok || !data?.success) {
                    setStatus(data?.message || 'Unable to save record.', true);
                    return;
                }
                setStatus(isEdit ? 'Record updated.' : 'Record created.');
                window.location.reload();
            } catch (err) {
                setStatus('Unable to save record.', true);
            } finally {
                saveMaster.disabled = false;
            }
        });

        document.querySelectorAll('.edit-master').forEach((button) => {
            button.addEventListener('click', () => {
                const id = button.getAttribute('data-master-id');
                const master = masterpagesData.find(item => (item.id || '').toString() === (id || ''));
                if (!master) return;
                if (masterId) masterId.value = master.id || '';
                if (masterName) masterName.value = master.name || '';
                if (templateViewerId) templateViewerId.value = master.templateViewerId || '';
                if (masterTemplate) masterTemplate.value = master.masterpageText || '';
                if (idDisplay) idDisplay.textContent = master.id || '1';
                if (dguidDisplay) dguidDisplay.textContent = master.dguid || 'Auto';
                if (drawerTitle) drawerTitle.textContent = 'Edit Masterpage';
                if (drawerSubtitle) drawerSubtitle.textContent = 'Update the masterpage details.';
                if (saveMaster) saveMaster.textContent = 'Save Changes';
                setStatus('');
                showDrawer(true);
            });
        });

        document.querySelectorAll('.delete-master').forEach((button) => {
            button.addEventListener('click', () => {
                deleteMasterId = button.getAttribute('data-master-id');
                showConfirm(true);
            });
        });

        cancelDelete?.addEventListener('click', () => showConfirm(false));
        confirmModal?.querySelector('.drawer-backdrop')?.addEventListener('click', () => showConfirm(false));
        confirmDelete?.addEventListener('click', async () => {
            if (!deleteMasterId) return;
            confirmDelete.disabled = true;
            try {
                const res = await fetch('/Tools/Masterpage?handler=Delete', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({ id: Number(deleteMasterId) })
                });
                if (res.redirected) {
                    window.location.href = res.url;
                    return;
                }
                const data = await res.json();
                if (!res.ok || !data?.success) {
                    setStatus(data?.message || 'Unable to delete record.', true);
                    return;
                }
                window.location.reload();
            } catch (err) {
                setStatus('Unable to delete record.', true);
            } finally {
                confirmDelete.disabled = false;
                showConfirm(false);
                deleteMasterId = null;
            }
        });

        const applyFilters = () => {
            const term = (masterSearch?.value || '').trim().toLowerCase();
            const filtered = tableRows.filter((row) => {
                if (!term) return true;
                const searchValue = masterSearchMap.get(row.dataset.masterId || '') || '';
                return searchValue.includes(term);
            });

            const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
            if (currentPage > totalPages) currentPage = totalPages;

            tableRows.forEach(row => row.style.display = 'none');
            const start = (currentPage - 1) * pageSize;
            const pageItems = filtered.slice(start, start + pageSize);
            pageItems.forEach(row => row.style.display = '');

            if (pageInfo) pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            if (prevPage) prevPage.disabled = currentPage === 1;
            if (nextPage) nextPage.disabled = currentPage === totalPages;
            if (masterPagination) masterPagination.style.display = filtered.length > pageSize ? 'flex' : 'none';
        };

        masterSearch?.addEventListener('input', () => {
            currentPage = 1;
            applyFilters();
        });
        prevPage?.addEventListener('click', () => {
            currentPage = Math.max(1, currentPage - 1);
            applyFilters();
        });
        nextPage?.addEventListener('click', () => {
            currentPage += 1;
            applyFilters();
        });
        applyFilters();

        const profileCard = document.getElementById('profileCard');
        const profileMenu = profileCard?.querySelector('.profile-menu');
        const toggleProfile = () => {
            if (!profileCard) return;
            profileCard.classList.toggle('show');
        };
        profileCard?.addEventListener('click', (event) => {
            event.stopPropagation();
            toggleProfile();
        });
        document.addEventListener('click', (event) => {
            if (!(event.target instanceof HTMLElement)) return;
            if (profileCard?.contains(event.target)) return;
            profileCard?.classList.remove('show');
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') profileCard?.classList.remove('show');
        });
    </script>
}

