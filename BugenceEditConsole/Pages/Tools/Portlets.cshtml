@page
@model BugenceEditConsole.Pages.Tools.PortletsModel
@{
    ViewData["Title"] = "Portlets";
    ViewData["BodyClass"] = "page-tools-portlets";
    var canManage = Model.CanManage;
}
@section Head {
<style>
        :root { --bg:#050505; --surface:#0a0a0a; --border:rgba(255,255,255,0.08); --text:#fff; --muted:#a1a1aa; --accent:#06b6d4; --success:#10b981; --danger:#ef4444; --warning:#f59e0b; --purple:#8b5cf6; }
        * { box-sizing:border-box; outline:none; }
        .tool-page-main { flex-grow:1; padding:40px 60px; overflow-y:auto; background: radial-gradient(circle at 0% 0%, rgba(6,182,212,0.03), transparent 40%); position:relative; }
        .header { margin-bottom:24px; display:flex; align-items:flex-start; justify-content:space-between; gap:16px; }
        .header h1 { font-family:'Cabinet Grotesk',sans-serif; font-size:2.5rem; margin:0 0 8px; }
        .header p { margin:0; color:var(--muted); font-size:0.95rem; }
        .primary-btn { background:var(--accent); color:#00131a; border:none; border-radius:10px; font-weight:700; padding:12px 16px; cursor:pointer; display:inline-flex; align-items:center; gap:8px; }
        .primary-btn:hover { background:#0891b2; color:white; }
        .table-wrapper { background:var(--surface); border:1px solid var(--border); border-radius:16px; overflow:hidden; }
        table { width:100%; border-collapse:collapse; }
        th { text-align:left; padding:18px 25px; background:rgba(255,255,255,0.02); border-bottom:1px solid var(--border); color:var(--muted); font-size:0.75rem; text-transform:uppercase; font-weight:700; letter-spacing:1px; }
        td { padding:20px 25px; border-bottom:1px solid var(--border); vertical-align:top; color:var(--text); }
        tr:last-child td { border-bottom:none; }
        tr:hover td { background:rgba(255,255,255,0.03); }
        .muted { color:var(--muted); font-size:0.85rem; }
        .empty-state { padding:40px; text-align:center; color:var(--muted); }
        .drawer { position:fixed; inset:0; display:none; z-index:200; }
        .drawer.show { display:flex; }
        .drawer-backdrop { flex:1; background:rgba(2,6,23,0.65); }
        .drawer-panel { width:min(520px, 92vw); background:#050607; border-left:1px solid rgba(148,163,184,0.2); padding:24px; overflow-y:auto; }
        .drawer-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .drawer-header h3 { margin:0; font-family:'Cabinet Grotesk',sans-serif; font-size:1.4rem; }
        .drawer-sub { color:#94a3b8; font-size:0.85rem; }
        .drawer-section { border:1px solid rgba(148,163,184,0.12); border-radius:16px; padding:16px; background:linear-gradient(180deg, rgba(8,10,14,0.98), rgba(4,6,10,0.98)); margin-top:14px; }
        .drawer-section h4 { margin:0 0 8px; font-size:0.95rem; color:#e2e8f0; }
        .form-input { width:100%; background:#0b0b0b; border:1px solid rgba(148,163,184,0.2); padding:12px 14px; border-radius:10px; color:white; outline:none; transition:0.2s; font-family:inherit; font-size:0.95rem; }
        .form-input:focus { border-color:var(--accent); }
        .form-textarea { min-height:160px; resize:vertical; }
        .id-display { background:#0b0b0b; border:1px solid rgba(148,163,184,0.2); padding:12px 14px; border-radius:10px; color:#e2e8f0; font-weight:700; letter-spacing:0.2px; }
        .chip-btn { background:rgba(255,255,255,0.06); border:1px solid var(--border); color:#e2e8f0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
        .chip-btn:hover { border-color:var(--accent); color:white; }
        .footer-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:18px; }
        .drawer-panel::-webkit-scrollbar { width:8px; }
        .drawer-panel::-webkit-scrollbar-track { background:transparent; }
        .drawer-panel::-webkit-scrollbar-thumb { background:rgba(148,163,184,0.2); border-radius:999px; }
        .drawer-panel::-webkit-scrollbar-thumb:hover { background:rgba(148,163,184,0.4); }
        .action-group { display:inline-flex; gap:8px; align-items:center; justify-content:flex-end; }
        .action-btn { background:transparent; border:1px solid var(--border); color:var(--muted); width:34px; height:34px; border-radius:8px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; transition:0.2s; }
        .action-btn:hover { color:white; border-color:white; }
        .action-btn.delete:hover { color:var(--danger); border-color:var(--danger); }
        .confirm-modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:220; }
        .confirm-modal.show { display:flex; }
        .confirm-card { width:min(420px, 92vw); background:#0b0e14; border:1px solid rgba(148,163,184,0.2); border-radius:16px; padding:20px; box-shadow:0 30px 60px rgba(0,0,0,0.5); }
        .confirm-card h4 { margin:0 0 6px; font-family:'Cabinet Grotesk',sans-serif; }
        .confirm-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:16px; }
        .table-toolbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
        .search-input { width:min(360px, 100%); background:#0b0b0b; border:1px solid rgba(148,163,184,0.2); padding:10px 14px; border-radius:10px; color:white; font-size:0.9rem; }
        .search-input:focus { border-color:var(--accent); }
        .pagination { display:flex; align-items:center; gap:8px; margin-top:16px; justify-content:flex-end; }
        .page-btn { background:rgba(255,255,255,0.06); border:1px solid var(--border); color:#e2e8f0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
        .page-btn:disabled { opacity:0.4; cursor:not-allowed; }
        .page-info { color:var(--muted); font-size:0.85rem; }
        .linked-cell-btn { background:transparent; border:none; padding:0; color:#67e8f9; cursor:pointer; font:inherit; text-align:left; }
        .linked-cell-btn:hover { color:#a5f3fc; text-decoration:underline; }
        @@media (max-width: 900px) { main { padding:32px 24px; } aside { display:none; } }
    </style>
}
<main class="tool-page-main">
            <div class="header">
                <div>
                    <h1>Portlets</h1>
                    <p>Manage portlets assigned to page zones.</p>
                </div>
            </div>

            <div class="table-toolbar">
                <input class="search-input" id="portletSearch" placeholder="Search portlets..." />
                @if (canManage)
                {
                    <button class="primary-btn" id="openDrawer"><i class="fa-solid fa-plus"></i> New Record</button>
                }
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th style="width:8%;">ID</th>
                            <th style="width:16%;">Page</th>
                            <th style="width:14%;">Zone</th>
                            <th>Template Viewer</th>
                            <th style="width:10%;">Order</th>
                            <th style="width:11%;">Created</th>
                            <th style="width:16%;">DGUID</th>
                            <th style="width:12%; text-align:right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Portlets.Count == 0)
                        {
                            <tr>
                                <td colspan="8" class="empty-state">No portlets yet. Create your first portlet to get started.</td>
                            </tr>
                        }
                        else
                        {
                            foreach (var portlet in Model.Portlets)
                            {
                                <tr data-portlet-id="@portlet.Id"
                                    data-search="@($"{portlet.Dguid} {portlet.PageName} {portlet.ZoneKey} {portlet.TemplateViewerName}".ToLowerInvariant())">
                                    <td><strong>#@portlet.Id</strong></td>
                                    <td>
                                        <div style="font-weight:700;">
                                            <button class="linked-cell-btn view-page" type="button" data-page-id="@portlet.PageId" title="Open page details">
                                                @portlet.PageName
                                            </button>
                                        </div>
                                        <div class="muted">Page ID: @portlet.PageId</div>
                                    </td>
                                    <td>@portlet.ZoneKey</td>
                                    <td>
                                        <button class="linked-cell-btn view-template-viewer" type="button" data-template-viewer-id="@portlet.TemplateViewerId" title="Open template viewer details">
                                            @portlet.TemplateViewerName
                                        </button>
                                    </td>
                                    <td>@portlet.SortOrder</td>
                                    <td class="muted">@portlet.CreatedAtUtc.ToLocalTime().ToString("MMM d, yyyy")</td>
                                    <td class="muted" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:0.75rem;">@portlet.Dguid</td>
                                    <td style="text-align:right;">
                                        @if (canManage)
                                        {
                                            <div class="action-group">
                                                <button class="action-btn edit-portlet" type="button" data-portlet-id="@portlet.Id" title="Edit">
                                                    <i class="fa-solid fa-pen"></i>
                                                </button>
                                                <button class="action-btn delete delete-portlet" type="button" data-portlet-id="@portlet.Id" title="Delete">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="muted">—</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="portletPagination" style="display:none;">
                <button class="page-btn" id="prevPage">Previous</button>
                <span class="page-info" id="pageInfo">Page 1 of 1</span>
                <button class="page-btn" id="nextPage">Next</button>
            </div>
        </main>

    <div class="drawer" id="drawer">
        <div class="drawer-backdrop" id="drawerBackdrop"></div>
        <div class="drawer-panel">
            <div class="drawer-header">
                <div>
                    <h3 id="drawerTitle">Create Portlet</h3>
                    <div class="drawer-sub" id="drawerSubtitle">Assign a template viewer to a page zone.</div>
                </div>
                <button class="chip-btn" id="closeDrawer" type="button"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="drawer-section">
                <h4>Record Details</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <div>
                        <label class="muted" style="display:block;margin-bottom:6px;">ID</label>
                        <div class="id-display" id="idDisplay">1</div>
                    </div>
                    <div>
                        <label class="muted" style="display:block;margin-bottom:6px;">DGUID</label>
                        <div class="id-display" id="dguidDisplay" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:0.75rem;">Auto</div>
                    </div>
                </div>

                <label class="muted" style="display:block;margin-bottom:6px;">Page</label>
                <select class="form-input" id="pageId">
                    <option value="">Select page</option>
                    @foreach (var pageItem in Model.Pages)
                    {
                        <option value="@pageItem.Id">@pageItem.Name</option>
                    }
                </select>

                <label class="muted" style="display:block;margin:12px 0 6px;">Zone</label>
                <input class="form-input" id="zoneKey" placeholder="e.g. Body" />

                <label class="muted" style="display:block;margin:12px 0 6px;">Template Viewer</label>
                <select class="form-input" id="templateViewerId">
                    <option value="">Select template viewer</option>
                    @foreach (var viewer in Model.TemplateViewers)
                    {
                        <option value="@viewer.Id">@viewer.Name</option>
                    }
                </select>

                <label class="muted" style="display:block;margin:12px 0 6px;">Order</label>
                <input class="form-input" id="sortOrder" type="number" min="0" value="0" />
            </div>

            <div class="muted" id="formStatus" style="margin-top:12px;"></div>
            <div class="footer-actions">
                <button class="chip-btn" id="cancelDrawer" type="button">Cancel</button>
                <button class="primary-btn" id="savePortlet" type="button">Save Record</button>
            </div>
        </div>
    </div>

    <div class="drawer" id="pageDrawer">
        <div class="drawer-backdrop" id="pageDrawerBackdrop"></div>
        <div class="drawer-panel">
            <div class="drawer-header">
                <div>
                    <h3>Page Details</h3>
                    <div class="drawer-sub">Review and edit linked page details.</div>
                </div>
                <button class="chip-btn" id="closePageDrawer" type="button"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="drawer-section">
                <h4>Record Details</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <div>
                        <label class="muted" style="display:block;margin-bottom:6px;">ID</label>
                        <div class="id-display" id="pageRecordIdDisplay">—</div>
                    </div>
                    <div>
                        <label class="muted" style="display:block;margin-bottom:6px;">DGUID</label>
                        <div class="id-display" id="pageRecordDguidDisplay" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:0.75rem;">—</div>
                    </div>
                </div>
                <input type="hidden" id="pageRecordId" />
                <input type="hidden" id="pageRecordMasterpageId" />
            </div>

            <div class="drawer-section">
                <h4>Name</h4>
                <input class="form-input" id="pageRecordName" placeholder="Page name" />
            </div>

            <div class="drawer-section">
                <h4>Slug</h4>
                <input class="form-input" id="pageRecordSlug" placeholder="page/home" />
            </div>

            <div class="drawer-section">
                <h4>Masterpage</h4>
                <div class="id-display" id="pageRecordMasterpageDisplay">—</div>
            </div>

            <div class="muted" id="pageFormStatus" style="margin-top:12px;"></div>
            <div class="footer-actions">
                <button class="chip-btn" id="cancelPageDrawer" type="button">Close</button>
                <button class="primary-btn" id="savePageFromPortlets" type="button">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="drawer" id="templateViewerDrawer">
        <div class="drawer-backdrop" id="templateViewerDrawerBackdrop"></div>
        <div class="drawer-panel">
            <div class="drawer-header">
                <div>
                    <h3>Template Viewer Details</h3>
                    <div class="drawer-sub">Review and edit linked template viewer data.</div>
                </div>
                <button class="chip-btn" id="closeTemplateViewerDrawer" type="button"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="drawer-section">
                <h4>Record Details</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <div>
                        <label class="muted" style="display:block;margin-bottom:6px;">ID</label>
                        <div class="id-display" id="templateViewerIdDisplay">—</div>
                    </div>
                    <div>
                        <label class="muted" style="display:block;margin-bottom:6px;">DGUID</label>
                        <div class="id-display" id="templateViewerDguidDisplay" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:0.75rem;">—</div>
                    </div>
                </div>
                <input type="hidden" id="templateViewerRecordId" />
            </div>

            <div class="drawer-section">
                <h4>Name</h4>
                <input class="form-input" id="templateViewerRecordName" placeholder="Template viewer name" />
            </div>

            <div class="drawer-section">
                <h4>Viewer Type</h4>
                <select class="form-input" id="templateViewerRecordType">
                    <option value="">Select viewer type</option>
                    <option value="Page Templete Viewer">Page Templete Viewer</option>
                    <option value="MasterPage Templete Viewer">MasterPage Templete Viewer</option>
                    <option value="Templete Viewer DB">Templete Viewer DB</option>
                    <option value="Master Page">Master Page</option>
                    <option value="Sub Templete">Sub Templete</option>
                </select>
            </div>

            <div class="drawer-section">
                <h4>Templete Viewer</h4>
                <textarea class="form-input form-textarea" id="templateViewerRecordText" placeholder="Template text"></textarea>
            </div>

            <div class="muted" id="templateViewerFormStatus" style="margin-top:12px;"></div>
            <div class="footer-actions">
                <button class="chip-btn" id="cancelTemplateViewerDrawer" type="button">Close</button>
                <button class="primary-btn" id="saveTemplateViewerFromPortlets" type="button">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-card">
            <h4>Delete portlet?</h4>
            <div class="muted" id="confirmMessage">This will remove the portlet from the page.</div>
            <div class="confirm-actions">
                <button class="chip-btn" id="cancelDelete" type="button">Cancel</button>
                <button class="chip-btn danger-btn" id="confirmDelete" type="button">Delete</button>
            </div>
        </div>
    </div>

    <form id="antiForgery" method="post" style="display:none;">
        @Html.AntiForgeryToken()
    </form>

    <script src="/js/tool-database-sync.js"></script>
@section Scripts {
    <script>
        const canManage = @canManage.ToString().ToLowerInvariant();
        const portletsData = @Html.Raw(Model.PortletsJson);
        const pagesData = @Html.Raw(Model.PagesJson);
        const templateViewersData = @Html.Raw(Model.TemplateViewersJson);

        const drawer = document.getElementById('drawer');
        const drawerBackdrop = document.getElementById('drawerBackdrop');
        const openDrawer = document.getElementById('openDrawer');
        const closeDrawer = document.getElementById('closeDrawer');
        const cancelDrawer = document.getElementById('cancelDrawer');
        const savePortlet = document.getElementById('savePortlet');
        const drawerTitle = document.getElementById('drawerTitle');
        const drawerSubtitle = document.getElementById('drawerSubtitle');
        const formStatus = document.getElementById('formStatus');
        const csrfToken = document.querySelector('#antiForgery input[name="__RequestVerificationToken"]')?.value || '';
        window.BugenceToolDbSync?.init({
            endpoint: '/Tools/Portlets?handler=DatabaseSync',
            requestVerificationToken: csrfToken,
            topButtonAnchorId: 'openDrawer',
            editButtonAnchorId: 'savePortlet',
            editRecordIdElementId: 'idDisplay',
            editRowButtonSelector: '.edit-portlet'
        });

        const pageId = document.getElementById('pageId');
        const zoneKey = document.getElementById('zoneKey');
        const templateViewerId = document.getElementById('templateViewerId');
        const sortOrder = document.getElementById('sortOrder');
        const idDisplay = document.getElementById('idDisplay');
        const dguidDisplay = document.getElementById('dguidDisplay');

        const confirmModal = document.getElementById('confirmModal');
        const cancelDelete = document.getElementById('cancelDelete');
        const confirmDelete = document.getElementById('confirmDelete');
        let deletePortletId = null;
        const pageDrawer = document.getElementById('pageDrawer');
        const pageDrawerBackdrop = document.getElementById('pageDrawerBackdrop');
        const closePageDrawer = document.getElementById('closePageDrawer');
        const cancelPageDrawer = document.getElementById('cancelPageDrawer');
        const pageRecordId = document.getElementById('pageRecordId');
        const pageRecordMasterpageId = document.getElementById('pageRecordMasterpageId');
        const pageRecordIdDisplay = document.getElementById('pageRecordIdDisplay');
        const pageRecordDguidDisplay = document.getElementById('pageRecordDguidDisplay');
        const pageRecordName = document.getElementById('pageRecordName');
        const pageRecordSlug = document.getElementById('pageRecordSlug');
        const pageRecordMasterpageDisplay = document.getElementById('pageRecordMasterpageDisplay');
        const pageFormStatus = document.getElementById('pageFormStatus');
        const savePageFromPortlets = document.getElementById('savePageFromPortlets');
        const templateViewerDrawer = document.getElementById('templateViewerDrawer');
        const templateViewerDrawerBackdrop = document.getElementById('templateViewerDrawerBackdrop');
        const closeTemplateViewerDrawer = document.getElementById('closeTemplateViewerDrawer');
        const cancelTemplateViewerDrawer = document.getElementById('cancelTemplateViewerDrawer');
        const templateViewerRecordId = document.getElementById('templateViewerRecordId');
        const templateViewerIdDisplay = document.getElementById('templateViewerIdDisplay');
        const templateViewerDguidDisplay = document.getElementById('templateViewerDguidDisplay');
        const templateViewerRecordName = document.getElementById('templateViewerRecordName');
        const templateViewerRecordType = document.getElementById('templateViewerRecordType');
        const templateViewerRecordText = document.getElementById('templateViewerRecordText');
        const templateViewerFormStatus = document.getElementById('templateViewerFormStatus');
        const saveTemplateViewerFromPortlets = document.getElementById('saveTemplateViewerFromPortlets');

        const portletSearch = document.getElementById('portletSearch');
        const portletPagination = document.getElementById('portletPagination');
        const pageInfo = document.getElementById('pageInfo');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');

        const pageSize = 8;
        let currentPage = 1;
        const portletRows = Array.from(document.querySelectorAll('tbody tr[data-portlet-id]'));

        const showDrawer = (show) => {
            if (!drawer) return;
            drawer.classList.toggle('show', show);
        };

        const showPageDrawer = (show) => {
            if (!pageDrawer) return;
            pageDrawer.classList.toggle('show', show);
        };

        const showTemplateViewerDrawer = (show) => {
            if (!templateViewerDrawer) return;
            templateViewerDrawer.classList.toggle('show', show);
        };

        const resetDrawer = async () => {
            if (drawerTitle) drawerTitle.textContent = 'Create Portlet';
            if (drawerSubtitle) drawerSubtitle.textContent = 'Assign a template viewer to a page zone.';
            if (pageId) pageId.value = '';
            if (zoneKey) zoneKey.value = '';
            if (templateViewerId) templateViewerId.value = '';
            if (sortOrder) sortOrder.value = '0';
            if (savePortlet) savePortlet.removeAttribute('data-editing');
            setStatus('');
            if (dguidDisplay) dguidDisplay.textContent = 'Generating...';
            if (idDisplay) {
                idDisplay.textContent = '1';
                try {
                    const res = await fetch('/Tools/Portlets?handler=NextIdentity', {
                        method: 'GET',
                        credentials: 'include'
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data?.success) {
                            idDisplay.textContent = data.nextId ?? '1';
                            if (dguidDisplay) dguidDisplay.textContent = data.dguid || '';
                        }
                    }
                } catch {
                    idDisplay.textContent = '1';
                    if (dguidDisplay) dguidDisplay.textContent = '';
                }
            }
        };

        const setStatus = (message, isError = false) => {
            if (!formStatus) return;
            formStatus.textContent = message || '';
            formStatus.style.color = isError ? '#f59e0b' : '#94a3b8';
        };

        const setPageStatus = (message, isError = false) => {
            if (!pageFormStatus) return;
            pageFormStatus.textContent = message || '';
            pageFormStatus.style.color = isError ? '#f59e0b' : '#94a3b8';
        };

        const setTemplateViewerStatus = (message, isError = false) => {
            if (!templateViewerFormStatus) return;
            templateViewerFormStatus.textContent = message || '';
            templateViewerFormStatus.style.color = isError ? '#f59e0b' : '#94a3b8';
        };

        const showConfirm = (show) => {
            if (!confirmModal) return;
            confirmModal.classList.toggle('show', show);
        };

        const updatePagination = (filtered) => {
            const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
            if (currentPage > totalPages) currentPage = totalPages;
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const current = filtered.slice(start, end);

            portletRows.forEach(row => row.style.display = 'none');
            current.forEach(row => row.style.display = '');

            if (pageInfo) pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            if (prevPage) prevPage.disabled = currentPage === 1;
            if (nextPage) nextPage.disabled = currentPage === totalPages;
            if (portletPagination) portletPagination.style.display = filtered.length > pageSize ? 'flex' : 'none';
        };

        const filterRows = () => {
            const term = (portletSearch?.value || '').trim().toLowerCase();
            const filtered = portletRows.filter((row) => {
                const search = row.getAttribute('data-search') || '';
                return search.includes(term);
            });
            updatePagination(filtered);
        };

        filterRows();
        portletSearch?.addEventListener('input', () => {
            currentPage = 1;
            filterRows();
        });
        prevPage?.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage -= 1;
                filterRows();
            }
        });
        nextPage?.addEventListener('click', () => {
            currentPage += 1;
            filterRows();
        });

        openDrawer?.addEventListener('click', async () => {
            await resetDrawer();
            showDrawer(true);
        });
        closeDrawer?.addEventListener('click', () => showDrawer(false));
        cancelDrawer?.addEventListener('click', () => showDrawer(false));
        drawerBackdrop?.addEventListener('click', () => showDrawer(false));
        closePageDrawer?.addEventListener('click', () => showPageDrawer(false));
        cancelPageDrawer?.addEventListener('click', () => showPageDrawer(false));
        pageDrawerBackdrop?.addEventListener('click', () => showPageDrawer(false));
        closeTemplateViewerDrawer?.addEventListener('click', () => showTemplateViewerDrawer(false));
        cancelTemplateViewerDrawer?.addEventListener('click', () => showTemplateViewerDrawer(false));
        templateViewerDrawerBackdrop?.addEventListener('click', () => showTemplateViewerDrawer(false));

        document.querySelectorAll('.view-page').forEach((button) => {
            button.addEventListener('click', () => {
                const id = Number(button.getAttribute('data-page-id') || '0');
                const page = pagesData.find(item => Number(item.id || 0) === id);
                if (!page) {
                    setStatus('Page record not found.', true);
                    return;
                }
                if (pageRecordId) pageRecordId.value = String(page.id || '');
                if (pageRecordMasterpageId) pageRecordMasterpageId.value = page.masterpageId ? String(page.masterpageId) : '';
                if (pageRecordIdDisplay) pageRecordIdDisplay.textContent = `#${page.id || '—'}`;
                if (pageRecordDguidDisplay) pageRecordDguidDisplay.textContent = page.dguid || '—';
                if (pageRecordName) pageRecordName.value = page.name || '';
                if (pageRecordSlug) pageRecordSlug.value = page.slug || '';
                if (pageRecordMasterpageDisplay) pageRecordMasterpageDisplay.textContent = page.masterpageName || '—';
                if (pageRecordName) pageRecordName.disabled = !canManage;
                if (pageRecordSlug) pageRecordSlug.disabled = !canManage;
                if (savePageFromPortlets) savePageFromPortlets.style.display = canManage ? 'inline-flex' : 'none';
                setPageStatus('');
                showPageDrawer(true);
            });
        });

        document.querySelectorAll('.view-template-viewer').forEach((button) => {
            button.addEventListener('click', () => {
                const id = Number(button.getAttribute('data-template-viewer-id') || '0');
                const viewer = templateViewersData.find(item => Number(item.id || 0) === id);
                if (!viewer) {
                    setStatus('Template viewer record not found.', true);
                    return;
                }
                if (templateViewerRecordId) templateViewerRecordId.value = String(viewer.id || '');
                if (templateViewerIdDisplay) templateViewerIdDisplay.textContent = `#${viewer.id || '—'}`;
                if (templateViewerDguidDisplay) templateViewerDguidDisplay.textContent = viewer.dguid || '—';
                if (templateViewerRecordName) templateViewerRecordName.value = viewer.name || '';
                if (templateViewerRecordType) templateViewerRecordType.value = viewer.viewerType || '';
                if (templateViewerRecordText) templateViewerRecordText.value = viewer.templateText || '';
                if (templateViewerRecordName) templateViewerRecordName.disabled = !canManage;
                if (templateViewerRecordType) templateViewerRecordType.disabled = !canManage;
                if (templateViewerRecordText) templateViewerRecordText.disabled = !canManage;
                if (saveTemplateViewerFromPortlets) saveTemplateViewerFromPortlets.style.display = canManage ? 'inline-flex' : 'none';
                setTemplateViewerStatus('');
                showTemplateViewerDrawer(true);
            });
        });

        savePageFromPortlets?.addEventListener('click', async () => {
            if (!canManage) return;
            const idValue = Number(pageRecordId?.value || '0');
            const nameValue = pageRecordName?.value?.trim() || '';
            const slugValue = pageRecordSlug?.value?.trim() || '';
            const masterpageIdValue = pageRecordMasterpageId?.value ? Number(pageRecordMasterpageId.value) : null;
            if (!idValue || !nameValue) {
                setPageStatus('Please provide page name.', true);
                return;
            }
            setPageStatus('Saving changes...');
            if (savePageFromPortlets) savePageFromPortlets.disabled = true;
            try {
                const res = await fetch('/Tools/Pages?handler=Update', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({
                        id: idValue,
                        name: nameValue,
                        slug: slugValue,
                        masterpageId: masterpageIdValue
                    })
                });
                if (res.redirected) {
                    window.location.href = res.url;
                    return;
                }
                const data = await res.json();
                if (!res.ok || !data?.success) {
                    setPageStatus(data?.message || 'Unable to save page.', true);
                    return;
                }
                setPageStatus('Page updated.');
                window.location.reload();
            } catch {
                setPageStatus('Unable to save page.', true);
            } finally {
                if (savePageFromPortlets) savePageFromPortlets.disabled = false;
            }
        });

        saveTemplateViewerFromPortlets?.addEventListener('click', async () => {
            if (!canManage) return;
            const idValue = Number(templateViewerRecordId?.value || '0');
            const nameValue = templateViewerRecordName?.value?.trim() || '';
            const typeValue = templateViewerRecordType?.value?.trim() || '';
            const textValue = templateViewerRecordText?.value?.trim() || '';
            if (!idValue || !nameValue || !typeValue || !textValue) {
                setTemplateViewerStatus('Please provide name, viewer type and templete viewer.', true);
                return;
            }
            setTemplateViewerStatus('Saving changes...');
            if (saveTemplateViewerFromPortlets) saveTemplateViewerFromPortlets.disabled = true;
            try {
                const res = await fetch('/Tools/TempleteViewer?handler=Update', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({
                        id: idValue,
                        name: nameValue,
                        viewerType: typeValue,
                        templateText: textValue
                    })
                });
                if (res.redirected) {
                    window.location.href = res.url;
                    return;
                }
                const data = await res.json();
                if (!res.ok || !data?.success) {
                    setTemplateViewerStatus(data?.message || 'Unable to save template viewer.', true);
                    return;
                }
                setTemplateViewerStatus('Template viewer updated.');
                window.location.reload();
            } catch {
                setTemplateViewerStatus('Unable to save template viewer.', true);
            } finally {
                if (saveTemplateViewerFromPortlets) saveTemplateViewerFromPortlets.disabled = false;
            }
        });

        document.querySelectorAll('.edit-portlet').forEach((button) => {
            button.addEventListener('click', () => {
                const id = button.getAttribute('data-portlet-id');
                const portlet = portletsData.find(p => String(p.id) === String(id));
                if (!portlet) return;
                if (drawerTitle) drawerTitle.textContent = 'Edit Portlet';
                if (drawerSubtitle) drawerSubtitle.textContent = 'Update portlet details.';
                if (pageId) pageId.value = portlet.pageId || '';
                if (zoneKey) zoneKey.value = portlet.zoneKey || '';
                if (templateViewerId) templateViewerId.value = portlet.templateViewerId || '';
                if (sortOrder) sortOrder.value = portlet.sortOrder || 0;
                if (idDisplay) idDisplay.textContent = portlet.id || '1';
                if (dguidDisplay) dguidDisplay.textContent = portlet.dguid || 'Auto';
                if (savePortlet) savePortlet.setAttribute('data-editing', id || '');
                showDrawer(true);
            });
        });

        document.querySelectorAll('.delete-portlet').forEach((button) => {
            button.addEventListener('click', () => {
                deletePortletId = button.getAttribute('data-portlet-id');
                showConfirm(true);
            });
        });

        cancelDelete?.addEventListener('click', () => {
            deletePortletId = null;
            showConfirm(false);
        });
        confirmDelete?.addEventListener('click', async () => {
            if (!deletePortletId) return;
            try {
                const res = await fetch('/Tools/Portlets?handler=Delete', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({ id: Number(deletePortletId) })
                });
                const data = await res.json();
                if (!res.ok || !data?.success) {
                    setStatus(data?.message || 'Unable to delete portlet.', true);
                    return;
                }
                window.location.reload();
            } catch (err) {
                setStatus('Unable to delete portlet.', true);
            }
        });

        savePortlet?.addEventListener('click', async () => {
            if (!canManage) return;
            const pageValue = pageId?.value ? Number(pageId.value) : 0;
            const zoneValue = zoneKey?.value?.trim() || '';
            const viewerValue = templateViewerId?.value ? Number(templateViewerId.value) : 0;
            const orderValue = Number(sortOrder?.value || 0);
            const dguidValue = dguidDisplay?.textContent?.trim() || '';
            if (!pageValue || !zoneValue || !viewerValue) {
                setStatus('Please select page, zone, and template viewer.', true);
                return;
            }
            const editingId = savePortlet.getAttribute('data-editing');
            setStatus(editingId ? 'Updating portlet...' : 'Creating portlet...');
            savePortlet.disabled = true;
            try {
                const res = await fetch(`/Tools/Portlets?handler=${editingId ? 'Update' : 'Create'}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify(editingId ? {
                        id: Number(editingId),
                        pageId: pageValue,
                        zoneKey: zoneValue,
                        templateViewerId: viewerValue,
                        sortOrder: orderValue
                    } : {
                        dguid: dguidValue,
                        pageId: pageValue,
                        zoneKey: zoneValue,
                        templateViewerId: viewerValue,
                        sortOrder: orderValue
                    })
                });
                const data = await res.json();
                if (!res.ok || !data?.success) {
                    setStatus(data?.message || 'Unable to save portlet.', true);
                    return;
                }
                window.location.reload();
            } catch (err) {
                setStatus('Unable to save portlet.', true);
            } finally {
                savePortlet.disabled = false;
            }
        });

        const profileCard = document.getElementById('profileCard');
        profileCard?.addEventListener('click', () => profileCard.classList.toggle('show'));
    </script>
}

