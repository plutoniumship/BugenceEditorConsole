@page
@model BugenceEditConsole.Pages.Tools.ApplicationsModel
@{
    ViewData["Title"] = "Applications";
    ViewData["BodyClass"] = "page-tools-applications";
    var tables = Model.Tables;
    var canManage = Model.CanManageApps;
    string ResolveManageUrl(string tableName, Guid id)
    {
        if (string.Equals(tableName, "Masterpages", StringComparison.OrdinalIgnoreCase))
        {
            return "/Tools/Masterpage";
        }
        if (string.Equals(tableName, "Pages", StringComparison.OrdinalIgnoreCase))
        {
            return "/Tools/Pages";
        }
        if (string.Equals(tableName, "TempleteViewers", StringComparison.OrdinalIgnoreCase) ||
            string.Equals(tableName, "TemplateViewers", StringComparison.OrdinalIgnoreCase))
        {
            return "/Tools/TempleteViewer";
        }
        if (string.Equals(tableName, "DatabaseQuerySelectors", StringComparison.OrdinalIgnoreCase))
        {
            return "/Tools/DatabaseQuerySelector";
        }
        if (string.Equals(tableName, "PagePortlets", StringComparison.OrdinalIgnoreCase))
        {
            return "/Tools/Portlets";
        }
        if (string.Equals(tableName, "SystemProperties", StringComparison.OrdinalIgnoreCase))
        {
            return "/Tools/SystemProperties";
        }
        if (string.Equals(tableName, "Permissions", StringComparison.OrdinalIgnoreCase))
        {
            return "/Tools/Permissions";
        }
        return $"/Application/Table/{id}";
    }
}
@section Head {
<style>
        :root { --bg:#050505; --surface:#0a0a0a; --border:rgba(255,255,255,0.08); --text:#fff; --muted:#a1a1aa; --accent:#06b6d4; --success:#10b981; --danger:#ef4444; --warning:#f59e0b; --purple:#8b5cf6; }
        * { box-sizing:border-box; outline:none; }
        .sidebar-scroll {
            flex: 1 1 auto;
            overflow-y: auto;
            padding-right: 8px;
            margin-right: -8px;
        }
        .tool-page-main { flex-grow:1; padding:40px 60px; overflow-y:auto; background: radial-gradient(circle at 0% 0%, rgba(6,182,212,0.03), transparent 40%); position:relative; }
        .header { margin-bottom:24px; display:flex; align-items:flex-start; justify-content:space-between; gap:16px; }
        .header h1 { font-family:'Cabinet Grotesk',sans-serif; font-size:2.5rem; margin:0 0 8px; }
        .header p { margin:0; color:var(--muted); font-size:0.95rem; }
        .onboarding-banner {
            margin: 0 0 16px;
            border: 1px solid rgba(245, 158, 11, 0.45);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.14), rgba(245, 158, 11, 0.05));
            border-radius: 14px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px;
        }
        .onboarding-banner strong { color: #fde68a; font-size: 0.9rem; display: block; margin-bottom: 4px; }
        .onboarding-banner span { color: #f1f5f9; font-size: 0.82rem; }
        .onboarding-banner .chip-btn { border-color: rgba(245,158,11,0.55); color: #fde68a; }
        .primary-btn { background:var(--accent); color:#00131a; border:none; border-radius:10px; font-weight:700; padding:12px 16px; cursor:pointer; display:inline-flex; align-items:center; gap:8px; }
        .primary-btn:hover { background:#0891b2; color:white; }
        .table-wrapper { background:var(--surface); border:1px solid var(--border); border-radius:16px; overflow:hidden; }
        table { width:100%; border-collapse:collapse; }
        th { text-align:left; padding:18px 25px; background:rgba(255,255,255,0.02); border-bottom:1px solid var(--border); color:var(--muted); font-size:0.75rem; text-transform:uppercase; font-weight:700; letter-spacing:1px; }
        td { padding:20px 25px; border-bottom:1px solid var(--border); vertical-align:top; color:var(--text); }
        tr:last-child td { border-bottom:none; }
        tr:hover td { background:rgba(255,255,255,0.03); }
        .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:0.75rem; background:rgba(6,182,212,0.12); color:var(--accent); border:1px solid rgba(6,182,212,0.2); }
        .muted { color:var(--muted); font-size:0.85rem; }
        .columns { display:flex; flex-wrap:wrap; gap:8px; }
        .column-chip { background:rgba(255,255,255,0.05); border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-size:0.75rem; color:#e2e8f0; }
        .empty-state { padding:40px; text-align:center; color:var(--muted); }
        .drawer { position:fixed; inset:0; display:none; z-index:200; }
        .drawer.show { display:flex; }
        .drawer-backdrop { flex:1; background:rgba(2,6,23,0.65); }
        .drawer-panel { width:min(520px, 92vw); background:#050607; border-left:1px solid rgba(148,163,184,0.2); padding:24px; overflow-y:auto; }
        .drawer-panel.permissions-panel { width:min(680px, 96vw); padding:26px 22px 20px; }
        .drawer-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .drawer-header h3 { margin:0; font-family:'Cabinet Grotesk',sans-serif; font-size:1.4rem; }
        .drawer-sub { color:#94a3b8; font-size:0.85rem; }
        .form-input { width:100%; background:#0b0b0b; border:1px solid rgba(148,163,184,0.2); padding:12px 14px; border-radius:10px; color:white; outline:none; transition:0.2s; font-family:inherit; font-size:0.95rem; }
        .form-input:focus { border-color:var(--accent); }
        .role-select { width:100%; background:#0b0b0b; border:1px solid rgba(148,163,184,0.2); padding:0 12px; border-radius:10px; color:white; outline:none; cursor:pointer; appearance:none; height:44px; background-image:url(\"data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e\"); background-repeat:no-repeat; background-position:right 14px center; background-size:16px; }
        .columns-grid { display:grid; grid-template-columns:1.1fr 1fr 0.6fr 0.6fr 0.6fr 0.4fr 40px; gap:10px; align-items:center; }
        .columns-grid label { font-size:0.75rem; color:#94a3b8; }
        .drawer-section { border:1px solid rgba(148,163,184,0.12); border-radius:16px; padding:16px; background:linear-gradient(180deg, rgba(8,10,14,0.98), rgba(4,6,10,0.98)); margin-top:14px; }
        .drawer-section h4 { margin:0 0 8px; font-size:0.95rem; color:#e2e8f0; }
        .chip-btn { background:rgba(255,255,255,0.06); border:1px solid var(--border); color:#e2e8f0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
        .chip-btn:hover { border-color:var(--accent); color:white; }
        .danger-btn { background:transparent; border:1px solid rgba(239,68,68,0.4); color:#fecaca; }
        .danger-btn:hover { border-color:#ef4444; color:white; }
        .footer-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:18px; }
        .drawer-panel::-webkit-scrollbar { width:8px; }
        .drawer-panel::-webkit-scrollbar-track { background:transparent; }
        .drawer-panel::-webkit-scrollbar-thumb { background:rgba(148,163,184,0.2); border-radius:999px; }
        .drawer-panel::-webkit-scrollbar-thumb:hover { background:rgba(148,163,184,0.4); }
        .form-input[type="number"] { padding-right:44px; text-align:left; }
        .form-input[type="number"]::-webkit-outer-spin-button,
        .form-input[type="number"]::-webkit-inner-spin-button { margin-right:-32px; }
        .form-input[type="number"] { -moz-appearance:textfield; }
        .action-group { display:inline-flex; gap:8px; align-items:center; justify-content:flex-end; }
        .action-btn { background:transparent; border:1px solid var(--border); color:var(--muted); width:34px; height:34px; border-radius:8px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; transition:0.2s; }
        .action-btn:hover { color:white; border-color:white; }
        .action-btn.delete:hover { color:var(--danger); border-color:var(--danger); }
        .confirm-modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:220; }
        .confirm-modal.show { display:flex; }
        .confirm-card { width:min(420px, 92vw); background:#0b0e14; border:1px solid rgba(148,163,184,0.2); border-radius:16px; padding:20px; box-shadow:0 30px 60px rgba(0,0,0,0.5); }
        .confirm-card h4 { margin:0 0 6px; font-family:'Cabinet Grotesk',sans-serif; }
        .confirm-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:16px; }
        .column-deleted { opacity:0.5; }
        .column-deleted .form-input { text-decoration: line-through; }
        .deleted-badge { display:inline-flex; align-items:center; gap:6px; font-size:0.7rem; color:#fca5a5; border:1px solid rgba(239,68,68,0.35); border-radius:999px; padding:2px 8px; }
        .table-toolbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
        .search-input { width:min(360px, 100%); background:#0b0b0b; border:1px solid rgba(148,163,184,0.2); padding:10px 14px; border-radius:10px; color:white; font-size:0.9rem; }
        .search-input:focus { border-color:var(--accent); }
        .pagination { display:flex; align-items:center; gap:8px; margin-top:16px; justify-content:flex-end; }
        .page-btn { background:rgba(255,255,255,0.06); border:1px solid var(--border); color:#e2e8f0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
        .page-btn:disabled { opacity:0.4; cursor:not-allowed; }
        .page-info { color:var(--muted); font-size:0.85rem; }
        .permissions-headline { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:6px; }
        .permissions-metrics { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
        .metric { border:1px solid rgba(148,163,184,0.25); border-radius:999px; padding:5px 10px; font-size:0.72rem; font-weight:700; color:#dbe7f5; letter-spacing:0.03em; line-height:1; }
        .metric.admin { border-color:rgba(34,211,238,0.45); color:#7de9ff; }
        .metric.view { border-color:rgba(59,130,246,0.45); color:#9cc5ff; }
        .metric.noaccess { border-color:rgba(239,68,68,0.45); color:#fca5a5; }
        .metric.changed { border-color:rgba(245,158,11,0.45); color:#fcd34d; }
        .permissions-toolbar { margin-top:14px; display:grid; grid-template-columns:1fr 160px; gap:10px; align-items:center; }
        .permissions-search { width:100%; }
        .permissions-filter { height:42px; }
        .permissions-quick-actions { margin-top:12px; display:grid; grid-template-columns:repeat(3, minmax(0, 1fr)); gap:8px; }
        .permissions-quick-actions .chip-btn { width:100%; min-height:34px; justify-content:center; text-align:center; }
        .permissions-list { display:flex; flex-direction:column; gap:12px; margin-top:14px; }
        .permission-row {
            display:grid;
            grid-template-columns:minmax(0, 1.35fr) 118px minmax(250px, 1fr) minmax(130px, 0.8fr);
            gap:12px;
            align-items:center;
            border:1px solid rgba(148,163,184,0.16);
            border-radius:12px;
            padding:13px 12px;
            background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015));
        }
        .permission-identity { min-width:0; display:flex; align-items:center; gap:11px; }
        .permission-avatar {
            width:34px;
            height:34px;
            border-radius:10px;
            display:grid;
            place-items:center;
            background:linear-gradient(135deg, rgba(6,182,212,0.85), rgba(34,211,238,0.45));
            color:#022330;
            font-size:0.78rem;
            font-weight:800;
        }
        .permission-name { font-size:0.9rem; font-weight:700; color:#e2e8f0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1.25; }
        .permission-email { color:#94a3b8; font-size:0.75rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:1px; }
        .permission-role {
            color:#a1a1aa;
            font-size:0.7rem;
            text-transform:uppercase;
            letter-spacing:0.06em;
            border:1px solid rgba(148,163,184,0.2);
            border-radius:999px;
            padding:4px 8px;
            text-align:center;
            justify-self:stretch;
            align-self:center;
            line-height:1.2;
        }
        .permission-control { min-width:0; display:flex; align-items:center; }
        .permission-access { display:flex; gap:6px; width:100%; flex-wrap:wrap; }
        .access-btn {
            background:rgba(255,255,255,0.04);
            border:1px solid rgba(148,163,184,0.24);
            color:#dbe7f5;
            border-radius:9px;
            height:35px;
            min-width:82px;
            flex:1 1 82px;
            padding:0 10px;
            font-size:0.74rem;
            font-weight:700;
            cursor:pointer;
            transition:0.15s ease;
        }
        .access-btn:hover { border-color:rgba(6,182,212,0.55); color:#fff; }
        .access-btn.active.admin { border-color:rgba(34,211,238,0.55); background:rgba(34,211,238,0.14); color:#8eedff; }
        .access-btn.active.viewonly { border-color:rgba(59,130,246,0.55); background:rgba(59,130,246,0.14); color:#acd1ff; }
        .access-btn.active.noaccess { border-color:rgba(239,68,68,0.55); background:rgba(239,68,68,0.14); color:#ffc2c2; }
        .permission-lock { color:#94a3b8; font-size:0.8rem; text-align:left; }
        .permission-state { font-size:0.72rem; text-align:right; color:#9fb2c7; line-height:1.35; }
        .permission-state .override { color:#fcd34d; }
        .permission-state .default { color:#6ee7b7; }
        .permission-row.changed { border-color:rgba(245,158,11,0.4); box-shadow:0 0 0 1px rgba(245,158,11,0.15) inset; }
        .permissions-empty {
            margin-top:14px;
            border:1px dashed rgba(148,163,184,0.26);
            border-radius:12px;
            padding:18px;
            display:flex;
            flex-direction:column;
            gap:8px;
            align-items:flex-start;
            background:rgba(255,255,255,0.02);
        }
        .permissions-empty i { color:#94a3b8; font-size:1.1rem; }
        .permissions-empty strong { font-size:0.92rem; color:#e2e8f0; }
        .permissions-empty span { font-size:0.82rem; color:#94a3b8; }
        .permissions-audit { margin-top:16px; border-top:1px solid rgba(148,163,184,0.18); padding-top:12px; }
        .permissions-audit-title { font-size:0.8rem; font-weight:700; color:#d7e5f6; letter-spacing:0.05em; text-transform:uppercase; }
        .permissions-audit-list { margin-top:8px; display:flex; flex-direction:column; gap:8px; max-height:180px; overflow:auto; padding-right:4px; }
        .permissions-audit-item { border:1px solid rgba(148,163,184,0.2); border-radius:10px; padding:9px 10px; background:rgba(255,255,255,0.015); }
        .permissions-audit-main { font-size:0.8rem; color:#d9e7f7; }
        .permissions-audit-main strong { color:#ffffff; }
        .permissions-audit-meta { margin-top:4px; color:#8fa5bd; font-size:0.72rem; display:flex; justify-content:space-between; gap:10px; }
        .permissions-audit-empty { color:#8fa5bd; font-size:0.8rem; padding:10px; border:1px dashed rgba(148,163,184,0.2); border-radius:10px; }
        @@media (max-width: 1100px) { .columns-grid { grid-template-columns:1fr 1fr 0.8fr 0.8fr 0.8fr 0.5fr 36px; } }
        @@media (max-width: 920px) {
            .permission-row { grid-template-columns:1fr; }
            .permission-state { text-align:left; }
            .permissions-toolbar { grid-template-columns:1fr; }
            .permissions-quick-actions { grid-template-columns:repeat(2, minmax(0, 1fr)); }
        }
        @@media (max-width: 640px) {
            .permissions-quick-actions { grid-template-columns:1fr; }
        }
        @@media (max-width: 900px) { main { padding:32px 24px; } aside { display:none; } }
        @@media (max-width: 720px) { .columns-grid { grid-template-columns:1fr; gap:6px; } }
    </style>
}
<main class="tool-page-main">
            <div class="header">
                <div>
                    <h1>Applications</h1>
                    <p>Create SQL tables with custom columns. The system adds a unique `DGUID` column automatically.</p>
                </div>
            </div>
            @if (Model.ShowPermissionOnboarding)
            {
                <div class="onboarding-banner" id="permissionOnboardingBanner">
                    <div>
                        <strong>Starter Plan Requirement</strong>
                        <span>Configure and save table permissions before moving to the dashboard. Open a table permissions panel and click <em>Save Permissions</em>.</span>
                    </div>
                    <button class="chip-btn" id="openFirstPermissionSetup"><i class="fa-solid fa-shield-halved"></i> Setup Now</button>
                </div>
            }

            <div class="table-toolbar">
                <input class="search-input" id="tableSearch" placeholder="Search tables or columns..." />
                @if (canManage)
                {
                    <button class="primary-btn" id="openDrawer"><i class="fa-solid fa-plus"></i> New Application</button>
                }
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th style="width:8%;">ID</th>
                            <th style="width:20%;">Table Name</th>
                            <th>Columns</th>
                            <th style="width:14%;">Created</th>
                            <th style="width:18%;">DGUID</th>
                            <th style="width:12%; text-align:right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (tables.Count == 0)
                        {
                            <tr>
                                <td colspan="6" class="empty-state">No applications yet. Create your first table to get started.</td>
                            </tr>
                        }
                        else
                        {
                            foreach (var table in tables)
                            {
                                var columnsText = string.Join(" ", table.Columns.Select(c => $"{c.Name} {c.Type}"));
                                <tr data-table-id="@table.Id"
                                    data-table-name="@(table.DisplayName ?? table.TableName)"
                                    data-columns='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(table.Columns, new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }))'
                                    data-search="@($"{table.Id} {table.DisplayName ?? table.TableName} {columnsText}".ToLowerInvariant())">
                                    <td><strong>@table.DisplayId</strong></td>
                                    <td>
                                        <div style="font-weight:700;">@(table.DisplayName ?? table.TableName)</div>
                                        <span class="pill">DGUID</span>
                                    </td>
                                    <td>
                                        <div class="columns">
                                            @if (table.Columns.Count == 0)
                                            {
                                                <span class="muted">No columns found</span>
                                            }
                                            else
                                            {
                                                foreach (var column in table.Columns)
                                                {
                                                    var typeLabel = column.Type;
                                                    if (column.Length.HasValue)
                                                    {
                                                        typeLabel = $"{typeLabel}({column.Length})";
                                                    }
                                                    else if (column.Precision.HasValue)
                                                    {
                                                        typeLabel = $"{typeLabel}({column.Precision},{column.Scale ?? 0})";
                                                    }
                                                    <span class="column-chip">@column.Name · @typeLabel</span>
                                                }
                                            }
                                        </div>
                                    </td>
                                    <td class="muted">@table.CreatedAtUtc.ToLocalTime().ToString("MMM d, yyyy")</td>
                                    <td class="muted" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:0.75rem;">@table.Id</td>
                                    <td style="text-align:right;">
                                        <div class="action-group">
                                            <a class="action-btn" href="@ResolveManageUrl(table.TableName ?? string.Empty, table.Id)" title="Manage records">
                                                <i class="fa-solid fa-table-list"></i>
                                            </a>
                                            @if (table.CanManage)
                                            {
                                                <button class="action-btn permissions-table" type="button" data-table-id="@table.Id" data-table-name="@(table.DisplayName ?? table.TableName)" title="Permissions">
                                                    <i class="fa-solid fa-shield-halved"></i>
                                                </button>
                                                @if (!table.IsSystem)
                                                {
                                                    <button class="action-btn sync-table" type="button" data-table-id="@table.Id" title="Sync columns">
                                                        <i class="fa-solid fa-rotate"></i>
                                                    </button>
                                                    <button class="action-btn edit-table" type="button" data-table-id="@table.Id" title="Edit">
                                                        <i class="fa-solid fa-pen"></i>
                                                    </button>
                                                    <button class="action-btn delete delete-table" type="button" data-table-id="@table.Id" title="Delete">
                                                        <i class="fa-solid fa-trash"></i>
                                                    </button>
                                                }
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="tablePagination" style="display:none;">
                <button class="page-btn" id="prevPage">Previous</button>
                <span class="page-info" id="pageInfo">Page 1 of 1</span>
                <button class="page-btn" id="nextPage">Next</button>
            </div>
        </main>

    <div class="drawer" id="drawer">
        <div class="drawer-backdrop" id="drawerBackdrop"></div>
        <div class="drawer-panel">
            <div class="drawer-header">
                <div>
                    <h3 id="drawerTitle">Create Application Table</h3>
                    <div class="drawer-sub" id="drawerSubtitle">Define table and columns. DGUID is added automatically.</div>
                </div>
                <button class="chip-btn" id="closeDrawer"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <input type="hidden" id="tableId" />
            <div class="drawer-section">
                <h4>Table Details</h4>
                <label class="muted" style="display:block; margin-top:10px;">Table Name</label>
                <input class="form-input" id="tableName" placeholder="e.g. DUsers" />
            </div>

            <div class="drawer-section">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                    <h4 style="margin:0;">Columns</h4>
                    <div style="display:flex; gap:8px;">
                        <button class="chip-btn" id="syncColumns"><i class="fa-solid fa-rotate"></i> Sync</button>
                        <button class="chip-btn" id="addColumn"><i class="fa-solid fa-plus"></i> Add Column</button>
                    </div>
                </div>
                <div class="columns-grid" style="margin-top:10px;">
                    <label>Column Name</label>
                    <label>Type</label>
                    <label>Length</label>
                    <label>Precision</label>
                    <label>Scale</label>
                    <label>Nullable</label>
                    <label></label>
                </div>
                <div id="columnsList" style="margin-top:8px; display:flex; flex-direction:column; gap:10px;"></div>
            </div>

            <div id="formStatus" class="muted" style="margin-top:12px;"></div>
            <div class="footer-actions">
                <button class="chip-btn" id="cancelCreate">Cancel</button>
                <button class="primary-btn" id="saveCreate">Create Table</button>
            </div>
        </div>
    </div>

    <div class="confirm-modal" id="confirmModal">
        <div class="drawer-backdrop"></div>
        <div class="confirm-card">
            <h4>Delete Application</h4>
            <div class="muted" id="confirmMessage">Are you sure you want to delete this table? This will remove the SQL table and all records.</div>
            <div class="confirm-actions">
                <button class="chip-btn" id="cancelDelete">Cancel</button>
                <button class="primary-btn" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>

    <div class="drawer" id="permissionsDrawer">
        <div class="drawer-backdrop" id="permissionsDrawerBackdrop"></div>
        <div class="drawer-panel permissions-panel">
            <div class="drawer-header">
                <div>
                    <h3 id="permissionsTitle">Table Permissions</h3>
                    <div class="drawer-sub">Per-user row permissions for this application table.</div>
                </div>
                <button class="chip-btn" id="closePermissionsDrawer"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="drawer-section">
                <div class="permissions-headline">
                    <h4>Access Matrix</h4>
                    <div class="permissions-metrics">
                        <span class="metric admin" id="metricAdmin">Admin: 0</span>
                        <span class="metric view" id="metricView">ViewOnly: 0</span>
                        <span class="metric noaccess" id="metricNoAccess">NoAccess: 0</span>
                        <span class="metric changed" id="metricChanged">Changed: 0</span>
                    </div>
                </div>
                <div class="muted">Set row-level access per member. Owner remains locked at Admin.</div>
                <div class="permissions-toolbar">
                    <input class="search-input permissions-search" id="permissionsSearch" placeholder="Search member, email, role..." />
                    <select class="role-select permissions-filter" id="permissionsFilter">
                        <option value="all">All Members</option>
                        <option value="changed">Changed Only</option>
                        <option value="admin">Admin Access</option>
                        <option value="viewonly">ViewOnly Access</option>
                        <option value="noaccess">NoAccess</option>
                    </select>
                </div>
                <div class="permissions-quick-actions">
                    <button class="chip-btn" id="applyRoleDefaults"><i class="fa-solid fa-wand-magic-sparkles"></i> Role Defaults</button>
                    <button class="chip-btn" id="grantAdminsOnly"><i class="fa-solid fa-user-shield"></i> Admin Role = Admin</button>
                    <button class="chip-btn" id="restrictViewers"><i class="fa-solid fa-user-lock"></i> Viewer Role = NoAccess</button>
                    <button class="chip-btn" id="grantViewOnlyAll"><i class="fa-solid fa-eye"></i> Set All ViewOnly</button>
                    <button class="chip-btn" id="grantAdminAll"><i class="fa-solid fa-shield-halved"></i> Set All Admin</button>
                    <button class="chip-btn" id="lockdownNoAccess"><i class="fa-solid fa-lock"></i> Set All NoAccess</button>
                    <button class="chip-btn" id="resetPermissionDefaults"><i class="fa-solid fa-rotate-left"></i> Reset Defaults</button>
                </div>
                <div id="permissionsStatus" class="muted" style="margin-top:10px;"></div>
                <div id="permissionsList" class="permissions-list"></div>
                <div id="permissionsEmpty" class="permissions-empty" style="display:none;">
                    <i class="fa-solid fa-users"></i>
                    <strong>No editable team members found.</strong>
                    <span>Invite members from Teams to configure row-level access beyond owner permissions.</span>
                    <a href="/Settings/Teams" class="chip-btn">Open Teams</a>
                </div>
                <div class="permissions-audit" id="permissionsAudit">
                    <div class="permissions-audit-title">Recent Permission Activity</div>
                    <div class="permissions-audit-list" id="permissionsAuditList"></div>
                </div>
            </div>
            <div class="footer-actions">
                <button class="chip-btn" id="cancelPermissions">Cancel</button>
                <button class="primary-btn" id="savePermissions">Save Permissions</button>
            </div>
        </div>
    </div>

    <form id="antiForgery" method="post" style="display:none;">
        @Html.AntiForgeryToken()
    </form>

    <script src="/js/tool-database-sync.js"></script>
@section Scripts {
    <script>
        const profileCard = document.getElementById('profileCard');
        const closeProfileDropdown = () => profileCard?.classList.remove('show');
        profileCard?.addEventListener('click', (event) => {
            event.stopPropagation();
            profileCard.classList.toggle('show');
        });
        document.addEventListener('click', (event) => {
            if (!(event.target instanceof HTMLElement)) return;
            if (profileCard?.contains(event.target)) return;
            closeProfileDropdown();
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') closeProfileDropdown();
        });

        const canManage = @canManage.ToString().ToLowerInvariant();
        const drawer = document.getElementById('drawer');
        const openDrawer = document.getElementById('openDrawer');
        const closeDrawer = document.getElementById('closeDrawer');
        const drawerBackdrop = document.getElementById('drawerBackdrop');
        const cancelCreate = document.getElementById('cancelCreate');
        const addColumn = document.getElementById('addColumn');
        const syncColumns = document.getElementById('syncColumns');
        const columnsList = document.getElementById('columnsList');
        const tableName = document.getElementById('tableName');
        const tableId = document.getElementById('tableId');
        const drawerTitle = document.getElementById('drawerTitle');
        const drawerSubtitle = document.getElementById('drawerSubtitle');
        const saveCreate = document.getElementById('saveCreate');
        const formStatus = document.getElementById('formStatus');
        const csrfToken = document.querySelector('#antiForgery input[name="__RequestVerificationToken"]')?.value || '';
        window.BugenceToolDbSync?.init({
            endpoint: '/Tools/Applications?handler=DatabaseSync',
            requestVerificationToken: csrfToken,
            topButtonAnchorId: 'openDrawer',
            editButtonAnchorId: 'saveCreate',
            editRecordIdElementId: 'tableId',
            editRowButtonSelector: '.edit-table'
        });
        const currentUserDisplayName = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.UserName));
        const tablesData = @Html.Raw(Model.TablesJson);
        const confirmModal = document.getElementById('confirmModal');
        const cancelDelete = document.getElementById('cancelDelete');
        const confirmDelete = document.getElementById('confirmDelete');
        const permissionsDrawer = document.getElementById('permissionsDrawer');
        const permissionsDrawerBackdrop = document.getElementById('permissionsDrawerBackdrop');
        const closePermissionsDrawer = document.getElementById('closePermissionsDrawer');
        const cancelPermissions = document.getElementById('cancelPermissions');
        const savePermissions = document.getElementById('savePermissions');
        const permissionsStatus = document.getElementById('permissionsStatus');
        const permissionsTitle = document.getElementById('permissionsTitle');
        const permissionsList = document.getElementById('permissionsList');
        const permissionsEmpty = document.getElementById('permissionsEmpty');
        const permissionsSearch = document.getElementById('permissionsSearch');
        const permissionsFilter = document.getElementById('permissionsFilter');
        const grantViewOnlyAll = document.getElementById('grantViewOnlyAll');
        const grantAdminAll = document.getElementById('grantAdminAll');
        const lockdownNoAccess = document.getElementById('lockdownNoAccess');
        const resetPermissionDefaults = document.getElementById('resetPermissionDefaults');
        const applyRoleDefaults = document.getElementById('applyRoleDefaults');
        const grantAdminsOnly = document.getElementById('grantAdminsOnly');
        const restrictViewers = document.getElementById('restrictViewers');
        const metricAdmin = document.getElementById('metricAdmin');
        const metricView = document.getElementById('metricView');
        const metricNoAccess = document.getElementById('metricNoAccess');
        const metricChanged = document.getElementById('metricChanged');
        const permissionsAuditList = document.getElementById('permissionsAuditList');
        const openFirstPermissionSetup = document.getElementById('openFirstPermissionSetup');
        const isPermissionOnboarding = @Model.ShowPermissionOnboarding.ToString().ToLowerInvariant();
        let deleteTableId = null;
        let permissionsTableId = null;
        let permissionsMembers = [];
        let permissionsOriginalByUser = new Map();
        let permissionsCurrentByUser = new Map();
        let permissionAuditEntries = [];
        const tableSearch = document.getElementById('tableSearch');
        const tablePagination = document.getElementById('tablePagination');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const pageInfo = document.getElementById('pageInfo');
        const tableRows = Array.from(document.querySelectorAll('tbody tr[data-table-id]'));
        let currentPage = 1;
        const pageSize = 6;

        const showDrawer = (show) => {
            if (!drawer) return;
            drawer.classList.toggle('show', show);
        };
        const showPermissionsDrawer = (show) => {
            if (!permissionsDrawer) return;
            permissionsDrawer.classList.toggle('show', show);
        };
        closeDrawer?.addEventListener('click', () => showDrawer(false));
        drawerBackdrop?.addEventListener('click', () => showDrawer(false));
        cancelCreate?.addEventListener('click', () => showDrawer(false));

        const buildColumnRow = (data = null) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'columns-grid';
            wrapper.innerHTML = `
                <input class="form-input" placeholder="Column name" data-field="name" />
                <select class="role-select" data-field="type">
                    <option value="int">int</option>
                    <option value="bigint">bigint</option>
                    <option value="nvarchar" selected>nvarchar</option>
                    <option value="varchar">varchar</option>
                    <option value="char">char</option>
                    <option value="decimal">decimal</option>
                    <option value="numeric">numeric</option>
                    <option value="image">image</option>
                    <option value="bit">bit</option>
                    <option value="datetime">datetime</option>
                    <option value="float">float</option>
                </select>
                <input class="form-input" placeholder="Length" data-field="length" type="number" min="1" />
                <input class="form-input" placeholder="Precision" data-field="precision" type="number" min="1" />
                <input class="form-input" placeholder="Scale" data-field="scale" type="number" min="0" />
                <div style="display:flex; justify-content:center;">
                    <input type="checkbox" data-field="nullable" />
                </div>
                <button class="chip-btn danger-btn" type="button" data-action="remove"><i class="fa-solid fa-trash"></i></button>
            `;
            const typeSelect = wrapper.querySelector('select[data-field=\"type\"]');
            const lengthInput = wrapper.querySelector('input[data-field=\"length\"]');
            const precisionInput = wrapper.querySelector('input[data-field=\"precision\"]');
            const scaleInput = wrapper.querySelector('input[data-field=\"scale\"]');
            const nameInput = wrapper.querySelector('input[data-field=\"name\"]');
            const nullableInput = wrapper.querySelector('input[data-field=\"nullable\"]');
            const removeBtn = wrapper.querySelector('[data-action=\"remove\"]');

            const updateVisibility = () => {
                const type = typeSelect?.value || '';
                const showLength = ['nvarchar', 'varchar', 'char'].includes(type);
                const showPrecision = ['decimal', 'numeric'].includes(type);
                if (lengthInput) lengthInput.style.display = showLength ? 'block' : 'none';
                if (precisionInput) precisionInput.style.display = showPrecision ? 'block' : 'none';
                if (scaleInput) scaleInput.style.display = showPrecision ? 'block' : 'none';
            };
            updateVisibility();
            typeSelect?.addEventListener('change', updateVisibility);

            const toggleDeleted = (shouldDelete) => {
                wrapper.dataset.deleted = shouldDelete ? 'true' : 'false';
                wrapper.classList.toggle('column-deleted', shouldDelete);
                const badge = wrapper.querySelector('.deleted-badge');
                if (shouldDelete && !badge) {
                    const badgeEl = document.createElement('span');
                    badgeEl.className = 'deleted-badge';
                    badgeEl.textContent = 'Marked for deletion';
                    wrapper.appendChild(badgeEl);
                }
                if (!shouldDelete && badge) {
                    badge.remove();
                }
                if (nameInput) nameInput.disabled = shouldDelete;
                if (removeBtn) removeBtn.innerHTML = shouldDelete ? '<i class="fa-solid fa-rotate-left"></i>' : '<i class="fa-solid fa-trash"></i>';
            };

            removeBtn?.addEventListener('click', () => {
                if (wrapper.dataset.existing === 'true') {
                    const isDeleted = wrapper.dataset.deleted === 'true';
                    toggleDeleted(!isDeleted);
                } else {
                    wrapper.remove();
                }
            });
            if (data) {
                if (nameInput) nameInput.value = data.name || '';
                if (typeSelect) typeSelect.value = data.type || 'nvarchar';
                if (lengthInput && data.length) lengthInput.value = data.length;
                if (precisionInput && data.precision) precisionInput.value = data.precision;
                if (scaleInput && data.scale) scaleInput.value = data.scale;
                if (nullableInput) nullableInput.checked = !!data.isNullable;
                if (data.existing) {
                    wrapper.dataset.existing = 'true';
                    wrapper.dataset.originalName = data.originalName || data.name || '';
                    if (typeSelect) typeSelect.disabled = true;
                    toggleDeleted(false);
                    if (lengthInput) lengthInput.disabled = true;
                    if (precisionInput) precisionInput.disabled = true;
                    if (scaleInput) scaleInput.disabled = true;
                }
                updateVisibility();
            }
            return wrapper;
        };

        const resetDrawer = () => {
            if (tableId) tableId.value = '';
            if (tableName) tableName.value = '';
            if (drawerTitle) drawerTitle.textContent = 'Create Application Table';
            if (drawerSubtitle) drawerSubtitle.textContent = 'Define table and columns. DGUID is added automatically.';
            if (saveCreate) saveCreate.textContent = 'Create Table';
            if (columnsList) columnsList.innerHTML = '';
            if (columnsList) columnsList.appendChild(buildColumnRow());
            setStatus('');
        };

        openDrawer?.addEventListener('click', () => {
            resetDrawer();
            showDrawer(true);
        });
        addColumn?.addEventListener('click', () => {
            if (!columnsList) return;
            columnsList.appendChild(buildColumnRow());
        });

        if (columnsList && columnsList.children.length === 0) {
            columnsList.appendChild(buildColumnRow());
        }

        const setStatus = (message, isError = false) => {
            if (!formStatus) return;
            formStatus.textContent = message;
            formStatus.style.color = isError ? '#f59e0b' : '#94a3b8';
        };
        const setPermissionsStatus = (message, isError = false) => {
            if (!permissionsStatus) return;
            permissionsStatus.textContent = message;
            permissionsStatus.style.color = isError ? '#f59e0b' : '#94a3b8';
        };

        saveCreate?.addEventListener('click', async () => {
            if (!canManage) return;
            const nameValue = tableName?.value?.trim() || '';
            if (!nameValue) {
                setStatus('Please enter a table name.', true);
                return;
            }

            const columns = [];
            columnsList?.querySelectorAll('.columns-grid').forEach((row) => {
                const name = row.querySelector('[data-field=\"name\"]')?.value?.trim();
                if (!name) return;
                const type = row.querySelector('[data-field=\"type\"]')?.value;
                const length = row.querySelector('[data-field=\"length\"]')?.value;
                const precision = row.querySelector('[data-field=\"precision\"]')?.value;
                const scale = row.querySelector('[data-field=\"scale\"]')?.value;
                const nullable = row.querySelector('[data-field=\"nullable\"]')?.checked || false;
                const originalName = row.dataset.originalName || null;
                const isExisting = row.dataset.existing === 'true';
                const isDeleted = row.dataset.deleted === 'true';
                columns.push({
                    name,
                    type,
                    length: length ? Number(length) : null,
                    precision: precision ? Number(precision) : null,
                    scale: scale ? Number(scale) : null,
                    isNullable: nullable,
                    originalName,
                    isExisting,
                    isDeleted
                });
            });

            if (columns.length === 0) {
                setStatus('Please add at least one column.', true);
                return;
            }

            const isEdit = !!(tableId?.value);
            setStatus(isEdit ? 'Updating table...' : 'Creating table...');
            saveCreate.disabled = true;
            try {
                const res = await fetch(`/Tools/Applications?handler=${isEdit ? 'Update' : 'Create'}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({ tableId: tableId?.value || null, tableName: nameValue, columns })
                });
                if (res.redirected) {
                    window.location.href = res.url;
                    return;
                }
                const data = await res.json();
                if (!res.ok || !data?.success) {
                    setStatus(data?.message || 'Unable to create table.', true);
                    return;
                }
                setStatus(isEdit ? 'Table updated.' : 'Table created.');
                window.location.reload();
            } catch (err) {
                setStatus('Unable to create table.', true);
            } finally {
                saveCreate.disabled = false;
            }
        });

        document.querySelectorAll('.edit-table').forEach((button) => {
            button.addEventListener('click', () => {
                const id = button.getAttribute('data-table-id');
                const row = button.closest('tr');
                const table = tablesData.find(t => (t.id || '').toString().toLowerCase() === (id || '').toLowerCase());
                const tableColumns = row?.dataset.columns ? JSON.parse(row.dataset.columns) : table?.columns;
                const tableLabel = row?.dataset.tableName || table?.tableName;
                const tableKey = row?.dataset.tableId || table?.id;
                if (!tableKey) return;
                if (tableId) tableId.value = tableKey;
                if (tableName) tableName.value = tableLabel || '';
                if (drawerTitle) drawerTitle.textContent = 'Edit Application Table';
                if (drawerSubtitle) drawerSubtitle.textContent = 'Update table name or add columns. Column type changes are not supported.';
                if (saveCreate) saveCreate.textContent = 'Save Changes';
                if (columnsList) columnsList.innerHTML = '';
                if (Array.isArray(tableColumns)) {
                    tableColumns.forEach(col => {
                        columnsList?.appendChild(buildColumnRow({ ...col, existing: true, originalName: col.name }));
                    });
                }
                showDrawer(true);
            });
        });

        const normalizeAccess = (level) => {
            const value = (level || '').toString().trim().toLowerCase();
            if (value === 'admin') return 'Admin';
            if (value === 'noaccess') return 'NoAccess';
            return 'ViewOnly';
        };

        const defaultAccessByRole = (member) => {
            if (!member || member.locked) return 'Admin';
            return (member.role || '').toLowerCase() === 'admin' ? 'Admin' : 'ViewOnly';
        };

        const readCurrentAccess = (member) => {
            const fromMap = permissionsCurrentByUser.get(member.userId);
            return normalizeAccess(fromMap || member.explicitAccessLevel || member.effectiveAccessLevel);
        };

        const readOriginalAccess = (member) => normalizeAccess(
            permissionsOriginalByUser.get(member.userId) || member.explicitAccessLevel || member.effectiveAccessLevel
        );

        const isPermissionChanged = (member) => {
            if (!member || member.locked) return false;
            return readCurrentAccess(member) !== readOriginalAccess(member);
        };

        const memberMatchesFilter = (member) => {
            const term = (permissionsSearch?.value || '').trim().toLowerCase();
            const filter = (permissionsFilter?.value || 'all').toLowerCase();
            const currentAccess = readCurrentAccess(member).toLowerCase();
            const changed = isPermissionChanged(member);

            if (term) {
                const role = (member.role || '').toLowerCase();
                const source = `${member.displayName || ''} ${member.email || ''} ${role}`.toLowerCase();
                if (!source.includes(term)) return false;
            }

            if (filter === 'changed' && !changed) return false;
            if (filter === 'admin' && currentAccess !== 'admin') return false;
            if (filter === 'viewonly' && currentAccess !== 'viewonly') return false;
            if (filter === 'noaccess' && currentAccess !== 'noaccess') return false;
            return true;
        };

        const renderPermissionRow = (member) => {
            const row = document.createElement('div');
            row.className = 'permission-row';
            if (isPermissionChanged(member)) {
                row.classList.add('changed');
            }

            const identity = document.createElement('div');
            identity.className = 'permission-identity';
            const avatar = document.createElement('div');
            avatar.className = 'permission-avatar';
            const initials = (member.displayName || member.email || 'U')
                .split(/\s+/)
                .filter(Boolean)
                .slice(0, 2)
                .map(part => part[0])
                .join('')
                .toUpperCase() || 'U';
            avatar.textContent = initials;

            const identityText = document.createElement('div');
            const name = document.createElement('div');
            name.className = 'permission-name';
            name.textContent = member.displayName || 'Unknown User';
            const email = document.createElement('div');
            email.className = 'permission-email';
            email.textContent = member.email || '';
            identityText.appendChild(name);
            identityText.appendChild(email);
            identity.appendChild(avatar);
            identity.appendChild(identityText);

            const role = document.createElement('div');
            role.className = 'permission-role';
            role.textContent = member.role || 'Viewer';

            const controlWrap = document.createElement('div');
            controlWrap.className = 'permission-control';
            if (member.locked) {
                const locked = document.createElement('div');
                locked.className = 'permission-lock';
                locked.textContent = 'Owner (locked)';
                controlWrap.appendChild(locked);
            } else {
                const current = readCurrentAccess(member);
                const accessWrap = document.createElement('div');
                accessWrap.className = 'permission-access';
                ['Admin', 'ViewOnly', 'NoAccess'].forEach((level) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = `access-btn ${level.toLowerCase()}${current === level ? ' active' : ''}`;
                    button.textContent = level;
                    button.addEventListener('click', () => {
                        permissionsCurrentByUser.set(member.userId, level);
                        renderPermissionsList();
                        refreshPermissionMetrics();
                        refreshPermissionSaveState();
                    });
                    accessWrap.appendChild(button);
                });
                controlWrap.appendChild(accessWrap);
            }

            const state = document.createElement('div');
            state.className = 'permission-state';
            if (member.locked) {
                state.textContent = 'Inherited: Owner hard override';
            } else {
                const current = readCurrentAccess(member);
                const roleDefault = defaultAccessByRole(member);
                const isDefault = current === roleDefault;
                state.innerHTML = isDefault
                    ? `<span class="default">Default: ${roleDefault}</span>`
                    : `<span class="override">Override: ${current}</span>`;
            }

            row.appendChild(identity);
            row.appendChild(role);
            row.appendChild(controlWrap);
            row.appendChild(state);
            return row;
        };

        const refreshPermissionMetrics = () => {
            let adminCount = 0;
            let viewCount = 0;
            let noAccessCount = 0;
            let changedCount = 0;
            permissionsMembers.forEach((member) => {
                const access = readCurrentAccess(member);
                if (access === 'Admin') adminCount += 1;
                else if (access === 'NoAccess') noAccessCount += 1;
                else viewCount += 1;
                if (isPermissionChanged(member)) changedCount += 1;
            });
            if (metricAdmin) metricAdmin.textContent = `Admin: ${adminCount}`;
            if (metricView) metricView.textContent = `ViewOnly: ${viewCount}`;
            if (metricNoAccess) metricNoAccess.textContent = `NoAccess: ${noAccessCount}`;
            if (metricChanged) metricChanged.textContent = `Changed: ${changedCount}`;
        };

        const refreshPermissionSaveState = () => {
            if (!savePermissions) return;
            const hasEditable = permissionsMembers.some(member => !member.locked);
            const hasChanges = permissionsMembers.some(member => isPermissionChanged(member));
            const canCompleteOnboarding = isPermissionOnboarding && !hasEditable;
            savePermissions.disabled = (!hasEditable || !hasChanges) && !canCompleteOnboarding;
            savePermissions.textContent = canCompleteOnboarding ? 'Complete Setup' : 'Save Permissions';
        };

        const renderPermissionsList = () => {
            if (!permissionsList) return;
            permissionsList.innerHTML = '';
            const visible = permissionsMembers.filter(memberMatchesFilter);
            visible.forEach((member) => permissionsList.appendChild(renderPermissionRow(member)));
            if (permissionsEmpty) {
                const editableCount = permissionsMembers.filter(member => !member.locked).length;
                permissionsEmpty.style.display = editableCount === 0 ? 'flex' : 'none';
            }
        };

        const applyBulkPermission = (level) => {
            permissionsMembers.forEach((member) => {
                if (!member.locked) {
                    permissionsCurrentByUser.set(member.userId, level);
                }
            });
            renderPermissionsList();
            refreshPermissionMetrics();
            refreshPermissionSaveState();
        };

        const applyRoleDefaultPreset = () => {
            permissionsMembers.forEach((member) => {
                if (!member.locked) {
                    permissionsCurrentByUser.set(member.userId, defaultAccessByRole(member));
                }
            });
            renderPermissionsList();
            refreshPermissionMetrics();
            refreshPermissionSaveState();
        };

        const applyAdminRoleOnlyPreset = () => {
            permissionsMembers.forEach((member) => {
                if (!member.locked && (member.role || '').toLowerCase() === 'admin') {
                    permissionsCurrentByUser.set(member.userId, 'Admin');
                }
            });
            renderPermissionsList();
            refreshPermissionMetrics();
            refreshPermissionSaveState();
        };

        const applyViewerRestrictionPreset = () => {
            permissionsMembers.forEach((member) => {
                if (!member.locked && (member.role || '').toLowerCase() === 'viewer') {
                    permissionsCurrentByUser.set(member.userId, 'NoAccess');
                }
            });
            renderPermissionsList();
            refreshPermissionMetrics();
            refreshPermissionSaveState();
        };

        const resetPermissionValuesToRoleDefaults = () => {
            permissionsMembers.forEach((member) => {
                if (!member.locked) {
                    permissionsCurrentByUser.set(member.userId, defaultAccessByRole(member));
                }
            });
            renderPermissionsList();
            refreshPermissionMetrics();
            refreshPermissionSaveState();
        };

        const renderPermissionAudit = () => {
            if (!permissionsAuditList) return;
            permissionsAuditList.innerHTML = '';
            if (!Array.isArray(permissionAuditEntries) || permissionAuditEntries.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'permissions-audit-empty';
                empty.textContent = 'No permission changes logged yet for this table.';
                permissionsAuditList.appendChild(empty);
                return;
            }

            permissionAuditEntries.forEach((entry) => {
                const item = document.createElement('div');
                item.className = 'permissions-audit-item';

                const main = document.createElement('div');
                main.className = 'permissions-audit-main';
                main.innerHTML = `<strong>${entry.subjectDisplayName || 'User'}</strong> · ${entry.previousAccessLevel || 'ViewOnly'} ? ${entry.newAccessLevel || 'ViewOnly'}`;

                const meta = document.createElement('div');
                meta.className = 'permissions-audit-meta';
                const actor = document.createElement('span');
                actor.textContent = `By ${entry.changedByDisplayName || 'System'}`;
                const when = document.createElement('span');
                const timestamp = entry.changedAtUtc ? new Date(entry.changedAtUtc) : null;
                when.textContent = timestamp && !Number.isNaN(timestamp.getTime())
                    ? timestamp.toLocaleString()
                    : 'Just now';
                meta.appendChild(actor);
                meta.appendChild(when);

                item.appendChild(main);
                item.appendChild(meta);
                permissionsAuditList.appendChild(item);
            });
        };

        document.querySelectorAll('.permissions-table').forEach((button) => {
            button.addEventListener('click', async () => {
                const tableId = button.getAttribute('data-table-id');
                const tableName = button.getAttribute('data-table-name') || 'Table';
                if (!tableId) return;
                permissionsTableId = tableId;
                setPermissionsStatus('Loading permissions...');
                if (permissionsTitle) {
                    permissionsTitle.textContent = `Table Permissions · ${tableName}`;
                }
                if (permissionsList) {
                    permissionsList.innerHTML = '';
                }
                if (permissionsSearch) permissionsSearch.value = '';
                if (permissionsFilter) permissionsFilter.value = 'all';
                permissionsMembers = [];
                permissionsOriginalByUser = new Map();
                permissionsCurrentByUser = new Map();
                permissionAuditEntries = [];
                renderPermissionAudit();
                showPermissionsDrawer(true);
                try {
                    const res = await fetch(`/Tools/Applications?handler=Permissions&tableId=${encodeURIComponent(tableId)}`, {
                        method: 'GET',
                        credentials: 'include'
                    });
                    if (res.redirected) {
                        window.location.href = res.url;
                        return;
                    }
                    const data = await res.json();
                    if (!res.ok || !data?.success) {
                        setPermissionsStatus(data?.message || 'Unable to load permissions.', true);
                        return;
                    }
                    permissionsMembers = Array.isArray(data.members) ? data.members : [];
                    permissionAuditEntries = Array.isArray(data.auditEntries) ? data.auditEntries : [];
                    permissionsMembers.forEach((member) => {
                        const value = normalizeAccess(member.explicitAccessLevel || member.effectiveAccessLevel);
                        permissionsOriginalByUser.set(member.userId, value);
                        permissionsCurrentByUser.set(member.userId, value);
                    });
                    renderPermissionsList();
                    renderPermissionAudit();
                    refreshPermissionMetrics();
                    refreshPermissionSaveState();
                    const hasEditable = permissionsMembers.some(member => !member.locked);
                    if (isPermissionOnboarding && !hasEditable) {
                        setPermissionsStatus('No active team members yet. Click Complete Setup to continue.');
                    } else {
                        setPermissionsStatus('');
                    }
                } catch (err) {
                    setPermissionsStatus('Unable to load permissions.', true);
                }
            });
        });

        closePermissionsDrawer?.addEventListener('click', () => showPermissionsDrawer(false));
        permissionsDrawerBackdrop?.addEventListener('click', () => showPermissionsDrawer(false));
        cancelPermissions?.addEventListener('click', () => showPermissionsDrawer(false));
        permissionsSearch?.addEventListener('input', renderPermissionsList);
        permissionsFilter?.addEventListener('change', renderPermissionsList);
        applyRoleDefaults?.addEventListener('click', applyRoleDefaultPreset);
        grantAdminsOnly?.addEventListener('click', applyAdminRoleOnlyPreset);
        restrictViewers?.addEventListener('click', applyViewerRestrictionPreset);
        grantViewOnlyAll?.addEventListener('click', () => applyBulkPermission('ViewOnly'));
        grantAdminAll?.addEventListener('click', () => applyBulkPermission('Admin'));
        lockdownNoAccess?.addEventListener('click', () => applyBulkPermission('NoAccess'));
        resetPermissionDefaults?.addEventListener('click', resetPermissionValuesToRoleDefaults);

        savePermissions?.addEventListener('click', async () => {
            if (!permissionsTableId) return;
            const entries = [];
            const changedEntries = [];
            permissionsMembers.forEach((member) => {
                if (member.locked) return;
                const nextLevel = readCurrentAccess(member);
                entries.push({
                    userId: member.userId,
                    accessLevel: nextLevel
                });
                if (isPermissionChanged(member)) {
                    changedEntries.push({
                        subjectDisplayName: member.displayName || member.email || 'User',
                        previousAccessLevel: readOriginalAccess(member),
                        newAccessLevel: nextLevel
                    });
                }
            });

            savePermissions.disabled = true;
            setPermissionsStatus('Saving permissions...');
            try {
                const res = await fetch('/Tools/Applications?handler=SavePermissions', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({ tableId: permissionsTableId, entries })
                });
                if (res.redirected) {
                    window.location.href = res.url;
                    return;
                }
                const data = await res.json();
                if (!res.ok || !data?.success) {
                    setPermissionsStatus(data?.message || 'Unable to save permissions.', true);
                    return;
                }
                setPermissionsStatus(`Permissions saved successfully${data?.changedCount ? ` (${data.changedCount} changes)` : ''}.`);
                permissionsMembers.forEach((member) => {
                    if (member.locked) return;
                    const current = readCurrentAccess(member);
                    permissionsOriginalByUser.set(member.userId, current);
                });
                if (changedEntries.length > 0) {
                    const actor = currentUserDisplayName || 'Administrator';
                    const nowIso = new Date().toISOString();
                    const newAudit = changedEntries.map(item => ({
                        ...item,
                        changedByDisplayName: actor,
                        changedAtUtc: nowIso
                    }));
                    permissionAuditEntries = [...newAudit, ...permissionAuditEntries].slice(0, 30);
                    renderPermissionAudit();
                }
                renderPermissionsList();
                refreshPermissionMetrics();
                refreshPermissionSaveState();
                if (isPermissionOnboarding) {
                    setPermissionsStatus('Permission setup completed. Redirecting to dashboard...');
                    setTimeout(() => {
                        window.location.href = '/Dashboard/Index';
                    }, 700);
                }
            } catch (err) {
                setPermissionsStatus('Unable to save permissions.', true);
            } finally {
                refreshPermissionSaveState();
            }
        });

        const showConfirm = (show) => {
            if (!confirmModal) return;
            confirmModal.classList.toggle('show', show);
        };

        document.querySelectorAll('.delete-table').forEach((button) => {
            button.addEventListener('click', () => {
                deleteTableId = button.getAttribute('data-table-id');
                showConfirm(true);
            });
        });

        document.querySelectorAll('.sync-table').forEach((button) => {
            button.addEventListener('click', async () => {
                const id = button.getAttribute('data-table-id');
                if (!id) return;
                button.setAttribute('disabled', 'true');
                try {
                    const res = await fetch('/Tools/Applications?handler=SyncColumns', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': csrfToken
                        },
                        body: JSON.stringify({ tableId: id })
                    });
                    if (res.redirected) {
                        window.location.href = res.url;
                        return;
                    }
                    const data = await res.json();
                    if (!res.ok || !data?.success) {
                        setStatus(data?.message || 'Unable to sync columns.', true);
                        return;
                    }
                    window.location.reload();
                } catch (err) {
                    setStatus('Unable to sync columns.', true);
                } finally {
                    button.removeAttribute('disabled');
                }
            });
        });

        const applyFilters = () => {
            const term = (tableSearch?.value || '').trim().toLowerCase();
            const filtered = tableRows.filter((row) => {
                if (!term) return true;
                return (row.dataset.search || '').includes(term);
            });

            const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
            if (currentPage > totalPages) currentPage = totalPages;

            tableRows.forEach(row => row.style.display = 'none');
            const start = (currentPage - 1) * pageSize;
            const pageItems = filtered.slice(start, start + pageSize);
            pageItems.forEach(row => row.style.display = '');

            if (tablePagination) {
                tablePagination.style.display = filtered.length > pageSize ? 'flex' : 'none';
            }
            if (pageInfo) {
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            }
            if (prevPage) prevPage.disabled = currentPage <= 1;
            if (nextPage) nextPage.disabled = currentPage >= totalPages;
        };

        tableSearch?.addEventListener('input', () => {
            currentPage = 1;
            applyFilters();
        });

        prevPage?.addEventListener('click', () => {
            currentPage = Math.max(1, currentPage - 1);
            applyFilters();
        });

        nextPage?.addEventListener('click', () => {
            currentPage += 1;
            applyFilters();
        });

        applyFilters();

        openFirstPermissionSetup?.addEventListener('click', () => {
            const firstButton = document.querySelector('.permissions-table');
            if (firstButton instanceof HTMLElement) {
                firstButton.click();
                return;
            }
            setStatus('Create at least one application table, then save permissions to complete setup.', true);
        });

        if (isPermissionOnboarding) {
            const firstButton = document.querySelector('.permissions-table');
            if (firstButton instanceof HTMLElement) {
                firstButton.click();
            } else {
                setStatus('Starter onboarding: create your first application table, then save permissions.', true);
            }
        }

        syncColumns?.addEventListener('click', async () => {
            const id = tableId?.value;
            if (!id) {
                setStatus('Save the table first to sync columns.', true);
                return;
            }
            syncColumns.disabled = true;
            try {
                const res = await fetch('/Tools/Applications?handler=SyncColumns', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({ tableId: id })
                });
                if (res.redirected) {
                    window.location.href = res.url;
                    return;
                }
                const data = await res.json();
                if (!res.ok || !data?.success) {
                    setStatus(data?.message || 'Unable to sync columns.', true);
                    return;
                }
                if (Array.isArray(data?.columns) && columnsList) {
                    columnsList.innerHTML = '';
                    data.columns.forEach(col => {
                        columnsList.appendChild(buildColumnRow({ ...col, existing: true, originalName: col.name }));
                    });
                    setStatus('Columns synced.');
                } else {
                    window.location.reload();
                }
            } catch (err) {
                setStatus('Unable to sync columns.', true);
            } finally {
                syncColumns.disabled = false;
            }
        });

        cancelDelete?.addEventListener('click', () => showConfirm(false));
        confirmModal?.querySelector('.drawer-backdrop')?.addEventListener('click', () => showConfirm(false));
        confirmDelete?.addEventListener('click', async () => {
            if (!deleteTableId) return;
            confirmDelete.disabled = true;
            try {
                const res = await fetch('/Tools/Applications?handler=Delete', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({ tableId: deleteTableId })
                });
                if (res.redirected) {
                    window.location.href = res.url;
                    return;
                }
                const data = await res.json();
                if (!res.ok || !data?.success) {
                    setStatus(data?.message || 'Unable to delete table.', true);
                    showConfirm(false);
                    return;
                }
                window.location.reload();
            } catch (err) {
                setStatus('Unable to delete table.', true);
                showConfirm(false);
            } finally {
                confirmDelete.disabled = false;
            }
        });
    </script>
}

