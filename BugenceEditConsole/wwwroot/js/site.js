(function(){"use strict";const O="http://www.w3.org/2000/svg",Jt=new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric"});function Zt(t,e,n){const s=(t.length?t:[{dayUtc:new Date().toISOString(),changes:0,uniqueEditors:0}]).map(l=>({date:new Date(l.dayUtc),value:l.changes})),r=Math.max(1,...s.map(l=>l.value)),o=Math.max(e,1),i=s.length>1?o/(s.length-1):0,c=s.map((l,p)=>({x:p*i,y:r===0?0:1-l.value/r,value:l.value,label:Jt.format(l.date)}));return{maxValue:r,points:c.map(l=>({x:l.x,y:l.y,value:l.value,label:l.label}))}}function Xt(t,e){const n=document.createElementNS(O,"svg");return n.setAttribute("viewBox",`0 0 ${t} ${e}`),n.setAttribute("preserveAspectRatio","xMidYMid meet"),n.setAttribute("role","img"),n.classList.add("insights-analytics__svg"),n}function _t(t,e){const n=document.createElementNS(O,"path");return n.setAttribute("d",t),n.setAttribute("class",e),n}function te(t,e,n,a){const s=document.createElementNS(O,"circle");return s.setAttribute("cx",t.toFixed(2)),s.setAttribute("cy",e.toFixed(2)),s.setAttribute("r",n>0?"3.5":"2"),s.setAttribute("data-value",n.toString(10)),s.setAttribute("data-label",a),s.classList.add("insights-analytics__point"),s}function ee(t,e){t.innerHTML="";const n={top:16,right:16,bottom:32,left:40},a=640,s=240,r=a-n.left-n.right,o=s-n.top-n.bottom,{points:i,maxValue:c}=Zt(e,r);if(!e.length||c===0){const L=document.createElement("p");L.className="insights-analytics__empty",L.textContent="No activity matched the current filters.",t.appendChild(L);return}const l=Xt(a,s),p=document.createElementNS(O,"g");p.setAttribute("transform",`translate(${n.left}, ${n.top})`),l.appendChild(p);const h=o,b=i.map(L=>{const _=L.x,x=o*L.y;return{...L,x:_,y:x}}),u=b.map((L,_)=>`${_===0?"M":"L"}${L.x.toFixed(2)} ${L.y.toFixed(2)}`).join(" "),m=[`M${b[0].x.toFixed(2)} ${h.toFixed(2)}`,...b.map(L=>`L${L.x.toFixed(2)} ${L.y.toFixed(2)}`),`L${b[b.length-1].x.toFixed(2)} ${h.toFixed(2)}`,"Z"].join(" ");p.appendChild(_t(m,"insights-analytics__area")),p.appendChild(_t(u,"insights-analytics__line")),b.forEach(L=>{const _=te(L.x,L.y,L.value,L.label);p.appendChild(_)});const d=Math.max(1,Math.round(c/2)),g=document.createElementNS(O,"line");g.setAttribute("x1","0"),g.setAttribute("x2",r.toFixed(2)),g.setAttribute("y1",(o-o*(d/c)).toFixed(2)),g.setAttribute("y2",(o-o*(d/c)).toFixed(2)),g.setAttribute("class","insights-analytics__grid"),p.appendChild(g);const v=document.createElementNS(O,"line");v.setAttribute("x1","0"),v.setAttribute("x2",r.toFixed(2)),v.setAttribute("y1",h.toFixed(2)),v.setAttribute("y2",h.toFixed(2)),v.setAttribute("class","insights-analytics__axis"),p.appendChild(v);const T=document.createElementNS(O,"g");T.setAttribute("class","insights-analytics__labels");const E=new Set;E.add(0),b.length>2&&E.add(Math.floor((b.length-1)/2)),E.add(b.length-1),E.forEach(L=>{const _=b[L],x=document.createElementNS(O,"text");x.textContent=i[L].label,x.setAttribute("x",_.x.toFixed(2)),x.setAttribute("y",(h+20).toFixed(2)),x.setAttribute("text-anchor","middle"),T.appendChild(x)}),p.appendChild(T),t.appendChild(l)}function xt(t,e,n){if(t.innerHTML="",!e.length){const r=document.createElement("p");r.className="insights-analytics__empty",r.textContent=n,t.appendChild(r);return}const a=e.reduce((r,o)=>r+o.changes,0),s=document.createElement("ul");s.className="insights-analytics__list",e.forEach(r=>{const o=document.createElement("li");o.className="insights-analytics__list-item";const i=document.createElement("span");i.className="insights-analytics__list-label",i.textContent=r.label;const c=document.createElement("strong");c.className="insights-analytics__list-value",c.textContent=r.changes.toLocaleString();const l=document.createElement("span");l.className="insights-analytics__list-meter";const p=a>0?Math.round(r.changes/a*100):0;l.style.setProperty("--meter",`${p}`),l.textContent=`${p}%`,o.append(i,c,l),s.appendChild(o)}),t.appendChild(s)}const ne=new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric"});function ae(t){const e=new Date(t);return Number.isNaN(e.getTime())?t:ne.format(e)}function se(t,e){if(t.innerHTML="",!e.length){const a=document.createElement("p");a.className="insights-analytics__empty",a.textContent="No storyline events detected for this range.",t.appendChild(a);return}const n=document.createElement("ul");n.className="insights-storyline__list",e.forEach(a=>{const s=document.createElement("li");s.className="insights-storyline__item";const r=document.createElement("span");r.className=`insights-storyline__icon ${a.icon}`,r.setAttribute("aria-hidden","true");const o=document.createElement("div");o.className="insights-storyline__content";const i=document.createElement("div");i.className="insights-storyline__heading";const c=document.createElement("strong");c.textContent=a.title;const l=document.createElement("span");l.className="insights-storyline__timestamp",l.textContent=ae(a.highlightUtc),i.append(c,l);const p=document.createElement("p");if(p.textContent=a.summary,o.append(i),a.accent){const h=document.createElement("span");h.className="insights-storyline__accent",h.textContent=a.accent,o.append(h)}if(o.append(p),typeof a.changes=="number"&&!Number.isNaN(a.changes)){const h=document.createElement("span");h.className="insights-storyline__badge",h.textContent=`${a.changes.toLocaleString()} change${Math.abs(a.changes)===1?"":"s"}`,o.append(h)}s.append(r,o),n.appendChild(s)}),t.appendChild(n)}const At=new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric"});function re(t){var n;const e=(n=t.textContent)==null?void 0:n.trim();if(!e)return null;try{return JSON.parse(e)}catch(a){return console.warn("[analytics] Failed to parse analytics payload",a),null}}function ie(t,e){const n=new Date(t),a=new Date(e);return Number.isNaN(n.getTime())||Number.isNaN(a.getTime())?"":`${At.format(n)} – ${At.format(a)}`}function oe(t,e){const n=t.querySelector('[data-analytics-chart="trend"]');n&&ee(n,e.trend);const a=t.querySelector('[data-analytics-breakdown="editors"]');a&&xt(a,e.topEditors,"No editor activity in range.");const s=t.querySelector('[data-analytics-breakdown="fields"]');s&&xt(s,e.topFields,"No field changes captured.");const r=t.querySelector("[data-analytics-storyline]");r&&se(r,e.storyline);const o=t.querySelector("[data-analytics-summary]");if(o){const i=ie(e.rangeStartUtc,e.rangeEndUtc);o.textContent=i?`${e.totalChanges.toLocaleString()} changes · ${i}`:`${e.totalChanges.toLocaleString()} changes`}t.dataset.analyticsReady="true"}function ce(t){return t instanceof HTMLElement?[t].filter(e=>e.matches("[data-analytics-root]")):Array.from(t.querySelectorAll("[data-analytics-root]"))}function le(t=document){const e=ce(t);if(!e.length&&t instanceof Document){const n=t.querySelector("[data-analytics-root]");n&&e.push(n)}e.forEach(n=>{const a=n.querySelector("[data-analytics-config]");if(!a)return;const s=re(a);s&&oe(n,s)})}function de(t){const e=new Set,n=typeof t=="function"?t:()=>({...t});let a=n();const s=()=>a,r=c=>{const l=typeof c=="function"?c(a):c;l&&(a=Object.freeze({...a,...l}),e.forEach(p=>p(a)))},o=c=>(e.add(c),()=>{e.delete(c)}),i=()=>{a=Object.freeze({...n()}),e.forEach(c=>c(a))};return a=Object.freeze({...a}),{getState:s,setState:r,subscribe:o,reset:i}}const it=new Map,ue=15e3;async function ot(t,e,n={}){const a=Date.now(),s=n.ttlMs??ue,r=it.get(t);if(!n.revalidate&&r&&a-r.timestamp<=s)return{data:r.data,etag:r.etag,fromCache:!0};const o=new Headers(n.headers??{});r!=null&&r.etag&&o.set("If-None-Match",r.etag);const i=await fetch(e,{...n,headers:o});if(i.status===304&&r)return r.timestamp=a,it.set(t,r),{data:r.data,etag:r.etag,fromCache:!0};if(!i.ok)throw new Error(await me(i));const c=await i.json(),l=i.headers.get("ETag");return it.set(t,{data:c,etag:l,timestamp:a}),{data:c,etag:l??void 0,fromCache:!1}}async function me(t){try{const n=await t.clone().json();if(typeof(n==null?void 0:n.message)=="string")return n.message;if(typeof(n==null?void 0:n.Message)=="string")return n.Message}catch{}const e=await t.text();return e||`Request failed with status ${t.status}`}const J="/api/content";async function pe(t={}){return ot("content:pages",`${J}/pages`,t)}async function fe(t,e={}){const n=new URLSearchParams({pageId:t});return ot(`content:sections:${t}`,`${J}/sections?${n.toString()}`,e)}async function kt(t={},e={}){const n=new URLSearchParams;t.pageId&&n.set("pageId",t.pageId),t.take&&n.set("take",t.take.toString());const a=`content:history:${t.pageId??"all"}${t.take?`:${t.take}`:""}`,s=n.size>0?`${J}/history?${n.toString()}`:`${J}/history`;return ot(a,s,e)}const he={publishing_overview:{id:"publishing_overview",title:"Publishing Overview",description:"Track last publish and outstanding drafts.",metrics:[{id:"draft-count",label:"Draft sections",description:"Blocks updated since last publish.",icon:"fa-solid fa-pen-to-square",compute:"dynamic",valueField:"draftCount",formatter:"number",emphasis:"warning"},{id:"last-published",label:"Last publish",description:"Most recent publish timestamp.",icon:"fa-solid fa-rocket",compute:"dynamic",valueField:"lastPublishedAtUtc",formatter:"datetime"}],actions:[{id:"open-publish-dialog",label:"Publish updates",icon:"fa-solid fa-rocket-launch",intent:"primary",target:"command",command:"canvas.publish"}],footerHint:"Publishing requires review of all draft sections."},quality_checks:{id:"quality_checks",title:"Quality Checks",description:"Automated guardrails before shipping.",metrics:[{id:"accessibility-score",label:"Accessibility score",description:"Automated scan of current page.",icon:"fa-solid fa-universal-access",compute:"dynamic",valueField:"accessibilityScore",formatter:"percentage",emphasis:"default"},{id:"broken-links",label:"Broken links",icon:"fa-solid fa-link-slash",compute:"dynamic",valueField:"brokenLinkCount",formatter:"number",emphasis:"warning"}],actions:[{id:"run-accessibility-scan",label:"Run scan",icon:"fa-solid fa-magnifying-glass-chart",target:"command",command:"canvas.scanAccessibility"}]},quick_actions:{id:"quick_actions",title:"Quick Actions",actions:[{id:"open-history",label:"View history",icon:"fa-solid fa-wave-square",target:"drawer",command:"dashboard.openHistory"},{id:"schedule-reminder",label:"Schedule reminder",icon:"fa-solid fa-clock",target:"modal",command:"dashboard.scheduleReminder"},{id:"request-review",label:"Request review",icon:"fa-solid fa-user-check",target:"command",command:"canvas.requestReview"}],footerHint:"Customize quick actions via admin settings."}},ye={default_content_flow:{id:"default_content_flow",title:"Content Workflow",defaultStepId:"draft",steps:[{id:"draft",label:"Draft",description:"Edit sections and capture notes.",icon:"fa-solid fa-pencil",status:"draft",actions:[{id:"submit-for-review",label:"Submit for review",icon:"fa-solid fa-share",intent:"primary",target:"command",command:"workflow.submitReview"}]},{id:"review",label:"Review",description:"Verify tone, accessibility, and QA checks.",icon:"fa-solid fa-clipboard-check",status:"review",blockers:["missingAccessibilityScan","unresolvedComments"],actions:[{id:"request-changes",label:"Request changes",icon:"fa-solid fa-comment-dots",target:"command",command:"workflow.requestChanges"},{id:"approve",label:"Approve",icon:"fa-solid fa-check",intent:"primary",target:"command",command:"workflow.approve"}]},{id:"publish",label:"Publish",description:"Push live once all checks pass.",icon:"fa-solid fa-rocket",status:"publish",blockers:["draftSectionsExist"],actions:[{id:"publish-now",label:"Publish now",icon:"fa-solid fa-rocket-launch",intent:"primary",target:"command",command:"canvas.publish"},{id:"schedule-publish",label:"Schedule publish",icon:"fa-solid fa-calendar",target:"modal",command:"workflow.schedulePublish"}]}]}};function ge(t,e){return t[e]??null}function be(t,e){return t[e]??null}const Z=new Map;function Se(t){let e=Z.get(t);return e||(e=new Set,Z.set(t,e)),e}function Lt(){const t=globalThis.crypto;return t&&typeof t.randomUUID=="function"?t.randomUUID():`evt_${Math.random().toString(16).slice(2)}${Date.now().toString(16)}`}function ve(){return new Date().toISOString()}function we(){return typeof globalThis.BroadcastChannel=="function"}function ct(){return typeof window<"u"&&typeof window.postMessage=="function"}function Ee(t,e={}){const n=e.busId??Lt(),a=new Set;let s=null,r=null,o=null;const i=(u,m,d)=>{if(e.logger)try{e.logger(u,m,d)}catch{}},c=u=>{a.forEach(m=>{try{m(u)}catch(d){i("error","Event bus listener threw",{error:d,envelope:u})}})},l=u=>{!u||typeof u!="object"||u.source!==n&&c(u)};if(we())s=new BroadcastChannel(t),s.addEventListener("message",u=>{l(u.data)});else if(e.useWindowFallback!==!1&&ct())r=u=>{const m=u.data;!m||typeof m!="object"||m.__bugenceBusName!==t||l(m.envelope)},window.addEventListener("message",r);else{const u=Se(t),m={busId:n,handler:l};u.add(m),o=()=>{u.delete(m),u.size===0&&Z.delete(t)}}return{publish:(u,m)=>{const d={id:Lt(),topic:u,payload:m,timestamp:ve(),source:n};if(c(d),s)try{s.postMessage(d)}catch(g){i("error","Failed to publish via BroadcastChannel",{error:g,envelope:d})}else if(r&&ct())window.postMessage({__bugenceBusName:t,envelope:d},"*");else{const g=Z.get(t);g&&g.forEach(v=>{if(v.busId!==n)try{v.handler(d)}catch(T){i("error","Memory event handler threw",{error:T,envelope:d})}})}return d},subscribe:u=>(a.add(u),()=>{a.delete(u)}),close:()=>{if(a.clear(),s){try{s.close()}catch{}s=null}r&&ct()&&window.removeEventListener("message",r),r=null,o&&(o(),o=null)},getId(){return n}}}const X=new Map;function Ce(t){return t.trim().toLowerCase()}function _e(t){const e=Ce(t);return X.has(e)?X.get(e)===!0:X.has("*")?X.get("*")===!0:!0}const xe=new Map;function Ae(t){return t.trim()}function ke(t){var e;return(e=t.capabilities)!=null&&e.length?t.capabilities.every(n=>_e(n)):!0}function Le(t){if(t.formatted)return t;const e=t.value;return e==null?{...t,formatted:"--"}:typeof e=="number"?{...t,formatted:Number.isFinite(e)?e.toLocaleString():String(e)}:e instanceof Date?{...t,formatted:e.toISOString()}:{...t,formatted:String(e)}}async function Te(t,e){var o,i;const n=xe.get(Ae(t));if(!n||!ke(n.registration))return null;const a=await Promise.resolve(n.registration.resolve(e));if(!a)return null;const s={...a,id:a.id||n.registration.id};return((i=(o=n.registration).format)==null?void 0:i.call(o,s,e))??Le(s)}async function Ne(t,e){return(await Promise.all(t.map(async a=>{const s=await Te(a,e);return[a,s]}))).reduce((a,[s,r])=>(r&&(a[s]=r),a),{})}const Tt=["draftCount","lastPublishedAtUtc","accessibilityScore","brokenLinkCount"],$e=["publishing_overview","quality_checks","quick_actions"];function qe(){const t=document.querySelector("[data-schema-sidebar]");if(!t)return;const e=t.querySelector("[data-schema-cards]")??t,n=t.querySelector("[data-schema-workflow]"),a=De(t);if((async()=>{const s=await Me(t.dataset.pageId,a);$e.forEach(r=>{const o=ge(he,r);if(!o)return;const i=Ue(o,s);e.appendChild(i)})})(),n){const s=be(ye,"default_content_flow");s&&n.appendChild(Ie(s))}}function Ue(t,e){var r,o;const n=document.createElement("article");n.className="tilt on-white dashboard-card animate-fadeUp";const a=document.createElement("div");a.className="dashboard-card__inner space-y-5 p-6";const s=document.createElement("div");if(s.innerHTML=`
    <h3 class="font-display text-xl">${(t==null?void 0:t.title)??""}</h3>
    ${t!=null&&t.description?`<p class="text-sm text-ink/70">${t.description}</p>`:""}
  `,a.appendChild(s),(r=t==null?void 0:t.metrics)!=null&&r.length){const i=document.createElement("div");i.className="dashboard-card__metric-grid",t.metrics.forEach(c=>{const l=c.valueField?e[c.valueField]:void 0,p=l?l.formatted??$t(l.raw,c.formatter):$t(void 0,c.formatter);i.appendChild(Pe(c.label,p,c.description,c.icon,c.emphasis))}),a.appendChild(i)}if((o=t==null?void 0:t.actions)!=null&&o.length){const i=document.createElement("div");i.className="flex flex-wrap gap-3",t.actions.forEach(c=>{const l=document.createElement("button");if(l.type="button",l.className=["inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-semibold transition",c.intent==="primary"?"bg-black text-white hover:-translate-y-px":c.intent==="danger"?"bg-bugence-coral text-white":"border border-black/10 hover:bg-black/5"].join(" "),l.dataset.command=c.command??"",c.icon){const p=document.createElement("span");p.className=`${c.icon}`,l.appendChild(p)}l.appendChild(document.createTextNode(c.label)),i.appendChild(l)}),a.appendChild(i)}if(t!=null&&t.footerHint){const i=document.createElement("p");i.className="text-xs text-ink/50",i.textContent=t.footerHint,a.appendChild(i)}return n.appendChild(a),n}function lt(t,e=0){if(t===void 0)return e;const n=Number(t);return Number.isFinite(n)?n:e}function De(t){return{draftCount:lt(t.dataset.draftCount,0),lastPublishedAtUtc:t.dataset.lastPublished??t.dataset.lastPublishedAtUtc??null,accessibilityScore:lt(t.dataset.accessibilityScore,0),brokenLinkCount:lt(t.dataset.brokenLinkCount,0),lastSyncedAtUtc:t.dataset.lastSyncedAtUtc??null}}async function Me(t,e){try{const n=await Ne(Tt,{pageId:t,source:"dashboard",data:e}),a=Nt(e);return Object.entries(n).forEach(([s,r])=>{r&&(a[s]={raw:r.value??e[s],formatted:r.formatted})}),a}catch(n){return console.error("[schemaSidebar] Failed to resolve metrics",n),Nt(e)}}function Nt(t){return Tt.reduce((e,n)=>(e[n]={raw:t[n]},e),{})}function Pe(t,e,n,a,s="default"){const r=document.createElement("div");if(r.className="dashboard-card__metric",a){const c=document.createElement("span");c.className=`${a} text-accent`,r.appendChild(c)}const o=document.createElement("p");o.className="dashboard-card__metric-label",o.textContent=t,r.appendChild(o);const i=document.createElement("p");if(i.className="dashboard-card__metric-value",s==="warning"&&i.classList.add("text-bugence-coral"),i.textContent=e,r.appendChild(i),n){const c=document.createElement("p");c.className="dashboard-card__metric-desc",c.textContent=n,r.appendChild(c)}return r}function $t(t,e){if(t==null)return"--";if(typeof t=="string"){const n=t.trim();if(!n)return"--";if(!e)return n;t=n}if(e==="percentage"){if(typeof t=="string"&&t.includes("%"))return t;const n=typeof t=="number"?t:Number(t);if(Number.isFinite(n)){const a=Math.min(Math.max(n,0),1);return`${Math.round(a*100)}%`}return String(t)}if(e==="datetime")try{return(t instanceof Date?t:new Date(String(t))).toLocaleString()}catch{return String(t)}if(e==="number"){const n=typeof t=="number"?t:Number(t);if(Number.isFinite(n))return n.toLocaleString()}return String(t)}function Ie(t){const e=document.createElement("article");e.className="tilt on-white dashboard-card animate-fadeUp";const n=document.createElement("div");n.className="dashboard-card__inner space-y-4 p-6";const a=document.createElement("div");a.innerHTML=`
    <h3 class="font-display text-xl">${t.title}</h3>
    <p class="text-sm text-ink/70">Track progress from draft to publish.</p>
  `,n.appendChild(a);const s=document.createElement("ol");return s.className="space-y-3",t.steps.forEach(r=>{var i;const o=document.createElement("li");o.className="flex items-start gap-3",o.innerHTML=`
      <span class="flex h-9 w-9 items-center justify-center rounded-full bg-black/5 text-black">
        <span class="${r.icon??"fa-solid fa-circle-dot"}"></span>
      </span>
      <div class="space-y-1">
        <p class="font-semibold">${r.label}</p>
        ${r.description?`<p class="text-xs text-ink/60">${r.description}</p>`:""}
        ${(i=r.blockers)!=null&&i.length?`<p class="text-xs text-bugence-coral">Blockers: ${r.blockers.join(", ")}</p>`:""}
      </div>
    `,s.appendChild(o)}),n.appendChild(s),e.appendChild(n),e}const Fe="bugence:sync",He=15e3,Re=40,Oe={pages:[],totals:null,pagesEtag:void 0,selectedPageId:void 0,isLoading:!1,error:void 0,lastFetchedAtUtc:void 0,history:{},isHistoryLoading:!1,historyError:void 0,timelineByPage:{}},U=de(()=>({...Oe})),dt=Ee(Fe,{logger:(t,e,n)=>{t==="error"&&console.error("[dashboardSync]",e,n)}});let j=null;dt.subscribe(Ye);function qt(){return{events:[],dirtySections:{},reviewStatuses:{},conflictSectionIds:[],publishSummary:null,lastSyncedAtUtc:void 0,lastSyncTelemetry:void 0,historyIds:[]}}function Ut(t){return t.slice(0,Re)}function I(t,e){U.setState(n=>{const a=n.timelineByPage[t]??qt(),s=e(a);return s===a&&t in n.timelineByPage?n:{...n,timelineByPage:{...n.timelineByPage,[t]:s}}})}function Be(t){return U.getState().timelineByPage[t]??qt()}function B(t,e){I(t,n=>{const a=n.events.filter(s=>s.id!==e.id);return{...n,events:Ut([e,...a])}})}function ut(t,e,n){I(t,a=>{const s={...a.dirtySections};if(!n||!n.dirty){if(!(e in s))return a;delete s[e]}else s[e]=n;return{...a,dirtySections:s}})}function Ke(t,e){I(t,n=>n.conflictSectionIds.includes(e)?n:{...n,conflictSectionIds:[...n.conflictSectionIds,e]})}function je(t,e){I(t,n=>n.conflictSectionIds.includes(e)?{...n,conflictSectionIds:n.conflictSectionIds.filter(a=>a!==e)}:n)}function We(t,e,n){I(t,a=>{const s={...a.reviewStatuses};if(n)s[e]=n;else{if(!(e in s))return a;delete s[e]}return{...a,reviewStatuses:s}})}function Ve(t,e){I(t,n=>({...n,publishSummary:e}))}function mt(t,e,n){I(t,a=>({...a,lastSyncTelemetry:e,lastSyncedAtUtc:e.result==="error"?a.lastSyncedAtUtc:n??new Date().toISOString()}))}function Dt(t,e){e.length&&I(t,n=>{const a=new Set(n.historyIds),s=[];return e.slice().sort((r,o)=>Date.parse(o.performedAtUtc)-Date.parse(r.performedAtUtc)).forEach(r=>{a.has(r.id)||(a.add(r.id),s.push(Ge(r)))}),s.length===0?n:{...n,events:Ut([...s,...n.events]),historyIds:Array.from(a).slice(-200)}})}function Mt(t,e){var n,a;return((n=t==null?void 0:t.after)==null?void 0:n.payload.sectionKey)??((a=t==null?void 0:t.before)==null?void 0:a.payload.sectionKey)??e}function tt(t,e,n){var r;const a=Mt(n,e);if(a&&a!==e)return a;const s=U.getState().timelineByPage[t];if(s){const o=s.dirtySections[e];if(o!=null&&o.sectionKey)return o.sectionKey;const i=(r=s.publishSummary)==null?void 0:r.entries.find(c=>c.sectionId===e);if(i!=null&&i.sectionKey)return i.sectionKey}return`Section ${e.slice(0,8)}`}function pt(t){var o,i,c,l;if(!t)return;const e=t.changeType.charAt(0).toUpperCase()+t.changeType.slice(1),n=((o=t.after)==null?void 0:o.payload.contentType)??((i=t.before)==null?void 0:i.payload.contentType),a=Mt(t,t.sectionId),s=(l=(c=t.annotations)==null?void 0:c[0])==null?void 0:l.message,r=[`${e} · ${a}`];return n&&r.push(n),s&&r.push(s),r.join(" — ")}function ze(t){switch(t){case"approved":return"Review approved";case"rejected":return"Review rejected";default:return"Review requested"}}function Ge(t){var i;const e=t.performedByDisplayName??"System",n=t.pageSectionId?`Section ${t.pageSectionId.slice(0,8)}`:"Page",a=t.diff??null,s=a?` · Δ${a.characterDelta>=0?"+":""}${a.characterDelta}`:"",r=(i=a==null?void 0:a.snippet)==null?void 0:i.trim(),o=r?` · ${r}`:"";return{id:`history:${t.id}`,timestamp:t.performedAtUtc,type:"history",title:t.changeSummary??`Updated ${t.fieldKey}`,description:`${n} · ${e}${s}${o}`,tone:"neutral",source:"history",sectionId:t.pageSectionId??void 0}}function Ye(t){const{topic:e,payload:n,timestamp:a,id:s}=t,r=n.pageId;if(r)switch(e){case"snapshot.applied":{const o=n;I(r,i=>({...i,lastSyncedAtUtc:o.appliedAtUtc})),o.source==="remote"&&B(r,{id:s,timestamp:a,type:"history",title:"Remote snapshot applied",description:"Canvas changes pulled from server.",tone:"info",source:"canvas"});break}case"section.changed":{const o=n,i=o.sectionId,c=o.diff,l=tt(r,i,c),p=!!Be(r).dirtySections[i];o.dirty?(ut(r,i,{sectionId:i,sectionKey:l,dirty:!0,lastChangedAtUtc:a,diff:c}),p||B(r,{id:s,timestamp:a,type:"draft-dirty",title:`Draft updated · ${l}`,description:pt(c),tone:"info",source:"canvas",sectionId:i,sectionKey:l})):(p&&B(r,{id:`${s}:clean`,timestamp:a,type:"draft-synced",title:`Draft aligned · ${l}`,description:"Local changes match baseline.",tone:"positive",source:"canvas",sectionId:i,sectionKey:l}),ut(r,i,null));break}case"section.committed":{const o=n,i=o.sectionId,c=o.diff,l=tt(r,i,c);ut(r,i,null),je(r,i),B(r,{id:s,timestamp:a,type:"draft-committed",title:`Changes committed · ${l}`,description:pt(c),tone:"positive",source:"canvas",sectionId:i,sectionKey:l});break}case"section.conflicted":{const o=n,i=o.sectionId,c=o.diff,l=tt(r,i,c);Ke(r,i),B(r,{id:s,timestamp:a,type:"draft-conflict",title:`Conflict detected · ${l}`,description:pt(c)??"Resolve conflicts to continue.",tone:"warning",source:"canvas",sectionId:i,sectionKey:l});break}case"review.status.updated":{const o=n,i=o.sectionId,c=tt(r,i);We(r,i,o.status),B(r,{id:s,timestamp:a,type:"review-status",title:`${ze(o.status)} · ${c}`,description:o.comment??void 0,tone:o.status==="approved"?"positive":o.status==="rejected"?"warning":"info",source:"workflow",sectionId:i,sectionKey:c,reviewStatus:o.status});break}case"timeline.publish.summary":{const o=n;Ve(r,o.summary),B(r,{id:s,timestamp:a,type:"publish-summary",title:"Publish summary ready",description:`${o.summary.entries.length} section${o.summary.entries.length===1?"":"s"} staged for release.`,tone:"info",source:"workflow"});break}case"sync.telemetry":{const o=n,i=o.result==="error"?void 0:a;mt(r,o,i),o.result==="error"&&B(r,{id:s,timestamp:a,type:"sync-telemetry",title:"Dashboard sync error",description:o.errorMessage??"Sync worker reported an error.",tone:"warning",source:o.source});break}}}function Qe(){return typeof window<"u"}function Je(){return U.getState()}function et(){return U}async function Ze(t={}){const{force:e=!1,ttlMs:n}=t,a=U.getState();if(a.isLoading||!e&&a.pages.length>0)return a.pages;U.setState(s=>({...s,isLoading:!0,error:void 0}));try{const s=await pe({revalidate:e,ttlMs:n}),r=s.data.pages??[],o=s.data.totals??null,i=s.etag??s.data.etag??a.pagesEtag;return U.setState(c=>({...c,pages:r,totals:o,pagesEtag:i??void 0,isLoading:!1,lastFetchedAtUtc:new Date().toISOString(),error:void 0})),r}catch(s){const r=s instanceof Error?s.message:"Unable to load pages.";throw U.setState(o=>({...o,isLoading:!1,error:r})),s}}function Xe(t){U.setState(e=>({...e,selectedPageId:t})),t&&I(t,e=>e)}async function Pt(t={}){const{pageId:e,take:n,force:a=!1,ttlMs:s}=t,r=`${e??"all"}:${n??"default"}`,i=U.getState().history[r];if(!a&&i&&i.items.length>0)return i.items;U.setState(c=>({...c,isHistoryLoading:!0,historyError:void 0}));try{const c=await kt({pageId:e,take:n},{revalidate:a,ttlMs:s}),l=c.data.history??[],p=c.etag??c.data.etag??(i==null?void 0:i.etag);return U.setState(h=>({...h,isHistoryLoading:!1,history:{...h.history,[r]:{items:l,etag:p??void 0,lastFetchedAtUtc:new Date().toISOString()}}})),e&&Dt(e,l),l}catch(c){const l=c instanceof Error?c.message:"Unable to load history.";throw U.setState(p=>({...p,isHistoryLoading:!1,historyError:l})),c}}function It(t,e){var a;const n=`${t??"all"}:${e??"default"}`;return((a=U.getState().history[n])==null?void 0:a.items)??[]}function z(t){const e=t??U.getState().selectedPageId;if(!e)return{events:[],dirtySections:{},reviewStatuses:{},conflictSectionIds:[],publishSummary:null,lastSyncedAtUtc:void 0,lastSyncTelemetry:void 0};const n=U.getState().timelineByPage[e];return n?{events:[...n.events],dirtySections:{...n.dirtySections},reviewStatuses:{...n.reviewStatuses},conflictSectionIds:[...n.conflictSectionIds],publishSummary:n.publishSummary??null,lastSyncedAtUtc:n.lastSyncedAtUtc,lastSyncTelemetry:n.lastSyncTelemetry}:{events:[],dirtySections:{},reviewStatuses:{},conflictSectionIds:[],publishSummary:null,lastSyncedAtUtc:void 0,lastSyncTelemetry:void 0}}async function tn(t){const e=`${t}:default`,a=U.getState().history[e],s=await kt({pageId:t},{revalidate:!0,ttlMs:0}),r=s.data.history??[],o=s.etag??s.data.etag??(a==null?void 0:a.etag);return U.setState(i=>({...i,history:{...i.history,[e]:{items:r,etag:o??void 0,lastFetchedAtUtc:new Date().toISOString()}}})),r}function en(t){if(!Qe())return;const{pageId:e,intervalMs:n}=t,a=Math.max(n??He,5e3);j&&(clearInterval(j),j=null);const s=async()=>{const r=Date.now();try{const o=await tn(e);Dt(e,o);const i=Date.now()-r,c={pageId:e,durationMs:i,result:"success",source:"dashboard"};mt(e,c,new Date().toISOString()),dt.publish("sync.telemetry",c)}catch(o){const i=Date.now()-r,c=o instanceof Error?o.message:String(o),l={pageId:e,durationMs:i,result:"error",source:"dashboard",errorMessage:c};mt(e,l),dt.publish("sync.telemetry",l)}};s(),j=window.setInterval(s,a)}function nn(){j&&(clearInterval(j),j=null)}const an={canvas:"Canvas",dashboard:"Dashboard",history:"History",workflow:"Workflow"},Ft={approved:"Approved",rejected:"Rejected",pending:"Pending review"};function sn(){var b;const t=document.querySelector("[data-dashboard-timeline]");if(!t)return;const e=(b=t.getAttribute("data-page-id"))==null?void 0:b.trim();if(!e)return;const n=t.querySelector("[data-timeline-events]"),a=t.querySelector("[data-timeline-empty]"),s=t.querySelector("[data-timeline-last-sync]"),r=t.querySelector("[data-publish-summary-list]"),o=t.querySelector("[data-publish-summary-empty]"),i=rn(),c=et(),l=()=>{const u=z(e);on(n,a,u),ln(r,o,u),dn(s,u),un(i,u)},p=c.subscribe(l);Xe(e),en({pageId:e}),l();const h=()=>{p(),nn()};window.addEventListener("beforeunload",()=>{h()},{once:!0}),t.addEventListener("dashboard:timeline:dispose",()=>{h()},{once:!0})}function rn(){const t=new Map;return document.querySelectorAll("[data-editor-card]").forEach(e=>{const n=e.getAttribute("data-section-id");n&&t.set(n,{root:e,dirtyBadge:e.querySelector("[data-section-dirty-indicator]")??void 0,conflictBadge:e.querySelector("[data-section-conflict-indicator]")??void 0,reviewBadge:e.querySelector("[data-section-review-indicator]")??void 0,reviewLabel:e.querySelector("[data-section-review-label]")??void 0})}),t}function on(t,e,n){if(!t)return;t.innerHTML="";const a=n.events;if(!a.length){e&&(e.hidden=!1);return}e&&(e.hidden=!0),a.forEach(s=>{t.appendChild(cn(s))})}function cn(t){const e=document.createElement("article");e.className="dashboard-card__event timeline-event",e.dataset.tone=t.tone,t.sectionKey&&(e.dataset.sectionKey=t.sectionKey);const n=document.createElement("h3");n.className="dashboard-card__event-title",n.textContent=t.title,e.appendChild(n);const a=document.createElement("div");a.className="dashboard-card__event-meta",a.textContent=an[t.source]??"Timeline",e.appendChild(a);const s=document.createElement("time");if(s.className="dashboard-card__event-timestamp",s.dateTime=t.timestamp,s.textContent=Ht(t.timestamp),e.appendChild(s),t.description){const r=document.createElement("p");r.textContent=t.description,e.appendChild(r)}return e}function ln(t,e,n){if(!t)return;t.innerHTML="";const a=n.publishSummary;if(!a||a.entries.length===0){e&&(e.hidden=!1);return}e&&(e.hidden=!0),a.entries.forEach(s=>{const r=document.createElement("li");r.className="dashboard-card__event timeline-event",r.dataset.tone=s.changeType==="removed"?"warning":"info";const o=document.createElement("h3");o.className="dashboard-card__event-title",o.textContent=`${s.sectionKey} · ${pn(s.changeType)}`,r.appendChild(o);const i=document.createElement("div");if(i.className="dashboard-card__event-meta",i.textContent=s.contentType??"Content",s.reviewerStatus){const c=document.createElement("span");c.className="timeline-summary__status",c.textContent=Ft[s.reviewerStatus]??s.reviewerStatus,i.appendChild(document.createTextNode(" · ")),i.appendChild(c)}r.appendChild(i),t.appendChild(r)})}function dn(t,e){if(!t)return;const n=e.lastSyncTelemetry;if((n==null?void 0:n.result)==="error"){t.dataset.state="error",t.textContent=`Sync error · ${n.errorMessage??"Check logs"}`;return}if(t.removeAttribute("data-state"),!e.lastSyncedAtUtc){t.textContent="Awaiting first sync…";return}t.textContent=`Last sync ${Ht(e.lastSyncedAtUtc)}`}function un(t,e){t.forEach((n,a)=>{const s=e.dirtySections[a];if(n.dirtyBadge){const r=n.dirtyBadge;s?(r.hidden=!1,r.title=mn(s.diff)):(r.hidden=!0,r.removeAttribute("title"))}if(n.conflictBadge&&(n.conflictBadge.hidden=!e.conflictSectionIds.includes(a)),n.reviewBadge&&n.reviewLabel){const r=e.reviewStatuses[a];r?(n.reviewBadge.hidden=!1,n.reviewBadge.dataset.status=r,n.reviewLabel.textContent=Ft[r]??r):(n.reviewBadge.hidden=!0,n.reviewBadge.removeAttribute("data-status"))}})}function Ht(t){const e=new Date(t);return Number.isNaN(e.getTime())?t:e.toLocaleString(void 0,{hour:"2-digit",minute:"2-digit",second:"2-digit"})}function mn(t){var a,s;if(!t)return"Draft updated";const e=t.changeType.charAt(0).toUpperCase()+t.changeType.slice(1),n=((a=t.after)==null?void 0:a.payload.sectionKey)??((s=t.before)==null?void 0:s.payload.sectionKey)??t.sectionId;return`${e} · ${n}`}function pn(t){return t.charAt(0).toUpperCase()+t.slice(1)}const Rt=48,fn=14,hn=new Intl.DateTimeFormat(void 0,{month:"short",day:"2-digit",year:"numeric"}),yn=new Intl.DateTimeFormat(void 0,{month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"}),gn=new Intl.DateTimeFormat(void 0,{hour:"2-digit",minute:"2-digit"});function bn(){const t=document.querySelector("[data-library-console]");if(!t)return;const e={totalPages:t.querySelector('[data-library-metric="totalPages"]'),totalSections:t.querySelector('[data-library-metric="totalSections"]'),activePastWeek:t.querySelector('[data-library-metric="activePastWeek"]'),latestUpdate:t.querySelector('[data-library-metric="latestUpdate"]')},n=t.querySelector("[data-library-count]"),a=t.querySelector("[data-library-page-list]"),s=t.querySelector("[data-library-empty]"),r=t.querySelector("[data-library-trending] .library-console__chip-stack"),o=t.querySelector("[data-library-controls]"),i=t.querySelector("#term")??document.getElementById("term"),c=Array.from(t.querySelectorAll("[data-library-status]")).map(u=>({root:u,kind:(u.dataset.statusKind??"").trim(),value:u.querySelector("strong"),meter:u.querySelector(".library-console__status-meter span")})),l=document.querySelector("[data-library-inspector]"),p=l?Mn(l,{loadSections:qn(),loadActivity:Un()}):null,h={pages:a?Tn(a):[],sort:"recent",filter:"all",search:((i==null?void 0:i.value)??"").trim()};if(h.pages=h.pages.map(u=>at(u)),!a){console.warn("[libraryConsole] Page grid container not found, skipping enhancements.");return}const b=()=>Sn({state:h,pageGrid:a,emptyState:s,badgeCount:n,metricsRefs:e,statusRefs:c,trendingHost:r});b(),Ze({force:!0,ttlMs:6e4}).then(()=>{const u=Je();h.pages=u.pages.map(m=>at(m)),b()}).catch(u=>{console.warn("[libraryConsole] Unable to refresh pages",u)}),i&&i.addEventListener("input",()=>{h.search=i.value.trim(),b()}),t.addEventListener("click",u=>{var v;const m=u.target;if(!m)return;const d=m.closest("[data-library-chip]");if(d&&i){u.preventDefault();const T=d.dataset.libraryTerm??((v=d.textContent)==null?void 0:v.trim())??"";i.value=T,h.search=T,b();return}const g=m.closest("[data-library-inspect]");if(g&&p){u.preventDefault();const T=g.getAttribute("data-library-inspect");if(!T)return;const E=h.pages.find(L=>L.id===T);if(!E)return;p.open(E,g)}}),o&&(nt(o,"[data-library-sort]",h.sort),nt(o,"[data-library-filter]",h.filter),o.addEventListener("click",u=>{const m=u.target;if(!m)return;const d=m.closest("[data-library-sort]");if(d){const v=d.getAttribute("data-library-sort");v&&h.sort!==v&&(h.sort=v,nt(o,"[data-library-sort]",v),b());return}const g=m.closest("[data-library-filter]");if(g){const v=g.getAttribute("data-library-filter");v&&h.filter!==v&&(h.filter=v,nt(o,"[data-library-filter]",v),b())}}))}function Sn(t){const{state:e,pageGrid:n,emptyState:a,badgeCount:s,metricsRefs:r,statusRefs:o,trendingHost:i}=t,c=e.pages.map(h=>at(h)),l=c.length,p=c.filter(h=>vn(h,e.filter)).filter(h=>wn(h,e.search));En(p,e.sort),Cn(n,p),a&&(a.hidden=p.length>0),n.hidden=p.length===0,s&&(s.textContent=p.length===l?l.toString():`${p.length} / ${l}`),An(r,c),kn(o,c),Ln(i,c)}function vn(t,e){if(e==="all")return!0;const n=new Date(t.updatedAtUtc),a=!Number.isNaN(n.getTime()),s=t.lastPublishedAtUtc?new Date(t.lastPublishedAtUtc):null,r=s?!Number.isNaN(s.getTime()):!1;switch(e){case"fresh":return a&&rt(n)<=Rt;case"stale":return a&&rt(n)>=fn*24;case"unpublished":return!r;default:return!0}}function wn(t,e){return e?`${t.name??""} ${t.slug??""} ${t.description??""}`.toLowerCase().includes(e.toLowerCase()):!0}function En(t,e){switch(e){case"sections":t.sort((n,a)=>a.sectionCount-n.sectionCount||n.name.localeCompare(a.name));break;case"alphabetical":t.sort((n,a)=>n.name.localeCompare(a.name));break;case"recent":default:t.sort((n,a)=>new Date(a.updatedAtUtc).getTime()-new Date(n.updatedAtUtc).getTime());break}}function Cn(t,e){if(t.innerHTML="",!e.length)return;const n=document.createDocumentFragment();e.forEach(a=>{n.appendChild(_n(a))}),t.appendChild(n)}function _n(t){const e=document.createElement("article");e.className="library-console__page-card",e.dataset.pageId=t.id,e.dataset.pageName=t.name,e.dataset.pageSlug=t.slug,t.description&&(e.dataset.pageDescription=t.description),e.dataset.pageUpdated=t.updatedAtUtc,t.lastPublishedAtUtc&&(e.dataset.pagePublished=t.lastPublishedAtUtc),e.dataset.pageSections=String(t.sectionCount),e.dataset.pageText=String(t.textSections),e.dataset.pageImages=String(t.imageSections);const n=document.createElement("header");n.className="library-console__page-header";const a=document.createElement("span");a.className="library-console__page-slug",a.textContent=t.slug;const s=document.createElement("h3");s.textContent=t.name;const r=document.createElement("p");r.textContent=t.description??"No description yet.",n.append(a,s,r);const o=document.createElement("dl");o.className="library-console__page-metrics",o.append(ft("Sections",t.sectionCount),ft("Text frames",t.textSections),ft("Imagery slots",t.imageSections));const i=document.createElement("footer");i.className="library-console__page-footer";const c=document.createElement("div"),l=document.createElement("span");l.className="library-console__timestamp-label",l.textContent="Updated";const p=document.createElement("time");p.className="library-console__timestamp",p.dateTime=t.updatedAtUtc,p.textContent=yt(t.updatedAtUtc);const h=document.createElement("span");h.className="library-console__timestamp-secondary",h.textContent=`${Kt(t.updatedAtUtc)} local`;const b=document.createElement("span");b.className="library-console__timestamp-secondary library-console__timestamp-secondary--published",b.textContent=`Last publish: ${t.lastPublishedAtUtc?yt(t.lastPublishedAtUtc):"Draft only"}`,c.append(l,p,h,b);const u=document.createElement("div");return u.className="library-console__page-actions",u.append(Ot(`/content/canvas/${t.id}`,"library-console__action","fa-solid fa-pen-to-square","Edit",!0),Ot(`/Content/LivePreview?pageId=${encodeURIComponent(t.id)}`,"library-console__action library-console__action--ghost","fa-solid fa-eye","Preview"),xn(t.id)),i.append(c,u),e.append(n,o,i),e}function ft(t,e){const n=document.createElement("div"),a=document.createElement("dt");a.textContent=t;const s=document.createElement("dd");return s.textContent=e.toString(),n.append(a,s),n}function Ot(t,e,n,a,s=!1){const r=document.createElement("a");r.href=t,r.className=e,s&&(r.target="_blank",r.rel="noopener");const o=document.createElement("span");return o.className=n,r.append(o,document.createTextNode(a)),r}function xn(t){const e=document.createElement("button");e.type="button",e.className="library-console__action library-console__action--detail",e.setAttribute("data-library-inspect",t);const n=document.createElement("span");n.className="fa-solid fa-circle-info";const a=document.createTextNode("Details");return e.append(n,a),e}function An(t,e){const n=e.reduce((a,s)=>(a.sectionCount+=s.sectionCount,a.textSections+=s.textSections,a.imageSections+=s.imageSections,s.updatedAtUtc>a.latestUpdateUtc&&(a.latestUpdateUtc=s.updatedAtUtc),rt(new Date(s.updatedAtUtc))<=168&&(a.activePastWeek+=1),a),{pageCount:e.length,sectionCount:0,textSections:0,imageSections:0,activePastWeek:0,latestUpdateUtc:""});t.totalPages&&(t.totalPages.textContent=n.pageCount.toString()),t.totalSections&&(t.totalSections.textContent=n.sectionCount.toString()),t.activePastWeek&&(t.activePastWeek.textContent=n.activePastWeek.toString()),t.latestUpdate&&(n.latestUpdateUtc?(t.latestUpdate.dataset.libraryLatest=n.latestUpdateUtc,t.latestUpdate.textContent=`${yt(n.latestUpdateUtc)} · ${Kt(n.latestUpdateUtc)}`):(t.latestUpdate.dataset.libraryLatest="",t.latestUpdate.textContent="Awaiting first publish"))}function kn(t,e){const n=e.reduce((a,s)=>(s.sectionCount>0&&(a["Launch ready"]=(a["Launch ready"]??0)+1),rt(new Date(s.updatedAtUtc))<=Rt&&(a["In review"]=(a["In review"]??0)+1),(s.description??"").toLowerCase().includes("test")&&(a.Experimenting=(a.Experimenting??0)+1),a),{});t.forEach(({root:a,value:s,meter:r,kind:o})=>{const i=e.length||1,c=n[o]??0;if(s&&(s.textContent=c.toString()),r){const l=Math.max(0,Math.min(1,c/i));r.style.width=`${Math.round(l*100)}%`}a.dataset.state=c>0?"active":"idle"})}function Ln(t,e){if(!t)return;const n=[...e].sort((a,s)=>new Date(s.updatedAtUtc).getTime()-new Date(a.updatedAtUtc).getTime()).slice(0,3);t.innerHTML="",n.length&&n.forEach(a=>{const s=document.createElement("a");s.href=`/Content/Library?term=${encodeURIComponent(a.name)}`,s.className="library-console__chip",s.dataset.libraryChip="",s.dataset.libraryTerm=a.name,s.dataset.pageId=a.id,s.dataset.pageUpdated=a.updatedAtUtc;const r=document.createElement("span");r.className="fa-solid fa-sparkles",r.setAttribute("aria-hidden","true");const o=document.createTextNode(a.name),i=document.createElement("span");i.className="library-console__chip-meta",i.textContent=`${W(a.updatedAtUtc)}`,s.append(r,o,i),t.appendChild(s)})}function nt(t,e,n){t.querySelectorAll(e).forEach(a=>{(a.getAttribute(e.replace(/[\[\]]/g,"").split("=")[0])??"")===n?a.dataset.state="active":a.dataset.state="idle"})}function Tn(t){const e=[];return t.querySelectorAll("[data-page-id]").forEach(n=>{var s,r,o;const a={id:n.dataset.pageId??"",name:n.dataset.pageName??((s=n.querySelector("h3"))==null?void 0:s.textContent)??"",slug:n.dataset.pageSlug??((r=n.querySelector("[data-page-slug], .library-console__page-slug"))==null?void 0:r.textContent)??"",description:n.dataset.pageDescription??((o=n.querySelector("[data-page-description], p"))==null?void 0:o.textContent)??"",updatedAtUtc:n.dataset.pageUpdated??"",lastPublishedAtUtc:n.dataset.pagePublished&&n.dataset.pagePublished.trim().length>0?n.dataset.pagePublished:null,sectionCount:n.dataset.pageSections,textSections:n.dataset.pageText,imageSections:n.dataset.pageImages};e.push(at(a))}),e}function at(t){const e=t,n=st(H(e,"name","Name"),"Untitled page"),a=Nn(H(e,"slug","Slug"),n),s=H(e,"updatedAtUtc","UpdatedAtUtc","updatedAt","UpdatedAt"),r=H(e,"lastPublishedAtUtc","LastPublishedAtUtc","publishedAtUtc","PublishedAtUtc"),o=Bt(s,new Date().toISOString()),i=r==null||typeof r=="string"&&r.trim().length===0?null:Bt(r,o);return{id:$n(H(e,"id","Id"),a,n),name:n,slug:a,description:st(H(e,"description","Description"),""),updatedAtUtc:o,lastPublishedAtUtc:i,sectionCount:ht(H(e,"sectionCount","SectionCount")),textSections:ht(H(e,"textSections","TextSections")),imageSections:ht(H(e,"imageSections","ImageSections"))}}function st(t,e=""){if(typeof t=="string"){const n=t.trim();if(n.length>0)return n}return e}function Bt(t,e){if(t instanceof Date)return t.toISOString();if(typeof t=="number"&&Number.isFinite(t))return new Date(t).toISOString();if(typeof t=="string"){const a=t.trim();if(a.length>0){const s=new Date(a);if(!Number.isNaN(s.getTime()))return a}}const n=new Date(e);return(Number.isNaN(n.getTime())?new Date:n).toISOString()}function ht(t,e=0){if(typeof t=="number"&&Number.isFinite(t))return t;if(typeof t=="string"){const n=t.trim();if(n.length>0){const a=Number.parseInt(n,10);if(Number.isFinite(a))return a}}return e}function H(t,...e){for(const n of e){const a=t[n];if(a!=null)return a}}function Nn(t,e){const n=st(t??"","");return n||e.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").slice(0,60)||`page-${Math.random().toString(36).slice(2,10)}`}function $n(t,e,n){const a=st(t??"","");return a||e||n.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")||`page-${Date.now().toString(36)}${Math.random().toString(36).slice(2,6)}`}function rt(t){return(Date.now()-t.getTime())/36e5}function yt(t){const e=new Date(t);return Number.isNaN(e.getTime())?t:hn.format(e)}function W(t){const e=new Date(t);return Number.isNaN(e.getTime())?t:yn.format(e)}function Kt(t){const e=new Date(t);return Number.isNaN(e.getTime())?t:gn.format(e)}function qn(){const t=new Map;return async e=>{if(t.has(e))return t.get(e)??[];try{const a=((await fe(e,{revalidate:!0,ttlMs:0})).data.sections??[]).map(Dn);return t.set(e,a),a}catch(n){return console.warn("[libraryConsole] Unable to load sections for inspector",n),t.set(e,[]),[]}}}function Un(){const t=new Map;return async e=>{if(t.has(e))return t.get(e)??[];try{await Pt({pageId:e,take:8,force:!0,ttlMs:0});const n=It(e,8);return t.set(e,n),n}catch(n){return console.warn("[libraryConsole] Unable to load history for inspector",n),t.set(e,[]),[]}}}function Dn(t){return{id:t.id,sectionKey:t.sectionKey,title:t.title,contentType:t.contentType,updatedAtUtc:t.updatedAtUtc,lastPublishedAtUtc:t.lastPublishedAtUtc??null}}function Mn(t,e){const n=t.querySelector("[data-library-inspector-slug]"),a=t.querySelector("[data-library-inspector-title]"),s=t.querySelector("[data-library-inspector-description]"),r=t.querySelector("[data-library-inspector-sections]"),o=t.querySelector("[data-library-inspector-text]"),i=t.querySelector("[data-library-inspector-images]"),c=t.querySelector("[data-library-inspector-signals]"),l=t.querySelector("[data-library-inspector-section-list]"),p=t.querySelector("[data-library-inspector-activity]"),h=Array.from(t.querySelectorAll("[data-library-inspector-tabs] [data-tab]")),b=Array.from(t.querySelectorAll("[data-library-inspector-panels] [data-panel]")),u=t.querySelectorAll("[data-library-close]");let m=null,d="summary";h.forEach(_=>{_.addEventListener("click",()=>{const x=_.getAttribute("data-tab");!x||x===d||(d=x,jt(h,b,d))})}),u.forEach(_=>{_.addEventListener("click",()=>v())}),t.addEventListener("keydown",_=>{_.key==="Escape"&&v()});function g(_,x){m=x,d="summary",jt(h,b,d),T(_),E(_.id),L(_.id),t.hidden=!1,requestAnimationFrame(()=>{t.dataset.state="open";const A=t.querySelector(".library-inspector__close");A==null||A.focus({preventScroll:!0}),document.body.style.setProperty("overflow","hidden")})}function v(){t.dataset.state="idle",document.body.style.removeProperty("overflow"),setTimeout(()=>{t.hidden=!0,m&&m.focus({preventScroll:!0})},180)}function T(_){n&&(n.textContent=_.slug??""),a&&(a.textContent=_.name??""),s&&(s.textContent=_.description??"No description captured yet."),r&&(r.textContent=_.sectionCount.toString()),o&&(o.textContent=_.textSections.toString()),i&&(i.textContent=_.imageSections.toString()),c&&(c.innerHTML="",Pn(_).forEach(A=>{const w=document.createElement("li");w.textContent=A,c.appendChild(w)}))}async function E(_){if(!l)return;l.innerHTML="";const x=document.createElement("li");x.className="library-inspector__loading",x.textContent="Loading sectionsâ€¦",l.appendChild(x);const A=await e.loadSections(_);if(l.innerHTML="",!A.length){const w=document.createElement("li");w.className="library-inspector__empty",w.textContent="No sections available yet.",l.appendChild(w);return}A.forEach(w=>{const N=document.createElement("li");N.className="library-inspector__list-item";const q=document.createElement("div");q.className="library-inspector__list-head";const $=document.createElement("strong");$.textContent=w.title??w.sectionKey??"Untitled section";const D=document.createElement("span");D.textContent=`${w.contentType} · Updated ${W(w.updatedAtUtc)}`,q.append($,D);const M=document.createElement("div");M.className="library-inspector__list-meta",M.textContent=w.lastPublishedAtUtc?`Last publish ${W(w.lastPublishedAtUtc)}`:"Draft not yet published",N.append(q,M),l.appendChild(N)})}async function L(_){if(!p)return;p.innerHTML="";const x=document.createElement("li");x.className="library-inspector__loading",x.textContent="Loading activityâ€¦",p.appendChild(x);const A=await e.loadActivity(_);if(p.innerHTML="",!A.length){const w=document.createElement("li");w.className="library-inspector__empty",w.textContent="No recent edits recorded.",p.appendChild(w);return}A.forEach(w=>{const N=document.createElement("li");N.className="library-inspector__list-item";const q=document.createElement("div");q.className="library-inspector__list-head";const $=document.createElement("strong");$.textContent=w.changeSummary??w.fieldKey??"Content update";const D=document.createElement("span");D.textContent=`${w.performedByDisplayName??"Unknown"} · ${W(w.performedAtUtc)}`,q.append($,D);const M=document.createElement("div");M.className="library-inspector__list-meta",M.textContent=In(w),N.append(q,M),p.appendChild(N)})}return{open:g,hide:v}}function jt(t,e,n){t.forEach(a=>{const s=a.getAttribute("data-tab")===n;a.dataset.state=s?"active":"idle"}),e.forEach(a=>{a.dataset.state=a.getAttribute("data-panel")===n?"active":"idle"})}function Pn(t){const e=[],n=W(t.updatedAtUtc);e.push(`Updated ${n}`),t.lastPublishedAtUtc?(e.push(`Last publish ${W(t.lastPublishedAtUtc)}`),new Date(t.updatedAtUtc).getTime()>new Date(t.lastPublishedAtUtc).getTime()&&e.push("Draft changes pending publish")):e.push("Draft has not been published yet");const a=t.sectionCount>0?Math.round(t.textSections/t.sectionCount*100):0;return e.push(`Copy density ${a}% text · ${t.imageSections} imagery slots`),e}function In(t){if(t.changeSummary)return t.changeSummary;const e=t.previousValue??"",n=t.newValue??"";return e&&n&&e!==n?`Updated ${gt(n)}`:!e&&n?`Added ${gt(n)}`:e&&!n?`Removed ${gt(e)}`:"No change captured."}function gt(t,e=60){const n=t.replace(/\s+/g," ").trim();return n.length>e?`${n.slice(0,e)}…`:n}const Fn=new Intl.DateTimeFormat(void 0,{month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});function Hn(){const t=document.querySelector("[data-dashboard-page]");if(!t)return;const e=t.getAttribute("data-dashboard-page");if(!e)return;const n=Array.from(document.querySelectorAll("[data-editor-card]"));if(!n.length)return;const a=n.map(i=>Rn(i,e)).filter(i=>i!==null);if(!a.length)return;const s=et(),r=()=>{const i=z(e);a.forEach(c=>On(c,i))};r();const o=s.subscribe(r);window.addEventListener("beforeunload",()=>{o()},{once:!0})}function Rn(t,e){const n=t.getAttribute("data-section-id");if(!n)return null;const a=Array.from(t.querySelectorAll("[data-section-tabs] [data-section-tab]")),s=Array.from(t.querySelectorAll("[data-section-panel]")),r={card:t,pageId:e,sectionId:n,tabs:a,panels:s,metaHost:t.querySelector("[data-section-meta]"),flagsHost:t.querySelector("[data-section-flags]"),actionsHost:t.querySelector("[data-section-actions]"),historyList:t.querySelector("[data-section-history-list]"),historyEmpty:t.querySelector("[data-section-history-empty]"),activeTab:"editor",detailsPopulated:!1,historyLoaded:!1};return a.forEach(o=>{o.addEventListener("click",()=>{const i=o.getAttribute("data-section-tab");!i||r.activeTab===i||(r.activeTab=i,Bn(r),i==="details"&&!r.detailsPopulated&&Wt(r),i==="history"&&!r.historyLoaded&&Vt(r))})}),r}function On(t,e){t.activeTab==="details"?Wt(t,e):t.detailsPopulated=!1,t.activeTab==="history"&&t.historyLoaded&&Vt(t)}function Bn(t){t.tabs.forEach(e=>{const n=e.getAttribute("data-section-tab");e.dataset.state=n===t.activeTab?"active":"idle"}),t.panels.forEach(e=>{const n=e.getAttribute("data-section-panel");e.dataset.state=n===t.activeTab?"active":"idle"})}function Wt(t,e=z(t.pageId)){const{metaHost:n,flagsHost:a,actionsHost:s,card:r,sectionId:o}=t;if(!n||!a||!s)return;const i=r.dataset,c=e.dirtySections[o],l=e.reviewStatuses[o],p=e.conflictSectionIds.includes(o),h=[["Key",i.sectionKey??""],["Selector",i.sectionSelector??"No selector"],["Content type",i.sectionType??"Unknown"],["Display order",i.sectionOrder??"—"]];i.sectionUpdated&&h.push(["Last updated",bt(i.sectionUpdated)]),i.sectionPublished?h.push(["Last published",bt(i.sectionPublished)]):h.push(["Last published","Not yet published"]),n.innerHTML="",h.forEach(([u,m])=>{const d=document.createElement("dt");d.textContent=u;const g=document.createElement("dd");g.textContent=m,n.append(d,g)}),a.innerHTML="";const b=[];if(i.sectionLocked==="true"?b.push("Locked by concierge"):b.push("Editable"),i.sectionHasDraft==="true"&&b.push("Draft ahead of publish"),c!=null&&c.dirty&&b.push("Unsaved diff detected"),p&&b.push("Conflict with remote baseline"),l&&b.push(`Review status: ${Wn(l)}`),b.forEach(u=>{const m=document.createElement("span");m.className="section-card__flag",m.textContent=u,a.appendChild(m)}),s.innerHTML="",c!=null&&c.diff){const u=c.diff,m=document.createElement("article");m.className="section-card__diff";const d=document.createElement("h4");d.textContent=`Diff · ${zt(u.changeType)}`;const g=document.createElement("p");g.textContent=Kn(u),m.append(d,g),s.appendChild(m)}else{const u=document.createElement("p");u.className="section-card__diff-empty",u.textContent="No active diff recorded for this section.",s.appendChild(u)}t.detailsPopulated=!0}async function Vt(t){const{pageId:e,sectionId:n,historyList:a,historyEmpty:s}=t;if(!a)return;s&&(s.hidden=!0),a.innerHTML="";try{await Pt({pageId:e,take:60,force:!t.historyLoaded,ttlMs:0})}catch{}const r=It(e,60).filter(i=>i.pageSectionId===n);if(!r.length){s&&(s.hidden=!1),t.historyLoaded=!0;return}const o=document.createDocumentFragment();r.slice(0,6).forEach(i=>{const c=document.createElement("li");c.className="section-card__history-item";const l=document.createElement("div");l.className="section-card__history-head";const p=document.createElement("strong");p.textContent=i.changeSummary??i.fieldKey??"Content update";const h=document.createElement("span");h.textContent=`${i.performedByDisplayName??"Unknown"} · ${bt(i.performedAtUtc)}`,l.append(p,h);const b=document.createElement("div");b.className="section-card__history-body",b.textContent=jn(i),c.append(l,b),o.appendChild(c)}),a.appendChild(o),t.historyLoaded=!0}function Kn(t){var a,s,r;const e=((a=t.after)==null?void 0:a.payload.sectionKey)??((s=t.before)==null?void 0:s.payload.sectionKey)??t.sectionId,n=[`${zt(t.changeType)} · ${e}`];return(r=t.annotations)!=null&&r.length&&n.push(t.annotations.join("; ")),n.join(" — ")}function jn(t){if(t.changeSummary)return t.changeSummary;const e=t.previousValue??"",n=t.newValue??"";return e&&n&&e!==n?`Modified content to "${St(n)}"`:!e&&n?`Added "${St(n)}"`:e&&!n?`Removed "${St(e)}"`:"No content changes recorded."}function bt(t){const e=new Date(t);return Number.isNaN(e.getTime())?t:Fn.format(e)}function Wn(t){switch(t){case"approved":return"Approved";case"rejected":return"Needs revision";case"pending":default:return"Pending review"}}function zt(t){return t.charAt(0).toUpperCase()+t.slice(1)}function St(t,e=60){const n=t.replace(/\s+/g," ").trim();return n.length>e?`${n.slice(0,e)}…`:n}const Vn=[{id:"copy-review",label:"Confirm copy review completed",completed:!1,origin:"default"},{id:"accessibility-audit",label:"Run accessibility spot-check",completed:!1,origin:"default"}];function zn(){var A;const t=document.querySelector("[data-publish-summary-panel]"),e=document.querySelector("[data-publish-console]"),n=document.querySelector("[data-dashboard-notifications]"),a=document.querySelector("[data-publish-form]"),s=(A=document.querySelector("[data-dashboard-page]"))==null?void 0:A.getAttribute("data-dashboard-page");if(!t||!e||!s||!a)return;const r=t.querySelector("[data-publish-console-open]"),o=t.querySelector("[data-publish-task-preview]"),i=t.querySelector("[data-publish-task-empty]"),c=e.querySelector("[data-publish-console-summary]"),l=e.querySelector("[data-publish-console-summary-empty]"),p=e.querySelector("[data-publish-console-summary-count]"),h=e.querySelector("[data-publish-console-task-list]"),b=e.querySelector("[data-publish-console-task-empty]"),u=e.querySelector("[data-publish-console-task-progress]"),m=e.querySelector("[data-publish-console-task-form]"),d=e.querySelector("[data-publish-console-notes]"),g=e.querySelector("[data-publish-console-status]"),v=e.querySelector("[data-publish-console-confirm]"),T=e.querySelectorAll("[data-publish-console-close]"),E={tasks:Vn.map(w=>({...w})),summary:null,notes:""},L=et(),_=()=>{const w=z(s);E.summary=w.publishSummary??null,Yn(E,c,l,p),G(E,{previewList:o,previewEmpty:i,taskList:h,taskEmpty:b,taskProgress:u}),Y(E,g,v)};_();const x=L.subscribe(_);r==null||r.addEventListener("click",()=>Gn(e)),T.forEach(w=>w.addEventListener("click",()=>vt(e))),e.addEventListener("keydown",w=>{w.key==="Escape"&&vt(e)}),v==null||v.addEventListener("click",()=>{v.disabled||(a.requestSubmit(),vt(e),n&&Gt(n,"Publishing request dispatched","Concierge automation is processing your publish request."))}),h==null||h.addEventListener("change",w=>{const N=w.target;if(!N||N.type!=="checkbox")return;const q=N.getAttribute("data-task-id");if(!q)return;const $=E.tasks.find(D=>D.id===q);$&&($.completed=N.checked,G(E,{previewList:o,previewEmpty:i,taskList:h,taskEmpty:b,taskProgress:u}),Y(E,g,v))}),h==null||h.addEventListener("click",w=>{var D;const N=(D=w.target)==null?void 0:D.closest("[data-task-remove]");if(!N)return;const q=N.getAttribute("data-task-remove");if(!q)return;const $=E.tasks.findIndex(M=>M.id===q);$>=0&&E.tasks[$].origin==="manual"&&(E.tasks.splice($,1),G(E,{previewList:o,previewEmpty:i,taskList:h,taskEmpty:b,taskProgress:u}),Y(E,g,v))}),m==null||m.addEventListener("submit",w=>{w.preventDefault();const N=m.querySelector("input[type='text']");if(!N)return;const q=N.value.trim();if(!q)return;const $=`manual-${Date.now()}`;E.tasks.push({id:$,label:q,completed:!1,origin:"manual"}),N.value="",G(E,{previewList:o,previewEmpty:i,taskList:h,taskEmpty:b,taskProgress:u}),Y(E,g,v)}),d==null||d.addEventListener("input",()=>{E.notes=d.value}),document.addEventListener("dashboard:task:add",w=>{const N=w.detail;N&&(E.tasks.some(q=>q.id===N.id)||(E.tasks.push({id:N.id,label:N.label,completed:!1,origin:"event"}),G(E,{previewList:o,previewEmpty:i,taskList:h,taskEmpty:b,taskProgress:u}),Y(E,g,v),n&&Gt(n,"Task added",N.label)))}),window.addEventListener("beforeunload",()=>{x()},{once:!0})}function Gn(t){t.hidden=!1,requestAnimationFrame(()=>{t.dataset.state="open";const e=t.querySelector(".publish-console__close");e==null||e.focus({preventScroll:!0}),document.body.style.setProperty("overflow","hidden")})}function vt(t){t.dataset.state="idle",document.body.style.removeProperty("overflow"),setTimeout(()=>{t.hidden=!0},180)}function Yn(t,e,n,a){if(!e)return;e.innerHTML="";const s=t.summary;if(!s||s.entries.length===0){n&&(n.hidden=!1),a&&(a.textContent="0 sections");return}n&&(n.hidden=!0),a&&(a.textContent=`${s.entries.length} section${s.entries.length===1?"":"s"}`);const r=document.createDocumentFragment();s.entries.forEach(o=>{const i=document.createElement("li");i.className="publish-console__summary-item",i.dataset.changeType=o.changeType;const c=document.createElement("div");c.className="publish-console__summary-head";const l=document.createElement("strong");l.textContent=o.sectionKey??"Section";const p=document.createElement("span");p.textContent=`${o.changeType} · ${o.contentType??"Content"}`,c.append(l,p);const h=document.createElement("p");h.className="publish-console__summary-notes",h.textContent=o.diffSummary??"No diff summary recorded.",i.append(c,h),r.appendChild(i)}),e.appendChild(r)}function G(t,e){const{tasks:n}=t,a=n.filter(s=>s.completed).length;if(e.previewList){e.previewList.innerHTML="";const s=n.slice(0,3);s.length?(e.previewEmpty&&(e.previewEmpty.hidden=!0),s.forEach(r=>{var i;const o=document.createElement("li");o.className="publish-console__preview-item",o.dataset.state=r.completed?"done":"pending",o.textContent=r.label,(i=e.previewList)==null||i.appendChild(o)})):e.previewEmpty&&(e.previewEmpty.hidden=!1)}if(e.taskList)if(e.taskList.innerHTML="",!n.length)e.taskEmpty&&(e.taskEmpty.hidden=!1);else{e.taskEmpty&&(e.taskEmpty.hidden=!0);const s=document.createDocumentFragment();n.forEach(r=>{const o=document.createElement("li");o.className="publish-console__task";const i=document.createElement("label");i.className="publish-console__task-label";const c=document.createElement("input");c.type="checkbox",c.checked=r.completed,c.setAttribute("data-task-id",r.id);const l=document.createElement("span");if(l.textContent=r.label,i.append(c,l),o.appendChild(i),r.origin==="manual"){const p=document.createElement("button");p.type="button",p.className="publish-console__task-remove",p.setAttribute("data-task-remove",r.id),p.innerHTML='<span class="fa-solid fa-xmark" aria-hidden="true"></span><span class="sr-only">Remove task</span>',o.appendChild(p)}s.appendChild(o)}),e.taskList.appendChild(s)}e.taskProgress&&(e.taskProgress.textContent=`${a} of ${n.length} complete`)}function Y(t,e,n){const a=t.tasks.some(r=>!r.completed),s=!!(t.summary&&t.summary.entries.length);e&&(s?a?e.textContent="Complete all pre-flight tasks to enable publishing.":e.textContent="All tasks completed. Ready for publish.":e.textContent="Generate a diff summary before publishing."),n&&(n.disabled=a||!s)}function Gt(t,e,n){const a=document.createElement("div");a.className="dashboard-notification";const s=document.createElement("strong");s.textContent=e;const r=document.createElement("p");r.textContent=n,a.append(s,r),t.appendChild(a),setTimeout(()=>{a.classList.add("dashboard-notification--hide"),setTimeout(()=>{a.remove()},300)},4e3)}function Qn(){var i;const t=document.querySelector("[data-dashboard-notifications]"),e=(i=document.querySelector("[data-dashboard-page]"))==null?void 0:i.getAttribute("data-dashboard-page");if(!t||!e)return;const n=et(),a=new Set,s=c=>{c.events.forEach(l=>{if(!a.has(l.id))switch(a.add(l.id),l.type){case"draft-conflict":Q(t,"Conflict detected",l.description??"Resolve conflicts before publishing."),wt(`conflict-${l.sectionId}`,`Resolve conflict for ${l.sectionKey??"a section"}`);break;case"review-status":l.reviewStatus==="pending"&&(Q(t,"Review requested",`${l.sectionKey??"Section"} needs review.`),wt(`review-${l.sectionId}`,`Complete review for ${l.sectionKey??"section"}`)),l.reviewStatus==="rejected"&&(Q(t,"Review rejected",l.description??"Update content before publishing."),wt(`rework-${l.sectionId}`,`Address review feedback for ${l.sectionKey??"section"}`));break;case"draft-dirty":Q(t,"Draft updated",l.description??"New draft changes ready for review.");break;case"publish-summary":Q(t,"Publish ready","Diff summary prepared in publish console.");break}})},r=()=>{const c=z(e);s(c)};r();const o=n.subscribe(r);window.addEventListener("beforeunload",()=>{o()},{once:!0})}function Q(t,e,n){const a=document.createElement("div");a.className="dashboard-notification";const s=document.createElement("strong");s.textContent=e;const r=document.createElement("p");r.textContent=n,a.append(s,r),t.appendChild(a),requestAnimationFrame(()=>{a.dataset.state="visible"}),setTimeout(()=>{a.dataset.state="closing",setTimeout(()=>{a.remove()},300)},4500)}function wt(t,e){document.dispatchEvent(new CustomEvent("dashboard:task:add",{detail:{id:t,label:e}}))}(()=>{const t=()=>{const r=Array.from(document.querySelectorAll("[data-profile-menu]"));if(!r.length)return;const o="[data-profile-toggle]";let i=null;const c=m=>m&&r.find(d=>d.contains(m))||null,l=(m,d)=>{const g=m.querySelector(o);g&&g.setAttribute("aria-expanded",d?"true":"false"),m.dataset.open=d?"true":"false"},p=m=>{m&&(l(m,!1),i===m&&(i=null))},h=m=>{i&&i!==m&&p(i),l(m,!0),i=m},b=m=>{const d=m.querySelector('[role="menuitem"]');d&&d.focus({preventScroll:!0})},u=m=>!!(m!=null&&m.closest(o));document.addEventListener("click",m=>{const d=m.target.closest(o);if(d){const g=c(d);if(!g)return;m.preventDefault(),g.dataset.open==="true"?p(g):h(g);return}i&&!i.contains(m.target)&&p(i)}),document.addEventListener("keydown",m=>{const d=m.target;if(!(d instanceof HTMLElement&&(d.isContentEditable||d.matches("input, textarea, select")))){if(u(d)){const g=c(d);if(!g)return;(m.key==="Enter"||m.key===" ")&&(m.preventDefault(),d.click()),m.key==="ArrowDown"&&(m.preventDefault(),g.dataset.open!=="true"&&h(g),b(g)),m.key==="Escape"&&(m.preventDefault(),p(g));return}if(m.key==="Escape"&&i){const g=i.querySelector(o);p(i),g&&g.focus({preventScroll:!0})}}}),document.addEventListener("focusin",m=>{i&&!i.contains(m.target)&&p(i)}),window.addEventListener("blur",()=>{i&&p(i)})},e=()=>{const r=Array.from(document.querySelectorAll("[data-nav-dropdown]"));if(!r.length)return;const o=(i=null)=>{r.forEach(c=>{const l=c.querySelector("[data-nav-dropdown-toggle]"),p=c===i;c.dataset.open=p?"true":"false",l&&l.setAttribute("aria-expanded",p?"true":"false")})};r.forEach(i=>{const c=i.querySelector("[data-nav-dropdown-toggle]");if(!c)return;const l=i.querySelector("[data-nav-dropdown-menu]"),p=h=>{i.dataset.open=h?"true":"false",c.setAttribute("aria-expanded",h?"true":"false")};c.addEventListener("click",h=>{h.preventDefault(),i.dataset.open==="true"?p(!1):(o(i),p(!0))}),i.addEventListener("keydown",h=>{h.key==="Escape"&&(p(!1),c.focus({preventScroll:!0}))}),l&&l.querySelectorAll("a, button").forEach(h=>{h.addEventListener("click",()=>{p(!1)})})}),document.addEventListener("click",i=>{r.some(c=>c.contains(i.target))||o()}),o()},n=()=>{const r=Array.from(document.querySelectorAll("[data-editor]"));if(!r.length)return;const o=new Set(["color","background-color","font-size","font-family","font-style","font-weight","font-variant","text-transform","text-decoration","text-decoration-line","letter-spacing","line-height"]),i=u=>u?u.split(";").map(d=>d.trim()).filter(Boolean).map(d=>{const[g,...v]=d.split(":");if(!g||v.length===0)return null;const T=g.trim().toLowerCase();if(!o.has(T))return null;const E=v.join(":").trim();return!E||/url\s*\(/i.test(E)||/expression/i.test(E)||/javascript:/i.test(E)?null:`${T}: ${E}`}).filter(Boolean).join("; "):"",c=u=>{const m=document.createElement("template");return m.innerHTML=u,m.content.querySelectorAll("script, style").forEach(d=>d.remove()),m.content.querySelectorAll("*").forEach(d=>{Array.from(d.attributes).forEach(g=>{if(g.name.startsWith("on")){d.removeAttribute(g.name);return}if(g.name==="style"){const v=i(g.value);v?d.setAttribute("style",v):d.removeAttribute("style")}})}),m.innerHTML},l=u=>typeof u!="string"?"":u.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),p=[],h=new WeakSet,b=u=>{const m=u.dataset.editorMode||"text",d=u.querySelector("[data-editor-surface]"),g=u.querySelector("[data-editor-input]"),v=u.querySelector("[data-editor-code]"),T=u.querySelector("[data-editor-metrics]"),E=T?T.querySelector("[data-editor-words]"):null,L=T?T.querySelector("[data-editor-chars]"):null,_=T?T.querySelector("[data-editor-read]"):null,x=d?u.querySelector("[data-editor-font-family]"):null,A=d?u.querySelector("[data-editor-font-size]"):null,w=d?Array.from(u.querySelectorAll("[data-style-lineheight], [data-style-letterspacing], [data-style-wordspacing], [data-style-texttransform]")):[],N={norwester:'"Norwester", sans-serif',inter:'"Inter", "Segoe UI", sans-serif',playfair:'"Playfair Display", "Times New Roman", serif',space:'"Space Grotesk", "Futura", sans-serif',lora:'"Lora", "Georgia", serif',work:'"Work Sans", "Helvetica Neue", sans-serif',mono:'"IBM Plex Mono", "SFMono-Regular", monospace'},q=f=>{const y=(f||"").replace(/\s+/g," ").trim();return y?y.length<=80?y:`${y.slice(0,77).trimEnd()}...`:""},$=(f,y)=>{if(!f)return;let S=f.querySelector('option[data-custom="true"]');if(!y){S&&S.remove(),f.value==="__custom__"&&(f.value="");return}S||(S=document.createElement("option"),S.dataset.custom="true",f.appendChild(S)),S.value=y,S.textContent=`Custom (${y})`,f.value=y},D=()=>{if(!d)return null;const f=window.getSelection();if(!f||f.rangeCount===0)return null;const y=f.getRangeAt(0);if(!d.contains(y.commonAncestorContainer))return null;const S=f.focusNode||f.anchorNode;let C=S instanceof Element?S:(S==null?void 0:S.parentElement)||d;return d.contains(C)||(C=d),{selection:f,range:y,contextElement:C}},M=f=>{const y=D();if(!y)return;const{selection:S,range:C}=y,k=document.createElement("span");Object.entries(f).forEach(([K,Ct])=>{Ct!=null&&(k.style[K]=Ct)});try{if(C.collapsed)k.appendChild(document.createTextNode("")),C.insertNode(k);else{const K=C.extractContents();k.appendChild(K),C.insertNode(k)}}catch{const K=document.createElement("div");K.appendChild(C.cloneContents()),k.innerHTML=K.innerHTML||S.toString()||"",document.execCommand("insertHTML",!1,k.outerHTML);return}S.removeAllRanges();const F=document.createRange();F.selectNodeContents(k),C.collapsed&&F.collapse(!0),S.addRange(F)},Jn=f=>{if(!f)return;const y=f.closest(".rich-editor__toolbar-controls");y?y.querySelectorAll("[aria-pressed]").forEach(S=>{S.setAttribute("aria-pressed",S===f?"true":"false")}):f.setAttribute("aria-pressed","true")},Zn=f=>{const y=f.dataset||{},S=Object.prototype.hasOwnProperty.call(y,"styleLineheight"),C=Object.prototype.hasOwnProperty.call(y,"styleLetterspacing"),k=Object.prototype.hasOwnProperty.call(y,"styleWordspacing"),F=Object.prototype.hasOwnProperty.call(y,"styleTexttransform");return(!S||!y.styleLineheight)&&(!C||!y.styleLetterspacing)&&(!k||!y.styleWordspacing)&&(!F||y.styleTexttransform==="none")},Xn=f=>{if(!d)return;d.focus({preventScroll:!0});const y={};Object.prototype.hasOwnProperty.call(f.dataset,"styleLineheight")&&(y.lineHeight=f.dataset.styleLineheight||"normal"),Object.prototype.hasOwnProperty.call(f.dataset,"styleLetterspacing")&&(y.letterSpacing=f.dataset.styleLetterspacing||"normal"),Object.prototype.hasOwnProperty.call(f.dataset,"styleWordspacing")&&(y.wordSpacing=f.dataset.styleWordspacing||"normal"),Object.prototype.hasOwnProperty.call(f.dataset,"styleTexttransform")&&(y.textTransform=f.dataset.styleTexttransform||"none"),M(y),P(),Jn(f),R()};w.length&&w.forEach(f=>{const y=Zn(f);f.setAttribute("aria-pressed",y?"true":"false"),f.addEventListener("click",()=>{Xn(f)})});const ta=f=>{if(!f)return"";const y=f.replace(/["']/g,"").split(",")[0].trim().toLowerCase();return y==="norwester"?"norwester":y==="inter"||y==="segoe ui"||y==="helvetica neue"?"inter":y==="playfair display"||y==="times new roman"?"playfair":y==="space grotesk"||y==="futura"?"space":y==="lora"||y==="georgia"?"lora":y==="work sans"||y==="helvetica"?"work":y==="ibm plex mono"||y==="sfmono-regular"||y==="courier new"||y==="monaco"?"mono":""},R=()=>{if(!d)return;const f=D();if(!f){x&&(x.value=""),A&&(A.value="",$(A,""));return}const y=window.getComputedStyle(f.contextElement);if(x&&(x.value=ta(y.fontFamily)),A){const S=(y.fontSize||"").trim(),C=Array.from(A.options).map(k=>k.value).filter(k=>k&&k!=="__custom__");S&&C.includes(S)?(A.value=S,$(A,"")):S?$(A,S):(A.value="",$(A,""))}},ea=f=>{if(!d)return;const y=f?N[f]??f:"inherit";M({fontFamily:y}),P(),R()},Yt=f=>{if(!d)return;M({fontSize:f||"inherit"}),P(),R()};if(!g)return;const na=()=>d?d.innerText.replace(/\u00a0/g," ").replace(/\r/g,"").replace(/\n{3,}/g,`

`).trim():"",Qt=f=>{try{return new Intl.NumberFormat().format(f)}catch{return`${f}`}},aa=f=>{if(!T)return;const y=(f==null?void 0:f.plain)||"",S=y?y.trim().split(/\s+/).filter(Boolean).length:0,C=y.replace(/\s/g,"").length,k=S/200;let F="0 min read";S>0&&(k<1?F="<1 min read":F=`${Math.max(1,Math.round(k))} min read`),E&&(E.textContent=`${Qt(S)} ${S===1?"word":"words"}`),L&&(L.textContent=`${Qt(C)} ${C===1?"character":"characters"}`),_&&(_.textContent=F)},sa=()=>{if(m==="text"){const f=na();return{plain:f,html:l(f).replace(/(?:\r\n|\r|\n)/g,"<br>")}}if(u.dataset.code==="true"&&v){const f=c(v.value.trim());return{plain:f.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim(),html:f}}if(d){const f=d.innerHTML.replace(/<div><br><\/div>/gi,"<br>").replace(/<p><br><\/p>/gi,"<br>"),y=c(f).trim();return{plain:d.innerText.replace(/\u00a0/g," ").replace(/\r/g,"").replace(/\s+\n/g,`
`).trim(),html:y}}return{plain:"",html:""}},P=()=>{const f=sa();m==="text"?g.value=f.plain:g.value=f.html,u.dispatchEvent(new CustomEvent("rich-editor-change",{bubbles:!0,detail:{editor:u,mode:m,plainText:f.plain,html:f.html}})),aa(f),d&&R()};if(d&&(d.addEventListener("input",P),d.addEventListener("blur",()=>{d.innerText.trim()===""&&(d.innerHTML=""),P(),R()}),d.addEventListener("keyup",R),d.addEventListener("mouseup",R),!u.__selectionListener)){const f=()=>{const y=window.getSelection();if(!y||y.rangeCount===0)return;const S=y.focusNode||y.anchorNode;S&&d.contains(S)&&R()};u.__selectionListener=f,document.addEventListener("selectionchange",f)}x&&x.addEventListener("change",f=>{ea(f.target.value)}),A&&A.addEventListener("change",f=>{const y=f.target.value;if(y==="__custom__"){const S=window.prompt("Enter a CSS font-size (e.g. 18px, 1.25rem, clamp(1rem, 2vw, 2rem))");if(!S||!S.trim()){A.value="",$(A,"");return}const C=S.trim();$(A,C),Yt(C);return}$(A,""),Yt(y)}),v&&v.addEventListener("input",P);const ra=(f,y)=>{if(f==="toggle-code"&&v){u.dataset.code==="true"?(u.dataset.code="false",d&&(d.innerHTML=c(v.value),d.focus({preventScroll:!0}))):(v.value=d?d.innerHTML.trim():g.value,u.dataset.code="true",v.focus({preventScroll:!0})),P();return}if(!d)return;if(f==="createLink"){let C=window.prompt("Enter URL");if(!C){document.execCommand("unlink"),P();return}C=C.trim(),C&&!/^https?:\/\//i.test(C)&&(C=`https://${C}`),d.focus({preventScroll:!0}),document.execCommand("createLink",!1,C),P();return}let S=f;if(S==="HiliteColor"&&!document.queryCommandSupported("HiliteColor")&&(S="backColor"),d.focus({preventScroll:!0}),S==="removeFormat"){document.execCommand("removeFormat"),document.execCommand("unlink"),P();return}S==="formatBlock"?document.execCommand("formatBlock",!1,y||"p"):document.execCommand(S,!1,y),P()};u.querySelectorAll("[data-command]").forEach(f=>{f.addEventListener("click",()=>{ra(f.dataset.command,f.dataset.value)})});const Et=u.dataset.previewTarget;if(Et){const f=document.querySelector(`[data-preview-tab="${Et}"] [data-preview-summary]`);u.addEventListener("rich-editor-change",y=>{const S=document.querySelector(`[data-preview-section="${Et}"]`);if(!S)return;const C=y.detail||{},k=S.closest(".preview-canvas__section");if(S.innerHTML=C.html||"",!C.plainText&&!C.html?(S.classList.add("preview-canvas__content--empty"),k&&k.classList.add("preview-canvas__section--empty")):(S.classList.remove("preview-canvas__content--empty"),k&&k.classList.remove("preview-canvas__section--empty")),S.classList.add("preview-canvas__content--dirty"),k&&k.classList.add("preview-canvas__section--dirty"),S.__dirtyTimeout&&window.clearTimeout(S.__dirtyTimeout),k&&k.__dirtyTimeout&&window.clearTimeout(k.__dirtyTimeout),S.__dirtyTimeout=window.setTimeout(()=>{S.classList.remove("preview-canvas__content--dirty")},700),k&&(k.__dirtyTimeout=window.setTimeout(()=>{k.classList.remove("preview-canvas__section--dirty")},700)),f){const K=C.plainText&&C.plainText.trim()?C.plainText:C.html?C.html.replace(/<[^>]+>/g," "):"";f.textContent=q(K)}})}const V=u.closest("form");p.push({editor:u,form:V,updateStorage:P}),V&&!h.has(V)&&(h.add(V),V.addEventListener("submit",()=>{p.filter(f=>f.form===V).forEach(f=>f.updateStorage())})),P(),R()};r.forEach(b)},a=()=>{const r=document.querySelector("[data-editor-sections]");if(!r)return;const o=Array.from(r.querySelectorAll("[data-editor-card]"));if(!o.length)return;const i=document.querySelector("[data-editor-search]"),c=document.querySelector("[data-editor-filter-count]"),l=Array.from(document.querySelectorAll("[data-editor-filter]")),p=new Set,h=()=>{const b=((i==null?void 0:i.value)||"").trim().toLowerCase(),u=[];if(o.forEach(m=>{let d=!0;const g=m.dataset.sectionStatus||"",v=m.dataset.hasDraft==="true",T=`${m.dataset.sectionTitle??""} ${m.dataset.sectionKey??""}`.toLowerCase();b&&!T.includes(b)&&(d=!1),d&&p.has("editable")&&g!=="editable"&&(d=!1),d&&p.has("draft")&&!v&&(d=!1),m.hidden=!d,d&&u.push(m)}),c){const m=o.length;c.textContent=u.length===m?`${m} sections`:`${u.length} of ${m} sections`}};i&&i.addEventListener("input",()=>{window.requestAnimationFrame(h)}),l.forEach(b=>{b.addEventListener("click",()=>{const u=b.dataset.editorFilter;u&&(p.has(u)?(p.delete(u),b.dataset.state="off"):(p.add(u),b.dataset.state="on"),h())})}),h()},s=()=>{t(),e(),n(),a(),bn(),qe(),sn(),Hn(),zn(),Qn(),le()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",s):s()})()})();
//# sourceMappingURL=site.js.map
